<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ميزانيتك الذكية | Smart Budget Pro</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">

<style>
/* ---------------------------------------------------- */
/* Variables and Base Styling */
/* ---------------------------------------------------- */
:root{
    --p: #0077b6; --s: #48cae4; --bg: #f7f9fc; 
    --danger: #ef476f; --success: #2a9d8f; --warning: #fbc02d;
    --text-dark: #333; --text-light: #f7f9fc;
    --shadow-light: 0 4px 8px rgba(0, 0, 0, 0.08);
    --shadow-hover: 0 6px 15px rgba(0, 0, 0, 0.15);
    --card-bg: #fff; --input-bg: #fff; --border-color: #ddd;
}

body.dark-mode {
    --p: #90e0ef; --bg: #1f1f1f; --text-dark: #e0e0e0; 
    --card-bg: #2d2d2d; --input-bg: #3c3c3c; --border-color: #555;
}

* { box-sizing: border-box; }
body{
    margin:0; font-family: 'Tajawal', sans-serif;
    background: var(--bg); color: var(--text-dark);
    line-height: 1.6; transition: 0.3s;
}

/* ---------------------------------------------------- */
/* UI Elements */
/* ---------------------------------------------------- */
header{
    background: var(--p); color: var(--text-light);
    padding: 15px; font-size: 18px; display: flex;
    justify-content: space-between; align-items: center;
    position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow-hover);
}
header button { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }

.tabs{ display:flex; background: var(--card-bg); border-bottom: 2px solid var(--border-color); }
.tabs button{
    flex: 1; padding: 15px 5px; border:none; background: none;
    color: var(--text-dark); font-weight: 700; font-size: 13px; cursor: pointer;
}
.tabs button.active{ color: var(--p); border-bottom: 3px solid var(--p); }

.section{ display:none; padding: 15px; animation: fadeIn 0.3s; }
.section.active{ display:block; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.card{
    background:var(--card-bg); padding: 20px; border-radius: 15px;
    box-shadow: var(--shadow-light); margin-bottom: 15px; border-top: 5px solid var(--s);
}

.balance-display {
    text-align: center; padding: 25px; background: var(--card-bg);
    border-radius: 15px; box-shadow: var(--shadow-hover); margin-bottom: 20px;
}
#currentBalanceDisplay { font-size: 32px; font-weight: 800; color: var(--p); margin: 10px 0; }

input, select {
    width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px;
    border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-dark);
}

button.action {
    background: var(--p); color: white; border: none; padding: 15px;
    width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px;
}
button.secondary {
    background: var(--input-bg); color: var(--text-dark); border: 1px solid var(--border-color);
    padding: 10px; width: 100%; border-radius: 10px; cursor: pointer; margin-top: 5px;
}

/* Modals */
.modal{
    position:fixed; top:0; left:0; width:100%; height:100%;
    background: var(--bg); display:none; flex-direction:column; z-index: 200;
}
.modal header{ background: var(--card-bg); color: var(--text-dark); border-bottom: 1px solid var(--border-color); }
.modal-content { padding: 20px; overflow-y: auto; flex-grow: 1; }

.toast {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    background: #333; color: white; padding: 10px 20px; border-radius: 20px;
    display: none; z-index: 1000; font-size: 14px;
}

.sidebar {
    position: fixed; top: 0; right: 0; width: 280px; height: 100%;
    background: var(--card-bg); z-index: 300; transform: translateX(100%);
    transition: 0.3s; box-shadow: -5px 0 15px rgba(0,0,0,0.1);
}
.sidebar.open { transform: translateX(0); }
.sidebar-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); display: none; z-index: 250;
}

.list-item {
    background: var(--card-bg); padding: 15px; border-radius: 10px;
    margin-bottom: 10px; border-right: 5px solid var(--p); box-shadow: var(--shadow-light);
}
</style>
</head>

<body>

<header>
    <button onclick="openLayer('sidebar')"><i class="fas fa-bars"></i></button> 
    <span class="title">ميزانيتك الذكية</span>
    <button onclick="openLayer('about')"><i class="fas fa-info-circle"></i></button> 
</header>

<div class="tabs">
    <button class="active" onclick="openTab('overview', event)">لوحة القيادة</button>
    <button onclick="openTab('expenses', event)">مصروفات</button>
    <button onclick="openTab('rights', event)">حقوق</button>
    <button onclick="openTab('debts', event)">التزامات</button>
</div>

<div id="overview" class="section active">
    <div class="balance-display">
        <h2 style="font-size: 16px; color: #777;">الرصيد النقدي الحالي</h2>
        <p id="currentBalanceDisplay">0.00</p>
        <button onclick="toggleBalanceVisibility()" id="balanceVisibilityToggle" style="background:none; border:none; color:var(--p); cursor:pointer;">
             <i class="fas fa-eye"></i>
        </button>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="action" onclick="openBalanceActionModal('deposit')" style="background: var(--success);">إيداع</button>
            <button class="action" onclick="openBalanceActionModal('withdraw')" style="background: var(--danger);">سحب</button>
        </div>
    </div>
    
    <div class="card">
        <h3 style="margin-top:0">ملخص سريع</h3>
        <p>إجمالي المصروفات: <span id="sExpTotal">0</span></p>
        <p>إجمالي الحقوق: <span id="sRigTotal">0</span></p>
        <p>إجمالي الالتزامات: <span id="sDebTotal">0</span></p>
    </div>
    <button class="secondary" onclick="openLayer('balanceLog')">سجل حركات الرصيد</button>
</div>

<div id="expenses" class="section">
    <div class="card">
        <input id="eAmount" type="text" placeholder="المبلغ" oninput="formatAmount(this)">
        <select id="eType">
            <option value="">اختر الفئة</option>
            <option>طعام</option><option>مواصلات</option><option>تسوق</option><option>أخرى</option>
        </select>
        <input id="eDesc" placeholder="وصف">
        <input id="eDate" type="datetime-local">
        <button class="action" onclick="addExpense()">حفظ المصروف</button>
        <button class="secondary" onclick="openLog('exp')">سجل المصروفات</button>
    </div>
</div>

<div id="rights" class="section">
    <div class="card">
        <input id="rAmount" type="text" placeholder="المبلغ الكلي" oninput="formatAmount(this)">
        <input id="rDesc" placeholder="المدين / الجهة">
        <select id="rStatus">
            <option value="غير مدفوع">غير مدفوع</option>
            <option value="كامل">مدفوع بالكامل</option>
        </select>
        <input id="rDate" type="datetime-local">
        <button class="action" onclick="addRight()">حفظ الحق</button>
        <button class="secondary" onclick="openLog('rig')">سجل الحقوق</button>
    </div>
</div>

<div id="debts" class="section">
    <div class="card">
        <input id="dAmount" type="text" placeholder="قيمة الالتزام" oninput="formatAmount(this)">
        <input id="dDesc" placeholder="الدائن / الجهة">
        <select id="dStatus">
            <option value="غير مدفوع">غير مدفوع</option>
            <option value="مدفوع">مدفوع</option>
        </select>
        <input id="dDate" type="datetime-local">
        <button class="action" onclick="addDebt()">حفظ الالتزام</button>
        <button class="secondary" onclick="openLog('deb')">سجل الالتزامات</button>
    </div>
</div>

<div class="modal" id="logModal">
    <header>
        <button onclick="closeLayer('log')"><i class="fas fa-times"></i></button>
        <span class="title">السجل</span>
        <div style="width:40px"></div>
    </header>
    <div class="modal-content" id="logContent"></div>
</div>

<div class="modal" id="actionModal">
    <header>
        <button onclick="closeLayer('balanceAction')"><i class="fas fa-times"></i></button>
        <span id="actionModalTitle">إجراء</span>
        <div style="width:40px"></div>
    </header>
    <div class="modal-content">
        <input id="bAmount" type="text" placeholder="المبلغ" oninput="formatAmount(this)">
        <input id="bDesc" placeholder="ملاحظة">
        <button class="action" onclick="processBalanceAction()">تأكيد</button>
    </div>
</div>

<div class="modal" id="balanceLogModal">
    <header><button onclick="closeLayer('balanceLog')"><i class="fas fa-times"></i></button><span>سجل الرصيد</span><div style="width:40px"></div></header>
    <div class="modal-content" id="balanceLogContent"></div>
</div>

<div class="sidebar-overlay" id="mainOverlay" onclick="closeLayer('sidebar')"></div>
<div class="sidebar" id="appSidebar">
    <div style="padding:20px; background:var(--p); color:white; font-weight:bold;">القائمة والإعدادات</div>
    <div style="padding:10px;">
        <button class="secondary" onclick="toggleDarkMode()">الوضع الليلي</button>
        <button class="secondary" onclick="exportData()">تصدير البيانات (JSON)</button>
        <label class="secondary" style="display:block; text-align:center;">
            استيراد بيانات
            <input type="file" style="display:none" onchange="importData(event)">
        </label>
        <button class="secondary" style="color:red" onclick="clearAllData()">مسح كافة البيانات</button>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ------------------------------------
// 1. التهيئة والبيانات الأساسية
// ------------------------------------
const STORE_NAMES = ["exp", "rig", "deb", "bal"];
let db = { exp: [], rig: [], deb: [], bal: { amount: 0, changes: [] } };
let IDB_connection = null;
let currentBalance = 0;
let balanceHidden = localStorage.getItem('balanceHidden') === 'true';
let balanceActionType = null;
let historyStack = [];

const LAYERS = {
    'sidebar': { elementId: 'appSidebar', type: 'menu' },
    'log': { elementId: 'logModal', type: 'modal' },
    'balanceAction': { elementId: 'actionModal', type: 'modal' },
    'balanceLog': { elementId: 'balanceLogModal', type: 'modal' },
    'about': { elementId: 'logModal', type: 'modal' } // مثال
};

// ------------------------------------
// 2. إدارة قاعدة البيانات (IndexedDB)
// ------------------------------------
function initDB() {
    return new Promise((resolve) => {
        const request = indexedDB.open("SmartBudgetDB", 2);
        request.onupgradeneeded = (e) => {
            const tempDb = e.target.result;
            STORE_NAMES.forEach(name => {
                if (!tempDb.objectStoreNames.contains(name)) {
                    tempDb.createObjectStore(name, { keyPath: "id", autoIncrement: true });
                }
            });
        };
        request.onsuccess = (e) => {
            IDB_connection = e.target.result;
            loadAllData().then(resolve);
        };
    });
}

async function loadAllData() {
    for (const storeName of STORE_NAMES) {
        db[storeName] = await loadStoreData(storeName);
    }
    // معالجة الرصيد
    if (db.bal.length > 0) {
        const balObj = db.bal[db.bal.length - 1]; // آخر حالة للرصيد
        currentBalance = balObj.amount || 0;
        db.bal = balObj; 
    } else {
        db.bal = { amount: 0, changes: [] };
    }
    updateStats();
    updateBalanceDisplay();
}

function loadStoreData(name) {
    return new Promise((resolve) => {
        const transaction = IDB_connection.transaction([name], "readonly");
        const store = transaction.objectStore(name);
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result || []);
    });
}

function saveData(storeName, data) {
    return new Promise((resolve) => {
        const transaction = IDB_connection.transaction([storeName], "readwrite");
        const store = transaction.objectStore(storeName);
        const request = store.put(data);
        request.onsuccess = () => resolve(request.result);
    });
}

// ------------------------------------
// 3. الدوال المساعدة (المهمة)
// ------------------------------------
function formatAmount(input) {
    let value = input.value.replace(/[^0-9.]/g, '');
    if (value) {
        let parts = value.split('.');
        parts[0] = new Intl.NumberFormat().format(parts[0]);
        input.value = parts.join('.');
    }
}

function cleanAmount(val) {
    return parseFloat(val.toString().replace(/,/g, '')) || 0;
}

function toastMsg(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg; t.style.display = 'block';
    setTimeout(() => t.style.display = 'none', 2500);
}

// ------------------------------------
// 4. إدارة الواجهة والتبويبات
// ------------------------------------
function openTab(tabId, event) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    if(event) event.currentTarget.classList.add('active');
}

function openLayer(name, data = null) {
    const layer = LAYERS[name];
    if (!layer) return;
    const el = document.getElementById(layer.elementId);
    if (layer.type === 'modal') el.style.display = 'flex';
    else {
        el.classList.add('open');
        document.getElementById('mainOverlay').style.display = 'block';
    }
    historyStack.push(name);
    
    if(name === 'balanceLog') renderBalanceLog();
}

function closeLayer(name) {
    const layer = LAYERS[name];
    if (!layer) return;
    const el = document.getElementById(layer.elementId);
    if (layer.type === 'modal') el.style.display = 'none';
    else {
        el.classList.remove('open');
        document.getElementById('mainOverlay').style.display = 'none';
    }
    historyStack.pop();
}

// ------------------------------------
// 5. وظائف العمليات المالية
// ------------------------------------
async function updateBalance(amount, type, desc) {
    currentBalance += amount;
    db.bal.amount = currentBalance;
    db.bal.changes.push({ amount, type, desc, date: new Date().toISOString() });
    await saveData('bal', db.bal);
    updateBalanceDisplay();
    updateStats();
}

function updateBalanceDisplay() {
    const el = document.getElementById('currentBalanceDisplay');
    if (balanceHidden) el.innerText = "••••••";
    else el.innerText = currentBalance.toFixed(2);
}

function toggleBalanceVisibility() {
    balanceHidden = !balanceHidden;
    localStorage.setItem('balanceHidden', balanceHidden);
    updateBalanceDisplay();
}

function openBalanceActionModal(type) {
    balanceActionType = type;
    document.getElementById('actionModalTitle').innerText = type === 'deposit' ? 'إيداع رصيد' : 'سحب رصيد';
    openLayer('balanceAction');
}

async function processBalanceAction() {
    const amtInput = document.getElementById('bAmount');
    const descInput = document.getElementById('bDesc');
    const amount = cleanAmount(amtInput.value);
    
    if (amount <= 0) return toastMsg("أدخل مبلغاً صحيحاً");
    
    const finalAmount = balanceActionType === 'deposit' ? amount : -amount;
    await updateBalance(finalAmount, balanceActionType, descInput.value || "عملية يدوية");
    
    amtInput.value = ''; descInput.value = '';
    closeLayer('balanceAction');
    toastMsg("تم تحديث الرصيد");
}

async function addExpense() {
    const amt = cleanAmount(document.getElementById('eAmount').value);
    const type = document.getElementById('eType').value;
    if (amt <= 0 || !type) return toastMsg("أكمل البيانات");

    const item = {
        amount: amt, type, desc: document.getElementById('eDesc').value,
        date: document.getElementById('eDate').value || new Date().toISOString()
    };
    
    await updateBalance(-amt, 'مصروف', item.desc || type);
    await saveData('exp', item);
    db.exp.push(item);
    toastMsg("تم الحفظ");
    openTab('overview');
}

async function addRight() {
    const amt = cleanAmount(document.getElementById('rAmount').value);
    const status = document.getElementById('rStatus').value;
    if (amt <= 0) return toastMsg("أدخل المبلغ");

    const item = { amount: amt, desc: document.getElementById('rDesc').value, status, date: document.getElementById('rDate').value };
    if (status === 'كامل') await updateBalance(amt, 'تحصيل حق', item.desc);
    
    await saveData('rig', item);
    db.rig.push(item);
    toastMsg("تم حفظ الحق");
}

async function addDebt() {
    const amt = cleanAmount(document.getElementById('dAmount').value);
    const status = document.getElementById('dStatus').value;
    if (amt <= 0) return toastMsg("أدخل المبلغ");

    const item = { amount: amt, desc: document.getElementById('dDesc').value, status, date: document.getElementById('dDate').value };
    if (status === 'مدفوع') await updateBalance(-amt, 'دفع التزام', item.desc);
    
    await saveData('deb', item);
    db.deb.push(item);
    toastMsg("تم حفظ الالتزام");
}

function updateStats() {
    document.getElementById('sExpTotal').innerText = db.exp.reduce((s,i)=>s+i.amount,0).toFixed(2);
    document.getElementById('sRigTotal').innerText = db.rig.reduce((s,i)=>s+i.amount,0).toFixed(2);
    document.getElementById('sDebTotal').innerText = db.deb.reduce((s,i)=>s+i.amount,0).toFixed(2);
}

function renderLog(type) {
    const container = document.getElementById('logContent');
    let html = '';
    const items = db[type] || [];
    items.forEach(item => {
        html += `<div class="list-item">
            <b>${item.amount}</b> - ${item.type || item.desc}
            <div style="font-size:10px; color:#888">${new Date(item.date).toLocaleString()}</div>
        </div>`;
    });
    container.innerHTML = html || '<p style="text-align:center">لا توجد بيانات</p>';
}

function openLog(type) {
    renderLog(type);
    openLayer('log');
}

function renderBalanceLog() {
    const container = document.getElementById('balanceLogContent');
    let html = '';
    (db.bal.changes || []).reverse().forEach(ch => {
        const color = ch.amount > 0 ? 'green' : 'red';
        html += `<div class="list-item" style="border-right-color:${color}">
            <b style="color:${color}">${ch.amount}</b> - ${ch.type} (${ch.desc})
        </div>`;
    });
    container.innerHTML = html;
}

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
}

window.onload = async () => {
    await initDB();
    if(localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode');
    document.getElementById('eDate').value = new Date().toISOString().slice(0, 16);
};
</script>

</body>
</html>
