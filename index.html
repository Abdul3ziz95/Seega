<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ميزانيتك الذكية | Smart Budget</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">

<style>
/* ---------------------------------------------------- */
/* Variables and Base Styling */
/* ---------------------------------------------------- */
:root{
    --p: #0077b6; 
    --s: #48cae4; 
    --bg: #f7f9fc; 
    --danger: #ef476f; 
    --success: #2a9d8f;
    --warning: #fbc02d;
    --text-dark: #333;
    --text-light: #f7f9fc;
    --shadow-light: 0 4px 8px rgba(0, 0, 0, 0.08);
    --shadow-hover: 0 6px 15px rgba(0, 0, 0, 0.15);
    --card-bg: #fff;
    --input-bg: #eee;
}

*{ box-sizing: border-box; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; }
body { margin: 0; background-color: var(--bg); color: var(--text-dark); transition: 0.3s; padding-bottom: 70px; }

/* ---------------------------------------------------- */
/* Layout & Sections */
/* ---------------------------------------------------- */
header { background: var(--p); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow-light); }
header h1 { margin: 0; font-size: 1.2rem; }

.container { padding: 15px; max-width: 600px; margin: auto; }
.section { display: none; animation: fadeIn 0.4s ease; }
.section.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* ---------------------------------------------------- */
/* Dashboard & Cards */
/* ---------------------------------------------------- */
.balance-card { background: linear-gradient(135deg, var(--p), var(--s)); color: white; padding: 25px; border-radius: 20px; text-align: center; margin-bottom: 20px; box-shadow: 0 8px 20px rgba(0,119,182,0.3); position: relative; overflow: hidden; }
.balance-card h2 { margin: 0; font-size: 0.9rem; opacity: 0.9; }
.balance-card .amount { font-size: 2.2rem; font-weight: 800; margin: 10px 0; display: block; }
.balance-card .actions { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
.balance-card button { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 8px 15px; border-radius: 10px; cursor: pointer; transition: 0.3s; }
.balance-card button:hover { background: rgba(255,255,255,0.4); }

.stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
.stat-box { background: var(--card-bg); padding: 15px; border-radius: 15px; box-shadow: var(--shadow-light); display: flex; flex-direction: column; align-items: center; text-align: center; }
.stat-box i { font-size: 1.5rem; margin-bottom: 8px; color: var(--p); }
.stat-box span { font-size: 0.8rem; color: #666; }
.stat-box b { font-size: 1.1rem; color: var(--text-dark); margin-top: 5px; }

/* ---------------------------------------------------- */
/* Forms & UI Elements */
/* ---------------------------------------------------- */
.card-form { background: var(--card-bg); padding: 20px; border-radius: 15px; box-shadow: var(--shadow-light); margin-bottom: 20px; }
.form-group { margin-bottom: 15px; }
label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 1rem; outline: none; background: #fafafa; }
input:focus { border-color: var(--p); }

.btn-main { background: var(--p); color: white; border: none; padding: 15px; width: 100%; border-radius: 12px; font-weight: bold; font-size: 1.1rem; cursor: pointer; transition: 0.3s; display: flex; justify-content: center; align-items: center; gap: 10px; }
.btn-main:active { transform: scale(0.98); }

/* ---------------------------------------------------- */
/* Bottom Navigation */
/* ---------------------------------------------------- */
.nav-bottom { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
.nav-item { color: #888; text-decoration: none; display: flex; flex-direction: column; align-items: center; font-size: 0.75rem; cursor: pointer; background: none; border: none; }
.nav-item i { font-size: 1.3rem; margin-bottom: 4px; }
.nav-item.active { color: var(--p); }

/* ---------------------------------------------------- */
/* Overlays / Modals */
/* ---------------------------------------------------- */
.overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: flex-end; }
.modal { background: white; width: 100%; border-radius: 20px 20px 0 0; padding: 25px; animation: slideUp 0.3s ease; max-height: 90vh; overflow-y: auto; }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

#toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 20px; font-size: 0.9rem; display: none; z-index: 5000; }
#toast.show { display: block; }
</style>
</head>
<body>

<header>
    <h1><i class="fas fa-wallet"></i> ميزانيتك الذكية</h1>
    <button onclick="openLayer('settings')" style="background:none; border:none; color:white; font-size:1.4rem;"><i class="fas fa-cog"></i></button>
</header>

<div class="container">
    
    <section id="dashboard" class="section active">
        <div class="balance-card">
            <h2>الرصيد الحالي</h2>
            <span class="amount" id="currentBalanceDisplay">0.00 ر.س</span>
            <div class="actions">
                <button onclick="showBalanceAction('deposit')"><i class="fas fa-plus-circle"></i> إيداع</button>
                <button onclick="showBalanceAction('withdraw')"><i class="fas fa-minus-circle"></i> سحب</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-box">
                <i class="fas fa-arrow-up" style="color:var(--danger)"></i>
                <span>إجمالي المصروفات</span>
                <b id="sExpTotal">0.00</b>
            </div>
            <div class="stat-box">
                <i class="fas fa-hand-holding-usd" style="color:var(--success)"></i>
                <span>حقوق لك (تم تحصيل)</span>
                <b id="sRigPaid">0.00</b>
            </div>
            <div class="stat-box">
                <i class="fas fa-file-invoice-dollar" style="color:var(--warning)"></i>
                <span>التزامات (تم دفع)</span>
                <b id="sDebPaid">0.00</b>
            </div>
            <div class="stat-box">
                <i class="fas fa-calculator"></i>
                <span>صافي الحقوق/الديون</span>
                <b id="sNetStatus">0.00</b>
            </div>
        </div>
    </section>

    <section id="expenses" class="section">
        <div class="card-form">
            <h3><i class="fas fa-cart-plus"></i> إضافة مصروف جديد</h3>
            <div class="form-group">
                <label>المبلغ</label>
                <input type="number" id="eAmount" placeholder="0.00" inputmode="decimal">
            </div>
            <div class="form-group">
                <label>الفئة</label>
                <select id="eType">
                    <option value="طعام">طعام</option>
                    <option value="تسوق">تسوق</option>
                    <option value="فواتير">فواتير</option>
                    <option value="أخرى">أخرى</option>
                </select>
            </div>
            <div class="form-group">
                <label>الوصف</label>
                <input type="text" id="eDesc" placeholder="مثلاً: غداء، فاتورة جوال">
            </div>
            <button class="btn-main" onclick="addExpense()"><i class="fas fa-check"></i> حفظ المصروف</button>
        </div>
    </section>

    <section id="rights" class="section">
        <div class="card-form">
            <h3><i class="fas fa-user-plus"></i> إضافة (حق لك / التزام عليك)</h3>
            <div class="form-group">
                <label>النوع</label>
                <select id="rKind">
                    <option value="right">حق لي (دين عند شخص)</option>
                    <option value="debt">التزام علي (دين لشخص)</option>
                </select>
            </div>
            <div class="form-group">
                <label>المبلغ</label>
                <input type="number" id="rAmount" placeholder="0.00">
            </div>
            <div class="form-group">
                <label>الشخص / الجهة</label>
                <input type="text" id="rPerson" placeholder="اسم الشخص">
            </div>
            <button class="btn-main" onclick="addDebtRight()"><i class="fas fa-save"></i> حفظ العملية</button>
        </div>
    </section>

</div>

<div class="overlay" id="overlay">
    <div class="modal" id="modalContent">
        </div>
</div>

<nav class="nav-bottom">
    <button class="nav-item active" onclick="switchSection('dashboard', this)"><i class="fas fa-home"></i>الرئيسية</button>
    <button class="nav-item" onclick="switchSection('expenses', this)"><i class="fas fa-receipt"></i>المصروفات</button>
    <button class="nav-item" onclick="switchSection('rights', this)"><i class="fas fa-users-cog"></i>الحقوق</button>
</nav>

<div id="toast"></div>

<script>
// ==========================================
// 1. إدارة البيانات (IndexedDB)
// ==========================================
let db;
const request = indexedDB.open("SmartBudgetDB", 1);

request.onupgradeneeded = (e) => {
    db = e.target.result;
    db.createObjectStore("settings", { keyPath: "id" });
    db.createObjectStore("transactions", { keyPath: "id", autoIncrement: true });
};

request.onsuccess = (e) => {
    db = e.target.result;
    initApp();
};

// ==========================================
// 2. المحرك الأساسي للتطبيق
// ==========================================
let currentBalance = 0;
let transactions = [];

async function initApp() {
    await loadData();
    updateUI();
}

async function loadData() {
    return new Promise((resolve) => {
        const tx = db.transaction(["transactions", "settings"], "readonly");
        const store = tx.objectStore("transactions");
        const setStore = tx.objectStore("settings");

        store.getAll().onsuccess = (e) => { transactions = e.target.result; };
        setStore.get("balance").onsuccess = (e) => {
            currentBalance = e.target.result ? e.target.result.value : 0;
            resolve();
        };
    });
}

function updateUI() {
    document.getElementById('currentBalanceDisplay').textContent = currentBalance.toFixed(2) + " ر.س";
    
    const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
    const rightsPaid = transactions.filter(t => t.type === 'right_paid').reduce((sum, t) => sum + t.amount, 0);
    const debtsPaid = transactions.filter(t => t.type === 'debt_paid').reduce((sum, t) => sum + t.amount, 0);

    document.getElementById('sExpTotal').textContent = expenses.toFixed(2);
    document.getElementById('sRigPaid').textContent = rightsPaid.toFixed(2);
    document.getElementById('sDebPaid').textContent = debtsPaid.toFixed(2);
    document.getElementById('sNetStatus').textContent = (rightsPaid - debtsPaid).toFixed(2);
}

// ==========================================
// 3. الوظائف المالية
// ==========================================

function switchSection(id, btn) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

async function addExpense() {
    const amount = parseFloat(document.getElementById('eAmount').value);
    const type = document.getElementById('eType').value;
    const desc = document.getElementById('eDesc').value;

    if (!amount || amount <= 0) return showToast("يرجى إدخال مبلغ صحيح");

    const entry = { type: 'expense', amount, category: type, desc, date: new Date() };
    currentBalance -= amount;

    await saveData(entry);
    showToast("تم حفظ المصروف بنجاح");
    clearInputs(['eAmount', 'eDesc']);
    updateUI();
}

async function addDebtRight() {
    const amount = parseFloat(document.getElementById('rAmount').value);
    const kind = document.getElementById('rKind').value;
    const person = document.getElementById('rPerson').value;

    if (!amount || !person) return showToast("يرجى إكمال البيانات");

    const entry = { type: kind, amount, person, date: new Date(), status: 'pending' };
    await saveData(entry);
    showToast("تم الحفظ في السجلات");
    clearInputs(['rAmount', 'rPerson']);
    updateUI();
}

function showBalanceAction(action) {
    const title = action === 'deposit' ? 'إيداع رصيد' : 'سحب من الرصيد';
    const modal = document.getElementById('modalContent');
    modal.innerHTML = `
        <h3>${title}</h3>
        <div class="form-group">
            <label>المبلغ</label>
            <input type="number" id="modalAmount" placeholder="0.00">
        </div>
        <button class="btn-main" onclick="processBalance('${action}')">تأكيد</button>
        <button class="btn-main" style="background:#888; margin-top:10px;" onclick="closeLayer()">إلغاء</button>
    `;
    document.getElementById('overlay').style.display = 'flex';
}

async function processBalance(action) {
    const amount = parseFloat(document.getElementById('modalAmount').value);
    if (!amount) return;

    if (action === 'deposit') currentBalance += amount;
    else currentBalance -= amount;

    const tx = db.transaction(["settings"], "readwrite");
    tx.objectStore("settings").put({ id: "balance", value: currentBalance });
    
    closeLayer();
    updateUI();
    showToast("تم تحديث الرصيد");
}

// ==========================================
// 4. أدوات مساعدة
// ==========================================

async function saveData(data) {
    const tx = db.transaction(["transactions", "settings"], "readwrite");
    tx.objectStore("transactions").add(data);
    tx.objectStore("settings").put({ id: "balance", value: currentBalance });
    transactions.push(data);
}

function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
}

function closeLayer() {
    document.getElementById('overlay').style.display = 'none';
}

function clearInputs(ids) {
    ids.forEach(id => document.getElementById(id).value = '');
}

function openLayer(type) {
    if(type === 'settings') {
        const modal = document.getElementById('modalContent');
        modal.innerHTML = `
            <h3>الإعدادات والنسخ الاحتياطي</h3>
            <button class="btn-main" onclick="exportData()" style="margin-bottom:10px;"><i class="fas fa-download"></i> تصدير البيانات (Backup)</button>
            <button class="btn-main" style="background:var(--danger)" onclick="resetData()"><i class="fas fa-trash"></i> مسح كافة البيانات</button>
            <button class="btn-main" style="background:#888; margin-top:10px;" onclick="closeLayer()">إغلاق</button>
        `;
        document.getElementById('overlay').style.display = 'flex';
    }
}

function exportData() {
    const dataStr = JSON.stringify({ transactions, currentBalance });
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `budget_backup_${new Date().toLocaleDateString()}.json`;
    a.click();
}

function resetData() {
    if(confirm("هل أنت متأكد من حذف جميع البيانات؟ لا يمكن التراجع!")) {
        const tx = db.transaction(["transactions", "settings"], "readwrite");
        tx.objectStore("transactions").clear();
        tx.objectStore("settings").clear();
        location.reload();
    }
}
</script>

</body>
</html>
