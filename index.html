<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ© | Smart Budget</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">

<style>
/* ---------------------------------------------------- */
/* Variables and Base Styling - LIGHT MODE (Default) */
/* ---------------------------------------------------- */
:root{
    --p: #0077b6; /* Primary Blue (Vibrant) */
    --s: #48cae4; /* Secondary Light Blue */
    --bg: #f7f9fc; /* Light Background */
    --danger: #ef476f; 
    --success: #2a9d8f;
    --warning: #fbc02d;
    --text-dark: #333;
    --text-light: #f7f9fc;
    --shadow-light: 0 4px 8px rgba(0, 0, 0, 0.08);
    --shadow-hover: 0 6px 15px rgba(0, 0, 0, 0.15);
    --card-bg: #fff;
    --input-bg: #fff;
    --border-color: #ddd;
    --tab-active-bg: #fff;
}

/* ---------------------------------------------------- */
/* Dark Mode Variables */
/* ---------------------------------------------------- */
body.dark-mode {
    --p: #90e0ef; /* Lighter Primary Blue for contrast */
    --s: #48cae4; 
    --bg: #1f1f1f; /* Dark Background */
    --danger: #ff8a80;
    --success: #66bb6a;
    --warning: #fbc02d;
    --text-dark: #e0e0e0; /* Light Text */
    --text-light: #1f1f1f;
    --shadow-light: 0 4px 10px rgba(0, 0, 0, 0.5);
    --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.8);
    --card-bg: #2d2d2d;
    --input-bg: #3c3c3c;
    --border-color: #555;
    --tab-active-bg: #2d2d2d;
}

/* ---------------------------------------------------- */
/* Global Reset and Base Styling */
/* ---------------------------------------------------- */
* {
    box-sizing: border-box;
}
body{
    margin:0;
    font-family: 'Tajawal', 'Arial', sans-serif;
    background: var(--bg);
    color: var(--text-dark);
    overflow-x: hidden;
    line-height: 1.6;
    transition: background 0.3s, color 0.3s;
}

/* Global Dark Mode Overrides for Specific Elements */
.card, .sidebar, .modal { background: var(--card-bg); }
.modal header { background: var(--card-bg); border-bottom: 1px solid var(--border-color); }

/* ---------------------------------------------------- */
/* Header & Navigation */
/* ---------------------------------------------------- */
header{
    background: var(--p);
    color: var(--text-light);
    padding: 15px;
    font-size: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-hover);
    position: sticky;
    top: 0;
    z-index: 10;
}
header .title { flex-grow: 1; text-align: center; font-weight: 800; }
header button {
    background: none; 
    border: none; 
    color: var(--text-light); 
    font-size: 20px; 
    cursor: pointer; 
    padding: 0 10px;
    transition: transform 0.2s;
}
header button:hover { transform: scale(1.1); }

.tabs{
    display:flex;
    background: var(--card-bg);
    border-bottom: 2px solid var(--border-color);
    box-shadow: var(--shadow-light);
    overflow-x: auto; /* Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
    white-space: nowrap;
}
.tabs button{
    flex: 1 1 auto; /* Ù…Ø±ÙˆÙ†Ø© Ø£ÙƒØ¨Ø± Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
    min-width: 100px;
    padding: 15px 10px;
    border:none;
    background: var(--card-bg);
    color: var(--text-dark);
    font-weight: 700;
    font-size: 14px;
    transition: all 0.3s;
    border-bottom: 3px solid transparent;
}
.tabs button.active{
    color: var(--p);
    border-bottom: 3px solid var(--p);
    background: color-mix(in srgb, var(--bg) 90%, var(--p)); 
}
body.dark-mode .tabs button.active {
    background: color-mix(in srgb, var(--bg) 85%, var(--p)); 
}

/* ---------------------------------------------------- */
/* General Layout & Cards */
/* ---------------------------------------------------- */
.section{ display:none; padding: 15px; }
.section.active{ display:block; }
.card{
    background:var(--card-bg);
    padding: 20px;
    border-radius: 15px;
    box-shadow: var(--shadow-light);
    margin-bottom: 15px;
    border-top: 5px solid var(--s); 
    transition: background 0.3s, border-color 0.3s;
}

/* ---------------------------------------------------- */
/* Balance Section Styling (New) */
/* ---------------------------------------------------- */
#balance .balance-display {
    text-align: center;
    padding: 30px 20px;
    margin-bottom: 20px;
    border-radius: 15px;
    background: var(--card-bg);
    box-shadow: var(--shadow-hover);
    border: 1px solid var(--border-color);
}
#balance .balance-display h2 {
    margin: 0 0 5px 0;
    font-size: 18px;
    color: #999;
}
#balance .balance-display p {
    font-size: 38px;
    font-weight: 800;
    margin: 5px 0 0 0;
    color: var(--p);
}
#balance .balance-actions {
    display: flex;
    gap: 15px;
}
#balance .balance-actions .action {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    background: var(--card-bg);
    color: var(--text-dark);
    border-radius: 10px;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-light);
    transition: all 0.2s;
}
#balance .balance-actions .action:hover {
    box-shadow: var(--shadow-hover);
    transform: translateY(-2px);
    border-color: var(--p);
}
#balance .balance-actions .action i {
    font-size: 24px;
    margin-bottom: 5px;
}
#balance .balance-actions .deposit i { color: var(--success); }
#balance .balance-actions .withdraw i { color: var(--danger); }

/* ---------------------------------------------------- */
/* Form Elements & Inputs */
/* ---------------------------------------------------- */
input, select, .datetime-container input[type="datetime-local"] {
    width: 100%;
    padding: 14px;
    margin: 8px 0;
    font-size: 16px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    box-sizing: border-box;
    background: var(--input-bg);
    color: var(--text-dark);
    transition: all 0.3s;
}
input:focus, select:focus, .datetime-container input[type="datetime-local"]:focus {
    border-color: var(--s);
    box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.2);
    outline: none;
}
body.dark-mode input:focus, body.dark-mode select:focus, body.dark-mode .datetime-container input[type="datetime-local"]:focus {
    box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.3);
}

.datetime-container { position: relative; width: 100%; margin: 8px 0; }
.datetime-container input[type="datetime-local"] { margin: 0; padding-left: 40px; }

.calendar-icon {
    position: absolute;
    top: 50%;
    left: 15px; 
    transform: translateY(-50%);
    font-size: 1.4em;
    z-index: 2;
    pointer-events: none; 
    color: var(--p); 
}

/* ---------------------------------------------------- */
/* Buttons & Actions */
/* ---------------------------------------------------- */
button.action{
    background: var(--p);
    color: var(--text-light);
    border: none;
    padding: 16px;
    width: 100%;
    border-radius: 10px;
    font-size: 18px;
    font-weight: bold;
    margin-top: 10px;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
    box-shadow: var(--shadow-light);
}
button.action:hover{
    background: color-mix(in srgb, var(--p) 85%, black); 
    transform: translateY(-2px);
}

button.secondary{
    background: var(--input-bg);
    color: var(--text-dark);
    padding: 12px;
    width: 100%;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    margin-top: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s;
}
button.secondary:hover {
    background: color-mix(in srgb, var(--input-bg) 80%, #999); 
}

/* ---------------------------------------------------- */
/* Utility & Custom Elements */
/* ---------------------------------------------------- */
.toast{
    position:fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: var(--text-light);
    padding: 12px 25px;
    border-radius: 30px;
    display:none;
    z-index: 100;
    font-size: 15px;
    box-shadow: var(--shadow-hover);
    white-space: nowrap;
}

.currency-symbol { color: var(--p); font-weight: bold; font-size: 1.1em; margin-right: 5px; }

/* ---------------------------------------------------- */
/* Modals and Sidebar Refinements */
/* ---------------------------------------------------- */
.modal{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background: var(--bg);
    display:none;
    flex-direction:column;
    z-index: 30;
    overflow-y: auto;
}
.modal header{
    display:flex;
    gap: 10px;
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    background: var(--card-bg);
    align-items: center;
    box-shadow: var(--shadow-light);
    position: sticky;
    top: 0;
    z-index: 35;
}
.modal header .title { flex-grow: 1; text-align: center; font-weight: 700; }
.modal header button {
    background: none; 
    border: none; 
    color: var(--text-dark); 
    font-size: 20px; 
    cursor: pointer; 
    padding: 0 10px;
}
.modal-content {
    flex-grow: 1;
    padding: 15px;
}

.sidebar {
    position: fixed;
    top: 0;
    right: 0; 
    width: 300px; 
    max-width: 85%;
    height: 100%;
    background: var(--card-bg);
    box-shadow: -4px 0 12px rgba(0, 0, 0, 0.2);
    transform: translateX(100%); 
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
    z-index: 25; 
    display: flex;
    flex-direction: column;
}
.sidebar.open { transform: translateX(0); }

/* Switch Style (Dark Mode) */
.switch-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    font-size: 17px;
    color: var(--text-dark);
}
.switch { position: relative; display: inline-block; width: 45px; height: 25px; }
.switch input {opacity: 0; width: 0; height: 0;}
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: var(--border-color); transition: .4s; border-radius: 25px;
}
.slider:before {
    position: absolute; content: ""; height: 19px; width: 19px; left: 3px; bottom: 3px;
    background-color: white; transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: var(--p); }
input:checked + .slider:before { transform: translateX(20px); }

/* Sidebar */
.sidebar-header {
    padding: 15px;
    background: var(--p);
    color: var(--text-light);
    font-size: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
}
.sidebar-content {
    flex-grow: 1;
    padding: 15px 0;
    overflow-y: auto;
}

.sidebar-menu-item {
    padding: 15px 20px;
    margin: 5px 0;
    display: flex;
    align-items: center;
    justify-content: space-between; 
    gap: 15px;
    font-size: 17px;
    color: var(--text-dark);
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
}

.sidebar-menu-item:hover {
    background: var(--s);
    color: var(--text-dark); /* Ù„Ø§ ÙŠØªØºÙŠØ± Ø§Ù„Ù„ÙˆÙ† Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¨Ø§ÙŠÙ† Ø§Ù„Ø¹Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ø¯Ø§Ø±Ùƒ Ù…ÙˆØ¯ */
}
.sidebar-menu-item i { font-size: 1.2em; }

.sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    z-index: 24;
}
.sidebar-overlay.open { display: block; }

/* Toast Animation */
.toast.show{
    display:block;
    animation: fadeInOut 2.5s ease-in-out forwards;
}

@keyframes fadeInOut {
    0% { opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { opacity: 0; }
}

/* List Item */
.list-item{
    background: var(--card-bg);
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    border-right: 5px solid var(--s); 
    color: var(--text-dark);
}
.list-item:hover {
    background: color-mix(in srgb, var(--card-bg) 95%, #999);
    box-shadow: var(--shadow-light);
}
.list-item .details {
    font-size: 0.9em; 
    color: #666; 
    text-align: right;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 5px;
}
</style>
</head>

<body>

<header>
    <button onclick="openSidebar()"><i class="fas fa-bars"></i></button> 
    <span class="title">Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</span>
    <button style="visibility: hidden;"><i class="fas fa-search"></i></button> 
</header>

<div class="tabs">
    <button class="active" onclick="openTab('balance')">
        <i class="fas fa-money-check" style="margin-left: 5px;"></i> Ø§Ù„Ø±ØµÙŠØ¯
    </button>
    <button onclick="openTab('expenses')">
        <i class="fas fa-money-bill-wave" style="margin-left: 5px;"></i> Ù…ØµØ±ÙˆÙØ§Øª
    </button>
    <button onclick="openTab('rights')">
        <i class="fas fa-handshake" style="margin-left: 5px;"></i> Ø­Ù‚ÙˆÙ‚
    </button>
    <button onclick="openTab('debts')">
        <i class="fas fa-file-invoice" style="margin-left: 5px;"></i> Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    </button>
    <button onclick="openTab('stats')">
        <i class="fas fa-chart-line" style="margin-left: 5px;"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    </button>
</div>

<div id="balance" class="section active">
    <div class="balance-display">
        <h2>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
        <p id="currentBalanceDisplay">
            <i class="fas fa-spinner fa-spin"></i>
        </p>
    </div>

    <div class="balance-actions">
        <button class="action deposit" onclick="openBalanceModal('deposit')">
            <i class="fas fa-plus-circle"></i> Ø¥ÙŠØ¯Ø§Ø¹
        </button>
        <button class="action withdraw" onclick="openBalanceModal('withdraw')">
            <i class="fas fa-minus-circle"></i> Ø³Ø­Ø¨
        </button>
    </div>

    <div class="card" style="margin-top: 20px; border-top: 5px solid var(--p);">
        <h3 style="color: var(--p); margin-top: 0;"><i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯</h3>
        <div id="balanceLogContent">
             <p style="text-align: center; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ø±ØµÙŠØ¯ Ù…Ø³Ø¬Ù„Ø©.</p>
        </div>
    </div>
</div>

<div id="expenses" class="section">
    <div class="card">
    <p style="color: var(--danger); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡Ø§ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙˆØ±Ø§Ù‹</p>
    <input id="eAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
    <select id="eType">
    <option value="">ğŸ›’ Ø§Ù„ÙØ¦Ø© (Ù†ÙÙ‚Ø§Øª Ù…ØªØºÙŠØ±Ø©)</option>
    <option>Ø·Ø¹Ø§Ù…</option><option>Ù…ÙˆØ§ØµÙ„Ø§Øª</option>
    <option>Ø±Ø¹Ø§ÙŠØ© Ø´Ø®ØµÙŠØ©</option><option>Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
    <option>ØµØ­Ø©</option><option>ØªØ±ÙÙŠÙ‡</option><option>ØªØ³ÙˆÙ‚</option>
    <option>ØªØ¹Ù„ÙŠÙ…</option><option>ØµÙŠØ§Ù†Ø© ÙˆØ¥ØµÙ„Ø§Ø­</option><option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="eDesc" placeholder="ğŸ“ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
    <div class="datetime-container">
        <input id="eDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    <label for="eImg">Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
    <input id="eImg" type="file" accept="image/*">
    <button class="action" onclick="addExpense()">
        <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ
    </button>
    <button class="secondary" onclick="openLog('exp')">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
    </button>
    </div>
</div>

<div id="rights" class="section">
    <div class="card">
    <p style="color: var(--success); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„Ø© (Ø¯ÙØ¹ Ø§Ù„Ø¯ÙŠÙ†/Ø§Ù„Ø¢Ø¬Ù„) ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
    <select id="rType" onchange="updateRightFields(this.value)">
    <option value="">ğŸ¤ Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚</option>
    <option>Ø¯ÙŠÙ†</option>
    <option>Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„</option>
    <option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="rAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚ (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ)" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
    <div id="rDynamicFields"></div>
    <input id="rDesc" placeholder="ğŸ‘¤ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ù„Ù…Ø¯ÙŠÙ†/Ø§Ù„Ø¬Ù‡Ø©)">
    <div class="datetime-container">
        <input id="rDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    <select id="rStatus">
    <option value="">âœ… Ø§Ù„Ø­Ø§Ù„Ø©</option>
    <option value="ÙƒØ§Ù…Ù„">Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</option>
    <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ Ø¨Ø¹Ø¯</option>
    </select>
    <button class="action" onclick="addRight()">
        <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ø­Ù‚
    </button>
    <button class="secondary" onclick="openLog('rig')">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ‚
    </button>
    </div>
</div>

<div id="debts" class="section">
    <div class="card">
    <p style="color: var(--danger); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø¯ÙØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
    <select id="dType" onchange="updateDebtFields(this.value)">
    <option value="">ğŸ§¾ Ù†ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</option>
    <option>Ø¥ÙŠØ¬Ø§Ø±</option>
    <option>ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
    <option>Ù…Ø§Ø¡</option>
    <option>Ø¥Ù†ØªØ±Ù†Øª</option>
    <option>Ù‚Ø±Ø¶</option> <option>Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ</option> <option>Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø© Ø£Ø®Ø±Ù‰</option>
    <option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="dAmount" type="text" placeholder="ğŸ’µ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©/Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">

    <div id="dDynamicFields"></div>
    <input id="dDesc" placeholder="ğŸ¢ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ù„Ø¯Ø§Ø¦Ù†/Ø§Ù„Ø¬Ù‡Ø©)">
    <div class="datetime-container">
        <input id="dDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    <select id="dStatus">
    <option value="">âœ… Ø§Ù„Ø­Ø§Ù„Ø©</option>
    <option value="Ù…Ø¯ÙÙˆØ¹">Ù…Ø¯ÙÙˆØ¹</option>
    <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
    </select>
    <button class="action" onclick="addDebt()">
        <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…
    </button>
    <button class="secondary" onclick="openLog('deb')">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    </button>
    </div>
</div>

<div id="stats" class="section">
    <div class="card">
    <h3><i class="fas fa-calculator" style="margin-left: 5px;"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
    <p><span>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ:</span> <b id="sCurrentBalance" style="color: var(--success);">0</b></p>
    <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (ØªØ´Ù…Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª):</span> <b id="sExpTotal">0</b></p>
    <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©:</span> <b id="sRigTotal">0</b></p>
    <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©:</span> <b id="sDebTotal">0</b></p>
    </div>
    <div class="card">
    <h3><i class="fas fa-money-bill-wave" style="margin-left: 5px;"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
    <p><span>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª:</span> <b id="sExpCount">0</b></p>
    <p><span>Ø£Ø¹Ù„Ù‰ ÙØ¦Ø©:</span> <b id="sTopCat">â€”</b></p>
    </div>
    <div class="card">
    <h3><i class="fas fa-hand-holding-usd" style="margin-left: 5px;"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ‚ (Ù„Ùƒ)</h3>
    <p><span>Ø§Ù„Ù…Ø­ØµÙ„:</span> <b id="sRigPaid">0</b></p>
    <p><span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ØªØ­ØµÙŠÙ„Ù‡:</span> <b id="sRigUnpaid">0</b></p>
    </div>
    <div class="card">
    <h3><i class="fas fa-money-check-alt" style="margin-left: 5px;"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª (Ø¹Ù„ÙŠÙƒ)</h3>
    <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†:</span> <b id="sDebPaid">0</b></p>
    <p><span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©:</span> <b id="sDebUnpaid">0</b></p>
    </div>
</div>

<div class="modal" id="logModal">
    <header>
        <input id="search" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„..." oninput="renderLog()">
        <button onclick="closeLog()"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content" id="logContent"></div>
</div>

<div class="modal" id="detailModal">
    <header>
        <span class="title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</span>
        <button onclick="closeDetailAndClearEditMode()"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content detail" id="detailContent"></div>
</div>

<div class="modal" id="balanceActionModal">
    <header>
        <span class="title" id="balanceModalTitle"></span>
        <button onclick="closeBalanceModal()"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <p style="text-align: center; font-size: 1.1em;">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="currentBalanceInModal" style="color: var(--p); font-weight: bold;"></span></p>
        <input id="bAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
        <input id="bDesc" placeholder="ğŸ“ ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Ù…Ø«Ù„: Ø±Ø§ØªØ¨ØŒ ØªØ­ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ)">
        <div class="datetime-container">
            <input id="bDate" type="datetime-local">
            <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
        </div>
        <button class="action" onclick="processBalanceAction()">
            <i class="fas fa-check" style="margin-left: 5px;"></i> ØªÙ†ÙÙŠØ°
        </button>
    </div>
</div>


<div class="toast" id="toast"></div>

<div class="sidebar-overlay" onclick="closeSidebar()"></div>

<div class="sidebar" id="appSidebar">
    <div class="sidebar-header">
        <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        <button onclick="closeSidebar()"><i class="fas fa-times"></i></button>
    </div>
    <div class="sidebar-content">
        <div class="card" style="margin: 0 15px 15px; border-top: 5px solid var(--s);">
             <p style="font-weight: bold; margin-top: 0; color: var(--p);">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</p>
             
             <div class="switch-container">
                 <i class="fas fa-moon" style="margin-left: 10px;"></i> <span>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span>
                 <label class="switch">
                     <input type="checkbox" id="darkModeToggle" onclick="toggleDarkMode()">
                     <span class="slider"></span>
                 </label>
             </div>
             
             <button class="secondary" onclick="openCurrencyModal()" style="display: flex; justify-content: space-between; align-items: center; border: none; background: var(--card-bg); margin-top: 15px;">
                 <span id="currentCurrencyDisplay" style="font-weight: bold;">Ø§Ù„Ø¹Ù…Ù„Ø©: Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ (Ø±.Ø³)</span>
                 <span style="color: var(--p);"><i class="fas fa-exchange-alt"></i> ØªØºÙŠÙŠØ±</span>
             </button>
        </div>
        
        <div class="sidebar-menu-item" onclick="exportData()">
            <i class="fas fa-file-export"></i> <span>ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</span>
        </div>
        
        <div class="sidebar-menu-item" onclick="document.getElementById('importFile').click()">
            <i class="fas fa-file-import"></i> <span>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</span>
        </div>
        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
        
        <div class="sidebar-menu-item" onclick="openAboutModal()">
            <i class="fas fa-info-circle"></i> <span>Ø­ÙˆÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>
        </div>
        
        <div class="sidebar-menu-item" onclick="confirmResetData()" style="color: var(--danger);">
            <i class="fas fa-exclamation-triangle"></i> <span>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        </div>
    </div>
</div>

<div class="modal" id="aboutModal">
    <header>
        <h3 style="color: var(--p);">Ø­ÙˆÙ„ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ©</h3>
        <button onclick="closeAboutModal()"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <p>ØªØ·Ø¨ÙŠÙ‚ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© Ù‡Ùˆ Ø£Ø¯Ø§Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ ØªØªØ¨Ø¹:</p>
        <ul>
            <li><i class="fas fa-wallet" style="color: var(--s);"></i> **Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø©** Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.</li>
            <li><i class="fas fa-receipt" style="color: var(--s);"></i> **Ø§Ù„Ø­Ù‚ÙˆÙ‚** Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ù„Ùƒ (Ø¯ÙŠÙˆÙ†ØŒ Ø¨ÙŠØ¹ Ø¢Ø¬Ù„).</li>
            <li><i class="fas fa-clipboard-list" style="color: var(--s);"></i> **Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª** Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ø¹Ù„ÙŠÙƒ (ÙÙˆØ§ØªÙŠØ±ØŒ Ø£Ù‚Ø³Ø§Ø·ØŒ Ù‚Ø±ÙˆØ¶).</li>
        </ul>
        <p class="card" style="border-top: 3px solid var(--danger);">
            <strong>Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©:</strong> ÙŠØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ© IndexedDBØŒ ÙˆÙ„Ø§ ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ø£ÙŠ Ø®Ø§Ø¯Ù… Ø®Ø§Ø±Ø¬ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ.
        </p>
        <p style="text-align: center; margin-top: 20px; color: #999; font-size: 0.9em;">Ø§Ù„Ø¥ØµØ¯Ø§Ø± 2.0 (Ù…Ø·ÙˆØ±)</p>
    </div>
</div>

<div class="modal" id="currencyModal">
    <header>
        <h3 style="color: var(--p);">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø©</h3>
        <button onclick="closeCurrencyModal()"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <input id="currencySearch" type="text" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„Ø© (Ø±ÙŠØ§Ù„ØŒ Ø¬Ù†ÙŠÙ‡ØŒ Ø¯ÙˆÙ„Ø§Ø±...)" oninput="renderCurrencyList()">
        <div id="currencyList">
            </div>
    </div>
</div>

<script>
// ===================================================
// 1. Ø¥Ø¹Ø¯Ø§Ø¯ IndexedDB ÙˆÙ…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Øª
// ===================================================

const IDB_NAME = "MySmartBudgetDB";
const IDB_VERSION = 3; // ØªÙ… Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ù„Ø¥Ø¶Ø§ÙØ© store Ø¬Ø¯ÙŠØ¯ (bal)
const STORE_NAMES = ["exp", "rig", "deb", "bal"]; 
let db = { exp: [], rig: [], deb: [], bal: [] }; 
let IDB_connection = null; 

let currentLog = "", editMode = null, balanceActionType = null;
let currentBalance = 0; 
let historyStack = [];

const ARABIC_CURRENCIES = [
    { code: 'SAR', symbol: 'Ø±.Ø³', name: 'Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ' },
    { code: 'EGP', symbol: 'Ø¬.Ù…', name: 'Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ' },
    { code: 'AED', symbol: 'Ø¯.Ø¥', name: 'Ø¯Ø±Ù‡Ù… Ø¥Ù…Ø§Ø±Ø§ØªÙŠ' },
    { code: 'KWD', symbol: 'Ø¯.Ùƒ', name: 'Ø¯ÙŠÙ†Ø§Ø± ÙƒÙˆÙŠØªÙŠ' },
    { code: 'USD', symbol: '$', name: 'Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ' },
    { code: 'QAR', symbol: 'Ø±.Ù‚', name: 'Ø±ÙŠØ§Ù„ Ù‚Ø·Ø±ÙŠ' },
    { code: 'OMR', symbol: 'Ø±.Ø¹.', name: 'Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ' },
    { code: 'JOD', symbol: 'Ø¯.Ø§', name: 'Ø¯ÙŠÙ†Ø§Ø± Ø£Ø±Ø¯Ù†ÙŠ' },
    { code: 'EUR', symbol: 'â‚¬', name: 'ÙŠÙˆØ±Ùˆ' },
];

let currentCurrency = ARABIC_CURRENCIES.find(c => c.code === 'SAR'); 

// ===================================================
// 2. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
// ===================================================

function loadDarkModePreference() {
    const isDark = localStorage.getItem('darkMode') === 'true';
    if (isDark) {
        document.body.classList.add('dark-mode');
        const toggle = document.getElementById('darkModeToggle');
        if (toggle) toggle.checked = true;
    }
}

function toggleDarkMode() {
    const isDark = document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', isDark);
}

loadDarkModePreference(); 

// ===================================================
// 3. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ†Ù‚Ù„ (History API V2 & Exit Confirmation)
// ===================================================

// Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ù…Ù…ÙƒÙ† ÙØªØ­Ù‡Ø§
const LAYERS = {
    'sidebar': { elementId: 'appSidebar', type: 'menu', open: _openSidebar, close: _closeSidebar },
    'log': { elementId: 'logModal', type: 'modal', open: _openLog, close: _closeLog },
    'detail': { elementId: 'detailModal', type: 'modal', open: _showDetailById, close: _closeDetailAndClearEditMode },
    'currency': { elementId: 'currencyModal', type: 'modal', open: _openCurrencyModal, close: _closeCurrencyModal },
    'about': { elementId: 'aboutModal', type: 'modal', open: _openAboutModal, close: _closeAboutModal },
    'balanceAction': { elementId: 'balanceActionModal', type: 'modal', open: _openBalanceModal, close: _closeBalanceModal }
};

// ÙˆØ¸ÙŠÙØ© Ø¹Ø§Ù…Ø© Ù„ÙØªØ­ Ø·Ø¨Ù‚Ø© Ù…Ø¹ ØªÙØ¹ÙŠÙ„ History
function openLayer(layerName, data = {}) {
    const layer = LAYERS[layerName];
    if (!layer) return;
    
    // Ù…Ù†Ø¹ Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø© Ù…ÙƒØ±Ø±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø·Ø¨Ù‚Ø© Ø¨Ø§Ù„ÙØ¹Ù„ Ù‡ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    if (historyStack.length > 0 && historyStack[historyStack.length - 1].layer === layerName) return;

    historyStack.push({ layer: layerName, data: data });
    history.pushState({ layer: layerName, data: data }, null, `#${layerName}`);
    layer.open(data);
}

// ÙˆØ¸ÙŠÙØ© Ø¹Ø§Ù…Ø© Ù„Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¹Ø¨Ø± Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ
function closeLayer(layerName) {
    const currentLayer = historyStack[historyStack.length - 1];
    if (currentLayer && currentLayer.layer === layerName) {
        history.back(); // Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ popstate Ù„Ù„Ù‚ÙŠØ§Ù… Ø¨Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨ØµØ±ÙŠ
    } else {
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù€ stackØŒ Ù‚Ù… Ø¨Ø¥ØºÙ„Ø§Ù‚Ù‡ Ø¨ØµØ±ÙŠÙ‹Ø§ ÙÙ‚Ø·
        LAYERS[layerName].close(false); 
    }
}

// Ù…Ø¹Ø§Ù„Ø¬ Ø­Ø¯Ø« Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­/Ø§Ù„Ù‡Ø§ØªÙ
window.onpopstate = (event) => {
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ù…Ù† Ø§Ù„Ù€ stack
    historyStack.pop(); 

    if (historyStack.length === 0) {
        // ÙˆØµÙ„Ù†Ø§ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ø¨Ù‚Ø§Øª Ù…ÙØªÙˆØ­Ø©)
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£ÙŠ Ø·Ø¨Ù‚Ø© Ù…Ø±Ø¦ÙŠØ©ØŒ ÙÙ‡Ø°Ø§ ÙŠØ¹Ù†ÙŠ Ø£Ù† Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„Ù‰ Ø­Ø§Ù„Ø© ÙØ§Ø±ØºØ© (Ø®Ø±ÙˆØ¬)
        
        for (const name in LAYERS) {
            const element = document.getElementById(LAYERS[name].elementId);
            if (element && (element.style.display === 'flex' || element.classList.contains('open'))) {
                LAYERS[name].close(false); // Ø£ØºÙ„Ù‚Ù‡Ø§ Ø¨ØµØ±ÙŠØ§Ù‹
            }
        }
        
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø¥ØºÙ„Ø§Ù‚ Ø£ÙŠ Ø´ÙŠØ¡ Ù…Ø±Ø¦ÙŠØŒ Ù†Ø·Ù„Ù‚ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø®Ø±ÙˆØ¬
        if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŸ")) {
             // ÙŠÙ…ÙƒÙ† Ù‡Ù†Ø§ ÙˆØ¶Ø¹ Ù…Ù†Ø·Ù‚ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„Ø®Ø±ÙˆØ¬ Ù„Ùˆ ÙƒØ§Ù† ØªØ·Ø¨ÙŠÙ‚Ø§Ù‹ Ù‡Ø¬ÙŠÙ†Ø§Ù‹
        } else {
            // Ø¥Ø°Ø§ Ø¶ØºØ· "Ø¥Ù„ØºØ§Ø¡"ØŒ Ù†Ø¹ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ø¥Ù„Ù‰ History Ù„Ù…Ù†Ø¹ Ø§Ù„Ø®Ø±ÙˆØ¬
            const mainState = { layer: 'main' };
            historyStack.push(mainState);
            history.pushState(mainState, null, `#main`);
        }
        return;
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø·Ø¨Ù‚Ø§Øª Ù…ØªØ¨Ù‚ÙŠØ©ØŒ Ø§ÙØªØ­ Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (Ø§Ù„ØªÙŠ ØªÙ… Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„ÙŠÙ‡Ø§)
    const previousState = historyStack[historyStack.length - 1];
    LAYERS[previousState.layer].open(previousState.data, false); // Ø§ÙØªØ­Ù‡Ø§ Ø¨ØµØ±ÙŠØ§Ù‹ Ø¨Ø¯ÙˆÙ† pushState Ø¬Ø¯ÙŠØ¯
};

// ÙˆØ¸Ø§Ø¦Ù ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© (Ø§Ù„Ø¢Ù† ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ historyStack)

function openSidebar() { openLayer('sidebar'); }
function _openSidebar(data, isPush=true) {
    if(isPush) openLayer('sidebar');
    document.getElementById('appSidebar').classList.add('open');
    document.querySelector('.sidebar-overlay').classList.add('open');
}
function closeSidebar() { closeLayer('sidebar'); }
function _closeSidebar(popState=true) {
    if(popState) history.back();
    document.getElementById('appSidebar').classList.remove('open');
    document.querySelector('.sidebar-overlay').classList.remove('open');
}

function openLog(t) { openLayer('log', { logType: t }); }
function _openLog(data, isPush=true) {
    if(isPush) openLayer('log', data);
    currentLog = data.logType;
    document.getElementById("logModal").style.display = "flex";
    renderLog();
}
function closeLog() { closeLayer('log'); }
function _closeLog(popState=true) { 
    if(popState) history.back();
    document.getElementById("logModal").style.display = "none"; 
}

function showDetailById(id, type) {
    const o = db[type].find(item => item.id === id);
    if (!o) return toastMsg("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.");
    
    const index = db[type].findIndex(item => item.id === id);
    if (index === -1) return toastMsg("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙ‡Ø±Ø³ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.");
    
    editMode = { type, index }; 
    
    openLayer('detail', { logType: type, id: id });
}

function _showDetailById(data, isPush=true) {
    if(isPush) openLayer('detail', data);
    const o = db[data.logType].find(item => item.id === data.id);
    if (!o) return;
    const index = db[data.logType].findIndex(item => item.id === data.id);
    editMode = { type: data.logType, index: index }; 
    _renderDetailContent(o, data.logType); 
    document.getElementById("detailModal").style.display = "flex";
}

function closeDetailAndClearEditMode() { closeLayer('detail'); }
function _closeDetailAndClearEditMode(popState=true) {
  if(popState) history.back();
  document.getElementById("detailModal").style.display = "none";
  editMode = null; 
}

// Balance Modal
function openBalanceModal(type) { openLayer('balanceAction', { actionType: type }); }
function _openBalanceModal(data, isPush=true) {
    if(isPush) openLayer('balanceAction', data);
    balanceActionType = data.actionType;
    document.getElementById('balanceModalTitle').textContent = balanceActionType === 'deposit' ? 'Ø¥ÙŠØ¯Ø§Ø¹ Ø±ØµÙŠØ¯ Ø¬Ø¯ÙŠØ¯' : 'Ø³Ø­Ø¨/ØªØ­ÙˆÙŠÙ„ Ø±ØµÙŠØ¯';
    document.getElementById('currentBalanceInModal').innerHTML = formatCurrency(currentBalance);
    document.getElementById('balanceActionModal').style.display = 'flex';
    document.getElementById('bAmount').value = '';
    document.getElementById('bDesc').value = '';
    document.getElementById('bDate').value = new Date().toISOString().slice(0, 16);
}
function closeBalanceModal() { closeLayer('balanceAction'); }
function _closeBalanceModal(popState=true) {
    if(popState) history.back();
    document.getElementById('balanceActionModal').style.display = 'none';
    balanceActionType = null;
}

function openCurrencyModal() { openLayer('currency'); }
function _openCurrencyModal(data, isPush=true) {
    if(isPush) openLayer('currency');
    document.getElementById('currencyModal').style.display = 'flex';
    document.getElementById('currencySearch').value = '';
    renderCurrencyList();
}
function closeCurrencyModal() { closeLayer('currency'); }
function _closeCurrencyModal(popState=true) { 
    if(popState) history.back();
    document.getElementById('currencyModal').style.display = 'none';
}

function openAboutModal() { openLayer('about'); }
function _openAboutModal(data, isPush=true) {
    if(isPush) openLayer('about');
    document.getElementById('aboutModal').style.display = 'flex';
}
function closeAboutModal() { closeLayer('about'); }
function _closeAboutModal(popState=true) { 
    if(popState) history.back();
    document.getElementById('aboutModal').style.display = 'none';
}

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£ÙˆÙ„ÙŠØ© (Ù„Ù…Ù†Ø¹ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„)
window.onload = () => {
    // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø­Ø§Ù„Ø© Ù…Ø­ÙÙˆØ¸Ø©ØŒ Ù‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    if (history.state === null || history.state.layer !== 'main') {
        history.replaceState({ layer: 'main' }, null, '#main');
        historyStack.push({ layer: 'main' });
    } else {
        historyStack.push(history.state);
    }
};

// ===================================================
// 4. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆØ§Ù„Ù…Ù„Ø§Ø­ÙŠØ©
// ===================================================

function formatAmount(input) {
  let value = input.value.replace(/[^\d.]/g, ''); 
  const parts = value.split('.');
  
  if (parts.length > 2) {
    value = parts[0] + '.' + parts.slice(1).join('');
  }
  
  const integerPart = parts[0];
  const decimalPart = parts[1] ? '.' + parts[1] : '';
  
  const number = parseFloat(integerPart.replace(/,/g, '')); 
  let formattedIntegerPart = isNaN(number) ? '' : number.toLocaleString('ar');
  
  if (input.value.endsWith('.') && !decimalPart) {
      formattedIntegerPart += '.';
  }

  input.value = formattedIntegerPart + decimalPart;
}

function parseAmount(amount) {
  // ÙŠØ²ÙŠÙ„ ÙƒÙ„ Ù…Ø§ Ù‡Ùˆ Ù„ÙŠØ³ Ø±Ù‚Ù… Ø£Ùˆ ÙØ§ØµÙ„Ø© Ø¹Ø´Ø±ÙŠØ© (Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ ÙÙˆØ§ØµÙ„ Ø§Ù„Ø£Ù„ÙˆÙ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©/Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©)
  let str = String(amount).replace(/[ØŒ\u066c]/g, '').replace(/[^\d.]/g, ''); 
  // ÙŠØ³ØªØ¨Ø¯Ù„ Ø§Ù„ÙØ§ØµÙ„Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ø¥Ù† ÙˆØ¬Ø¯Øª) Ø¨Ø§Ù„Ù†Ù‚Ø·Ø©
  str = str.replace(/([Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©])/g, (d) => String.fromCharCode(d.charCodeAt(0) - 1632 + 48));

  return parseFloat(str) || 0;
}

function formatCurrency(amount, withColor = false) {
    const num = parseAmount(amount);
    const formattedNum = num.toLocaleString('ar', { 
        minimumFractionDigits: num % 1 === 0 ? 0 : 2,
        maximumFractionDigits: 2 
    });
    
    let colorStyle = '';
    if (withColor) {
        if (num > 0) colorStyle = `style="color: var(--success);"`;
        else if (num < 0) colorStyle = `style="color: var(--danger);"`;
    }

    return `<span ${colorStyle}>${formattedNum} <span class="currency-symbol" style="color: var(--p);">${currentCurrency.symbol}</span></span>`;
}


function formatDateTime(dateString) {
    if (!dateString) return 'â€”';
    const date = new Date(dateString);
    if (isNaN(date)) return 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ§Ù„Ø­';
    return date.toLocaleString('ar-EG', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true 
    });
}

function toastMsg(m) {
  const toast = document.getElementById("toast");
  toast.textContent = m;
  toast.classList.add("show");
  toast.style.animation = 'none';
  toast.offsetHeight; 
  toast.style.animation = null; 
  setTimeout(() => toast.classList.remove("show"), 2500);
}


function clearFields(keepExpenseImage = false) {
  const fields = ['eAmount', 'eDesc', 'eType', 'eDate', 'eImg', 
                  'rAmount', 'rDesc', 'rDate', 'rType', 'rStatus',
                  'dType', 'dAmount', 'dDesc', 'dDate', 'dStatus'];
  fields.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = "";
  });
  
  document.getElementById('rDynamicFields').innerHTML = '';
  document.getElementById('dDynamicFields').innerHTML = '';
}

// ØªØ­Ø¯ÙŠØ« ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© (Ù…Ø¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)
function calculateRightRemaining() {
    const totalInput = document.getElementById('rAmount');
    const paidInput = document.getElementById('rPaidAmount');
    const remainingDisplay = document.getElementById('rRemainingDisplay');

    if (!totalInput || !paidInput || !remainingDisplay) return;

    const total = parseAmount(totalInput.value);
    const paid = parseAmount(paidInput.value);

    const remaining = total - paid;
    
    remainingDisplay.innerHTML = `Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${formatCurrency(remaining.toFixed(2), remaining <= 0)}`;
    remainingDisplay.style.color = remaining > 0 ? 'var(--danger)' : 'var(--success)'; 
}

function updateRightFields(type, currentData = null) {
    const dynamicContainer = document.getElementById('rDynamicFields');
    dynamicContainer.innerHTML = '';
    
    const rStatusSelect = document.getElementById('rStatus'); 
    const rAmountInput = document.getElementById('rAmount');

    rAmountInput.placeholder = "ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚ (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ)";
    rAmountInput.oninput = function() { formatAmount(this); };

    if (type === 'Ø¯ÙŠÙ†') {
        rStatusSelect.style.display = 'none'; 
        rAmountInput.placeholder = "ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø¯ÙŠÙ†";

        dynamicContainer.innerHTML = `
            <div class="datetime-container">
                <input id="rExpectedDate" type="datetime-local">
                <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
            </div>
            <label for="rExpectedDate" style="display:block; font-size: 0.9em; color: #555; text-align: right; padding-right: 15px;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</label>
            
            <input id="rPaidAmount" type="text" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹/Ø§Ù„Ù…Ø­ØµÙ„ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†" oninput="calculateRightRemaining(); formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
            <p id="rRemainingDisplay" style="margin: 0; padding: 10px 0; font-size: 0.9em; color: var(--danger); font-weight: bold;">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: â€”</p>
        `;
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ oninput Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ù„Ù„Ø­Ù‚Ù„ rAmount Ù„Ø¯Ø¹Ù… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ
        rAmountInput.oninput = function() { formatAmount(this); calculateRightRemaining(); };

        // Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        if (currentData) {
            if (document.getElementById('rExpectedDate')) document.getElementById('rExpectedDate').value = currentData.ØªØ§Ø±ÙŠØ®_Ù…ØªÙˆÙ‚Ø¹ || '';
            
            // ÙŠØ¬Ø¨ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ù†Øµ Ù…Ø¹ Ø¹Ù…Ù„Ø© Ø¥Ù„Ù‰ Ø±Ù‚Ù… Ø®Ø§Ù… Ù„Ù„Ø¹Ø±Ø¶
            const paidAmount = parseAmount(currentData.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¯ÙÙˆØ¹) || 0;
            document.getElementById('rPaidAmount').value = paidAmount.toLocaleString('ar');
            
            calculateRightRemaining();
        }

    } else if (type === 'Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„') {
        rStatusSelect.style.display = 'block';
        rAmountInput.placeholder = "ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„";

        dynamicContainer.innerHTML = `
            <div class="datetime-container">
                <input id="rExpectedDate" type="datetime-local">
                <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
            </div>
            <label for="rExpectedDate" style="display:block; font-size: 0.9em; color: #555; text-align: right; padding-right: 15px;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ (Ø¥Ù† ÙˆØ¬Ø¯)</label>
        `;
        if (currentData && document.getElementById('rExpectedDate')) {
            document.getElementById('rExpectedDate').value = currentData.ØªØ§Ø±ÙŠØ®_Ù…ØªÙˆÙ‚Ø¹ || '';
        }
    } else {
        rStatusSelect.style.display = 'block';
    }
}

function calculateInstallmentValue() {
    const totalInput = document.getElementById('dTotalAmount');
    const installmentsInput = document.getElementById('dInstallments');
    const valueDisplay = document.getElementById('dInstallmentValue');

    if (!totalInput || !installmentsInput || !valueDisplay) return;

    const total = parseAmount(totalInput.value);
    const installments = parseInt(installmentsInput.value) || 0;

    if (total > 0 && installments > 0) {
        const value = total / installments;
        valueDisplay.innerHTML = `Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø·: ${formatCurrency(value.toFixed(2))}`;
    } else {
        valueDisplay.textContent = 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø·: â€”';
    }
}

function updateDebtFields(type, currentData = null) {
    const dynamicContainer = document.getElementById('dDynamicFields');
    dynamicContainer.innerHTML = '';
    
    const dAmountInput = document.getElementById('dAmount');
    const dStatusSelect = document.getElementById('dStatus'); 

    if (type === 'Ù‚Ø±Ø¶') {
        dAmountInput.style.display = 'none'; 
        dStatusSelect.style.display = 'none'; 

        dynamicContainer.innerHTML = `
            <input id="dTotalAmount" type="text" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ù‚Ø±Ø¶" oninput="calculateInstallmentValue(); formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
            <input id="dInstallments" type="number" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„ÙƒÙ„ÙŠ" min="1" oninput="calculateInstallmentValue()">
            <p id="dInstallmentValue" style="margin: 0; padding: 10px 0; font-size: 0.9em; color: var(--p); font-weight: bold;">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø·: â€”</p>
            <input id="dPaidInstallments" type="number" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†" min="0">
        `;

        if (currentData) {
            document.getElementById('dTotalAmount').value = parseAmount(currentData.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…).toLocaleString('ar');
            document.getElementById('dInstallments').value = currentData.Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ù‚Ø³Ø§Ø· || '';
            document.getElementById('dPaidInstallments').value = currentData.Ø§Ù„Ø£Ù‚Ø³Ø§Ø·_Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© || 0;
            calculateInstallmentValue();
        }
        
    } else if (type === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ') {
        dAmountInput.style.display = 'none'; 
        dStatusSelect.style.display = 'none'; 

        dynamicContainer.innerHTML = `
            <input id="dTotalAmount" type="text" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø¯ÙŠÙ†" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
            <input id="dPaidAmount" type="text" placeholder="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù†Ù‚Ø¯Ø§Ù‹ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
        `;
        
        if (currentData) {
            document.getElementById('dTotalAmount').value = parseAmount(currentData.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…).toLocaleString('ar');
            const paidAmount = parseAmount(currentData.Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„Ù…Ø¯ÙÙˆØ¹) || 0;
            document.getElementById('dPaidAmount').value = paidAmount.toLocaleString('ar');
        }
        
    } else {
        dAmountInput.style.display = 'block';
        dStatusSelect.style.display = 'block'; 
    }
}

function openTab(id, keepEditMode = false) {
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    
    const button = event && event.currentTarget || document.querySelector(`.tabs button[onclick*="${id}"]`);
    if(button) button.classList.add("active");
    
    if (!keepEditMode) { 
        editMode = null; 
        clearFields(); 
    }
    
    if(id === 'stats') updateStats();
    if(id === 'balance') renderBalanceLog();
}

// ===================================================
// 5. ÙˆØ¸Ø§Ø¦Ù IndexedDB ÙˆØ§Ù„Ø­ÙØ¸ (Ù…Ø­Ø¯Ø«Ø©)
// ===================================================

function initDB() {
  return new Promise((resolve, reject) => {
    if (!window.indexedDB) {
        toastMsg("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… IndexedDB.");
        return reject(new Error("IndexedDB not supported."));
    }

    const request = indexedDB.open(IDB_NAME, IDB_VERSION);

    request.onerror = (e) => {
      console.error("IndexedDB error:", e.target.error);
      reject(e.target.error);
    };

    request.onupgradeneeded = (e) => {
      IDB_connection = e.target.result;
      STORE_NAMES.forEach(storeName => {
        if (!IDB_connection.objectStoreNames.contains(storeName)) {
            // Ø¨Ø§Ù„Ø§Ù†Ø³ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù„Ù‡ Ù…ÙØªØ§Ø­ ÙØ±ÙŠØ¯ Ù„ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            const keyPath = (storeName === 'bal') ? 'clientId' : 'id'; 
            const autoIncrement = (storeName !== 'bal'); 
            IDB_connection.createObjectStore(storeName, { keyPath: keyPath, autoIncrement: autoIncrement });
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ØªØ¬Ø± balØŒ Ø£Ø¶Ù Ø£ÙˆÙ„ Ø³Ø¬Ù„ Ø£Ø³Ø§Ø³ÙŠ
            if(storeName === 'bal') {
                const balStore = e.target.transaction.objectStore('bal');
                balStore.add({ clientId: 1, amount: 0, changes: [] });
            }
        }
      });
    };
    
    request.onsuccess = (e) => {
      IDB_connection = e.target.result;
      resolve(IDB_connection);
      loadAllData().then(() => {
        updateStats();
        updateBalanceDisplay();
      });
    };
  });
}

initDB();

function saveData(storeName, data) {
  return new Promise((resolve, reject) => {
    if (!IDB_connection) return reject(new Error("Database not connected."));

    const transaction = IDB_connection.transaction([storeName], "readwrite");
    const store = transaction.objectStore(storeName);
    const request = store.put(data); 

    request.onsuccess = () => resolve(request.result);
    request.onerror = (e) => reject(e.target.error);
  });
}

function deleteFromDB(storeName, id) {
  return new Promise((resolve, reject) => {
    if (!IDB_connection) return reject(new Error("Database not connected."));

    const transaction = IDB_connection.transaction([storeName], "readwrite");
    const store = transaction.objectStore(storeName);
    const request = store.delete(id); 

    request.onsuccess = () => resolve();
    request.onerror = (e) => reject(e.target.error);
  });
}

function loadStoreData(storeName) {
  return new Promise((resolve) => {
    if (!IDB_connection) return resolve([]); 
    
    const transaction = IDB_connection.transaction([storeName], "readonly");
    const store = transaction.objectStore(storeName);
    const request = store.getAll();

    request.onsuccess = (e) => {
        // Ù…ØªØ¬Ø± bal Ù„Ø§ ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¹ÙƒØ³ Ø§Ù„ØªØ±ØªÙŠØ¨ Ù„Ø£Ù†Ù‡ Ø³Ø¬Ù„ ÙˆØ§Ø­Ø¯
        if(storeName === 'bal') return resolve(e.target.result[0]);
        resolve(e.target.result.reverse());
    };
    request.onerror = () => resolve(storeName === 'bal' ? { clientId: 1, amount: 0, changes: [] } : []);
  });
}

async function loadAllData() {
    const [expData, rigData, debData, balData] = await Promise.all([
        loadStoreData('exp'),
        loadStoreData('rig'),
        loadStoreData('deb'),
        loadStoreData('bal'),
    ]);
    db.exp = expData;
    db.rig = rigData;
    db.deb = debData;
    db.bal = balData || { clientId: 1, amount: 0, changes: [] }; 
    currentBalance = db.bal.amount || 0;
}

function postSaveCleanup(isEditing, type) {
    editMode = null; 
    clearFields(); 
    loadAllData().then(() => {
        updateStats();
        updateBalanceDisplay();
    });
    
    _closeDetailAndClearEditMode(false); 
    
    if (isEditing) {
        _openLog({ logType: type }, false); 
    }
}

// ===================================================
// 6. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±ØµÙŠØ¯ (Current Balance Logic)
// ===================================================

function updateBalanceDisplay() {
    document.getElementById("currentBalanceDisplay").innerHTML = formatCurrency(currentBalance);
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ø±ØµÙŠØ¯
    if (document.getElementById('balance').classList.contains('active')) {
        renderBalanceLog();
    }
}

// ÙˆØ¸ÙŠÙØ© Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø±ØµÙŠØ¯
async function processBalanceChange(amount, type, description, recordId = null, isEdit = false, oldAmount = 0) {
    if (!recordId) recordId = `bal-${Date.now()}`;
    
    const changeAmount = parseAmount(amount);
    let netChange = changeAmount;
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
    if (type === 'expense' || type === 'debt_payment' || type === 'withdraw') {
        netChange *= -1;
    }
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØºÙŠØ± Ø§Ù„ØµØ§ÙÙŠ ÙÙŠ Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø³Ø¨Ø¨ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    if (isEdit) {
        const oldNetChange = oldAmount;
        netChange = netChange - oldNetChange; 
    }
    
    currentBalance = parseAmount(currentBalance) + netChange;
    db.bal.amount = currentBalance;
    
    const newChangeEntry = {
        id: recordId,
        Ø§Ù„ØªØ§Ø±ÙŠØ®: new Date().toISOString().slice(0, 16),
        Ø§Ù„Ù†ÙˆØ¹: description, // ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙˆØµÙ Ø£Ùˆ ÙØ¦Ø©
        Ø§Ù„Ù…Ø¨Ù„Øº: changeAmount,
        Ø§Ù„ØªØ£Ø«ÙŠØ±: (netChange > 0 ? 'Ø¥ÙŠØ¯Ø§Ø¹' : 'Ø®ØµÙ…'),
        Ø§Ù„Ù‚ÙŠÙ…Ø©_Ø§Ù„ØµØ§ÙÙŠØ©: netChange,
        Ø§Ù„Ø±ØµÙŠØ¯_Ø¨Ø¹Ø¯_Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: currentBalance
    };
    
    // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
    const existingIndex = db.bal.changes.findIndex(c => c.id === recordId);
    if (existingIndex > -1) {
        db.bal.changes[existingIndex] = newChangeEntry;
    } else {
        db.bal.changes.unshift(newChangeEntry); // Ø¥Ø¶Ø§ÙØ© ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    }

    try {
        await saveData('bal', db.bal);
        updateBalanceDisplay();
        return true;
    } catch (e) {
        console.error('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø±ØµÙŠØ¯', e);
        currentBalance -= netChange; // Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø§Ù„ØªØºÙŠÙŠØ±
        toastMsg("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯.");
        return false;
    }
}

async function processBalanceAction() {
    const amount = document.getElementById('bAmount').value;
    const desc = document.getElementById('bDesc').value || (balanceActionType === 'deposit' ? 'Ø¥ÙŠØ¯Ø§Ø¹ Ø¹Ø§Ù…' : 'Ø³Ø­Ø¨ Ø¹Ø§Ù…');
    const date = document.getElementById('bDate').value;
    
    if (!amount) return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº.");

    const success = await processBalanceChange(amount, balanceActionType, desc);
    
    if (success) {
        toastMsg(balanceActionType === 'deposit' ? "ØªÙ… Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø¨Ù†Ø¬Ø§Ø­" : "ØªÙ… Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
        closeBalanceModal();
        renderBalanceLog();
    }
}

function renderBalanceLog() {
    const logContent = document.getElementById("balanceLogContent");
    const changes = db.bal.changes || [];
    
    if (changes.length === 0) {
        logContent.innerHTML = `<p style="text-align: center; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ø±ØµÙŠØ¯ Ù…Ø³Ø¬Ù„Ø©.</p>`;
        return;
    }

    logContent.innerHTML = changes
        .map(i => {
            const isDeposit = i.Ø§Ù„ØªØ£Ø«ÙŠØ± === 'Ø¥ÙŠØ¯Ø§Ø¹';
            const color = isDeposit ? 'var(--success)' : 'var(--danger)';
            const icon = isDeposit ? 'fa-arrow-up' : 'fa-arrow-down';
            
            return `
                <div class="list-item" style="border-right-color: ${color};">
                    <div style="font-weight: bold; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;">
                        <span><i class="fas ${icon}" style="margin-left: 8px; color: ${color};"></i> ${i.Ø§Ù„Ù†ÙˆØ¹}</span> 
                        <span style="color: ${color};">${formatCurrency(i.Ø§Ù„Ù…Ø¨Ù„Øº)}</span>
                    </div>
                    <div class="details">
                        <span>Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯: ${formatCurrency(i.Ø§Ù„Ø±ØµÙŠØ¯_Ø¨Ø¹Ø¯_Ø§Ù„Ø¹Ù…Ù„ÙŠØ©)}</span>
                        <span><i class="far fa-clock" style="margin-left: 4px;"></i>${formatDateTime(i.Ø§Ù„ØªØ§Ø±ÙŠØ®)}</span>
                    </div>
                </div>
            `;
        })
        .join("");
}

// ===================================================
// 7. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù (CRUD) - ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ø±ØµÙŠØ¯
// ===================================================

async function addExpense() { 
  const eAmount = document.getElementById('eAmount');
  const eType = document.getElementById('eType');
  const eDate = document.getElementById('eDate');
  const eDesc = document.getElementById('eDesc');
  const eImg = document.getElementById('eImg');

  if (!eAmount.value || !eType.value || !eDate.value) return toastMsg("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  
  const isEditing = editMode && editMode.type === "exp";
  const oldData = isEditing ? db.exp[editMode.index] : {}; 
  const oldAmount = isEditing ? parseAmount(oldData.Ø§Ù„Ù…Ø¨Ù„Øº) : 0;
  
  const amount = parseAmount(eAmount.value);
  
  if (amount === 0) return toastMsg("Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±.");
  
  const data = isEditing ? { ...oldData } : {}; 

  data.Ø§Ù„Ù…Ø¨Ù„Øº = eAmount.value; 
  data.Ø§Ù„ÙØ¦Ø© = eType.value; 
  data.Ø§Ù„ÙˆØµÙ = eDesc.value; 
  data.Ø§Ù„ØªØ§Ø±ÙŠØ® = eDate.value; 
  data.clientId = isEditing ? oldData.clientId : `exp-${Date.now()}`; // Ù„Ø±Ø¨Ø·Ù‡ Ø¨Ø³Ø¬Ù„ Ø§Ù„Ø±ØµÙŠØ¯
  
  const done = async () => {
    try {
        await saveData('exp', data); 
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯
        await processBalanceChange(amount, 'expense', `Ù…ØµØ±ÙˆÙ: ${data.Ø§Ù„ÙØ¦Ø©} (${data.Ø§Ù„ÙˆØµÙ || 'â€”'})`, data.clientId, isEditing, oldAmount);

        toastMsg(isEditing ? "ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ" : "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ");
        
        await loadAllData(); 
        postSaveCleanup(isEditing, 'exp'); 

    } catch (error) {
        toastMsg("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸. ØªØ­Ù‚Ù‚ Ù…Ù† Console.");
        console.error(error);
    }
  };

  if (eImg.files[0]) {
    const r = new FileReader();
    r.onload = () => { 
        data.ØµÙˆØ±Ø© = r.result; 
        done(); 
    };
    r.readAsDataURL(eImg.files[0]);
  } else {
      done(); 
  }
}

async function addRight() {
  const rAmount = document.getElementById('rAmount');
  const rType = document.getElementById('rType');
  const rDate = document.getElementById('rDate');
  const rDesc = document.getElementById('rDesc');
  const rStatus = document.getElementById('rStatus');

  if (!rAmount.value || !rType.value || !rDate.value) return toastMsg("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  
  const isEditing = editMode && editMode.type === "rig";
  const oldData = isEditing ? db.rig[editMode.index] : {};
  const totalAmount = parseAmount(rAmount.value);
  const rExpectedDate = document.getElementById('rExpectedDate');
  
  const data = isEditing ? { ...oldData } : {};
  data.clientId = isEditing ? oldData.clientId : `rig-${Date.now()}`; 

  data.Ø§Ù„Ù†ÙˆØ¹ = rType.value; 
  data.Ø§Ù„Ù…Ø¨Ù„Øº = rAmount.value; 
  data.Ø§Ù„ÙˆØµÙ = rDesc.value; 
  data.Ø§Ù„ØªØ§Ø±ÙŠØ® = rDate.value; 
  data.ØªØ§Ø±ÙŠØ®_Ù…ØªÙˆÙ‚Ø¹ = rExpectedDate ? rExpectedDate.value : null; 
  
  let amountCollected = 0; // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„ Ø§Ù„Ø°ÙŠ Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ø±ØµÙŠØ¯
  let oldAmountCollected = isEditing ? parseAmount(oldData.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¶Ø§Ù_Ù„Ù„Ø±ØµÙŠØ¯ || 0) : 0; 
  
  if (data.Ø§Ù„Ù†ÙˆØ¹ === 'Ø¯ÙŠÙ†') {
      const rPaidAmountInput = document.getElementById('rPaidAmount');
      const paidAmount = rPaidAmountInput ? parseAmount(rPaidAmountInput.value) : 0;
      const remaining = totalAmount - paidAmount;
      
      if (paidAmount > totalAmount) return toastMsg("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø¯ÙŠÙ†.");

      data.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¯ÙÙˆØ¹ = paidAmount.toLocaleString('ar'); 
      data.Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ = remaining.toLocaleString('ar'); 
      
      if (remaining <= 0) {
          data.Ø§Ù„Ø­Ø§Ù„Ø© = "Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„";
      } else if (paidAmount > 0) {
          data.Ø§Ù„Ø­Ø§Ù„Ø© = "Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹";
      } else {
          data.Ø§Ù„Ø­Ø§Ù„Ø© = "ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ Ø¨Ø¹Ø¯";
      }
      amountCollected = paidAmount;
      delete data.Ø§Ù„Ø­Ø§Ù„Ø©_Ø§Ù„ÙŠØ¯ÙˆÙŠØ©;
      
  } else { // Ø¨ÙŠØ¹ Ø¢Ø¬Ù„ Ø£Ùˆ Ø£Ø®Ø±Ù‰
      if (!rStatus.value) return toastMsg("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø©.");
      data.Ø§Ù„Ø­Ø§Ù„Ø© = rStatus.value;
      
      if (data.Ø§Ù„Ø­Ø§Ù„Ø© === 'ÙƒØ§Ù…Ù„') {
          amountCollected = totalAmount;
      } else {
          amountCollected = 0;
      }
      
      delete data.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¯ÙÙˆØ¹;
      delete data.Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ;
  }
  
  // Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ Ø£Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯ Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  data.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¶Ø§Ù_Ù„Ù„Ø±ØµÙŠØ¯ = amountCollected; 
  
  if (isEditing) {
      data.id = oldData.id;
  }
  
  try {
      await saveData('rig', data);
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ (ÙŠØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
      await processBalanceChange(amountCollected, 'right_collection', `ØªØ­ØµÙŠÙ„: ${data.Ø§Ù„Ù†ÙˆØ¹} (${data.Ø§Ù„ÙˆØµÙ || 'â€”'})`, data.clientId, isEditing, oldAmountCollected);

      toastMsg(isEditing ? "ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ù‚" : "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ù‚");
      
      await loadAllData(); 
      postSaveCleanup(isEditing, 'rig');

  } catch (error) {
      toastMsg("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸. ØªØ­Ù‚Ù‚ Ù…Ù† Console.");
      console.error(error);
  }
}

async function addDebt() {
  const dType = document.getElementById('dType');
  const dDate = document.getElementById('dDate');
  const dAmount = document.getElementById('dAmount');
  const dStatus = document.getElementById('dStatus');
  const dDesc = document.getElementById('dDesc');

  if (!dType.value || !dDate.value) return toastMsg("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©");
  
  const isMasterLiability = (dType.value === 'Ù‚Ø±Ø¶' || dType.value === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ');
  
  const isEditing = editMode && editMode.type === "deb";
  const oldData = isEditing ? db.deb[editMode.index] : {};
  
  const data = isEditing ? { ...oldData } : {};
  data.clientId = isEditing ? oldData.clientId : `deb-${Date.now()}`; 

  data.Ø§Ù„Ù†ÙˆØ¹ = dType.value; 
  data.Ø§Ù„ÙˆØµÙ = dDesc.value; 
  data.Ø§Ù„ØªØ§Ø±ÙŠØ® = dDate.value; 
  
  let amountPaid = 0; // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ ØªÙ… Ø¯ÙØ¹Ù‡ ÙˆÙŠØ¬Ø¨ Ø®ØµÙ…Ù‡ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
  let oldAmountPaid = isEditing ? parseAmount(oldData.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø®ØµÙˆÙ…_Ù„Ù„Ø±ØµÙŠØ¯ || 0) : 0; 
  
  if (isMasterLiability) {
      const dTotalAmountInput = document.getElementById('dTotalAmount');
      const dInstallmentsInput = document.getElementById('dInstallments');
      const dPaidInfoInput = document.getElementById(dType.value === 'Ù‚Ø±Ø¶' ? 'dPaidInstallments' : 'dPaidAmount'); 

      if (!dTotalAmountInput.value) return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø§Ù„ØªØ²Ø§Ù….");
      
      const totalAmount = parseAmount(dTotalAmountInput.value);
      let totalPaidAmount = 0;

      if (data.Ø§Ù„Ù†ÙˆØ¹ === 'Ù‚Ø±Ø¶') {
          const paidInstallmentsCount = parseInt(dPaidInfoInput.value) || 0;
          const installmentsTotal = parseInt(dInstallmentsInput.value) || 0;
          
          if (installmentsTotal <= 0) return toastMsg("Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±.");
          if (paidInstallmentsCount > installmentsTotal) return toastMsg("Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„ÙƒÙ„ÙŠ.");

          const installmentValue = totalAmount / installmentsTotal;
          
          // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ ØªÙ… Ø¯ÙØ¹Ù‡ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Ø¥Ø°Ø§ ÙƒØ§Ù† ØªØ¹Ø¯ÙŠÙ„ØŒ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ§Ù„Ø¬Ø¯ÙŠØ¯)
          totalPaidAmount = paidInstallmentsCount * installmentValue;
          
          data.Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ù‚Ø³Ø§Ø· = installmentsTotal;
          data.Ù‚ÙŠÙ…Ø©_Ø§Ù„Ù‚Ø³Ø· = formatCurrency(installmentValue.toFixed(2));
          data.Ø§Ù„Ø£Ù‚Ø³Ø§Ø·_Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© = paidInstallmentsCount;
          
      } else if (data.Ø§Ù„Ù†ÙˆØ¹ === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ') {
          totalPaidAmount = parseAmount(dPaidInfoInput.value);
          
          if (totalPaidAmount > totalAmount) return toastMsg("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø¯ÙŠÙ†.");
          
          delete data.Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ù‚Ø³Ø§Ø·;
          delete data.Ù‚ÙŠÙ…Ø©_Ø§Ù„Ù‚Ø³Ø·;
          delete data.Ø§Ù„Ø£Ù‚Ø³Ø§Ø·_Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©;
      }
      
      const remainingAmount = totalAmount - totalPaidAmount;
      
      data.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù… = dTotalAmountInput.value;
      data.Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„Ù…Ø¯ÙÙˆØ¹ = formatCurrency(totalPaidAmount); 
      data.Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù… = formatCurrency(remainingAmount);
      
      data.Ø§Ù„Ù…Ø¨Ù„Øº = "â€”";
      data.Ø§Ù„Ø­Ø§Ù„Ø© = "â€”";
      
      amountPaid = totalPaidAmount; // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†
      
  } else {
      if (!dAmount.value || !dStatus.value) return toastMsg("Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©/Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø¹Ø§Ø¯ÙŠ.");

      data.Ø§Ù„Ù…Ø¨Ù„Øº = dAmount.value; 
      data.Ø§Ù„Ø­Ø§Ù„Ø© = dStatus.value;
      
      if (data.Ø§Ù„Ø­Ø§Ù„Ø© === 'Ù…Ø¯ÙÙˆØ¹') {
          amountPaid = parseAmount(dAmount.value);
      } else {
          amountPaid = 0;
      }
      
      delete data.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…;
      delete data.Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„Ù…Ø¯ÙÙˆØ¹;
      delete data.Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…;
      delete data.Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ù‚Ø³Ø§Ø·;
      delete data.Ù‚ÙŠÙ…Ø©_Ø§Ù„Ù‚Ø³Ø·;
      delete data.Ø§Ù„Ø£Ù‚Ø³Ø§Ø·_Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©;
  }
  
  // Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ Ø£Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯ Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  data.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø®ØµÙˆÙ…_Ù„Ù„Ø±ØµÙŠØ¯ = amountPaid; 
  
  if (isEditing) {
      data.id = oldData.id;
  }
  
  try {
      await saveData('deb', data);
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯
      await processBalanceChange(amountPaid, 'debt_payment', `Ø¯ÙØ¹Ø© Ø§Ù„ØªØ²Ø§Ù…: ${data.Ø§Ù„Ù†ÙˆØ¹} (${data.Ø§Ù„ÙˆØµÙ || 'â€”'})`, data.clientId, isEditing, oldAmountPaid);

      toastMsg(isEditing ? "ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…" : "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…");
      
      await loadAllData(); 
      postSaveCleanup(isEditing, 'deb');

  } catch (error) {
      toastMsg("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸. ØªØ­Ù‚Ù‚ Ù…Ù† Console.");
      console.error(error);
  }
}


function editTransaction() {
  if (!editMode) return;
  const currentData = db[editMode.type][editMode.index];
  
  closeDetailAndClearEditMode(); 

  // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ø¶Ù…Ø§Ù† Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆØ¹ÙˆØ¯Ø© Ø§Ù„ØªØ±ÙƒÙŠØ² Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  setTimeout(() => {
    
    // 1. ÙØªØ­ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
    openTab(editMode.type === 'exp' ? 'expenses' : (editMode.type === 'rig' ? 'rights' : 'debts'), true); 

    // 2. Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    if (editMode.type === "exp") {
      document.getElementById('eAmount').value = parseAmount(currentData.Ø§Ù„Ù…Ø¨Ù„Øº).toLocaleString('ar');
      document.getElementById('eType').value = currentData.Ø§Ù„ÙØ¦Ø©;
      document.getElementById('eDesc').value = currentData.Ø§Ù„ÙˆØµÙ;
      document.getElementById('eDate').value = currentData.Ø§Ù„ØªØ§Ø±ÙŠØ®;
    }
    
    if (editMode.type === "rig") {
      document.getElementById('rType').value = currentData.Ø§Ù„Ù†ÙˆØ¹;
      // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      updateRightFields(currentData.Ø§Ù„Ù†ÙˆØ¹, currentData); 
      
      document.getElementById('rAmount').value = parseAmount(currentData.Ø§Ù„Ù…Ø¨Ù„Øº).toLocaleString('ar');
      document.getElementById('rDesc').value = currentData.Ø§Ù„ÙˆØµÙ;
      document.getElementById('rDate').value = currentData.Ø§Ù„ØªØ§Ø±ÙŠØ®;
      
      // Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ ØºÙŠØ± Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
      if (currentData.Ø§Ù„Ù†ÙˆØ¹ !== 'Ø¯ÙŠÙ†') {
          document.getElementById('rStatus').value = currentData.Ø§Ù„Ø­Ø§Ù„Ø© === 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„' ? 'ÙƒØ§Ù…Ù„' : currentData.Ø§Ù„Ø­Ø§Ù„Ø©;
      }
    }
    
    if (editMode.type === "deb") {
      document.getElementById('dType').value = currentData.Ø§Ù„Ù†ÙˆØ¹;
      document.getElementById('dDesc').value = currentData.Ø§Ù„ÙˆØµÙ;
      document.getElementById('dDate').value = currentData.Ø§Ù„ØªØ§Ø±ÙŠØ®;

      // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      updateDebtFields(currentData.Ø§Ù„Ù†ÙˆØ¹, currentData); 

      if (currentData.Ø§Ù„Ù†ÙˆØ¹ !== 'Ù‚Ø±Ø¶' && currentData.Ø§Ù„Ù†ÙˆØ¹ !== 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ') {
          document.getElementById('dAmount').value = parseAmount(currentData.Ø§Ù„Ù…Ø¨Ù„Øº).toLocaleString('ar');
          document.getElementById('dStatus').value = currentData.Ø§Ù„Ø­Ø§Ù„Ø©;
      }
    }
  }, 300); // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØªØ£Ø®ÙŠØ± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„ÙˆØ«ÙˆÙ‚ÙŠØ©
}

async function deleteTransaction() {
  if (!editMode) return;
  if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŸ Ø³ÙŠØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† ØªØ£Ø«ÙŠØ±Ù‡Ø§ Ø¹Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£ÙŠØ¶Ø§Ù‹.")) return;
  
  const typeToDelete = editMode.type;
  const transaction = db[typeToDelete][editMode.index];
  const idToDelete = transaction.id;
  
  try {
      await deleteFromDB(typeToDelete, idToDelete);
      
      // Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† ØªØ£Ø«ÙŠØ± Ø§Ù„Ø±ØµÙŠØ¯: Ù†Ø¬Ø¯ Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ db.bal.changes ÙˆÙ†Ø¹ÙƒØ³ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
      if (transaction.clientId) {
          const balanceRecord = db.bal.changes.find(c => c.id === transaction.clientId);
          if (balanceRecord) {
              const reversedAmount = balanceRecord.Ø§Ù„Ù‚ÙŠÙ…Ø©_Ø§Ù„ØµØ§ÙÙŠØ© * -1;
              const newDescription = `Ø¥Ù„ØºØ§Ø¡ Ù…Ø¹Ø§Ù…Ù„Ø©: ${balanceRecord.Ø§Ù„Ù†ÙˆØ¹}`;
              
              // Ù†Ø³ØªØ®Ø¯Ù… processBalanceChange Ø¨Ù‚ÙŠÙ…Ø© ØµÙØ± ÙˆØ¨Ø¥Ø´Ø§Ø±Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (isEdit=true) Ù„Ù€ oldAmount
              // Ø§Ù„Ù‡Ø¯Ù: Ø¹Ù…Ù„ÙŠØ© "Ø¥Ø²Ø§Ù„Ø©" Ù„Ø¢Ø«Ø§Ø± Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
              await processBalanceChange(0, 'revert', newDescription, transaction.clientId, true, balanceRecord.Ø§Ù„Ù‚ÙŠÙ…Ø©_Ø§Ù„ØµØ§ÙÙŠØ©);
              
              // Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø±ØªØ¨Ø·
              const balIndex = db.bal.changes.findIndex(c => c.id === transaction.clientId);
              if (balIndex > -1) {
                  db.bal.changes.splice(balIndex, 1);
                  db.bal.amount = currentBalance; // ØªØ£ÙƒÙŠØ¯ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø±ØµÙŠØ¯
                  await saveData('bal', db.bal);
              }
          }
      }

      editMode = null; 
      await loadAllData(); 
      toastMsg("ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­");
      
      updateStats();
      updateBalanceDisplay();
      
      closeDetailAndClearEditMode();
      
  } catch (error) {
      toastMsg("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù.");
      console.error(error);
  }
}

// ===================================================
// 8. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ù…Ø­Ø¯Ø«Ø©)
// ===================================================

function updateStats() {
  let et = 0, ec = 0; 
  let cats = {}; 
  
  let rt = 0, rp = 0, ru = 0; 
  let dt = 0, dp = 0, du = 0; 

  // 1. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø©
  db.exp.forEach(e => { 
    let a = parseAmount(e.Ø§Ù„Ù…Ø¨Ù„Øº); 
    et += a; 
    ec++;
    cats[e.Ø§Ù„ÙØ¦Ø©] = (cats[e.Ø§Ù„ÙØ¦Ø©] || 0) + a;
  });

  // 2. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙˆØ§Ù„Ù†Ù‚Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©
  db.deb.forEach(d => { 
    const isMasterLiability = (d.Ø§Ù„Ù†ÙˆØ¹ === 'Ù‚Ø±Ø¶' || d.Ø§Ù„Ù†ÙˆØ¹ === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ');
    
    if (isMasterLiability) {
        const totalLiability = parseAmount(d.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…);
        const paidAmount = parseAmount(d.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø®ØµÙˆÙ…_Ù„Ù„Ø±ØµÙŠØ¯ || 0); // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ ØªÙ… Ø®ØµÙ…Ù‡ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
        
        dt += totalLiability; 
        dp += paidAmount;
        
        const remaining = totalLiability - paidAmount;
        du += remaining;
        
        if (paidAmount > 0) {
            et += paidAmount; 
            ec++; 
            const category = `Ø§Ù„ØªØ²Ø§Ù… Ù…Ø¯ÙÙˆØ¹: ${d.Ø§Ù„Ù†ÙˆØ¹}`; 
            cats[category] = (cats[category] || 0) + paidAmount;
        }

    } else {
        let amount = parseAmount(d.Ø§Ù„Ù…Ø¨Ù„Øº); 
        dt += amount; 
        
        if (d.Ø§Ù„Ø­Ø§Ù„Ø© === "Ù…Ø¯ÙÙˆØ¹") {
            dp += amount;
            
            et += amount; 
            ec++;
            
            const category = `Ø§Ù„ØªØ²Ø§Ù… Ù…Ø¯ÙÙˆØ¹: ${d.Ø§Ù„Ù†ÙˆØ¹}`; 
            cats[category] = (cats[category] || 0) + amount;
        } else {
            du += amount;
        }
    }
  });
  
  // 3. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ù‚ÙˆÙ‚
  db.rig.forEach(r => { 
    let a = parseAmount(r.Ø§Ù„Ù…Ø¨Ù„Øº); 
    rt += a; 
    
    if (r.Ø§Ù„Ù†ÙˆØ¹ === 'Ø¯ÙŠÙ†') {
        const paid = parseAmount(r.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¶Ø§Ù_Ù„Ù„Ø±ØµÙŠØ¯ || 0); // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„
        rp += paid;
        ru += a - paid;

    } else {
        // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¶Ø§Ù Ù„Ù„Ø±ØµÙŠØ¯
        const addedToBalance = parseAmount(r.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¶Ø§Ù_Ù„Ù„Ø±ØµÙŠØ¯ || 0);
        rp += addedToBalance;
        ru += a - addedToBalance;
    }
  });

  // ØªØ­Ø¯ÙŠØ¯ Ø£Ø¹Ù„Ù‰ ÙØ¦Ø© Ù…ØµØ±ÙˆÙØ§Øª
  let topCatName = 'â€”';
  let maxCatAmount = 0;
  for (let cat in cats) { 
    if (cats[cat] > maxCatAmount) {
      maxCatAmount = cats[cat];
      topCatName = cat;
    }
  }
  
  if (topCatName.startsWith('Ø§Ù„ØªØ²Ø§Ù… Ù…Ø¯ÙÙˆØ¹:')) {
      topCatName = `Ù…Ù† Ø§Ù„ØªØ²Ø§Ù…Ø§Øª: ${topCatName.substring(topCatName.indexOf(':') + 1)}`;
  }

  // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
  document.getElementById("sCurrentBalance").innerHTML = formatCurrency(currentBalance, true); 
  document.getElementById("sExpTotal").innerHTML = formatCurrency(et); 
  document.getElementById("sExpCount").textContent = ec;
  document.getElementById("sTopCat").textContent = topCatName;
  
  document.getElementById("sRigTotal").innerHTML = formatCurrency(rt); 
  document.getElementById("sRigPaid").innerHTML = formatCurrency(rp); 
  document.getElementById("sRigUnpaid").innerHTML = formatCurrency(ru);
  
  document.getElementById("sDebTotal").innerHTML = formatCurrency(dt); 
  document.getElementById("sDebPaid").innerHTML = formatCurrency(dp); 
  document.getElementById("sDebUnpaid").innerHTML = formatCurrency(du);
}

function loadCurrencyPreference() {
    const savedCode = localStorage.getItem('selectedCurrencyCode');
    if (savedCode) {
        const found = ARABIC_CURRENCIES.find(c => c.code === savedCode);
        if (found) {
            currentCurrency = found;
        }
    }
    updateCurrencyDisplay();
}

function saveCurrencyPreference(code) {
    localStorage.setItem('selectedCurrencyCode', code);
}

function updateCurrencyDisplay() {
    const displayElement = document.getElementById('currentCurrencyDisplay');
    if (displayElement) {
        displayElement.textContent = `Ø§Ù„Ø¹Ù…Ù„Ø©: ${currentCurrency.name} (${currentCurrency.symbol})`;
    }
    updateStats(); 
    if (document.getElementById("logModal").style.display === "flex") renderLog();
    if (document.getElementById("balance").classList.contains("active")) renderBalanceLog();
}

loadCurrencyPreference(); 

function renderCurrencyList() {
    const list = document.getElementById('currencyList');
    const searchTerm = document.getElementById('currencySearch').value.toLowerCase();

    const filtered = ARABIC_CURRENCIES.filter(c => 
        c.name.toLowerCase().includes(searchTerm) || 
        c.code.toLowerCase().includes(searchTerm) ||
        c.symbol.includes(searchTerm)
    );

    list.innerHTML = filtered.map(c => `
        <div class="sidebar-menu-item" onclick="selectCurrency('${c.code}')">
            <span>${c.name} (${c.symbol})</span>
            ${c.code === currentCurrency.code ? '<span style="color: var(--s); font-weight: bold;"><i class="fas fa-check-circle"></i> Ø§Ù„Ø­Ø§Ù„ÙŠØ©</span>' : ''}
        </div>
    `).join('');
}

function selectCurrency(code) {
    const newCurrency = ARABIC_CURRENCIES.find(c => c.code === code);
    if (newCurrency) {
        currentCurrency = newCurrency;
        saveCurrencyPreference(code);
        updateCurrencyDisplay();
        _closeCurrencyModal(false); 
        toastMsg(`ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø© Ø¥Ù„Ù‰: ${newCurrency.name}`);
    }
}


function exportData() {
    closeSidebar();
    
    if (!IDB_connection) return toastMsg("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");

    const transaction = IDB_connection.transaction(STORE_NAMES, "readonly");
    const dataToExport = {};
    let storesProcessed = 0;
    
    STORE_NAMES.forEach(storeName => {
        const store = transaction.objectStore(storeName);
        const request = store.getAll();

        request.onsuccess = (event) => {
            dataToExport[storeName] = event.target.result;
            storesProcessed++;
            
            if (storesProcessed === STORE_NAMES.length) {
                const json = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `smart_budget_backup_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                toastMsg("ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
            }
        };

        request.onerror = () => {
             toastMsg(`ÙØ´Ù„ ØªØµØ¯ÙŠØ± Ù…ØªØ¬Ø± ${storeName}.`);
             storesProcessed++;
        };
    });
}

async function importData(event) {
    closeSidebar();
    const file = event.target.files[0];
    if (!file) return;

    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ø³ÙŠØ¤Ø¯ÙŠ Ø°Ù„Ùƒ Ø¥Ù„Ù‰ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„.")) {
        event.target.value = null; 
        return;
    }

    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const importedData = JSON.parse(e.target.result);
            if (!IDB_connection) return toastMsg("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");

            const clearStore = (storeName) => new Promise((resolve, reject) => {
                const transaction = IDB_connection.transaction([storeName], "readwrite");
                const store = transaction.objectStore(storeName);
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e.target.error);
            });
            
            const addDataToStore = (storeName, data) => new Promise((resolve, reject) => {
                const transaction = IDB_connection.transaction([storeName], "readwrite");
                const store = transaction.objectStore(storeName);
                
                let successCount = 0;
                let errorCount = 0;
                
                data.forEach(item => {
                    if (storeName !== 'bal') delete item.id; 
                    const request = store.put(item); // Ø§Ø³ØªØ®Ø¯Ø§Ù… put Ù„Ù„Ø³Ø¬Ù„ Ø§Ù„ÙˆØ§Ø­Ø¯ ÙÙŠ bal
                    request.onsuccess = () => successCount++;
                    request.onerror = () => errorCount++;
                });

                transaction.oncomplete = () => resolve({success: successCount, error: errorCount});
                transaction.onerror = (e) => reject(e.target.error);
            });


            for (const storeName of STORE_NAMES) {
                await clearStore(storeName); 
            }

            for (const storeName of STORE_NAMES) {
                if (importedData[storeName]) {
                    const dataArray = storeName === 'bal' ? [importedData[storeName]] : importedData[storeName];
                    if (Array.isArray(dataArray)) {
                         await addDataToStore(storeName, dataArray);
                    }
                }
            }

            await loadAllData(); 
            updateStats();
            updateBalanceDisplay();
            toastMsg("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­!");

        } catch (error) {
            toastMsg("ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù Ø¨ØµÙŠØºØ© JSON ØµØ­ÙŠØ­Ø©.");
            console.error("Import Error:", error);
        } finally {
            event.target.value = null; 
        }
    };
    reader.readAsText(file);
}

function confirmResetData() {
    closeSidebar();
    if (confirm("ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.")) {
        resetAllData();
    }
}

function resetAllData() {
     if (!IDB_connection) return toastMsg("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");

    const transaction = IDB_connection.transaction(STORE_NAMES, "readwrite");
    let storesCleared = 0;
    
    STORE_NAMES.forEach(storeName => {
        const store = transaction.objectStore(storeName);
        const request = store.clear();

        request.onsuccess = async () => {
            storesCleared++;
            if (storesCleared === STORE_NAMES.length) {
                db.exp = db.rig = db.deb = []; 
                db.bal = { clientId: 1, amount: 0, changes: [] };
                currentBalance = 0;
                
                // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
                await saveData('bal', db.bal); 

                updateStats(); 
                updateBalanceDisplay();
                toastMsg("ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
            }
        };

        request.onerror = () => toastMsg("ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
    });
}
</script>

</body>
</html>
