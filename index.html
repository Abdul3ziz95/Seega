<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ© | Smart Budget</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">

<style>
/* ---------------------------------------------------- */
/* Variables and Base Styling - LIGHT MODE (Default) */
/* ---------------------------------------------------- */
:root{
    --p: #0077b6; /* Primary Blue (Vibrant) */
    --s: #48cae4; /* Secondary Light Blue */
    --bg: #f7f9fc; /* Light Background */
    --danger: #ef476f; 
    --success: #2a9d8f;
    --warning: #fbc02d;
    --text-dark: #333;
    --text-light: #f7f9fc;
    --shadow-light: 0 4px 8px rgba(0, 0, 0, 0.08);
    --shadow-hover: 0 6px 15px rgba(0, 0, 0, 0.15);
    --card-bg: #fff;
    --input-bg: #fff;
    --border-color: #ddd;
    --tab-active-bg: #fff;
}

/* ---------------------------------------------------- */
/* Dark Mode Variables */
/* ---------------------------------------------------- */
body.dark-mode {
    --p: #90e0ef; /* Lighter Primary Blue for contrast */
    --s: #48cae4; 
    --bg: #1f1f1f; /* Dark Background */
    --danger: #ff8a80;
    --success: #66bb6a;
    --warning: #fbc02d;
    --text-dark: #e0e0e0; /* Light Text */
    --text-light: #1f1f1f;
    --shadow-light: 0 4px 10px rgba(0, 0, 0, 0.5);
    --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.8);
    --card-bg: #2d2d2d;
    --input-bg: #3c3c3c;
    --border-color: #555;
    --tab-active-bg: #2d2d2d;
}

/* ---------------------------------------------------- */
/* Global Reset and Base Styling */
/* ---------------------------------------------------- */
* {
    box-sizing: border-box;
}
body{
    margin:0;
    font-family: 'Tajawal', 'Arial', sans-serif;
    background: var(--bg);
    color: var(--text-dark);
    overflow-x: hidden;
    line-height: 1.6;
    transition: background 0.3s, color 0.3s;
}

/* Global Dark Mode Overrides for Specific Elements */
.card, .sidebar, .modal { background: var(--card-bg); }
.modal header { background: var(--card-bg); border-bottom: 1px solid var(--border-color); }

/* ---------------------------------------------------- */
/* Header & Navigation */
/* ---------------------------------------------------- */
header{
    background: var(--p);
    color: var(--text-light);
    padding: 15px;
    font-size: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-hover);
    position: sticky;
    top: 0;
    z-index: 10;
}
header .title { flex-grow: 1; text-align: center; font-weight: 800; }
header button {
    background: none; 
    border: none; 
    color: var(--text-light); 
    font-size: 20px; 
    cursor: pointer; 
    padding: 0 10px;
    transition: transform 0.2s;
}
header button:hover { transform: scale(1.1); }

.tabs{
    display:flex;
    background: var(--card-bg);
    border-bottom: 2px solid var(--border-color);
    box-shadow: var(--shadow-light);
    overflow-x: auto; 
    white-space: nowrap;
}
.tabs button{
    flex: 1 1 auto; 
    min-width: 0; 
    padding: 15px 10px;
    border:none;
    background: var(--card-bg);
    color: var(--text-dark);
    font-weight: 700;
    font-size: 14px;
    transition: all 0.3s;
    border-bottom: 3px solid transparent;
}
.tabs button.active{
    color: var(--p);
    border-bottom: 3px solid var(--p);
    background: color-mix(in srgb, var(--bg) 90%, var(--p)); 
}
body.dark-mode .tabs button.active {
    background: color-mix(in srgb, var(--bg) 85%, var(--p)); 
}

/* ---------------------------------------------------- */
/* General Layout & Cards */
/* ---------------------------------------------------- */
.section{ display:none; padding: 15px; }
.section.active{ display:block; }
.card{
    background:var(--card-bg);
    padding: 20px;
    border-radius: 15px;
    box-shadow: var(--shadow-light);
    margin-bottom: 15px;
    border-top: 5px solid var(--s); 
    transition: background 0.3s, border-color 0.3s;
}

/* ---------------------------------------------------- */
/* Overview Section Styling (New Dashboard) */
/* ---------------------------------------------------- */
#overview .balance-display {
    text-align: center;
    padding: 30px 20px;
    margin-bottom: 20px;
    border-radius: 15px;
    background: var(--card-bg);
    box-shadow: var(--shadow-hover);
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    align-items: center;
}
#overview .balance-display h2 {
    margin: 0 0 5px 0;
    font-size: 18px;
    color: #999;
}
#overview .balance-display p {
    font-size: 38px;
    font-weight: 800;
    margin: 5px 0 0 0;
    color: var(--p);
    display: flex;
    align-items: center;
}
#overview .balance-display button {
    background: none;
    border: none;
    color: var(--p);
    font-size: 24px;
    cursor: pointer;
    margin-right: 10px;
    transition: color 0.2s;
}
#overview .balance-display button:hover {
    color: var(--s);
}
#overview .balance-actions {
    display: flex;
    gap: 15px;
    margin-top: 10px;
}
#overview .balance-actions .action {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    color: var(--text-dark);
    border-radius: 10px;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-light);
    transition: all 0.2s;
    background: var(--input-bg);
}
#overview .balance-actions .action:hover {
    box-shadow: var(--shadow-hover);
    transform: translateY(-2px);
    border-color: var(--p);
}
#overview .balance-actions .action i {
    font-size: 24px;
    margin-bottom: 5px;
}
#overview .balance-actions .deposit i { color: var(--success); }
#overview .balance-actions .withdraw i { color: var(--danger); }

/* ---------------------------------------------------- */
/* Form Elements & Inputs */
/* ---------------------------------------------------- */
input, select, .datetime-container input[type="datetime-local"] {
    width: 100%;
    padding: 14px;
    margin: 8px 0;
    font-size: 16px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    box-sizing: border-box;
    background: var(--input-bg);
    color: var(--text-dark);
    transition: all 0.3s;
}
input:focus, select:focus, .datetime-container input[type="datetime-local"]:focus {
    border-color: var(--s);
    box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.2);
    outline: none;
}
body.dark-mode input:focus, body.dark-mode select:focus, body.dark-mode .datetime-container input[type="datetime-local"]:focus {
    box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.3);
}

.datetime-container { position: relative; width: 100%; margin: 8px 0; }
.datetime-container input[type="datetime-local"] { margin: 0; padding-left: 40px; }

.calendar-icon {
    position: absolute;
    top: 50%;
    left: 15px; 
    transform: translateY(-50%);
    font-size: 1.4em;
    z-index: 2;
    pointer-events: none; 
    color: var(--p); 
}

/* ---------------------------------------------------- */
/* Buttons & Actions */
/* ---------------------------------------------------- */
button.action{
    background: var(--p);
    color: var(--text-light);
    border: none;
    padding: 16px;
    width: 100%;
    border-radius: 10px;
    font-size: 18px;
    font-weight: bold;
    margin-top: 10px;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
    box-shadow: var(--shadow-light);
}
button.action:hover{
    background: color-mix(in srgb, var(--p) 85%, black); 
    transform: translateY(-2px);
}

button.secondary{
    background: var(--input-bg);
    color: var(--text-dark);
    padding: 12px;
    width: 100%;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    margin-top: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s;
}
button.secondary:hover {
    background: color-mix(in srgb, var(--input-bg) 80%, #999); 
}

/* ---------------------------------------------------- */
/* Utility & Custom Elements */
/* ---------------------------------------------------- */
.toast{
    position:fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: var(--text-light);
    padding: 12px 25px;
    border-radius: 30px;
    display:none;
    z-index: 100;
    font-size: 15px;
    box-shadow: var(--shadow-hover);
    white-space: nowrap;
}

.currency-symbol { color: var(--p); font-weight: bold; font-size: 1.1em; margin-right: 5px; }
.hidden-balance { font-size: 38px; font-weight: 800; letter-spacing: 5px; color: var(--p); }

/* ---------------------------------------------------- */
/* Modals and Sidebar Refinements */
/* ---------------------------------------------------- */
.modal{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background: var(--bg);
    display:none;
    flex-direction:column;
    z-index: 30;
    overflow-y: auto;
}
.modal header{
    display:flex;
    gap: 10px;
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    background: var(--card-bg);
    align-items: center;
    box-shadow: var(--shadow-light);
    position: sticky;
    top: 0;
    z-index: 35;
}
.modal header .title { flex-grow: 1; text-align: center; font-weight: 700; }
.modal header button {
    background: none; 
    border: none; 
    color: var(--text-dark); 
    font-size: 20px; 
    cursor: pointer; 
    padding: 0 10px;
}
.modal-content {
    flex-grow: 1;
    padding: 15px;
}

.sidebar {
    position: fixed;
    top: 0;
    right: 0; 
    width: 300px; 
    max-width: 85%;
    height: 100%;
    background: var(--card-bg);
    box-shadow: -4px 0 12px rgba(0, 0, 0, 0.2);
    transform: translateX(100%); 
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
    z-index: 25; 
    display: flex;
    flex-direction: column;
}
.sidebar.open { transform: translateX(0); }

/* Switch Style (Dark Mode) */
.switch-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    font-size: 17px;
    color: var(--text-dark);
}
.switch { position: relative; display: inline-block; width: 45px; height: 25px; }
.switch input {opacity: 0; width: 0; height: 0;}
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: var(--border-color); transition: .4s; border-radius: 25px;
}
.slider:before {
    position: absolute; content: ""; height: 19px; width: 19px; left: 3px; bottom: 3px;
    background-color: white; transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: var(--p); }
input:checked + .slider:before { transform: translateX(20px); }


/* Sidebar */
.sidebar-header {
    padding: 15px;
    background: var(--p);
    color: var(--text-light);
    font-size: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
}
.sidebar-content {
    flex-grow: 1;
    padding: 15px 0;
    overflow-y: auto;
}

.sidebar-menu-item {
    padding: 15px 20px;
    margin: 5px 0;
    display: flex;
    align-items: center;
    justify-content: space-between; 
    gap: 15px;
    font-size: 17px;
    color: var(--text-dark);
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
}

.sidebar-menu-item:hover {
    background: var(--s);
    color: var(--text-dark); 
}
.sidebar-menu-item i { font-size: 1.2em; }

.sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    z-index: 24;
}
.sidebar-overlay.open { display: block; }

/* Small Image Source Modal */
#imageSourceModal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80%;
    max-width: 350px;
    height: auto;
    background: var(--card-bg);
    border-radius: 15px;
    box-shadow: var(--shadow-hover);
    padding: 20px;
    z-index: 150;
    display: none; 
    flex-direction: column;
    align-items: center;
}
#imageSourceModal.open {
    display: flex;
}

#imageSourceModal h3 {
    margin-top: 0;
    color: var(--p);
    text-align: center;
}
#imageSourceModal button {
    margin: 10px 0;
    padding: 15px;
    font-size: 16px;
    border-radius: 10px;
    width: 100%;
}

/* Toast Animation */
.toast.show{
    display:block;
    animation: fadeInOut 2.5s ease-in-out forwards;
}

@keyframes fadeInOut {
    0% { opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { opacity: 0; }
}

/* List Item */
.list-item{
    background: var(--card-bg);
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    border-right: 5px solid var(--s); 
    color: var(--text-dark);
}
.list-item:hover {
    background: color-mix(in srgb, var(--card-bg) 95%, #999);
    box-shadow: var(--shadow-light);
}
.list-item .details {
    font-size: 0.9em; 
    color: #666; 
    text-align: right;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 5px;
}

/* ---------------------------------------------------- */
/* Responsive Fix for Tabs (Small Screens) */
/* ---------------------------------------------------- */
@media (max-width: 450px) {
    .tabs button {
        padding: 15px 5px; 
        font-size: 13px; 
    }
}
</style>
</head>

<body>

<header>
    <button onclick="openSidebar()"><i class="fas fa-bars"></i></button> 
    <span class="title" id="appTitle">Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</span>
    <button style="visibility: hidden;"><i class="fas fa-search"></i></button> 
</header>

<div class="tabs">
    <button class="active" onclick="openTab('overview')">
        <i class="fas fa-tachometer-alt" style="margin-left: 5px;"></i> <span id="tabOverview">Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</span>
    </button>
    <button onclick="openTab('expenses')">
        <i class="fas fa-money-bill-wave" style="margin-left: 5px;"></i> <span id="tabExpenses">Ù…ØµØ±ÙˆÙØ§Øª</span>
    </button>
    <button onclick="openTab('rights')">
        <i class="fas fa-handshake" style="margin-left: 5px;"></i> <span id="tabRights">Ø­Ù‚ÙˆÙ‚</span>
    </button>
    <button onclick="openTab('debts')">
        <i class="fas fa-file-invoice" style="margin-left: 5px;"></i> <span id="tabDebts">Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</span>
    </button>
</div>

<div id="overview" class="section active">
    <div class="balance-display">
        <h2 id="balanceTitle">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
        <p id="currentBalanceDisplay">
            <i class="fas fa-spinner fa-spin"></i>
        </p>
        <button onclick="toggleBalanceVisibility()" id="balanceVisibilityToggle" title="Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±ØµÙŠØ¯">
             <i class="fas fa-eye"></i>
        </button>
    </div>

    <div class="balance-actions">
        <button class="action deposit" onclick="openBalanceActionModal('deposit')">
            <i class="fas fa-plus-circle"></i> <span id="btnDeposit">Ø¥ÙŠØ¯Ø§Ø¹</span>
        </button>
        <button class="action withdraw" onclick="openBalanceActionModal('withdraw')">
            <i class="fas fa-minus-circle"></i> <span id="btnWithdraw">Ø³Ø­Ø¨</span>
        </button>
    </div>
    
    <button class="secondary" onclick="openBalanceLogModal()" style="margin-top: 15px;">
        <i class="fas fa-history" style="margin-left: 5px;"></i> <span id="btnBalanceLog">Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯</span>
    </button>
    <div class="card" style="margin-top: 20px; border-top: 5px solid var(--p);">
        <h3 style="color: var(--p); margin-top: 0;"><i class="fas fa-calculator" style="margin-left: 5px;"></i> <span id="summaryTitle">Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</span></h3>
        <p><span id="sExpLabel">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (ØªØ´Ù…Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª):</span> <b id="sExpTotal">0</b></p>
        <p><span id="sRigLabel">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©:</span> <b id="sRigTotal">0</b></p>
        <p><span id="sDebLabel">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©:</span> <b id="sDebTotal">0</b></p>
        <p><span id="sRigPaidLabel">Ø§Ù„Ù…Ø­ØµÙ„ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ‚:</span> <b id="sRigPaid">0</b></p>
        <p><span id="sDebPaidLabel">Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª:</span> <b id="sDebPaid">0</b></p>
        </div>
</div>

<div id="expenses" class="section">
    <div class="card">
    <p style="color: var(--danger); font-weight: bold; font-size: 0.9em; text-align: right;" id="expNote">* Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡Ø§ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙˆØ±Ø§Ù‹</p>
    <input id="eAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
    <select id="eType">
    <option value="" id="eTypePlaceholder">ğŸ›’ Ø§Ù„ÙØ¦Ø© (Ù†ÙÙ‚Ø§Øª Ù…ØªØºÙŠØ±Ø©)</option>
    <option>Ø·Ø¹Ø§Ù…</option><option>Ù…ÙˆØ§ØµÙ„Ø§Øª</option>
    <option>Ø±Ø¹Ø§ÙŠØ© Ø´Ø®ØµÙŠØ©</option><option>Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
    <option>ØµØ­Ø©</option><option>ØªØ±ÙÙŠÙ‡</option><option>ØªØ³ÙˆÙ‚</option>
    <option>ØªØ¹Ù„ÙŠÙ…</option><option>ØµÙŠØ§Ù†Ø© ÙˆØ¥ØµÙ„Ø§Ø­</option><option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="eDesc" placeholder="ğŸ“ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
    <div class="datetime-container">
        <input id="eDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    
    <button class="secondary" onclick="showImageSourceModal()" id="btnAttachImage">
        <i class="fas fa-camera" style="margin-left: 5px;"></i> Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    </button>
    <span id="eImgName" style="display: block; font-size: 0.8em; color: var(--success); text-align: right; margin-top: 5px;"></span>
    <input type="file" id="eImgCamera" accept="image/*" capture="camera" style="display: none;" onchange="updateFileName(this, 'eImgName')">
    <input type="file" id="eImgGallery" accept="image/*" style="display: none;" onchange="updateFileName(this, 'eImgName')">
    <button class="action" onclick="addExpense()" id="btnSaveExpense">
        <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ
    </button>
    <button class="secondary" onclick="openLog('exp')" id="btnExpenseLog">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
    </button>
    </div>
</div>

<div id="rights" class="section">
    <div class="card">
    <p style="color: var(--success); font-weight: bold; font-size: 0.9em; text-align: right;" id="rigNote">* Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„Ø© (Ø¯ÙØ¹ Ø§Ù„Ø¯ÙŠÙ†/Ø§Ù„Ø¢Ø¬Ù„) ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
    <select id="rType" onchange="updateRightFields(this.value)">
    <option value="" id="rTypePlaceholder">ğŸ¤ Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚</option>
    <option>Ø¯ÙŠÙ†</option>
    <option>Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„</option>
    <option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="rAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚ (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ)" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
    <div id="rDynamicFields"></div>
    <input id="rDesc" placeholder="ğŸ‘¤ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ù„Ù…Ø¯ÙŠÙ†/Ø§Ù„Ø¬Ù‡Ø©)">
    <div class="datetime-container">
        <input id="rDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    <select id="rStatus">
    <option value="" id="rStatusPlaceholder">âœ… Ø§Ù„Ø­Ø§Ù„Ø©</option>
    <option value="ÙƒØ§Ù…Ù„" id="rStatusPaid">Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</option>
    <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹" id="rStatusUnpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ Ø¨Ø¹Ø¯</option>
    </select>
    <button class="action" onclick="addRight()" id="btnSaveRight">
        <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ø­Ù‚
    </button>
    <button class="secondary" onclick="openLog('rig')" id="btnRightLog">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ‚
    </button>
    </div>
</div>

<div id="debts" class="section">
    <div class="card">
    <p style="color: var(--danger); font-weight: bold; font-size: 0.9em; text-align: right;" id="debNote">* Ø¯ÙØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
    <select id="dType" onchange="updateDebtFields(this.value)">
    <option value="" id="dTypePlaceholder">ğŸ§¾ Ù†ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</option>
    <option>Ø¥ÙŠØ¬Ø§Ø±</option>
    <option>ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
    <option>Ù…Ø§Ø¡</option>
    <option>Ø¥Ù†ØªØ±Ù†Øª</option>
    <option>Ù‚Ø±Ø¶</option> <option>Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ</option> <option>Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø© Ø£Ø®Ø±Ù‰</option>
    <option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="dAmount" type="text" placeholder="ğŸ’µ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©/Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">

    <div id="dDynamicFields"></div>
    <input id="dDesc" placeholder="ğŸ¢ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ù„Ø¯Ø§Ø¦Ù†/Ø§Ù„Ø¬Ù‡Ø©)">
    <div class="datetime-container">
        <input id="dDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    <select id="dStatus">
    <option value="" id="dStatusPlaceholder">âœ… Ø§Ù„Ø­Ø§Ù„Ø©</option>
    <option value="Ù…Ø¯ÙÙˆØ¹" id="dStatusPaid">Ù…Ø¯ÙÙˆØ¹</option>
    <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹" id="dStatusUnpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
    </select>
    <button class="action" onclick="addDebt()" id="btnSaveDebt">
        <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…
    </button>
    <button class="secondary" onclick="openLog('deb')" id="btnDebtLog">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    </button>
    </div>
</div>

<div class="modal" id="logModal">
    <header>
        <input id="search" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„..." oninput="renderLog()">
        <button onclick="closeLayer('log')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content" id="logContent"></div>
</div>

<div class="modal" id="detailModal">
    <header>
        <span class="title" id="detailModalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</span>
        <button onclick="closeLayer('detail')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content detail" id="detailContent"></div>
</div>

<div class="modal" id="editModal">
    <header>
        <span class="title" id="editModalTitle">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</span>
        <button onclick="closeLayer('edit')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <div id="editFormContainer">
            <div id="editExpForm" style="display:none;">
                <input id="eEditAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
                <select id="eEditType"></select> <input id="eEditDesc" placeholder="ğŸ“ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
                <div class="datetime-container">
                    <input id="eEditDate" type="datetime-local">
                    <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
                </div>
                
                <p id="eEditImgInfo" style="font-size: 0.9em; color: var(--p); text-align: right; margin-top: 10px;"></p>
                <button class="secondary" onclick="document.getElementById('eEditImgNew').click()" id="eEditImgBtn">
                    <i class="fas fa-camera" style="margin-left: 5px;"></i> Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                </button>
                <input type="file" id="eEditImgNew" accept="image/*" style="display: none;" onchange="updateEditFileName(this, 'eEditImgInfo')">
                <button class="secondary" id="eEditImgRemoveBtn" style="background: var(--danger); color: var(--text-light); border: none; margin-top: 5px; display: none;" onclick="removeEditImage('eEditImgInfo')">
                     <i class="fas fa-trash-alt" style="margin-left: 5px;"></i> Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                </button>
            </div>

            <div id="editRigDebForm" style="display:none;">
                <select id="rdEditType"></select> <input id="rdEditAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
                <div id="rdEditDynamicFields"></div>
                <input id="rdEditDesc" placeholder="ğŸ“ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
                <div class="datetime-container">
                    <input id="rdEditDate" type="datetime-local">
                    <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
                </div>
                <select id="rdEditStatus"></select> <p id="rdEditPaidInfo" style="font-size: 0.9em; color: var(--success); text-align: right; margin-top: 10px; font-weight: bold;"></p>
            </div>

        </div>

        <button class="action" onclick="updateTransaction()" id="btnSaveEdit">
            <i class="fas fa-check" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
        </button>
    </div>
</div>


<div class="modal" id="balanceActionModal">
    <header>
        <span class="title" id="actionModalTitle"></span>
        <button onclick="closeLayer('balanceAction')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <p style="text-align: center; font-size: 1.1em;"><span id="actionCurrentBalanceLabel">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ:</span> <span id="currentBalanceInAction" style="color: var(--p); font-weight: bold;"></span></p>
        <input id="bAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
        <input id="bDesc" placeholder="ğŸ“ ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Ù…Ø«Ù„: Ø±Ø§ØªØ¨ØŒ ØªØ­ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ)">
        <div class="datetime-container">
            <input id="bDate" type="datetime-local">
            <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
        </div>
        <button class="action" onclick="processBalanceAction()" id="btnExecute">
            <i class="fas fa-check" style="margin-left: 5px;"></i> ØªÙ†ÙÙŠØ°
        </button>
    </div>
</div>

<div class="modal" id="balanceLogModal">
    <header>
        <span class="title" id="balanceLogTitle">Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯</span>
        <button onclick="closeLayer('balanceLog')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content" id="balanceLogContent">
        </div>
</div>

<div id="imageSourceModal">
    <h3 style="margin-bottom: 20px;" id="imageSourceTitle">Ø§Ø®ØªÙŠØ§Ø± Ù…ØµØ¯Ø± Ø§Ù„ØµÙˆØ±Ø©</h3>
    <button class="action" onclick="openCameraInput()" id="btnCamera"><i class="fas fa-camera" style="margin-left: 10px;"></i> Ø§Ù„ØªÙ‚Ø§Ø· Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
    <button class="secondary" onclick="openGalleryInput()" id="btnGallery"><i class="fas fa-images" style="margin-left: 10px;"></i> Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ø¶</button>
    <button class="secondary" style="background: none; border: none; color: var(--danger); margin-top: 10px;" onclick="closeLayer('imageSource')" id="btnCancel">Ø¥Ù„ØºØ§Ø¡</button>
</div>
<div class="sidebar-overlay" id="imageSourceOverlay" style="z-index: 140; display: none;" onclick="closeLayer('imageSource')"></div>

<div class="toast" id="toast"></div>

<div class="sidebar-overlay" onclick="closeLayer('sidebar')"></div>

<div class="sidebar" id="appSidebar">
    <div class="sidebar-header">
        <span id="sidebarHeader">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        <button onclick="closeLayer('sidebar')"><i class="fas fa-times"></i></button>
    </div>
    <div class="sidebar-content">
        <div class="card" style="margin: 0 15px 15px; border-top: 5px solid var(--s);">
             <p style="font-weight: bold; margin-top: 0; color: var(--p);" id="settingsTitle">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</p>
             
             <div class="switch-container">
                 <i class="fas fa-moon" style="margin-left: 10px;"></i> <span id="darkModeLabel">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span>
                 <label class="switch">
                     <input type="checkbox" id="darkModeToggle" onclick="toggleDarkMode()">
                     <span class="slider"></span>
                 </label>
             </div>
             
             <div class="sidebar-menu-item" id="languageToggleItem" onclick="toggleLanguage()" style="padding-left: 0; padding-right: 0; margin-top: 15px;">
                <i class="fas fa-language"></i> <span id="languageToggleText">English (EN)</span> 
            </div>
             <button class="secondary" onclick="openCurrencyModal()" style="display: flex; justify-content: space-between; align-items: center; border: none; background: var(--card-bg); margin-top: 15px;">
                 <span id="currentCurrencyDisplay" style="font-weight: bold;">Ø§Ù„Ø¹Ù…Ù„Ø©: Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ (Ø±.Ø³)</span>
                 <span style="color: var(--p);"><i class="fas fa-exchange-alt"></i> <span id="changeCurrencyBtn">ØªØºÙŠÙŠØ±</span></span>
             </button>
        </div>
        
        <div class="sidebar-menu-item" onclick="exportData()">
            <i class="fas fa-file-export"></i> <span id="exportData">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</span>
        </div>
        
        <div class="sidebar-menu-item" onclick="document.getElementById('importFile').click()">
            <i class="fas fa-file-import"></i> <span id="importData">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</span>
        </div>
        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">

        <div class="sidebar-menu-item" onclick="openAboutModal()">
            <i class="fas fa-info-circle"></i> <span id="aboutApp">Ø­ÙˆÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>
        </div>
        
        <div class="sidebar-menu-item" onclick="confirmResetData()" style="color: var(--danger);">
            <i class="fas fa-exclamation-triangle"></i> <span id="resetData">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        </div>
    </div>
</div>

<div class="modal" id="aboutModal">
    <header>
        <h3 style="color: var(--p);" id="aboutModalTitle">Ø­ÙˆÙ„ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ©</h3>
        <button onclick="closeLayer('about')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <p id="aboutText1">ØªØ·Ø¨ÙŠÙ‚ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© Ù‡Ùˆ Ø£Ø¯Ø§Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ ØªØªØ¨Ø¹:</p>
        <ul> 
            <li><i class="fas fa-wallet" style="color: var(--s);"></i> <strong id="aboutExp">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø©</strong> Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.</li>
            <li><i class="fas fa-receipt" style="color: var(--s);"></i> <strong id="aboutRig">Ø§Ù„Ø­Ù‚ÙˆÙ‚</strong> Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ù„Ùƒ (Ø¯ÙŠÙˆÙ†ØŒ Ø¨ÙŠØ¹ Ø¢Ø¬Ù„).</li>
            <li><i class="fas fa-clipboard-list" style="color: var(--s);"></i> <strong id="aboutDeb">Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</strong> Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ø¹Ù„ÙŠÙƒ (ÙÙˆØ§ØªÙŠØ±ØŒ Ø£Ù‚Ø³Ø§Ø·ØŒ Ù‚Ø±ÙˆØ¶).</li>
        </ul>
        <p class="card" style="border-top: 3px solid var(--danger);"> 
            <strong id="aboutNoteHeader">Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©:</strong> <span id="aboutNoteBody">ÙŠØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ© IndexedDBØŒ ÙˆÙ„Ø§ ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ø£ÙŠ Ø®Ø§Ø¯Ù… Ø®Ø§Ø±Ø¬ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ.</span>
        </p>
        <p style="text-align: center; margin-top: 20px; color: #999; font-size: 0.9em;" id="appVersion">Ø§Ù„Ø¥ØµØ¯Ø§Ø± 3.2 (Ù…Ø¹ Ù…ÙŠØ²Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙÙˆØ±ÙŠ)</p>
    </div>
</div>

<div class="modal" id="currencyModal">
    <header>
        <h3 style="color: var(--p);" id="currencyModalTitle">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø©</h3>
        <button onclick="closeLayer('currency')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <input id="currencySearch" type="text" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„Ø© (Ø±ÙŠØ§Ù„ØŒ Ø¬Ù†ÙŠÙ‡ØŒ Ø¯ÙˆÙ„Ø§Ø±...)" oninput="renderCurrencyList()">
        <div id="currencyList"> 
        </div>
    </div>
</div>

<script>
// ===================================================
// 1. Ø¥Ø¹Ø¯Ø§Ø¯ IndexedDB ÙˆÙ…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Øª
// ===================================================

const IDB_NAME = "MySmartBudgetDB";
const IDB_VERSION = 4;
const STORE_NAMES = ["exp", "rig", "deb", "bal"];
let db = {
    exp: [],
    rig: [],
    deb: [],
    bal: { clientId: 1, amount: 0, changes: [] }
};
let IDB_connection = null;

// Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
let currentLog = "", editMode = null, balanceActionType = null;
let currentBalance = 0;
let balanceHidden = localStorage.getItem('balanceHidden') === 'true';
let currentImageBase64 = null; 
let currentLanguage = localStorage.getItem('appLang') || 'ar'; // Ø¬Ø¯ÙŠØ¯: Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù„ØºØ©

const EXP_TYPES = ["Ø·Ø¹Ø§Ù…", "Ù…ÙˆØ§ØµÙ„Ø§Øª", "Ø±Ø¹Ø§ÙŠØ© Ø´Ø®ØµÙŠØ©", "Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©", "ØµØ­Ø©", "ØªØ±ÙÙŠÙ‡", "ØªØ³ÙˆÙ‚", "ØªØ¹Ù„ÙŠÙ…", "ØµÙŠØ§Ù†Ø© ÙˆØ¥ØµÙ„Ø§Ø­", "Ø£Ø®Ø±Ù‰"];
const RIG_TYPES = ["Ø¯ÙŠÙ†", "Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„", "Ø£Ø®Ø±Ù‰"];
const DEB_TYPES = ["Ø¥ÙŠØ¬Ø§Ø±", "ÙƒÙ‡Ø±Ø¨Ø§Ø¡", "Ù…Ø§Ø¡", "Ø¥Ù†ØªØ±Ù†Øª", "Ù‚Ø±Ø¶", "Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ", "Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø© Ø£Ø®Ø±Ù‰", "Ø£Ø®Ø±Ù‰"];

// Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ù‚Ù„ (ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© 'edit')
const LAYERS = {
    'sidebar': { elementId: 'appSidebar', type: 'menu' },
    'log': { elementId: 'logModal', type: 'modal' },
    'detail': { elementId: 'detailModal', type: 'modal' },
    'currency': { elementId: 'currencyModal', type: 'modal' },
    'about': { elementId: 'aboutModal', type: 'modal' },
    'balanceAction': { elementId: 'balanceActionModal', type: 'modal' },
    'balanceLog': { elementId: 'balanceLogModal', type: 'modal' },
    'imageSource': { elementId: 'imageSourceModal', type: 'menu' },
    'edit': { elementId: 'editModal', type: 'modal' }
};
let historyStack = [];

const ARABIC_CURRENCIES = [
    { code: 'SAR', symbol: 'Ø±.Ø³', name: 'Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ' },
    { code: 'EGP', symbol: 'Ø¬.Ù…', name: 'Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ' },
    { code: 'AED', symbol: 'Ø¯.Ø¥', name: 'Ø¯Ø±Ù‡Ù… Ø¥Ù…Ø§Ø±Ø§ØªÙŠ' },
    { code: 'KWD', symbol: 'Ø¯.Ùƒ', name: 'Ø¯ÙŠÙ†Ø§Ø± ÙƒÙˆÙŠØªÙŠ' },
    { code: 'USD', symbol: '$', name: 'Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ' },
    { code: 'QAR', symbol: 'Ø±.Ù‚', name: 'Ø±ÙŠØ§Ù„ Ù‚Ø·Ø±ÙŠ' },
    { code: 'OMR', symbol: 'Ø±.Ø¹.', name: 'Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ' },
    { code: 'JOD', symbol: 'Ø¯.Ø§', name: 'Ø¯ÙŠÙ†Ø§Ø± Ø£Ø±Ø¯Ù†ÙŠ' },
    { code: 'EUR', symbol: 'â‚¬', name: 'ÙŠÙˆØ±Ùˆ' },
];
let currentCurrency = ARABIC_CURRENCIES.find(c => c.code === (localStorage.getItem('currencyCode') || 'SAR'));

// Ù‚Ø§Ù…ÙˆØ³ Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù†ØµÙˆØµ
const Translations = {
    'ar': {
        title: 'Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©',
        tabOverview: 'Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©', tabExpenses: 'Ù…ØµØ±ÙˆÙØ§Øª', tabRights: 'Ø­Ù‚ÙˆÙ‚', tabDebts: 'Ø§Ù„ØªØ²Ø§Ù…Ø§Øª',
        balanceTitle: 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ', btnDeposit: 'Ø¥ÙŠØ¯Ø§Ø¹', btnWithdraw: 'Ø³Ø­Ø¨', btnBalanceLog: 'Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯',
        summaryTitle: 'Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª', sExpLabel: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (ØªØ´Ù…Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª):', sRigLabel: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©:', sDebLabel: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©:', sRigPaidLabel: 'Ø§Ù„Ù…Ø­ØµÙ„ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ‚:', sDebPaidLabel: 'Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª:',
        expNote: '* Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡Ø§ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙˆØ±Ø§Ù‹', rigNote: '* Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„Ø© (Ø¯ÙØ¹ Ø§Ù„Ø¯ÙŠÙ†/Ø§Ù„Ø¢Ø¬Ù„) ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ', debNote: '* Ø¯ÙØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ',
        eTypePlaceholder: 'ğŸ›’ Ø§Ù„ÙØ¦Ø© (Ù†ÙÙ‚Ø§Øª Ù…ØªØºÙŠØ±Ø©)', rTypePlaceholder: 'ğŸ¤ Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚', dTypePlaceholder: 'ğŸ§¾ Ù†ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…',
        btnSaveExpense: 'Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ', btnExpenseLog: 'Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', btnSaveRight: 'Ø­ÙØ¸ Ø§Ù„Ø­Ù‚', btnRightLog: 'Ø³Ø¬Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ‚', btnSaveDebt: 'Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…', btnDebtLog: 'Ø³Ø¬Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª',
        rStatusPlaceholder: 'âœ… Ø§Ù„Ø­Ø§Ù„Ø©', rStatusPaid: 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„', rStatusUnpaid: 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ Ø¨Ø¹Ø¯', dStatusPlaceholder: 'âœ… Ø§Ù„Ø­Ø§Ù„Ø©', dStatusPaid: 'Ù…Ø¯ÙÙˆØ¹', dStatusUnpaid: 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹',
        sidebarHeader: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', settingsTitle: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©', darkModeLabel: 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ', languageToggleText: 'English (EN)', changeCurrencyBtn: 'ØªØºÙŠÙŠØ±', exportData: 'ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)', importData: 'Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)', aboutApp: 'Ø­ÙˆÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚', resetData: 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
        detailModalTitle: 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©', actionCurrentBalanceLabel: 'Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ:', btnExecute: 'ØªÙ†ÙÙŠØ°', balanceLogTitle: 'Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯', imageSourceTitle: 'Ø§Ø®ØªÙŠØ§Ø± Ù…ØµØ¯Ø± Ø§Ù„ØµÙˆØ±Ø©', btnCamera: 'Ø§Ù„ØªÙ‚Ø§Ø· Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§', btnGallery: 'Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ø¶', btnCancel: 'Ø¥Ù„ØºØ§Ø¡', btnAttachImage: 'Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',
        aboutModalTitle: 'Ø­ÙˆÙ„ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ©', aboutText1: 'ØªØ·Ø¨ÙŠÙ‚ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© Ù‡Ùˆ Ø£Ø¯Ø§Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ ØªØªØ¨Ø¹:', aboutExp: 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø©', aboutRig: 'Ø§Ù„Ø­Ù‚ÙˆÙ‚', aboutDeb: 'Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª', aboutNoteHeader: 'Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©:', aboutNoteBody: 'ÙŠØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ© IndexedDBØŒ ÙˆÙ„Ø§ ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ø£ÙŠ Ø®Ø§Ø¯Ù… Ø®Ø§Ø±Ø¬ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ.', appVersion: 'Ø§Ù„Ø¥ØµØ¯Ø§Ø± 3.2 (Ù…Ø¹ Ù…ÙŠØ²Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙÙˆØ±ÙŠ)', btnSaveEdit: 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª'
    },
    'en': {
        title: 'Smart Financial Budget',
        tabOverview: 'Dashboard', tabExpenses: 'Expenses', tabRights: 'Rights', tabDebts: 'Debts',
        balanceTitle: 'Current Cash Balance', btnDeposit: 'Deposit', btnWithdraw: 'Withdraw', btnBalanceLog: 'Balance Log',
        summaryTitle: 'Statistics Summary', sExpLabel: 'Total Expenses (incl. payments):', sRigLabel: 'Total Outstanding Rights:', sDebLabel: 'Total Debts:', sRigPaidLabel: 'Collected from Rights:', sDebPaidLabel: 'Paid from Debts:',
        expNote: '* Expenses are deducted from your current balance immediately.', rigNote: '* Collected amounts (debt/credit payment) are added to your current balance.', debNote: '* Debt payments are deducted from your current balance.',
        eTypePlaceholder: 'ğŸ›’ Category (Variable Expenses)', rTypePlaceholder: 'ğŸ¤ Right Type', dTypePlaceholder: 'ğŸ§¾ Debt Type',
        btnSaveExpense: 'Save Expense', btnExpenseLog: 'Expense Log', btnSaveRight: 'Save Right', btnRightLog: 'Rights Log', btnSaveDebt: 'Save Debt', btnDebtLog: 'Debts Log',
        rStatusPlaceholder: 'âœ… Status', rStatusPaid: 'Paid in Full', rStatusUnpaid: 'Unpaid Yet', dStatusPlaceholder: 'âœ… Status', dStatusPaid: 'Paid', dStatusUnpaid: 'Unpaid',
        sidebarHeader: 'Settings & Data', settingsTitle: 'General Settings', darkModeLabel: 'Dark Mode', languageToggleText: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (AR)', changeCurrencyBtn: 'Change', exportData: 'Export Data (JSON)', importData: 'Import Data (JSON)', aboutApp: 'About App', resetData: 'Reset Data',
        detailModalTitle: 'Transaction Details', actionCurrentBalanceLabel: 'Your current balance:', btnExecute: 'Execute', balanceLogTitle: 'Balance Movement Log', imageSourceTitle: 'Select Image Source', btnCamera: 'Capture with Camera', btnGallery: 'Choose from Gallery', btnCancel: 'Cancel', btnAttachImage: 'Attach Invoice Image (Optional)',
        aboutModalTitle: 'About Smart Budget', aboutText1: 'The Smart Financial Budget application is a simple tool to help track:', aboutExp: 'Variable Expenses', aboutRig: 'Financial Rights', aboutDeb: 'Financial Obligations', aboutNoteHeader: 'Important Note:', aboutNoteBody: 'All data is saved locally on your device using IndexedDB technology and is not sent to any external server. Please use the export feature to save a backup periodically.', appVersion: 'Version 3.2 (with instant edit feature)', btnSaveEdit: 'Save Edits'
    }
};

// ===================================================
// 2. ÙˆØ¸Ø§Ø¦Ù IndexedDB ÙˆØ§Ù„Ø­ÙØ¸
// ===================================================

function initDB() {
    return new Promise((resolve, reject) => {
        if (!window.indexedDB) {
            toastMsg("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… IndexedDB.");
            return reject(new Error("IndexedDB not supported"));
        }

        const request = indexedDB.open(IDB_NAME, IDB_VERSION);

        request.onerror = event => {
            console.error("Database error:", event.target.errorCode);
            toastMsg("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
            reject(event.target.error);
        };

        request.onsuccess = event => {
            IDB_connection = event.target.result;
            loadAllData().then(resolve);
        };

        request.onupgradeneeded = event => {
            const db_upgrade = event.target.result;
            STORE_NAMES.forEach(storeName => {
                if (!db_upgrade.objectStoreNames.contains(storeName)) {
                    db_upgrade.createObjectStore(storeName, { keyPath: "id", autoIncrement: true });
                }
            });
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø­Ø§Ø¬Ø© Ù„Ù‡Ø¬Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ù…ÙØ§ØªÙŠØ­ØŒ ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù‡Ù†Ø§
        };
    });
}

function loadData(storeName) {
    return new Promise((resolve, reject) => {
        if (!IDB_connection) return resolve([]);
        const transaction = IDB_connection.transaction(storeName, "readonly");
        const store = transaction.objectStore(storeName);
        const request = store.getAll();

        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

async function loadAllData() {
    try {
        const [exp, rig, deb, balArr] = await Promise.all([
            loadData("exp"),
            loadData("rig"),
            loadData("deb"),
            loadData("bal")
        ]);

        db.exp = exp.sort((a, b) => new Date(b.date) - new Date(a.date));
        db.rig = rig.sort((a, b) => new Date(b.date) - new Date(a.date));
        db.deb = deb.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        // ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ balArr Ø¹Ù„Ù‰ Ø¹Ù†ØµØ± ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·
        if (balArr.length === 1) {
            db.bal = balArr[0];
            currentBalance = db.bal.amount;
        } else if (balArr.length === 0) {
            // Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø±ØµÙŠØ¯ Ø£Ø³Ø§Ø³ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙØ§Ø±ØºÙ‹Ø§
            await saveData('bal', db.bal);
            currentBalance = 0;
        } else {
             // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø§Ù„Ø© ÙˆØ¬ÙˆØ¯ Ø³Ø¬Ù„Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ø¨Ø§Ù„: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø­Ø¯Ø« Ø£Ùˆ Ø§Ù„Ø£ÙˆÙ„
            db.bal = balArr[0];
            currentBalance = db.bal.amount;
            console.warn("Multiple balance records found. Using the first one.");
        }

        updateStats();
        updateBalanceDisplay();
        return true;
    } catch (error) {
        console.error("Error loading all data:", error);
        return false;
    }
}

function saveData(storeName, data) {
    return new Promise((resolve, reject) => {
        if (!IDB_connection) return resolve(false);

        const transaction = IDB_connection.transaction(storeName, "readwrite");
        const store = transaction.objectStore(storeName);
        let request;
        
        // Ù„Ù€ store 'bal'ØŒ Ù†Ø³ØªØ®Ø¯Ù… put Ù„Ø£Ù†Ù†Ø§ Ù†Ø¹Ø±Ù Ù…ÙØªØ§Ø­ Ø§Ù„ÙƒØ§Ø¦Ù† (clientId: 1)
        if (storeName === 'bal') {
            request = store.put(data); 
        } else {
            // Ù„Ù„ØªØ®Ø²ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ØŒ Ù†Ø³ØªØ®Ø¯Ù… put (Ù„ØªØ­Ø¯ÙŠØ« Ø£Ùˆ Ø¥Ø¶Ø§ÙØ©)
            request = store.put(data);
        }

        request.onsuccess = event => {
            resolve(event.target.result);
        };
        request.onerror = event => {
            console.error(`Error saving data to ${storeName}:`, event.target.error);
            reject(event.target.error);
        };
    });
}

// ----------------------------------------------------
// 3. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
// ----------------------------------------------------

function parseAmount(input) {
    const num = parseFloat(input.replace(/,/g, ''));
    return isNaN(num) ? 0 : num;
}

function formatAmount(input) {
    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø´ÙŠØ¡ ØºÙŠØ± Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø¹Ø´Ø±ÙŠØ©
    let value = input.value.replace(/[^\d.]/g, ''); 
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù†Ù‚Ø·Ø© Ø¹Ø´Ø±ÙŠØ© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
    const parts = value.split('.');
    if (parts.length > 2) {
        value = parts[0] + '.' + parts.slice(1).join('');
    }

    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„ØµØ­ÙŠØ­ Ù„Ø¥Ø¶Ø§ÙØ© ÙÙˆØ§ØµÙ„ Ø§Ù„Ø£Ù„ÙˆÙ
    const [integerPart, decimalPart] = value.split('.');
    const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ù‚Ù…
    input.value = decimalPart !== undefined ? `${formattedInteger}.${decimalPart}` : formattedInteger;
}

function updateBalance(amount, type, description = "", transactionId = null) {
    currentBalance += amount;
    db.bal.amount = currentBalance;
    
    const balanceChange = {
        amount: amount,
        type: type, // 'deposit', 'withdraw', 'expense', 'rig_paid', 'deb_paid'
        description: description,
        date: new Date().toISOString(),
        relatedId: transactionId 
    };
    db.bal.changes.push(balanceChange);

    return saveData('bal', db.bal).then(() => {
        updateBalanceDisplay();
        return true;
    });
}

function updateStats() {
    const t = Translations[currentLanguage];
    let totalExp = 0, totalRig = 0, totalDeb = 0;
    let paidRig = 0, paidDeb = 0;

    // Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
    totalExp += db.exp.reduce((sum, item) => sum + item.amount, 0);

    // Ø§Ù„Ø­Ù‚ÙˆÙ‚
    db.rig.forEach(item => {
        totalRig += item.amount;
        if (item.status === t.rStatusPaid || item.status === 'ÙƒØ§Ù…Ù„') {
             paidRig += item.amount;
        } else if (item.paidAmount) {
             paidRig += item.paidAmount;
        }
    });

    // Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    db.deb.forEach(item => {
        totalDeb += item.amount;
        if (item.status === t.dStatusPaid || item.status === 'Ù…Ø¯ÙÙˆØ¹') {
            paidDeb += item.amount;
        } else if (item.paidAmount) {
             paidDeb += item.paidAmount;
        }
    });
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
    document.getElementById('sExpTotal').innerHTML = `<span class="currency-symbol">${currentCurrency.symbol}</span>${totalExp.toLocaleString(currentLanguage)}`;
    document.getElementById('sRigTotal').innerHTML = `<span class="currency-symbol">${currentCurrency.symbol}</span>${totalRig.toLocaleString(currentLanguage)}`;
    document.getElementById('sDebTotal').innerHTML = `<span class="currency-symbol">${currentCurrency.symbol}</span>${totalDeb.toLocaleString(currentLanguage)}`;
    document.getElementById('sRigPaid').innerHTML = `<span class="currency-symbol">${currentCurrency.symbol}</span>${paidRig.toLocaleString(currentLanguage)}`;
    document.getElementById('sDebPaid').innerHTML = `<span class="currency-symbol">${currentCurrency.symbol}</span>${paidDeb.toLocaleString(currentLanguage)}`;
}

function updateBalanceDisplay() {
    const balanceElement = document.getElementById('currentBalanceDisplay');
    const balanceInAction = document.getElementById('currentBalanceInAction');

    if (balanceHidden) {
        balanceElement.innerHTML = `<span class="hidden-balance">â€¢â€¢â€¢â€¢</span>`;
        document.getElementById('balanceVisibilityToggle').innerHTML = `<i class="fas fa-eye-slash"></i>`;
    } else {
        balanceElement.innerHTML = `<span class="currency-symbol">${currentCurrency.symbol}</span>${currentBalance.toLocaleString(currentLanguage)}`;
        document.getElementById('balanceVisibilityToggle').innerHTML = `<i class="fas fa-eye"></i>`;
    }

    // ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ù€ Modal Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØªÙˆØ­Ø§Ù‹
    if(balanceInAction) {
        balanceInAction.textContent = `${currentCurrency.symbol}${currentBalance.toLocaleString(currentLanguage)}`;
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ù„Ø© ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
    document.getElementById('currentCurrencyDisplay').textContent = `${Translations[currentLanguage].getCurrencyLabel || 'Ø§Ù„Ø¹Ù…Ù„Ø©'}: ${currentCurrency.name} (${currentCurrency.symbol})`;
}

function toggleBalanceVisibility() {
    balanceHidden = !balanceHidden;
    localStorage.setItem('balanceHidden', balanceHidden);
    updateBalanceDisplay();
}

// ----------------------------------------------------
// 4. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
// ----------------------------------------------------

async function addExpense() {
    const amount = parseAmount(document.getElementById('eAmount').value);
    const type = document.getElementById('eType').value;
    const desc = document.getElementById('eDesc').value;
    let date = document.getElementById('eDate').value || new Date().toISOString().slice(0, 16);
    
    if (!amount || !type) return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ¦Ø©.");

    const newExpense = {
        amount, type, desc, date, 
        imgBase64: currentImageBase64,
        id: Date.now() 
    };

    try {
        const newId = await saveData('exp', newExpense);
        newExpense.id = newId; // ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ ID Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
        db.exp.unshift(newExpense);
        await updateBalance(-amount, 'expense', `Ù…ØµØ±ÙˆÙ: ${type}`, newExpense.id); 
        
        toastMsg("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ ÙˆØ®ØµÙ…Ù‡ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­!");
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
        document.getElementById('eAmount').value = document.getElementById('eType').value = document.getElementById('eDesc').value = '';
        document.getElementById('eImgName').textContent = '';
        currentImageBase64 = null;
        document.getElementById('eDate').value = new Date().toISOString().slice(0, 16);
    } catch (e) {
        toastMsg("ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ.");
        console.error(e);
    }
}

function updateRightFields(type) {
    const container = document.getElementById('rDynamicFields');
    container.innerHTML = '';
    const t = Translations[currentLanguage];

    if (type === t.rTypePaid || type === 'Ø¯ÙŠÙ†' || type === 'Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„') {
        container.innerHTML = `
            <input id="rPaidAmount" type="text" placeholder="ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ‘Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹ (Ø¥Ù† ÙˆØ¬Ø¯)" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
        `;
    }
}

async function addRight() {
    const amount = parseAmount(document.getElementById('rAmount').value);
    const type = document.getElementById('rType').value;
    const desc = document.getElementById('rDesc').value;
    const status = document.getElementById('rStatus').value;
    let date = document.getElementById('rDate').value || new Date().toISOString().slice(0, 16);
    const paidAmountInput = document.getElementById('rPaidAmount');
    const paidAmount = paidAmountInput ? parseAmount(paidAmountInput.value) : 0;
    
    if (!amount || !type || !status) return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ÙˆØ¹ ÙˆØ§Ù„Ø­Ø§Ù„Ø©.");
    if (paidAmount > amount) return toastMsg("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ.");
    
    const newRight = {
        amount, type, desc, status, date, 
        paidAmount: paidAmount, // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ ØªÙ… ØªØ­ØµÙŠÙ„Ù‡ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        id: Date.now()
    };
    
    try {
        const newId = await saveData('rig', newRight);
        newRight.id = newId;
        db.rig.unshift(newRight);

        // Ø¥Ø°Ø§ ØªÙ… ØªØ­ØµÙŠÙ„ Ù…Ø¨Ù„ØºØŒ Ù‚Ù… Ø¨Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ø±ØµÙŠØ¯
        if (paidAmount > 0) {
            await updateBalance(paidAmount, 'rig_paid', `ØªØ­ØµÙŠÙ„ Ø­Ù‚: ${type}`, newRight.id);
        }
        
        toastMsg("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ù‚ Ø¨Ù†Ø¬Ø§Ø­!");
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
        document.getElementById('rAmount').value = document.getElementById('rType').value = document.getElementById('rDesc').value = document.getElementById('rStatus').value = '';
        document.getElementById('rDynamicFields').innerHTML = '';
        document.getElementById('rDate').value = new Date().toISOString().slice(0, 16);
    } catch (e) {
        toastMsg("ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø­Ù‚.");
        console.error(e);
    }
}

function updateDebtFields(type) {
    const container = document.getElementById('dDynamicFields');
    container.innerHTML = '';
    const t = Translations[currentLanguage];
    
    if (type === t.dTypeLoan || type === 'Ù‚Ø±Ø¶' || type === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ' || type === 'Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø© Ø£Ø®Ø±Ù‰') {
        container.innerHTML = `
            <input id="dTotalAmount" type="text" placeholder="ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ù‚Ø±Ø¶/Ø§Ù„Ø¯ÙŠÙ† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
            <input id="dPaidAmount" type="text" placeholder="ğŸ’¸ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø­Ø§Ù„ÙŠØ§Ù‹ (Ø¥Ù† ÙˆØ¬Ø¯)" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
        `;
    }
}

async function addDebt() {
    const amount = parseAmount(document.getElementById('dAmount').value);
    const type = document.getElementById('dType').value;
    const desc = document.getElementById('dDesc').value;
    const status = document.getElementById('dStatus').value;
    let date = document.getElementById('dDate').value || new Date().toISOString().slice(0, 16);
    
    const totalAmountInput = document.getElementById('dTotalAmount');
    const totalAmount = totalAmountInput ? parseAmount(totalAmountInput.value) : 0;
    const paidAmountInput = document.getElementById('dPaidAmount');
    const paidAmount = paidAmountInput ? parseAmount(paidAmountInput.value) : 0;
    
    if (!amount || !type || !status) return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø·/Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ÙˆØ¹ ÙˆØ§Ù„Ø­Ø§Ù„Ø©.");
    if (paidAmount > amount) return toastMsg("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªØ¬Ø§ÙˆØ² Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø·/Ø§Ù„ÙØ§ØªÙˆØ±Ø©.");
    
    const newDebt = {
        amount, type, desc, status, date, 
        totalAmount: totalAmount,
        paidAmount: paidAmount, // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ ØªÙ… Ø¯ÙØ¹Ù‡ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        id: Date.now()
    };
    
    try {
        const newId = await saveData('deb', newDebt);
        newDebt.id = newId;
        db.deb.unshift(newDebt);

        // Ø¥Ø°Ø§ ØªÙ… Ø¯ÙØ¹ Ù…Ø¨Ù„ØºØŒ Ù‚Ù… Ø¨Ø®ØµÙ…Ù‡ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
        if (paidAmount > 0) {
            await updateBalance(-paidAmount, 'deb_paid', `Ø¯ÙØ¹ Ø§Ù„ØªØ²Ø§Ù…: ${type}`, newDebt.id);
        }
        
        toastMsg("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­!");
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
        document.getElementById('dAmount').value = document.getElementById('dType').value = document.getElementById('dDesc').value = document.getElementById('dStatus').value = '';
        document.getElementById('dDynamicFields').innerHTML = '';
        document.getElementById('dDate').value = new Date().toISOString().slice(0, 16);
    } catch (e) {
        toastMsg("ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù….");
        console.error(e);
    }
}

function openBalanceActionModal(type) {
    balanceActionType = type;
    const t = Translations[currentLanguage];
    document.getElementById('actionModalTitle').textContent = type === 'deposit' ? t.btnDeposit : t.btnWithdraw;
    document.getElementById('bAmount').value = '';
    document.getElementById('bDesc').value = '';
    document.getElementById('bDate').value = new Date().toISOString().slice(0, 16);
    updateBalanceDisplay(); // Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    openLayer('balanceAction');
}

async function processBalanceAction() {
    const amount = parseAmount(document.getElementById('bAmount').value);
    const desc = document.getElementById('bDesc').value;
    let date = document.getElementById('bDate').value || new Date().toISOString().slice(0, 16);

    if (!amount) return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº.");

    const finalAmount = balanceActionType === 'deposit' ? amount : -amount;
    const typeLabel = balanceActionType === 'deposit' ? 'Ø¥ÙŠØ¯Ø§Ø¹' : 'Ø³Ø­Ø¨';

    try {
        // Ù„Ø§ ÙŠÙˆØ¬Ø¯ relatedId Ù‡Ù†Ø§ Ù„Ø£Ù†Ù‡ Ù„Ø§ ÙŠØ±ØªØ¨Ø· Ø¨Ù…Ø¹Ø§Ù…Ù„Ø© exp/rig/deb
        await updateBalance(finalAmount, balanceActionType, `${typeLabel}: ${desc}`, null);
        
        toastMsg(`ØªÙ… ØªÙ†ÙÙŠØ° ${typeLabel} Ø¨Ù†Ø¬Ø§Ø­!`);
        closeLayer('balanceAction');
    } catch (e) {
        toastMsg(`ÙØ´Ù„ ÙÙŠ ØªÙ†ÙÙŠØ° ${typeLabel}.`);
        console.error(e);
    }
}


// ----------------------------------------------------
// 5. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙ†Ù‚Ù„ ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø©
// ----------------------------------------------------

function toastMsg(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2500);
}

function openTab(tabId) {
    // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    // Ø¥Ø²Ø§Ù„Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø§Ø· Ù…Ù† ÙƒÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    document.querySelectorAll('.tabs button').forEach(button => {
        button.classList.remove('active');
    });

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙˆØªÙ†Ø´ÙŠØ· Ø§Ù„Ø²Ø±
    document.getElementById(tabId).classList.add('active');
    document.querySelector(`.tabs button[onclick="openTab('${tabId}')"]`).classList.add('active');
}

function openSidebar() {
    document.getElementById('appSidebar').classList.add('open');
    document.querySelector('.sidebar-overlay').classList.add('open');
    historyStack.push('sidebar');
    updateSidebarLanguageText(); // ØªØ­Ø¯ÙŠØ« Ù†Øµ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ø´Ø±ÙŠØ·
}

function openLayer(layerName) {
    const layer = LAYERS[layerName];
    if (!layer) return;

    const element = document.getElementById(layer.elementId);
    if (layer.type === 'modal') {
        element.style.display = 'flex';
    } else if (layer.type === 'menu') {
        element.classList.add('open');
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†ÙˆØ¹Ù‡ menu (Ù…Ø«Ù„ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ø£Ùˆ imageSourceModal) Ù†Ø³ØªØ®Ø¯Ù… overlay Ø®Ø§Øµ Ø¨Ù‡ Ø£Ùˆ Ù†Ø³ØªØ®Ø¯Ù… overlay Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
        if (layerName === 'imageSource') {
            document.getElementById('imageSourceOverlay').style.display = 'block';
        } else {
             document.querySelector('.sidebar-overlay').classList.add('open');
        }
    }
    historyStack.push(layerName);
}

function closeLayer(layerName) {
    const layer = LAYERS[layerName];
    if (!layer) return;

    const element = document.getElementById(layer.elementId);
    if (layer.type === 'modal') {
        element.style.display = 'none';
    } else if (layer.type === 'menu') {
        element.classList.remove('open');
        if (layerName === 'imageSource') {
            document.getElementById('imageSourceOverlay').style.display = 'none';
        } else {
             document.querySelector('.sidebar-overlay').classList.remove('open');
        }
    }
    
    // Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø³ØªØ§Ùƒ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
    if (historyStack[historyStack.length - 1] === layerName) {
        historyStack.pop();
    }
}

// ----------------------------------------------------
// 6. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù„ØºØ© ÙˆØ§Ù„ØªØ±Ø¬Ù…Ø©
// ----------------------------------------------------

function updateUI() {
    const t = Translations[currentLanguage];
    const html = document.documentElement;

    html.setAttribute('lang', currentLanguage);
    html.setAttribute('dir', currentLanguage === 'ar' ? 'rtl' : 'ltr');
    document.title = t.title;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø«Ø§Ø¨ØªØ©
    document.getElementById('appTitle').textContent = t.title;
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨
    document.getElementById('tabOverview').textContent = t.tabOverview;
    document.getElementById('tabExpenses').textContent = t.tabExpenses;
    document.getElementById('tabRights').textContent = t.tabRights;
    document.getElementById('tabDebts').textContent = t.tabDebts;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (ÙŠØªØ·Ù„Ø¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ø¹Ù…Ù„Ø© Ø£ÙŠØ¶Ø§Ù‹)
    document.getElementById('summaryTitle').innerHTML = `<i class="fas fa-calculator" style="margin-left: 5px;"></i> ${t.summaryTitle}`;
    document.getElementById('sExpLabel').textContent = t.sExpLabel;
    document.getElementById('sRigLabel').textContent = t.sRigLabel;
    document.getElementById('sDebLabel').textContent = t.sDebLabel;
    document.getElementById('sRigPaidLabel').textContent = t.sRigPaidLabel;
    document.getElementById('sDebPaidLabel').textContent = t.sDebPaidLabel;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ ÙÙŠ ÙƒÙ„ Ø§Ù„Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ø£Ø®Ø±Ù‰
    document.getElementById('balanceTitle').textContent = t.balanceTitle;
    document.getElementById('btnDeposit').textContent = t.btnDeposit;
    document.getElementById('btnWithdraw').textContent = t.btnWithdraw;
    document.getElementById('btnBalanceLog').textContent = t.btnBalanceLog;

    // ØªØ­Ø¯ÙŠØ« Ù†ØµÙˆØµ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
    document.getElementById('expNote').textContent = t.expNote;
    document.getElementById('eTypePlaceholder').textContent = t.eTypePlaceholder;
    document.getElementById('btnSaveExpense').innerHTML = `<i class="fas fa-save" style="margin-left: 5px;"></i> ${t.btnSaveExpense}`;
    document.getElementById('btnExpenseLog').innerHTML = `<i class="fas fa-history" style="margin-left: 5px;"></i> ${t.btnExpenseLog}`;
    document.getElementById('btnAttachImage').innerHTML = `<i class="fas fa-camera" style="margin-left: 5px;"></i> ${t.btnAttachImage}`;

    // ØªØ­Ø¯ÙŠØ« Ù†ØµÙˆØµ Ø§Ù„Ø­Ù‚ÙˆÙ‚
    document.getElementById('rigNote').textContent = t.rigNote;
    document.getElementById('rTypePlaceholder').textContent = t.rTypePlaceholder;
    document.getElementById('rStatusPlaceholder').textContent = t.rStatusPlaceholder;
    document.getElementById('rStatusPaid').textContent = t.rStatusPaid;
    document.getElementById('rStatusUnpaid').textContent = t.rStatusUnpaid;
    document.getElementById('btnSaveRight').innerHTML = `<i class="fas fa-save" style="margin-left: 5px;"></i> ${t.btnSaveRight}`;
    document.getElementById('btnRightLog').innerHTML = `<i class="fas fa-history" style="margin-left: 5px;"></i> ${t.btnRightLog}`;
    
    // ØªØ­Ø¯ÙŠØ« Ù†ØµÙˆØµ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    document.getElementById('debNote').textContent = t.debNote;
    document.getElementById('dTypePlaceholder').textContent = t.dTypePlaceholder;
    document.getElementById('dStatusPlaceholder').textContent = t.dStatusPlaceholder;
    document.getElementById('dStatusPaid').textContent = t.dStatusPaid;
    document.getElementById('dStatusUnpaid').textContent = t.dStatusUnpaid;
    document.getElementById('btnSaveDebt').innerHTML = `<i class="fas fa-save" style="margin-left: 5px;"></i> ${t.btnSaveDebt}`;
    document.getElementById('btnDebtLog').innerHTML = `<i class="fas fa-history" style="margin-left: 5px;"></i> ${t.btnDebtLog}`;

    // ØªØ­Ø¯ÙŠØ« Ù†ØµÙˆØµ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
    document.getElementById('sidebarHeader').textContent = t.sidebarHeader;
    document.getElementById('settingsTitle').textContent = t.settingsTitle;
    document.getElementById('darkModeLabel').textContent = t.darkModeLabel;
    document.getElementById('changeCurrencyBtn').textContent = t.changeCurrencyBtn;
    document.getElementById('exportData').textContent = t.exportData;
    document.getElementById('importData').textContent = t.importData;
    document.getElementById('aboutApp').textContent = t.aboutApp;
    document.getElementById('resetData').textContent = t.resetData;
    updateSidebarLanguageText();
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„Ø© ÙˆØ§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    updateBalanceDisplay(); 
    updateStats(); 
}

function updateSidebarLanguageText() {
    const t = Translations[currentLanguage];
    document.getElementById('languageToggleText').textContent = t.languageToggleText;
}

function toggleLanguage() {
    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ© Ø¨ÙŠÙ† 'ar' Ùˆ 'en'
    currentLanguage = currentLanguage === 'ar' ? 'en' : 'ar';
    localStorage.setItem('appLang', currentLanguage);
    
    updateUI();
    closeLayer('sidebar'); // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
    toastMsg(currentLanguage === 'ar' ? "ØªÙ… ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ© Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©" : "Language switched to English");
}


// ----------------------------------------------------
// 7. ÙˆØ¸Ø§Ø¦Ù Ù…ØªÙ†ÙˆØ¹Ø© (Log, Currency, Image, Edit, Reset)
// ----------------------------------------------------

// **********************************************
// Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ù…Ø·ÙˆØ±: ØªÙ… ØªØ¶Ù…ÙŠÙ† ÙˆØ¸Ø§Ø¦Ù Log, Currency, 
// Image, Edit, Reset Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø§Ù„ØªÙŠ ØªØªØ·Ù„Ø¨Ù‡Ø§ 
// Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø³ÙˆÙ…ÙŠØ© (HTML) Ù„ÙŠØ¹Ù…Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
// Ø¨Ø¯ÙˆÙ†Ù‡Ø§ Ø³ØªÙØ´Ù„ ÙˆØ¸Ø§Ø¦Ù addExpense, addRight, addDebt
// **********************************************

// ÙˆØ¸ÙŠÙØ© Ù„Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª (Log)
function openLog(type) {
    currentLog = type;
    document.getElementById('search').value = '';
    renderLog();
    openLayer('log');
}

function renderLog() {
    const t = Translations[currentLanguage];
    const search = document.getElementById('search').value.toLowerCase();
    let data = db[currentLog];
    let title = '';

    if (currentLog === 'exp') title = t.tabExpenses;
    else if (currentLog === 'rig') title = t.tabRights;
    else if (currentLog === 'deb') title = t.tabDebts;

    document.querySelector('#logModal header .title').textContent = title + ' ' + (t.search || 'Ø§Ù„Ø³Ø¬Ù„');

    let filteredData = data.filter(item => 
        (item.type && item.type.toLowerCase().includes(search)) ||
        (item.desc && item.desc.toLowerCase().includes(search))
    );

    let html = '';
    if (filteredData.length === 0) {
        html = `<p style="text-align: center; color: #999;">${t.noRecords || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©.'}</p>`;
    } else {
        filteredData.forEach(item => {
            const date = new Date(item.date).toLocaleDateString(currentLanguage, { year: 'numeric', month: 'short', day: 'numeric' });
            const time = new Date(item.date).toLocaleTimeString(currentLanguage, { hour: '2-digit', minute: '2-digit' });
            
            let amountText = `${item.amount ? item.amount.toLocaleString(currentLanguage) : (item.paidAmount ? item.paidAmount.toLocaleString(currentLanguage) : '')}`;
            let amountColor = '';
            
            if (currentLog === 'exp') amountColor = 'var(--danger)';
            else if (currentLog === 'rig') amountColor = (item.status === 'ÙƒØ§Ù…Ù„' || item.status === t.rStatusPaid) ? 'var(--success)' : 'var(--warning)';
            else if (currentLog === 'deb') amountColor = (item.status === 'Ù…Ø¯ÙÙˆØ¹' || item.status === t.dStatusPaid) ? 'var(--danger)' : 'var(--warning)';

            html += `
                <div class="list-item" onclick="openDetailModal('${currentLog}', ${item.id})">
                    <div style="font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
                        <span>${item.type}</span>
                        <span style="color: ${amountColor};">
                            ${item.amount ? currentCurrency.symbol : ''}${amountText}
                        </span>
                    </div>
                    <div class="details">
                        <span>${item.desc || (t.noDesc || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ')}</span>
                        <span>${date} @ ${time}</span>
                    </div>
                </div>
            `;
        });
    }

    document.getElementById('logContent').innerHTML = html;
}

function openDetailModal(type, id) {
    const item = db[type].find(i => i.id === id);
    if (!item) return toastMsg('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.');

    const date = new Date(item.date).toLocaleString(currentLanguage, { dateStyle: 'medium', timeStyle: 'short' });
    const amount = item.amount.toLocaleString(currentLanguage);
    const t = Translations[currentLanguage];

    let html = `
        <div class="card" style="border-top: 5px solid var(--p);">
            <p><strong>${t.type || 'Ø§Ù„Ù†ÙˆØ¹'}:</strong> ${item.type}</p>
            <p><strong>${t.amount || 'Ø§Ù„Ù…Ø¨Ù„Øº'}:</strong> <span style="font-weight: bold; color: var(--p);">${amount} ${currentCurrency.symbol}</span></p>
            <p><strong>${t.date || 'Ø§Ù„ØªØ§Ø±ÙŠØ®'}:</strong> ${date}</p>
            <p><strong>${t.description || 'Ø§Ù„ÙˆØµÙ'}:</strong> ${item.desc || (t.noDesc || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯')}</p>
    `;

    if (type === 'rig' || type === 'deb') {
        let statusColor = item.status === (t.rStatusPaid || t.dStatusPaid || 'ÙƒØ§Ù…Ù„' || 'Ù…Ø¯ÙÙˆØ¹') ? 'var(--success)' : 'var(--danger)';
        html += `<p><strong>${t.status || 'Ø§Ù„Ø­Ø§Ù„Ø©'}:</strong> <span style="color: ${statusColor}; font-weight: bold;">${item.status}</span></p>`;
        
        if (item.paidAmount) {
            html += `<p><strong>${t.paidAmount || 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹/Ø§Ù„Ù…Ø­ØµÙ„'}:</strong> <span style="font-weight: bold; color: var(--success);">${item.paidAmount.toLocaleString(currentLanguage)} ${currentCurrency.symbol}</span></p>`;
        }
        if (item.totalAmount) {
             html += `<p><strong>${t.totalAmount || 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ'}:</strong> <span style="font-weight: bold; color: var(--p);">${item.totalAmount.toLocaleString(currentLanguage)} ${currentCurrency.symbol}</span></p>`;
        }
    }

    if (type === 'exp' && item.imgBase64) {
        html += `
            <p><strong>${t.invoiceImage || 'ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©'}:</strong></p>
            <img src="${item.imgBase64}" style="max-width: 100%; border-radius: 10px; margin-top: 10px; border: 1px solid var(--border-color);">
        `;
    }

    html += `
        </div>
        <button class="secondary" onclick="openEditModal('${type}', ${item.id})" style="margin-top: 15px;">
            <i class="fas fa-edit" style="margin-left: 5px;"></i> ${t.edit || 'ØªØ¹Ø¯ÙŠÙ„'}
        </button>
        <button class="secondary" onclick="confirmDelete('${type}', ${item.id})" style="background: var(--danger); color: var(--text-light); border: none;">
            <i class="fas fa-trash-alt" style="margin-left: 5px;"></i> ${t.delete || 'Ø­Ø°Ù'}
        </button>
    `;
    
    document.getElementById('detailContent').innerHTML = html;
    openLayer('detail');
    closeLayer('log'); 
}

// Ø¯Ø§Ù„Ø© Ù…Ø¨Ø³Ø·Ø© Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù€ Select options
function populateEditType(elementId, types, currentValue) {
    const select = document.getElementById(elementId);
    select.innerHTML = '';
    types.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        if (type === currentValue) {
            option.selected = true;
        }
        select.appendChild(option);
    });
}

function openEditModal(type, id) {
    const item = db[type].find(i => i.id === id);
    if (!item) return;

    editMode = { type, item };
    const t = Translations[currentLanguage];
    document.getElementById('editModalTitle').textContent = t.edit || 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©';
    document.getElementById('editExpForm').style.display = 'none';
    document.getElementById('editRigDebForm').style.display = 'none';
    currentImageBase64 = item.imgBase64 || null; // Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
    if (type === 'exp') {
        document.getElementById('editExpForm').style.display = 'block';
        document.getElementById('eEditAmount').value = item.amount.toLocaleString(currentLanguage);
        document.getElementById('eEditDesc').value = item.desc;
        document.getElementById('eEditDate').value = item.date.slice(0, 16);
        populateEditType('eEditType', EXP_TYPES, item.type);
        
        const imgInfo = document.getElementById('eEditImgInfo');
        const imgRemoveBtn = document.getElementById('eEditImgRemoveBtn');
        if (item.imgBase64) {
            imgInfo.textContent = t.imageAttached || 'ØµÙˆØ±Ø© Ù…Ø±ÙÙ‚Ø©. Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„.';
            imgRemoveBtn.style.display = 'block';
        } else {
            imgInfo.textContent = t.noImageAttached || 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù…Ø±ÙÙ‚Ø©.';
            imgRemoveBtn.style.display = 'none';
        }

    } else if (type === 'rig' || type === 'deb') {
        document.getElementById('editRigDebForm').style.display = 'block';
        document.getElementById('rdEditAmount').value = item.amount.toLocaleString(currentLanguage);
        document.getElementById('rdEditDesc').value = item.desc;
        document.getElementById('rdEditDate').value = item.date.slice(0, 16);
        document.getElementById('rdEditPaidInfo').textContent = `${t.currentPaid || 'Ø§Ù„Ù…Ø¯ÙÙˆØ¹/Ø§Ù„Ù…Ø­ØµÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹'}: ${item.paidAmount ? item.paidAmount.toLocaleString(currentLanguage) : 0} ${currentCurrency.symbol}`;


        // ØªØ­Ø¯ÙŠØ« dynamic fields
        const dynamicContainer = document.getElementById('rdEditDynamicFields');
        dynamicContainer.innerHTML = '';
        if (type === 'deb' && (item.type === 'Ù‚Ø±Ø¶' || item.type === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ' || item.type === 'Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø© Ø£Ø®Ø±Ù‰')) {
            dynamicContainer.innerHTML = `
                <input id="dEditTotalAmount" type="text" placeholder="${t.totalLoanAmount || 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ù‚Ø±Ø¶/Ø§Ù„Ø¯ÙŠÙ†'}" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal" value="${item.totalAmount ? item.totalAmount.toLocaleString(currentLanguage) : ''}">
            `;
        }

        // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù†ÙˆØ¹ ÙˆØ§Ù„Ø­Ø§Ù„Ø©
        const typeList = type === 'rig' ? RIG_TYPES : DEB_TYPES;
        populateEditType('rdEditType', typeList, item.type);
        
        const statusSelect = document.getElementById('rdEditStatus');
        statusSelect.innerHTML = '';
        const statuses = type === 'rig' 
            ? [{ val: 'ÙƒØ§Ù…Ù„', text: t.rStatusPaid }, { val: 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹', text: t.rStatusUnpaid }] 
            : [{ val: 'Ù…Ø¯ÙÙˆØ¹', text: t.dStatusPaid }, { val: 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹', text: t.dStatusUnpaid }];
        
        statuses.forEach(s => {
            const option = document.createElement('option');
            option.value = s.val;
            option.textContent = s.text;
            if (item.status === s.val) option.selected = true;
            statusSelect.appendChild(option);
        });
    }

    closeLayer('detail');
    openLayer('edit');
}

async function updateTransaction() {
    if (!editMode) return;

    const { type, item } = editMode;
    const t = Translations[currentLanguage];

    // Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„Ø±ØµÙŠØ¯
    const oldAmount = item.amount;
    const oldPaidAmount = item.paidAmount || 0;

    let newAmount = 0, newDesc = '', newType = '', newDate = '', newStatus = '', newPaidAmount = 0, newTotalAmount = 0;

    if (type === 'exp') {
        newAmount = parseAmount(document.getElementById('eEditAmount').value);
        newDesc = document.getElementById('eEditDesc').value;
        newType = document.getElementById('eEditType').value;
        newDate = document.getElementById('eEditDate').value;
        
        if (!newAmount || !newType) return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ¦Ø©.");

        item.amount = newAmount;
        item.desc = newDesc;
        item.type = newType;
        item.date = newDate;
        item.imgBase64 = currentImageBase64;
        
        // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯: Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const balanceChange = (-oldAmount) - (-newAmount); // (-100) - (-120) = -100 + 120 = +20 (Ø¥Ø°Ø§ Ø²Ø§Ø¯Øª Ø§Ù„Ù…ØµØ±ÙˆÙØ§ØªØŒ ÙŠØªÙ… Ø§Ù„Ø®ØµÙ… Ø£ÙƒØ«Ø±)
        await updateBalance(balanceChange, 'expense_edit', `ØªØ¹Ø¯ÙŠÙ„ Ù…ØµØ±ÙˆÙ: ${newType}`, item.id);


    } else if (type === 'rig' || type === 'deb') {
        newAmount = parseAmount(document.getElementById('rdEditAmount').value);
        newDesc = document.getElementById('rdEditDesc').value;
        newType = document.getElementById('rdEditType').value;
        newDate = document.getElementById('rdEditDate').value;
        newStatus = document.getElementById('rdEditStatus').value;
        newPaidAmount = item.paidAmount || 0; // Ø§ÙØªØ±Ø§Ø¶ Ø£Ù† Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù„Ù… ÙŠØªØºÙŠØ±ØŒ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ø¬Ù‡Ø© Ù„Ø°Ù„Ùƒ Ù„Ø§Ø­Ù‚Ø§Ù‹

        if (type === 'deb') {
            const totalAmountInput = document.getElementById('dEditTotalAmount');
            newTotalAmount = totalAmountInput ? parseAmount(totalAmountInput.value) : 0;
        }

        if (!newAmount || !newType || !newStatus) return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ÙˆØ¹ ÙˆØ§Ù„Ø­Ø§Ù„Ø©.");
        
        item.amount = newAmount;
        item.desc = newDesc;
        item.type = newType;
        item.date = newDate;
        item.status = newStatus;
        item.totalAmount = newTotalAmount;

        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ ÙŠØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ø­Ù‚/Ø§Ù„ØªØ²Ø§Ù…ØŒ ÙÙ‚Ø· Ø¥Ø°Ø§ ØªÙ… ØªØ¹Ø¯ÙŠÙ„ paidAmount.
        // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©/Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØªÙ… Ø­Ø³Ø§Ø¨Ù‡ ÙÙŠ updateStats ÙÙ‚Ø·.
    }

    try {
        await saveData(type, item);
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        const index = db[type].findIndex(i => i.id === item.id);
        if (index !== -1) db[type][index] = item;
        db[type].sort((a, b) => new Date(b.date) - new Date(a.date)); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨

        updateStats();
        closeLayer('edit');
        toastMsg(t.updateSuccess || "ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
    } catch (e) {
        toastMsg(t.updateFailure || "ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª.");
        console.error(e);
    }
}

function confirmDelete(type, id) {
    const t = Translations[currentLanguage];
    if (confirm(t.confirmDelete || "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø£ÙŠ ØªØ£Ø«ÙŠØ± Ù„Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯.")) {
        deleteTransaction(type, id);
    }
}

async function deleteTransaction(type, id) {
     const item = db[type].find(i => i.id === id);
    if (!item) return;

    try {
        if (type === 'exp') {
            // Ø¥Ù„ØºØ§Ø¡ Ø®ØµÙ… Ø§Ù„Ù…ØµØ±ÙˆÙ: Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù„Øº Ø¥Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯
            await updateBalance(item.amount, 'expense_delete', `Ø­Ø°Ù Ù…ØµØ±ÙˆÙ: ${item.type}`, item.id);
        } else if (type === 'rig' && item.paidAmount) {
             // Ø¥Ù„ØºØ§Ø¡ ØªØ­ØµÙŠÙ„ Ø§Ù„Ø­Ù‚: Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
             await updateBalance(-item.paidAmount, 'rig_delete', `Ø­Ø°Ù ØªØ­ØµÙŠÙ„ Ø­Ù‚: ${item.type}`, item.id);
        } else if (type === 'deb' && item.paidAmount) {
             // Ø¥Ù„ØºØ§Ø¡ Ø¯ÙØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…: Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù„Øº Ø¥Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯
             await updateBalance(item.paidAmount, 'deb_delete', `Ø­Ø°Ù Ø¯ÙØ¹ Ø§Ù„ØªØ²Ø§Ù…: ${item.type}`, item.id);
        }

        // Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ù…Ù† IndexedDB
        const transaction = IDB_connection.transaction(type, "readwrite");
        const store = transaction.objectStore(type);
        await new Promise((resolve, reject) => {
            const request = store.delete(id);
            request.onsuccess = resolve;
            request.onerror = reject;
        });

        // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        db[type] = db[type].filter(i => i.id !== id);

        updateStats();
        closeLayer('detail');
        toastMsg(Translations[currentLanguage].deleteSuccess || "ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!");
    } catch (e) {
        toastMsg(Translations[currentLanguage].deleteFailure || "ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.");
        console.error(e);
    }
}

// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¹Ù…Ù„Ø§Øª
function openCurrencyModal() {
    renderCurrencyList();
    openLayer('currency');
}

function renderCurrencyList() {
    const container = document.getElementById('currencyList');
    const search = document.getElementById('currencySearch').value.toLowerCase();

    const filteredCurrencies = ARABIC_CURRENCIES.filter(c => 
        c.name.toLowerCase().includes(search) || 
        c.code.toLowerCase().includes(search)
    );

    let html = '<div style="margin-top: 10px;">';
    filteredCurrencies.forEach(c => {
        const isActive = c.code === currentCurrency.code;
        html += `
            <div class="list-item" onclick="setCurrency('${c.code}')" style="border-right: 5px solid ${isActive ? 'var(--p)' : 'var(--border-color)'};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: bold; font-size: 1.1em; color: var(--text-dark);">
                        ${c.name} (${c.symbol})
                    </span>
                    ${isActive ? '<i class="fas fa-check-circle" style="color: var(--success);"></i>' : ''}
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function setCurrency(code) {
    currentCurrency = ARABIC_CURRENCIES.find(c => c.code === code);
    localStorage.setItem('currencyCode', code);
    updateBalanceDisplay();
    updateStats(); 
    closeLayer('currency');
    toastMsg(`${Translations[currentLanguage].currencySet || 'ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù…Ù„Ø© Ø¥Ù„Ù‰'} ${currentCurrency.name} (${currentCurrency.symbol})`);
}

// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
}

// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØµÙˆØ±
function showImageSourceModal() {
    closeLayer('sidebar');
    openLayer('imageSource');
}

function openCameraInput() {
    document.getElementById('eImgCamera').click();
    closeLayer('imageSource');
}

function openGalleryInput() {
    document.getElementById('eImgGallery').click();
    closeLayer('imageSource');
}

function updateFileName(input, displayId) {
    const file = input.files[0];
    if (file) {
        document.getElementById(displayId).textContent = file.name;
        // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù ÙˆØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ Base64
        const reader = new FileReader();
        reader.onload = e => {
            currentImageBase64 = e.target.result;
        };
        reader.readAsDataURL(file);
    } else {
        document.getElementById(displayId).textContent = '';
        currentImageBase64 = null;
    }
}

function updateEditFileName(input, displayId) {
    const file = input.files[0];
    const t = Translations[currentLanguage];
    if (file) {
        document.getElementById(displayId).textContent = `${t.newImageAttached || 'ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø±ÙÙ‚Ø©'}: ${file.name}`;
        // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù ÙˆØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ Base64
        const reader = new FileReader();
        reader.onload = e => {
            currentImageBase64 = e.target.result;
        };
        reader.readAsDataURL(file);
        document.getElementById('eEditImgRemoveBtn').style.display = 'block';
    } 
}

function removeEditImage(displayId) {
     currentImageBase64 = null;
     document.getElementById(displayId).textContent = Translations[currentLanguage].noImageAttached || 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù…Ø±ÙÙ‚Ø©.';
     document.getElementById('eEditImgRemoveBtn').style.display = 'none';
     document.getElementById('eEditImgNew').value = ''; // Ù…Ø³Ø­ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
     toastMsg(Translations[currentLanguage].imageRemoved || "ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­.");
}

// ÙˆØ¸Ø§Ø¦Ù Ø­ÙˆÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
function openAboutModal() {
    closeLayer('sidebar');
    openLayer('about');
}

// ÙˆØ¸Ø§Ø¦Ù ØªØµØ¯ÙŠØ± ÙˆØ§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function exportData() {
    const dataStr = JSON.stringify(db);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = 'smart_budget_data.json';
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    closeLayer('sidebar');
    toastMsg(Translations[currentLanguage].exportSuccess || "ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
}

function importData(event) {
    const t = Translations[currentLanguage];
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async e => {
        try {
            const importedData = JSON.parse(e.target.result);

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø£Ø±Ø¨Ø¹Ø©)
            if (!importedData.exp || !importedData.rig || !importedData.deb || !importedData.bal) {
                return toastMsg(t.invalidFile || "Ù…Ù„Ù Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„.");
            }

            // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
            const transaction = IDB_connection.transaction(STORE_NAMES, "readwrite");
            await Promise.all(STORE_NAMES.map(storeName => {
                return new Promise((resolve, reject) => {
                    const request = transaction.objectStore(storeName).clear();
                    request.onsuccess = resolve;
                    request.onerror = reject;
                });
            }));
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©
            const importTransaction = IDB_connection.transaction(STORE_NAMES, "readwrite");
            const importPromises = [];
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙƒÙ„ Ù…Ø®Ø²Ù†
            STORE_NAMES.forEach(storeName => {
                const store = importTransaction.objectStore(storeName);
                const dataToImport = storeName === 'bal' ? [importedData.bal] : importedData[storeName];

                if (Array.isArray(dataToImport)) {
                    dataToImport.forEach(item => {
                        importPromises.push(new Promise((resolve, reject) => {
                            const request = store.add(item); 
                            request.onsuccess = resolve;
                            request.onerror = reject;
                        }));
                    });
                }
            });

            await Promise.all(importPromises);

            loadAllData().then(() => {
                updateUI();
                toastMsg(t.importSuccess || "ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­!");
            });

        } catch (error) {
            toastMsg(t.importFailure || "ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù Ø¨ØµÙŠØºØ© JSON ØµØ­ÙŠØ­Ø©.");
            console.error("Import Error:", error);
        } finally {
            event.target.value = null; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
        }
    };
    reader.readAsText(file);
}

function confirmResetData() {
    closeLayer('sidebar');
    if (confirm(Translations[currentLanguage].confirmReset || "ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.")) {
        resetAllData();
    }
}

function resetAllData() {
     if (!IDB_connection) return toastMsg("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");

    const transaction = IDB_connection.transaction(STORE_NAMES, "readwrite");
    let storesCleared = 0;
    
    STORE_NAMES.forEach(storeName => {
        const store = transaction.objectStore(storeName);
        const request = store.clear();

        request.onsuccess = () => {
            storesCleared++;
            if (storesCleared === STORE_NAMES.length) {
                db.exp = db.rig = db.deb = []; 
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒØ§Ø¦Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
                db.bal = { clientId: 1, amount: 0, changes: [] };
                // Ø­ÙØ¸ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ø¯ ØªØ¹ÙŠÙŠÙ†Ù‡
                saveData('bal', db.bal).then(() => {
                    loadAllData().then(() => {
                        updateStats(); 
                        updateBalanceDisplay();
                        toastMsg(Translations[currentLanguage].resetSuccess || "ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
                    });
                });
            }
        };

        request.onerror = () => toastMsg(Translations[currentLanguage].resetFailure || "ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
    });
}


// ------------------------------------
// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø®Ù„ÙÙŠ
// ------------------------------------

window.onpopstate = () => {
    if (historyStack.length > 0) {
        const topLayer = historyStack[historyStack.length - 1];
        closeLayer(topLayer);
    }
};

// ------------------------------------
// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
// ------------------------------------

window.onload = () => {
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙˆØ§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        document.getElementById('darkModeToggle').checked = true;
    }
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
    currentLanguage = localStorage.getItem('appLang') || 'ar';
    updateUI();

    initDB().then(() => {
        // ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„ÙˆÙ‚Øª ÙƒÙ‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        const now = new Date().toISOString().slice(0, 16);
        document.getElementById('eDate').value = now;
        document.getElementById('rDate').value = now;
        document.getElementById('dDate').value = now;

        toastMsg(Translations[currentLanguage].appReady || "ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.");
    }).catch(error => {
        console.error("Initialization failed:", error);
    });
};

</script>

</body>
</html>
