<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ© | Smart Budget</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<style>
/* ---------------------------------------------------- */
/* Variables and Base Styling - LIGHT MODE (Default) */
/* ---------------------------------------------------- */
:root{
    --p: #0077b6; /* Primary Blue (Vibrant) */
    --s: #48cae4; /* Secondary Light Blue */
    --bg: #f7f9fc; /* Light Background */
    --danger: #ef476f; 
    --success: #2a9d8f;
    --warning: #fbc02d;
    --text-dark: #333;
    --text-light: #f7f9fc;
    --shadow-light: 0 4px 8px rgba(0, 0, 0, 0.08);
    --shadow-hover: 0 6px 15px rgba(0, 0, 0, 0.15);
    --card-bg: #fff;
    --input-bg: #fff;
    --border-color: #ddd;
    --tab-active-bg: #fff;
}

/* ---------------------------------------------------- */
/* Dark Mode Variables */
/* ---------------------------------------------------- */
body.dark-mode {
    --p: #90e0ef; 
    --s: #48cae4; 
    --bg: #1f1f1f; 
    --danger: #ff8a80;
    --success: #66bb6a;
    --warning: #fbc02d;
    --text-dark: #e0e0e0; 
    --text-light: #1f1f1f;
    --shadow-light: 0 4px 10px rgba(0, 0, 0, 0.5);
    --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.8);
    --card-bg: #2d2d2d;
    --input-bg: #3c3c3c;
    --border-color: #555;
    --tab-active-bg: #2d2d2d;
}

/* ---------------------------------------------------- */
/* Global Reset and Base Styling */
/* ---------------------------------------------------- */
* {
    box-sizing: border-box;
}
body{
    margin:0;
    font-family: 'Tajawal', 'Arial', sans-serif;
    background: var(--bg);
    color: var(--text-dark);
    overflow-x: hidden;
    line-height: 1.6;
    transition: background 0.3s, color 0.3s;
}

/* Global Dark Mode Overrides for Specific Elements */
.card, .sidebar, .modal { background: var(--card-bg); }
.modal header { background: var(--card-bg); border-bottom: 1px solid var(--border-color); }

/* ---------------------------------------------------- */
/* Header & Navigation */
/* ---------------------------------------------------- */
header{
    background: var(--p);
    color: var(--text-light);
    padding: 15px;
    font-size: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-hover);
    position: sticky;
    top: 0;
    z-index: 10;
}
header .title { flex-grow: 1; text-align: center; font-weight: 800; }
header button {
    background: none; 
    border: none; 
    color: var(--text-light); 
    font-size: 20px; 
    cursor: pointer; 
    padding: 0 10px;
    transition: transform 0.2s;
}
header button:hover { transform: scale(1.1); }

.tabs{
    display:flex;
    background: var(--card-bg);
    border-bottom: 2px solid var(--border-color);
    box-shadow: var(--shadow-light);
    overflow-x: auto; 
    white-space: nowrap;
}
.tabs button{
    flex: 1 1 auto; 
    min-width: 0; 
    padding: 15px 10px;
    border:none;
    background: var(--card-bg);
    color: var(--text-dark);
    font-weight: 700;
    font-size: 14px;
    transition: all 0.3s;
    border-bottom: 3px solid transparent;
}
.tabs button.active{
    color: var(--p);
    border-bottom: 3px solid var(--p);
    background: color-mix(in srgb, var(--bg) 90%, var(--p)); 
}
body.dark-mode .tabs button.active {
    background: color-mix(in srgb, var(--bg) 85%, var(--p)); 
}

/* ---------------------------------------------------- */
/* General Layout & Cards */
/* ---------------------------------------------------- */
.section{ display:none; padding: 15px; }
.section.active{ display:block; }
.card{
    background:var(--card-bg);
    padding: 20px;
    border-radius: 15px;
    box-shadow: var(--shadow-light);
    margin-bottom: 15px;
    border-top: 5px solid var(--s); 
    transition: background 0.3s, border-color 0.3s;
}

/* ---------------------------------------------------- */
/* Overview Section Styling (Dashboard) */
/* ---------------------------------------------------- */
#overview .balance-display {
    text-align: center;
    padding: 30px 20px;
    margin-bottom: 20px;
    border-radius: 15px;
    background: var(--card-bg);
    box-shadow: var(--shadow-hover);
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    align-items: center;
}
#overview .balance-display h2 {
    margin: 0 0 5px 0;
    font-size: 18px;
    color: #999;
}
#overview .balance-display p {
    font-size: 38px;
    font-weight: 800;
    margin: 5px 0 0 0;
    color: var(--p);
    display: flex;
    align-items: center;
}
#overview .balance-display button {
    background: none;
    border: none;
    color: var(--p);
    font-size: 24px;
    cursor: pointer;
    margin-right: 10px;
    transition: color 0.2s;
}
#overview .balance-display button:hover {
    color: var(--s);
}
#overview .balance-actions {
    display: flex;
    gap: 15px;
    margin-top: 10px;
}
#overview .balance-actions .action {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    color: var(--text-dark);
    border-radius: 10px;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-light);
    transition: all 0.2s;
    background: var(--input-bg);
}
#overview .balance-actions .action:hover {
    box-shadow: var(--shadow-hover);
    transform: translateY(-2px);
    border-color: var(--p);
}
#overview .balance-actions .action i {
    font-size: 24px;
    margin-bottom: 5px;
}
#overview .balance-actions .deposit i { color: var(--success); }
#overview .balance-actions .withdraw i { color: var(--danger); }

/* Monthly Budget Goal Bar (New Feature) */
.budget-goal-card {
    border-top: 5px solid var(--warning) !important;
}
.goal-bar-container {
    background: var(--border-color);
    height: 15px;
    border-radius: 10px;
    margin-top: 10px;
    overflow: hidden;
}
.goal-bar {
    height: 100%;
    width: 0%;
    background: var(--success);
    transition: width 0.5s ease-out;
}
.goal-bar.warning { background: var(--warning); }
.goal-bar.danger { background: var(--danger); }
.goal-bar-info {
    display: flex;
    justify-content: space-between;
    font-size: 0.9em;
    margin-top: 5px;
    font-weight: bold;
}

/* ---------------------------------------------------- */
/* Reports Section (New Tab) */
/* ---------------------------------------------------- */
#reports .chart-container {
    max-width: 100%;
    margin: 20px 0;
    padding: 10px;
    background: var(--card-bg);
    border-radius: 15px;
    box-shadow: var(--shadow-light);
}

/* ---------------------------------------------------- */
/* Form Elements & Inputs */
/* ---------------------------------------------------- */
input, select, .datetime-container input[type="datetime-local"] {
    width: 100%;
    padding: 14px;
    margin: 8px 0;
    font-size: 16px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    box-sizing: border-box;
    background: var(--input-bg);
    color: var(--text-dark);
    transition: all 0.3s;
}
input:focus, select:focus, .datetime-container input[type="datetime-local"]:focus {
    border-color: var(--s);
    box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.2);
    outline: none;
}
body.dark-mode input:focus, body.dark-mode select:focus, body.dark-mode .datetime-container input[type="datetime-local"]:focus {
    box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.3);
}

.datetime-container { position: relative; width: 100%; margin: 8px 0; }
.datetime-container input[type="datetime-local"] { margin: 0; padding-left: 40px; }

.calendar-icon {
    position: absolute;
    top: 50%;
    left: 15px; 
    transform: translateY(-50%);
    font-size: 1.4em;
    z-index: 2;
    pointer-events: none; 
    color: var(--p); 
}

/* ---------------------------------------------------- */
/* Buttons & Actions */
/* ---------------------------------------------------- */
button.action{
    background: var(--p);
    color: var(--text-light);
    border: none;
    padding: 16px;
    width: 100%;
    border-radius: 10px;
    font-size: 18px;
    font-weight: bold;
    margin-top: 10px;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
    box-shadow: var(--shadow-light);
}
button.action:hover{
    background: color-mix(in srgb, var(--p) 85%, black); 
    transform: translateY(-2px);
}
button.action.danger-btn {
    background: var(--danger);
}
button.action.danger-btn:hover {
    background: color-mix(in srgb, var(--danger) 85%, black);
}


button.secondary{
    background: var(--input-bg);
    color: var(--text-dark);
    padding: 12px;
    width: 100%;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    margin-top: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s;
}
button.secondary:hover {
    background: color-mix(in srgb, var(--input-bg) 80%, #999); 
}

/* ---------------------------------------------------- */
/* Utility & Custom Elements */
/* ---------------------------------------------------- */
.toast{
    position:fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: var(--text-light);
    padding: 12px 25px;
    border-radius: 30px;
    display:none;
    z-index: 100;
    font-size: 15px;
    box-shadow: var(--shadow-hover);
    white-space: nowrap;
}

.currency-symbol { color: inherit; font-weight: bold; font-size: 1em; margin-right: 5px; }
.hidden-balance { font-size: 38px; font-weight: 800; letter-spacing: 5px; color: var(--p); }
.hidden-balance::after { content: 'â€¢â€¢â€¢â€¢â€¢'; }

/* ---------------------------------------------------- */
/* Modals and Sidebar Refinements */
/* ---------------------------------------------------- */
.modal{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background: var(--bg);
    display:none;
    flex-direction:column;
    z-index: 30;
    overflow-y: auto;
    transition: transform 0.3s ease-out; /* Ø¥Ø¶Ø§ÙØ© Ø§Ù†ØªÙ‚Ø§Ù„ Ø³Ù„Ø³ */
    transform: translateX(100%);
}
.modal.open{
    display:flex;
    transform: translateX(0);
}
.modal header{
    display:flex;
    gap: 10px;
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    background: var(--card-bg);
    align-items: center;
    box-shadow: var(--shadow-light);
    position: sticky;
    top: 0;
    z-index: 35;
}
.modal header .title { flex-grow: 1; text-align: center; font-weight: 700; }
.modal header button {
    background: none; 
    border: none; 
    color: var(--text-dark); 
    font-size: 20px; 
    cursor: pointer; 
    padding: 0 10px;
}
.modal-content {
    flex-grow: 1;
    padding: 15px;
}

.sidebar {
    position: fixed;
    top: 0;
    right: 0; 
    width: 300px; 
    max-width: 85%;
    height: 100%;
    background: var(--card-bg);
    box-shadow: -4px 0 12px rgba(0, 0, 0, 0.2);
    transform: translateX(100%); 
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
    z-index: 25; 
    display: flex;
    flex-direction: column;
}
.sidebar.open { transform: translateX(0); }

/* Switch Style (Dark Mode) */
.switch-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 0;
    font-size: 17px;
    color: var(--text-dark);
}
.switch { position: relative; display: inline-block; width: 45px; height: 25px; }
.switch input {opacity: 0; width: 0; height: 0;}
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: var(--border-color); transition: .4s; border-radius: 25px;
}
.slider:before {
    position: absolute; content: ""; height: 19px; width: 19px; left: 3px; bottom: 3px;
    background-color: white; transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: var(--p); }
input:checked + .slider:before { transform: translateX(-20px); } /* Reverse direction for RTL */

/* Sidebar */
.sidebar-header {
    padding: 15px;
    background: var(--p);
    color: var(--text-light);
    font-size: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
}
.sidebar-content {
    flex-grow: 1;
    padding: 15px 0;
    overflow-y: auto;
}

.sidebar-menu-item {
    padding: 15px 20px;
    margin: 5px 0;
    display: flex;
    align-items: center;
    justify-content: flex-start; 
    gap: 15px;
    font-size: 17px;
    color: var(--text-dark);
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
}

.sidebar-menu-item:hover {
    background: color-mix(in srgb, var(--s) 20%, var(--card-bg));
}
.sidebar-menu-item i { font-size: 1.2em; }

.sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    z-index: 24;
}
.sidebar-overlay.open { display: block; }

/* Small Image Source Modal */
#imageSourceModal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80%;
    max-width: 350px;
    height: auto;
    background: var(--card-bg);
    border-radius: 15px;
    box-shadow: var(--shadow-hover);
    padding: 20px;
    z-index: 150;
    display: none;
    flex-direction: column;
    align-items: center;
}
/* Toast Animation */
.toast.show{
    display:block;
    animation: fadeInOut 2.5s ease-in-out forwards;
}

@keyframes fadeInOut {
    0% { opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { opacity: 0; }
}

/* List Item */
.list-item{
    background: var(--card-bg);
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    border-right: 5px solid var(--s); 
    color: var(--text-dark);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.list-item:hover {
    background: color-mix(in srgb, var(--card-bg) 95%, #999);
    box-shadow: var(--shadow-light);
}
.list-item .main-info {
    flex-grow: 1;
}
.list-item .amount-display {
    font-weight: bold;
    font-size: 1.2em;
    margin-right: 15px;
    min-width: 80px;
    text-align: left;
}
.list-item .details {
    font-size: 0.9em; 
    color: #666; 
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 5px;
}

/* ---------------------------------------------------- */
/* Responsive Fix for Tabs (Small Screens) */
/* ---------------------------------------------------- */
@media (max-width: 450px) {
    .tabs button {
        padding: 15px 5px; 
        font-size: 12px; 
    }
}
</style>
</head>

<body onload="initApp()">

<header>
    <button onclick="openLayer('sidebar')"><i class="fas fa-bars"></i></button> 
    <span class="title">Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</span>
    </header>

<div class="tabs">
    <button class="active" onclick="openTab('overview')">
        <i class="fas fa-tachometer-alt" style="margin-left: 5px;"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©
    </button>
    <button onclick="openTab('expenses')">
        <i class="fas fa-money-bill-wave" style="margin-left: 5px;"></i> Ù…ØµØ±ÙˆÙØ§Øª
    </button>
    <button onclick="openTab('rights')">
        <i class="fas fa-handshake" style="margin-left: 5px;"></i> Ø­Ù‚ÙˆÙ‚
    </button>
    <button onclick="openTab('debts')">
        <i class="fas fa-file-invoice" style="margin-left: 5px;"></i> Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    </button>
    <button onclick="openTab('reports')">
        <i class="fas fa-chart-pie" style="margin-left: 5px;"></i> ØªÙ‚Ø§Ø±ÙŠØ±
    </button>
</div>

<div id="overview" class="section active">
    <div class="balance-display">
        <h2>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
        <p id="currentBalanceDisplay">
            <i class="fas fa-spinner fa-spin"></i>
        </p>
        <button onclick="toggleBalanceVisibility()" id="balanceVisibilityToggle" title="Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±ØµÙŠØ¯" style="margin-right: 0; padding: 5px 0;">
             <i class="fas fa-eye"></i>
        </button>
    </div>

    <div class="balance-actions">
        <button class="action deposit" onclick="openBalanceActionModal('deposit')">
            <i class="fas fa-plus-circle"></i> Ø¥ÙŠØ¯Ø§Ø¹
        </button>
        <button class="action withdraw" onclick="openBalanceActionModal('withdraw')">
            <i class="fas fa-minus-circle"></i> Ø³Ø­Ø¨
        </button>
    </div>
    
    <button class="secondary" onclick="openLayer('balanceLogModal')" style="margin-top: 15px;">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯
    </button>
    
    <div class="card budget-goal-card" style="margin-top: 20px;">
        <h3 style="color: var(--warning); margin-top: 0;"><i class="fas fa-bullseye" style="margin-left: 5px;"></i> Ù‡Ø¯Ù Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h3>
        <div id="monthlyBudgetGoalContent">
            </div>
    </div>
    
    <div class="card" style="margin-top: 20px; border-top: 5px solid var(--p);">
        <h3 style="color: var(--p); margin-top: 0;"><i class="fas fa-calculator" style="margin-left: 5px;"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±)</h3>
        <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</span> <b id="sExpTotal">0</b></p>
        <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©:</span> <b id="sRigTotal">0</b></p>
        <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©:</span> <b id="sDebTotal">0</b></p>
        <p><span>Ø§Ù„Ù…Ø­ØµÙ„ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ‚:</span> <b id="sRigPaid" style="color: var(--success);">0</b></p>
        <p><span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª:</span> <b id="sDebPaid" style="color: var(--success);">0</b></p>
    </div>
    
</div>

<div id="expenses" class="section">
    <div class="card">
        <p style="color: var(--danger); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡Ø§ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙˆØ±Ø§Ù‹</p>
        <input id="eAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" inputmode="decimal">
        <select id="eType">
        <option value="">ğŸ›’ Ø§Ù„ÙØ¦Ø© (Ø§Ø®ØªØ± ÙØ¦Ø©)</option>
        <option value="Ø·Ø¹Ø§Ù… ÙˆÙ…Ø´Ø±ÙˆØ¨Ø§Øª">Ø·Ø¹Ø§Ù… ÙˆÙ…Ø´Ø±ÙˆØ¨Ø§Øª</option>
        <option value="Ù…ÙˆØ§ØµÙ„Ø§Øª">Ù…ÙˆØ§ØµÙ„Ø§Øª</option>
        <option value="ØªØ³ÙˆÙ‚/Ù…Ù„Ø§Ø¨Ø³">ØªØ³ÙˆÙ‚/Ù…Ù„Ø§Ø¨Ø³</option>
        <option value="ÙÙˆØ§ØªÙŠØ±/Ø§Ø´ØªØ±Ø§ÙƒØ§Øª">ÙÙˆØ§ØªÙŠØ±/Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</option>
        <option value="Ø±Ø¹Ø§ÙŠØ© Ø´Ø®ØµÙŠØ©">Ø±Ø¹Ø§ÙŠØ© Ø´Ø®ØµÙŠØ©</option>
        <option value="ØµØ­Ø©">ØµØ­Ø© ÙˆØ¹Ù„Ø§Ø¬</option>
        <option value="ØªØ±ÙÙŠÙ‡">ØªØ±ÙÙŠÙ‡ ÙˆØ³ÙØ±</option>
        <option value="ØªØ¹Ù„ÙŠÙ…">ØªØ¹Ù„ÙŠÙ…</option>
        <option value="ØªØ¨Ø±Ø¹Ø§Øª">ØªØ¨Ø±Ø¹Ø§Øª ÙˆØµØ¯Ù‚Ø§Øª</option>
        <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
        </select>
        <input id="eDesc" placeholder="ğŸ“ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
        <div class="datetime-container">
            <input id="eDate" type="datetime-local">
            <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
        </div>
        
        <button class="secondary" onclick="openLayer('imageSource')">
            <i class="fas fa-camera" style="margin-left: 5px;"></i> Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        </button>
        <span id="eImgName" style="display: block; font-size: 0.8em; color: var(--success); text-align: right; margin-top: 5px;"></span>
        <input type="file" id="eImgCamera" accept="image/*" capture="camera" style="display: none;" onchange="updateFileName(this, 'eImgName')">
        <input type="file" id="eImgGallery" accept="image/*" style="display: none;" onchange="updateFileName(this, 'eImgName')">
        
        <button class="action" onclick="addExpense()">
            <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ
        </button>
    </div>
    
    <button class="secondary" onclick="openLog('exp')">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
    </button>
</div>

<div id="rights" class="section">
    <div class="card">
        <p style="color: var(--success); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„Ø© ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
        <select id="rType" onchange="updateRightFields(this.value)">
        <option value="">ğŸ¤ Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚</option>
        <option value="Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ">Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ</option>
        <option value="Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„">Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„</option>
        <option value="Ø³Ù„Ù/Ù…Ù‚Ø¯Ù…">Ø³Ù„Ù/Ù…Ù‚Ø¯Ù…</option>
        <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
        </select>
        <input id="rAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚" oninput="formatAmount(this)" inputmode="decimal">
        
        <div id="rDynamicFields">
            <input id="rCollectedAmount" type="text" placeholder="âœ… Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù† (0 Ø¥Ø°Ø§ ÙƒØ§Ù† ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹)" oninput="formatAmount(this)" inputmode="decimal" value="0">
        </div>
        
        <input id="rDesc" placeholder="ğŸ‘¤ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†/Ø§Ù„Ø¬Ù‡Ø©)">
        <div class="datetime-container">
            <input id="rDate" type="datetime-local">
            <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
        </div>
        <button class="action" onclick="addRight()">
            <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ø­Ù‚
        </button>
    </div>

    <div class="card" id="rightsTotals" style="margin-top: 15px; border-top: 5px solid var(--success);">
        <h3 style="color: var(--success); margin-top: 0;"><i class="fas fa-chart-bar" style="margin-left: 5px;"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ù‚ÙˆÙ‚ (Ø§Ù„ÙƒÙ„ÙŠ)</h3>
        <p><span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚:</span> <b id="rigTotalDisplay">0</b></p>
        <p style="color: var(--success);"><span>Ø§Ù„Ù…Ø­ØµÙ„ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ‚:</span> <b id="rigCollectedDisplay">0</b></p>
        <p style="color: var(--danger);"><span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ØºÙŠØ± Ø§Ù„Ù…Ø­ØµÙ„:</span> <b id="rigPendingDisplay">0</b></p>
    </div>
    
    <button class="secondary" onclick="openLog('rig')">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ‚
    </button>
</div>

<div id="debts" class="section">
    <div class="card">
        <p style="color: var(--danger); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø¯ÙØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
        <select id="dType" onchange="updateDebtFields(this.value)">
        <option value="">ğŸ§¾ Ù†ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</option>
        <option value="Ù‚Ø±Ø¶/Ø£Ù‚Ø³Ø§Ø·">Ù‚Ø±Ø¶/Ø£Ù‚Ø³Ø§Ø·</option>
        <option value="Ø¥ÙŠØ¬Ø§Ø±">Ø¥ÙŠØ¬Ø§Ø±</option>
        <option value="ÙÙˆØ§ØªÙŠØ± Ø®Ø¯Ù…Ø§Øª">ÙÙˆØ§ØªÙŠØ± Ø®Ø¯Ù…Ø§Øª (ÙƒÙ‡Ø±Ø¨Ø§Ø¡ØŒ Ù…Ø§Ø¡ØŒ Ø¥Ù†ØªØ±Ù†Øª)</option>
        <option value="Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ">Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ</option>
        <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
        </select>
        <input id="dAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚" oninput="formatAmount(this)" inputmode="decimal">

        <div id="dDynamicFields">
             <input id="dPaidAmount" type="text" placeholder="ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù† (0 Ø¥Ø°Ø§ ÙƒØ§Ù† ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹)" oninput="formatAmount(this)" inputmode="decimal" value="0">
        </div>
        
        <input id="dDesc" placeholder="ğŸ¢ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø³Ù… Ø§Ù„Ø¯Ø§Ø¦Ù†/Ø§Ù„Ø¬Ù‡Ø©)">
        <div class="datetime-container">
            <input id="dDate" type="datetime-local">
            <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
        </div>
        
        <button class="action" onclick="addDebt()">
            <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…
        </button>
    </div>

    <div class="card" id="debtsTotals" style="margin-top: 15px; border-top: 5px solid var(--danger);">
        <h3 style="color: var(--danger); margin-top: 0;"><i class="fas fa-credit-card" style="margin-left: 5px;"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª (Ø§Ù„ÙƒÙ„ÙŠ)</h3>
        <p><span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª:</span> <b id="debTotalDisplay">0</b></p>
        <p style="color: var(--success);"><span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª:</span> <b id="debPaidDisplay">0</b></p>
        <p style="color: var(--danger);"><span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ØºÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span> <b id="debPendingDisplay">0</b></p>
    </div>
    
    <button class="secondary" onclick="openLog('deb')">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    </button>
</div>

<div id="reports" class="section">
    <div class="card" style="border-top: 5px solid var(--s);">
        <h3 style="color: var(--p); margin-top: 0;"><i class="fas fa-chart-pie" style="margin-left: 5px;"></i> ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (Ø¢Ø®Ø± 30 ÙŠÙˆÙ…Ø§Ù‹)</h3>
        <p style="font-size: 0.9em; color: #999;">ÙŠØ¹Ø±Ø¶ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø®Ø·Ø· Ø£ÙƒØ¨Ø± 5 ÙØ¦Ø§Øª Ù„Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ Ø®Ù„Ø§Ù„ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ.</p>
        <div class="chart-container">
            <canvas id="expensePieChart"></canvas>
        </div>
        <p style="text-align: center; color: var(--danger); font-weight: bold;" id="chartMessage"></p>
    </div>
    
    <div class="card" style="border-top: 5px solid var(--p);">
        <h3 style="color: var(--p); margin-top: 0;"><i class="fas fa-balance-scale" style="margin-left: 5px;"></i> ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£ØµÙˆÙ„ ÙˆØ§Ù„Ø®ØµÙˆÙ…</h3>
        <p id="assetLiabilitySummary">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...</p>
    </div>
</div>

<div class="modal" id="logModal">
    <header>
        <button onclick="popLayer()"><i class="fas fa-arrow-right"></i></button>
        <input id="search" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„..." oninput="renderLog()">
        <button onclick="closeLayer('log')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content" id="logContent"></div>
</div>

<div class="modal" id="detailModal">
    <header>
        <button onclick="popLayer()"><i class="fas fa-arrow-right"></i></button>
        <span class="title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</span>
        <button onclick="closeLayer('detail')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content detail" id="detailContent"></div>
</div>

<div class="modal" id="editModal">
    <header>
        <button onclick="popLayer()"><i class="fas fa-arrow-right"></i></button>
        <span class="title" id="editModalTitle">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</span>
        <button onclick="closeLayer('edit')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content" id="editModalContent">
        </div>
</div>

<div class="modal" id="balanceActionModal">
    <header>
        <button onclick="popLayer()"><i class="fas fa-arrow-right"></i></button>
        <span class="title" id="actionModalTitle"></span>
        <button onclick="closeLayer('balanceAction')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <p style="text-align: center; font-size: 1.1em;">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="currentBalanceInAction" style="color: var(--p); font-weight: bold;"></span></p>
        <input id="bAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" inputmode="decimal">
        <input id="bDesc" placeholder="ğŸ“ ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Ù…Ø«Ù„: Ø±Ø§ØªØ¨ØŒ ØªØ­ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ)">
        <div class="datetime-container">
            <input id="bDate" type="datetime-local">
            <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
        </div>
        <button class="action" onclick="processBalanceAction()">
            <i class="fas fa-check" style="margin-left: 5px;"></i> ØªÙ†ÙÙŠØ°
        </button>
    </div>
</div>

<div class="modal" id="balanceLogModal">
    <header>
        <button onclick="popLayer()"><i class="fas fa-arrow-right"></i></button>
        <span class="title">Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯</span>
        <button onclick="closeLayer('balanceLog')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content" id="balanceLogContent">
        </div>
</div>

<div id="imageSourceModal">
    <h3 style="margin-bottom: 20px;">Ø§Ø®ØªÙŠØ§Ø± Ù…ØµØ¯Ø± Ø§Ù„ØµÙˆØ±Ø©</h3>
    <button class="action" onclick="openCameraInput()"><i class="fas fa-camera" style="margin-left: 10px;"></i> Ø§Ù„ØªÙ‚Ø§Ø· Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
    <button class="secondary" onclick="openGalleryInput()"><i class="fas fa-images" style="margin-left: 10px;"></i> Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ø¶</button>
    <button class="secondary" style="background: none; border: none; color: var(--danger); margin-top: 10px;" onclick="closeLayer('imageSource')">Ø¥Ù„ØºØ§Ø¡</button>
</div>
<div class="sidebar-overlay" id="imageSourceOverlay" style="z-index: 140;" onclick="closeLayer('imageSource')"></div>

<div class="toast" id="toast"></div>

<div class="sidebar-overlay" onclick="closeLayer('sidebar')"></div>

<div class="sidebar" id="appSidebar">
    <div class="sidebar-header">
        <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        <button onclick="closeLayer('sidebar')"><i class="fas fa-times"></i></button>
    </div>
    <div class="sidebar-content">
        <div class="card" style="margin: 0 15px 15px; border-top: 5px solid var(--s);">
             <p style="font-weight: bold; margin-top: 0; color: var(--p);">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</p>
             
             <div class="switch-container">
                 <i class="fas fa-moon" style="margin-left: 10px;"></i> <span>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span>
                 <label class="switch">
                     <input type="checkbox" id="darkModeToggle" onclick="toggleDarkMode()">
                     <span class="slider"></span>
                 </label>
             </div>
             
             <button class="secondary" onclick="openLayer('currencyModal')" style="display: flex; justify-content: space-between; align-items: center; border: none; background: var(--card-bg); margin-top: 15px; padding: 12px 0;">
                 <span id="currentCurrencyDisplay" style="font-weight: bold;">Ø§Ù„Ø¹Ù…Ù„Ø©: Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ (Ø±.Ø³)</span>
                 <span style="color: var(--p);"><i class="fas fa-exchange-alt"></i> ØªØºÙŠÙŠØ±</span>
             </button>
             
             <button class="secondary" onclick="openMonthlyGoalModal()" style="display: flex; justify-content: space-between; align-items: center; border: none; background: var(--card-bg); margin-top: 10px; padding: 12px 0;">
                 <span id="currentMonthlyGoalDisplay" style="font-weight: bold;">Ù‡Ø¯Ù Ø§Ù„Ø´Ù‡Ø±: Ù„Ù… ÙŠÙØ­Ø¯Ø¯</span>
                 <span style="color: var(--warning);"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</span>
             </button>
        </div>
        
        <div class="sidebar-menu-item" onclick="exportData()">
            <i class="fas fa-file-export"></i> <span>ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</span>
        </div>
        
        <div class="sidebar-menu-item" onclick="document.getElementById('importFile').click()">
            <i class="fas fa-file-import"></i> <span>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</span>
        </div>
        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
        
        <div class="sidebar-menu-item" onclick="openLayer('about')">
            <i class="fas fa-info-circle"></i> <span>Ø­ÙˆÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>
        </div>
        
        <div class="sidebar-menu-item" onclick="confirmResetData()" style="color: var(--danger);">
            <i class="fas fa-exclamation-triangle"></i> <span>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        </div>
    </div>
</div>

<div class="modal" id="aboutModal">
    <header>
        <button onclick="popLayer()"><i class="fas fa-arrow-right"></i></button>
        <h3 style="color: var(--p);">Ø­ÙˆÙ„ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ©</h3>
        <button onclick="closeLayer('about')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <p>ØªØ·Ø¨ÙŠÙ‚ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© Ù‡Ùˆ Ø£Ø¯Ø§Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ ØªØªØ¨Ø¹:</p>
        <ul>
            <li><i class="fas fa-wallet" style="color: var(--s);"></i> **Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø©** Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.</li>
            <li><i class="fas fa-receipt" style="color: var(--s);"></i> **Ø§Ù„Ø­Ù‚ÙˆÙ‚** Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ù„Ùƒ (Ø¯ÙŠÙˆÙ†ØŒ Ø¨ÙŠØ¹ Ø¢Ø¬Ù„).</li>
            <li><i class="fas fa-clipboard-list" style="color: var(--s);"></i> **Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª** Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ø¹Ù„ÙŠÙƒ (ÙÙˆØ§ØªÙŠØ±ØŒ Ø£Ù‚Ø³Ø§Ø·ØŒ Ù‚Ø±ÙˆØ¶).</li>
        </ul>
        <p class="card" style="border-top: 3px solid var(--danger);">
            <strong>Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©:</strong> ÙŠØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ© IndexedDBØŒ ÙˆÙ„Ø§ ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ø£ÙŠ Ø®Ø§Ø¯Ù… Ø®Ø§Ø±Ø¬ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ.
        </p>
        <p style="text-align: center; margin-top: 20px; color: #999; font-size: 0.9em;">Ø§Ù„Ø¥ØµØ¯Ø§Ø± 4.0 (Ù…Ø·ÙˆØ± ÙˆÙ…Ø«Ø¨Øª)</p>
    </div>
</div>

<div class="modal" id="currencyModal">
    <header>
        <button onclick="popLayer()"><i class="fas fa-arrow-right"></i></button>
        <h3 style="color: var(--p);">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø©</h3>
        <button onclick="closeLayer('currency')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <input id="currencySearch" type="text" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„Ø© (Ø±ÙŠØ§Ù„ØŒ Ø¬Ù†ÙŠÙ‡ØŒ Ø¯ÙˆÙ„Ø§Ø±...)" oninput="renderCurrencyList()">
        <div id="currencyList">
            </div>
    </div>
</div>

<div class="modal" id="monthlyGoalModal">
    <header>
        <button onclick="popLayer()"><i class="fas fa-arrow-right"></i></button>
        <h3 style="color: var(--warning);">ØªØ­Ø¯ÙŠØ¯ Ù‡Ø¯Ù Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h3>
        <button onclick="closeLayer('monthlyGoal')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <p style="text-align: center; font-size: 0.9em; color: var(--text-dark);">Ø¹ÙŠÙ‘Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù‡Ø§ Ø´Ù‡Ø±ÙŠØ§Ù‹:</p>
        <input id="monthlyGoalAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù" oninput="formatAmount(this)" inputmode="decimal">
        <button class="action" onclick="saveMonthlyGoal()">
            <i class="fas fa-check" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ù‡Ø¯Ù
        </button>
        <button class="secondary danger-btn" onclick="clearMonthlyGoal()" style="margin-top: 15px; color: var(--text-light);">
            <i class="fas fa-trash" style="margin-left: 5px;"></i> Ø­Ø°Ù Ø§Ù„Ù‡Ø¯Ù
        </button>
    </div>
</div>


<script>
// ===================================================
// 1. Ø¥Ø¹Ø¯Ø§Ø¯ IndexedDB ÙˆÙ…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Øª
// ===================================================

const IDB_NAME = "MySmartBudgetDB";
const IDB_VERSION = 6; // ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹
const STORE_NAMES = ["exp", "rig", "deb", "bal"]; 

// ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
let db = { exp: [], rig: [], deb: [], bal: { clientId: 1, amount: 0, changes: [] } }; 
let IDB_connection = null; 

// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©
let currentLog = "", editMode = null, balanceActionType = null; 
let currentBalance = 0;
let balanceHidden = localStorage.getItem('balanceHidden') === 'true'; 

// Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ù‚Ù„ (Layers)
const LAYERS = { 
    'sidebar': { elementId: 'appSidebar', type: 'menu' }, 
    'log': { elementId: 'logModal', type: 'modal' }, 
    'detail': { elementId: 'detailModal', type: 'modal' }, 
    'edit': { elementId: 'editModal', type: 'modal' }, 
    'currency': { elementId: 'currencyModal', type: 'modal' }, 
    'about': { elementId: 'aboutModal', type: 'modal' }, 
    'balanceAction': { elementId: 'balanceActionModal', type: 'modal' }, 
    'balanceLog': { elementId: 'balanceLogModal', type: 'modal' }, 
    'imageSource': { elementId: 'imageSourceModal', type: 'modal', overlayId: 'imageSourceOverlay' },
    'monthlyGoal': { elementId: 'monthlyGoalModal', type: 'modal' } // New Modal
};
let historyStack = [];

// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ù…Ù„Ø§Øª
const ARABIC_CURRENCIES = [
    { code: 'SAR', symbol: 'Ø±.Ø³', name: 'Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ' },
    { code: 'EGP', symbol: 'Ø¬.Ù…', name: 'Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ' },
    { code: 'AED', symbol: 'Ø¯.Ø¥', name: 'Ø¯Ø±Ù‡Ù… Ø¥Ù…Ø§Ø±Ø§ØªÙŠ' },
    { code: 'KWD', symbol: 'Ø¯.Ùƒ', name: 'Ø¯ÙŠÙ†Ø§Ø± ÙƒÙˆÙŠØªÙŠ' },
    { code: 'USD', symbol: '$', name: 'Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ' },
    { code: 'QAR', symbol: 'Ø±.Ù‚', name: 'Ø±ÙŠØ§Ù„ Ù‚Ø·Ø±ÙŠ' },
    { code: 'OMR', symbol: 'Ø±.Ø¹.', name: 'Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ' },
    { code: 'JOD', symbol: 'Ø¯.Ø§', name: 'Ø¯ÙŠÙ†Ø§Ø± Ø£Ø±Ø¯Ù†ÙŠ' },
    { code: 'EUR', symbol: 'â‚¬', name: 'ÙŠÙˆØ±Ùˆ' },
    { code: 'TRY', symbol: 'â‚º', name: 'Ù„ÙŠØ±Ø© ØªØ±ÙƒÙŠØ©' },
    { code: 'LYD', symbol: 'Ù„.Ø¯', name: 'Ø¯ÙŠÙ†Ø§Ø± Ù„ÙŠØ¨ÙŠ' },
]; 
let currentCurrency = ARABIC_CURRENCIES.find(c => c.code === (localStorage.getItem('currencyCode') || 'SAR'));
let monthlyExpenseGoal = cleanAmount(localStorage.getItem('monthlyGoal') || 0);

// Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
let expenseChart = null;


// ===================================================
// 2. ÙˆØ¸Ø§Ø¦Ù IndexedDB ÙˆØ§Ù„Ø­ÙØ¸ (Ù…ÙƒØªÙ…Ù„Ø© ÙˆÙ…Ø¹Ø¯Ù„Ø©)
// ===================================================

function initDB() {
    return new Promise((resolve, reject) => {
        if (!window.indexedDB) {
            toastMsg("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… IndexedDB. Ù„Ù† ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
            return reject(new Error("IndexedDB not supported."));
        }
        
        const request = indexedDB.open(IDB_NAME, IDB_VERSION);
        
        request.onerror = (e) => {
            console.error("IndexedDB error:", e.target.error);
            reject(e.target.error);
        };
        
        request.onupgradeneeded = (e) => {
            IDB_connection = e.target.result;
            // ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø®Ø§Ø²Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
            STORE_NAMES.forEach(storeName => {
                if (IDB_connection.objectStoreNames.contains(storeName)) {
                    IDB_connection.deleteObjectStore(storeName);
                }
                const keyPath = (storeName === 'bal') ? 'clientId' : 'id';
                const autoIncrement = (storeName !== 'bal');
                const store = IDB_connection.createObjectStore(storeName, { keyPath: keyPath, autoIncrement: autoIncrement });
                if(storeName === 'bal') { 
                    store.add({ clientId: 1, amount: 0, changes: [] });
                }
            });
            // ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„ØªØ±Ù‚ÙŠØ©
            e.target.transaction.oncomplete = () => {
                resolve(IDB_connection); 
                loadAllData().then(initAfterLoad);
            };
        };

        request.onsuccess = (e) => {
            IDB_connection = e.target.result;
            resolve(IDB_connection);
            loadAllData().then(initAfterLoad);
        };
    });
}

function initApp() {
    // ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ø¥Ù† ÙƒØ§Ù† Ù…Ø­ÙÙˆØ¸Ø§Ù‹
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        document.getElementById('darkModeToggle').checked = true;
    }
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ù„Ø©
    updateCurrencyDisplay();
    // Ø¨Ø¯Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    initDB();
}

function initAfterLoad() {
    updateStats();
    updateBalanceDisplay();
    updateMonthlyGoalDisplay();
}

// Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù…Ø®Ø²Ù† Ù…Ø¹ÙŠÙ† (exp, rig, deb) Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ (bal)
function saveData(storeName, data) {
    return new Promise((resolve, reject) => {
        if (!IDB_connection) return reject(new Error("Database not connected."));
        const transaction = IDB_connection.transaction([storeName], "readwrite");
        const store = transaction.objectStore(storeName);
        
        if (storeName === 'bal') {
             // IndexedDB requires the object to exist before updating, but here we use put which handles both add/update based on keyPath.
             const request = store.put(data);
             request.onsuccess = () => resolve(request.result);
             request.onerror = (e) => reject(e.target.error);
        } else {
            // For items, check if 'id' is present for update or for add
            const isUpdate = typeof data.id === 'number';
            const request = store.put(data);

            request.onsuccess = (event) => {
                // If it was an add operation (id generated by DB), update the object
                if (!isUpdate) data.id = event.target.result; 
                resolve(data);
            };
            request.onerror = (e) => reject(e.target.error);
        }
    });
}

// Ø­Ø°Ù Ù…Ø¹Ø§Ù…Ù„Ø© Ù…Ù† Ù…Ø®Ø²Ù† Ù…Ø¹ÙŠÙ†
function deleteFromDB(storeName, id) {
    return new Promise((resolve, reject) => {
        if (!IDB_connection) return reject(new Error("Database not connected."));
        const transaction = IDB_connection.transaction([storeName], "readwrite");
        const store = transaction.objectStore(storeName);
        const request = store.delete(id);
        request.onsuccess = () => resolve();
        request.onerror = (e) => reject(e.target.error);
    });
}

// ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ø®Ø²Ù† Ù…Ø¹ÙŠÙ†
function loadStoreData(storeName) {
    return new Promise((resolve) => {
        if (!IDB_connection) return resolve([]);
        const transaction = IDB_connection.transaction([storeName], "readonly");
        const store = transaction.objectStore(storeName);
        const request = store.getAll();
        
        request.onsuccess = (e) => {
            if(storeName === 'bal') {
                const result = e.target.result[0];
                return resolve(result || { clientId: 1, amount: 0, changes: [] });
            }
            // Sort by id descending (newest first)
            resolve(e.target.result.sort((a, b) => b.id - a.id));
        };
        request.onerror = () => resolve(storeName === 'bal' ? { clientId: 1, amount: 0, changes: [] } : []);
    });
}

// ØªØ­Ù…ÙŠÙ„ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
async function loadAllData() {
    try {
        const [expData, rigData, debData, balData] = await Promise.all([
            loadStoreData('exp'),
            loadStoreData('rig'),
            loadStoreData('deb'),
            loadStoreData('bal'),
        ]);
        db.exp = expData;
        db.rig = rigData;
        db.deb = debData;
        db.bal = balData;
        currentBalance = db.bal.amount || 0;
    } catch (e) {
        toastMsg("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
    }
}

// ===================================================
// 3. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆØ§Ù„ØªÙ†Ø³ÙŠÙ‚
// ===================================================

function toastMsg(msg, type = 'default') {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.style.backgroundColor = (type === 'success') ? 'var(--success)' : (type === 'error' ? 'var(--danger)' : '#333');
    toast.classList.add('show');
    setTimeout(() => {
        toast.classList.remove('show');
    }, 2500);
}

// ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø¨Ù„Øº Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
function formatAmount(input) {
    // Remove all non-digit and non-decimal characters, handling Arabic/English digits
    let value = input.value.replace(/[^0-9.]/g, '');
    
    // Check if the input is a valid number, keeping two decimal places
    const parts = value.split('.');
    if (parts.length > 1) {
        // Limit to one decimal point and two decimal digits
        value = parts[0] + '.' + parts.slice(1).join('').substring(0, 2);
    } 
    input.value = value;
}

// ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ Ø±Ù‚Ù…
function cleanAmount(value) {
    if (!value) return 0;
    // Remove non-numeric characters except for the decimal point
    const cleaned = String(value).replace(/[^0-9.]/g, '');
    return parseFloat(cleaned) || 0;
}

// ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
function formatDate(dateString) {
    if (!dateString) return 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true };
    try {
        // Handle ISO format ('YYYY-MM-DDTHH:mm')
        const date = new Date(dateString.replace('T', ' ')); 
        if (isNaN(date)) {
             // Try common date format
             return new Date(dateString).toLocaleDateString('ar-EG', options);
        }
        return date.toLocaleDateString('ar-EG', options);
    } catch(e) {
        return dateString;
    }
}

// ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„Ø©
function formatCurrency(amount, includeSymbol = true, sign = '') {
    const num = cleanAmount(amount);
    if (isNaN(num)) return `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©`;
    
    // Handle sign and color
    let color = '';
    if (sign === '-') {
        color = 'var(--danger)';
    } else if (sign === '+') {
        color = 'var(--success)';
    }
    
    const formatted = new Intl.NumberFormat('ar-EG', { 
        minimumFractionDigits: 2, 
        maximumFractionDigits: 2 
    }).format(Math.abs(num));
    
    let symbolHtml = '';
    if (includeSymbol && currentCurrency.symbol) {
        symbolHtml = `<span class="currency-symbol">${currentCurrency.symbol}</span>`;
    }
    
    // Arabic is RTL, so symbol is usually placed after the number
    return `<span style="color: ${color || 'inherit'};">${sign} ${formatted} ${symbolHtml}</span>`;
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨ØªÙ†Ø³ÙŠÙ‚ <input type="datetime-local">
function getCurrentDate() {
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    return now.toISOString().slice(0, 16);
}

// ===================================================
// 4. ÙˆØ¸Ø§Ø¦Ù ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
// ===================================================

function updateBalanceDisplay() {
    const displayElement = document.getElementById('currentBalanceDisplay');
    const symbolToggle = document.getElementById('balanceVisibilityToggle');
    
    if (balanceHidden) {
        displayElement.className = 'hidden-balance';
        displayElement.innerHTML = '';
        symbolToggle.innerHTML = '<i class="fas fa-eye-slash"></i>';
    } else {
        displayElement.className = '';
        displayElement.innerHTML = formatCurrency(currentBalance, true, currentBalance >= 0 ? '' : '-');
        symbolToggle.innerHTML = '<i class="fas fa-eye"></i>';
    }
    
    // Update balance in action modal
    const actionBalance = document.getElementById('currentBalanceInAction');
    if (actionBalance) {
        actionBalance.innerHTML = formatCurrency(currentBalance, true, '');
    }
}

function toggleBalanceVisibility() {
    balanceHidden = !balanceHidden;
    localStorage.setItem('balanceHidden', balanceHidden);
    updateBalanceDisplay();
}

function updateCurrencyDisplay() {
    document.getElementById('currentCurrencyDisplay').textContent = `Ø§Ù„Ø¹Ù…Ù„Ø©: ${currentCurrency.name} (${currentCurrency.symbol})`;
    updateBalanceDisplay(); // Refresh balance display with new currency
    // Re-render the current log/detail if open
    if (document.getElementById('logModal').classList.contains('open')) {
        renderLog();
    }
    if (document.getElementById('detailModal').classList.contains('open')) {
        // The detailed view logic needs the 'editMode' context, which is stored in the `showDetail` call,
        // but for a simple refresh, we can try to find the item in `editMode`
        if (editMode && editMode.item) {
             showDetail(editMode.item.type, editMode.item.id);
        }
    }
    toastMsg(`ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø© Ø¥Ù„Ù‰: ${currentCurrency.name}`, 'success');
}

function updateMonthlyGoalDisplay() {
    const display = document.getElementById('currentMonthlyGoalDisplay');
    if (monthlyExpenseGoal > 0) {
        display.textContent = `Ù‡Ø¯Ù Ø§Ù„Ø´Ù‡Ø±: ${formatCurrency(monthlyExpenseGoal, true)}`;
    } else {
        display.textContent = 'Ù‡Ø¯Ù Ø§Ù„Ø´Ù‡Ø±: Ù„Ù… ÙŠÙØ­Ø¯Ø¯';
    }
}

function updateStats() {
    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();

    // 1. Calculate Monthly Expenses
    const monthlyExpenses = db.exp.filter(item => {
        const itemDate = new Date(item.date);
        return itemDate.getMonth() === currentMonth && itemDate.getFullYear() === currentYear;
    }).reduce((sum, item) => sum + cleanAmount(item.amount), 0);

    // 2. Calculate Totals (All Time)
    const expTotal = db.exp.reduce((sum, item) => sum + cleanAmount(item.amount), 0);
    const rigTotal = db.rig.reduce((sum, item) => sum + cleanAmount(item.amount), 0);
    const debTotal = db.deb.reduce((sum, item) => sum + cleanAmount(item.amount), 0);
    const rigPaid = db.rig.reduce((sum, item) => sum + cleanAmount(item.collectedAmount), 0);
    const debPaid = db.deb.reduce((sum, item) => sum + cleanAmount(item.paidAmount), 0);

    // Update Dashboard Totals
    document.getElementById('sExpTotal').innerHTML = formatCurrency(expTotal, true, '-');
    document.getElementById('sRigTotal').innerHTML = formatCurrency(rigTotal, true, '+');
    document.getElementById('sDebTotal').innerHTML = formatCurrency(debTotal, true, '-');
    document.getElementById('sRigPaid').innerHTML = formatCurrency(rigPaid, true, '+');
    document.getElementById('sDebPaid').innerHTML = formatCurrency(debPaid, true, '-');
    
    // Update Expenses Totals (Current Month)
    // Note: The original code had an 'expenseTotals' card that was always hidden. 
    // I will show it and update its content for total expenses.
    // document.getElementById('expTotalDisplay').innerHTML = formatCurrency(expTotal, true, '-');
    
    // Update Rights Totals (All Time)
    document.getElementById('rigTotalDisplay').innerHTML = formatCurrency(rigTotal, true, '+');
    document.getElementById('rigCollectedDisplay').innerHTML = formatCurrency(rigPaid, true, '+');
    document.getElementById('rigPendingDisplay').innerHTML = formatCurrency(rigTotal - rigPaid, true, '+');
    
    // Update Debts Totals (All Time)
    document.getElementById('debTotalDisplay').innerHTML = formatCurrency(debTotal, true, '-');
    document.getElementById('debPaidDisplay').innerHTML = formatCurrency(debPaid, true, '-');
    document.getElementById('debPendingDisplay').innerHTML = formatCurrency(debTotal - debPaid, true, '-');
    
    // Update Monthly Goal Progress Bar (New Feature)
    const goalContent = document.getElementById('monthlyBudgetGoalContent');
    if (monthlyExpenseGoal > 0) {
        const percentage = Math.min((monthlyExpenses / monthlyExpenseGoal) * 100, 100);
        let barClass = '';
        if (percentage >= 100) barClass = 'danger';
        else if (percentage >= 75) barClass = 'warning';
        
        goalContent.innerHTML = `
            <p>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <b>${formatCurrency(monthlyExpenses, true)}</b></p>
            <div class="goal-bar-container">
                <div class="goal-bar ${barClass}" style="width: ${percentage}%;"></div>
            </div>
            <div class="goal-bar-info">
                <span>ØªÙ… Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ: ${percentage.toFixed(1)}%</span>
                <span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${formatCurrency(monthlyExpenseGoal - monthlyExpenses, true)}</span>
            </div>
        `;
    } else {
        goalContent.innerHTML = `<p style="text-align: center; color: #999;">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù‡Ø¯Ù Ù„Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©.</p>`;
    }

    // Update Reports Tab if active
    if (document.querySelector('.tabs button:nth-child(5)').classList.contains('active')) {
        renderReports();
    }
}


// ===================================================
// 5. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙ†Ù‚Ù„ (Layers and Tabs)
// ===================================================

function pushLayer(layerName) {
    if (historyStack.length === 0 || historyStack[historyStack.length - 1] !== layerName) {
        historyStack.push(layerName);
    }
}

function popLayer() {
    if (historyStack.length > 1) {
        const topLayerName = historyStack.pop();
        const nextLayerName = historyStack[historyStack.length - 1];
        
        // Close the top layer (with animation)
        const topLayer = document.getElementById(LAYERS[topLayerName].elementId);
        topLayer.classList.remove('open');
        if (LAYERS[topLayerName].overlayId) {
             document.getElementById(LAYERS[topLayerName].overlayId).classList.remove('open');
        }
        
        // Open the previous layer (instantly)
        if (nextLayerName) {
            const nextLayer = document.getElementById(LAYERS[nextLayerName].elementId);
            nextLayer.classList.add('open');
            if (LAYERS[nextLayerName].overlayId) {
                 document.getElementById(LAYERS[nextLayerName].overlayId).classList.add('open');
            }
        }
    } else {
        // If only one layer is in stack, close it completely
        const layerName = historyStack.pop();
        closeLayer(layerName);
    }
}

function openLayer(layerName) {
    const layer = LAYERS[layerName];
    if (!layer) return;

    // Check if the layer is already open
    if (layer.type === 'modal' && document.getElementById(layer.elementId).classList.contains('open')) {
        return; 
    }
    
    pushLayer(layerName);
    
    // Close other layers if they are modals (only one modal can be open at a time)
    // Note: Sidebar and ImageSource are considered "menus" and should not close modals, but modals should close menus.
    if (layer.type === 'modal') {
        Object.keys(LAYERS).filter(name => LAYERS[name].type === 'modal' && name !== layerName).forEach(name => {
             document.getElementById(LAYERS[name].elementId).classList.remove('open');
        });
        // Modals also close the sidebar
        document.getElementById(LAYERS['sidebar'].elementId).classList.remove('open');
        document.querySelector('.sidebar-overlay').classList.remove('open');
    }
    
    // Open the target layer
    const element = document.getElementById(layer.elementId);
    element.classList.add('open');
    if (layerName === 'sidebar' && !document.querySelector('.sidebar-overlay').classList.contains('open')) {
        document.querySelector('.sidebar-overlay').classList.add('open');
    }
    if (layer.overlayId) {
        document.getElementById(layer.overlayId).classList.add('open');
    }

    // Specific logic for modals upon opening
    if (layerName === 'balanceActionModal') {
        document.getElementById('bDate').value = getCurrentDate();
    } else if (layerName === 'expenses' || layerName === 'rights' || layerName === 'debts') {
        document.getElementById(layerName.charAt(0) + 'Date').value = getCurrentDate();
    } else if (layerName === 'balanceLogModal') {
        renderBalanceLog();
    } else if (layerName === 'reports') {
        renderReports();
    }
}

function closeLayer(layerName) {
    const layer = LAYERS[layerName];
    if (!layer) return;

    // Remove from history stack
    historyStack = historyStack.filter(name => name !== layerName);
    
    // Close the layer element
    const element = document.getElementById(layer.elementId);
    element.classList.remove('open');

    // Close overlays
    if (layerName === 'sidebar' || layer.type === 'modal') {
        document.querySelector('.sidebar-overlay').classList.remove('open');
    }
    if (layer.overlayId) {
        document.getElementById(layer.overlayId).classList.remove('open');
    }

    // Cleanup specific states
    if (layerName === 'edit') {
        editMode = null;
    }
}

function openTab(tabName) {
    // Hide all sections
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    // Remove active class from all tabs
    document.querySelectorAll('.tabs button').forEach(btn => {
        btn.classList.remove('active');
    });

    // Show the target section and mark the tab as active
    document.getElementById(tabName).classList.add('active');
    document.querySelector(`.tabs button[onclick="openTab('${tabName}')"]`).classList.add('active');
    
    // Specific logic for tabs
    if (tabName === 'reports') {
        renderReports();
    }
}

function openSidebar() {
    openLayer('sidebar');
}

// ===================================================
// 6. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ (Expenses, Rights, Debts)
// ===================================================

function validateInput(amountId, typeId) {
    const amount = cleanAmount(document.getElementById(amountId).value);
    const type = document.getElementById(typeId) ? document.getElementById(typeId).value : 'N/A';
    
    if (amount <= 0) {
        toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„ØµÙØ±.", 'error');
        return false;
    }
    if (typeId && type === "") {
        toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹/ÙØ¦Ø©.", 'error');
        return false;
    }
    return true;
}

function addExpense() {
    if (!validateInput('eAmount', 'eType')) return;

    const amount = cleanAmount(document.getElementById('eAmount').value);
    
    // 1. Prepare data object
    const newItem = {
        type: 'exp',
        amount: amount,
        category: document.getElementById('eType').value,
        description: document.getElementById('eDesc').value,
        date: document.getElementById('eDate').value || getCurrentDate(),
        image: document.getElementById('eImgName').textContent || null
    };

    // 2. Update Balance
    currentBalance -= amount;
    db.bal.amount = currentBalance;
    db.bal.changes.unshift({ // Add to the start of the changes log
        id: Date.now(),
        type: 'expense',
        amount: -amount,
        desc: `Ù…ØµØ±ÙˆÙ: ${newItem.description || newItem.category}`,
        date: newItem.date
    });

    // 3. Save to DB and Array
    saveData('exp', newItem).then(savedItem => {
        db.exp.unshift(savedItem); // Add to local array
        return saveData('bal', db.bal); // Save balance
    }).then(() => {
        // 4. Update UI
        updateStats();
        updateBalanceDisplay();
        // 5. Reset Form & Toast
        document.getElementById('eAmount').value = '';
        document.getElementById('eType').value = '';
        document.getElementById('eDesc').value = '';
        document.getElementById('eImgName').textContent = '';
        toastMsg("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ ÙˆØ®ØµÙ…Ù‡ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯.", 'success');
    }).catch(e => toastMsg("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ: " + e.message, 'error'));
}

function addRight() {
    if (!validateInput('rAmount', 'rType')) return;

    const totalAmount = cleanAmount(document.getElementById('rAmount').value);
    const collectedAmount = cleanAmount(document.getElementById('rCollectedAmount').value);
    
    if (collectedAmount > totalAmount) {
        toastMsg("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚.", 'error');
        return;
    }

    // 1. Prepare data object
    const newItem = {
        type: 'rig',
        amount: totalAmount,
        collectedAmount: collectedAmount,
        category: document.getElementById('rType').value,
        description: document.getElementById('rDesc').value,
        date: document.getElementById('rDate').value || getCurrentDate(),
        status: (collectedAmount === totalAmount) ? 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„' : (collectedAmount > 0 ? 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹' : 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹')
    };

    // 2. Update Balance (Add collected amount only)
    if (collectedAmount > 0) {
        currentBalance += collectedAmount;
        db.bal.amount = currentBalance;
        db.bal.changes.unshift({ 
            id: Date.now(),
            type: 'collection',
            amount: collectedAmount,
            desc: `ØªØ­ØµÙŠÙ„ Ø­Ù‚: ${newItem.description || newItem.category}`,
            date: newItem.date
        });
    }

    // 3. Save to DB and Array
    saveData('rig', newItem).then(savedItem => {
        db.rig.unshift(savedItem); 
        return saveData('bal', db.bal); 
    }).then(() => {
        // 4. Update UI
        updateStats();
        updateBalanceDisplay();
        // 5. Reset Form & Toast
        document.getElementById('rAmount').value = '';
        document.getElementById('rCollectedAmount').value = '0';
        document.getElementById('rType').value = '';
        document.getElementById('rDesc').value = '';
        toastMsg("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ù‚ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯.", 'success');
    }).catch(e => toastMsg("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø­Ù‚: " + e.message, 'error'));
}

function addDebt() {
    if (!validateInput('dAmount', 'dType')) return;

    const totalAmount = cleanAmount(document.getElementById('dAmount').value);
    const paidAmount = cleanAmount(document.getElementById('dPaidAmount').value);
    
    if (paidAmount > totalAmount) {
        toastMsg("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø§Ù„ØªØ²Ø§Ù….", 'error');
        return;
    }

    // 1. Prepare data object
    const newItem = {
        type: 'deb',
        amount: totalAmount,
        paidAmount: paidAmount,
        category: document.getElementById('dType').value,
        description: document.getElementById('dDesc').value,
        date: document.getElementById('dDate').value || getCurrentDate(),
        status: (paidAmount === totalAmount) ? 'Ù…Ø¯ÙÙˆØ¹' : (paidAmount > 0 ? 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹' : 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹')
    };

    // 2. Update Balance (Deduct paid amount only)
    if (paidAmount > 0) {
        currentBalance -= paidAmount;
        db.bal.amount = currentBalance;
        db.bal.changes.unshift({ 
            id: Date.now(),
            type: 'payment',
            amount: -paidAmount,
            desc: `Ø¯ÙØ¹ Ø§Ù„ØªØ²Ø§Ù…: ${newItem.description || newItem.category}`,
            date: newItem.date
        });
    }

    // 3. Save to DB and Array
    saveData('deb', newItem).then(savedItem => {
        db.deb.unshift(savedItem); 
        return saveData('bal', db.bal); 
    }).then(() => {
        // 4. Update UI
        updateStats();
        updateBalanceDisplay();
        // 5. Reset Form & Toast
        document.getElementById('dAmount').value = '';
        document.getElementById('dPaidAmount').value = '0';
        document.getElementById('dType').value = '';
        document.getElementById('dDesc').value = '';
        toastMsg("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… ÙˆØ®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯.", 'success');
    }).catch(e => toastMsg("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…: " + e.message, 'error'));
}

// ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù€ Rights Ùˆ Debts (ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª) - ØªØ¨Ø³ÙŠØ· ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
function updateRightFields(value) { /* No longer needed as collectedAmount is always visible */ }
function updateDebtFields(value) { /* No longer needed as paidAmount is always visible */ }

// ===================================================
// 7. ÙˆØ¸Ø§Ø¦Ù Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª ÙˆØ§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©
// ===================================================

function openBalanceActionModal(action) {
    balanceActionType = action;
    document.getElementById('actionModalTitle').textContent = (action === 'deposit') ? 'Ø¥Ø¬Ø±Ø§Ø¡ Ø¥ÙŠØ¯Ø§Ø¹ Ù†Ù‚Ø¯ÙŠ' : 'Ø¥Ø¬Ø±Ø§Ø¡ Ø³Ø­Ø¨ Ù†Ù‚Ø¯ÙŠ';
    document.getElementById('bAmount').value = '';
    document.getElementById('bDesc').value = '';
    openLayer('balanceAction');
}

function processBalanceAction() {
    const amount = cleanAmount(document.getElementById('bAmount').value);
    const desc = document.getElementById('bDesc').value;
    const date = document.getElementById('bDate').value || getCurrentDate();
    
    if (amount <= 0) {
        toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­.", 'error');
        return;
    }

    const sign = (balanceActionType === 'deposit') ? 1 : -1;
    const finalAmount = amount * sign;
    
    // 1. Update Balance
    currentBalance += finalAmount;
    db.bal.amount = currentBalance;
    
    // 2. Add to Changes Log
    db.bal.changes.unshift({ 
        id: Date.now(),
        type: balanceActionType,
        amount: finalAmount,
        desc: desc || (balanceActionType === 'deposit' ? 'Ø¥ÙŠØ¯Ø§Ø¹ Ø¹Ø§Ù…' : 'Ø³Ø­Ø¨ Ø¹Ø§Ù…'),
        date: date
    });

    // 3. Save Balance
    saveData('bal', db.bal).then(() => {
        // 4. Update UI
        updateBalanceDisplay();
        updateStats();
        // 5. Close Modal & Toast
        closeLayer('balanceAction');
        toastMsg(`ØªÙ… ØªÙ†ÙÙŠØ° ${balanceActionType === 'deposit' ? 'Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹' : 'Ø§Ù„Ø³Ø­Ø¨'} Ø¨Ù†Ø¬Ø§Ø­.`, 'success');
    }).catch(e => toastMsg("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯: " + e.message, 'error'));
}

function renderBalanceLog() {
    const logContent = document.getElementById('balanceLogContent');
    let html = '';

    if (db.bal.changes.length === 0) {
        logContent.innerHTML = '<p style="text-align: center; color: #999; margin-top: 30px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>';
        return;
    }
    
    db.bal.changes.forEach(change => {
        const sign = change.amount >= 0 ? '+' : '-';
        const color = change.amount >= 0 ? 'var(--success)' : 'var(--danger)';
        
        // Exclude internal balance changes resulting from exp/rig/deb entries
        if (['deposit', 'withdraw'].includes(change.type)) {
            html += `
                <div class="list-item" style="border-right-color: ${color};">
                    <div class="main-info">
                        <strong>${change.type === 'deposit' ? 'Ø¥ÙŠØ¯Ø§Ø¹' : 'Ø³Ø­Ø¨'} Ù†Ù‚Ø¯ÙŠ</strong>
                        <div class="details">
                            <span>${change.desc}</span>
                            <span>${formatDate(change.date)}</span>
                        </div>
                    </div>
                    <span class="amount-display" style="color: ${color};">
                        ${formatCurrency(change.amount, true, sign)}
                    </span>
                </div>
            `;
        }
    });

    logContent.innerHTML = html || '<p style="text-align: center; color: #999; margin-top: 30px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¹Ø§Ù…Ø© (Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹/Ø§Ù„Ø³Ø­Ø¨).</p>';
}

// ===================================================
// 8. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª (Log, Detail, Edit, Delete)
// ===================================================

function openLog(type) {
    currentLog = type;
    document.getElementById('search').value = '';
    renderLog();
    openLayer('log');
}

function renderLog() {
    const logContent = document.getElementById('logContent');
    const searchTerm = document.getElementById('search').value.toLowerCase();
    
    const data = db[currentLog];
    const filteredData = data.filter(item => 
        item.description.toLowerCase().includes(searchTerm) || 
        (item.category && item.category.toLowerCase().includes(searchTerm)) ||
        formatCurrency(item.amount).includes(searchTerm)
    );

    if (filteredData.length === 0) {
        logContent.innerHTML = '<p style="text-align: center; color: #999; margin-top: 30px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„ÙÙ„ØªØ± Ø§Ù„Ø¨Ø­Ø«.</p>';
        return;
    }

    let html = '';
    filteredData.forEach(item => {
        html += renderLogItem(item);
    });

    logContent.innerHTML = html;
}

function renderLogItem(item) {
    let title, icon, color, amountDisplay;
    const totalAmount = cleanAmount(item.amount);

    switch(item.type) {
        case 'exp':
            title = 'Ù…ØµØ±ÙˆÙ: ' + (item.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯');
            icon = 'fa-money-bill-wave';
            color = 'var(--danger)';
            amountDisplay = formatCurrency(totalAmount, true, '-');
            break;
        case 'rig':
            title = 'Ø­Ù‚ Ù…Ø§Ù„ÙŠ: ' + (item.category || 'Ø¯ÙŠÙ†');
            icon = 'fa-handshake';
            color = 'var(--success)';
            const pendingRig = totalAmount - cleanAmount(item.collectedAmount);
            amountDisplay = `
                <span style="font-size: 0.8em; color: var(--success); margin-bottom: 3px;">+${formatCurrency(totalAmount - pendingRig, true)}</span>
                <span style="font-size: 0.9em; color: var(--danger);">- ${formatCurrency(pendingRig, true)}</span>
            `;
            break;
        case 'deb':
            title = 'Ø§Ù„ØªØ²Ø§Ù…: ' + (item.category || 'ÙØ§ØªÙˆØ±Ø©');
            icon = 'fa-file-invoice';
            color = 'var(--danger)';
            const pendingDeb = totalAmount - cleanAmount(item.paidAmount);
            amountDisplay = `
                <span style="font-size: 0.8em; color: var(--danger); margin-bottom: 3px;">-${formatCurrency(totalAmount - pendingDeb, true)}</span>
                <span style="font-size: 0.9em; color: var(--success);">+ ${formatCurrency(pendingDeb, true)}</span>
            `;
            break;
        default:
            return '';
    }

    return `
        <div class="list-item" style="border-right-color: ${color};" onclick="showDetail('${item.type}', ${item.id})">
            <div class="main-info">
                <strong><i class="fas ${icon}" style="margin-left: 5px; color: ${color};"></i> ${title}</strong>
                <div class="details" style="color: ${color};">
                    <span>${item.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</span>
                    <span style="color: #999;">${formatDate(item.date)}</span>
                </div>
            </div>
            <div class="amount-display" style="text-align: left;">
                ${amountDisplay}
            </div>
        </div>
    `;
}

function showDetail(type, id) {
    const item = db[type].find(i => i.id === id);
    if (!item) {
        toastMsg("Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.", 'error');
        return;
    }
    
    // Set editMode context
    editMode = { type: type, item: item, originalItem: JSON.parse(JSON.stringify(item)) };

    const detailContent = document.getElementById('detailContent');
    detailContent.innerHTML = renderDetail(item);
    openLayer('detail');
}

function renderDetail(item) {
    let html = `
        <div class="card" style="border-top: 5px solid var(--p);">
            <h3><i class="fas fa-info-circle" style="margin-left: 5px; color: var(--p);"></i> Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
            <p><strong>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙÙŠ:</strong> ${item.id}</p>
            <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${formatDate(item.date)}</p>
            <p><strong>Ø§Ù„ÙØ¦Ø©/Ø§Ù„Ù†ÙˆØ¹:</strong> ${item.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
            <p><strong>Ø§Ù„ÙˆØµÙ/Ø§Ù„Ø¬Ù‡Ø©:</strong> ${item.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</p>
        </div>
    `;

    if (item.type === 'exp') {
        html += `
            <div class="card" style="border-top: 5px solid var(--danger);">
                <h3><i class="fas fa-money-bill-wave" style="margin-left: 5px; color: var(--danger);"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ</h3>
                <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ:</strong> ${formatCurrency(item.amount, true, '-')}</p>
                <p><strong>ØªØ£Ø«ÙŠØ± Ø§Ù„Ø±ØµÙŠØ¯:</strong> Ø®ØµÙ… ÙÙˆØ±ÙŠ.</p>
                ${item.image ? `<p><strong>ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> <span style="color: var(--success);">${item.image}</span></p>` : ''}
            </div>
        `;
    } else if (item.type === 'rig') {
        const pending = cleanAmount(item.amount) - cleanAmount(item.collectedAmount);
        html += `
            <div class="card" style="border-top: 5px solid var(--success);">
                <h3><i class="fas fa-handshake" style="margin-left: 5px; color: var(--success);"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ù‚</h3>
                <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚:</strong> ${formatCurrency(item.amount, true)}</p>
                <p style="color: var(--success);"><strong>Ø§Ù„Ù…Ø­ØµÙ„ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†:</strong> ${formatCurrency(item.collectedAmount, true, '+')}</p>
                <p style="color: var(--danger);"><strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ØºÙŠØ± Ø§Ù„Ù…Ø­ØµÙ„:</strong> ${formatCurrency(pending, true)}</p>
                <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <strong style="color: ${pending === 0 ? 'var(--success)' : 'var(--danger)'};">${item.status}</strong></p>
            </div>
            ${pending > 0 ? `<button class="action" onclick="openPaymentActionModal('${item.type}', ${item.id})" style="background: var(--success);">
                <i class="fas fa-plus-circle" style="margin-left: 5px;"></i> ØªØ³Ø¬ÙŠÙ„ ØªØ­ØµÙŠÙ„ Ø¬Ø¯ÙŠØ¯
            </button>` : ''}
        `;
    } else if (item.type === 'deb') {
        const pending = cleanAmount(item.amount) - cleanAmount(item.paidAmount);
        html += `
            <div class="card" style="border-top: 5px solid var(--danger);">
                <h3><i class="fas fa-file-invoice" style="margin-left: 5px; color: var(--danger);"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</h3>
                <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…:</strong> ${formatCurrency(item.amount, true)}</p>
                <p style="color: var(--success);"><strong>Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†:</strong> ${formatCurrency(item.paidAmount, true, '-')}</p>
                <p style="color: var(--danger);"><strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ØºÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong> ${formatCurrency(pending, true)}</p>
                <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <strong style="color: ${pending === 0 ? 'var(--success)' : 'var(--danger)'};">${item.status}</strong></p>
            </div>
            ${pending > 0 ? `<button class="action" onclick="openPaymentActionModal('${item.type}', ${item.id})" style="background: var(--danger);">
                <i class="fas fa-minus-circle" style="margin-left: 5px;"></i> ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
            </button>` : ''}
        `;
    }

    html += `
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="action secondary" onclick="openEditModal('${item.type}', ${item.id})" style="flex: 1; border: 1px solid var(--p); color: var(--p);">
                <i class="fas fa-edit" style="margin-left: 5px;"></i> ØªØ¹Ø¯ÙŠÙ„
            </button>
            <button class="action danger-btn" onclick="confirmDelete('${item.type}', ${item.id})" style="flex: 1;">
                <i class="fas fa-trash" style="margin-left: 5px;"></i> Ø­Ø°Ù
            </button>
        </div>
    `;

    return html;
}

function openEditModal(type, id) {
    const item = db[type].find(i => i.id === id);
    if (!item) return;

    // Set editMode context again (to be safe)
    editMode = { type: type, item: item, originalItem: JSON.parse(JSON.stringify(item)) };

    const content = document.getElementById('editModalContent');
    document.getElementById('editModalTitle').textContent = `ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ø§Ù…Ù„Ø© ${type === 'exp' ? 'Ù…ØµØ±ÙˆÙ' : type === 'rig' ? 'Ø­Ù‚' : 'Ø§Ù„ØªØ²Ø§Ù…'}`;

    // Create the HTML form for editing
    let html = '';
    const dateValue = item.date ? item.date.slice(0, 16) : getCurrentDate();

    if (type === 'exp') {
        html = `
            <input id="editAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" value="${item.amount}">
            <select id="editType">
                ${document.getElementById('eType').innerHTML}
            </select>
            <input id="editDesc" placeholder="ğŸ“ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©" value="${item.description || ''}">
            <div class="datetime-container">
                <input id="editDate" type="datetime-local" value="${dateValue}">
                <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
            </div>
            ${item.image ? `<p>ØµÙˆØ±Ø© Ù…Ø±ÙÙ‚Ø©: <span style="color: var(--success);">${item.image}</span></p>` : ''}
            <button class="action" onclick="editItem()">
                <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
            </button>
        `;
    } else if (type === 'rig' || type === 'deb') {
        const totalAmountKey = 'amount';
        const collectedPaidKey = (type === 'rig') ? 'collectedAmount' : 'paidAmount';
        const placeholderCollectedPaid = (type === 'rig') ? 'âœ… Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†' : 'ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†';
        
        html = `
            <select id="editType">
                ${document.getElementById(type === 'rig' ? 'rType' : 'dType').innerHTML}
            </select>
            <input id="editAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚" oninput="formatAmount(this)" value="${item[totalAmountKey]}">
            <input id="editCollectedPaidAmount" type="text" placeholder="${placeholderCollectedPaid}" oninput="formatAmount(this)" value="${item[collectedPaidKey]}">
            <input id="editDesc" placeholder="ğŸ“ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ù„Ù…Ø¯ÙŠÙ†/Ø§Ù„Ø¯Ø§Ø¦Ù†)" value="${item.description || ''}">
            <div class="datetime-container">
                <input id="editDate" type="datetime-local" value="${dateValue}">
                <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
            </div>
            <button class="action" onclick="editItem()">
                <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
            </button>
        `;
    }

    content.innerHTML = html;

    // Set dropdown values after injecting HTML
    if (type === 'exp') {
        document.getElementById('editType').value = item.category;
    } else if (type === 'rig') {
        document.getElementById('editType').value = item.category;
    } else if (type === 'deb') {
        document.getElementById('editType').value = item.category;
    }

    openLayer('edit');
}

function editItem() {
    if (!editMode) return;

    const { type, item, originalItem } = editMode;
    const newAmount = cleanAmount(document.getElementById('editAmount').value);
    const newCategory = document.getElementById('editType').value;
    const newDesc = document.getElementById('editDesc').value;
    const newDate = document.getElementById('editDate').value;
    
    let oldPaidCollected = 0;
    let newPaidCollected = 0;

    if (type === 'rig' || type === 'deb') {
        const collectedPaidInput = document.getElementById('editCollectedPaidAmount');
        if (!collectedPaidInput) {
             toastMsg("Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹/Ø§Ù„Ù…Ø­ØµÙ„.", 'error');
             return;
        }
        newPaidCollected = cleanAmount(collectedPaidInput.value);
        oldPaidCollected = originalItem[type === 'rig' ? 'collectedAmount' : 'paidAmount'];

        if (newPaidCollected > newAmount) {
            toastMsg("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹/Ø§Ù„Ù…Ø­ØµÙ„ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚.", 'error');
            return;
        }
    }

    // 1. Calculate the change in net balance
    let balanceChange = 0;
    
    if (type === 'exp') {
        // Balance = Old Amount (was deducted) - New Amount (to be deducted)
        balanceChange = originalItem.amount - newAmount;
    } else if (type === 'rig') {
        // Balance = New Collected - Old Collected
        balanceChange = newPaidCollected - oldPaidCollected;
        item.collectedAmount = newPaidCollected;
        item.status = (newPaidCollected === newAmount) ? 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„' : (newPaidCollected > 0 ? 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹' : 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹');
    } else if (type === 'deb') {
        // Balance = Old Paid (was deducted) - New Paid (to be deducted)
        // Since debts are deducted, we reverse the sign. Change is (Old Deduction - New Deduction)
        balanceChange = oldPaidCollected - newPaidCollected; 
        item.paidAmount = newPaidCollected;
        item.status = (newPaidCollected === newAmount) ? 'Ù…Ø¯ÙÙˆØ¹' : (newPaidCollected > 0 ? 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹' : 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹');
    }

    // 2. Update item properties
    item.amount = newAmount;
    item.category = newCategory;
    item.description = newDesc;
    item.date = newDate;

    // 3. Update Balance
    if (balanceChange !== 0) {
        currentBalance += balanceChange;
        db.bal.amount = currentBalance;
        
        // Update balance changes log (optional, but good practice)
        db.bal.changes.unshift({ 
            id: Date.now(),
            type: `edit-${type}`,
            amount: balanceChange,
            desc: `ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ø§Ù…Ù„Ø© ${type === 'exp' ? 'Ù…ØµØ±ÙˆÙ' : type === 'rig' ? 'Ø­Ù‚' : 'Ø§Ù„ØªØ²Ø§Ù…'} Ø±Ù‚Ù… ${item.id}`,
            date: newDate
        });
    }
    
    // 4. Save to DB
    saveData(type, item).then(() => {
        return saveData('bal', db.bal); 
    }).then(() => {
        // 5. Update UI & Close
        db[type] = db[type].map(i => i.id === item.id ? item : i); // Update local array (optional since array is passed by reference but safer to ensure sorting)
        db[type].sort((a, b) => b.id - a.id);
        updateStats();
        updateBalanceDisplay();
        closeLayer('edit');
        closeLayer('detail'); // Close detail modal too
        toastMsg("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯.", 'success');
        // Re-render log if it was open
        if (document.getElementById('logModal').classList.contains('open')) renderLog();
    }).catch(e => toastMsg("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª: " + e.message, 'error'));
}

function confirmDelete(type, id) {
    closeLayer('detail');
    if (confirm("ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŸ Ø³ÙŠØªÙ… Ø¹ÙƒØ³ ØªØ£Ø«ÙŠØ±Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯.")) {
        deleteItem(type, id);
    }
}

function deleteItem(type, id) {
    const itemIndex = db[type].findIndex(i => i.id === id);
    if (itemIndex === -1) {
        toastMsg("Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø­Ù„ÙŠØ§Ù‹.", 'error');
        return;
    }
    const itemToDelete = db[type][itemIndex];

    // 1. Calculate the reversal of the balance impact
    let balanceReversal = 0;
    const amount = cleanAmount(itemToDelete.amount);
    
    if (type === 'exp') {
        // Expense was deducted (-amount), reversal is +amount
        balanceReversal = amount;
    } else if (type === 'rig') {
        // Collection was added (+collectedAmount), reversal is -collectedAmount
        const collectedAmount = cleanAmount(itemToDelete.collectedAmount || 0);
        balanceReversal = -collectedAmount;
    } else if (type === 'deb') {
        // Payment was deducted (-paidAmount), reversal is +paidAmount
        const paidAmount = cleanAmount(itemToDelete.paidAmount || 0);
        balanceReversal = paidAmount;
    }

    // 2. Update Balance
    if (balanceReversal !== 0) {
        currentBalance += balanceReversal;
        db.bal.amount = currentBalance;
        
        // Add to changes log
        db.bal.changes.unshift({ 
            id: Date.now(),
            type: `delete-${type}`,
            amount: balanceReversal,
            desc: `Ø­Ø°Ù Ù…Ø¹Ø§Ù…Ù„Ø© ${type === 'exp' ? 'Ù…ØµØ±ÙˆÙ' : type === 'rig' ? 'Ø­Ù‚' : 'Ø§Ù„ØªØ²Ø§Ù…'} Ø±Ù‚Ù… ${id}`,
            date: getCurrentDate()
        });
    }

    // 3. Delete from DB and array
    deleteFromDB(type, id).then(() => {
        return saveData('bal', db.bal); // Save new balance
    }).then(() => {
        db[type].splice(itemIndex, 1); // Remove from local array
        
        // 4. Update UI & Toast
        updateStats();
        updateBalanceDisplay();
        toastMsg("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ÙˆØ¹ÙƒØ³ ØªØ£Ø«ÙŠØ±Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯.", 'success');
        // Re-render log if it was open
        if (document.getElementById('logModal').classList.contains('open')) renderLog();
    }).catch(e => toastMsg("ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: " + e.message, 'error'));
}

function openPaymentActionModal(type, id) {
    // This function is for quick partial payment/collection from detail modal
    closeLayer('detail');
    
    // Logic to open a smaller modal for quick payment/collection if needed.
    // For simplicity and quick implementation, I will re-open the edit modal pre-filled
    // and guide the user to adjust the 'paid/collected' amount.
    toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¯ÙŠÙ„ 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†' ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©.", 'default');
    openEditModal(type, id);
}

// ===================================================
// 9. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© (New Feature)
// ===================================================
function renderReports() {
    renderExpensePieChart();
    renderAssetLiabilitySummary();
}

function renderExpensePieChart() {
    const last30Days = new Date();
    last30Days.setDate(last30Days.getDate() - 30);

    const recentExpenses = db.exp.filter(item => {
        const itemDate = new Date(item.date);
        return itemDate >= last30Days;
    });

    const categories = {};
    recentExpenses.forEach(item => {
        const category = item.category || 'ØºÙŠØ± Ù…ØµÙ†Ù';
        const amount = cleanAmount(item.amount);
        categories[category] = (categories[category] || 0) + amount;
    });

    const sortedCategories = Object.entries(categories)
        .sort(([, a], [, b]) => b - a);
        
    const topCategories = sortedCategories.slice(0, 5);
    const otherAmount = sortedCategories.slice(5).reduce((sum, [, amount]) => sum + amount, 0);
    
    const dataLabels = topCategories.map(([category]) => category);
    const dataValues = topCategories.map(([, amount]) => amount);

    if (otherAmount > 0) {
        dataLabels.push('Ø£Ø®Ø±Ù‰');
        dataValues.push(otherAmount);
    }

    const totalRecentExpenses = dataValues.reduce((a, b) => a + b, 0);
    const chartMessage = document.getElementById('chartMessage');

    if (totalRecentExpenses === 0) {
        chartMessage.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ø¢Ø®Ø± 30 ÙŠÙˆÙ…Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.";
        // Destroy existing chart if it exists
        if (expenseChart) {
            expenseChart.destroy();
            expenseChart = null;
        }
        document.getElementById('expensePieChart').style.display = 'none';
        return;
    }
    chartMessage.textContent = "";
    document.getElementById('expensePieChart').style.display = 'block';

    // Chart Colors (A palette of blues, greens, and reds)
    const backgroundColors = [
        '#0077b6', '#48cae4', '#90e0ef', '#00bfa5', '#66bb6a', '#fbc02d', '#ef476f', '#ff8a80'
    ];
    
    const ctx = document.getElementById('expensePieChart').getContext('2d');
    
    // Destroy existing chart before creating a new one
    if (expenseChart) {
        expenseChart.destroy();
    }

    expenseChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: dataLabels,
            datasets: [{
                data: dataValues,
                backgroundColor: backgroundColors.slice(0, dataValues.length),
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            aspectRatio: 1, // Ensures it's a square chart
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: 'var(--text-dark)', // Use CSS variable
                        font: { family: 'Tajawal' },
                        generateLabels: (chart) => {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map((label, i) => {
                                    const value = data.datasets[0].data[i];
                                    const percentage = (value / totalRecentExpenses * 100).toFixed(1);
                                    return {
                                        text: `${label}: ${formatCurrency(value, true)} (${percentage}%)`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: '#fff',
                                        lineWidth: 2,
                                        hidden: !chart.isDatasetVisible(0) || chart.getDatasetMeta(0).data[i].hidden,
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                title: {
                    display: true,
                    text: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: ' + formatCurrency(totalRecentExpenses, true),
                    color: 'var(--text-dark)',
                    font: { family: 'Tajawal', size: 16, weight: 'bold' }
                },
                tooltip: {
                    rtl: true,
                    titleFont: { family: 'Tajawal' },
                    bodyFont: { family: 'Tajawal' },
                    callbacks: {
                         label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed !== null) {
                                const percentage = (context.parsed / totalRecentExpenses * 100).toFixed(1) + '%';
                                label += formatCurrency(context.parsed, true) + ' (' + percentage + ')';
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
}

function renderAssetLiabilitySummary() {
    const rigTotal = db.rig.reduce((sum, item) => sum + cleanAmount(item.amount), 0);
    const debTotal = db.deb.reduce((sum, item) => sum + cleanAmount(item.amount), 0);
    const rigPaid = db.rig.reduce((sum, item) => sum + cleanAmount(item.collectedAmount), 0);
    const debPaid = db.deb.reduce((sum, item) => sum + cleanAmount(item.paidAmount), 0);
    
    const totalAssets = currentBalance + rigTotal - rigPaid; // Current Balance + Pending Collections (Rig)
    const totalLiabilities = debTotal - debPaid; // Pending Payments (Deb)
    const netWorth = totalAssets - totalLiabilities;

    let summaryText = `
        <p><strong>ØµØ§ÙÙŠ Ø§Ù„Ø«Ø±ÙˆØ©:</strong> <span style="font-weight: bold; color: ${netWorth >= 0 ? 'var(--success)' : 'var(--danger)'};">${formatCurrency(netWorth, true)}</span></p>
        <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù„Ø© (Ø§Ù„Ø±ØµÙŠØ¯ + Ø­Ù‚ÙˆÙ‚ ØºÙŠØ± Ù…Ø­ØµÙ„Ø©):</strong> ${formatCurrency(totalAssets, true, '+')}</p>
        <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ… (Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©):</strong> ${formatCurrency(totalLiabilities, true, '-')}</p>
    `;
    
    document.getElementById('assetLiabilitySummary').innerHTML = summaryText;
}


// ===================================================
// 10. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Currency, DarkMode, Goal, Import/Export, Reset)
// ===================================================

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDarkMode = document.body.classList.contains('dark-mode');
    localStorage.setItem('darkMode', isDarkMode);
    // Re-render chart to pick up new color variables
    if (document.getElementById('reports').classList.contains('active')) {
        renderReports();
    }
}

function openCurrencyModal() {
    openLayer('currencyModal');
    renderCurrencyList();
}

function renderCurrencyList() {
    const search = document.getElementById('currencySearch').value.toLowerCase();
    const list = document.getElementById('currencyList');
    
    const filteredCurrencies = ARABIC_CURRENCIES.filter(c => 
        c.name.includes(search) || c.code.toLowerCase().includes(search)
    );

    let html = '';
    filteredCurrencies.forEach(c => {
        const isSelected = c.code === currentCurrency.code;
        html += `
            <button class="secondary" onclick="selectCurrency('${c.code}')" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; border: 1px solid ${isSelected ? 'var(--p)' : 'var(--border-color)'}; background: ${isSelected ? 'color-mix(in srgb, var(--p) 10%, var(--card-bg))' : 'var(--card-bg)'};">
                <span style="font-weight: bold;">${c.name} (${c.symbol})</span>
                ${isSelected ? '<i class="fas fa-check" style="color: var(--success);"></i>' : ''}
            </button>
        `;
    });
    list.innerHTML = html;
}

function selectCurrency(code) {
    const selected = ARABIC_CURRENCIES.find(c => c.code === code);
    if (selected) {
        currentCurrency = selected;
        localStorage.setItem('currencyCode', code);
        updateCurrencyDisplay();
        closeLayer('currency');
        renderCurrencyList(); // To update the checkmark in the list
    }
}

function openMonthlyGoalModal() {
    document.getElementById('monthlyGoalAmount').value = monthlyExpenseGoal > 0 ? monthlyExpenseGoal.toFixed(2) : '';
    openLayer('monthlyGoal');
}

function saveMonthlyGoal() {
    const amount = cleanAmount(document.getElementById('monthlyGoalAmount').value);
    
    if (amount < 0) {
        toastMsg("Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø´Ù‡Ø±ÙŠ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‚ÙŠÙ…Ø© Ù…ÙˆØ¬Ø¨Ø©.", 'error');
        return;
    }
    
    monthlyExpenseGoal = amount;
    localStorage.setItem('monthlyGoal', amount);
    updateMonthlyGoalDisplay();
    updateStats();
    closeLayer('monthlyGoal');
    toastMsg("ØªÙ… Ø­ÙØ¸ Ù‡Ø¯Ù Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­.", 'success');
}

function clearMonthlyGoal() {
     monthlyExpenseGoal = 0;
     localStorage.removeItem('monthlyGoal');
     updateMonthlyGoalDisplay();
     updateStats();
     closeLayer('monthlyGoal');
     toastMsg("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø´Ù‡Ø±ÙŠ.", 'success');
}


function exportData() {
    // Collect all data
    const exportObject = {
        version: IDB_VERSION,
        timestamp: new Date().toISOString(),
        settings: {
            currencyCode: currentCurrency.code,
            darkMode: localStorage.getItem('darkMode') === 'true',
            balanceHidden: localStorage.getItem('balanceHidden') === 'true',
            monthlyGoal: monthlyExpenseGoal 
        },
        data: db
    };

    const dataStr = JSON.stringify(exportObject, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `budget_backup_${new Date().toISOString().slice(0, 10)}.json`;

    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    toastMsg("ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.", 'success');
}

function importData(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const importedData = JSON.parse(e.target.result);

            if (!importedData.data || !importedData.data.bal) {
                toastMsg("ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…ÙÙ‚ÙˆØ¯ Ù…Ù†Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©.", 'error');
                return;
            }
            
            if (!confirm("ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ø³ÙŠØ¤Ø¯ÙŠ Ù‡Ø°Ø§ Ø¥Ù„Ù‰ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©.")) return;
            
            // 1. Reset current DB stores
            const transaction = IDB_connection.transaction(STORE_NAMES, "readwrite");
            
            // 2. Clear all stores
            STORE_NAMES.forEach(storeName => { transaction.objectStore(storeName).clear(); });
            
            // 3. Import data into stores
            transaction.oncomplete = () => {
                const importTrans = IDB_connection.transaction(STORE_NAMES, "readwrite");
                let importCount = 0;
                let totalStoresToImport = STORE_NAMES.length;

                STORE_NAMES.forEach(storeName => {
                    const store = importTrans.objectStore(storeName);
                    const dataArray = (storeName === 'bal') ? [importedData.data.bal] : importedData.data[storeName] || [];
                    
                    dataArray.forEach(item => {
                        // Ensure primary key is removed for auto-increment stores
                        if (storeName !== 'bal' && item.id) {
                            delete item.id; 
                        }
                        store.add(item).onerror = (e) => console.error(`Error adding ${storeName} item:`, e);
                    });
                    
                    importCount++;
                    if (importCount === totalStoresToImport) {
                         // 4. Update Settings
                         if (importedData.settings) {
                             if (importedData.settings.currencyCode) {
                                 localStorage.setItem('currencyCode', importedData.settings.currencyCode);
                             }
                             if (importedData.settings.darkMode !== undefined) {
                                 localStorage.setItem('darkMode', importedData.settings.darkMode);
                                 if (importedData.settings.darkMode) {
                                     document.body.classList.add('dark-mode');
                                     document.getElementById('darkModeToggle').checked = true;
                                 } else {
                                     document.body.classList.remove('dark-mode');
                                     document.getElementById('darkModeToggle').checked = false;
                                 }
                             }
                             if (importedData.settings.monthlyGoal !== undefined) {
                                 localStorage.setItem('monthlyGoal', importedData.settings.monthlyGoal);
                                 monthlyExpenseGoal = cleanAmount(importedData.settings.monthlyGoal);
                             }
                         }

                        // 5. Reload and update UI
                        loadAllData().then(initAfterLoad).then(() => {
                            toastMsg("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.", 'success');
                        });
                    }
                });
            };
            
            transaction.onerror = (e) => {
                toastMsg("ÙØ´Ù„ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯.", 'error');
            };

        } catch (error) {
            toastMsg("ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù JSON.", 'error');
            console.error(error);
        } finally {
            // Reset the file input to allow selecting the same file again
            event.target.value = null; 
        }
    };
    reader.readAsText(file);
}

function confirmResetData() {
    closeLayer('sidebar');
    if (confirm("ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.")) {
        resetAllData();
    }
}

function resetAllData() {
     if (!IDB_connection) return toastMsg("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.", 'error');

    const transaction = IDB_connection.transaction(STORE_NAMES, "readwrite");
    let storesCleared = 0;
    
    STORE_NAMES.forEach(storeName => {
        const store = transaction.objectStore(storeName);
        const request = store.clear();

        request.onsuccess = () => {
            storesCleared++;
            if (storesCleared === STORE_NAMES.length) {
                // Reset local arrays
                db.exp = []; 
                db.rig = [];
                db.deb = []; 
                db.bal = { clientId: 1, amount: 0, changes: [] };
                currentBalance = 0;
                
                // Save the empty balance record (necessary for IndexedDB)
                saveData('bal', db.bal).then(() => {
                    loadAllData().then(() => {
                        // Reset all local storage settings except dark mode and currency
                        localStorage.removeItem('balanceHidden');
                        localStorage.removeItem('monthlyGoal');
                        monthlyExpenseGoal = 0;
                        balanceHidden = false;
                        
                        initAfterLoad();
                        toastMsg("ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!", 'success');
                    });
                });
            }
        };

        request.onerror = () => toastMsg("ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.", 'error');
    });
}

// ===================================================
// 11. ÙˆØ¸Ø§Ø¦Ù Ø¥Ø±ÙØ§Ù‚ Ø§Ù„ØµÙˆØ± (Camera/Gallery)
// Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ®Ø²ÙŠÙ† Ù…Ù„Ù Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„ÙØ¹Ù„ÙŠ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø±ÙÙ‚ØŒ Ù„Ø°Ø§ Ø³ÙŠØªÙ… ØªØ®Ø²ÙŠÙ† Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ÙÙ‚Ø·.
// ===================================================

function showImageSourceModal() {
    openLayer('imageSource');
}

function openCameraInput() {
    document.getElementById('eImgCamera').click();
    closeLayer('imageSource');
}

function openGalleryInput() {
    document.getElementById('eImgGallery').click();
    closeLayer('imageSource');
}

function updateFileName(input, displayId) {
    const displayElement = document.getElementById(displayId);
    if (input.files && input.files.length > 0) {
        displayElement.textContent = `ØªÙ… Ø¥Ø±ÙØ§Ù‚: ${input.files[0].name}`;
    } else {
        displayElement.textContent = '';
    }
}


</script>
</body>
</html>
