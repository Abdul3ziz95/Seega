<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ©</title>

<style>
/* ---------------------------------------------------- */
/* 1. Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø£Ø²Ø±Ù‚ Ù…Ø¨Ù‡Ø¬ ÙˆÙˆØ§Ø¶Ø­) */
/* ---------------------------------------------------- */
:root{
    --p: #0d6efd; /* Primary - Ø£Ø²Ø±Ù‚ ÙˆØ§Ø¶Ø­ ÙˆÙ…Ø´Ø±Ù‚ */
    --s: #28a745; /* Success - Ø£Ø®Ø¶Ø± Ø²Ø§Ù‡ÙŠ */
    --bg: #f4f6f8; /* Background - ÙØ§ØªØ­ Ø¬Ø¯Ø§Ù‹ */
    --danger: #dc3545; /* Danger - Ø£Ø­Ù…Ø± ÙˆØ§Ø¶Ø­ */
    --secondary-bg: #e9ecef; /* Ø®Ù„ÙÙŠØ© Ø«Ø§Ù†ÙˆÙŠØ© Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª/Ø§Ù„Ø­Ù‚ÙˆÙ„ */
    --border-color: #ced4da; /* Ù„ÙˆÙ† Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ */
}

body{
    margin:0;
    font-family: 'Tahoma', Arial, sans-serif;
    background:var(--bg);
    overflow-x: hidden;
    color: #333;
}

header{
    background:var(--p);
    color:#fff;
    padding:15px;
    text-align:center;
    font-size:22px;
    font-weight: bold;
    display:flex;
    justify-content:space-between;
    align-items:center;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); /* Ø¸Ù„ ÙˆØ§Ø¶Ø­ */
    position: sticky;
    top: 0;
    z-index: 10;
}

header .title {
    flex-grow: 1; 
    text-align: center;
}

header button {
    background: none; 
    border: none; 
    color: #fff; 
    font-size: 24px; 
    cursor: pointer; 
    padding: 0 10px;
    transition: opacity 0.2s;
}

header button:hover {
    opacity: 0.8;
}

/* ---------------------------------------------------- */
/* 2. ØªØµÙ…ÙŠÙ… Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª (Tabs) - Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¨ØµØ±ÙŠ */
/* ---------------------------------------------------- */
.tabs{
    display:flex;
    background:#fff;
    border-bottom: 1px solid var(--border-color); 
    box-shadow: 0 2px 4px rgba(0,0,0,.05);
    margin-bottom: 5px;
    padding-top: 5px; /* Ù…Ø³Ø§ÙØ© Ø¨Ø³ÙŠØ·Ø© Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ */
}

.tabs button{
    flex:1;
    padding:15px 10px;
    border:none;
    background:#fff;
    font-size: 15px;
    color: #555;
    font-weight: 600;
    transition: all 0.2s ease;
    border-bottom: 3px solid transparent;
}

.tabs button:hover {
    background: var(--secondary-bg);
    color: #333;
}

.tabs button.active{
    background: var(--secondary-bg);
    color:var(--p);
    border-bottom: 3px solid var(--p);
    box-shadow: 0 -2px 5px rgba(0,0,0,.05) inset;
}

.section{
    display:none;
    padding:15px;
}

.section.active{
    display:block
}

.card{
    background:#fff;
    padding:20px;
    border-radius:12px;
    box-shadow:0 3px 8px rgba(0,0,0,.1);
    margin-bottom:15px;
}

input, select{
    width:100%;
    padding:12px;
    margin:8px 0;
    font-size:16px;
    border-radius:8px;
    border:1px solid var(--border-color);
    box-sizing: border-box;
    background: #fff;
    color: #333;
    transition: border-color 0.2s, background 0.2s;
}

input:focus, select:focus {
    border-color: var(--p);
    background: var(--secondary-bg);
    outline: none;
}

.datetime-container {
    position: relative;
    width: 100%; 
    margin: 8px 0; 
}

.datetime-container input[type="datetime-local"] {
    margin: 0; 
    padding-left: 35px; 
    box-sizing: border-box;
}

.calendar-icon {
    position: absolute;
    top: 50%;
    left: 10px; 
    transform: translateY(-50%);
    font-size: 1.2em;
    z-index: 2;
    pointer-events: none; 
    color: var(--p); 
}

button.action{
    background:var(--s);
    color:#fff;
    border:none;
    padding:15px;
    width:100%;
    border-radius:8px;
    font-size:17px;
    font-weight: bold;
    margin-top: 10px;
    box-shadow: 0 4px 6px rgba(40, 167, 69, 0.3);
    transition: background 0.2s;
}

button.action:hover {
    background: #1e7e34;
}

button.secondary{
    background: var(--secondary-bg);
    padding:12px;
    width:100%;
    border:1px solid var(--border-color);
    border-radius:8px;
    margin-top:8px;
    color: #555;
    font-size: 15px;
    transition: background 0.2s;
}

button.secondary:hover {
    background: #d4d8db;
}

.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:12px 22px;border-radius:30px;display:none;z-index:100; box-shadow: 0 4px 12px rgba(0,0,0,.2)}
.toast.show{display:block}

.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;display:none;flex-direction:column;z-index:1000}
.modal header{
    display:flex;
    gap:6px;
    padding:15px;
    border-bottom:1px solid var(--border-color);
    align-items: center;
    justify-content: space-between;
    background: var(--p);
    color: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.modal header h3 { margin: 0; font-size: 18px; color: #fff; }
.modal header button { background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; }

.modal-content{padding:15px;overflow:auto;flex:1}
.list-item{
    background:#fff;
    padding:15px;
    border-radius:10px;
    margin-bottom:10px;
    cursor:pointer;
    border: 1px solid var(--border-color);
    box-shadow:0 1px 3px rgba(0,0,0,.05);
    transition: background 0.2s;
}

.list-item:hover {
    background: var(--secondary-bg);
}

.detail p{margin:8px 0; font-size: 16px;}
.detail p b { color: var(--p); }
.detail img{width:100%;max-width: 400px; height: auto; border-radius:10px;margin-top:15px;box-shadow: 0 2px 5px rgba(0,0,0,.15);}


.currency-symbol { 
    color: var(--s); 
    font-weight: bold;
    font-size: 1.1em;
    margin-right: 5px; 
}

/* ---------------------------------------------------- */
/* ÙƒÙˆØ¯ Ø§Ù„Ù€ CSS Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Sidebar) */
/* ---------------------------------------------------- */
.sidebar {
    position: fixed;
    top: 0;
    right: 0; 
    width: 280px; 
    max-width: 80%;
    height: 100%;
    background: #fff;
    box-shadow: -4px 0 15px rgba(0, 0, 0, 0.2);
    transform: translateX(100%); 
    transition: transform 0.3s ease-in-out;
    z-index: 2000; 
    display: flex;
    flex-direction: column;
}

.sidebar.open {
    transform: translateX(0); 
}

.sidebar-header {
    padding: 15px;
    background: var(--p);
    color: #fff;
    font-size: 18px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
}

.sidebar-content {
    flex-grow: 1;
    padding: 15px 0;
    overflow-y: auto;
}

.sidebar-menu-item {
    padding: 12px 15px;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    justify-content: space-between; 
    gap: 10px;
    font-size: 16px;
    color: #333;
    cursor: pointer;
    transition: background 0.2s;
    font-weight: 500;
}

.sidebar-menu-item:hover {
    background: var(--secondary-bg);
}

/* Ø·Ø¨Ù‚Ø© Ø§Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ø´ÙØ§ÙØ© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
.app-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.4);
    display: none;
    z-index: 1500;
}

.app-overlay.open {
    display: block;
}

/* ---------------------------------------------------- */
/* 3. ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¢Ù„Ø© Ø§Ù„Ø­Ø§Ø³Ø¨Ø© (Calculator Modal) */
/* ---------------------------------------------------- */
.calculator-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    padding: 20px 15px;
    background: #f4f6f8; /* Ø®Ù„ÙÙŠØ© Ø®ÙÙŠÙØ© Ù„Ù„Ø¢Ù„Ø© Ø§Ù„Ø­Ø§Ø³Ø¨Ø© */
    border-radius: 10px;
}

.calculator-output {
    grid-column: 1 / -1;
    background: #fff;
    color: #222;
    font-size: 2.5em;
    padding: 10px 15px;
    text-align: left;
    border-radius: 8px;
    margin-bottom: 10px;
    min-height: 50px;
    overflow-x: auto;
    white-space: nowrap;
    box-shadow: inset 0 1px 3px rgba(0,0,0,.1);
}

.calculator-output-secondary {
    font-size: 0.8em;
    color: #777;
    text-align: right;
}

.calculator-button {
    padding: 20px;
    font-size: 1.5em;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
    font-weight: bold;
}

.calculator-button.number {
    background: #fff;
    color: #333;
}

.calculator-button.operator {
    background: var(--p);
    color: white;
}

.calculator-button.equal {
    background: var(--s);
    color: white;
    grid-column: span 2;
}

.calculator-button.clear {
    background: var(--danger);
    color: white;
}

.calculator-button:active {
    filter: brightness(0.85);
}
/* ---------------------------------------------------- */

/* 4. ØªØµÙ…ÙŠÙ… Ø²Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
.image-upload-wrapper {
    position: relative;
    width: 100%;
}

#imageOptionsPopup {
    /* ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ù„ÙŠÙƒÙˆÙ† Ù…ØªÙ…Ø§Ø´ÙŠØ§Ù‹ Ù…Ø¹ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
    min-width: 180px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.2);
    transform-origin: top right;
    animation: fadeIn 0.15s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
}

#imageOptionsPopup button {
    font-weight: 500;
    color: #333;
    padding: 10px;
    border-radius: 6px;
    text-align: right;
}
/* ---------------------------------------------------- */
</style>
</head>

<body>

<header>
    <button onclick="toggleSidebar()">â˜°</button> 
    <span class="title">Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</span>
    <button onclick="openCalculator()">â—</button> 
</header>

<div class="tabs">
<button class="active" onclick="openTab('expenses')">ğŸ’¸ Ù…ØµØ±ÙˆÙØ§Øª</button>
<button onclick="openTab('rights')">ğŸ¤ Ø­Ù‚ÙˆÙ‚</button>
<button onclick="openTab('debts')">ğŸ“Œ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</button>
<button onclick="openTab('stats')">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
</div>

<div id="expenses" class="section active">
<div class="card">
<input id="eAmount" type="text" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº ğŸ’µ" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
<select id="eType">
<option value="">Ø§Ù„ÙØ¦Ø©</option>
<option>Ø·Ø¹Ø§Ù…</option><option>Ù…ÙˆØ§ØµÙ„Ø§Øª</option>
<option>Ø±Ø¹Ø§ÙŠØ© Ø´Ø®ØµÙŠØ©</option><option>Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
<option>ØµØ­Ø©</option><option>ØªØ±ÙÙŠÙ‡</option><option>ØªØ³ÙˆÙ‚</option>
<option>ØªØ¹Ù„ÙŠÙ…</option><option>ØµÙŠØ§Ù†Ø© ÙˆØ¥ØµÙ„Ø§Ø­</option><option>Ø£Ø®Ø±Ù‰</option>
</select>
<input id="eDesc" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
<div class="datetime-container">
    <input id="eDate" type="datetime-local">
    <span class="calendar-icon">ğŸ“…</span>
</div>

<div class="image-upload-wrapper">
    <button id="uploadButton" class="secondary" onclick="showImageOptions(event)" style="margin-top: 10px; width: 100%; color: var(--p); border: 1px dashed var(--p); background: #fff;">
        ğŸ“· Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©
    </button>

    <div id="imageOptionsPopup" style="display:none; position:absolute; z-index: 1001; background: #fff; border: 1px solid var(--border-color); border-radius: 8px; width: 200px;">
        <div style="padding: 10px; text-align: right; color: var(--p); font-weight: bold; border-bottom: 1px solid var(--secondary-bg);">Ø§Ø®ØªØ± Ø§Ù„Ù…ØµØ¯Ø±:</div>
        <button onclick="document.getElementById('eImgCamera').click(); hideImageOptions();" class="secondary" style="margin: 5px; width: calc(100% - 10px); background: #fff; border: none; text-align: right;">ğŸ“¸ ÙƒØ§Ù…ÙŠØ±Ø§</button>
        <button onclick="document.getElementById('eImgGallery').click(); hideImageOptions();" class="secondary" style="margin: 5px; width: calc(100% - 10px); background: #fff; border: none; text-align: right;">ğŸ–¼ï¸ Ù…Ø¹Ø±Ø¶</button>
    </div>
    
    <input id="eImgCamera" type="file" accept="image/*" capture="camera" style="display: none;">
    <input id="eImgGallery" type="file" accept="image/*" style="display: none;">
</div>
<span id="imageStatus" style="font-size: 0.9em; color: var(--p); display: block; margin-top: 5px; margin-bottom: 5px;">Ù„Ù… ÙŠØªÙ… Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø©</span>

<button class="action" onclick="addExpense()">Ø­ÙØ¸</button>
<button class="secondary" onclick="openLog('exp')">ğŸ“‚ Ø§Ù„Ø³Ø¬Ù„</button>
</div>
</div>

<div id="rights" class="section">
<div class="card">
<select id="rType" onchange="updateRightFields(this.value)">
<option value="">Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚</option>
<option>Ø¯ÙŠÙ†</option>
<option>Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„</option>
<option>Ø£Ø®Ø±Ù‰</option>
</select>
<input id="rAmount" type="text" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ ğŸ’µ" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
<div id="rDynamicFields"></div>
<input id="rDesc" placeholder="ÙˆØµÙ / Ø§Ù„Ù…Ø¯ÙŠÙ†">
<div class="datetime-container">
    <input id="rDate" type="datetime-local">
    <span class="calendar-icon">ğŸ“…</span>
</div>
<select id="rStatus">
<option value="">Ø§Ù„Ø­Ø§Ù„Ø©</option>
<option>Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</option>
<option>ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ Ø¨Ø¹Ø¯</option>
</select>
<button class="action" onclick="addRight()">Ø­ÙØ¸</button>
<button class="secondary" onclick="openLog('rig')">ğŸ“‚ Ø§Ù„Ø³Ø¬Ù„</button>
</div>
</div>

<div id="debts" class="section">
<div class="card">
<select id="dType" onchange="updateDebtFields(this.value)">
<option value="">Ù†ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</option>
<option>Ø¥ÙŠØ¬Ø§Ø±</option>
<option>ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
<option>Ù…Ø§Ø¡</option>
<option>Ø¥Ù†ØªØ±Ù†Øª</option>
<option>Ù‚Ø±Ø¶</option> <option>Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ</option> <option>Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø© Ø£Ø®Ø±Ù‰</option>
<option>Ø£Ø®Ø±Ù‰</option>
</select>
<input id="dAmount" type="text" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©/Ø§Ù„Ù‚Ø³Ø· ğŸ’µ" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">

<div id="dDynamicFields"></div>
<input id="dDesc" placeholder="ÙˆØµÙ / Ø§Ù„Ø¯Ø§Ø¦Ù†">
<div class="datetime-container">
    <input id="dDate" type="datetime-local">
    <span class="calendar-icon">ğŸ“…</span>
</div>
<select id="dStatus">
<option value="">Ø§Ù„Ø­Ø§Ù„Ø©</option>
<option>Ù…Ø¯ÙÙˆØ¹</option>
<option>ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
</select>
<button class="action" onclick="addDebt()">Ø­ÙØ¸</button>
<button class="secondary" onclick="openLog('deb')">ğŸ“‚ Ø§Ù„Ø³Ø¬Ù„</button>
</div>
</div>

<div id="stats" class="section">
<div class="card">
<h3>ğŸ’¸ Ù…ØµØ±ÙˆÙØ§Øª + Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ù…Ø¯ÙÙˆØ¹Ø©</h3>
<p>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: <b id="sExpTotal">0</b></p>
<p>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: <b id="sExpCount">0</b></p>
<p>Ø£Ø¹Ù„Ù‰ ÙØ¦Ø©: <b id="sTopCat">â€”</b></p>
</div>
<div class="card">
<h3>ğŸ¤ Ø§Ù„Ø­Ù‚ÙˆÙ‚</h3>
<p>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚: <b id="sRigTotal">0</b></p>
<p>Ø§Ù„Ù…Ø­ØµÙ„: <b id="sRigPaid">0</b></p>
<p>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ØªØ­ØµÙŠÙ„Ù‡: <b id="sRigUnpaid">0</b></p>
</div>
<div class="card">
<h3>ğŸ“Œ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©</h3>
<p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©: <b id="sDebTotal">0</b></p>
<p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†: <b id="sDebPaid">0</b></p>
<p>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ù‚Ø±ÙˆØ¶/Ø§Ù„Ø¯ÙŠÙˆÙ†/Ø§Ù„ÙÙˆØ§ØªÙŠØ±: <b id="sDebUnpaid">0</b></p>
</div>
</div>

<div class="modal" id="logModal">
<header>
<input id="search" placeholder="ğŸ” Ø¨Ø­Ø«" oninput="renderLog()" style="flex-grow: 1; margin: 0; padding: 10px; border-radius: 6px; border: none; background: #fff; color: #333;">
<button onclick="closeLog()">Ø¥ØºÙ„Ø§Ù‚</button>
</header>
<div class="modal-content" id="logContent"></div>
</div>

<div class="modal" id="detailModal">
<header>
<button onclick="closeDetailAndClearEditMode()">Ø¥ØºÙ„Ø§Ù‚</button>
</header>
<div class="modal-content detail" id="detailContent"></div>
</div>

<div class="toast" id="toast"></div>

<div class="app-overlay" id="appOverlay" onclick="handleOverlayClick(event)"></div>

<div class="sidebar" id="appSidebar">
    <div class="sidebar-header">
        <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        <button onclick="toggleSidebar()">âœ–</button>
    </div>
    <div class="sidebar-content">
        <div class="card" style="margin: 0 15px 15px;">
             <p style="font-weight: bold; margin-top: 0; color: var(--p);">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</p>
             <button class="secondary" onclick="openCurrencyModal()" style="display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border-color);">
                 <span id="currentCurrencyDisplay">Ø§Ù„Ø¹Ù…Ù„Ø©: Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ (Ø±.Ø³)</span>
                 <span style="font-weight: bold; color: var(--p);">ØªØºÙŠÙŠØ±</span>
             </button>
        </div>
        
        <div class="sidebar-menu-item" onclick="exportData()">
            ğŸ“ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)
        </div>
        
        <div class="sidebar-menu-item" onclick="document.getElementById('importFile').click()">
            ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)
        </div>
        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
        
        <div class="sidebar-menu-item" onclick="openAboutModal()">
            ğŸ’¡ Ø­ÙˆÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        </div>
        
        <div class="sidebar-menu-item" onclick="confirmResetData()" style="color: var(--danger);">
            âš ï¸ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        </div>
    </div>
</div>

<div class="modal" id="aboutModal">
    <header>
        <h3>Ø­ÙˆÙ„ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ©</h3>
        <button onclick="document.getElementById('aboutModal').style.display='none'">âœ–</button>
    </header>
    <div class="modal-content">
        <p>ØªØ·Ø¨ÙŠÙ‚ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© Ù‡Ùˆ Ø£Ø¯Ø§Ø© Ø¨Ø³ÙŠØ·Ø© Ù„ØªØªØ¨Ø¹:</p>
        <ul>
            <li>ğŸ’¸ **Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø©** Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.</li>
            <li>ğŸ¤ **Ø§Ù„Ø­Ù‚ÙˆÙ‚** Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ù„Ùƒ.</li>
            <li>ğŸ“Œ **Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª** Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ø¹Ù„ÙŠÙƒ.</li>
        </ul>
        <p><strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ÙŠØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ (IndexedDB). Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.</p>
        <p style="text-align: center; margin-top: 20px; color: #777; font-size: 0.9em;">Ø§Ù„Ø¥ØµØ¯Ø§Ø± 1.1.0 (Ù…Ø¹ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ØªØµÙ…ÙŠÙ…)</p>
    </div>
</div>

<div class="modal" id="currencyModal">
    <header>
        <h3>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø©</h3>
        <button onclick="document.getElementById('currencyModal').style.display='none'">âœ–</button>
    </header>
    <div class="modal-content">
        <input id="currencySearch" type="text" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„Ø©" oninput="renderCurrencyList()">
        <div id="currencyList">
            </div>
    </div>
</div>

<div class="modal" id="calculatorModal" style="max-width: 400px; margin: auto; height: auto; top: 50%; transform: translateY(-50%); position: absolute; left: 0; right: 0; border-radius: 12px; overflow: hidden; display: none;">
    <header>
        <h3>Ø§Ù„Ø¢Ù„Ø© Ø§Ù„Ø­Ø§Ø³Ø¨Ø©</h3>
        <button onclick="closeCalculator()">âœ–</button>
    </header>
    <div class="modal-content" style="padding: 0;">
        <div class="calculator-output" style="margin: 10px 10px 0 10px;">
            <div id="calcSecondaryOutput" class="calculator-output-secondary">0</div>
            <div id="calcMainOutput">0</div>
        </div>
        
        <div class="calculator-grid">
            <button class="calculator-button clear" onclick="calculatorClear()">C</button>
            <button class="calculator-button operator" onclick="calculatorDelete()">DEL</button>
            <button class="calculator-button operator" onclick="calculatorInput('/')">Ã·</button>
            <button class="calculator-button operator" onclick="calculatorInput('*')">Ã—</button>
            
            <button class="calculator-button number" onclick="calculatorInput('7')">7</button>
            <button class="calculator-button number" onclick="calculatorInput('8')">8</button>
            <button class="calculator-button number" onclick="calculatorInput('9')">9</button>
            <button class="calculator-button operator" onclick="calculatorInput('-')">â€”</button>

            <button class="calculator-button number" onclick="calculatorInput('4')">4</button>
            <button class="calculator-button number" onclick="calculatorInput('5')">5</button>
            <button class="calculator-button number" onclick="calculatorInput('6')">6</button>
            <button class="calculator-button operator" onclick="calculatorInput('+')">+</button>

            <button class="calculator-button number" onclick="calculatorInput('1')">1</button>
            <button class="calculator-button number" onclick="calculatorInput('2')">2</button>
            <button class="calculator-button number" onclick="calculatorInput('3')">3</button>
            <button class="calculator-button number" onclick="calculatorInput('0')">0</button>
            
            <button class="calculator-button number" onclick="calculatorInput('.')">.</button>
            <button class="calculator-button equal" onclick="calculatorCompute()">=</button>
        </div>
    </div>
</div>


<script>
// ===================================================
// 1. Ø¥Ø¹Ø¯Ø§Ø¯ IndexedDB ÙˆÙ…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
// ===================================================

const IDB_NAME = "MySmartBudgetDB";
const IDB_VERSION = 2; 
const STORE_NAMES = ["exp", "rig", "deb"];
let db = { exp: [], rig: [], deb: [] };
let IDB_connection = null; 

let currentLog = "", editMode = null;
let currentExpenseFile = null; // **Ù…ØªØºÙŠØ± Ø¬Ø¯ÙŠØ¯ Ù„ØªØªØ¨Ø¹ Ù…Ù„Ù Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±**

// Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
const ARABIC_CURRENCIES = [
    { code: 'SAR', symbol: 'Ø±.Ø³', name: 'Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ' },
    { code: 'EGP', symbol: 'Ø¬.Ù…', name: 'Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ' },
    { code: 'AED', symbol: 'Ø¯.Ø¥', name: 'Ø¯Ø±Ù‡Ù… Ø¥Ù…Ø§Ø±Ø§ØªÙŠ' },
    { code: 'KWD', symbol: 'Ø¯.Ùƒ', name: 'Ø¯ÙŠÙ†Ø§Ø± ÙƒÙˆÙŠØªÙŠ' },
    { code: 'BHD', symbol: 'Ø¯.Ø¨', name: 'Ø¯ÙŠÙ†Ø§Ø± Ø¨Ø­Ø±ÙŠÙ†ÙŠ' },
    { code: 'QAR', symbol: 'Ø±.Ù‚', name: 'Ø±ÙŠØ§Ù„ Ù‚Ø·Ø±ÙŠ' },
    { code: 'OMR', symbol: 'Ø±.Ø¹.', name: 'Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ' },
    { code: 'JOD', symbol: 'Ø¯.Ø§', name: 'Ø¯ÙŠÙ†Ø§Ø± Ø£Ø±Ø¯Ù†ÙŠ' },
    { code: 'LBP', symbol: 'Ù„.Ù„', name: 'Ù„ÙŠØ±Ø© Ù„Ø¨Ù†Ø§Ù†ÙŠØ©' },
    { code: 'SYP', symbol: 'Ù„.Ø³', name: 'Ù„ÙŠØ±Ø© Ø³ÙˆØ±ÙŠØ©' },
    { code: 'SDG', symbol: 'Ø¬.Ø³.', name: 'Ø¬Ù†ÙŠÙ‡ Ø³ÙˆØ¯Ø§Ù†ÙŠ' },
    { code: 'DZD', symbol: 'Ø¯.Ø¬', name: 'Ø¯ÙŠÙ†Ø§Ø± Ø¬Ø²Ø§Ø¦Ø±ÙŠ' },
    { code: 'TND', symbol: 'Ø¯.Øª', name: 'Ø¯ÙŠÙ†Ø§Ø± ØªÙˆÙ†Ø³ÙŠ' },
    { code: 'MAD', symbol: 'Ø¯.Ù….', name: 'Ø¯Ø±Ù‡Ù… Ù…ØºØ±Ø¨ÙŠ' },
    { code: 'LYD', symbol: 'Ù„.Ø¯', name: 'Ø¯ÙŠÙ†Ø§Ø± Ù„ÙŠØ¨ÙŠ' },
    { code: 'YER', symbol: 'Ø±.ÙŠ', name: 'Ø±ÙŠØ§Ù„ ÙŠÙ…Ù†ÙŠ' },
    { code: 'IQD', symbol: 'Ø¹.Ø¯', name: 'Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ' },
    { code: 'USD', symbol: '$', name: 'Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ' }
];

let currentCurrency = ARABIC_CURRENCIES.find(c => c.code === 'SAR'); 

function loadCurrencyPreference() {
    const savedCode = localStorage.getItem('selectedCurrencyCode');
    if (savedCode) {
        const found = ARABIC_CURRENCIES.find(c => c.code === savedCode);
        if (found) {
            currentCurrency = found;
        }
    }
    updateCurrencyDisplay();
}

function saveCurrencyPreference(code) {
    localStorage.setItem('selectedCurrencyCode', code);
}

function updateCurrencyDisplay() {
    const displayElement = document.getElementById('currentCurrencyDisplay');
    if (displayElement) {
        displayElement.textContent = `Ø§Ù„Ø¹Ù…Ù„Ø©: ${currentCurrency.name} (${currentCurrency.symbol})`;
    }
    updateStats(); 
    if (document.getElementById("logModal").style.display === "flex") renderLog();
}


loadCurrencyPreference(); 

// ===================================================
// 2. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆØ§Ù„Ù…Ù„Ø§Ø­ÙŠØ©
// ===================================================

document.addEventListener('DOMContentLoaded', () => {
    const eImgCamera = document.getElementById('eImgCamera');
    const eImgGallery = document.getElementById('eImgGallery');
    const imageStatus = document.getElementById('imageStatus');
    
    // **Ù…Ù†Ø·Ù‚ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±**
    const handleFileChange = (e) => {
        const file = e.target.files[0];
        
        if (file) {
            currentExpenseFile = file;
            imageStatus.textContent = `âœ… ØµÙˆØ±Ø© Ù…Ø±ÙÙ‚Ø©: ${file.name}`;
            imageStatus.style.color = 'var(--s)';
        } else {
            // ÙÙŠ Ø­Ø§Ù„Ø© Ø¥Ù„ØºØ§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù (ÙƒØ§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¥Ù„ØºØ§Ø¡ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù)
            // Ù†Ø­ØªØ§Ø¬ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù†Ø§ Ù„Ø§ Ù†Ù…Ø³Ø­ ØµÙˆØ±Ø© ÙƒØ§Ù†Øª Ù…Ø±ÙÙ‚Ø© Ù…Ù† Ù…ØµØ¯Ø± Ø¢Ø®Ø±
            if (currentExpenseFile && currentExpenseFile.name !== "ØµÙˆØ±Ø© Ø³Ø§Ø¨Ù‚Ø©") { 
                 currentExpenseFile = null;
                 imageStatus.textContent = 'Ù„Ù… ÙŠØªÙ… Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø©';
                 imageStatus.style.color = 'var(--p)';
            }
        }
    };

    if (eImgCamera) eImgCamera.addEventListener('change', handleFileChange);
    if (eImgGallery) eImgGallery.addEventListener('change', handleFileChange);
    
    // **ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù†Ø¯ ÙØªØ­ ØªØ¨ÙˆÙŠØ¨Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª**
    document.querySelector('.tabs button[onclick="openTab(\'expenses\')"]').addEventListener('click', () => {
        if (!editMode || editMode.type !== 'exp') {
             // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ø°Ø§ Ù„Ù… Ù†ÙƒÙ† ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
             currentExpenseFile = null;
             imageStatus.textContent = 'Ù„Ù… ÙŠØªÙ… Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø©';
             imageStatus.style.color = 'var(--p)';
        }
    });
    
    // Ø¥ØºÙ„Ø§Ù‚ Ù…Ø±Ø¨Ø¹ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
    document.addEventListener('click', (e) => {
        const popup = document.getElementById('imageOptionsPopup');
        const button = document.getElementById('uploadButton');
        if (popup.style.display === 'block' && !popup.contains(e.target) && e.target !== button) {
             hideImageOptions();
        }
    });
});

// **ÙˆØ¸Ø§Ø¦Ù Ù…Ø±Ø¨Ø¹ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØµÙˆØ±Ø©**
function showImageOptions(event) {
    event.stopPropagation();
    const popup = document.getElementById('imageOptionsPopup');
    const button = document.getElementById('uploadButton');
    
    // Positioning logic
    const rect = button.getBoundingClientRect();
    popup.style.top = `${rect.bottom + 5}px`;
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„ÙŠÙƒÙˆÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠÙ…Ù† Ù…Ù† Ø§Ù„Ø²Ø±
    popup.style.right = `${window.innerWidth - rect.right}px`; 
    
    popup.style.display = 'block';
}

function hideImageOptions() {
    document.getElementById('imageOptionsPopup').style.display = 'none';
}


function formatAmount(input) {
  let value = input.value.replace(/[^\d.]/g, ''); 
  const parts = value.split('.');
  
  if (parts.length > 2) {
    value = parts[0] + '.' + parts.slice(1).join('');
  }
  
  const integerPart = parts[0];
  const decimalPart = parts[1] ? '.' + parts[1] : '';
  
  // Ø¥Ø²Ø§Ù„Ø© ÙÙˆØ§ØµÙ„ Ø§Ù„Ø¢Ù„Ø§Ù Ù…Ù† Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„ØµØ­ÙŠØ­ Ù‚Ø¨Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø±Ù‚Ù…
  const number = parseFloat(integerPart.replace(/,/g, '')); 
  
  // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ†Ø³ÙŠÙ‚ Ø±Ù‚Ù… Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„ØµØ­ÙŠØ­ Ø¨ÙØ§ØµÙ„ Ø§Ù„Ø¢Ù„Ø§Ù Ø§Ù„Ø¹Ø±Ø¨ÙŠ
  let formattedIntegerPart = isNaN(number) ? '' : number.toLocaleString('ar');
  
  // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù†Ù‚Ø·Ø© Ø§Ù„ÙØ§ØµÙ„ Ø§Ù„Ø¹Ø´Ø±ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
  if (input.value.endsWith('.') && !decimalPart) {
      formattedIntegerPart += '.';
  }

  input.value = formattedIntegerPart + decimalPart;
}

function parseAmount(amount) {
  // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ ÙÙˆØ§ØµÙ„ Ø®Ø§ØµØ© Ø¨Ø§Ù„ØµÙŠØºØ© (Ù…Ø«Ù„ Ø§Ù„Ø¢Ù„Ø§Ù) ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© ÙƒØ±Ù‚Ù…
  return parseFloat(String(amount).replace(/[^0-9.]/g, '')) || 0;
}

function formatCurrency(amount) {
    const num = parseAmount(amount);
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… ØµÙØ±Ø§Ù‹ Ø£Ùˆ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­ÙˆÙŠÙ„Ù‡ØŒ Ù†Ø¹Ø±Ø¶ ØµÙØ±Ø§Ù‹ Ù…Ù†Ø³Ù‚Ø§Ù‹
    if (isNaN(num) || num === 0) {
        return `0 <span class="currency-symbol">${currentCurrency.symbol}</span>`;
    }

    const formattedNum = num.toLocaleString('ar', { 
        minimumFractionDigits: num % 1 === 0 ? 0 : 2,
        maximumFractionDigits: 2 
    });
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ø®ØªØ§Ø± Ù…Ù† currentCurrency
    return `${formattedNum} <span class="currency-symbol">${currentCurrency.symbol}</span>`;
}


function formatDateTime(dateString) {
    if (!dateString) return 'â€”';
    const date = new Date(dateString);
    if (isNaN(date)) return 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ§Ù„Ø­';
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… 'ar-EG' Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù…Ø¹ Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø§Ù„ØµØ¨Ø§Ø­ÙŠ/Ø§Ù„Ù…Ø³Ø§Ø¦ÙŠ
    return date.toLocaleString('ar-EG', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true 
    });
}

function toastMsg(m) {
  const toast = document.getElementById("toast");
  toast.textContent = m;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 2500);
}


function clearFields(keepExpenseImage = false) {
  // Expense fields
  eAmount.value = eDesc.value = eType.value = eDate.value = "";
  
  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚ÙˆÙ„ Ø§Ù„ØµÙˆØ±Ø©
  const eImgCamera = document.getElementById('eImgCamera');
  const eImgGallery = document.getElementById('eImgGallery');
  const imageStatus = document.getElementById('imageStatus');
  
  if (eImgCamera) eImgCamera.value = null; 
  if (eImgGallery) eImgGallery.value = null; 
  
  if (imageStatus) {
      if (!keepExpenseImage) {
          currentExpenseFile = null; 
          imageStatus.textContent = 'Ù„Ù… ÙŠØªÙ… Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø©';
          imageStatus.style.color = 'var(--p)';
      }
  }


  // Rights fields
  rAmount.value = rDesc.value = rDate.value = rType.value = rStatus.value = "";
  document.getElementById('rDynamicFields').innerHTML = '';
  document.getElementById('rAmount').oninput = function() { formatAmount(this); };
  document.getElementById('rAmount').placeholder = "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ ğŸ’µ";
  rStatus.style.display = 'block'; // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©


  // Debts fields
  dType.value = dAmount.value = dDesc.value = dDate.value = dStatus.value = "";
  document.getElementById('dDynamicFields').innerHTML = '';
  
  // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
  document.getElementById('dAmount').style.display = 'block'; 
  document.getElementById('dAmount').placeholder = "Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©/Ø§Ù„Ù‚Ø³Ø· ğŸ’µ";
  document.getElementById('dStatus').style.display = 'block'; 
}

// **ÙˆØ¸Ø§Ø¦Ù ØªØ®ØµÙŠØµ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©**

function calculateRightRemaining() {
    const totalInput = document.getElementById('rAmount');
    const paidInput = document.getElementById('rPaidAmount');
    const remainingDisplay = document.getElementById('rRemainingDisplay');

    if (!totalInput || !paidInput || !remainingDisplay) return;

    const total = parseAmount(totalInput.value);
    const paid = parseAmount(paidInput.value);

    const remaining = total - paid;
    
    if (remaining < 0) {
        remainingDisplay.textContent = `Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: Ø®Ø·Ø£! Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„ÙƒÙ„ÙŠ`;
        remainingDisplay.style.color = 'red';
        return;
    }
    
    remainingDisplay.style.color = 'var(--danger)'; 
    remainingDisplay.innerHTML = `Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${formatCurrency(remaining.toFixed(2))}`;
}

function updateRightFields(type) {
    const dynamicContainer = document.getElementById('rDynamicFields');
    dynamicContainer.innerHTML = '';
    
    const rStatusSelect = document.getElementById('rStatus'); 
    
    const rAmountInput = document.getElementById('rAmount');
    rAmountInput.placeholder = "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ ğŸ’µ";
    rAmountInput.oninput = function() { formatAmount(this); };

    if (type === 'Ø¯ÙŠÙ†') {
        rStatusSelect.style.display = 'none'; 
        // ØªÙ… ØªØ¹Ø¯ÙŠÙ„ placeholder:
        rAmountInput.placeholder = "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø¯ÙŠÙ† ğŸ’µ";
        rAmountInput.oninput = function() { formatAmount(this); calculateRightRemaining(); };

        dynamicContainer.innerHTML = `
            <div class="datetime-container">
                <input id="rExpectedDate" type="datetime-local">
                <span class="calendar-icon">ğŸ—“ï¸</span>
            </div>
            <label for="rExpectedDate" style="display:block; font-size: 0.9em; color: #555; text-align: right; margin-top: -10px;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</label>
            
            <input id="rPaidAmount" type="text" placeholder="Ø§Ù„Ù…Ø­ØµÙ„ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†" oninput="calculateRightRemaining(); formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
            <p id="rRemainingDisplay" style="margin: 0; padding: 10px 0; font-size: 0.9em; color: var(--danger); font-weight: bold;">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: â€”</p>
        `;
        
        // Ø±Ø¨Ø· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ ÙˆØ§Ù„Ø­Ø³Ø§Ø¨
        document.getElementById('rPaidAmount').addEventListener('input', calculateRightRemaining);
        
    } else if (type === 'Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„') {
        rStatusSelect.style.display = 'block';
        // ØªÙ… ØªØ¹Ø¯ÙŠÙ„ placeholder:
        rAmountInput.placeholder = "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø¢Ø¬Ù„ ğŸ’µ";

        dynamicContainer.innerHTML = `
            <div class="datetime-container">
                <input id="rExpectedDate" type="datetime-local">
                <span class="calendar-icon">ğŸ—“ï¸</span>
            </div>
            <label for="rExpectedDate" style="display:block; font-size: 0.9em; color: #555; text-align: right; margin-top: -10px;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        `;
    } else {
        rStatusSelect.style.display = 'block';
    }
}

function calculateInstallmentValue() {
    const totalInput = document.getElementById('dTotalAmount');
    const installmentsInput = document.getElementById('dInstallments');
    const valueDisplay = document.getElementById('dInstallmentValue');

    if (!totalInput || !installmentsInput || !valueDisplay) return;

    const total = parseAmount(totalInput.value);
    const installments = parseInt(installmentsInput.value) || 0;

    if (total > 0 && installments > 0) {
        const value = total / installments;
        valueDisplay.innerHTML = `Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø·: ${formatCurrency(value.toFixed(2))}`;
    } else {
        valueDisplay.textContent = 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø·: â€”';
    }
}

function updateDebtFields(type) {
    const dynamicContainer = document.getElementById('dDynamicFields');
    dynamicContainer.innerHTML = '';
    
    const dAmountInput = document.getElementById('dAmount');
    const dStatusSelect = document.getElementById('dStatus'); 
    // ØªÙ… ØªØ¹Ø¯ÙŠÙ„ placeholder:
    dAmountInput.placeholder = "Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©/Ø§Ù„Ù‚Ø³Ø· ğŸ’µ";


    if (type === 'Ù‚Ø±Ø¶') {
        dAmountInput.style.display = 'none'; 
        dStatusSelect.style.display = 'none'; 

        dynamicContainer.innerHTML = `
            <input id="dTotalAmount" type="text" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ù‚Ø±Ø¶ ğŸ’µ" oninput="calculateInstallmentValue(); formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
            <input id="dInstallments" type="number" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„ÙƒÙ„ÙŠ" min="1" oninput="calculateInstallmentValue()">
            <p id="dInstallmentValue" style="margin: 0; padding: 10px 0; font-size: 0.9em; color: var(--p); font-weight: bold;">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø·: â€”</p>
            <input id="dPaidInstallments" type="number" placeholder="Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†" min="0">
        `;
        // Ø±Ø¨Ø· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ ÙˆØ§Ù„Ø­Ø³Ø§Ø¨
        document.getElementById('dTotalAmount').addEventListener('input', calculateInstallmentValue);
        
    } else if (type === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ') {
        dAmountInput.style.display = 'none'; 
        dStatusSelect.style.display = 'none'; 

        dynamicContainer.innerHTML = `
            <input id="dTotalAmount" type="text" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø¯ÙŠÙ† ğŸ’µ" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
            <input id="dPaidInstallments" type="text" placeholder="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù†Ù‚Ø¯Ø§Ù‹ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
        `;
        
    } else {
        // Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© (ÙÙˆØ§ØªÙŠØ±ØŒ Ø¥ÙŠØ¬Ø§Ø±ØŒ Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø© Ø£Ø®Ø±Ù‰)
        dAmountInput.style.display = 'block';
        dStatusSelect.style.display = 'block'; 
    }
}

function openTab(id, keepEditMode = false) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
  document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  
  const button = event && event.currentTarget || document.querySelector(`.tabs button[onclick="openTab('${id}')"]`);
  if(button) button.classList.add("active");
  
  if (!keepEditMode) { 
      editMode = null; 
      clearFields(); 
  }
  
  if (document.getElementById('search')) {
      document.getElementById('search').value = "";
  }
}

function closeDetailAndClearEditMode() {
  const detailModal = document.getElementById("detailModal");
  detailModal.style.display = "none";
  editMode = null; 
}


// **ÙˆØ¸Ø§Ø¦Ù IndexedDB**
function initDB() {
  return new Promise((resolve, reject) => {
    if (!window.indexedDB) {
        toastMsg("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… IndexedDB.");
        return reject(new Error("IndexedDB not supported."));
    }

    const request = indexedDB.open(IDB_NAME, IDB_VERSION);

    request.onerror = (e) => {
      console.error("IndexedDB error:", e.target.error);
      reject(e.target.error);
    };

    request.onsuccess = (e) => {
      IDB_connection = e.target.result;
      console.log("IndexedDB opened successfully.");
      resolve(IDB_connection);
      loadAllData().then(updateStats);
    };

    request.onupgradeneeded = (e) => {
      IDB_connection = e.target.result;
      STORE_NAMES.forEach(storeName => {
        if (!IDB_connection.objectStoreNames.contains(storeName)) {
          // ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ØªØ§Ø¬Ø± exp, rig, deb ÙÙ‚Ø·
          IDB_connection.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
        }
      });
      console.log("Database upgrade complete.");
    };
  });
}

initDB();

function saveData(storeName, data) {
  return new Promise((resolve, reject) => {
    if (!IDB_connection) return reject(new Error("Database not connected."));

    const transaction = IDB_connection.transaction([storeName], "readwrite");
    const store = transaction.objectStore(storeName);
    const request = store.put(data); 

    request.onsuccess = () => resolve(request.result);
    request.onerror = (e) => reject(e.target.error);
  });
}

function deleteFromDB(storeName, id) {
  return new Promise((resolve, reject) => {
    if (!IDB_connection) return reject(new Error("Database not connected."));

    const transaction = IDB_connection.transaction([storeName], "readwrite");
    const store = transaction.objectStore(storeName);
    const request = store.delete(id); 

    request.onsuccess = () => resolve();
    request.onerror = (e) => reject(e.target.error);
  });
}

function loadStoreData(storeName) {
  return new Promise((resolve) => {
    if (!IDB_connection) return resolve([]); 
    
    const transaction = IDB_connection.transaction([storeName], "readonly");
    const store = transaction.objectStore(storeName);
    const request = store.getAll();

    request.onsuccess = (e) => resolve(e.target.result.reverse());
    request.onerror = () => resolve([]);
  });
}

async function loadAllData() {
    const [expData, rigData, debData] = await Promise.all([
        loadStoreData('exp'),
        loadStoreData('rig'),
        loadStoreData('deb'),
    ]);
    db.exp = expData;
    db.rig = rigData;
    db.deb = debData;

    const logModal = document.getElementById("logModal");
    if (logModal.style.display === "flex") renderLog();
}

function postSaveCleanup(isEditing, type) {
    editMode = null; 
    clearFields();
    currentExpenseFile = null; // **Ù…Ø³Ø­ Ù…Ø±Ø¬Ø¹ Ø§Ù„Ù…Ù„Ù Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸**
    updateStats();
    
    document.getElementById("detailModal").style.display = "none";
    
    if (isEditing) {
        // Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ù†Ø¹ÙŠØ¯ ÙØªØ­ Ø§Ù„Ø³Ø¬Ù„ Ù„Ù„Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø¯Ù„
        openLog(type); 
    } else {
        // Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ©ØŒ Ù†Ø¹ÙŠØ¯ Ø¥Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        openTab(type === 'exp' ? 'expenses' : type === 'rig' ? 'rights' : 'debts', false);
    }
}


// ===================================================
// 3. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù (CRUD)
// ===================================================

async function addExpense() { 
  if (!eAmount.value || !eType.value || !eDate.value) return toastMsg("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©");
  
  // **Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù„Ù**
  const fileToSave = currentExpenseFile;
  
  const isEditing = editMode && editMode.type === "exp";
  const oldData = isEditing ? db.exp[editMode.index] : {}; 
  
  const data = isEditing ? { ...oldData } : {}; 

  data.Ø§Ù„Ù…Ø¨Ù„Øº = eAmount.value; 
  data.Ø§Ù„ÙØ¦Ø© = eType.value; 
  data.Ø§Ù„ÙˆØµÙ = eDesc.value; 
  data.Ø§Ù„ØªØ§Ø±ÙŠØ® = eDate.value; 
  
  if (isEditing) {
      data.id = oldData.id; 
      // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ØŒ Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
      if (!fileToSave || fileToSave.name === "ØµÙˆØ±Ø© Ø³Ø§Ø¨Ù‚Ø©") { 
          data.ØµÙˆØ±Ø© = oldData.ØµÙˆØ±Ø© || null;
      } else {
           // Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø¨Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø§Ù„Ù€ onload
           data.ØµÙˆØ±Ø© = null; 
      }
  } else {
      data.ØµÙˆØ±Ø© = null; 
  }
  
  const done = async () => {
    try {
        await saveData('exp', data); 
        toastMsg(isEditing ? "ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ" : "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ");
        
        await loadAllData(); 
        postSaveCleanup(isEditing, 'exp'); 

    } catch (error) {
        toastMsg("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸. ØªØ­Ù‚Ù‚ Ù…Ù† Console.");
        console.error(error);
    }
  };

  // Ø¥Ø°Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ (ÙˆÙ„ÙŠØ³ ØµÙˆØ±Ø© Ø³Ø§Ø¨Ù‚Ø© ÙˆÙ‡Ù…ÙŠØ©)ØŒ Ù‚Ù… Ø¨ØªØ­ÙˆÙŠÙ„Ù‡
  if (fileToSave && fileToSave.name !== "ØµÙˆØ±Ø© Ø³Ø§Ø¨Ù‚Ø©") {
    const r = new FileReader();
    r.onload = () => { 
        data.ØµÙˆØ±Ø© = r.result; // DataURL Ù„Ù„ØµÙˆØ±Ø©
        done(); 
    };
    r.readAsDataURL(fileToSave);
  } else {
      // Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­ÙØ¸ Ù…Ø¨Ø§Ø´Ø±Ø©
      done(); 
  }
}

async function addRight() {
  // ØªÙ… Ø§Ø®ØªØµØ§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø©
  if (!rAmount.value || !rType.value || !rDate.value) return toastMsg("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  
  const isEditing = editMode && editMode.type === "rig";
  const oldData = isEditing ? db.rig[editMode.index] : {};
  const rExpectedDate = document.getElementById('rExpectedDate');
  const rPaidAmountInput = document.getElementById('rPaidAmount'); 
  const totalAmount = parseAmount(rAmount.value);

  const data = isEditing ? { ...oldData } : {};

  data.Ø§Ù„Ù†ÙˆØ¹ = rType.value; 
  data.Ø§Ù„Ù…Ø¨Ù„Øº = rAmount.value; // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ù†Ø³Ù‚Ø©
  data.Ø§Ù„ÙˆØµÙ = rDesc.value; 
  data.Ø§Ù„ØªØ§Ø±ÙŠØ® = rDate.value; 
  data.ØªØ§Ø±ÙŠØ®_Ù…ØªÙˆÙ‚Ø¹ = rExpectedDate ? rExpectedDate.value : null; 
  
  if (data.Ø§Ù„Ù†ÙˆØ¹ === 'Ø¯ÙŠÙ†') {
      const paidAmount = rPaidAmountInput ? parseAmount(rPaidAmountInput.value) : 0;
      const remaining = totalAmount - paidAmount;
      
      if (paidAmount > totalAmount) return toastMsg("Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„ÙƒÙ„ÙŠ.");

      data.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¯ÙÙˆØ¹ = paidAmount.toLocaleString('ar'); // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© Ø§Ù„Ù…Ù†Ø³Ù‚Ø©
      data.Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ = remaining.toLocaleString('ar'); // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ø§Ù„Ù…Ù†Ø³Ù‚Ø©
      
      if (remaining <= 0) {
          data.Ø§Ù„Ø­Ø§Ù„Ø© = "Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„";
      } else if (paidAmount > 0) {
          data.Ø§Ù„Ø­Ø§Ù„Ø© = "Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹";
      } else {
          data.Ø§Ù„Ø­Ø§Ù„Ø© = "ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ Ø¨Ø¹Ø¯";
      }
      
      delete data.Ø§Ù„Ø­Ø§Ù„Ø©_Ø§Ù„ÙŠØ¯ÙˆÙŠØ©;
      
  } else {
      if (!rStatus.value) return toastMsg("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø©.");
      data.Ø§Ù„Ø­Ø§Ù„Ø© = rStatus.value;
      
      delete data.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¯ÙÙˆØ¹;
      delete data.Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ;
  }
  
  if (isEditing) {
      data.id = oldData.id;
  }
  
  try {
      await saveData('rig', data);
      toastMsg(isEditing ? "ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ù‚" : "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ù‚");
      
      await loadAllData(); 
      postSaveCleanup(isEditing, 'rig');

  } catch (error) {
      toastMsg("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸. ØªØ­Ù‚Ù‚ Ù…Ù† Console.");
      console.error(error);
  }
}

async function addDebt() {
  const isMasterLiability = (dType.value === 'Ù‚Ø±Ø¶' || dType.value === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ');
  
  const dTotalAmountInput = document.getElementById('dTotalAmount');
  const dInstallmentsInput = document.getElementById('dInstallments');
  const dPaidInstallmentsInput = document.getElementById('dPaidInstallments'); 
  
  // ØªÙ… Ø§Ø®ØªØµØ§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø©
  if (!dType.value || !dDate.value) return toastMsg("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©");
  if (!isMasterLiability && (!dAmount.value || !dStatus.value)) return toastMsg("Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©/Ø§Ù„Ù‚Ø³Ø·.");
  if (isMasterLiability && !dTotalAmountInput.value) return toastMsg("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø§Ù„ØªØ²Ø§Ù….");

  const isEditing = editMode && editMode.type === "deb";
  const oldData = isEditing ? db.deb[editMode.index] : {};

  const data = isEditing ? { ...oldData } : {};

  data.Ø§Ù„Ù†ÙˆØ¹ = dType.value; 
  data.Ø§Ù„ÙˆØµÙ = dDesc.value; 
  data.Ø§Ù„ØªØ§Ø±ÙŠØ® = dDate.value; 
  
  if (isMasterLiability) {
      const totalAmount = parseAmount(dTotalAmountInput.value);
      let totalPaidAmount = 0;
      let remainingAmount = 0;

      if (data.Ø§Ù„Ù†ÙˆØ¹ === 'Ù‚Ø±Ø¶') {
          const paidInstallmentsCount = parseInt(dPaidInstallmentsInput.value) || 0;
          const installmentsTotal = parseInt(dInstallmentsInput.value) || 0;
          
          if (installmentsTotal <= 0) return toastMsg("Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±.");
          if (paidInstallmentsCount > installmentsTotal) return toastMsg("Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„ÙƒÙ„ÙŠ.");

          const installmentValue = totalAmount / installmentsTotal;
          totalPaidAmount = paidInstallmentsCount * installmentValue;
          
          data.Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ù‚Ø³Ø§Ø· = installmentsTotal;
          // Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ù†Ø³Ù‚Ø© Ù„Ù„Ø¹Ù…Ù„Ø© Ù„ØªØ¬Ù†Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨
          data.Ù‚ÙŠÙ…Ø©_Ø§Ù„Ù‚Ø³Ø· = formatCurrency(installmentValue.toFixed(2));
          data.Ø§Ù„Ø£Ù‚Ø³Ø§Ø·_Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© = paidInstallmentsCount;
          
      } else if (data.Ø§Ù„Ù†ÙˆØ¹ === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ') {
          // Ù‡Ù†Ø§ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù‡Ùˆ Ù‚ÙŠÙ…Ø© Ù†Ù‚Ø¯ÙŠØ© ÙˆÙ„ÙŠØ³Øª Ø¹Ø¯Ø¯ Ø£Ù‚Ø³Ø§Ø·
          totalPaidAmount = parseAmount(dPaidInstallmentsInput.value);
          
          if (totalPaidAmount > totalAmount) return toastMsg("Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø¯ÙŠÙ†.");
          
          delete data.Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ù‚Ø³Ø§Ø·;
          delete data.Ù‚ÙŠÙ…Ø©_Ø§Ù„Ù‚Ø³Ø·;
          data.Ø§Ù„Ø£Ù‚Ø³Ø§Ø·_Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© = null;
      }
      
      remainingAmount = totalAmount - totalPaidAmount;
      
      data.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù… = dTotalAmountInput.value; // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ø§Ù„Ù…Ù†Ø³Ù‚
      // Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ù†Ø³Ù‚Ø© Ù„Ù„Ø¹Ù…Ù„Ø© Ù„ØªØ¬Ù†Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨
      data.Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„Ù…Ø¯ÙÙˆØ¹ = formatCurrency(totalPaidAmount); 
      data.Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù… = formatCurrency(remainingAmount);
      
      data.Ø§Ù„Ù…Ø¨Ù„Øº = "â€”";
      data.Ø§Ù„Ø­Ø§Ù„Ø© = "â€”";
      
  } else {
      data.Ø§Ù„Ù…Ø¨Ù„Øº = dAmount.value; // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ù†Ø³Ù‚Ø©
      data.Ø§Ù„Ø­Ø§Ù„Ø© = dStatus.value;
      
      delete data.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…;
      delete data.Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„Ù…Ø¯ÙÙˆØ¹;
      delete data.Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…;
      delete data.Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ù‚Ø³Ø§Ø·;
      delete data.Ù‚ÙŠÙ…Ø©_Ø§Ù„Ù‚Ø³Ø·;
      delete data.Ø§Ù„Ø£Ù‚Ø³Ø§Ø·_Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©;
  }
  
  if (isEditing) {
      data.id = oldData.id;
  }
  
  try {
      await saveData('deb', data);
      toastMsg(isEditing ? "ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…" : "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…");
      
      await loadAllData(); 
      postSaveCleanup(isEditing, 'deb');

  } catch (error) {
      toastMsg("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸. ØªØ­Ù‚Ù‚ Ù…Ù† Console.");
      console.error(error);
  }
}

function openLog(t) {
  const logModal = document.getElementById("logModal");
  currentLog = t;
  logModal.style.display = "flex";
  renderLog();
}

function closeLog() { 
    const logModal = document.getElementById("logModal");
    logModal.style.display = "none"; 
}

function renderLog() {
  const logContent = document.getElementById("logContent");
  const search = document.getElementById("search");
  const q = (search.value || "").toLowerCase();
  
  const filteredData = db[currentLog]
    .filter(i => JSON.stringify(i).toLowerCase().includes(q));

  logContent.innerHTML = filteredData
    .map((i) => {
        let subText = i.Ø§Ù„Ø­Ø§Ù„Ø© || '';
        let displayAmount = i.Ø§Ù„Ù…Ø¨Ù„Øº;
        let displayTitle = i.Ø§Ù„Ù†ÙˆØ¹ || i.Ø§Ù„ÙØ¦Ø© || 'Ù…Ø¹Ø§Ù…Ù„Ø©'; 

        if (i.Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…) {
             // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ù†Ø³Ù‚Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
             subText = `Ù…Ø¯ÙÙˆØ¹: ${i.Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„Ù…Ø¯ÙÙˆØ¹} / Ù…ØªØ¨Ù‚ÙŠ: ${i.Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…}`;
             displayAmount = i.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…;
        } else if (i.Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ) { 
             // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ø§Ù„Ù…Ù†Ø³Ù‚Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø©
             subText = `Ø§Ù„Ø­Ø§Ù„Ø©: ${i.Ø§Ù„Ø­Ø§Ù„Ø©} / Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${formatCurrency(i.Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ)}`;
             displayAmount = i.Ø§Ù„Ù…Ø¨Ù„Øº; 
        }

        return `
            <div class="list-item" onclick='showDetailById(${i.id},"${currentLog}")'>
                <div style="font-weight: bold; margin-bottom: 5px; display: flex; justify-content: space-between;">
                    <span>${displayTitle}</span> <span>${formatCurrency(displayAmount)}</span>
                </div>
                <div style="font-size: 0.9em; color: #666; text-align: right;">
                    ${subText} | ${formatDateTime(i.Ø§Ù„ØªØ§Ø±ÙŠØ®)}
                </div>
            </div>
        `;
    })
    .join("");
}

function showDetailById(id, type) {
    const o = db[type].find(item => item.id === id);
    if (!o) return toastMsg("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.");
    
    const index = db[type].findIndex(item => item.id === id);
    if (index === -1) return toastMsg("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙ‡Ø±Ø³ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.");
    
    editMode = { type, index }; 
    
    _renderDetailContent(o, type); 
}

function _renderDetailContent(o, type) {
    const detailModal = document.getElementById("detailModal");
    const detailContent = document.getElementById("detailContent");

    detailModal.style.display = "flex";

    // **ØªÙ… Ø§Ø®ØªØµØ§Ø± Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©**
    const customMap = {
        'ØªØ§Ø±ÙŠØ®_Ù…ØªÙˆÙ‚Ø¹': 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹',
        'Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…': 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…',
        'Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„Ù…Ø¯ÙÙˆØ¹': 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ù…ØµØ±ÙˆÙ)',
        'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…': 'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…',
        'Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ù‚Ø³Ø§Ø·': 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·',
        'Ù‚ÙŠÙ…Ø©_Ø§Ù„Ù‚Ø³Ø·': 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø·',
        'Ø§Ù„Ø£Ù‚Ø³Ø§Ø·_Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©': 'Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©',
        'Ø§Ù„Ù…Ø¨Ù„Øº': 'Ø§Ù„Ù…Ø¨Ù„Øº (Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø©/Ø¯ÙŠÙ†)',
        'Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¯ÙÙˆØ¹': 'Ø§Ù„Ù…Ø­ØµÙ„/Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†', 
        'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ': 'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„ØªØ­ØµÙŠÙ„', 
        'Ø§Ù„ÙØ¦Ø©': 'Ø§Ù„ÙØ¦Ø©',
        'Ø§Ù„Ù†ÙˆØ¹': 'Ø§Ù„Ù†ÙˆØ¹',
        'Ø§Ù„ÙˆØµÙ': 'Ø§Ù„ÙˆØµÙ/Ø§Ù„Ù…Ø¯ÙŠÙ†/Ø§Ù„Ø¯Ø§Ø¦Ù†',
        'Ø§Ù„ØªØ§Ø±ÙŠØ®': 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©',
        'Ø§Ù„Ø­Ø§Ù„Ø©': 'Ø§Ù„Ø­Ø§Ù„Ø©',
    };

    let details = Object.entries(o).map(([k, v]) => {
        if (k === "ØµÙˆØ±Ø©" && v) return `<p><b>ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</b></p><img src="${v}">`;
        if (k === "id" || k === "clientID") return ""; 
        
        const displayKey = customMap[k] || k;
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø®Ø²Ù†Ø© ÙƒÙ€ String Ù…Ù†Ø³Ù‚ (Ù…Ø«Ø§Ù„: Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„Ù…Ø¯ÙÙˆØ¹ØŒ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…ØŒ Ù‚ÙŠÙ…Ø©_Ø§Ù„Ù‚Ø³Ø·)
        if (k === "Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…" || k === "Ù‚ÙŠÙ…Ø©_Ø§Ù„Ù‚Ø³Ø·" || k === "Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„Ù…Ø¯ÙÙˆØ¹") { 
             if (v === "â€”" || v === null) return "";
             return `<p><b>${displayKey}:</b> ${v}</p>`; 
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø®Ø²Ù†Ø© ÙƒÙ‚ÙŠÙ…Ø© Ù…Ù†Ø³Ù‚Ø© (Ù…Ø«Ø§Ù„: Ø§Ù„Ù…Ø¨Ù„ØºØŒ Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¯ÙÙˆØ¹ØŒ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØŒ Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…)
        if (k === "Ø§Ù„Ù…Ø¨Ù„Øº" || k === "Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…" || k === "Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¯ÙÙˆØ¹" || k === "Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ") { 
            if (v === "â€”" || v === null) return "";
            return `<p><b>${displayKey}:</b> ${formatCurrency(v)}</p>`;
        }
        
        if (k === "Ø§Ù„ØªØ§Ø±ÙŠØ®" || k === "ØªØ§Ø±ÙŠØ®_Ù…ØªÙˆÙ‚Ø¹") {
            return `<p><b>${displayKey}:</b> ${formatDateTime(v)}</p>`;
        }
        
        if (v === null || v === undefined || v === "" || v === "â€”") return "";
        
        return `<p><b>${displayKey}:</b> ${v}</p>`;
    }).filter(p => p !== "").join("");

    detailContent.innerHTML = details + 
    `<button class="action" onclick="editTransaction()">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
    <button class="secondary" onclick="deleteTransaction()">ğŸ—‘ï¸ Ø­Ø°Ù</button>`;
}

function editTransaction() {
  if (!editMode) return;
  const currentData = db[editMode.type][editMode.index];

  const detailModal = document.getElementById("detailModal");
  const logModal = document.getElementById("logModal");
  detailModal.style.display = "none";
  logModal.style.display = "none"; 
  
  if (editMode.type === "exp") {
    openTab('expenses', true); 
    eAmount.value = currentData.Ø§Ù„Ù…Ø¨Ù„Øº;
    eType.value = currentData.Ø§Ù„ÙØ¦Ø©;
    eDesc.value = currentData.Ø§Ù„ÙˆØµÙ;
    eDate.value = currentData.Ø§Ù„ØªØ§Ø±ÙŠØ®;
    
    // **Ù…Ù†Ø·Ù‚ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„**
    const imageStatus = document.getElementById('imageStatus');
    if (currentData.ØµÙˆØ±Ø©) {
        currentExpenseFile = { name: "ØµÙˆØ±Ø© Ø³Ø§Ø¨Ù‚Ø©", size: 0 }; // Placeholder object for status
        imageStatus.textContent = `âœ… ØµÙˆØ±Ø© Ø³Ø§Ø¨Ù‚Ø© Ù…Ø±ÙÙ‚Ø©`;
        imageStatus.style.color = 'var(--s)';
    } else {
        currentExpenseFile = null;
        imageStatus.textContent = 'Ù„Ù… ÙŠØªÙ… Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø©';
        imageStatus.style.color = 'var(--p)';
    }
    // Ù…Ø³Ø­ Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù…Ù„ÙØ§Øª Ù„ØªØ³Ù…Ø­ Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù
    document.getElementById('eImgCamera').value = null;
    document.getElementById('eImgGallery').value = null;

  }
  
  if (editMode.type === "rig") {
    openTab('rights', true); 
    
    rType.value = currentData.Ø§Ù„Ù†ÙˆØ¹;
    updateRightFields(rType.value); 
    rAmount.value = currentData.Ø§Ù„Ù…Ø¨Ù„Øº;
    rDesc.value = currentData.Ø§Ù„ÙˆØµÙ;
    rDate.value = currentData.Ø§Ù„ØªØ§Ø±ÙŠØ®;
    
    if (currentData.Ø§Ù„Ù†ÙˆØ¹ === 'Ø¯ÙŠÙ†') {
        const rPaidAmountInput = document.getElementById('rPaidAmount');
        if (rPaidAmountInput && currentData.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¯ÙÙˆØ¹) {
             rPaidAmountInput.value = currentData.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¯ÙÙˆØ¹; 
             // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
             // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‚ÙŠÙ…Ø© rAmount Ù…ÙˆØ¬ÙˆØ¯Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡
             calculateRightRemaining();
        }
    } else {
        rStatus.value = currentData.Ø§Ù„Ø­Ø§Ù„Ø©;
    }

    if (currentData.ØªØ§Ø±ÙŠØ®_Ù…ØªÙˆÙ‚Ø¹ && document.getElementById('rExpectedDate')) {
        document.getElementById('rExpectedDate').value = currentData.ØªØ§Ø±ÙŠØ®_Ù…ØªÙˆÙ‚Ø¹;
    }
  }
  
  if (editMode.type === "deb") {
    openTab('debts', true); 
    
    dType.value = currentData.Ø§Ù„Ù†ÙˆØ¹;
    dDesc.value = currentData.Ø§Ù„ÙˆØµÙ;
    dDate.value = currentData.Ø§Ù„ØªØ§Ø±ÙŠØ®;

    updateDebtFields(dType.value); 

    if (currentData.Ø§Ù„Ù†ÙˆØ¹ === 'Ù‚Ø±Ø¶' || currentData.Ø§Ù„Ù†ÙˆØ¹ === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ') {
        if (currentData.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù… && document.getElementById('dTotalAmount')) {
            document.getElementById('dTotalAmount').value = currentData.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…;
        }
        
        if (currentData.Ø§Ù„Ù†ÙˆØ¹ === 'Ù‚Ø±Ø¶') {
            if (currentData.Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ù‚Ø³Ø§Ø· && document.getElementById('dInstallments')) {
                document.getElementById('dInstallments').value = currentData.Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ù‚Ø³Ø§Ø·;
            }
            if (currentData.Ø§Ù„Ø£Ù‚Ø³Ø§Ø·_Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© !== null && document.getElementById('dPaidInstallments')) {
                document.getElementById('dPaidInstallments').value = currentData.Ø§Ù„Ø£Ù‚Ø³Ø§Ø·_Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©;
            }
            calculateInstallmentValue();

        } else if (currentData.Ø§Ù„Ù†ÙˆØ¹ === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ') {
            const paidAmountUnformatted = parseAmount(currentData.Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„Ù…Ø¯ÙÙˆØ¹);
            if (document.getElementById('dPaidInstallments')) {
                 // Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ù†Ø³Ù‚Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù„Ù„Ø¹Ø±Ø¶ØŒ Ø¯Ø§Ù„Ø© formatAmount Ø³ØªÙ†Ø¸ÙÙ‡Ø§ Ù„Ù„Ø­ÙØ¸
                document.getElementById('dPaidInstallments').value = paidAmountUnformatted.toLocaleString('ar');
            }
        }
    } else {
        dAmount.value = currentData.Ø§Ù„Ù…Ø¨Ù„Øº;
        dStatus.value = currentData.Ø§Ù„Ø­Ø§Ù„Ø©;
    }
  }
}

async function deleteTransaction() {
  if (!editMode) return;
  if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŸ")) return;
  
  const typeToDelete = editMode.type;
  const idToDelete = db[typeToDelete][editMode.index].id;
  
  try {
      await deleteFromDB(typeToDelete, idToDelete);
      editMode = null; 
      await loadAllData(); 
      toastMsg("ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­");
      
      const detailModal = document.getElementById("detailModal");
      detailModal.style.display = "none";
      
      updateStats();
      
      openLog(typeToDelete); 
      
  } catch (error) {
      toastMsg("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù.");
      console.error(error);
  }
}

// ===================================================
// 4. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Stats)
// ===================================================

function updateStats() {
  let et = 0, ec = 0; 
  let cats = {}; 
  
  let rt = 0, rp = 0, ru = 0; 
  let dt = 0, dp = 0, du = 0; 

  // 1. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø© (Variable Expenses)
  db.exp.forEach(e => { 
    let a = parseAmount(e.Ø§Ù„Ù…Ø¨Ù„Øº); 
    et += a; 
    ec++;
    cats[e.Ø§Ù„ÙØ¦Ø©] = (cats[e.Ø§Ù„ÙØ¦Ø©] || 0) + a;
  });

  // 2. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙˆØ§Ù„Ù†Ù‚Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©
  db.deb.forEach(d => { 
    const isMasterLiability = (d.Ø§Ù„Ù†ÙˆØ¹ === 'Ù‚Ø±Ø¶' || d.Ø§Ù„Ù†ÙˆØ¹ === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ');
    
    if (isMasterLiability) {
        // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚ÙŠÙ… ØºÙŠØ± Ø§Ù„Ù…Ù†Ø³Ù‚Ø© (Ø±ØºÙ… Ø£Ù†Ù†Ø§ Ù†Ø®Ø²Ù† Ø§Ù„Ù…Ù†Ø³Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹) Ù„Ø¶Ù…Ø§Ù† Ø¯Ù‚Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
        const totalLiability = parseAmount(d.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…);
        // ÙŠØ¬Ø¨ ØªØ­Ù„ÙŠÙ„ Ù‚ÙŠÙ…Ø© Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ù†Ø³Ù‚
        const paidAmount = parseAmount(d.Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„Ù…Ø¯ÙÙˆØ¹); 
        
        dt += totalLiability; 
        dp += paidAmount;
        
        const remaining = totalLiability - paidAmount;
        du += remaining;
        
        if (paidAmount > 0) {
            et += paidAmount; 
            ec++; 
            const category = `Ø§Ù„ØªØ²Ø§Ù… Ù…Ø¯ÙÙˆØ¹: ${d.Ø§Ù„Ù†ÙˆØ¹}`; 
            cats[category] = (cats[category] || 0) + paidAmount;
        }

    } else {
        let amount = parseAmount(d.Ø§Ù„Ù…Ø¨Ù„Øº); 
        dt += amount; 
        
        if (d.Ø§Ù„Ø­Ø§Ù„Ø© === "Ù…Ø¯ÙÙˆØ¹") {
            dp += amount;
            
            et += amount; 
            ec++;
            
            const category = `Ø§Ù„ØªØ²Ø§Ù… Ù…Ø¯ÙÙˆØ¹: ${d.Ø§Ù„Ù†ÙˆØ¹}`; 
            cats[category] = (cats[category] || 0) + amount;
        } else {
            du += amount;
        }
    }
  });
  
  // 3. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ù‚ÙˆÙ‚
  db.rig.forEach(r => { 
    let a = parseAmount(r.Ø§Ù„Ù…Ø¨Ù„Øº); 
    rt += a; 
    
    if (r.Ø§Ù„Ù†ÙˆØ¹ === 'Ø¯ÙŠÙ†') {
        // ÙŠØ¬Ø¨ ØªØ­Ù„ÙŠÙ„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ù†Ø³Ù‚
        const paid = parseAmount(r.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¯ÙÙˆØ¹);
        rp += paid;
        ru += a - paid;

    } else {
        r.Ø§Ù„Ø­Ø§Ù„Ø© === "Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„" ? rp += a : ru += a;
    }
  });

  // ØªØ­Ø¯ÙŠØ¯ Ø£Ø¹Ù„Ù‰ ÙØ¦Ø© Ù…ØµØ±ÙˆÙØ§Øª
  let topCatName = 'â€”';
  let maxCatAmount = 0;
  for (let cat in cats) { 
    if (cats[cat] > maxCatAmount) {
      maxCatAmount = cats[cat];
      topCatName = cat;
    }
  }
  
  if (topCatName.startsWith('Ø§Ù„ØªØ²Ø§Ù… Ù…Ø¯ÙÙˆØ¹:')) {
      topCatName = `Ù…Ù† Ø§Ù„ØªØ²Ø§Ù…Ø§Øª: ${topCatName.substring(topCatName.indexOf(':') + 1)}`;
  }

  // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
  document.getElementById("sExpTotal").innerHTML = formatCurrency(et); 
  document.getElementById("sExpCount").textContent = ec;
  document.getElementById("sTopCat").textContent = topCatName;
  
  document.getElementById("sRigTotal").innerHTML = formatCurrency(rt); 
  document.getElementById("sRigPaid").innerHTML = formatCurrency(rp); 
  document.getElementById("sRigUnpaid").innerHTML = formatCurrency(ru);
  
  document.getElementById("sDebTotal").innerHTML = formatCurrency(dt); 
  document.getElementById("sDebPaid").innerHTML = formatCurrency(dp); 
  document.getElementById("sDebUnpaid").innerHTML = formatCurrency(du);
}


// ===================================================
// 5. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Sidebar Functions) ÙˆØ§Ù„Ù€ Overlay
// ===================================================

// **Ø¯Ø§Ù„Ø© Ù…ÙˆØ­Ø¯Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¶ØºØ·Ø© Ø§Ù„Ù€ Overlay**
function handleOverlayClick(event) {
    const calculatorModal = document.getElementById('calculatorModal');
    const appSidebar = document.getElementById('appSidebar');

    if (calculatorModal.style.display === 'flex') {
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¢Ù„Ø© Ø§Ù„Ø­Ø§Ø³Ø¨Ø© Ù…ÙØªÙˆØ­Ø©ØŒ Ø£ØºÙ„Ù‚Ù‡Ø§
        if (event.target.id === 'appOverlay') { 
            closeCalculator();
        }
    } else if (appSidebar.classList.contains('open')) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù…ÙØªÙˆØ­Ø©ØŒ Ø£ØºÙ„Ù‚Ù‡Ø§
        toggleSidebar();
    }
}

function toggleSidebar() {
    const sidebar = document.getElementById('appSidebar');
    const overlay = document.getElementById('appOverlay');
    sidebar.classList.toggle('open');
    overlay.classList.toggle('open');
}

function openAboutModal() {
    document.getElementById('aboutModal').style.display = 'flex';
    toggleSidebar();
}

// **ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¹Ù…Ù„Ø§Øª**

function openCurrencyModal() {
    document.getElementById('currencyModal').style.display = 'flex';
    document.getElementById('currencySearch').value = '';
    renderCurrencyList();
    toggleSidebar(); 
}

function renderCurrencyList() {
    const list = document.getElementById('currencyList');
    const searchTerm = document.getElementById('currencySearch').value.toLowerCase();

    const filtered = ARABIC_CURRENCIES.filter(c => 
        c.name.toLowerCase().includes(searchTerm) || 
        c.code.toLowerCase().includes(searchTerm) ||
        c.symbol.includes(searchTerm)
    );

    list.innerHTML = filtered.map(c => `
        <div class="sidebar-menu-item" onclick="selectCurrency('${c.code}')">
            <span>${c.name} (${c.symbol})</span>
            ${c.code === currentCurrency.code ? '<span style="color: var(--s); font-weight: bold;">âœ… Ø§Ù„Ø­Ø§Ù„ÙŠØ©</span>' : ''}
        </div>
    `).join('');
}

function selectCurrency(code) {
    const newCurrency = ARABIC_CURRENCIES.find(c => c.code === code);
    if (newCurrency) {
        currentCurrency = newCurrency;
        saveCurrencyPreference(code);
        updateCurrencyDisplay();
        document.getElementById('currencyModal').style.display = 'none';
        toastMsg(`ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø© Ø¥Ù„Ù‰: ${newCurrency.name}`);
    }
}


// **ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Export)**
function exportData() {
    toggleSidebar();
    
    if (!IDB_connection) return toastMsg("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");

    const transaction = IDB_connection.transaction(STORE_NAMES, "readonly");
    const dataToExport = {};
    let storesProcessed = 0;
    
    STORE_NAMES.forEach(storeName => {
        const store = transaction.objectStore(storeName);
        const request = store.getAll();

        request.onsuccess = (event) => {
            dataToExport[storeName] = event.target.result;
            storesProcessed++;
            
            if (storesProcessed === STORE_NAMES.length) {
                const json = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `smart_budget_backup_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                toastMsg("ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
            }
        };

        request.onerror = () => {
             toastMsg(`ÙØ´Ù„ ØªØµØ¯ÙŠØ± Ù…ØªØ¬Ø± ${storeName}.`);
             storesProcessed++;
        };
    });
}

// **Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Import)**
async function importData(event) {
    toggleSidebar();
    const file = event.target.files[0];
    if (!file) return;

    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ø³ÙŠØ¤Ø¯ÙŠ Ø°Ù„Ùƒ Ø¥Ù„Ù‰ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„.")) {
        event.target.value = null; 
        return;
    }

    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const importedData = JSON.parse(e.target.result);
            if (!IDB_connection) return toastMsg("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");

            const clearStore = (storeName) => new Promise((resolve, reject) => {
                const transaction = IDB_connection.transaction([storeName], "readwrite");
                const store = transaction.objectStore(storeName);
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e.target.error);
            });
            
            const addDataToStore = (storeName, data) => new Promise((resolve, reject) => {
                const transaction = IDB_connection.transaction([storeName], "readwrite");
                const store = transaction.objectStore(storeName);
                
                let successCount = 0;
                let errorCount = 0;
                
                data.forEach(item => {
                    delete item.id; 
                    const request = store.add(item);
                    request.onsuccess = () => successCount++;
                    request.onerror = () => errorCount++;
                });

                transaction.oncomplete = () => resolve({success: successCount, error: errorCount});
                transaction.onerror = (e) => reject(e.target.error);
            });


            for (const storeName of STORE_NAMES) {
                await clearStore(storeName); 
            }

            for (const storeName of STORE_NAMES) {
                if (importedData[storeName] && Array.isArray(importedData[storeName])) {
                    await addDataToStore(storeName, importedData[storeName]);
                }
            }

            await loadAllData(); 
            updateStats();
            toastMsg("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­!");

        } catch (error) {
            toastMsg("ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù Ø¨ØµÙŠØºØ© JSON ØµØ­ÙŠØ­Ø©.");
            console.error("Import Error:", error);
        } finally {
            event.target.value = null; 
        }
    };
    reader.readAsText(file);
}

// **Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Reset)**
function confirmResetData() {
    toggleSidebar();
    if (confirm("ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.")) {
        resetAllData();
    }
}

function resetAllData() {
     if (!IDB_connection) return toastMsg("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");

    const transaction = IDB_connection.transaction(STORE_NAMES, "readwrite");
    let storesCleared = 0;
    
    STORE_NAMES.forEach(storeName => {
        const store = transaction.objectStore(storeName);
        const request = store.clear();

        request.onsuccess = () => {
            storesCleared++;
            if (storesCleared === STORE_NAMES.length) {
                db.exp = db.rig = db.deb = []; 
                updateStats(); 
                toastMsg("ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
            }
        };

        request.onerror = () => toastMsg("ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
    });
}

// ===================================================
// 6. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¢Ù„Ø© Ø§Ù„Ø­Ø§Ø³Ø¨Ø© (Calculator Functions)
// ===================================================

let currentInput = '0';
let previousInput = '';
let operation = null;
let computedResult = false; 

const calcMainOutput = document.getElementById('calcMainOutput');
const calcSecondaryOutput = document.getElementById('calcSecondaryOutput');

function updateCalculatorDisplay() {
    if (calcMainOutput) calcMainOutput.textContent = currentInput;
    if (calcSecondaryOutput) calcSecondaryOutput.textContent = previousInput;
}

function calculatorInput(value) {
    if (currentInput === 'Error') {
        currentInput = '0';
        previousInput = '';
    }

    if (computedResult) {
        currentInput = (isOperator(value) || value === '.') ? currentInput : '0';
        previousInput = '';
        computedResult = false;
    }

    if (value === '.') {
        if (!currentInput.includes('.')) {
            currentInput += '.';
        }
    } else if (isOperator(value)) {
        if (previousInput.includes('=')) {
            previousInput = currentInput + ' ' + value;
            operation = value;
            currentInput = '0';
        } else if (previousInput !== '' && !isOperator(previousInput.slice(-1))) {
            // Ù‚Ù… Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø²Ø¦ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¹Ù…Ù„ÙŠØ© Ø³Ø§Ø¨Ù‚Ø©
            calculatorCompute();
            previousInput = currentInput + ' ' + value;
            operation = value;
            currentInput = '0';
        } else if (previousInput === '') {
            previousInput = currentInput + ' ' + value;
            operation = value;
            currentInput = '0';
        } else {
            // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚
            previousInput = previousInput.slice(0, -1) + value;
            operation = value;
        }
    } else {
        // Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù…
        if (currentInput === '0') {
            currentInput = value;
        } else {
            currentInput += value;
        }
    }

    updateCalculatorDisplay();
}

function isOperator(char) {
    return ['+', '-', '*', '/'].includes(char);
}

function calculatorCompute() {
    if (previousInput === '' || currentInput === '0' || computedResult) return;

    try {
        const formula = previousInput.replace(operation, operation === '/' ? '/' : operation === '*' ? '*' : operation) + ' ' + currentInput;
        // Ø¥Ø²Ø§Ù„Ø© Ø±Ù…ÙˆØ² Ø§Ù„Ø¹Ù…Ù„Ø© ÙˆØ£ÙŠ Ø±Ù…ÙˆØ² Ø¹Ø±Ø¨ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
        const cleanFormula = formula.replace(/[^0-9.+-/*]/g, '');

        let result = eval(cleanFormula);
        
        // ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ù…Ù†Ø¹ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø§Ø¦Ù…Ø©
        result = parseFloat(result.toFixed(10)); 

        previousInput = formula + ' =';
        currentInput = result.toLocaleString('ar'); // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø±Ø¨ÙŠ

        computedResult = true;

    } catch (e) {
        currentInput = 'Error';
        previousInput = '';
        computedResult = false;
        console.error("Calculator Error:", e);
    }
    updateCalculatorDisplay();
}

function calculatorClear() {
    currentInput = '0';
    previousInput = '';
    operation = null;
    computedResult = false;
    updateCalculatorDisplay();
}

function calculatorDelete() {
    if (currentInput === 'Error') {
        currentInput = '0';
    } else if (currentInput.length > 1) {
        currentInput = currentInput.slice(0, -1);
    } else {
        currentInput = '0';
    }
    computedResult = false;
    updateCalculatorDisplay();
}

function openCalculator() {
    const modal = document.getElementById('calculatorModal');
    const overlay = document.getElementById('appOverlay'); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ Overlay Ø§Ù„ØµØ­ÙŠØ­
    modal.style.display = 'flex';
    overlay.classList.add('open'); 
    calculatorClear();
}

function closeCalculator() {
    const modal = document.getElementById('calculatorModal');
    const overlay = document.getElementById('appOverlay');
    modal.style.display = 'none';
    overlay.classList.remove('open');
}

</script>

</body>
</html>
