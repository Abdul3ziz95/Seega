<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title>تتبع المصروفات والحقوق والالتزامات</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- مكتبة jsPDF للتصدير إلى PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-/FfSZgqZKqS+o9g2VfQY0KFz8tnVnrx9DgYgYcQvJx8iazlJjLQ9w0yWvli1pR6VYbViu+gBq+Uz53S5vPZsLg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        :root {
            --bg: #f4f4f4;
            --card-bg: #ffffff;
            --primary: #2563eb;
            --primary-soft: #dbeafe;
            --danger: #dc2626;
            --success: #16a34a;
            --text: #111827;
            --muted: #6b7280;
            --radius: 10px;
            --shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        .app {
            max-width: 1100px;
            margin: 20px auto;
            padding: 10px;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: var(--muted);
            font-size: 14px;
            margin-bottom: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 15px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 15px;
        }

        @media (max-width: 900px) {
            .grid-3 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (max-width: 700px) {
            .grid-3,
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 15px 18px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .card-title {
            font-size: 15px;
            font-weight: 600;
        }

        .card-subtitle {
            font-size: 12px;
            color: var(--muted);
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            margin-top: 4px;
        }

        .stat-label {
            font-size: 11px;
            color: var(--muted);
        }

        .badge {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 999px;
            background: var(--primary-soft);
            color: var(--primary);
        }

        .badge-danger {
            background: #fee2e2;
            color: var(--danger);
        }

        .badge-success {
            background: #dcfce7;
            color: var(--success);
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 8px;
        }

        @media (max-width: 800px) {
            .form-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 13px;
        }

        label {
            font-weight: 500;
        }

        input, select, textarea {
            border-radius: 7px;
            border: 1px solid #d1d5db;
            padding: 6px 8px;
            font-size: 13px;
            font-family: inherit;
        }

        textarea {
            resize: vertical;
            min-height: 40px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 1px var(--primary-soft);
        }

        .btn {
            border-radius: 8px;
            border: none;
            padding: 7px 10px;
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #111827;
        }

        .btn-danger {
            background: var(--danger);
            color: #fff;
        }

        .btn-sm {
            padding: 4px 7px;
            font-size: 11px;
            border-radius: 999px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .table-wrapper {
            margin-top: 10px;
            max-height: 320px;
            overflow: auto;
            border-radius: var(--radius);
            border: 1px solid #e5e7eb;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th, td {
            padding: 6px 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            position: sticky;
            top: 0;
            background: #f9fafb;
            z-index: 1;
            text-align: right;
        }

        tr:nth-child(even) {
            background: #f9fafb;
        }

        .tag {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 999px;
            background: #e5e7eb;
        }

        .tag-expense {
            background: #fee2e2;
            color: #b91c1c;
        }

        .tag-right {
            background: #dcfce7;
            color: #166534;
        }

        .tag-liability {
            background: #fef3c7;
            color: #92400e;
        }

        .hint {
            font-size: 11px;
            color: var(--muted);
            margin-top: 4px;
        }

        .pill {
            padding: 2px 7px;
            border-radius: 999px;
            border: 1px dashed #d1d5db;
            font-size: 11px;
            color: var(--muted);
        }
    </style>
</head>
<body>

<div class="app">
    <h1>دفتر المصروفات والحقوق والالتزامات</h1>
    <div class="subtitle">
        تتبع كل حركة مالية: المصروفات، الحقوق المستحقة، الالتزامات، والمدفوعات والتحصيلات مع حفظ البيانات وتصديرها.
    </div>

    <!-- بطاقات الملخص -->
    <div class="grid-3" style="margin-bottom: 15px;">
        <div class="card">
            <div class="card-header">
                <div>
                    <div class="card-title">الرصيد الحالي</div>
                    <div class="card-subtitle">بعد الأخذ في الاعتبار المصروفات والتحصيلات والمدفوعات</div>
                </div>
                <span class="badge badge-success">صافي الرصيد</span>
            </div>
            <div class="stat-value" id="currentBalance">0</div>
            <div class="stat-label">يمكنك تعديل الرصيد الابتدائي من الحقل أسفل النموذج.</div>
        </div>

        <div class="card">
            <div class="card-header">
                <div>
                    <div class="card-title">إجمالي المصروفات</div>
                    <div class="card-subtitle">تشمل مصروفاتك المباشرة والمدفوعات النقدية</div>
                </div>
                <span class="badge badge-danger">يخصم من الرصيد</span>
            </div>
            <div class="stat-value" id="totalExpenses">0</div>
            <div class="stat-label">كل عملية نوعها "مصروف" تقلل من الرصيد الحالي.</div>
        </div>

        <div class="card">
            <div class="card-header">
                <div>
                    <div class="card-title">إجمالي الحقوق المستحقة</div>
                    <div class="card-subtitle">المبالغ التي لك على الآخرين (ديون / آجلات)</div>
                </div>
                <span class="badge">مبالغ مستحقة لك</span>
            </div>
            <div class="stat-value" id="totalRights">0</div>
            <div class="stat-label">يتم تخفيض هذا الرقم عند تسجيل تحصيل حق.</div>
        </div>
    </div>

    <div class="grid-3" style="margin-bottom: 15px;">
        <div class="card">
            <div class="card-header">
                <div>
                    <div class="card-title">إجمالي الالتزامات الكلية</div>
                    <div class="card-subtitle">مبالغ عليك للغير (قروض، فواتير، آجلات)</div>
                </div>
                <span class="badge badge-warning">مبالغ مستحقة عليهم</span>
            </div>
            <div class="stat-value" id="totalLiabilities">0</div>
            <div class="stat-label">يتم تخفيض هذا الرقم عند تسجيل دفع التزام.</div>
        </div>

        <div class="card">
            <div class="card-header">
                <div>
                    <div class="card-title">المحصل من الحقوق</div>
                    <div class="card-subtitle">مبالغ تم استلامها من ديون/حقوق سابقة</div>
                </div>
                <span class="badge badge-success">يزيد الرصيد</span>
            </div>
            <div class="stat-value" id="totalRightsCollected">0</div>
            <div class="stat-label">كل تحصيل حق يزيد الرصيد الحالي.</div>
        </div>

        <div class="card">
            <div class="card-header">
                <div>
                    <div class="card-title">المدفوع من الالتزامات</div>
                    <div class="card-subtitle">مبالغ تم دفعها من التزاماتك للغير</div>
                </div>
                <span class="badge badge-danger">يقلل الرصيد</span>
            </div>
            <div class="stat-value" id="totalLiabilitiesPaid">0</div>
            <div class="stat-label">كل دفع التزام يقلل الرصيد الحالي.</div>
        </div>
    </div>

    <!-- نموذج إدخال حركة -->
    <div class="card">
        <div class="card-header">
            <div>
                <div class="card-title">إضافة عملية جديدة</div>
                <div class="card-subtitle">حدد نوع العملية وسيتم تحديث الأرصدة تلقائياً</div>
            </div>
            <span class="pill">
                * المصروفات تخصم من الرصيد فوراً  
                * تحصيل الحقوق يضيف للرصيد  
                * دفع الالتزامات يخصم من الرصيد
            </span>
        </div>

        <div class="form-grid" style="margin-bottom: 10px;">
            <div class="form-group">
                <label for="description">الوصف</label>
                <input id="description" type="text" placeholder="مثال: مصروف بنزين / قرض لصديق / تحصيل دين" />
            </div>

            <div class="form-group">
                <label for="type">نوع العملية</label>
                <select id="type">
                    <option value="expense">مصروف</option>
                    <option value="right-add">إضافة حق مستحق لك</option>
                    <option value="right-collect">تحصيل حق (استلام مبلغ)</option>
                    <option value="liability-add">إضافة التزام عليك</option>
                    <option value="liability-pay">دفع التزام (دفع مبلغ)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="amount">المبلغ</label>
                <input id="amount" type="number" min="0" step="0.01" placeholder="0.00" />
            </div>

            <div class="form-group">
                <label for="date">التاريخ</label>
                <input id="date" type="date" />
            </div>
        </div>

        <div class="form-grid">
            <div class="form-group">
                <label for="note">ملاحظة (اختياري)</label>
                <textarea id="note" placeholder="تفاصيل إضافية إن وجدت"></textarea>
            </div>

            <div class="form-group">
                <label for="initialBalance">الرصيد الابتدائي</label>
                <input id="initialBalance" type="number" step="0.01" placeholder="0.00" />
                <div class="hint">
                    يتم تطبيق الرصيد الابتدائي مرة واحدة فقط في أول استخدام، ويمكنك تعديله ليعكس رصيدك الحالي الفعلي.
                </div>
            </div>

            <div class="form-group">
                <label>التحكم</label>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-primary" id="addEntryBtn">إضافة العملية</button>
                    <button class="btn btn-secondary" id="resetFormBtn" type="button">تفريغ الحقول</button>
                </div>
                <div class="hint">
                    تأكد من نوع العملية قبل الإضافة لتنعكس الأرقام بشكل صحيح.
                </div>
            </div>

            <div class="form-group">
                <label>البيانات</label>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-secondary btn-sm" id="exportCsvBtn" type="button">تصدير إلى Excel (CSV)</button>
                    <button class="btn btn-secondary btn-sm" id="exportPdfBtn" type="button">تصدير إلى PDF</button>
                    <button class="btn btn-danger btn-sm" id="clearDataBtn" type="button">حذف كل البيانات</button>
                </div>
                <div class="hint">
                    يتم حفظ البيانات تلقائياً في المتصفح، ويمكنك تصديرها أو حذفها بالكامل من هنا.
                </div>
            </div>
        </div>
    </div>

    <!-- جدول العمليات -->
    <div class="card" style="margin-top: 15px;">
        <div class="flex-between" style="margin-bottom: 10px;">
            <div>
                <div class="card-title">سجل العمليات</div>
                <div class="card-subtitle">
                    جميع العمليات التي أدخلتها تظهر هنا مع إمكانية حذف أي عملية.
                </div>
            </div>
        </div>

        <div class="table-wrapper">
            <table id="entriesTable">
                <thead>
                <tr>
                    <th>#</th>
                    <th>التاريخ</th>
                    <th>الوصف</th>
                    <th>النوع</th>
                    <th>المبلغ</th>
                    <th>ملاحظة</th>
                    <th>إجراءات</th>
                </tr>
                </thead>
                <tbody>
                <!-- يتم تعبئته ديناميكياً -->
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    // ============================
    //  البيانات الأساسية
    // ============================
    const STORAGE_KEY = "financeLedgerData_v1";

    let state = {
        initialBalance: 0,
        currentBalance: 0,
        totalExpenses: 0,
        totalRights: 0,
        totalLiabilities: 0,
        totalRightsCollected: 0,
        totalLiabilitiesPaid: 0,
        entries: []
    };

    // ============================
    //  عناصر DOM
    // ============================
    const currentBalanceEl = document.getElementById("currentBalance");
    const totalExpensesEl = document.getElementById("totalExpenses");
    const totalRightsEl = document.getElementById("totalRights");
    const totalLiabilitiesEl = document.getElementById("totalLiabilities");
    const totalRightsCollectedEl = document.getElementById("totalRightsCollected");
    const totalLiabilitiesPaidEl = document.getElementById("totalLiabilitiesPaid");

    const descriptionInput = document.getElementById("description");
    const typeSelect = document.getElementById("type");
    const amountInput = document.getElementById("amount");
    const dateInput = document.getElementById("date");
    const noteInput = document.getElementById("note");
    const initialBalanceInput = document.getElementById("initialBalance");

    const addEntryBtn = document.getElementById("addEntryBtn");
    const resetFormBtn = document.getElementById("resetFormBtn");
    const clearDataBtn = document.getElementById("clearDataBtn");
    const exportCsvBtn = document.getElementById("exportCsvBtn");
    const exportPdfBtn = document.getElementById("exportPdfBtn");

    const entriesTableBody = document.querySelector("#entriesTable tbody");

    // ============================
    //  تحميل / حفظ البيانات
    // ============================
    function saveState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function loadState() {
        const data = localStorage.getItem(STORAGE_KEY);
        if (data) {
            try {
                const parsed = JSON.parse(data);
                // دمج مع الحالة الافتراضية لضمان وجود كل الحقول
                state = {
                    ...state,
                    ...parsed
                };
            } catch (e) {
                console.error("خطأ في قراءة البيانات المحفوظة", e);
            }
        }
    }

    // ============================
    //  تحديث الواجهة
    // ============================
    function formatNumber(num) {
        return Number(num || 0).toLocaleString("ar-SA", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    function recalculateFromEntries() {
        let totalExpenses = 0;
        let totalRights = 0;
        let totalLiabilities = 0;
        let totalRightsCollected = 0;
        let totalLiabilitiesPaid = 0;

        state.entries.forEach(entry => {
            const amount = Number(entry.amount || 0);

            switch (entry.type) {
                case "expense":
                    totalExpenses += amount;
                    break;
                case "right-add":
                    totalRights += amount;
                    break;
                case "right-collect":
                    totalRightsCollected += amount;
                    totalRights -= amount;
                    break;
                case "liability-add":
                    totalLiabilities += amount;
                    break;
                case "liability-pay":
                    totalLiabilitiesPaid += amount;
                    totalLiabilities -= amount;
                    break;
            }
        });

        state.totalExpenses = totalExpenses;
        state.totalRights = Math.max(totalRights, 0);
        state.totalLiabilities = Math.max(totalLiabilities, 0);
        state.totalRightsCollected = totalRightsCollected;
        state.totalLiabilitiesPaid = totalLiabilitiesPaid;

        // معادلة الرصيد الحالي:
        // الرصيد الحالي = الرصيد الابتدائي - المصروفات - المدفوع من الالتزامات + المحصل من الحقوق
        state.currentBalance =
            Number(state.initialBalance || 0) -
            state.totalExpenses -
            state.totalLiabilitiesPaid +
            state.totalRightsCollected;
    }

    function renderStats() {
        currentBalanceEl.textContent = formatNumber(state.currentBalance);
        totalExpensesEl.textContent = formatNumber(state.totalExpenses);
        totalRightsEl.textContent = formatNumber(state.totalRights);
        totalLiabilitiesEl.textContent = formatNumber(state.totalLiabilities);
        totalRightsCollectedEl.textContent = formatNumber(state.totalRightsCollected);
        totalLiabilitiesPaidEl.textContent = formatNumber(state.totalLiabilitiesPaid);

        initialBalanceInput.value =
            state.initialBalance !== null && state.initialBalance !== undefined
                ? state.initialBalance
                : "";
    }

    function renderTable() {
        entriesTableBody.innerHTML = "";

        state.entries.forEach((entry, index) => {
            const tr = document.createElement("tr");

            const tdIndex = document.createElement("td");
            tdIndex.textContent = index + 1;

            const tdDate = document.createElement("td");
            tdDate.textContent = entry.date || "";

            const tdDesc = document.createElement("td");
            tdDesc.textContent = entry.description || "";

            const tdType = document.createElement("td");
            const typeSpan = document.createElement("span");
            typeSpan.classList.add("tag");
            switch (entry.type) {
                case "expense":
                    typeSpan.classList.add("tag-expense");
                    typeSpan.textContent = "مصروف";
                    break;
                case "right-add":
                    typeSpan.classList.add("tag-right");
                    typeSpan.textContent = "إضافة حق";
                    break;
                case "right-collect":
                    typeSpan.classList.add("tag-right");
                    typeSpan.textContent = "تحصيل حق";
                    break;
                case "liability-add":
                    typeSpan.classList.add("tag-liability");
                    typeSpan.textContent = "إضافة التزام";
                    break;
                case "liability-pay":
                    typeSpan.classList.add("tag-liability");
                    typeSpan.textContent = "دفع التزام";
                    break;
                default:
                    typeSpan.textContent = entry.type;
            }
            tdType.appendChild(typeSpan);

            const tdAmount = document.createElement("td");
            tdAmount.textContent = formatNumber(entry.amount);

            const tdNote = document.createElement("td");
            tdNote.textContent = entry.note || "";

            const tdActions = document.createElement("td");
            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "حذف";
            deleteBtn.className = "btn btn-danger btn-sm";
            deleteBtn.addEventListener("click", () => {
                if (confirm("هل أنت متأكد من حذف هذه العملية؟")) {
                    state.entries.splice(index, 1);
                    recalculateFromEntries();
                    renderStats();
                    renderTable();
                    saveState();
                }
            });
            tdActions.appendChild(deleteBtn);

            tr.appendChild(tdIndex);
            tr.appendChild(tdDate);
            tr.appendChild(tdDesc);
            tr.appendChild(tdType);
            tr.appendChild(tdAmount);
            tr.appendChild(tdNote);
            tr.appendChild(tdActions);

            entriesTableBody.appendChild(tr);
        });
    }

    function updateUI() {
        recalculateFromEntries();
        renderStats();
        renderTable();
    }

    // ============================
    //  التعامل مع النموذج
    // ============================
    function handleAddEntry() {
        const description = descriptionInput.value.trim();
        const type = typeSelect.value;
        const amount = parseFloat(amountInput.value);
        const date = dateInput.value;
        const note = noteInput.value.trim();

        if (!type || isNaN(amount) || amount <= 0) {
            alert("الرجاء إدخال مبلغ صحيح واختيار نوع العملية.");
            return;
        }

        // إذا أدخل المستخدم رصيد ابتدائي جديد، نحدّثه
        const initialBalanceValue = parseFloat(initialBalanceInput.value);
        if (!isNaN(initialBalanceValue)) {
            state.initialBalance = initialBalanceValue;
        }

        const entry = {
            id: Date.now(),
            description,
            type,
            amount,
            date,
            note
        };

        state.entries.push(entry);
        updateUI();
        saveState();
        resetForm(false);
    }

    function resetForm(resetInitialBalance = false) {
        descriptionInput.value = "";
        typeSelect.value = "expense";
        amountInput.value = "";
        noteInput.value = "";
        const today = new Date().toISOString().split("T")[0];
        dateInput.value = today;

        if (resetInitialBalance) {
            initialBalanceInput.value = "";
        }
    }

    function handleClearData() {
        if (!confirm("سيتم حذف جميع البيانات نهائياً من هذا المتصفح، هل أنت متأكد؟")) {
            return;
        }
        state = {
            initialBalance: 0,
            currentBalance: 0,
            totalExpenses: 0,
            totalRights: 0,
            totalLiabilities: 0,
            totalRightsCollected: 0,
            totalLiabilitiesPaid: 0,
            entries: []
        };
        saveState();
        updateUI();
        resetForm(true);
    }

    // ============================
    //  التصدير إلى CSV (Excel)
    // ============================
    function exportToCsv() {
        if (!state.entries.length) {
            alert("لا توجد عمليات لتصديرها.");
            return;
        }

        const header = [
            "التاريخ",
            "الوصف",
            "النوع",
            "المبلغ",
            "ملاحظة"
        ];

        const rows = state.entries.map(entry => {
            let typeLabel = "";
            switch (entry.type) {
                case "expense":
                    typeLabel = "مصروف";
                    break;
                case "right-add":
                    typeLabel = "إضافة حق";
                    break;
                case "right-collect":
                    typeLabel = "تحصيل حق";
                    break;
                case "liability-add":
                    typeLabel = "إضافة التزام";
                    break;
                case "liability-pay":
                    typeLabel = "دفع التزام";
                    break;
                default:
                    typeLabel = entry.type;
            }

            return [
                entry.date || "",
                entry.description || "",
                typeLabel,
                entry.amount || 0,
                entry.note || ""
            ];
        });

        const allRows = [header, ...rows];
        const csvContent = allRows
            .map(r =>
                r
                    .map(field => `"${String(field).replace(/"/g, '""')}"`)
                    .join(",")
            )
            .join("\r\n");

        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });

        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        const now = new Date();
        const fileName = `ledger_${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}.csv`;
        link.download = fileName;
        link.click();
        URL.revokeObjectURL(url);
    }

    // ============================
    //  التصدير إلى PDF
    // ============================
    function exportToPdf() {
        if (!state.entries.length) {
            alert("لا توجد عمليات لتصديرها.");
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
            orientation: "landscape",
            unit: "pt",
            format: "a4"
        });

        const margin = 40;
        let y = margin;

        doc.setFontSize(14);
        doc.text("دفتر المصروفات والحقوق والالتزامات", 300, y, { align: "center" });
        y += 25;

        doc.setFontSize(10);
        const statsLines = [
            `الرصيد الحالي: ${formatNumber(state.currentBalance)}`,
            `إجمالي المصروفات: ${formatNumber(state.totalExpenses)}`,
            `إجمالي الحقوق المستحقة: ${formatNumber(state.totalRights)}`,
            `إجمالي الالتزامات الكلية: ${formatNumber(state.totalLiabilities)}`,
            `المحصل من الحقوق: ${formatNumber(state.totalRightsCollected)}`,
            `المدفوع من الالتزامات: ${formatNumber(state.totalLiabilitiesPaid)}`
        ];

        statsLines.forEach(line => {
            doc.text(line, margin, y);
            y += 14;
        });

        y += 10;

        doc.setFontSize(11);
        doc.text("سجل العمليات:", margin, y);
        y += 20;

        const headers = ["#", "التاريخ", "الوصف", "النوع", "المبلغ", "ملاحظة"];

        const colWidths = [25, 75, 180, 90, 80, 200];
        const startX = margin;
        let currentX = startX;

        // رسم العناوين
        headers.forEach((header, index) => {
            doc.text(header, currentX + 2, y);
            currentX += colWidths[index];
        });
        y += 15;

        // رسم حدود بسيطة
        doc.setLineWidth(0.2);
        doc.line(margin, y - 18, margin + colWidths.reduce((a, b) => a + b, 0), y - 18);

        state.entries.forEach((entry, i) => {
            if (y > 530) {
                doc.addPage();
                y = margin;
            }
            currentX = startX;
            const typeLabelMap = {
                "expense": "مصروف",
                "right-add": "إضافة حق",
                "right-collect": "تحصيل حق",
                "liability-add": "إضافة التزام",
                "liability-pay": "دفع التزام"
            };

            const row = [
                String(i + 1),
                entry.date || "",
                entry.description || "",
                typeLabelMap[entry.type] || entry.type,
                formatNumber(entry.amount || 0),
                entry.note || ""
            ];

            row.forEach((cell, index) => {
                const lines = doc.splitTextToSize(cell, colWidths[index] - 4);
                doc.text(lines, currentX + 2, y);
                currentX += colWidths[index];
            });

            y += 18;
        });

        const now = new Date();
        const fileName = `ledger_${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}.pdf`;
        doc.save(fileName);
    }

    // ============================
    //  ربط الأحداث
    // ============================
    addEntryBtn.addEventListener("click", function (e) {
        e.preventDefault();
        handleAddEntry();
    });

    resetFormBtn.addEventListener("click", function (e) {
        e.preventDefault();
        resetForm(true);
    });

    clearDataBtn.addEventListener("click", function (e) {
        e.preventDefault();
        handleClearData();
    });

    exportCsvBtn.addEventListener("click", function (e) {
        e.preventDefault();
        exportToCsv();
    });

    exportPdfBtn.addEventListener("click", function (e) {
        e.preventDefault();
        exportToPdf();
    });

    initialBalanceInput.addEventListener("change", function () {
        const val = parseFloat(initialBalanceInput.value);
        if (!isNaN(val)) {
            state.initialBalance = val;
            updateUI();
            saveState();
        }
    });

    // ============================
    //  تهيئة التطبيق
    // ============================
    function init() {
        loadState();
        // ضبط التاريخ على تاريخ اليوم كقيمة افتراضية
        const today = new Date().toISOString().split("T")[0];
        dateInput.value = state.entries.length ? "" : today;
        updateUI();
    }

    init();
</script>

</body>
</html>
