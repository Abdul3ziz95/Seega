<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ© | Smart Budget</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">

<style>
/* ---------------------------------------------------- */
/* Variables and Base Styling - LIGHT MODE (Default) */
/* ---------------------------------------------------- */
:root{
    --p: #0077b6; /* Primary Blue (Vibrant) */
    --s: #48cae4; /* Secondary Light Blue */
    --bg: #f7f9fc; /* Light Background */
    --danger: #ef476f; 
    --success: #2a9d8f;
    --warning: #fbc02d;
    --text-dark: #333;
    --text-light: #f7f9fc;
    --shadow-light: 0 4px 8px rgba(0, 0, 0, 0.08);
    --shadow-hover: 0 6px 15px rgba(0, 0, 0, 0.15);
    --card-bg: #fff;
    --input-bg: #fff;
    --border-color: #ddd;
    --tab-active-bg: #fff;
}

/* ---------------------------------------------------- */
/* Dark Mode Variables */
/* ---------------------------------------------------- */
body.dark-mode {
    --p: #90e0ef; /* Lighter Primary Blue for contrast */
    --s: #48cae4; 
    --bg: #1f1f1f; /* Dark Background */
    --danger: #ff8a80;
    --success: #66bb6a;
    --warning: #fbc02d;
    --text-dark: #e0e0e0; /* Light Text */
    --text-light: #1f1f1f;
    --shadow-light: 0 4px 10px rgba(0, 0, 0, 0.5);
    --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.8);
    --card-bg: #2d2d2d;
    --input-bg: #3c3c3c;
    --border-color: #555;
    --tab-active-bg: #2d2d2d;
}

/* ---------------------------------------------------- */
/* Global Reset and Base Styling */
/* ---------------------------------------------------- */
* {
    box-sizing: border-box;
}
body{
    margin:0;
    font-family: 'Tajawal', 'Arial', sans-serif;
    background: var(--bg);
    color: var(--text-dark);
    overflow-x: hidden;
    line-height: 1.6;
    transition: background 0.3s, color 0.3s;
}

/* Global Dark Mode Overrides for Specific Elements */
.card, .sidebar, .modal { background: var(--card-bg); }
.modal header { background: var(--card-bg); border-bottom: 1px solid var(--border-color); }

/* ---------------------------------------------------- */
/* Header & Navigation */
/* ---------------------------------------------------- */
header{
    background: var(--p);
    color: var(--text-light);
    padding: 15px;
    font-size: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-hover);
    position: sticky;
    top: 0;
    z-index: 10;
}
header .title { flex-grow: 1; text-align: center; font-weight: 800; }
header button {
    background: none; 
    border: none; 
    color: var(--text-light); 
    font-size: 20px; 
    cursor: pointer; 
    padding: 0 10px;
    transition: transform 0.2s;
}
header button:hover { transform: scale(1.1); }

.tabs{
    display:flex;
    background: var(--card-bg);
    border-bottom: 2px solid var(--border-color);
    box-shadow: var(--shadow-light);
    overflow-x: auto; 
    white-space: nowrap;
}
.tabs button{
    flex: 1 1 auto; 
    min-width: 0; 
    padding: 15px 10px;
    border:none;
    background: var(--card-bg);
    color: var(--text-dark);
    font-weight: 700;
    font-size: 14px;
    transition: all 0.3s;
    border-bottom: 3px solid transparent;
}
.tabs button.active{
    color: var(--p);
    border-bottom: 3px solid var(--p);
    background: color-mix(in srgb, var(--bg) 90%, var(--p)); 
}
body.dark-mode .tabs button.active {
    background: color-mix(in srgb, var(--bg) 85%, var(--p)); 
}

/* ---------------------------------------------------- */
/* General Layout & Cards */
/* ---------------------------------------------------- */
.section{ display:none; padding: 15px; }
.section.active{ display:block; }
.card{
    background:var(--card-bg);
    padding: 20px;
    border-radius: 15px;
    box-shadow: var(--shadow-light);
    margin-bottom: 15px;
    border-top: 5px solid var(--s); 
    transition: background 0.3s, border-color 0.3s;
}

/* ---------------------------------------------------- */
/* Overview Section Styling (New Dashboard) */
/* ---------------------------------------------------- */
#overview .balance-display {
    text-align: center;
    padding: 30px 20px;
    margin-bottom: 20px;
    border-radius: 15px;
    background: var(--card-bg);
    box-shadow: var(--shadow-hover);
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    align-items: center;
}
#overview .balance-display h2 {
    margin: 0 0 5px 0;
    font-size: 18px;
    color: #999;
}
#overview .balance-display p {
    font-size: 38px;
    font-weight: 800;
    margin: 5px 0 0 0;
    color: var(--p);
    display: flex;
    align-items: center;
}
#overview .balance-display button {
    background: none;
    border: none;
    color: var(--p);
    font-size: 24px;
    cursor: pointer;
    margin-right: 10px;
    transition: color 0.2s;
}
#overview .balance-display button:hover {
    color: var(--s);
}
#overview .balance-actions {
    display: flex;
    gap: 15px;
    margin-top: 10px;
}
#overview .balance-actions .action {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    color: var(--text-dark);
    border-radius: 10px;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-light);
    transition: all 0.2s;
    background: var(--input-bg);
}
#overview .balance-actions .action:hover {
    box-shadow: var(--shadow-hover);
    transform: translateY(-2px);
    border-color: var(--p);
}
#overview .balance-actions .action i {
    font-size: 24px;
    margin-bottom: 5px;
}
#overview .balance-actions .deposit i { color: var(--success); }
#overview .balance-actions .withdraw i { color: var(--danger); }

/* ---------------------------------------------------- */
/* Form Elements & Inputs */
/* ---------------------------------------------------- */
input, select, .datetime-container input[type="datetime-local"] {
    width: 100%;
    padding: 14px;
    margin: 8px 0;
    font-size: 16px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    box-sizing: border-box;
    background: var(--input-bg);
    color: var(--text-dark);
    transition: all 0.3s;
}
input:focus, select:focus, .datetime-container input[type="datetime-local"]:focus {
    border-color: var(--s);
    box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.2);
    outline: none;
}
body.dark-mode input:focus, body.dark-mode select:focus, body.dark-mode .datetime-container input[type="datetime-local"]:focus {
    box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.3);
}

.datetime-container { position: relative; width: 100%; margin: 8px 0; }
.datetime-container input[type="datetime-local"] { margin: 0; padding-left: 40px; }

.calendar-icon {
    position: absolute;
    top: 50%;
    left: 15px; 
    transform: translateY(-50%);
    font-size: 1.4em;
    z-index: 2;
    pointer-events: none; 
    color: var(--p); 
}

/* ---------------------------------------------------- */
/* Buttons & Actions */
/* ---------------------------------------------------- */
button.action{
    background: var(--p);
    color: var(--text-light);
    border: none;
    padding: 16px;
    width: 100%;
    border-radius: 10px;
    font-size: 18px;
    font-weight: bold;
    margin-top: 10px;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
    box-shadow: var(--shadow-light);
}
button.action:hover{
    background: color-mix(in srgb, var(--p) 85%, black); 
    transform: translateY(-2px);
}

button.secondary{
    background: var(--input-bg);
    color: var(--text-dark);
    padding: 12px;
    width: 100%;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    margin-top: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s;
}
button.secondary:hover {
    background: color-mix(in srgb, var(--input-bg) 80%, #999); 
}

/* ---------------------------------------------------- */
/* Utility & Custom Elements */
/* ---------------------------------------------------- */
.toast{
    position:fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: var(--text-light);
    padding: 12px 25px;
    border-radius: 30px;
    display:none;
    z-index: 100;
    font-size: 15px;
    box-shadow: var(--shadow-hover);
    white-space: nowrap;
}

.currency-symbol { color: var(--p); font-weight: bold; font-size: 1.1em; margin-right: 5px; }
.hidden-balance { font-size: 38px; font-weight: 800; letter-spacing: 5px; color: var(--p); }

/* ---------------------------------------------------- */
/* Modals and Sidebar Refinements */
/* ---------------------------------------------------- */
.modal{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background: var(--bg);
    display:none;
    flex-direction:column;
    z-index: 30;
    overflow-y: auto;
}
.modal header{
    display:flex;
    gap: 10px;
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    background: var(--card-bg);
    align-items: center;
    box-shadow: var(--shadow-light);
    position: sticky;
    top: 0;
    z-index: 35;
}
.modal header .title { flex-grow: 1; text-align: center; font-weight: 700; }
.modal header button {
    background: none; 
    border: none; 
    color: var(--text-dark); 
    font-size: 20px; 
    cursor: pointer; 
    padding: 0 10px;
}
.modal-content {
    flex-grow: 1;
    padding: 15px;
}

.sidebar {
    position: fixed;
    top: 0;
    right: 0; 
    width: 300px; 
    max-width: 85%;
    height: 100%;
    background: var(--card-bg);
    box-shadow: -4px 0 12px rgba(0, 0, 0, 0.2);
    transform: translateX(100%); 
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
    z-index: 25; 
    display: flex;
    flex-direction: column;
}
.sidebar.open { transform: translateX(0); }

/* Switch Style (Dark Mode) */
.switch-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    font-size: 17px;
    color: var(--text-dark);
}
.switch { position: relative; display: inline-block; width: 45px; height: 25px; }
.switch input {opacity: 0; width: 0; height: 0;}
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: var(--border-color); transition: .4s; border-radius: 25px;
}
.slider:before {
    position: absolute; content: ""; height: 19px; width: 19px; left: 3px; bottom: 3px;
    background-color: white; transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: var(--p); }
input:checked + .slider:before { transform: translateX(20px); }


/* Sidebar */
.sidebar-header {
    padding: 15px;
    background: var(--p);
    color: var(--text-light);
    font-size: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
}
.sidebar-content {
    flex-grow: 1;
    padding: 15px 0;
    overflow-y: auto;
}

.sidebar-menu-item {
    padding: 15px 20px;
    margin: 5px 0;
    display: flex;
    align-items: center;
    justify-content: space-between; 
    gap: 15px;
    font-size: 17px;
    color: var(--text-dark);
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
}

.sidebar-menu-item:hover {
    background: var(--s);
    color: var(--text-dark); 
}
.sidebar-menu-item i { font-size: 1.2em; }

.sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    z-index: 24;
}
.sidebar-overlay.open { display: block; }

/* Small Image Source Modal */
#imageSourceModal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80%;
    max-width: 350px;
    height: auto;
    background: var(--card-bg);
    border-radius: 15px;
    box-shadow: var(--shadow-hover);
    padding: 20px;
    z-index: 150;
    display: none;
    flex-direction: column;
    align-items: center;
}
#imageSourceModal h3 {
    margin-top: 0;
    color: var(--p);
    text-align: center;
}
#imageSourceModal button {
    margin: 10px 0;
    padding: 15px;
    font-size: 16px;
    border-radius: 10px;
    width: 100%;
}

/* Toast Animation */
.toast.show{
    display:block;
    animation: fadeInOut 2.5s ease-in-out forwards;
}

@keyframes fadeInOut {
    0% { opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { opacity: 0; }
}

/* List Item */
.list-item{
    background: var(--card-bg);
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    border-right: 5px solid var(--s); 
    color: var(--text-dark);
}
.list-item:hover {
    background: color-mix(in srgb, var(--card-bg) 95%, #999);
    box-shadow: var(--shadow-light);
}
.list-item .details {
    font-size: 0.9em; 
    color: #666; 
    text-align: right;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 5px;
}

/* ---------------------------------------------------- */
/* Responsive Fix for Tabs (Small Screens) */
/* ---------------------------------------------------- */
@media (max-width: 450px) {
    .tabs button {
        padding: 15px 5px; 
        font-size: 13px; 
    }
}
</style>
</head>

<body onload="initApp()">

<header>
    <button onclick="openSidebar()"><i class="fas fa-bars"></i></button> 
    <span class="title">Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</span>
    <button style="visibility: hidden;"><i class="fas fa-search"></i></button> 
</header>

<div class="tabs">
    <button class="active" onclick="openTab('overview')">
        <i class="fas fa-tachometer-alt" style="margin-left: 5px;"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©
    </button>
    <button onclick="openTab('expenses')">
        <i class="fas fa-money-bill-wave" style="margin-left: 5px;"></i> Ù…ØµØ±ÙˆÙØ§Øª
    </button>
    <button onclick="openTab('rights')">
        <i class="fas fa-handshake" style="margin-left: 5px;"></i> Ø­Ù‚ÙˆÙ‚
    </button>
    <button onclick="openTab('debts')">
        <i class="fas fa-file-invoice" style="margin-left: 5px;"></i> Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    </button>
</div>

<div id="overview" class="section active">
    <div class="balance-display">
        <h2>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
        <p id="currentBalanceDisplay">
            <i class="fas fa-spinner fa-spin"></i>
        </p>
        <button onclick="toggleBalanceVisibility()" id="balanceVisibilityToggle" title="Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±ØµÙŠØ¯">
             <i class="fas fa-eye"></i>
        </button>
    </div>

    <div class="balance-actions">
        <button class="action deposit" onclick="openBalanceActionModal('deposit')">
            <i class="fas fa-plus-circle"></i> Ø¥ÙŠØ¯Ø§Ø¹
        </button>
        <button class="action withdraw" onclick="openBalanceActionModal('withdraw')">
            <i class="fas fa-minus-circle"></i> Ø³Ø­Ø¨
        </button>
    </div>
    
    <button class="secondary" onclick="openBalanceLogModal()" style="margin-top: 15px;">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯
    </button>
    <div class="card" style="margin-top: 20px; border-top: 5px solid var(--p);">
        <h3 style="color: var(--p); margin-top: 0;"><i class="fas fa-calculator" style="margin-left: 5px;"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
        <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (ØªØ´Ù…Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª):</span> <b id="sExpTotal">0</b></p>
        <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©:</span> <b id="sRigTotal">0</b></p>
        <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©:</span> <b id="sDebTotal">0</b></p>
        <p><span>Ø§Ù„Ù…Ø­ØµÙ„ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ‚:</span> <b id="sRigPaid">0</b></p>
        <p><span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª:</span> <b id="sDebPaid">0</b></p>
    </div>
</div>

<div id="expenses" class="section">
    <div class="card">
    <p style="color: var(--danger); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡Ø§ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙˆØ±Ø§Ù‹</p>
    <input id="eAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
    <select id="eType">
    <option value="">ğŸ›’ Ø§Ù„ÙØ¦Ø© (Ù†ÙÙ‚Ø§Øª Ù…ØªØºÙŠØ±Ø©)</option>
    <option>Ø·Ø¹Ø§Ù…</option><option>Ù…ÙˆØ§ØµÙ„Ø§Øª</option>
    <option>Ø±Ø¹Ø§ÙŠØ© Ø´Ø®ØµÙŠØ©</option><option>Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
    <option>ØµØ­Ø©</option><option>ØªØ±ÙÙŠÙ‡</option><option>ØªØ³ÙˆÙ‚</option>
    <option>ØªØ¹Ù„ÙŠÙ…</option><option>ØµÙŠØ§Ù†Ø© ÙˆØ¥ØµÙ„Ø§Ø­</option><option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="eDesc" placeholder="ğŸ“ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
    <div class="datetime-container">
        <input id="eDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    
    <button class="secondary" onclick="showImageSourceModal()">
        <i class="fas fa-camera" style="margin-left: 5px;"></i> Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    </button>
    <span id="eImgName" style="display: block; font-size: 0.8em; color: var(--success); text-align: right; margin-top: 5px;"></span>
    <input type="file" id="eImgCamera" accept="image/*" capture="camera" style="display: none;" onchange="updateFileName(this, 'eImgName')">
    <input type="file" id="eImgGallery" accept="image/*" style="display: none;" onchange="updateFileName(this, 'eImgName')">
    <button class="action" onclick="addExpense()">
        <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ
    </button>
    <button class="secondary" onclick="openLog('exp')">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
    </button>
    </div>
</div>

<div id="rights" class="section">
    <div class="card">
    <p style="color: var(--success); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„Ø© (Ø¯ÙØ¹ Ø§Ù„Ø¯ÙŠÙ†/Ø§Ù„Ø¢Ø¬Ù„) ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
    <select id="rType" onchange="updateRightFields(this.value)">
    <option value="">ğŸ¤ Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚</option>
    <option>Ø¯ÙŠÙ†</option>
    <option>Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„</option>
    <option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="rAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚ (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ)" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
    <div id="rDynamicFields"></div>
    <input id="rDesc" placeholder="ğŸ‘¤ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ù„Ù…Ø¯ÙŠÙ†/Ø§Ù„Ø¬Ù‡Ø©)">
    <div class="datetime-container">
        <input id="rDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    <select id="rStatus">
    <option value="">âœ… Ø§Ù„Ø­Ø§Ù„Ø©</option>
    <option value="ÙƒØ§Ù…Ù„">Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</option>
    <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ Ø¨Ø¹Ø¯</option>
    </select>
    <button class="action" onclick="addRight()">
        <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ø­Ù‚
    </button>
    <button class="secondary" onclick="openLog('rig')">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ‚
    </button>
    </div>
</div>

<div id="debts" class="section">
    <div class="card">
    <p style="color: var(--danger); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø¯ÙØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
    <select id="dType" onchange="updateDebtFields(this.value)">
    <option value="">ğŸ§¾ Ù†ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</option>
    <option>Ø¥ÙŠØ¬Ø§Ø±</option>
    <option>ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
    <option>Ù…Ø§Ø¡</option>
    <option>Ø¥Ù†ØªØ±Ù†Øª</option>
    <option>Ù‚Ø±Ø¶</option> <option>Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ</option> <option>Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø© Ø£Ø®Ø±Ù‰</option>
    <option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="dAmount" type="text" placeholder="ğŸ’µ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©/Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">

    <div id="dDynamicFields"></div>
    <input id="dDesc" placeholder="ğŸ¢ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ù„Ø¯Ø§Ø¦Ù†/Ø§Ù„Ø¬Ù‡Ø©)">
    <div class="datetime-container">
        <input id="dDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    <select id="dStatus">
    <option value="">âœ… Ø§Ù„Ø­Ø§Ù„Ø©</option>
    <option value="Ù…Ø¯ÙÙˆØ¹">Ù…Ø¯ÙÙˆØ¹</option>
    <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
    </select>
    <button class="action" onclick="addDebt()">
        <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…
    </button>
    <button class="secondary" onclick="openLog('deb')">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    </button>
    </div>
</div>

<div class="modal" id="logModal">
    <header>
        <input id="search" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„..." oninput="renderLog()">
        <button onclick="closeLayer('log')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content" id="logContent"></div>
</div>

<div class="modal" id="detailModal">
    <header>
        <span class="title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</span>
        <button onclick="closeLayer('detail')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content detail" id="detailContent"></div>
</div>

<div class="modal" id="balanceActionModal">
    <header>
        <span class="title" id="actionModalTitle"></span>
        <button onclick="closeLayer('balanceAction')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <p style="text-align: center; font-size: 1.1em;">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="currentBalanceInAction" style="color: var(--p); font-weight: bold;"></span></p>
        <input id="bAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
        <input id="bDesc" placeholder="ğŸ“ ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Ù…Ø«Ù„: Ø±Ø§ØªØ¨ØŒ ØªØ­ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ)">
        <div class="datetime-container">
            <input id="bDate" type="datetime-local">
            <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
        </div>
        <button class="action" onclick="processBalanceAction()">
            <i class="fas fa-check" style="margin-left: 5px;"></i> ØªÙ†ÙÙŠØ°
        </button>
    </div>
</div>

<div class="modal" id="balanceLogModal">
    <header>
        <span class="title">Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯</span>
        <button onclick="closeLayer('balanceLog')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content" id="balanceLogContent">
        </div>
</div>

<div id="imageSourceModal">
    <h3 style="margin-bottom: 20px;">Ø§Ø®ØªÙŠØ§Ø± Ù…ØµØ¯Ø± Ø§Ù„ØµÙˆØ±Ø©</h3>
    <button class="action" onclick="openCameraInput()"><i class="fas fa-camera" style="margin-left: 10px;"></i> Ø§Ù„ØªÙ‚Ø§Ø· Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
    <button class="secondary" onclick="openGalleryInput()"><i class="fas fa-images" style="margin-left: 10px;"></i> Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ø¶</button>
    <button class="secondary" style="background: none; border: none; color: var(--danger); margin-top: 10px;" onclick="closeLayer('imageSource')">Ø¥Ù„ØºØ§Ø¡</button>
</div>
<div class="sidebar-overlay" id="imageSourceOverlay" style="z-index: 140; display: none;" onclick="closeLayer('imageSource')"></div>

<div class="toast" id="toast"></div>

<div class="sidebar-overlay" onclick="closeLayer('sidebar')"></div>

<div class="sidebar" id="appSidebar">
    <div class="sidebar-header">
        <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        <button onclick="closeLayer('sidebar')"><i class="fas fa-times"></i></button>
    </div>
    <div class="sidebar-content">
        <div class="card" style="margin: 0 15px 15px; border-top: 5px solid var(--s);">
             <p style="font-weight: bold; margin-top: 0; color: var(--p);">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</p>
             
             <div class="switch-container">
                 <i class="fas fa-moon" style="margin-left: 10px;"></i> <span>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span>
                 <label class="switch">
                     <input type="checkbox" id="darkModeToggle" onclick="toggleDarkMode()">
                     <span class="slider"></span>
                 </label>
             </div>
             
             <button class="secondary" onclick="openCurrencyModal()" style="display: flex; justify-content: space-between; align-items: center; border: none; background: var(--card-bg); margin-top: 15px;">
                 <span id="currentCurrencyDisplay" style="font-weight: bold;">Ø§Ù„Ø¹Ù…Ù„Ø©: Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ (Ø±.Ø³)</span>
                 <span style="color: var(--p);"><i class="fas fa-exchange-alt"></i> ØªØºÙŠÙŠØ±</span>
             </button>
        </div>
        
        <div class="sidebar-menu-item" onclick="exportData()">
            <i class="fas fa-file-export"></i> <span>ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</span>
        </div>
        
        <div class="sidebar-menu-item" onclick="document.getElementById('importFile').click()">
            <i class="fas fa-file-import"></i> <span>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</span>
        </div>
        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
        
        <div class="sidebar-menu-item" onclick="openAboutModal()">
            <i class="fas fa-info-circle"></i> <span>Ø­ÙˆÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>
        </div>
        
        <div class="sidebar-menu-item" onclick="confirmResetData()" style="color: var(--danger);">
            <i class="fas fa-exclamation-triangle"></i> <span>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        </div>
    </div>
</div>

<div class="modal" id="aboutModal">
    <header>
        <h3 style="color: var(--p);">Ø­ÙˆÙ„ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ©</h3>
        <button onclick="closeLayer('about')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <p>ØªØ·Ø¨ÙŠÙ‚ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© Ù‡Ùˆ Ø£Ø¯Ø§Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ ØªØªØ¨Ø¹:</p>
        <ul>
            <li><i class="fas fa-wallet" style="color: var(--s);"></i> **Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø©** Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.</li>
            <li><i class="fas fa-receipt" style="color: var(--s);"></i> **Ø§Ù„Ø­Ù‚ÙˆÙ‚** Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ù„Ùƒ (Ø¯ÙŠÙˆÙ†ØŒ Ø¨ÙŠØ¹ Ø¢Ø¬Ù„).</li>
            <li><i class="fas fa-clipboard-list" style="color: var(--s);"></i> **Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª** Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ø¹Ù„ÙŠÙƒ (ÙÙˆØ§ØªÙŠØ±ØŒ Ø£Ù‚Ø³Ø§Ø·ØŒ Ù‚Ø±ÙˆØ¶).</li>
        </ul>
        <p class="card" style="border-top: 3px solid var(--danger);">
            <strong>Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©:</strong> ÙŠØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ© IndexedDBØŒ ÙˆÙ„Ø§ ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ø£ÙŠ Ø®Ø§Ø¯Ù… Ø®Ø§Ø±Ø¬ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ.
        </p>
        <p style="text-align: center; margin-top: 20px; color: #999; font-size: 0.9em;">Ø§Ù„Ø¥ØµØ¯Ø§Ø± 3.2 (Ù…Ø·ÙˆØ± ÙˆÙ…Ø«Ø¨Øª)</p>
    </div>
</div>

<div class="modal" id="currencyModal">
    <header>
        <h3 style="color: var(--p);">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø©</h3>
        <button onclick="closeLayer('currency')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <input id="currencySearch" type="text" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„Ø© (Ø±ÙŠØ§Ù„ØŒ Ø¬Ù†ÙŠÙ‡ØŒ Ø¯ÙˆÙ„Ø§Ø±...)" oninput="renderCurrencyList()">
        <div id="currencyList">
            </div>
    </div>
</div>

<script>
// ===================================================
// 1. Ø¥Ø¹Ø¯Ø§Ø¯ IndexedDB ÙˆÙ…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Øª
// ===================================================

const IDB_NAME = "MySmartBudgetDB";
const IDB_VERSION = 4;
const STORE_NAMES = ["exp", "rig", "deb", "bal"]; 
let db = { exp: [], rig: [], deb: [], bal: { clientId: 1, amount: 0, changes: [] } }; 
let IDB_connection = null; 

// Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
let currentLog = "", editMode = null, balanceActionType = null;
let currentBalance = 0; 
let balanceHidden = localStorage.getItem('balanceHidden') === 'true'; 

// Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ù‚Ù„
const LAYERS = {
    'sidebar': { elementId: 'appSidebar', type: 'menu' },
    'log': { elementId: 'logModal', type: 'modal' },
    'detail': { elementId: 'detailModal', type: 'modal' },
    'currency': { elementId: 'currencyModal', type: 'modal' },
    'about': { elementId: 'aboutModal', type: 'modal' },
    'balanceAction': { elementId: 'balanceActionModal', type: 'modal' },
    'balanceLog': { elementId: 'balanceLogModal', type: 'modal' }, 
    'imageSource': { elementId: 'imageSourceModal', type: 'menu' } 
};
let historyStack = []; 

const ARABIC_CURRENCIES = [
    { code: 'SAR', symbol: 'Ø±.Ø³', name: 'Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ' },
    { code: 'EGP', symbol: 'Ø¬.Ù…', name: 'Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ' },
    { code: 'AED', symbol: 'Ø¯.Ø¥', name: 'Ø¯Ø±Ù‡Ù… Ø¥Ù…Ø§Ø±Ø§ØªÙŠ' },
    { code: 'KWD', symbol: 'Ø¯.Ùƒ', name: 'Ø¯ÙŠÙ†Ø§Ø± ÙƒÙˆÙŠØªÙŠ' },
    { code: 'USD', symbol: '$', name: 'Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ' },
    { code: 'QAR', symbol: 'Ø±.Ù‚', name: 'Ø±ÙŠØ§Ù„ Ù‚Ø·Ø±ÙŠ' },
    { code: 'OMR', symbol: 'Ø±.Ø¹.', name: 'Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ' },
    { code: 'JOD', symbol: 'Ø¯.Ø§', name: 'Ø¯ÙŠÙ†Ø§Ø± Ø£Ø±Ø¯Ù†ÙŠ' },
    { code: 'EUR', symbol: 'â‚¬', name: 'ÙŠÙˆØ±Ùˆ' },
];

let currentCurrency = ARABIC_CURRENCIES.find(c => c.code === (localStorage.getItem('currencyCode') || 'SAR'));

// ===================================================
// 2. ÙˆØ¸Ø§Ø¦Ù IndexedDB ÙˆØ§Ù„Ø­ÙØ¸ (Ù…Ø­Ø¯Ø«Ø© ÙˆÙ…Ø¹Ø²Ø²Ø©)
// ===================================================

function initDB() {
  return new Promise((resolve, reject) => {
    if (!window.indexedDB) {
        toastMsg("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… IndexedDB. Ù„Ù† ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
        return reject(new Error("IndexedDB not supported."));
    }

    const request = indexedDB.open(IDB_NAME, IDB_VERSION);

    request.onerror = (e) => {
      console.error("IndexedDB error:", e.target.error);
      reject(e.target.error);
    };

    request.onupgradeneeded = (e) => {
      IDB_connection = e.target.result;
      STORE_NAMES.forEach(storeName => {
        if (IDB_connection.objectStoreNames.contains(storeName)) {
            IDB_connection.deleteObjectStore(storeName); 
        }
        
        const keyPath = (storeName === 'bal') ? 'clientId' : 'id'; 
        const autoIncrement = (storeName !== 'bal'); 
        const store = IDB_connection.createObjectStore(storeName, { keyPath: keyPath, autoIncrement: autoIncrement });

        if(storeName === 'bal') {
            store.add({ clientId: 1, amount: 0, changes: [] });
        }
      });
    };

    request.onsuccess = (e) => {
      IDB_connection = e.target.result;
      resolve(IDB_connection);
      loadAllData().then(() => {
        updateStats();
        updateBalanceDisplay();
      });
    };
  });
}

function saveData(storeName, data) {
    return new Promise((resolve, reject) => {
        if (!IDB_connection) return reject(new Error("Database not connected."));
        const transaction = IDB_connection.transaction([storeName], "readwrite");
        const store = transaction.objectStore(storeName);
        const request = store.put(data);
        request.onsuccess = () => resolve(request.result);
        request.onerror = (e) => reject(e.target.error);
    });
}

function deleteFromDB(storeName, id) {
    return new Promise((resolve, reject) => {
        if (!IDB_connection) return reject(new Error("Database not connected."));
        const transaction = IDB_connection.transaction([storeName], "readwrite");
        const store = transaction.objectStore(storeName);
        const request = store.delete(id);
        request.onsuccess = () => resolve();
        request.onerror = (e) => reject(e.target.error);
    });
}

function loadStoreData(storeName) {
    return new Promise((resolve) => {
        if (!IDB_connection) return resolve([]);
        const transaction = IDB_connection.transaction([storeName], "readonly");
        const store = transaction.objectStore(storeName);
        const request = store.getAll();
        request.onsuccess = (e) => {
            if(storeName === 'bal') {
                const result = e.target.result[0];
                return resolve(result || { clientId: 1, amount: 0, changes: [] });
            }
            // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨ØªØ±ØªÙŠØ¨ Ø¹ÙƒØ³ÙŠ (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
            resolve(e.target.result.reverse());
        };
        request.onerror = () => resolve(storeName === 'bal' ? { clientId: 1, amount: 0, changes: [] } : []);
    });
}

async function loadAllData() {
    const [expData, rigData, debData, balData] = await Promise.all([
        loadStoreData('exp'),
        loadStoreData('rig'),
        loadStoreData('deb'),
        loadStoreData('bal'),
    ]);
    db.exp = expData;
    db.rig = rigData;
    db.deb = debData;
    db.bal = balData;
    currentBalance = db.bal.amount || 0;
}

// ===================================================
// 3. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆØ§Ù„Ù…Ù„Ø§Ø­ÙŠØ© (Ø§Ù„Ù…ÙØ­Ø¯Ù‘Ø«Ø©)
// ===================================================

function formatNumber(num) {
    if (num === null || num === undefined) return '';
    if (typeof num === 'string') {
        num = parseFloat(num.replace(/,/g, ''));
    }
    if (isNaN(num)) return '';
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… toLocaleString Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ù‚Ù… ÙˆØ¥Ø²Ø§Ù„Ø© Ø§Ù„ÙÙˆØ§ØµÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØºÙŠØ± Ø¶Ø±ÙˆØ±ÙŠØ©
    const formatted = num.toLocaleString('en-US', {
        minimumFractionDigits: (num % 1 !== 0) ? 2 : 0, // Ø¹Ø±Ø¶ Ø±Ù‚Ù…ÙŠÙ† Ø¹Ø´Ø±ÙŠÙŠÙ† ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ø¯Ø¯ Ø¹Ø´Ø±ÙŠ
        maximumFractionDigits: 2
    });
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙÙˆØ§ØµÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­Ø§Ù‹ (Ù„Ø¶Ù…Ø§Ù† Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­)
    return formatted.replace(/,/g, ''); 
}

function formatAmount(input) {
    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø±Ù…ÙˆØ² Ø£Ùˆ Ø£Ø­Ø±Ù ØºÙŠØ± Ø±Ù‚Ù…ÙŠØ© Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø¹Ø´Ø±ÙŠØ©
    let value = input.value.replace(/[^\d.]/g, '');
    
    // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù†Ù‚Ø·Ø© Ø¹Ø´Ø±ÙŠØ© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
    const parts = value.split('.');
    if (parts.length > 2) {
        value = parts[0] + '.' + parts.slice(1).join('');
    }
    
    // Ù‚ØµØ± Ø§Ù„Ø¹Ø¯Ø¯ Ø¹Ù„Ù‰ Ø®Ø§Ù†ØªÙŠÙ† Ø¹Ø´Ø±ÙŠØªÙŠÙ† Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ù‚Ø·Ø©
    if (parts.length === 2 && parts[1].length > 2) {
        parts[1] = parts[1].substring(0, 2);
        value = parts[0] + '.' + parts[1];
    }
    
    input.value = value;
}

function formatCurrency(amount) {
    const num = parseFloat(amount);
    if (isNaN(num)) return '0 ' + currentCurrency.symbol;
    
    const formatted = num.toLocaleString('ar-SA', {
        minimumFractionDigits: (num % 1 !== 0) ? 2 : 0,
        maximumFractionDigits: 2
    });
    
    return `${formatted} <span class="currency-symbol">${currentCurrency.symbol}</span>`;
}

function toastMsg(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => {
        toast.classList.remove('show');
    }, 2500);
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¶Ø¨Ø· Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
function getCurrentDateTimeLocal() {
    const now = new Date();
    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ù„ÙŠØªÙˆØ§ÙÙ‚ Ù…Ø¹ ØµÙŠØºØ© input[type="datetime-local"] (YYYY-MM-DDTHH:MM)
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    
    return `${year}-${month}-${day}T${hours}:${minutes}`;
}


// **ØªØ¹Ø¯ÙŠÙ„: Ø¯Ø§Ù„Ø© Ø¥ÙØ±Ø§Øº Ø§Ù„Ø­Ù‚ÙˆÙ„ (ØªÙØ±ÙŠØº Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙÙˆØ±Ø§ - Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ ÙˆØ§Ù„Ø«Ø§Ù„Ø«)**
function clearFields() {
    // Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (Expenses)
    document.getElementById('eAmount').value = '';
    document.getElementById('eType').value = '';
    document.getElementById('eDesc').value = '';
    document.getElementById('eDate').value = getCurrentDateTimeLocal();
    document.getElementById('eImgName').textContent = '';
    
    // Ø§Ù„Ø­Ù‚ÙˆÙ‚ (Rights)
    document.getElementById('rType').value = '';
    document.getElementById('rAmount').value = '';
    document.getElementById('rDesc').value = '';
    document.getElementById('rDate').value = getCurrentDateTimeLocal();
    document.getElementById('rStatus').value = '';
    // ÙŠØ¬Ø¨ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ù„ØªÙ†Ø¸ÙŠÙ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·/Ø§Ù„ØªØ³Ø¯ÙŠØ¯
    if (typeof updateRightFields === 'function') { updateRightFields(''); }

    // Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª (Debts)
    document.getElementById('dType').value = '';
    document.getElementById('dAmount').value = '';
    document.getElementById('dDesc').value = '';
    document.getElementById('dDate').value = getCurrentDateTimeLocal();
    document.getElementById('dStatus').value = '';
    // ÙŠØ¬Ø¨ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ù„ØªÙ†Ø¸ÙŠÙ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
    if (typeof updateDebtFields === 'function') { updateDebtFields(''); }
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ clearFields Ù…Ù† openTab Ø£ÙŠØ¶Ø§Ù‹)
    editMode = null; 
}


// **ØªØ¹Ø¯ÙŠÙ„: Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ (Ù„Ø¶Ù…Ø§Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ - Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø«Ø§Ù„Ø«)**
function openTab(id, keepEditMode = false) {
    const sections = document.querySelectorAll('.section');
    sections.forEach(section => {
        section.classList.remove('active');
    });
    document.getElementById(id).classList.add('active');

    const tabs = document.querySelectorAll('.tabs button');
    tabs.forEach(tab => {
        tab.classList.remove('active');
    });
    const activeTab = document.querySelector(`.tabs button[onclick*="openTab('${id}')"]`);
    if (activeTab) {
        activeTab.classList.add('active');
    }

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„ØºØ±Ø¶ Ù‡Ùˆ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ø£ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ø¹Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯)
    if (!keepEditMode) { 
        editMode = null; 
        clearFields(); // ÙŠØªÙ… Ø¥ÙØ±Ø§Øº Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    }
}

function _visualOpen(layerName, data = {}) {
    const layer = LAYERS[layerName];
    if (!layer) return;
    const element = document.getElementById(layer.elementId);

    if (layer.type === 'modal') {
        element.style.display = 'flex';
        if (layerName === 'log') {
            currentLog = data.logType;
            renderLog();
        } else if (layerName === 'detail') {
            const o = db[data.logType].find(item => item.id === data.id);
            if (!o) return toastMsg("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.");
            // Ø­ÙØ¸ Ù†ÙˆØ¹ Ùˆ ID Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            editMode = { type: data.logType, id: data.id }; 
            _renderDetailContent(o, data.logType);
        } else if (layerName === 'balanceAction') {
            balanceActionType = data.actionType;
            document.getElementById('actionModalTitle').textContent = balanceActionType === 'deposit' ? 'Ø¥ÙŠØ¯Ø§Ø¹ Ø±ØµÙŠØ¯ Ø¬Ø¯ÙŠØ¯' : 'Ø³Ø­Ø¨/ØªØ­ÙˆÙŠÙ„ Ø±ØµÙŠØ¯';
            document.getElementById('currentBalanceInAction').innerHTML = formatCurrency(currentBalance);
            document.getElementById('bAmount').value = '';
            document.getElementById('bDesc').value = '';
            document.getElementById('bDate').value = getCurrentDateTimeLocal();
        } else if (layerName === 'currency') {
            document.getElementById('currencySearch').value = '';
            renderCurrencyList();
        } else if (layerName === 'balanceLog') { 
            renderBalanceLog();
        }
    } else if (layer.type === 'menu') {
        element.classList.add('open');
        const overlay = document.querySelector(layerName === 'imageSource' ? '#imageSourceOverlay' : '.sidebar-overlay');
        if (overlay) overlay.classList.add('open');
    }
}

function _visualClose(layerName, clearEdit = true) {
    const layer = LAYERS[layerName];
    if (!layer) return;
    const element = document.getElementById(layer.elementId);

    if (layer.type === 'modal') {
        element.style.display = 'none';
        // Ù„Ø§ Ù†Ù‚ÙˆÙ… Ø¨Ù…Ø³Ø­ editMode Ù‡Ù†Ø§ Ù„Ø£Ù†Ù‡ Ù‚Ø¯ Ù†Ø­ØªØ§Ø¬Ù‡ Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        // Ø³ÙŠØªÙ… Ù…Ø³Ø­Ù‡ ÙÙŠ openTab Ø£Ùˆ postSaveCleanup
    } else if (layer.type === 'menu') {
        element.classList.remove('open');
        const overlay = document.querySelector(layerName === 'imageSource' ? '#imageSourceOverlay' : '.sidebar-overlay');
        if (overlay) overlay.classList.remove('open');
    }
}

function openLayer(layerName, data = {}) {
    // Ù„Ø§ ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ù†ÙØ³ Ø§Ù„Ù€ layer Ù…Ø±ØªÙŠÙ† Ù…ØªØªØ§Ù„ÙŠØªÙŠÙ†
    if (historyStack.length > 0 && historyStack[historyStack.length - 1].layer === layerName) return; 

    const state = { layer: layerName, data: data };
    historyStack.push(state);
    history.pushState(state, null, `#${layerName}`);
    _visualOpen(layerName, data);
}

function closeLayer(layerName) {
    const top = historyStack[historyStack.length - 1];
    if (top && top.layer === layerName) {
        history.back();
    } else {
        _visualClose(layerName);
    }
}

window.onpopstate = (event) => {
    // Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø£ÙˆÙ„Ø§Ù‹
    Object.keys(LAYERS).forEach(layerName => _visualClose(layerName, false));
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³ØªØ§Ùƒ ÙˆØªØ­Ø¯ÙŠØ«Ù‡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØµÙØ­
    historyStack = [];
    
    const state = event.state;
    if (state && state.layer) {
        historyStack.push(state);
        _visualOpen(state.layer, state.data);
    } else {
        // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø­Ø§Ù„Ø© Ø³Ø§Ø¨Ù‚Ø© (Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)
        openTab('overview');
    }
};

function openLog(type) {
    openLayer('log', { logType: type });
}

function openSidebar() {
    openLayer('sidebar');
}

function openBalanceActionModal(actionType) {
    openLayer('balanceAction', { actionType: actionType });
}

function openBalanceLogModal() {
    openLayer('balanceLog');
}

function openCurrencyModal() {
    openLayer('currency');
}

function openAboutModal() {
    openLayer('about');
}

function initApp() {
    loadDarkModePreference();
    initDB();
    document.getElementById('eDate').value = getCurrentDateTimeLocal();
    document.getElementById('rDate').value = getCurrentDateTimeLocal();
    document.getElementById('dDate').value = getCurrentDateTimeLocal();
}

function loadDarkModePreference() {
    const isDark = localStorage.getItem('darkMode') === 'true';
    if (isDark) {
        document.body.classList.add('dark-mode');
        const toggle = document.getElementById('darkModeToggle');
        if (toggle) toggle.checked = true;
    }
}

function toggleDarkMode() {
    const isDark = document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', isDark);
}

function updateBalanceDisplay() {
    const displayElement = document.getElementById('currentBalanceDisplay');
    const toggleButton = document.getElementById('balanceVisibilityToggle');
    const currencyDisplay = document.getElementById('currentCurrencyDisplay');

    if (currencyDisplay) {
        currencyDisplay.innerHTML = `Ø§Ù„Ø¹Ù…Ù„Ø©: ${currentCurrency.name} (${currentCurrency.symbol})`;
    }
    
    if (balanceHidden) {
        displayElement.className = 'hidden-balance';
        displayElement.textContent = 'â€¢â€¢â€¢â€¢â€¢';
        toggleButton.innerHTML = '<i class="fas fa-eye-slash"></i>';
    } else {
        displayElement.className = '';
        displayElement.innerHTML = formatCurrency(currentBalance);
        toggleButton.innerHTML = '<i class="fas fa-eye"></i>';
    }
}

function toggleBalanceVisibility() {
    balanceHidden = !balanceHidden;
    localStorage.setItem('balanceHidden', balanceHidden);
    updateBalanceDisplay();
}

// ===================================================
// 4. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Stats)
// ===================================================

function calculateTotal(arr, field, condition = () => true) {
    return arr
        .filter(condition)
        .reduce((sum, item) => sum + (parseFloat(item[field]) || 0), 0);
}

function updateStats() {
    const expTotal = calculateTotal(db.exp, 'amount');
    
    // Ø§Ù„Ø­Ù‚ÙˆÙ‚ (Rights)
    const rigTotal = calculateTotal(db.rig, 'amount');
    const rigPaid = calculateTotal(db.rig, 'paidAmount');

    // Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª (Debts)
    const debTotal = calculateTotal(db.deb, 'amount', item => item.type !== 'Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø© Ø£Ø®Ø±Ù‰' && item.type !== 'Ù‚Ø±Ø¶' && item.type !== 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ'); 
    const debTotalLoan = calculateTotal(db.deb, 'totalLoanAmount', item => item.type === 'Ù‚Ø±Ø¶' || item.type === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ'); 
    const debTotalInstallments = calculateTotal(db.deb, 'amount', item => item.type === 'Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø© Ø£Ø®Ø±Ù‰');
    const debTotalAll = debTotal + debTotalLoan + debTotalInstallments; 
    const debPaid = calculateTotal(db.deb, 'paidAmount'); 

    document.getElementById('sExpTotal').innerHTML = formatCurrency(expTotal);
    document.getElementById('sRigTotal').innerHTML = formatCurrency(rigTotal);
    document.getElementById('sDebTotal').innerHTML = formatCurrency(debTotalAll); 
    document.getElementById('sRigPaid').innerHTML = formatCurrency(rigPaid);
    document.getElementById('sDebPaid').innerHTML = formatCurrency(debPaid);
}

// ===================================================
// 5. ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
// ===================================================

function updateImageBase64(inputId, data) {
    const file = data.files[0];
    if (!file) {
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØŒ Ù‚Ø¯ ØªÙƒÙˆÙ† ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØªØ³ØªØ®Ø¯Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        return Promise.resolve(null); 
    }
    
    // 2MB limit
    if (file.size > 2 * 1024 * 1024) { 
        toastMsg("Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 2 Ù…ÙŠØºØ§Ø¨Ø§ÙŠØª).");
        document.getElementById(inputId).value = '';
        document.getElementById('eImgName').textContent = '';
        return Promise.reject(new Error("File too large"));
    }

    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = (error) => reject(error);
        reader.readAsDataURL(file);
    });
}

function updateFileName(input, targetId) {
    const fileName = input.files[0] ? input.files[0].name : '';
    document.getElementById(targetId).textContent = fileName ? `âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù: ${fileName}` : '';
    closeLayer('imageSource');
}

function showImageSourceModal() {
    openLayer('imageSource');
}

function openCameraInput() {
    document.getElementById('eImgCamera').click();
}

function openGalleryInput() {
    document.getElementById('eImgGallery').click();
}

// Ø¯Ø§Ù„Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ
async function addExpense() {
    const amount = parseFloat(document.getElementById('eAmount').value.replace(/,/g, '')) || 0;
    const type = document.getElementById('eType').value;
    const desc = document.getElementById('eDesc').value;
    const date = document.getElementById('eDate').value;
    const imgInputCamera = document.getElementById('eImgCamera');
    const imgInputGallery = document.getElementById('eImgGallery');
    
    if (amount <= 0 || !type || !date) {
        return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆÙ†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ ÙˆØªØ§Ø±ÙŠØ®Ù‡.");
    }
    
    try {
        let imageData = null;
        if (editMode && editMode.id) {
            // ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ø§Ø­ØªÙØ¸ Ø¨Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            const existingData = db.exp.find(item => item.id === editMode.id);
            imageData = existingData ? existingData.img : null;
        }

        // Ø¥Ø°Ø§ Ø§Ø®ØªØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù„ÙÙ‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§ØŒ Ù‚Ù… Ø¨ØªØ­ÙˆÙŠÙ„Ù‡
        if (imgInputCamera.files.length > 0) {
            imageData = await updateImageBase64('eImgCamera', imgInputCamera);
        } else if (imgInputGallery.files.length > 0) {
            imageData = await updateImageBase64('eImgGallery', imgInputGallery);
        }
        
        let newExpense = { 
            amount: amount, 
            type: type, 
            desc: desc, 
            date: date, 
            img: imageData, // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ÙØ±Ø©
            timestamp: new Date().getTime() 
        };
        
        let isEditing = false;
        if (editMode && editMode.id) {
            // ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            isEditing = true;
            newExpense.id = editMode.id;
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ ÙÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯
            const oldExpense = db.exp.find(item => item.id === editMode.id);
            const amountDiff = amount - (oldExpense.amount || 0); // Ø§Ù„Ø²ÙŠØ§Ø¯Ø© ØªÙƒÙˆÙ† Ù…ÙˆØ¬Ø¨Ø©ØŒ Ø§Ù„Ù†Ù‚ØµØ§Ù† Ø³Ø§Ù„Ø¨
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯: Ø§Ù„Ù…ØµØ±ÙˆÙ Ù‡Ùˆ Ø³Ø­Ø¨ØŒ Ù„Ø°Ø§ Ù†Ø·Ø±Ø­ Ø§Ù„ÙØ±Ù‚
            currentBalance -= amountDiff; 
            db.bal.amount = currentBalance;
            
            await saveData('exp', newExpense);
            await saveData('bal', db.bal);
            
            // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯ (Ù…ØªÙ‚Ø¯Ù…)
            if (amountDiff !== 0) {
                logBalanceChange(newExpense.id, 'exp', newExpense.date, amountDiff < 0 ? 'deposit' : 'withdraw', Math.abs(amountDiff), `ØªØ¹Ø¯ÙŠÙ„ Ù…ØµØ±ÙˆÙ: ${newExpense.type}`);
            }

        } else {
            // ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
            // Ø®ØµÙ… Ø§Ù„Ù…ØµØ±ÙˆÙ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ø¨Ø§Ø´Ø±Ø©
            currentBalance -= amount; 
            db.bal.amount = currentBalance;
            
            const newId = await saveData('exp', newExpense);
            newExpense.id = newId; // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù€ id Ø§Ù„Ù…ÙˆÙ„Ù‘Ø¯
            await saveData('bal', db.bal);
            
            // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯
            logBalanceChange(newExpense.id, 'exp', newExpense.date, 'withdraw', amount, newExpense.type);
        }
        
        postSaveCleanup(isEditing, 'exp');
        
    } catch(e) {
        console.error(e);
        toastMsg("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ.");
    }
}

function calculateInstallmentValue(totalAmount, numInstallments) {
    const total = parseFloat(totalAmount) || 0;
    const num = parseInt(numInstallments) || 0;
    if (total > 0 && num > 0) {
        return (total / num).toFixed(2);
    }
    return '';
}

function updateDebtFields(type, currentData = null) {
    const container = document.getElementById('dDynamicFields');
    container.innerHTML = '';
    
    if (type === 'Ù‚Ø±Ø¶' || type === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ') {
        // Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø§Ù„ØªØ²Ø§Ù… (Ø§Ù„Ù‚Ø±Ø¶)
        const totalAmountInput = document.createElement('input');
        totalAmountInput.setAttribute('id', 'dTotalLoanAmount');
        totalAmountInput.setAttribute('type', 'text');
        totalAmountInput.setAttribute('placeholder', 'ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…/Ø§Ù„Ù‚Ø±Ø¶');
        totalAmountInput.setAttribute('oninput', 'formatAmount(this); calculateInstallmentValueDisplay()');
        totalAmountInput.setAttribute('inputmode', 'decimal');
        if (currentData && currentData.totalLoanAmount) {
            totalAmountInput.value = formatNumber(currentData.totalLoanAmount);
        }
        container.appendChild(totalAmountInput);
        
        // Ø­Ù‚Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
        const installmentsInput = document.createElement('input');
        installmentsInput.setAttribute('id', 'dInstallmentsNum');
        installmentsInput.setAttribute('type', 'number');
        installmentsInput.setAttribute('placeholder', 'ğŸ”¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·');
        installmentsInput.setAttribute('oninput', 'calculateInstallmentValueDisplay()');
        if (currentData && currentData.installmentsNum) {
            installmentsInput.value = currentData.installmentsNum;
        }
        container.appendChild(installmentsInput);
        
        // Ø¹Ø±Ø¶ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø·
        const installmentValue = document.createElement('p');
        installmentValue.setAttribute('id', 'dInstallmentValue');
        installmentValue.style.fontSize = '0.9em';
        installmentValue.style.fontWeight = 'bold';
        installmentValue.style.color = 'var(--s)';
        installmentValue.style.textAlign = 'right';
        container.appendChild(installmentValue);

        // Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ù…Ù‡Ù… Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)
        const paidAmountInput = document.createElement('input');
        paidAmountInput.setAttribute('id', 'dPaidAmount');
        paidAmountInput.setAttribute('type', 'text');
        paidAmountInput.setAttribute('placeholder', 'ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù† (Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙ‚Ø·)');
        paidAmountInput.setAttribute('oninput', 'formatAmount(this)');
        paidAmountInput.setAttribute('inputmode', 'decimal');
        if (currentData && currentData.paidAmount) {
            paidAmountInput.value = formatNumber(currentData.paidAmount);
        }
        container.appendChild(paidAmountInput);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© ÙÙˆØ±Ø§Ù‹
        calculateInstallmentValueDisplay();
    }
    // ÙÙŠ Ø­Ø§Ù„Ø© Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ø­Ù‚ÙˆÙ„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©ØŒ ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ù‚Ù„ amount Ù…Ø¨Ø§Ø´Ø±Ø© ÙƒÙ‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø·
}

function calculateInstallmentValueDisplay() {
    const total = document.getElementById('dTotalLoanAmount');
    const num = document.getElementById('dInstallmentsNum');
    const display = document.getElementById('dInstallmentValue');
    
    if (total && num && display) {
        const value = calculateInstallmentValue(total.value, num.value);
        if (value) {
            display.innerHTML = `Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ù…Ù‚Ø¯Ø±Ø©: ${formatCurrency(value)}`;
        } else {
            display.innerHTML = '';
        }
    }
}

async function addDebt() {
    const type = document.getElementById('dType').value;
    const amount = parseFloat(document.getElementById('dAmount').value.replace(/,/g, '')) || 0;
    const desc = document.getElementById('dDesc').value;
    const date = document.getElementById('dDate').value;
    const status = document.getElementById('dStatus').value;
    
    if (amount <= 0 || !type || !date || !status) {
        return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„ØºØŒ Ø§Ù„Ù†ÙˆØ¹ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø­Ø§Ù„Ø©.");
    }
    
    let totalLoanAmount = 0;
    let installmentsNum = 0;
    let installmentValue = 0;
    let paidAmount = 0;
    
    let isEditing = false;
    let amountToDeduct = 0; // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ Ø³ÙŠØªÙ… Ø®ØµÙ…Ù‡ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯

    if (type === 'Ù‚Ø±Ø¶' || type === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ') {
        totalLoanAmount = parseFloat(document.getElementById('dTotalLoanAmount').value.replace(/,/g, '')) || amount;
        installmentsNum = parseInt(document.getElementById('dInstallmentsNum').value) || 0;
        installmentValue = parseFloat(calculateInstallmentValue(totalLoanAmount, installmentsNum)) || 0;
        paidAmount = parseFloat(document.getElementById('dPaidAmount')?.value.replace(/,/g, '')) || 0;

        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ù„Ø­Ø§Ù„Ø© Ù…Ø¯ÙÙˆØ¹ØŒ ÙØ§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù‡Ùˆ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø·
        if (!editMode && status === 'Ù…Ø¯ÙÙˆØ¹') {
            paidAmount = amount;
            amountToDeduct = amount;
        } else if (editMode && editMode.id) {
             const oldDebt = db.deb.find(item => item.id === editMode.id);
             // ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ø¥Ø°Ø§ ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ØŒ ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„ÙØ±Ù‚ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
             // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø­Ù‚Ù„ paidAmount ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (Ø£ÙŠ Ù„ÙŠØ³ Ù‚Ø±Ø¶/Ø¯ÙŠÙ†)ØŒ ÙØ¥Ù† paidAmount Ù‡ÙŠ amount
             const oldPaidAmount = oldDebt.paidAmount || 0;
             amountToDeduct = paidAmount - oldPaidAmount; // Ø¥Ø°Ø§ ÙƒØ§Ù† paidAmount Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø£ÙƒØ¨Ø±ØŒ ÙŠÙƒÙˆÙ† Ø§Ù„ÙØ±Ù‚ Ù…ÙˆØ¬Ø¨ ÙˆÙŠÙØ®ØµÙ…
        } else if (status === 'Ù…Ø¯ÙÙˆØ¹') {
             // Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©: Ø§Ù„Ø®ØµÙ… Ù‡Ùˆ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ (amount)
            amountToDeduct = amount;
        }
        
    } else {
        // ÙÙˆØ§ØªÙŠØ± ÙˆØ£Ù‚Ø³Ø§Ø· Ø£Ø®Ø±Ù‰
        paidAmount = (status === 'Ù…Ø¯ÙÙˆØ¹') ? amount : 0;
        if (!editMode && status === 'Ù…Ø¯ÙÙˆØ¹') {
            amountToDeduct = amount;
        } else if (editMode && editMode.id) {
            const oldDebt = db.deb.find(item => item.id === editMode.id);
            const wasPaid = oldDebt.status === 'Ù…Ø¯ÙÙˆØ¹';
            const nowPaid = status === 'Ù…Ø¯ÙÙˆØ¹';

            if (!wasPaid && nowPaid) {
                // ØªØ­ÙˆÙ„ Ù…Ù† "ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹" Ø¥Ù„Ù‰ "Ù…Ø¯ÙÙˆØ¹"
                amountToDeduct = amount;
            } else if (wasPaid && !nowPaid) {
                // ØªØ­ÙˆÙ„ Ù…Ù† "Ù…Ø¯ÙÙˆØ¹" Ø¥Ù„Ù‰ "ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹" (Ù†Ø§Ø¯Ø±)
                amountToDeduct = -oldDebt.amount; // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù„Ø±ØµÙŠØ¯
            } else if (wasPaid && nowPaid) {
                // ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† Ù…Ø¯ÙÙˆØ¹ Ù„Ù…Ø¯ÙÙˆØ¹: Ù†Ø®ØµÙ… Ø§Ù„ÙØ±Ù‚
                amountToDeduct = amount - oldDebt.amount;
            }
        }
    }
    
    try {
        let newDebt = { 
            amount: amount, 
            type: type, 
            desc: desc, 
            date: date, 
            status: status, 
            totalLoanAmount: totalLoanAmount,
            installmentsNum: installmentsNum,
            installmentValue: installmentValue,
            paidAmount: paidAmount,
            timestamp: new Date().getTime() 
        };
        
        if (editMode && editMode.id) {
            isEditing = true;
            newDebt.id = editMode.id;

            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙŠØªØ¹Ù„Ù‚ Ø¨Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù‚Ø±Ø¶/Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ø´Ø®ØµÙŠØŒ Ù†Ø­ØªØ§Ø¬ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø¹Ù…Ù‚ (ØªÙ… ØªØ¨Ø³ÙŠØ·Ù‡Ø§ Ù‡Ù†Ø§)
            // Ù†Ø³ØªØ®Ø¯Ù… amountToDeduct Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØºÙŠÙŠØ± Ø§Ù„ØµØ§ÙÙŠ ÙÙŠ Ø§Ù„Ø±ØµÙŠØ¯
            
            // Ø®ØµÙ…/Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±Ù‚ Ø§Ù„ØµØ§ÙÙŠ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
            currentBalance -= amountToDeduct; 
            db.bal.amount = currentBalance;
            
            await saveData('deb', newDebt);
            await saveData('bal', db.bal);
            
            // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯ (Ù…ØªÙ‚Ø¯Ù…)
            if (amountToDeduct !== 0) {
                 logBalanceChange(newDebt.id, 'deb', newDebt.date, amountToDeduct > 0 ? 'withdraw' : 'deposit', Math.abs(amountToDeduct), `ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ²Ø§Ù…: ${newDebt.type}`);
            }

        } else {
            // ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
            // Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
            currentBalance -= amountToDeduct; 
            db.bal.amount = currentBalance;
            
            const newId = await saveData('deb', newDebt);
            newDebt.id = newId; 
            await saveData('bal', db.bal);
            
            // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯
            if (amountToDeduct > 0) {
                logBalanceChange(newDebt.id, 'deb', newDebt.date, 'withdraw', amountToDeduct, newDebt.type);
            }
        }
        
        postSaveCleanup(isEditing, 'deb');
        
    } catch(e) {
        console.error(e);
        toastMsg("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù….");
    }
}

function calculateRightRemaining(totalAmount, paidAmount) {
    const total = parseFloat(totalAmount) || 0;
    const paid = parseFloat(paidAmount) || 0;
    return total - paid;
}

function updateRightFields(type, currentData = null) {
    const container = document.getElementById('rDynamicFields');
    container.innerHTML = '';
    
    if (type === 'Ø¯ÙŠÙ†' || type === 'Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„') {
        
        // Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ù…Ù‡Ù… Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)
        const paidAmountInput = document.createElement('input');
        paidAmountInput.setAttribute('id', 'rPaidAmount');
        paidAmountInput.setAttribute('type', 'text');
        paidAmountInput.setAttribute('placeholder', 'ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù† (Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙ‚Ø·)');
        paidAmountInput.setAttribute('oninput', 'formatAmount(this)');
        paidAmountInput.setAttribute('inputmode', 'decimal');
        if (currentData && currentData.paidAmount) {
            paidAmountInput.value = formatNumber(currentData.paidAmount);
        }
        container.appendChild(paidAmountInput);

    }
}

async function addRight() {
    const type = document.getElementById('rType').value;
    const amount = parseFloat(document.getElementById('rAmount').value.replace(/,/g, '')) || 0;
    const desc = document.getElementById('rDesc').value;
    const date = document.getElementById('rDate').value;
    const status = document.getElementById('rStatus').value;
    
    if (amount <= 0 || !type || !date || !status) {
        return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„ØºØŒ Ø§Ù„Ù†ÙˆØ¹ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø­Ø§Ù„Ø©.");
    }
    
    let paidAmount = parseFloat(document.getElementById('rPaidAmount')?.value.replace(/,/g, '')) || 0;
    
    let isEditing = false;
    let amountToDeposit = 0; // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ Ø¥Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯

    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ù„Ø­Ø§Ù„Ø© Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
    if (!editMode && status === 'ÙƒØ§Ù…Ù„') {
        paidAmount = amount;
        amountToDeposit = amount;
    } else if (editMode && editMode.id) {
        const oldRight = db.rig.find(item => item.id === editMode.id);
        const oldPaidAmount = oldRight.paidAmount || 0;
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙŠØªØ¹Ù„Ù‚ Ø¨ØªØ­ØµÙŠÙ„ Ø¯ÙŠÙ†/Ø¨ÙŠØ¹ Ø¢Ø¬Ù„
        if (type === 'Ø¯ÙŠÙ†' || type === 'Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„') {
            // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„ (Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ§Ù„Ù‚Ø¯ÙŠÙ…)
            amountToDeposit = paidAmount - oldPaidAmount; 
            
            // ÙÙŠ Ø­Ø§Ù„Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ 'ÙƒØ§Ù…Ù„'
            if (oldRight.status !== 'ÙƒØ§Ù…Ù„' && status === 'ÙƒØ§Ù…Ù„') {
                amountToDeposit = amount - oldPaidAmount;
                paidAmount = amount;
            }
        } else {
             // Ø­Ù‚ÙˆÙ‚ Ø£Ø®Ø±Ù‰ Ø¨Ø³ÙŠØ·Ø© (ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©/Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„)
            const wasPaid = oldRight.status === 'ÙƒØ§Ù…Ù„';
            const nowPaid = status === 'ÙƒØ§Ù…Ù„';
             if (!wasPaid && nowPaid) {
                amountToDeposit = amount; // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
                paidAmount = amount;
             } else if (wasPaid && !nowPaid) {
                amountToDeposit = -oldRight.amount; // Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø¯ÙŠÙ…
                paidAmount = 0;
             } else if (wasPaid && nowPaid) {
                amountToDeposit = amount - oldRight.amount; // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±Ù‚ ÙÙŠ Ø§Ù„Ù…Ø¨Ù„Øº
                paidAmount = amount;
             }
        }
    } else if (status === 'ÙƒØ§Ù…Ù„') {
         // Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©: Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙŠØªÙ… Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº ÙƒÙ„Ù‡
        amountToDeposit = amount;
    }

    try {
        let newRight = { 
            amount: amount, 
            type: type, 
            desc: desc, 
            date: date, 
            status: status, 
            paidAmount: paidAmount,
            timestamp: new Date().getTime() 
        };
        
        if (editMode && editMode.id) {
            isEditing = true;
            newRight.id = editMode.id;
            
            // Ø¥Ø¶Ø§ÙØ©/Ø®ØµÙ… Ø§Ù„ÙØ±Ù‚ Ø§Ù„ØµØ§ÙÙŠ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
            currentBalance += amountToDeposit; 
            db.bal.amount = currentBalance;
            
            await saveData('rig', newRight);
            await saveData('bal', db.bal);
            
            // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯ (Ù…ØªÙ‚Ø¯Ù…)
            if (amountToDeposit !== 0) {
                logBalanceChange(newRight.id, 'rig', newRight.date, amountToDeposit > 0 ? 'deposit' : 'withdraw', Math.abs(amountToDeposit), `ØªØ¹Ø¯ÙŠÙ„ Ø­Ù‚: ${newRight.type}`);
            }

        } else {
            // ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
            currentBalance += amountToDeposit; 
            db.bal.amount = currentBalance;
            
            const newId = await saveData('rig', newRight);
            newRight.id = newId; 
            await saveData('bal', db.bal);
            
            // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯
            if (amountToDeposit > 0) {
                logBalanceChange(newRight.id, 'rig', newRight.date, 'deposit', amountToDeposit, newRight.type);
            }
        }
        
        postSaveCleanup(isEditing, 'rig');
        
    } catch(e) {
        console.error(e);
        toastMsg("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø­Ù‚.");
    }
}


// ===================================================
// 6. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙ†Ø¸ÙŠÙ ÙˆÙ…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ø§Ù„Ù…ÙØ­Ø¯Ù‘ÙØ«Ø©)
// ===================================================

// **ØªØ¹Ø¯ÙŠÙ„: Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸ (Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø¬Ù„ - Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ)**
function postSaveCleanup(isEditing, type) {
    // 1. ØªØµÙÙŠØ± ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ¥ÙØ±Ø§Øº Ø§Ù„Ø­Ù‚ÙˆÙ„
    editMode = null; 
    clearFields(); 
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    loadAllData().then(() => {
        updateStats();
        updateBalanceDisplay();
        
        // Ø¥ØºÙ„Ø§Ù‚ Ø£ÙŠ Ù…ÙˆØ¯Ø§Ù„ ØªÙØ§ØµÙŠÙ„ Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù…ÙØªÙˆØ­Ø§Ù‹
        _visualClose('detail');
        
        // 2. Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø¬Ù„ Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        if (isEditing) {
            _visualOpen('log', { logType: type });
        }
    });
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
    const msg = isEditing ? "ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ÙˆØ­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!" : "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!";
    toastMsg(msg); 
}


// **ØªØ¹Ø¯ÙŠÙ„: Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (ØªØ¹Ø¨Ø¦Ø© ÙÙˆØ±ÙŠØ© Ù„Ù„Ø­Ù‚ÙˆÙ„ - Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø£ÙˆÙ„)**
function editTransaction() {
    if (!editMode || !editMode.id) return;
    
    // 1. Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙÙˆØ±Ø§Ù‹
    _visualClose('detail'); 

    const typeMap = { 'exp': 'expenses', 'rig': 'rights', 'deb': 'debts' };
    const sectionId = typeMap[editMode.type];
    
    // 2. ÙØªØ­ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„ Ø¹Ù„Ù‰ Ø§Ù„ÙÙˆØ± ÙˆØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (keepEditMode=true)
    openTab(sectionId, true); 

    // 3. Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ÙÙˆØ±Ø§
    const currentData = db[editMode.type].find(item => item.id === editMode.id);
    if (!currentData) {
        toastMsg("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.");
        editMode = null;
        clearFields();
        return;
    }

    if (editMode.type === 'exp') {
        document.getElementById('eAmount').value = currentData.amount ? formatNumber(currentData.amount) : '';
        document.getElementById('eType').value = currentData.type || '';
        document.getElementById('eDesc').value = currentData.desc || '';
        document.getElementById('eDate').value = currentData.date || getCurrentDateTimeLocal();
        document.getElementById('eImgName').textContent = currentData.img ? 'âœ… ØµÙˆØ±Ø© Ù…Ø±ÙÙ‚Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„' : '';
        // Ù„Ø§ ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø§Ù„Ù€ base64 Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø°Ø§ÙƒØ±Ø©ØŒ ÙŠØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø§Ø®ØªØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©.

    } else if (editMode.type === 'rig') {
        if (typeof updateRightFields === 'function') { 
            // ÙŠØ¬Ø¨ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ Ù„ØªØ¬Ù‡ÙŠØ² Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·/Ø§Ù„ØªØ³Ø¯ÙŠØ¯
            updateRightFields(currentData.type, currentData); 
        }
        
        document.getElementById('rType').value = currentData.type || '';
        document.getElementById('rAmount').value = currentData.amount ? formatNumber(currentData.amount) : '';
        document.getElementById('rDesc').value = currentData.desc || '';
        document.getElementById('rDate').value = currentData.date || getCurrentDateTimeLocal();
        document.getElementById('rStatus').value = currentData.status || '';
        
        // ØªØ¹Ø¨Ø¦Ø© paidAmount ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‚Ø¯ ØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ ÙÙŠ updateRightFields (Ù„Ø£Ù†Ù‡ Ù‚Ø¯ Ù„Ø§ ÙŠØ¹ÙŠØ¯ Ø±Ø³Ù… Ø§Ù„Ø­Ù‚Ù„ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ø·/Ø§Ù„Ø¯ÙŠÙˆÙ†)
        const paidAmountInput = document.getElementById('rPaidAmount');
        if (paidAmountInput && currentData.paidAmount) {
            paidAmountInput.value = formatNumber(currentData.paidAmount);
        }

    } else if (editMode.type === 'deb') {
        if (typeof updateDebtFields === 'function') { 
            // ÙŠØ¬Ø¨ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ Ù„ØªØ¬Ù‡ÙŠØ² Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
            updateDebtFields(currentData.type, currentData); 
        }
        
        document.getElementById('dType').value = currentData.type || '';
        document.getElementById('dAmount').value = currentData.amount ? formatNumber(currentData.amount) : '';
        document.getElementById('dDesc').value = currentData.desc || '';
        document.getElementById('dDate').value = currentData.date || getCurrentDateTimeLocal();
        document.getElementById('dStatus').value = currentData.status || '';
        
        // ØªØ¹Ø¨Ø¦Ø© Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‚Ø±Ø¶/Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ø´Ø®ØµÙŠ ÙŠØ¯ÙˆÙŠØ§Ù‹
        const totalLoanAmountInput = document.getElementById('dTotalLoanAmount');
        if (totalLoanAmountInput && currentData.totalLoanAmount) {
            totalLoanAmountInput.value = formatNumber(currentData.totalLoanAmount);
        }
        const installmentsNumInput = document.getElementById('dInstallmentsNum');
        if (installmentsNumInput && currentData.installmentsNum) {
            installmentsNumInput.value = currentData.installmentsNum;
        }
        const paidAmountInput = document.getElementById('dPaidAmount');
        if (paidAmountInput && currentData.paidAmount) {
            paidAmountInput.value = formatNumber(currentData.paidAmount);
        }
        
        if (currentData.type === 'Ù‚Ø±Ø¶' || currentData.type === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ') {
            calculateInstallmentValueDisplay(); // Ù„ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©
        }
    }
}

function deleteTransaction(id, type) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŸ')) return;
    
    const transaction = db[type].find(item => item.id === id);
    if (!transaction) return toastMsg("Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.");
    
    let amountToUpdate = 0;

    if (type === 'exp') {
        // Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: ÙŠØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº Ø¥Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯
        amountToUpdate = transaction.amount; 
    } else if (type === 'rig') {
        // Ø§Ù„Ø­Ù‚ÙˆÙ‚: ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
        amountToUpdate = -(transaction.paidAmount || 0); 
    } else if (type === 'deb') {
        // Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª: ÙŠØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø¥Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯
        amountToUpdate = transaction.paidAmount || (transaction.status === 'Ù…Ø¯ÙÙˆØ¹' ? transaction.amount : 0);
    }
    
    deleteFromDB(type, id)
        .then(() => {
            currentBalance += amountToUpdate; 
            db.bal.amount = currentBalance;
            
            return saveData('bal', db.bal);
        })
        .then(() => {
            logBalanceChange(id, type, transaction.date, amountToUpdate > 0 ? 'deposit' : 'withdraw', Math.abs(amountToUpdate), `Ø­Ø°Ù Ù…Ø¹Ø§Ù…Ù„Ø©: ${transaction.type}`, true);
            return loadAllData();
        })
        .then(() => {
            updateStats();
            updateBalanceDisplay();
            _visualClose('detail');
            renderLog(); // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù
            toastMsg("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯.");
        })
        .catch(e => {
            console.error(e);
            toastMsg("ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.");
        });
}

function payInstallment(id, type, amount, currentStatus) {
    if (currentStatus === 'ÙƒØ§Ù…Ù„' || currentStatus === 'Ù…Ø¯ÙÙˆØ¹') {
        return toastMsg("Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ØªÙ… Ø¯ÙØ¹Ù‡Ø§ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ Ø£Ùˆ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©.");
    }
    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© ${formatCurrency(amount).replace(/<[^>]*>/g, '')} Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŸ`)) return;

    const transaction = db[type].find(item => item.id === id);
    if (!transaction) return toastMsg("Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.");

    const transactionTypeMap = { 'rig': 'Ø­Ù‚', 'deb': 'Ø§Ù„ØªØ²Ø§Ù…' };
    const paidField = (type === 'rig' ? 'paidAmount' : 'paidAmount');
    const totalField = (type === 'rig' ? 'amount' : 'totalLoanAmount');
    const totalAmount = transaction[totalField] || transaction.amount;
    const currentPaid = transaction[paidField] || 0;
    const newPaid = currentPaid + amount;

    if (newPaid > totalAmount) {
        return toastMsg(`Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ! (Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${formatCurrency(totalAmount - currentPaid).replace(/<[^>]*>/g, '')})`);
    }

    transaction[paidField] = newPaid;
    let newStatus = currentStatus;
    if (newPaid >= totalAmount) {
        newStatus = (type === 'rig' ? 'ÙƒØ§Ù…Ù„' : 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„');
        transaction.status = newStatus;
    }

    const action = (type === 'rig' ? 'deposit' : 'withdraw');
    currentBalance += (action === 'deposit' ? amount : -amount);
    db.bal.amount = currentBalance;

    saveData(type, transaction)
        .then(() => saveData('bal', db.bal))
        .then(() => {
            logBalanceChange(id, type, getCurrentDateTimeLocal(), action, amount, `Ø¯ÙØ¹Ø© Ù‚Ø³Ø·/ØªØ­ØµÙŠÙ„ Ù„Ù€ ${transactionTypeMap[type]}: ${transaction.type}`);
            return loadAllData();
        })
        .then(() => {
            updateStats();
            updateBalanceDisplay();
            _renderDetailContent(transaction, type); // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
            renderLog();
            toastMsg(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© ${transactionTypeMap[type]} Ø¨Ù†Ø¬Ø§Ø­!`);
        })
        .catch(e => {
            console.error(e);
            toastMsg(`ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© ${transactionTypeMap[type]}.`);
        });
}


// ===================================================
// 7. ÙˆØ¸Ø§Ø¦Ù Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙˆØ§Ù„ØªÙØ§ØµÙŠÙ„
// ===================================================

function _renderDetailContent(o, type) {
    const content = document.getElementById('detailContent');
    const typeLabel = { 'exp': 'Ù…ØµØ±ÙˆÙ', 'rig': 'Ø­Ù‚', 'deb': 'Ø§Ù„ØªØ²Ø§Ù…' }[type];
    let html = `
        <div class="card" style="border-top-color: var(--p);">
            <h3 style="color: var(--p); margin-top: 0;">${typeLabel}: ${o.type}</h3>
            <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> ${formatCurrency(o.amount)}</p>
            <p><strong>Ø§Ù„ÙˆØµÙ/Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ${o.desc || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>
            <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date(o.date).toLocaleString('ar-SA')}</p>
    `;

    if (type !== 'exp') {
        html += `<p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${o.status || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>`;
        
        // ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‚Ø±Ø¶/Ø§Ù„Ø¯ÙŠÙ†/Ø§Ù„Ø¢Ø¬Ù„
        if (o.type === 'Ù‚Ø±Ø¶' || o.type === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ' || o.type === 'Ø¯ÙŠÙ†' || o.type === 'Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„') {
            const totalAmount = o.totalLoanAmount || o.amount;
            const paidAmount = o.paidAmount || 0;
            const remaining = calculateRightRemaining(totalAmount, paidAmount);
            const statusColor = remaining > 0 ? 'var(--danger)' : 'var(--success)';
            
            html += `<hr style="border-color: var(--border-color); margin: 15px 0;">`;
            html += `<p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº:</strong> ${formatCurrency(totalAmount)}</p>`;
            html += `<p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹/Ø§Ù„Ù…Ø­ØµÙ„:</strong> ${formatCurrency(paidAmount)}</p>`;
            html += `<p style="font-weight: bold; color: ${statusColor};"><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> ${formatCurrency(remaining)}</p>`;

            if (o.installmentsNum && o.installmentsNum > 0) {
                 html += `<p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·:</strong> ${o.installmentsNum}</p>`;
                 html += `<p><strong>Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø·:</strong> ${formatCurrency(o.installmentValue || calculateInstallmentValue(totalAmount, o.installmentsNum))}</p>`;
            }
            
            // Ø²Ø± Ø§Ù„ØªØ³Ø¯ÙŠØ¯/Ø§Ù„ØªØ­ØµÙŠÙ„
            if (remaining > 0) {
                 const installment = o.installmentValue || o.amount;
                 const buttonText = type === 'rig' ? `ØªØ³Ø¬ÙŠÙ„ ØªØ­ØµÙŠÙ„ Ù…Ø¨Ù„Øº: ${formatCurrency(installment).replace(/<[^>]*>/g, '')}` : `ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹ Ù‚Ø³Ø·: ${formatCurrency(installment).replace(/<[^>]*>/g, '')}`;

                 html += `<button class="action" onclick="payInstallment(${o.id}, '${type}', ${installment}, '${o.status}')" style="background: ${type === 'rig' ? 'var(--success)' : 'var(--danger)'}; margin-top: 15px;">
                     <i class="fas ${type === 'rig' ? 'fa-hand-holding-usd' : 'fa-money-check-alt'}" style="margin-left: 5px;"></i> ${buttonText}
                 </button>`;
            }
        }
    } else {
        // Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
        if (o.img) {
            html += `<hr style="border-color: var(--border-color); margin: 15px 0;">`;
            html += `<p style="font-weight: bold; margin-bottom: 5px; color: var(--s);"><i class="fas fa-image" style="margin-left: 5px;"></i> ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</p>`;
            html += `<img src="${o.img}" style="max-width: 100%; border-radius: 10px; box-shadow: var(--shadow-light);">`;
        }
    }

    html += `
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="action" onclick="editTransaction()" style="flex: 1;">
                <i class="fas fa-edit" style="margin-left: 5px;"></i> ØªØ¹Ø¯ÙŠÙ„
            </button>
            <button class="secondary" onclick="deleteTransaction(${o.id}, '${type}')" style="flex: 1; color: var(--danger); border-color: var(--danger);">
                <i class="fas fa-trash" style="margin-left: 5px;"></i> Ø­Ø°Ù
            </button>
        </div>
    `;

    content.innerHTML = html;
}

function renderLog() {
    const content = document.getElementById('logContent');
    const search = document.getElementById('search').value.toLowerCase();
    const data = db[currentLog] || [];
    
    // ØªØµÙ†ÙŠÙ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„ØªØ§Ø±ÙŠØ® Ù†ÙØ³Ù‡ ÙŠÙ…Ø«Ù„ Ø§Ù„ÙŠÙˆÙ…ØŒ Ø«Ù… Ø§Ù„ÙˆÙ‚Øª)
    const groupedData = data.reduce((acc, item) => {
        const datePart = item.date ? item.date.substring(0, 10) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        if (!acc[datePart]) {
            acc[datePart] = [];
        }
        acc[datePart].push(item);
        return acc;
    }, {});
    
    let html = '';
    const sortedDates = Object.keys(groupedData).sort().reverse();
    
    for (const date of sortedDates) {
        const transactions = groupedData[date];
        
        // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„ÙŠÙˆÙ…
        const dayName = new Date(date).toLocaleDateString('ar-SA', { weekday: 'long' });
        html += `<h4 style="margin: 15px 0 5px 0; color: #666; font-weight: 700;">${dayName} - ${date}</h4>`;
        
        transactions.filter(item => 
                (item.type && item.type.toLowerCase().includes(search)) ||
                (item.desc && item.desc.toLowerCase().includes(search)) ||
                (item.amount && item.amount.toString().includes(search))
            )
            .forEach(item => {
                const amountText = formatCurrency(item.amount);
                const statusText = item.status ? ` | Ø§Ù„Ø­Ø§Ù„Ø©: ${item.status}` : '';
                
                let color = 'var(--s)'; // Default for general
                if (currentLog === 'exp') color = 'var(--danger)';
                else if (currentLog === 'rig') color = 'var(--success)';
                else if (currentLog === 'deb' && item.status === 'Ù…Ø¯ÙÙˆØ¹') color = 'var(--danger)';
                else if (currentLog === 'deb') color = 'var(--warning)';

                html += `
                    <div class="list-item" style="border-right-color: ${color};" onclick="showDetailById(${item.id}, '${currentLog}')">
                        <div style="font-weight: bold; font-size: 1.1em; color: ${color};">
                            ${amountText}
                        </div>
                        <div class="details">
                            <span>${item.type}</span>
                            <span>${item.desc || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'} ${statusText}</span>
                        </div>
                    </div>
                `;
            });
    }

    if (html === '') {
        html = '<p style="text-align: center; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø«.</p>';
    }
    
    content.innerHTML = html;
}

function showDetailById(id, type) {
    // Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø³Ø¬Ù„ Ù‚Ø¨Ù„ ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙØ§ØµÙŠÙ„
    _visualClose('log'); 
    openLayer('detail', { id: id, logType: type });
}

// ===================================================
// 8. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø±ØµÙŠØ¯ (Balance)
// ===================================================

function logBalanceChange(id, type, date, action, amount, desc, isDeletion = false) {
    const change = {
        id: db.bal.changes.length + 1,
        refId: id,
        refType: type,
        date: date,
        action: action, // 'deposit' or 'withdraw'
        amount: amount,
        desc: desc,
        isDeletion: isDeletion
    };
    db.bal.changes.push(change);
    // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ø­ÙØ¸Ù‡Ø§ Ø§Ù„Ø¢Ù†ØŒ Ø³ÙŠØªÙ… Ø­ÙØ¸Ù‡Ø§ ÙÙŠ saveData('bal') ÙÙŠ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙŠ Ø§Ø³ØªØ¯Ø¹Øª Ù‡Ø°Ù‡
}

function processBalanceAction() {
    const amount = parseFloat(document.getElementById('bAmount').value.replace(/,/g, '')) || 0;
    const desc = document.getElementById('bDesc').value;
    const date = document.getElementById('bDate').value;

    if (amount <= 0 || !desc || !date) {
        return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„ÙˆØµÙ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®.");
    }
    
    let isDeposit = balanceActionType === 'deposit';

    if (isDeposit) {
        currentBalance += amount;
    } else {
        currentBalance -= amount;
    }
    
    db.bal.amount = currentBalance;

    saveData('bal', db.bal)
        .then(() => {
            logBalanceChange(0, 'bal', date, balanceActionType, amount, desc);
            return saveData('bal', db.bal); // Ù„Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØºÙŠÙŠØ±
        })
        .then(() => {
            updateBalanceDisplay();
            _visualClose('balanceAction');
            document.getElementById('bAmount').value = '';
            document.getElementById('bDesc').value = '';
            document.getElementById('bDate').value = getCurrentDateTimeLocal();
            toastMsg(`ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© ${isDeposit ? 'Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹' : 'Ø§Ù„Ø³Ø­Ø¨'} Ø¨Ù†Ø¬Ø§Ø­!`);
        })
        .catch(e => {
            console.error(e);
            toastMsg(`ÙØ´Ù„ Ø¹Ù…Ù„ÙŠØ© ${isDeposit ? 'Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹' : 'Ø§Ù„Ø³Ø­Ø¨'}.`);
        });
}

function renderBalanceLog() {
    const content = document.getElementById('balanceLogContent');
    const changes = db.bal.changes.slice().reverse(); // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
    
    if (changes.length === 0) {
        content.innerHTML = '<p style="text-align: center; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯.</p>';
        return;
    }
    
    let html = '';
    changes.forEach(change => {
        const isDeposit = change.action === 'deposit';
        const color = isDeposit ? 'var(--success)' : 'var(--danger)';
        const icon = isDeposit ? 'fa-arrow-up' : 'fa-arrow-down';
        const actionLabel = isDeposit ? 'Ø¥ÙŠØ¯Ø§Ø¹/Ø¥Ø¶Ø§ÙØ©' : 'Ø³Ø­Ø¨/Ø®ØµÙ…';
        
        html += `
            <div class="list-item" style="border-right-color: ${color};">
                <div style="font-weight: bold; font-size: 1.1em; color: ${color};">
                    <i class="fas ${icon}" style="margin-left: 5px;"></i> ${formatCurrency(change.amount)}
                </div>
                <div class="details">
                    <span>${actionLabel} (${change.refType})</span>
                    <span style="color: #666;">${change.desc || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</span>
                </div>
                <p style="font-size: 0.8em; color: #999; margin: 5px 0 0 0; text-align: right;">${new Date(change.date).toLocaleString('ar-SA')}</p>
            </div>
        `;
    });
    content.innerHTML = html;
}

// ===================================================
// 9. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
// ===================================================

function updateCurrency(code, symbol, name) {
    currentCurrency = { code, symbol, name };
    localStorage.setItem('currencyCode', code);
    updateBalanceDisplay();
    updateStats();
    closeLayer('currency');
    toastMsg(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ù„Ø© Ø¥Ù„Ù‰ ${name} (${symbol}).`);
}

function renderCurrencyList() {
    const list = document.getElementById('currencyList');
    const search = document.getElementById('currencySearch').value.toLowerCase();
    
    let html = '';
    ARABIC_CURRENCIES
        .filter(c => c.name.toLowerCase().includes(search) || c.code.toLowerCase().includes(search))
        .forEach(c => {
            const isCurrent = c.code === currentCurrency.code;
            html += `
                <div class="sidebar-menu-item" onclick="updateCurrency('${c.code}', '${c.symbol}', '${c.name}')" 
                    style="${isCurrent ? 'background: var(--s); font-weight: bold;' : ''}">
                    <span>${c.name} (${c.symbol})</span>
                    ${isCurrent ? '<i class="fas fa-check-circle" style="color: var(--p);"></i>' : ''}
                </div>
            `;
        });
    list.innerHTML = html;
}

function exportData() {
    const dataStr = JSON.stringify(db, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `smart_budget_backup_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    toastMsg("ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
}

function importData(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const importedDb = JSON.parse(e.target.result);
            if (importedDb.exp && importedDb.rig && importedDb.deb && importedDb.bal) {
                
                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©
                Promise.all([
                    saveData('bal', importedDb.bal),
                    ...importedDb.exp.map(item => saveData('exp', item)),
                    ...importedDb.rig.map(item => saveData('rig', item)),
                    ...importedDb.deb.map(item => saveData('deb', item))
                ]).then(() => {
                    loadAllData().then(() => {
                        updateStats(); 
                        updateBalanceDisplay();
                        toastMsg("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
                        closeLayer('sidebar');
                    });
                }).catch(err => {
                    console.error(err);
                    toastMsg("ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
                });

            } else {
                toastMsg("Ù…Ù„Ù Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…ÙÙ‚ÙˆØ¯ Ù…Ù†Ù‡ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù….");
            }
        } catch (error) {
            toastMsg("ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù JSON.");
        }
    };
    reader.readAsText(file);
}

function confirmResetData() {
    if (confirm("ØªØ­Ø°ÙŠØ±! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§ØªØŒ Ø§Ù„Ø­Ù‚ÙˆÙ‚ØŒ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙˆØ³Ø¬Ù„ Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ.")) {
        resetData();
    }
}

function resetData() {
    if (!IDB_connection) return toastMsg("Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØµÙ„Ø©.");
    
    STORE_NAMES.forEach(storeName => {
        const transaction = IDB_connection.transaction([storeName], "readwrite");
        const store = transaction.objectStore(storeName);
        const request = store.clear(); 

        let storesCleared = 0;
        request.onsuccess = () => {
            storesCleared++;
            if (storesCleared === STORE_NAMES.length) {
                // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯ Ù…Ø³Ø­ ÙƒÙ„ Ø´ÙŠØ¡
                db.exp = []; 
                db.rig = [];
                db.deb = []; 
                db.bal = { clientId: 1, amount: 0, changes: [] };
                saveData('bal', db.bal).then(() => {
                    loadAllData().then(() => {
                        updateStats(); 
                        updateBalanceDisplay();
                        closeLayer('sidebar');
                        toastMsg("ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
                    });
                });
            }
        };

        request.onerror = () => toastMsg("ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
    });
}
</script>

</body>
</html>
