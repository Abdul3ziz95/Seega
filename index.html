<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ© | Smart Budget</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">

<style>
/* ---------------------------------------------------- */
/* Variables and Base Styling - LIGHT MODE (Default) */
/* ---------------------------------------------------- */
:root{
    --p: #0077b6; /* Primary Blue (Vibrant) */
    --s: #48cae4; /* Secondary Light Blue */
    --bg: #f7f9fc; /* Light Background */
    --danger: #ef476f; 
    --success: #2a9d8f;
    --warning: #fbc02d;
    --text-dark: #333;
    --text-light: #f7f9fc;
    --shadow-light: 0 4px 8px rgba(0, 0, 0, 0.08);
    --shadow-hover: 0 6px 15px rgba(0, 0, 0, 0.15);
    --card-bg: #fff;
    --input-bg: #fff;
    --border-color: #ddd;
    --tab-active-bg: #fff;
}

/* ---------------------------------------------------- */
/* Dark Mode Variables */
/* ---------------------------------------------------- */
body.dark-mode {
    --p: #90e0ef; /* Lighter Primary Blue for contrast */
    --s: #48cae4; 
    --bg: #1f1f1f; /* Dark Background */
    --danger: #ff8a80;
    --success: #66bb6a;
    --warning: #fbc02d;
    --text-dark: #e0e0e0; /* Light Text */
    --text-light: #1f1f1f;
    --shadow-light: 0 4px 10px rgba(0, 0, 0, 0.5);
    --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.8);
    --card-bg: #2d2d2d;
    --input-bg: #3c3c3c;
    --border-color: #555;
    --tab-active-bg: #2d2d2d;
}

/* ---------------------------------------------------- */
/* Global Reset and Base Styling */
/* ---------------------------------------------------- */
* {
    box-sizing: border-box;
}
body{
    margin:0;
    font-family: 'Tajawal', 'Arial', sans-serif;
    background: var(--bg);
    color: var(--text-dark);
    overflow-x: hidden;
    line-height: 1.6;
    transition: background 0.3s, color 0.3s;
}

/* Global Dark Mode Overrides for Specific Elements */
.card, .sidebar, .modal { background: var(--card-bg); }
.modal header { background: var(--card-bg); border-bottom: 1px solid var(--border-color); }

/* ---------------------------------------------------- */
/* Header & Navigation */
/* ---------------------------------------------------- */
header{
    background: var(--p);
    color: var(--text-light);
    padding: 15px;
    font-size: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-hover);
    position: sticky;
    top: 0;
    z-index: 10;
}
header .title { flex-grow: 1; text-align: center; font-weight: 800; }
header button {
    background: none; 
    border: none; 
    color: var(--text-light); 
    font-size: 20px; 
    cursor: pointer; 
    padding: 0 10px;
    transition: transform 0.2s;
}
header button:hover { transform: scale(1.1); }

.tabs{
    display:flex;
    background: var(--card-bg);
    border-bottom: 2px solid var(--border-color);
    box-shadow: var(--shadow-light);
    overflow-x: auto; 
    white-space: nowrap;
}
.tabs button{
    flex: 1 1 auto; 
    min-width: 100px;
    padding: 15px 10px;
    border:none;
    background: var(--card-bg);
    color: var(--text-dark);
    font-weight: 700;
    font-size: 14px;
    transition: all 0.3s;
    border-bottom: 3px solid transparent;
}
.tabs button.active{
    color: var(--p);
    border-bottom: 3px solid var(--p);
    background: color-mix(in srgb, var(--bg) 90%, var(--p)); 
}
body.dark-mode .tabs button.active {
    background: color-mix(in srgb, var(--bg) 85%, var(--p)); 
}

/* ---------------------------------------------------- */
/* General Layout & Cards */
/* ---------------------------------------------------- */
.section{ display:none; padding: 15px; }
.section.active{ display:block; }
.card{
    background:var(--card-bg);
    padding: 20px;
    border-radius: 15px;
    box-shadow: var(--shadow-light);
    margin-bottom: 15px;
    border-top: 5px solid var(--s); 
    transition: background 0.3s, border-color 0.3s;
}

/* ---------------------------------------------------- */
/* Overview Section Styling (New Dashboard) */
/* ---------------------------------------------------- */
#overview .balance-display {
    text-align: center;
    padding: 30px 20px;
    margin-bottom: 20px;
    border-radius: 15px;
    background: var(--card-bg);
    box-shadow: var(--shadow-hover);
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    align-items: center;
}
#overview .balance-display h2 {
    margin: 0 0 5px 0;
    font-size: 18px;
    color: #999;
}
#overview .balance-display p {
    font-size: 38px;
    font-weight: 800;
    margin: 5px 0 0 0;
    color: var(--p);
    display: flex;
    align-items: center;
}
#overview .balance-display button {
    background: none;
    border: none;
    color: var(--p);
    font-size: 24px;
    cursor: pointer;
    margin-right: 10px;
    transition: color 0.2s;
}
#overview .balance-display button:hover {
    color: var(--s);
}
#overview .balance-actions {
    display: flex;
    gap: 15px;
    margin-top: 10px;
}
#overview .balance-actions .action {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    color: var(--text-dark);
    border-radius: 10px;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-light);
    transition: all 0.2s;
    background: var(--input-bg);
}
#overview .balance-actions .action:hover {
    box-shadow: var(--shadow-hover);
    transform: translateY(-2px);
    border-color: var(--p);
}
#overview .balance-actions .action i {
    font-size: 24px;
    margin-bottom: 5px;
}
#overview .balance-actions .deposit i { color: var(--success); }
#overview .balance-actions .withdraw i { color: var(--danger); }

/* ---------------------------------------------------- */
/* Form Elements & Inputs */
/* ---------------------------------------------------- */
input, select, .datetime-container input[type="datetime-local"] {
    width: 100%;
    padding: 14px;
    margin: 8px 0;
    font-size: 16px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    box-sizing: border-box;
    background: var(--input-bg);
    color: var(--text-dark);
    transition: all 0.3s;
}
input:focus, select:focus, .datetime-container input[type="datetime-local"]:focus {
    border-color: var(--s);
    box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.2);
    outline: none;
}
body.dark-mode input:focus, body.dark-mode select:focus, body.dark-mode .datetime-container input[type="datetime-local"]:focus {
    box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.3);
}

.datetime-container { position: relative; width: 100%; margin: 8px 0; }
.datetime-container input[type="datetime-local"] { margin: 0; padding-left: 40px; }

.calendar-icon {
    position: absolute;
    top: 50%;
    left: 15px; 
    transform: translateY(-50%);
    font-size: 1.4em;
    z-index: 2;
    pointer-events: none; 
    color: var(--p); 
}

/* ---------------------------------------------------- */
/* Buttons & Actions */
/* ---------------------------------------------------- */
button.action{
    background: var(--p);
    color: var(--text-light);
    border: none;
    padding: 16px;
    width: 100%;
    border-radius: 10px;
    font-size: 18px;
    font-weight: bold;
    margin-top: 10px;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
    box-shadow: var(--shadow-light);
}
button.action:hover{
    background: color-mix(in srgb, var(--p) 85%, black); 
    transform: translateY(-2px);
}

button.secondary{
    background: var(--input-bg);
    color: var(--text-dark);
    padding: 12px;
    width: 100%;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    margin-top: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s;
}
button.secondary:hover {
    background: color-mix(in srgb, var(--input-bg) 80%, #999); 
}

/* ---------------------------------------------------- */
/* Utility & Custom Elements */
/* ---------------------------------------------------- */
.toast{
    position:fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: var(--text-light);
    padding: 12px 25px;
    border-radius: 30px;
    display:none;
    z-index: 100;
    font-size: 15px;
    box-shadow: var(--shadow-hover);
    white-space: nowrap;
}

.currency-symbol { color: var(--p); font-weight: bold; font-size: 1.1em; margin-right: 5px; }
.hidden-balance { font-size: 38px; font-weight: 800; letter-spacing: 5px; color: var(--p); }

/* ---------------------------------------------------- */
/* Modals and Sidebar Refinements */
/* ---------------------------------------------------- */
.modal{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background: var(--bg);
    display:none;
    flex-direction:column;
    z-index: 30;
    overflow-y: auto;
}
.modal header{
    display:flex;
    flex-direction: column;
    gap: 10px;
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    background: var(--card-bg);
    box-shadow: var(--shadow-light);
    position: sticky;
    top: 0;
    z-index: 35;
}
.modal header .title-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}
.modal header input[type="text"] {
    flex-grow: 1;
    margin: 0;
    padding: 8px 15px;
    font-size: 16px;
    border-radius: 20px;
    border: 1px solid var(--border-color);
    background: var(--input-bg);
    color: var(--text-dark);
}
.modal header .title { 
    flex-grow: 1; 
    text-align: center; 
    font-weight: 700; 
}
.modal header button {
    background: none; 
    border: none; 
    color: var(--text-dark); 
    font-size: 20px; 
    cursor: pointer; 
    padding: 0 10px;
}
.modal-content {
    flex-grow: 1;
    padding: 15px;
}
.filter-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 10px;
    width: 100%;
}
.filter-row .full-width {
    grid-column: 1 / 3;
}
.filter-row label {
    font-size: 0.8em;
    color: #666;
    display: block;
    margin-bottom: 3px;
    text-align: right;
}
.filter-row input, .filter-row select {
    padding: 8px;
    margin: 0;
    font-size: 14px;
    border-radius: 8px;
}

.sidebar {
    position: fixed;
    top: 0;
    right: 0; 
    width: 300px; 
    max-width: 85%;
    height: 100%;
    background: var(--card-bg);
    box-shadow: -4px 0 12px rgba(0, 0, 0, 0.2);
    transform: translateX(100%); 
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
    z-index: 25; 
    display: flex;
    flex-direction: column;
}
.sidebar.open { transform: translateX(0); }

/* Switch Style (Dark Mode) */
.switch-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    font-size: 17px;
    color: var(--text-dark);
}
/* ... (ÙƒÙˆØ¯ Ø§Ù„Ù€ switch Ù„Ù… ÙŠØªØºÙŠØ±) ... */
.switch { position: relative; display: inline-block; width: 45px; height: 25px; }
.switch input {opacity: 0; width: 0; height: 0;}
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: var(--border-color); transition: .4s; border-radius: 25px;
}
.slider:before {
    position: absolute; content: ""; height: 19px; width: 19px; left: 3px; bottom: 3px;
    background-color: white; transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: var(--p); }
input:checked + .slider:before { transform: translateX(20px); }


/* Sidebar */
.sidebar-header {
    padding: 15px;
    background: var(--p);
    color: var(--text-light);
    font-size: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
}
.sidebar-content {
    flex-grow: 1;
    padding: 15px 0;
    overflow-y: auto;
}

.sidebar-menu-item {
    padding: 15px 20px;
    margin: 5px 0;
    display: flex;
    align-items: center;
    justify-content: space-between; 
    gap: 15px;
    font-size: 17px;
    color: var(--text-dark);
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
}

.sidebar-menu-item:hover {
    background: var(--s);
    color: var(--text-dark); 
}
.sidebar-menu-item i { font-size: 1.2em; }

.sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    z-index: 24;
}
.sidebar-overlay.open { display: block; }

/* Small Image Source Modal */
#imageSourceModal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80%;
    max-width: 350px;
    height: auto;
    background: var(--card-bg);
    border-radius: 15px;
    box-shadow: var(--shadow-hover);
    padding: 20px;
    z-index: 150;
    display: none;
    flex-direction: column;
    align-items: center;
}
#imageSourceModal h3 {
    margin-top: 0;
    color: var(--p);
    text-align: center;
}
#imageSourceModal button {
    margin: 10px 0;
    padding: 15px;
    font-size: 16px;
    border-radius: 10px;
    width: 100%;
}

/* Toast Animation */
.toast.show{
    display:block;
    animation: fadeInOut 2.5s ease-in-out forwards;
}

@keyframes fadeInOut {
    0% { opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { opacity: 0; }
}

/* List Item */
.list-item{
    background: var(--card-bg);
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    border-right: 5px solid var(--s); 
    color: var(--text-dark);
}
.list-item:hover {
    background: color-mix(in srgb, var(--card-bg) 95%, #999);
    box-shadow: var(--shadow-light);
}
.list-item .details {
    font-size: 0.9em; 
    color: #666; 
    text-align: right;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 5px;
}
</style>
</head>

<body>

<header>
    <button onclick="openSidebar()"><i class="fas fa-bars"></i></button> 
    <span class="title">Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</span>
    <button style="visibility: hidden;"><i class="fas fa-search"></i></button> 
</header>

<div class="tabs">
    <button class="active" onclick="openTab('overview')">
        <i class="fas fa-tachometer-alt" style="margin-left: 5px;"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©
    </button>
    <button onclick="openTab('expenses')">
        <i class="fas fa-money-bill-wave" style="margin-left: 5px;"></i> Ù…ØµØ±ÙˆÙØ§Øª
    </button>
    <button onclick="openTab('rights')">
        <i class="fas fa-handshake" style="margin-left: 5px;"></i> Ø­Ù‚ÙˆÙ‚
    </button>
    <button onclick="openTab('debts')">
        <i class="fas fa-file-invoice" style="margin-left: 5px;"></i> Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    </button>
</div>

<div id="overview" class="section active">
    <div class="balance-display">
        <h2>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
        <p id="currentBalanceDisplay">
            <i class="fas fa-spinner fa-spin"></i>
        </p>
        <button onclick="toggleBalanceVisibility()" id="balanceVisibilityToggle" title="Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±ØµÙŠØ¯">
             <i class="fas fa-eye"></i>
        </button>
    </div>

    <div class="balance-actions">
        <button class="action deposit" onclick="openBalanceActionModal('deposit')">
            <i class="fas fa-plus-circle"></i> Ø¥ÙŠØ¯Ø§Ø¹
        </button>
        <button class="action withdraw" onclick="openBalanceActionModal('withdraw')">
            <i class="fas fa-minus-circle"></i> Ø³Ø­Ø¨
        </button>
    </div>
    
    <button class="secondary" onclick="openBalanceLogModal()" style="margin-top: 15px;">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯
    </button>
    <div class="card" style="margin-top: 20px; border-top: 5px solid var(--p);">
        <h3 style="color: var(--p); margin-top: 0;"><i class="fas fa-calculator" style="margin-left: 5px;"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
        <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (ØªØ´Ù…Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª):</span> <b id="sExpTotal">0</b></p>
        <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©:</span> <b id="sRigTotal">0</b></p>
        <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©:</span> <b id="sDebTotal">0</b></p>
        <p><span>Ø§Ù„Ù…Ø­ØµÙ„ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ‚:</span> <b id="sRigPaid">0</b></p>
        <p><span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª:</span> <b id="sDebPaid">0</b></p>
        </div>
</div>

<div id="expenses" class="section">
    <div class="card">
    <p style="color: var(--danger); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡Ø§ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙˆØ±Ø§Ù‹</p>
    <input id="eAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
    <select id="eType">
    <option value="">ğŸ›’ Ø§Ù„ÙØ¦Ø© (Ù†ÙÙ‚Ø§Øª Ù…ØªØºÙŠØ±Ø©)</option>
    <option>Ø·Ø¹Ø§Ù…</option><option>Ù…ÙˆØ§ØµÙ„Ø§Øª</option>
    <option>Ø±Ø¹Ø§ÙŠØ© Ø´Ø®ØµÙŠØ©</option><option>Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
    <option>ØµØ­Ø©</option><option>ØªØ±ÙÙŠÙ‡</option><option>ØªØ³ÙˆÙ‚</option>
    <option>ØªØ¹Ù„ÙŠÙ…</option><option>ØµÙŠØ§Ù†Ø© ÙˆØ¥ØµÙ„Ø§Ø­</option><option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="eDesc" placeholder="ğŸ“ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
    <div class="datetime-container">
        <input id="eDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    
    <button class="secondary" onclick="showImageSourceModal()">
        <i class="fas fa-camera" style="margin-left: 5px;"></i> Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    </button>
    <span id="eImgName" style="display: block; font-size: 0.8em; color: var(--success); text-align: right; margin-top: 5px;"></span>
    <input type="file" id="eImgCamera" accept="image/*" capture="camera" style="display: none;" onchange="updateFileName(this, 'eImgName')">
    <input type="file" id="eImgGallery" accept="image/*" style="display: none;" onchange="updateFileName(this, 'eImgName')">
    <button class="action" onclick="addExpense()">
        <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ
    </button>
    <button class="secondary" onclick="openLog('exp')">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
    </button>
    </div>
</div>

<div id="rights" class="section">
    <div class="card">
    <p style="color: var(--success); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„Ø© (Ø¯ÙØ¹ Ø§Ù„Ø¯ÙŠÙ†/Ø§Ù„Ø¢Ø¬Ù„) ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
    <select id="rType" onchange="updateRightFields(this.value)">
    <option value="">ğŸ¤ Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚</option>
    <option>Ø¯ÙŠÙ†</option>
    <option>Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„</option>
    <option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="rAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚ (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ)" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
    <div id="rDynamicFields"></div>
    <input id="rDesc" placeholder="ğŸ‘¤ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ù„Ù…Ø¯ÙŠÙ†/Ø§Ù„Ø¬Ù‡Ø©)">
    <div class="datetime-container">
        <input id="rDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    <select id="rStatus">
    <option value="">âœ… Ø§Ù„Ø­Ø§Ù„Ø©</option>
    <option value="ÙƒØ§Ù…Ù„">Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</option>
    <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ Ø¨Ø¹Ø¯</option>
    </select>
    <button class="action" onclick="addRight()">
        <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ø­Ù‚
    </button>
    <button class="secondary" onclick="openLog('rig')">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ‚
    </button>
    </div>
</div>

<div id="debts" class="section">
    <div class="card">
    <p style="color: var(--danger); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø¯ÙØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
    <select id="dType" onchange="updateDebtFields(this.value)">
    <option value="">ğŸ§¾ Ù†ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</option>
    <option>Ø¥ÙŠØ¬Ø§Ø±</option>
    <option>ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
    <option>Ù…Ø§Ø¡</option>
    <option>Ø¥Ù†ØªØ±Ù†Øª</option>
    <option>Ù‚Ø±Ø¶</option> <option>Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ</option> <option>Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø© Ø£Ø®Ø±Ù‰</option>
    <option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="dAmount" type="text" placeholder="ğŸ’µ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©/Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">

    <div id="dDynamicFields"></div>
    <input id="dDesc" placeholder="ğŸ¢ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ù„Ø¯Ø§Ø¦Ù†/Ø§Ù„Ø¬Ù‡Ø©)">
    <div class="datetime-container">
        <input id="dDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    <select id="dStatus">
    <option value="">âœ… Ø§Ù„Ø­Ø§Ù„Ø©</option>
    <option value="Ù…Ø¯ÙÙˆØ¹">Ù…Ø¯ÙÙˆØ¹</option>
    <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
    </select>
    <button class="action" onclick="addDebt()">
        <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…
    </button>
    <button class="secondary" onclick="openLog('deb')">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    </button>
    </div>
</div>

<div class="modal" id="logModal">
    <header>
        <div class="title-row">
            <input id="search" type="text" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙˆØµÙ ÙˆØ§Ù„ÙØ¦Ø© ÙˆØ§Ù„Ø­Ø§Ù„Ø©" oninput="renderLog()">
            <button onclick="closeLayer('log')"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="filter-row">
            <div>
                <label for="filterMinAmount">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£Ø¯Ù†Ù‰</label>
                <input id="filterMinAmount" type="text" oninput="formatAmount(this); renderLog()" inputmode="decimal" placeholder="Ù…Ù†">
            </div>
            <div>
                <label for="filterMaxAmount">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£Ù‚ØµÙ‰</label>
                <input id="filterMaxAmount" type="text" oninput="formatAmount(this); renderLog()" inputmode="decimal" placeholder="Ø¥Ù„Ù‰">
            </div>
            
            <div>
                <label for="filterStartDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
                <input id="filterStartDate" type="date" onchange="renderLog()">
            </div>
            <div>
                <label for="filterEndDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</label>
                <input id="filterEndDate" type="date" onchange="renderLog()">
            </div>
        </div>
        
        <div class="filter-row">
            <select id="filterCategory" onchange="renderLog()" class="full-width">
                <option value="">ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø© / Ø§Ù„Ù†ÙˆØ¹ / Ø§Ù„Ø­Ø§Ù„Ø©</option>
            </select>
        </div>
        </header>
    <div class="modal-content" id="logContent"></div>
</div>

<div class="modal" id="detailModal">
    <header>
        <div class="title-row">
            <span class="title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</span>
            <button onclick="closeLayer('detail')"><i class="fas fa-times"></i></button>
        </div>
    </header>
    <div class="modal-content detail" id="detailContent"></div>
</div>

<div class="modal" id="balanceActionModal">
    <header>
        <div class="title-row">
            <span class="title" id="actionModalTitle"></span>
            <button onclick="closeLayer('balanceAction')"><i class="fas fa-times"></i></button>
        </div>
    </header>
    <div class="modal-content">
        <p style="text-align: center; font-size: 1.1em;">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="currentBalanceInAction" style="color: var(--p); font-weight: bold;"></span></p>
        <input id="bAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
        <input id="bDesc" placeholder="ğŸ“ ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Ù…Ø«Ù„: Ø±Ø§ØªØ¨ØŒ ØªØ­ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ)">
        <div class="datetime-container">
            <input id="bDate" type="datetime-local">
            <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
        </div>
        <button class="action" onclick="processBalanceAction()">
            <i class="fas fa-check" style="margin-left: 5px;"></i> ØªÙ†ÙÙŠØ°
        </button>
    </div>
</div>

<div class="modal" id="balanceLogModal">
    <header>
        <div class="title-row">
            <input id="balanceSearch" type="text" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø±ØµÙŠØ¯ (Ø§Ù„ÙˆØµÙØŒ Ø§Ù„Ù†ÙˆØ¹)" oninput="renderBalanceLog()">
            <button onclick="closeLayer('balanceLog')"><i class="fas fa-times"></i></button>
        </div>
    </header>
    <div class="modal-content" id="balanceLogContent">
        </div>
</div>

<div id="imageSourceModal">
    <h3 style="margin-bottom: 20px;">Ø§Ø®ØªÙŠØ§Ø± Ù…ØµØ¯Ø± Ø§Ù„ØµÙˆØ±Ø©</h3>
    <button class="action" onclick="openCameraInput()"><i class="fas fa-camera" style="margin-left: 10px;"></i> Ø§Ù„ØªÙ‚Ø§Ø· Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
    <button class="secondary" onclick="openGalleryInput()"><i class="fas fa-images" style="margin-left: 10px;"></i> Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ø¶</button>
    <button class="secondary" style="background: none; border: none; color: var(--danger); margin-top: 10px;" onclick="closeLayer('imageSource')">Ø¥Ù„ØºØ§Ø¡</button>
</div>
<div class="sidebar-overlay" id="imageSourceOverlay" style="z-index: 140; display: none;" onclick="closeLayer('imageSource')"></div>

<div class="toast" id="toast"></div>

<div class="sidebar-overlay" onclick="closeLayer('sidebar')"></div>

<div class="sidebar" id="appSidebar">
    <div class="sidebar-header">
        <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        <button onclick="closeLayer('sidebar')"><i class="fas fa-times"></i></button>
    </div>
    <div class="sidebar-content">
        <div class="card" style="margin: 0 15px 15px; border-top: 5px solid var(--s);">
             <p style="font-weight: bold; margin-top: 0; color: var(--p);">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</p>
             
             <div class="switch-container">
                 <i class="fas fa-moon" style="margin-left: 10px;"></i> <span>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span>
                 <label class="switch">
                     <input type="checkbox" id="darkModeToggle" onclick="toggleDarkMode()">
                     <span class="slider"></span>
                 </label>
             </div>
             
             <button class="secondary" onclick="openCurrencyModal()" style="display: flex; justify-content: space-between; align-items: center; border: none; background: var(--card-bg); margin-top: 15px;">
                 <span id="currentCurrencyDisplay" style="font-weight: bold;">Ø§Ù„Ø¹Ù…Ù„Ø©: Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ (Ø±.Ø³)</span>
                 <span style="color: var(--p);"><i class="fas fa-exchange-alt"></i> ØªØºÙŠÙŠØ±</span>
             </button>
        </div>
        
        <div class="sidebar-menu-item" onclick="exportData()">
            <i class="fas fa-file-export"></i> <span>ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</span>
        </div>
        
        <div class="sidebar-menu-item" onclick="document.getElementById('importFile').click()">
            <i class="fas fa-file-import"></i> <span>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</span>
        </div>
        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
        
        <div class="sidebar-menu-item" onclick="openAboutModal()">
            <i class="fas fa-info-circle"></i> <span>Ø­ÙˆÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>
        </div>
        
        <div class="sidebar-menu-item" onclick="confirmResetData()" style="color: var(--danger);">
            <i class="fas fa-exclamation-triangle"></i> <span>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        </div>
    </div>
</div>

<div class="modal" id="aboutModal">
    <header>
        <div class="title-row">
            <h3 style="color: var(--p); margin: 0;">Ø­ÙˆÙ„ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ©</h3>
            <button onclick="closeLayer('about')"><i class="fas fa-times"></i></button>
        </div>
    </header>
    <div class="modal-content">
        <p>ØªØ·Ø¨ÙŠÙ‚ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© Ù‡Ùˆ Ø£Ø¯Ø§Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ ØªØªØ¨Ø¹:</p>
        <ul>
            <li><i class="fas fa-wallet" style="color: var(--s);"></i> **Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø©** Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.</li>
            <li><i class="fas fa-receipt" style="color: var(--s);"></i> **Ø§Ù„Ø­Ù‚ÙˆÙ‚** Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ù„Ùƒ (Ø¯ÙŠÙˆÙ†ØŒ Ø¨ÙŠØ¹ Ø¢Ø¬Ù„).</li>
            <li><i class="fas fa-clipboard-list" style="color: var(--s);"></i> **Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª** Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ø¹Ù„ÙŠÙƒ (ÙÙˆØ§ØªÙŠØ±ØŒ Ø£Ù‚Ø³Ø§Ø·ØŒ Ù‚Ø±ÙˆØ¶).</li>
        </ul>
        <p class="card" style="border-top: 3px solid var(--danger);">
            <strong>Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©:</strong> ÙŠØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ© IndexedDBØŒ ÙˆÙ„Ø§ ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ø£ÙŠ Ø®Ø§Ø¯Ù… Ø®Ø§Ø±Ø¬ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ.
        </p>
        <p style="text-align: center; margin-top: 20px; color: #999; font-size: 0.9em;">Ø§Ù„Ø¥ØµØ¯Ø§Ø± 3.2 (Ù…Ø·ÙˆØ± ÙˆÙ…Ø«Ø¨Øª)</p>
    </div>
</div>

<div class="modal" id="currencyModal">
    <header>
        <div class="title-row">
            <h3 style="color: var(--p); margin: 0;">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø©</h3>
            <button onclick="closeLayer('currency')"><i class="fas fa-times"></i></button>
        </div>
    </header>
    <div class="modal-content">
        <input id="currencySearch" type="text" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„Ø© (Ø±ÙŠØ§Ù„ØŒ Ø¬Ù†ÙŠÙ‡ØŒ Ø¯ÙˆÙ„Ø§Ø±...)" oninput="renderCurrencyList()">
        <div id="currencyList">
            </div>
    </div>
</div>

<script>
// ===================================================
// 1. Ø¥Ø¹Ø¯Ø§Ø¯ IndexedDB ÙˆÙ…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Øª
// ===================================================

const IDB_NAME = "MySmartBudgetDB";
const IDB_VERSION = 4; // ØªÙ… Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¥ØµØ¯Ø§Ø±
const STORE_NAMES = ["exp", "rig", "deb", "bal"]; 
let db = { exp: [], rig: [], deb: [], bal: { clientId: 1, amount: 0, changes: [] } }; // ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ©
let IDB_connection = null; 

// Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
let currentLog = "", editMode = null, balanceActionType = null;
let currentBalance = 0; 
let balanceHidden = localStorage.getItem('balanceHidden') === 'true'; 

// Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ù‚Ù„
const LAYERS = {
    'sidebar': { elementId: 'appSidebar', type: 'menu' },
    'log': { elementId: 'logModal', type: 'modal' },
    'detail': { elementId: 'detailModal', type: 'modal' },
    'currency': { elementId: 'currencyModal', type: 'modal' },
    'about': { elementId: 'aboutModal', type: 'modal' },
    'balanceAction': { elementId: 'balanceActionModal', type: 'modal' },
    'balanceLog': { elementId: 'balanceLogModal', type: 'modal' }, 
    'imageSource': { elementId: 'imageSourceModal', type: 'menu' } 
};
let historyStack = [];

const ARABIC_CURRENCIES = [
    { code: 'SAR', symbol: 'Ø±.Ø³', name: 'Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ' },
    { code: 'EGP', symbol: 'Ø¬.Ù…', name: 'Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ' },
    { code: 'AED', symbol: 'Ø¯.Ø¥', name: 'Ø¯Ø±Ù‡Ù… Ø¥Ù…Ø§Ø±Ø§ØªÙŠ' },
    { code: 'KWD', symbol: 'Ø¯.Ùƒ', name: 'Ø¯ÙŠÙ†Ø§Ø± ÙƒÙˆÙŠØªÙŠ' },
    { code: 'BHD', symbol: 'Ø¯.Ø¨', name: 'Ø¯ÙŠÙ†Ø§Ø± Ø¨Ø­Ø±ÙŠÙ†ÙŠ' },
    { code: 'QAR', symbol: 'Ø±.Ù‚', name: 'Ø±ÙŠØ§Ù„ Ù‚Ø·Ø±ÙŠ' },
    { code: 'OMR', symbol: 'Ø±.Ø¹.', name: 'Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ' },
    { code: 'JOD', symbol: 'Ø¯.Ø§', name: 'Ø¯ÙŠÙ†Ø§Ø± Ø£Ø±Ø¯Ù†ÙŠ' },
    { code: 'LBP', symbol: 'Ù„.Ù„', name: 'Ù„ÙŠØ±Ø© Ù„Ø¨Ù†Ø§Ù†ÙŠØ©' },
    { code: 'DZD', symbol: 'Ø¯.Ø¬', name: 'Ø¯ÙŠÙ†Ø§Ø± Ø¬Ø²Ø§Ø¦Ø±ÙŠ' },
    { code: 'TND', symbol: 'Ø¯.Øª', name: 'Ø¯ÙŠÙ†Ø§Ø± ØªÙˆÙ†Ø³ÙŠ' },
    { code: 'MAD', symbol: 'Ø¯.Ù….', name: 'Ø¯Ø±Ù‡Ù… Ù…ØºØ±Ø¨ÙŠ' },
    { code: 'YER', symbol: 'Ø±.ÙŠ', name: 'Ø±ÙŠØ§Ù„ ÙŠÙ…Ù†ÙŠ' },
    { code: 'IQD', symbol: 'Ø¹.Ø¯', name: 'Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ' },
    { code: 'SDG', symbol: 'Ø¬.Ø³', name: 'Ø¬Ù†ÙŠÙ‡ Ø³ÙˆØ¯Ø§Ù†ÙŠ' },
    { code: 'SYP', symbol: 'Ù„.Ø³', name: 'Ù„ÙŠØ±Ø© Ø³ÙˆØ±ÙŠØ©' },
    { code: 'USD', symbol: '$', name: 'Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ' },
    { code: 'EUR', symbol: 'â‚¬', name: 'ÙŠÙˆØ±Ùˆ' },
];
let currentCurrency = ARABIC_CURRENCIES.find(c => c.code === (localStorage.getItem('currencyCode') || 'SAR'));

// ===================================================
// 2. ÙˆØ¸Ø§Ø¦Ù IndexedDB ÙˆØ§Ù„Ø­ÙØ¸
// ===================================================
function initDB() {
    return new Promise((resolve, reject) => {
        if (!window.indexedDB) {
            toastMsg("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… IndexedDB. Ù„Ù† ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
            return reject(new Error("IndexedDB not supported."));
        }
        const request = indexedDB.open(IDB_NAME, IDB_VERSION);
        request.onerror = (e) => {
            console.error("IndexedDB error:", e.target.error);
            reject(e.target.error);
        };
        request.onupgradeneeded = (e) => {
            IDB_connection = e.target.result;
            STORE_NAMES.forEach(storeName => {
                if (IDB_connection.objectStoreNames.contains(storeName)) {
                    IDB_connection.deleteObjectStore(storeName);
                }
                const keyPath = (storeName === 'bal') ? 'clientId' : 'id';
                const autoIncrement = (storeName !== 'bal');
                const store = IDB_connection.createObjectStore(storeName, { keyPath: keyPath, autoIncrement: autoIncrement });
                if(storeName === 'bal') { 
                    store.add({ clientId: 1, amount: 0, changes: [] });
                }
            });
        };
        request.onsuccess = (e) => {
            IDB_connection = e.target.result;
            resolve(IDB_connection);
            loadAllData().then(() => {
                updateStats();
                updateBalanceDisplay();
            });
        };
    });
}
initDB();

function saveData(storeName, data) {
    return new Promise((resolve, reject) => {
        if (!IDB_connection) return reject(new Error("Database not connected."));
        const transaction = IDB_connection.transaction([storeName], "readwrite");
        const store = transaction.objectStore(storeName);
        const request = store.put(data);
        request.onsuccess = () => resolve(request.result);
        request.onerror = (e) => reject(e.target.error);
    });
}

function deleteFromDB(storeName, id) {
    return new Promise((resolve, reject) => {
        if (!IDB_connection) return reject(new Error("Database not connected."));
        const transaction = IDB_connection.transaction([storeName], "readwrite");
        const store = transaction.objectStore(storeName);
        const request = store.delete(id);
        request.onsuccess = () => resolve();
        request.onerror = (e) => reject(e.target.error);
    });
}

function loadStoreData(storeName) {
    return new Promise((resolve) => {
        if (!IDB_connection) return resolve([]);
        const transaction = IDB_connection.transaction([storeName], "readonly");
        const store = transaction.objectStore(storeName);
        const request = store.getAll();
        request.onsuccess = (e) => {
            if(storeName === 'bal') { 
                const result = e.target.result[0];
                return resolve(result || { clientId: 1, amount: 0, changes: [] });
            }
            resolve(e.target.result.reverse());
        };
        request.onerror = () => resolve(storeName === 'bal' ? { clientId: 1, amount: 0, changes: [] } : []);
    });
}

async function loadAllData() {
    const [expData, rigData, debData, balData] = await Promise.all([
        loadStoreData('exp'),
        loadStoreData('rig'),
        loadStoreData('deb'),
        loadStoreData('bal'),
    ]);
    db.exp = expData;
    db.rig = rigData;
    db.deb = debData;
    db.bal = balData;
    currentBalance = db.bal.amount || 0;
}


// ===================================================
// 3. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆØ§Ù„Ù…Ù„Ø§Ø­ÙŠØ© (Ø¥ØµÙ„Ø§Ø­ Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹)
// ===================================================

function loadDarkModePreference() {
    const isDark = localStorage.getItem('darkMode') === 'true';
    if (isDark) {
        document.body.classList.add('dark-mode');
        const toggle = document.getElementById('darkModeToggle');
        if (toggle) toggle.checked = true;
    }
}
function toggleDarkMode() {
    const isDark = document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', isDark);
}
function toggleBalanceVisibility() {
    balanceHidden = !balanceHidden;
    localStorage.setItem('balanceHidden', balanceHidden);
    updateBalanceDisplay();
}
loadDarkModePreference();

function openLayer(layerName, data = {}) {
    const layer = LAYERS[layerName];
    if (!layer) return;

    if (layer.type === 'modal') {
        const element = document.getElementById(layer.elementId);
        if (element) {
            element.style.display = 'flex';
            historyStack.push(layerName);
        }
    } else if (layer.type === 'menu') {
        const element = document.getElementById(layer.elementId);
        if (element) {
            element.classList.add('open');
            const overlay = document.querySelector(layerName === 'imageSource' ? '#imageSourceOverlay' : '.sidebar-overlay');
            if (overlay) overlay.classList.add('open');
            historyStack.push(layerName);
        }
    }
    
    // Ø¯Ø¹Ù… Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ / Ø§Ù„Ù‡Ø§ØªÙ
    if (historyStack.length > 0) {
        // Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØªØµÙØ­
        window.history.pushState({ layer: layerName }, '', `#${layerName}`);
    }
}

function closeLayer(layerName, clearEdit = true) {
    const layer = LAYERS[layerName];
    if (!layer) return;

    const element = document.getElementById(layer.elementId);

    if (layer.type === 'modal') {
        if (element) {
            element.style.display = 'none';
        }
        if (clearEdit && (layerName === 'detail' || layerName === 'log')) {
             editMode = null;
        }
    } else if (layer.type === 'menu') {
        if (element) {
            element.classList.remove('open');
        }
        const overlay = document.querySelector(layerName === 'imageSource' ? '#imageSourceOverlay' : '.sidebar-overlay');
        if (overlay) overlay.classList.remove('open');
    }
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ù‚Ø© Ù…Ù† Ù…ÙƒØ¯Ø³ Ø§Ù„Ø³Ø¬Ù„
    const index = historyStack.lastIndexOf(layerName);
    if (index > -1) {
        historyStack.splice(index, 1);
    }
}

function openSidebar() {
    openLayer('sidebar');
}
function openCurrencyModal() {
    renderCurrencyList();
    openLayer('currency');
}
function openAboutModal() {
    openLayer('about');
}

function closeCurrentLayer(fromPopState = false) {
    if (historyStack.length === 0) return;
    const currentLayerName = historyStack[historyStack.length - 1];
    
    closeLayer(currentLayerName, true);
    
    // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ø­Ø±ÙƒØ© Ù†Ø§ØªØ¬Ø© Ø¹Ù† Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ØŒ ÙÙ‚Ù… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
    if (!fromPopState) {
        window.history.go(-1);
    }
}

// Ù…Ø¹Ø§Ù„Ø¬ Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
window.onpopstate = (event) => {
    // ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ±Ø¬Ø¹ Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙŠ ÙƒØ§Ù†Øª Ù‚Ø¨Ù„ ÙØªØ­ Ø¢Ø®Ø± Ø·Ø¨Ù‚Ø©
    if (event.state && event.state.layer) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø­Ø§Ù„Ø© Ù…Ø³Ø¬Ù„Ø©ØŒ Ø£ØºÙ„Ù‚ Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        const layerToClose = historyStack.find(l => l === event.state.layer);
        if (layerToClose) {
             // Ø£ØºÙ„Ù‚ ÙƒÙ„ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ø§Ù„ØªÙŠ Ø£ØªØª Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© (Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø£Ø®ÙŠØ±Ø©)
             while(historyStack[historyStack.length - 1] !== layerToClose && historyStack.length > 0) {
                 closeLayer(historyStack[historyStack.length - 1], false);
             }
             closeLayer(layerToClose, false);
        }
    } else if (historyStack.length > 0) {
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø­Ø§Ù„Ø© Ù…Ø³Ø¬Ù„Ø© ÙˆÙ„ÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø·Ø¨Ù‚Ø§Øª Ù…ÙØªÙˆØ­Ø© (Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚)
        closeCurrentLayer(true); 
    }
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ÙƒØ¯Ø³ ÙØ§Ø±ØºØ§Ù‹ØŒ Ø¹Ø¯ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©
    if(historyStack.length === 0) {
        window.location.hash = '';
    }
};

// ----------------- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…Ù„Ø© ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù… -----------------

function parseAmount(amount) {
  let str = String(amount || 0).replace(/[ØŒ\u066c]/g, '').replace(/[^\d.]/g, ''); 
  // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø¯Ù‚Ø© parseFloat
  str = str.replace(/([Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©])/g, (d) => String.fromCharCode(d.charCodeAt(0) - 1632 + 48));
  return parseFloat(str) || 0;
}

function formatAmount(input) {
    let num = parseAmount(input.value);
    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ù‚Ù… Ù…Ø¹ ÙØ§ØµÙ„ Ø§Ù„Ø£Ù„ÙˆÙ Ø§Ù„Ø¹Ø±Ø¨ÙŠ
    input.value = num.toLocaleString('ar', { 
        minimumFractionDigits: num % 1 === 0 ? 0 : 2,
        maximumFractionDigits: 2 
    });
}

function getFormattedAmount(num) {
    if (typeof num !== 'number' || isNaN(num)) num = 0;
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… 'ar' Ù„Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¨ÙŠ
    return num.toLocaleString('ar', { 
        minimumFractionDigits: num % 1 === 0 ? 0 : 2,
        maximumFractionDigits: 2 
    });
}

function formatCurrency(amount, includeColor = false) {
    const formatted = getFormattedAmount(amount);
    const color = includeColor ? (amount > 0 ? 'var(--success)' : (amount < 0 ? 'var(--danger)' : 'var(--p)')) : '';
    return `<span style="color: ${color};"><span class="currency-symbol">${currentCurrency.symbol}</span> ${formatted}</span>`;
}

function toastMsg(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => {
        toast.classList.remove('show');
    }, 2500);
}

function updateBalanceDisplay() {
    const display = document.getElementById('currentBalanceDisplay');
    const toggleButton = document.getElementById('balanceVisibilityToggle');
    
    if (balanceHidden) {
        display.innerHTML = `<span class="hidden-balance">â€¢â€¢â€¢â€¢â€¢â€¢</span>`;
        toggleButton.innerHTML = `<i class="fas fa-eye-slash"></i>`;
    } else {
        display.innerHTML = formatCurrency(currentBalance, true);
        toggleButton.innerHTML = `<i class="fas fa-eye"></i>`;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹/Ø§Ù„Ø³Ø­Ø¨
    const actionBalanceDisplay = document.getElementById('currentBalanceInAction');
    if (actionBalanceDisplay) {
         actionBalanceDisplay.innerHTML = formatCurrency(currentBalance, true);
    }
}

function formatDateTime(dateString) {
    if (!dateString) return 'â€”';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('ar-EG', { 
            year: 'numeric', month: 'short', day: 'numeric', 
            hour: '2-digit', minute: '2-digit' 
        });
    } catch (e) {
        return dateString;
    }
}


// ----------------- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -----------------

function updateFileName(input, displayId) {
    const display = document.getElementById(displayId);
    if (input.files.length > 0) {
        // ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… FileReader Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Base64
        const file = input.files[0];
        const reader = new FileReader();
        reader.onloadend = function() {
            display.dataset.base64 = reader.result;
            display.textContent = `ØªÙ… Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø©: ${file.name}`;
        }
        reader.readAsDataURL(file);
    } else {
        display.dataset.base64 = '';
        display.textContent = '';
    }
}

function openTab(tabName) {
    document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    
    document.querySelectorAll('.tabs button').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.tabs button[onclick="openTab('${tabName}')"]`).classList.add('active');
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªÙ†Ù‚Ù„
    updateStats();
    
    // Ù…Ø³Ø­ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
    editMode = null;
}

// ===================================================
// 4. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª 
// ===================================================

function updateStats() {
    const expTotal = db.exp.reduce((sum, item) => sum + parseAmount(item.Ø§Ù„Ù…Ø¨Ù„Øº || 0), 0);
    
    let rigTotal = 0, rigPaid = 0;
    db.rig.forEach(item => {
        const amount = parseAmount(item.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø³ØªØ­Ù‚_Ø§Ù„ÙƒÙ„ÙŠ || item.Ø§Ù„Ù…Ø¨Ù„Øº || 0);
        rigTotal += amount;
        
        // Ø§Ù„ØªØ­ØµÙŠÙ„ Ù…Ù† Ø§Ù„Ø¯ÙŠÙ†
        if (item.Ø§Ù„Ù†ÙˆØ¹ === 'Ø¯ÙŠÙ†') {
            rigPaid += parseAmount(item.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¯ÙÙˆØ¹ || 0);
        } else if (item.Ø§Ù„Ø­Ø§Ù„Ø© === 'ÙƒØ§Ù…Ù„') {
            rigPaid += amount;
        }
    });

    let debTotal = 0, debPaid = 0;
    db.deb.forEach(item => {
        if (item.Ø§Ù„Ù†ÙˆØ¹ === 'Ù‚Ø±Ø¶' || item.Ø§Ù„Ù†ÙˆØ¹ === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ') {
            const total = parseAmount(item.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù… || 0);
            debTotal += total;
            debPaid += parseAmount(item.Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„Ù…Ø¯ÙÙˆØ¹ || 0);
        } else {
            const amount = parseAmount(item.Ø§Ù„Ù…Ø¨Ù„Øº || 0);
            debTotal += amount;
            if (item.Ø§Ù„Ø­Ø§Ù„Ø© === 'Ù…Ø¯ÙÙˆØ¹') {
                debPaid += amount;
            }
        }
    });

    document.getElementById('sExpTotal').innerHTML = formatCurrency(expTotal);
    document.getElementById('sRigTotal').innerHTML = formatCurrency(rigTotal);
    document.getElementById('sDebTotal').innerHTML = formatCurrency(debTotal);
    document.getElementById('sRigPaid').innerHTML = formatCurrency(rigPaid, true);
    document.getElementById('sDebPaid').innerHTML = formatCurrency(debPaid);
}


// ===================================================
// 5. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¥ØµÙ„Ø§Ø­ ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„)
// ===================================================

function clearForm(section) {
    const ids = {
        'e': ['eAmount', 'eType', 'eDesc', 'eDate', 'eImgName'],
        'r': ['rAmount', 'rType', 'rDesc', 'rDate', 'rStatus'],
        'd': ['dAmount', 'dType', 'dDesc', 'dDate', 'dStatus'],
    };
    
    const elements = ids[section];
    if (elements) {
        elements.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                if (el.tagName === 'SELECT') {
                    el.value = ''; 
                } else if (el.type === 'text' || el.type === 'datetime-local' || el.type === 'date') {
                    el.value = '';
                    el.style.border = '1px solid var(--border-color)'; // Ø¥Ø¹Ø§Ø¯Ø© Ù„ÙˆÙ† Ø§Ù„Ø­Ø¯ÙˆØ¯
                }
                if (id === 'eImgName') {
                    el.textContent = '';
                    el.dataset.base64 = '';
                }
            }
        });
    }
    
    // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
    const rDynamic = document.getElementById('rDynamicFields');
    if (rDynamic) rDynamic.innerHTML = '';
    const dDynamic = document.getElementById('dDynamicFields');
    if (dDynamic) dDynamic.innerHTML = '';

    const rStatus = document.getElementById('rStatus');
    if (rStatus) rStatus.style.display = 'block';

    const dAmount = document.getElementById('dAmount');
    const dStatus = document.getElementById('dStatus');
    if (dAmount) dAmount.style.display = 'block';
    if (dStatus) dStatus.style.display = 'block';
    
    editMode = null;
}


// ----------------- Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ‚ ÙˆØ§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª -----------------

function calculateRightRemaining() {
    const rAmountInput = document.getElementById('rAmount');
    const rPaidAmountInput = document.getElementById('rPaidAmount');
    const totalAmount = parseAmount(rAmountInput.value);
    const paidAmount = parseAmount(rPaidAmountInput ? rPaidAmountInput.value : 0);
    let remaining = totalAmount - paidAmount;

    const statusSelect = document.getElementById('rStatus');

    if (rPaidAmountInput) {
        if (remaining < 0) {
            rPaidAmountInput.style.border = '2px solid var(--danger)';
            remaining = 0; 
        } else {
            rPaidAmountInput.style.border = '1px solid var(--border-color)';
        }
    }
    
    const remainingDisplay = document.getElementById('rRemainingDisplay');
    if (remainingDisplay) {
         remainingDisplay.innerHTML = `Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${formatCurrency(remaining, remaining > 0)}`;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© (Ù„Ù„Ø¯ÙŠÙ† ÙÙ‚Ø·)
    if (statusSelect && statusSelect.style.display === 'none') {
        if (remaining <= 0.01) { 
            statusSelect.value = 'ÙƒØ§Ù…Ù„';
        } else if (paidAmount > 0) {
            statusSelect.value = 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹';
        } else {
            statusSelect.value = 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹';
        }
    }
}

function updateRightFields(type, currentData = null) {
    const container = document.getElementById('rDynamicFields');
    const statusSelect = document.getElementById('rStatus');
    
    container.innerHTML = '';
    
    if (type === 'Ø¯ÙŠÙ†') {
        const paidValue = currentData ? parseAmount(currentData.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¯ÙÙˆØ¹ || 0).toLocaleString('ar') : '';
        const remainingValue = currentData ? parseAmount(currentData.Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ || 0) : 0;
        
        container.innerHTML = `
            <input id="rPaidAmount" type="text" placeholder="ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø­Ø§Ù„ÙŠØ§Ù‹" oninput="formatAmount(this); calculateRightRemaining();" pattern="[0-9]*" inputmode="decimal" value="${paidValue}">
            <p id="rRemainingDisplay" style="text-align: right; margin-top: -5px; font-size: 0.9em; color: var(--p);">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${formatCurrency(remainingValue, remainingValue > 0)}</p>
            <p style="color: var(--warning); font-size: 0.8em; text-align: right;">* Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙŠÙ† ÙŠØªÙ… Ø­Ø³Ø§Ø¨Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>
        `;
        
        if (statusSelect) statusSelect.style.display = 'none';
        
        setTimeout(() => {
            const rPaidAmountInput = document.getElementById('rPaidAmount');
            if(rPaidAmountInput) rPaidAmountInput.addEventListener('input', calculateRightRemaining);
            const rAmountInput = document.getElementById('rAmount');
            if(rAmountInput) rAmountInput.addEventListener('input', calculateRightRemaining);
            calculateRightRemaining();
        }, 50);

    } else {
        if (statusSelect) statusSelect.style.display = 'block';
    }
    
    const expectedDateValue = currentData ? currentData.ØªØ§Ø±ÙŠØ®_Ù…ØªÙˆÙ‚Ø¹ : '';
    container.innerHTML += `
        <div class="datetime-container" style="margin-top: 15px;">
            <input id="rExpectedDate" type="date" value="${expectedDateValue}">
            <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
        </div>
        <p style="color: #999; font-size: 0.8em; text-align: right; margin-top: -10px;">(ØªØ§Ø±ÙŠØ® Ù…ØªÙˆÙ‚Ø¹ Ù„Ù„ØªØ­ØµÙŠÙ„ - Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</p>
    `;
}

function calculateInstallmentValue() {
    const dTotalAmountInput = document.getElementById('dTotalAmount');
    const dInstallmentsInput = document.getElementById('dInstallments');
    const totalAmount = parseAmount(dTotalAmountInput.value);
    const installmentsTotal = parseInt(dInstallmentsInput.value) || 1;
    
    const installmentValue = installmentsTotal > 0 ? (totalAmount / installmentsTotal) : 0;
    
    const valueDisplay = document.getElementById('dInstallmentValueDisplay');
    if (valueDisplay) {
         valueDisplay.innerHTML = `Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„ÙˆØ§Ø­Ø¯: ${formatCurrency(installmentValue.toFixed(2))}`;
    }
}

function updateDebtFields(type, currentData = null) {
    const container = document.getElementById('dDynamicFields');
    const dAmountInput = document.getElementById('dAmount');
    const dStatusSelect = document.getElementById('dStatus');
    
    container.innerHTML = '';
    
    if (type === 'Ù‚Ø±Ø¶' || type === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ') {
        if (dAmountInput) dAmountInput.style.display = 'none';
        if (dStatusSelect) dStatusSelect.style.display = 'none';

        const totalValue = currentData ? parseAmount(currentData.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù… || 0).toLocaleString('ar') : '';
        const totalPaidValue = currentData ? parseAmount(currentData.Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„Ù…Ø¯ÙÙˆØ¹ || 0).toLocaleString('ar') : '';
        const remainingValue = currentData ? parseAmount(currentData.Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù… || 0) : 0;
        
        const isLoan = type === 'Ù‚Ø±Ø¶';
        const infoPlaceholder = isLoan ? 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†' : 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ ØªÙ… Ø¯ÙØ¹Ù‡ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†';
        const infoInputId = isLoan ? 'dPaidInstallments' : 'dPaidAmount';
        const infoValue = isLoan ? (currentData ? currentData.Ø§Ù„Ø£Ù‚Ø³Ø§Ø·_Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© || '' : '') : totalPaidValue;
        
        container.innerHTML = `
            <input id="dTotalAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…" oninput="formatAmount(this); ${isLoan ? 'calculateInstallmentValue();' : ''}" pattern="[0-9]*" inputmode="decimal" value="${totalValue}">
            
            ${isLoan ? `<input id="dInstallments" type="text" placeholder="ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„ÙƒÙ„ÙŠ" oninput="formatAmount(this); calculateInstallmentValue();" pattern="[0-9]*" inputmode="numeric" value="${currentData ? currentData.Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ù‚Ø³Ø§Ø· || '' : ''}">
                        <p id="dInstallmentValueDisplay" style="text-align: right; margin-top: -10px; font-size: 0.9em; color: var(--s);">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„ÙˆØ§Ø­Ø¯: ${formatCurrency(0)}</p>` : ''}

            <input id="${infoInputId}" type="text" placeholder="âœ… ${infoPlaceholder}" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal" value="${infoValue}">
            <p style="text-align: right; margin-top: -10px; font-size: 0.9em; color: var(--p);">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…: ${formatCurrency(remainingValue, remainingValue > 0)}</p>
            <p style="color: var(--warning); font-size: 0.8em; text-align: right;">* Ø§Ù„Ø¯ÙØ¹ ÙŠØ¯ÙˆÙŠ Ø¹Ø¨Ø± Ø´Ø§Ø´Ø© Ø³Ø­Ø¨ Ø§Ù„Ø±ØµÙŠØ¯.</p>
        `;
        
        if (isLoan) {
             setTimeout(calculateInstallmentValue, 50);
        }

    } else {
        // ÙÙˆØ§ØªÙŠØ± ÙˆØ£Ù‚Ø³Ø§Ø· Ø¹Ø§Ø¯ÙŠØ©
        if (dAmountInput) dAmountInput.style.display = 'block';
        if (dStatusSelect) dStatusSelect.style.display = 'block';
    }
}


// ----------------- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠ ÙÙŠ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª) -----------------

async function addExpense() {
    const amount = parseAmount(document.getElementById('eAmount').value);
    const type = document.getElementById('eType').value;
    const desc = document.getElementById('eDesc').value;
    const date = document.getElementById('eDate').value || new Date().toISOString().slice(0, 16);
    const imgData = document.getElementById('eImgName').dataset.base64 || '';

    if (!amount || !type) {
        return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ¦Ø©.");
    }
    
    const newId = editMode ? editMode.data.id : Date.now();
    const isNew = !editMode;
    
    const newExp = {
        id: newId,
        Ø§Ù„ØªØ§Ø±ÙŠØ®: date,
        Ø§Ù„Ù…Ø¨Ù„Øº: getFormattedAmount(amount),
        Ø§Ù„ÙØ¦Ø©: type,
        Ø§Ù„ÙˆØµÙ: desc,
        Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø®ØµÙˆÙ…_Ù„Ù„Ø±ØµÙŠØ¯: getFormattedAmount(amount * -1),
        ØµÙˆØ±Ø©: imgData
    };
    
    let oldAmount = 0;
    if (editMode) {
        oldAmount = parseAmount(editMode.data.Ø§Ù„Ù…Ø¨Ù„Øº);
        db.exp = db.exp.filter(i => i.id !== newId);
    }
    db.exp.unshift(newExp);
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ (Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø®ØµÙ…: -amount)
    const balanceChange = oldAmount - amount; // (old was deducted, new is deducted) -> (old deducted) - (new deducted)
    await updateBalance(balanceChange, 'expense', newId, desc);

    await saveData('exp', newExp);
    clearForm('e');
    updateStats();
    toastMsg(isNew ? "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­." : "ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­.");
}

async function addRight() {
    const type = document.getElementById('rType').value;
    const totalAmount = parseAmount(document.getElementById('rAmount').value);
    const desc = document.getElementById('rDesc').value;
    const date = document.getElementById('rDate').value || new Date().toISOString().slice(0, 16);
    let status = document.getElementById('rStatus').value;
    const expectedDate = document.getElementById('rExpectedDate') ? document.getElementById('rExpectedDate').value : '';

    if (!type || !totalAmount) {
        return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚ ÙˆØ§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ.");
    }
    
    let paidAmount = 0;
    if (type === 'Ø¯ÙŠÙ†') {
        paidAmount = parseAmount(document.getElementById('rPaidAmount').value);
        if (paidAmount > totalAmount) paidAmount = totalAmount; 
        
        if (paidAmount >= totalAmount * 0.99) {
            status = 'ÙƒØ§Ù…Ù„';
        } else if (paidAmount > 0) {
            status = 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹';
        } else {
            status = 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹';
        }
    }
    
    const newId = editMode ? editMode.data.id : Date.now();
    const isNew = !editMode;
    
    const newRight = {
        id: newId,
        Ø§Ù„ØªØ§Ø±ÙŠØ®: date,
        Ø§Ù„Ù†ÙˆØ¹: type,
        Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø³ØªØ­Ù‚_Ø§Ù„ÙƒÙ„ÙŠ: getFormattedAmount(totalAmount),
        Ø§Ù„ÙˆØµÙ: desc,
        Ø§Ù„Ø­Ø§Ù„Ø©: status,
        ØªØ§Ø±ÙŠØ®_Ù…ØªÙˆÙ‚Ø¹: expectedDate,
    };
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¶Ø§Ù Ù„Ù„Ø±ØµÙŠØ¯
    let currentBalanceAddition = 0;
    if (type === 'Ø¯ÙŠÙ†') {
        newRight.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¯ÙÙˆØ¹ = getFormattedAmount(paidAmount);
        newRight.Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ = getFormattedAmount(totalAmount - paidAmount);
        currentBalanceAddition = paidAmount;
    } else {
        if (status === 'ÙƒØ§Ù…Ù„') {
            currentBalanceAddition = totalAmount;
        }
    }
    newRight.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¶Ø§Ù_Ù„Ù„Ø±ØµÙŠØ¯ = getFormattedAmount(currentBalanceAddition);
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ ÙÙŠ Ø§Ù„Ø±ØµÙŠØ¯
    let oldBalanceAddition = 0;
    if (editMode) {
        oldBalanceAddition = parseAmount(editMode.data.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¶Ø§Ù_Ù„Ù„Ø±ØµÙŠØ¯ || 0);
        db.rig = db.rig.filter(i => i.id !== newId);
    }
    
    const balanceDifference = currentBalanceAddition - oldBalanceAddition; 
    
    db.rig.unshift(newRight);

    await updateBalance(balanceDifference, 'right', newId, desc);

    await saveData('rig', newRight);
    clearForm('r');
    updateStats();
    toastMsg(isNew ? "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ù‚ Ø¨Ù†Ø¬Ø§Ø­." : "ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ù‚ Ø¨Ù†Ø¬Ø§Ø­.");
}

async function addDebt() {
    const type = document.getElementById('dType').value;
    const desc = document.getElementById('dDesc').value;
    const date = document.getElementById('dDate').value || new Date().toISOString().slice(0, 16);
    let status = document.getElementById('dStatus').value;
    
    let amount = parseAmount(document.getElementById('dAmount').value);
    
    const newId = editMode ? editMode.data.id : Date.now();
    const isNew = !editMode;
    
    const newDebt = {
        id: newId,
        Ø§Ù„ØªØ§Ø±ÙŠØ®: date,
        Ø§Ù„Ù†ÙˆØ¹: type,
        Ø§Ù„ÙˆØµÙ: desc,
        Ø§Ù„Ø­Ø§Ù„Ø©: status,
        Ø§Ù„Ù…Ø¨Ù„Øº: getFormattedAmount(amount),
        // ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­Ø§Ù„Ø© 'Ù…Ø¯ÙÙˆØ¹'
        Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø®ØµÙˆÙ…_Ù„Ù„Ø±ØµÙŠØ¯: status === 'Ù…Ø¯ÙÙˆØ¹' ? getFormattedAmount(amount * -1) : getFormattedAmount(0)
    };
    
    if (type === 'Ù‚Ø±Ø¶' || type === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ') {
        const totalAmount = parseAmount(document.getElementById('dTotalAmount').value);
        const installments = type === 'Ù‚Ø±Ø¶' ? parseInt(document.getElementById('dInstallments').value) || 0 : 0;
        const paidInfo = type === 'Ù‚Ø±Ø¶' ? parseInt(document.getElementById('dPaidInstallments').value) || 0 : parseAmount(document.getElementById('dPaidAmount').value);
        
        let totalPaid;
        if (type === 'Ù‚Ø±Ø¶' && installments > 0) {
            const installmentValue = totalAmount / installments;
            totalPaid = paidInfo * installmentValue;
        } else {
            totalPaid = paidInfo;
        }
        
        const remaining = totalAmount - totalPaid;
        if (remaining <= 0.01) status = 'ÙƒØ§Ù…Ù„';
        
        newDebt.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù… = getFormattedAmount(totalAmount);
        newDebt.Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„Ù…Ø¯ÙÙˆØ¹ = getFormattedAmount(totalPaid);
        newDebt.Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù… = getFormattedAmount(remaining);
        newDebt.Ø§Ù„Ø­Ø§Ù„Ø© = status; 
        newDebt.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø®ØµÙˆÙ…_Ù„Ù„Ø±ØµÙŠØ¯ = getFormattedAmount(0); // Ø§Ù„Ø¯ÙØ¹ ÙŠØ¯ÙˆÙŠ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹
        
        if (type === 'Ù‚Ø±Ø¶') {
            newDebt.Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ù‚Ø³Ø§Ø· = installments;
            newDebt.Ø§Ù„Ø£Ù‚Ø³Ø§Ø·_Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© = paidInfo;
        }
    }
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ ÙÙŠ Ø§Ù„Ø®ØµÙ…
    let oldBalanceDeduction = 0;
    if (editMode) {
        oldBalanceDeduction = parseAmount(editMode.data.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø®ØµÙˆÙ…_Ù„Ù„Ø±ØµÙŠØ¯ || 0); // Ù‚ÙŠÙ…Ø© Ø³Ø§Ù„Ø¨Ø©
        db.deb = db.deb.filter(i => i.id !== newId);
    }
    
    const currentBalanceDeduction = parseAmount(newDebt.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø®ØµÙˆÙ…_Ù„Ù„Ø±ØµÙŠØ¯); // Ù‚ÙŠÙ…Ø© Ø³Ø§Ù„Ø¨Ø© Ø£Ùˆ ØµÙØ±
    
    // Ø§Ù„ÙØ±Ù‚: (Ø§Ù„Ø®ØµÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ - Ø§Ù„Ø®ØµÙ… Ø§Ù„Ù‚Ø¯ÙŠÙ…). Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®ØµÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø£ÙƒØ¨Ø± (Ø£ÙƒØ«Ø± Ø³Ø§Ù„Ø¨ÙŠØ©)ØŒ ÙŠÙƒÙˆÙ† Ø§Ù„ÙØ±Ù‚ Ø³Ø§Ù„Ø¨Ø§Ù‹.
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®ØµÙ… Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø³Ø§Ù„Ø¨ (-100) ÙˆØ§Ù„Ø¬Ø¯ÙŠØ¯ ØµÙØ± (0)ØŒ ÙØ§Ù„ÙØ±Ù‚ +100 (Ø£ÙŠ Ø²ÙŠØ§Ø¯Ø© ÙÙŠ Ø§Ù„Ø±ØµÙŠØ¯).
    const balanceDifference = currentBalanceDeduction - oldBalanceDeduction; 

    db.deb.unshift(newDebt);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯
    await updateBalance(balanceDifference, 'debt', newId, desc);

    await saveData('deb', newDebt);
    clearForm('d');
    updateStats();
    toastMsg(isNew ? "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­." : "ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­.");
}


// ----------------- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯ -----------------

function openBalanceActionModal(type) {
    balanceActionType = type;
    document.getElementById('actionModalTitle').textContent = type === 'deposit' ? 'Ø¥ÙŠØ¯Ø§Ø¹ Ø±ØµÙŠØ¯' : 'Ø³Ø­Ø¨ Ø±ØµÙŠØ¯';
    
    document.getElementById('bAmount').value = '';
    document.getElementById('bDesc').value = '';
    document.getElementById('bDate').value = new Date().toISOString().slice(0, 16);
    
    openLayer('balanceAction');
}

async function processBalanceAction() {
    const amount = parseAmount(document.getElementById('bAmount').value);
    const desc = document.getElementById('bDesc').value;
    const date = document.getElementById('bDate').value || new Date().toISOString().slice(0, 16);
    
    if (!amount) {
        return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº.");
    }
    
    let finalAmount = amount;
    if (balanceActionType === 'withdraw') {
        finalAmount = amount * -1;
    }
    
    await updateBalance(finalAmount, balanceActionType, null, desc, date);
    
    closeLayer('balanceAction');
    toastMsg(`ØªÙ… ØªÙ†ÙÙŠØ° Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù€ ${balanceActionType === 'deposit' ? 'Ø¥ÙŠØ¯Ø§Ø¹' : 'Ø§Ù„Ø³Ø­Ø¨'} Ø¨Ù†Ø¬Ø§Ø­.`);
}

async function updateBalance(change, type, relatedTxnId = null, description = '', date = new Date().toISOString().slice(0, 16)) {
    // 1. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯
    currentBalance += change; 

    // 2. ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
    db.bal.amount = currentBalance;
    
    if (change !== 0) {
        db.bal.changes.push({
            id: Date.now(),
            date: date,
            type: type, // deposit, withdraw, expense, right, debt
            amount: change, 
            description: description,
            relatedTxnId: relatedTxnId,
            relatedTxnType: relatedTxnId ? type.substring(0, 3) : null 
        });
        
        // Ø¥Ø¨Ù‚Ø§Ø¡ Ø¢Ø®Ø± 100 Ø­Ø±ÙƒØ© ÙÙ‚Ø·
        if (db.bal.changes.length > 100) {
            db.bal.changes.splice(0, db.bal.changes.length - 100);
        }
    }
    
    // 3. Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«
    await saveData('bal', db.bal);
    updateBalanceDisplay();
}


// ===================================================
// 6. Ø¯ÙˆØ§Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙˆØ§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„ÙÙ„ØªØ±Ø© (Ø¥ØµÙ„Ø§Ø­ ÙˆØªØ·ÙˆÙŠØ± Ø§Ù„ÙÙ„ØªØ±Ø©)
// ===================================================

function openLog(type) {
    currentLog = type;
    document.getElementById('search').value = ''; 
    document.getElementById('filterMinAmount').value = '';
    document.getElementById('filterMaxAmount').value = '';
    document.getElementById('filterStartDate').value = '';
    document.getElementById('filterEndDate').value = '';
    
    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„ÙÙ„ØªØ±Ø©
    populateFilterCategory(type);
    
    renderLog();
    openLayer('log');
}

function populateFilterCategory(type) {
    const select = document.getElementById('filterCategory');
    select.innerHTML = '<option value="">ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø© / Ø§Ù„Ù†ÙˆØ¹ / Ø§Ù„Ø­Ø§Ù„Ø©</option>';
    
    let options = new Set();
    
    if (type === 'exp') {
        db.exp.forEach(item => options.add(item.Ø§Ù„ÙØ¦Ø©));
    } else if (type === 'rig') {
        db.rig.forEach(item => { options.add(item.Ø§Ù„Ù†ÙˆØ¹); options.add(item.Ø§Ù„Ø­Ø§Ù„Ø©); });
    } else if (type === 'deb') {
        db.deb.forEach(item => { options.add(item.Ø§Ù„Ù†ÙˆØ¹); options.add(item.Ø§Ù„Ø­Ø§Ù„Ø©); });
    }
    
    Array.from(options).sort().forEach(option => {
        if (option) {
            select.innerHTML += `<option value="${option}">${option}</option>`;
        }
    });
    select.value = '';
}


function openBalanceLogModal() {
    document.getElementById('balanceSearch').value = '';
    renderBalanceLog();
    openLayer('balanceLog');
}

function renderBalanceLog() {
    const logContent = document.getElementById("balanceLogContent");
    const searchTerm = document.getElementById("balanceSearch").value.toLowerCase().trim();
    const data = db.bal.changes || []; 

    if (data.length === 0) {
        logContent.innerHTML = `<p style="text-align: center; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù„Ø±ØµÙŠØ¯.</p>`;
        return;
    }
    
    // ØªÙ†ÙÙŠØ° Ø§Ù„ÙÙ„ØªØ±Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙˆØµÙ ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©
    const filteredData = data.filter(item => {
        const desc = (item.description || '').toLowerCase();
        const type = (item.type || '').toLowerCase();
        
        return desc.includes(searchTerm) || 
               type.includes(searchTerm) ||
               (item.relatedTxnType || '').toLowerCase().includes(searchTerm);
    }).reverse(); 

    if (filteredData.length === 0) {
        logContent.innerHTML = `<p style="text-align: center; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø±ØµÙŠØ¯.</p>`;
        return;
    }

    logContent.innerHTML = filteredData.map(c => {
        const typeColor = c.amount > 0 ? 'var(--success)' : 'var(--danger)';
        const amountDisplay = formatCurrency(Math.abs(c.amount));
        const actionText = c.type === 'deposit' ? 'Ø¥ÙŠØ¯Ø§Ø¹' : c.type === 'withdraw' ? 'Ø³Ø­Ø¨' : c.type === 'expense' ? 'Ù…ØµØ±ÙˆÙ' : c.type === 'right' ? 'ØªØ­ØµÙŠÙ„ Ø­Ù‚' : 'Ø¯ÙØ¹ Ø§Ù„ØªØ²Ø§Ù…';
        const related = c.relatedTxnId ? ` | (Ø¹Ù…Ù„ÙŠØ©: ${actionText})` : '';

        return `
            <div class="list-item" style="border-right-color: ${typeColor};">
                <div style="font-weight: bold; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;">
                    <span>${c.description || actionText} ${related}</span> 
                    <span style="color: ${typeColor};">${c.amount > 0 ? '+' : ''}${amountDisplay}</span>
                </div>
                <div class="details">
                    <span>${actionText}</span>
                    <span><i class="far fa-clock" style="margin-left: 4px;"></i> ${formatDateTime(c.date)}</span>
                </div>
            </div>
        `;
    }).join('');
}

function renderLog() {
    const logContent = document.getElementById("logContent");
    const searchTerm = document.getElementById("search").value.toLowerCase().trim();
    
    // ÙÙ„Ø§ØªØ± Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„ØªÙˆØ§Ø±ÙŠØ®
    const minAmount = parseAmount(document.getElementById('filterMinAmount').value);
    const maxAmount = parseAmount(document.getElementById('filterMaxAmount').value);
    const startDate = document.getElementById('filterStartDate').value;
    const endDate = document.getElementById('filterEndDate').value;
    const filterCategory = document.getElementById('filterCategory').value;
    
    const data = db[currentLog] || [];
    
    if (data.length === 0) {
        logContent.innerHTML = `<p style="text-align: center; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø³Ø¬Ù„Ø©.</p>`;
        return;
    }
    
    // ØªÙ†ÙÙŠØ° Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©
    const filteredData = data.filter(item => {
        const desc = (item.Ø§Ù„ÙˆØµÙ || '').toLowerCase();
        const type = (item.Ø§Ù„ÙØ¦Ø© || item.Ø§Ù„Ù†ÙˆØ¹ || '').toLowerCase();
        const status = (item.Ø§Ù„Ø­Ø§Ù„Ø© || '').toLowerCase();
        
        // 1. ÙÙ„ØªØ±Ø© Ø§Ù„Ù†Øµ
        const textMatch = desc.includes(searchTerm) || 
                          type.includes(searchTerm) ||
                          status.includes(searchTerm);
                          
        // 2. ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø¨Ù„Øº (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ø£Ùˆ Ø§Ù„Ù…Ø¨Ù„Øº)
        let amount = 0;
        if (currentLog === 'exp') {
            amount = parseAmount(item.Ø§Ù„Ù…Ø¨Ù„Øº || 0);
        } else if (currentLog === 'rig') {
            amount = parseAmount(item.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø³ØªØ­Ù‚_Ø§Ù„ÙƒÙ„ÙŠ || item.Ø§Ù„Ù…Ø¨Ù„Øº || 0);
        } else if (currentLog === 'deb') {
            amount = parseAmount(item.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù… || item.Ø§Ù„Ù…Ø¨Ù„Øº || 0);
        }
        
        const amountMatch = (!minAmount || amount >= minAmount) && 
                            (!maxAmount || amount <= maxAmount);
                            
        // 3. ÙÙ„ØªØ±Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
        const itemDate = new Date(item.Ø§Ù„ØªØ§Ø±ÙŠØ®).getTime();
        const start = startDate ? new Date(startDate).getTime() : 0;
        const end = endDate ? new Date(endDate + 'T23:59:59').getTime() : Infinity; // Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙŠÙˆÙ…
        
        const dateMatch = itemDate >= start && itemDate <= end;
        
        // 4. ÙÙ„ØªØ±Ø© Ø§Ù„ÙØ¦Ø©/Ø§Ù„Ù†ÙˆØ¹/Ø§Ù„Ø­Ø§Ù„Ø©
        const categoryMatch = !filterCategory || 
                              item.Ø§Ù„ÙØ¦Ø© === filterCategory || 
                              item.Ø§Ù„Ù†ÙˆØ¹ === filterCategory ||
                              item.Ø§Ù„Ø­Ø§Ù„Ø© === filterCategory;

        return textMatch && amountMatch && dateMatch && categoryMatch;
    });

    if (filteredData.length === 0) {
        logContent.innerHTML = `<p style="text-align: center; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«.</p>`;
        return;
    }

    logContent.innerHTML = filteredData
        .map(i => {
            let title = i.Ø§Ù„ÙˆØµÙ || i.Ø§Ù„ÙØ¦Ø© || i.Ø§Ù„Ù†ÙˆØ¹ || 'Ø¨Ø¯ÙˆÙ† ÙˆØµÙ';
            let amount = 0;
            let subDetails = i.Ø§Ù„Ø­Ø§Ù„Ø© || i.Ø§Ù„ÙØ¦Ø© || 'â€”';
            let color = 'var(--s)';
            
            if (currentLog === 'exp') {
                 color = 'var(--danger)';
                 amount = parseAmount(i.Ø§Ù„Ù…Ø¨Ù„Øº); 
                 subDetails = i.Ø§Ù„ÙØ¦Ø©;
            } else if (currentLog === 'rig') {
                 color = 'var(--success)';
                 amount = parseAmount(i.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø³ØªØ­Ù‚_Ø§Ù„ÙƒÙ„ÙŠ || i.Ø§Ù„Ù…Ø¨Ù„Øº || 0); 
                 subDetails = i.Ø§Ù„Ø­Ø§Ù„Ø©;
            } else if (currentLog === 'deb') {
                 color = 'var(--p)';
                 amount = parseAmount(i.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù… || i.Ø§Ù„Ù…Ø¨Ù„Øº || 0); 
                 subDetails = i.Ø§Ù„Ø­Ø§Ù„Ø© || `Ù…ØªØ¨Ù‚ÙŠ: ${formatCurrency(parseAmount(i.Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù… || 0))}`;
            }

            return `
                <div class="list-item" style="border-right-color: ${color};" onclick="showDetailById(${i.id}, '${currentLog}')">
                    <div style="font-weight: bold; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;">
                        <span>${title}</span> 
                        <span style="color: ${color};">${formatCurrency(amount)}</span>
                    </div>
                    <div class="details">
                        <span>${subDetails}</span>
                        <span><i class="far fa-clock" style="margin-left: 4px;"></i> ${formatDateTime(i.Ø§Ù„ØªØ§Ø±ÙŠØ®)}</span>
                    </div>
                </div>
            `;
        })
        .join("");
}

function showDetailById(id, type) {
    const data = db[type];
    const item = data.find(i => i.id === id);
    if (item) {
        editMode = { data: item, type: type };
        document.getElementById('detailContent').dataset.id = id;
        document.getElementById('detailContent').dataset.type = type;
        
        _renderDetailContent(item, type);
        openLayer('detail');
    }
}

function _renderDetailContent(o, type) {
    const detailContent = document.getElementById('detailContent');
    let html = ``;
    
    html += `
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button class="action" onclick="editTransaction()" style="flex: 1; background: var(--s);"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="action" onclick="deleteTransaction()" style="flex: 1; background: var(--danger);"><i class="fas fa-trash"></i> Ø­Ø°Ù</button>
        </div>
        <div class="card" style="border-top: 5px solid var(--p);">
    `;

    for (const key in o) {
        if (key === 'id' || key === 'clientId' || key === 'ØµÙˆØ±Ø©' || key.includes('Ø§Ù„Ù…Ø®ØµÙˆÙ…_Ù„Ù„Ø±ØµÙŠØ¯') || key.includes('Ø§Ù„Ù…Ø¶Ø§Ù_Ù„Ù„Ø±ØµÙŠØ¯')) continue;
        
        let value = o[key];
        
        if (key.includes('Ø§Ù„Ù…Ø¨Ù„Øº') || key.includes('Ø§Ù„Ù‚ÙŠÙ…Ø©') || key.includes('Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ') || key.includes('Ø¥Ø¬Ù…Ø§Ù„ÙŠ')) {
             if (value !== 'â€”') value = formatCurrency(parseAmount(value));
        } else if (key === 'Ø§Ù„ØªØ§Ø±ÙŠØ®' || key.includes('ØªØ§Ø±ÙŠØ®')) {
             value = formatDateTime(value);
        }
        
        html += `<p><strong>${key.replace(/_/g, ' ')}:</strong> <span>${value || 'â€”'}</span></p>`;
    }
    
    html += `</div>`; 

    if (o.ØµÙˆØ±Ø©) {
         html += `
             <h4 style="margin-top: 20px; color: var(--p);">ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©/Ø§Ù„Ù…Ø³ØªÙ†Ø¯</h4>
             <img src="${o.ØµÙˆØ±Ø©}" alt="Ù…Ø±ÙÙ‚ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©" style="width: 100%; max-height: 400px; object-fit: contain; border-radius: 10px; border: 1px solid var(--border-color); cursor: zoom-in;" onclick="window.open(this.src)">
         `;
    }
    
    detailContent.innerHTML = html;
}

// ----------------- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù (Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙØ±ÙŠØº ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙˆØ±ÙŠ) -----------------

function editTransaction() {
    if (!editMode) return;
    
    const { data, type } = editMode;
    
    // 1. ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ (Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨)
    clearForm(type.charAt(0)); 
    
    // 2. Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø¬Ù„
    if (type === 'exp') {
        document.getElementById('eAmount').value = data.Ø§Ù„Ù…Ø¨Ù„Øº;
        document.getElementById('eType').value = data.Ø§Ù„ÙØ¦Ø© || '';
        document.getElementById('eDesc').value = data.Ø§Ù„ÙˆØµÙ || '';
        document.getElementById('eDate').value = data.Ø§Ù„ØªØ§Ø±ÙŠØ® ? data.Ø§Ù„ØªØ§Ø±ÙŠØ®.slice(0, 16) : '';
        const imgDisplay = document.getElementById('eImgName');
        if (data.ØµÙˆØ±Ø©) {
             imgDisplay.dataset.base64 = data.ØµÙˆØ±Ø©;
             imgDisplay.textContent = 'ØªÙ… Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© (Ù…Ø¹Ø¯Ù„Ø©)';
        }
        openTab('expenses');
    } else if (type === 'rig') {
        document.getElementById('rType').value = data.Ø§Ù„Ù†ÙˆØ¹ || '';
        document.getElementById('rAmount').value = data.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø³ØªØ­Ù‚_Ø§Ù„ÙƒÙ„ÙŠ || data.Ø§Ù„Ù…Ø¨Ù„Øº || '';
        document.getElementById('rDesc').value = data.Ø§Ù„ÙˆØµÙ || '';
        document.getElementById('rDate').value = data.Ø§Ù„ØªØ§Ø±ÙŠØ® ? data.Ø§Ù„ØªØ§Ø±ÙŠØ®.slice(0, 16) : '';
        document.getElementById('rStatus').value = data.Ø§Ù„Ø­Ø§Ù„Ø© || '';
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© (ÙˆÙ‡Ù†Ø§ ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ† Ø£ÙŠØ¶Ø§Ù‹)
        updateRightFields(data.Ø§Ù„Ù†ÙˆØ¹, data);
        if (data.Ø§Ù„Ù†ÙˆØ¹ === 'Ø¯ÙŠÙ†') {
            const rPaidAmountInput = document.getElementById('rPaidAmount');
            if (rPaidAmountInput) rPaidAmountInput.value = data.Ø§Ù„Ù…Ø¨Ù„Øº_Ù…Ø¯ÙÙˆØ¹ || '';
            calculateRightRemaining();
        }
        
        openTab('rights');
    } else if (type === 'deb') {
        document.getElementById('dType').value = data.Ø§Ù„Ù†ÙˆØ¹ || '';
        document.getElementById('dAmount').value = data.Ø§Ù„Ù…Ø¨Ù„Øº || '';
        document.getElementById('dDesc').value = data.Ø§Ù„ÙˆØµÙ || '';
        document.getElementById('dDate').value = data.Ø§Ù„ØªØ§Ø±ÙŠØ® ? data.Ø§Ù„ØªØ§Ø±ÙŠØ®.slice(0, 16) : '';
        document.getElementById('dStatus').value = data.Ø§Ù„Ø­Ø§Ù„Ø© || '';
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
        updateDebtFields(data.Ø§Ù„Ù†ÙˆØ¹, data);
        if (data.Ø§Ù„Ù†ÙˆØ¹ === 'Ù‚Ø±Ø¶') {
            document.getElementById('dTotalAmount').value = data.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù… || '';
            document.getElementById('dInstallments').value = data.Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ù‚Ø³Ø§Ø· || '';
            document.getElementById('dPaidInstallments').value = data.Ø§Ù„Ø£Ù‚Ø³Ø§Ø·_Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© || '';
            calculateInstallmentValue();
        } else if (data.Ø§Ù„Ù†ÙˆØ¹ === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ') {
            document.getElementById('dTotalAmount').value = data.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù… || '';
            document.getElementById('dPaidAmount').value = data.Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„Ù…Ø¯ÙÙˆØ¹ || '';
        }
        
        openTab('deb');
    }
    
    closeLayer('detail');
    closeLayer('log');
    toastMsg(`ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…ÙÙØ¹Ù‘ÙÙ„ Ù„Ù€ (ID: ${data.id})`);
}

async function deleteTransaction() {
    if (!editMode || !confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) return;
    
    const { data, type } = editMode;
    
    // 1. Ø¹ÙƒØ³ ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯
    let balanceChange = 0;
    if (type === 'exp') {
        balanceChange = parseAmount(data.Ø§Ù„Ù…Ø¨Ù„Øº); 
    } else if (type === 'rig') {
        balanceChange = parseAmount(data.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¶Ø§Ù_Ù„Ù„Ø±ØµÙŠØ¯ || 0) * -1; 
    } else if (type === 'deb') {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø®ØµÙˆÙ… Ø³Ø§Ù„Ø¨ØŒ Ø¹ÙƒØ³Ù‡ Ù…ÙˆØ¬Ø¨
        balanceChange = parseAmount(data.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø®ØµÙˆÙ…_Ù„Ù„Ø±ØµÙŠØ¯ || 0) * -1; 
    }

    if (balanceChange !== 0) {
        await updateBalance(balanceChange, 'delete', data.id, `Ø­Ø°Ù Ù…Ø¹Ø§Ù…Ù„Ø© Ø³Ø§Ø¨Ù‚Ø© (${data.Ø§Ù„ÙˆØµÙ || data.Ø§Ù„Ù†ÙˆØ¹})`);
    }
    
    // 2. Ø§Ù„Ø­Ø°Ù Ù…Ù† IndexedDB ÙˆÙ…Ù† Ø§Ù„Ù€ db object
    await deleteFromDB(type, data.id);
    db[type] = db[type].filter(i => i.id !== data.id);
    
    // 3. Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ§Ù„Ø¥ØºÙ„Ø§Ù‚
    editMode = null;
    closeLayer('detail');
    updateStats();
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø´Ø§Øª ÙÙˆØ±Ø§Ù‹ (Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨)
    renderLog(); 
    renderBalanceLog(); 
    
    toastMsg("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­.");
}

// ----------------- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…Ù„Ø© -----------------

function renderCurrencyList() {
    const listContainer = document.getElementById('currencyList');
    const searchInput = document.getElementById('currencySearch').value.toLowerCase();
    
    const filteredCurrencies = ARABIC_CURRENCIES.filter(c => 
        c.name.toLowerCase().includes(searchInput) || 
        c.symbol.toLowerCase().includes(searchInput) ||
        c.code.toLowerCase().includes(searchInput)
    );

    listContainer.innerHTML = filteredCurrencies.map(c => `
        <button class="list-item" onclick="setCurrency('${c.code}')" style="display: flex; justify-content: space-between; align-items: center; border-right-color: var(--p);">
            <span><span class="currency-symbol">${c.symbol}</span> ${c.name} (${c.code})</span>
            ${c.code === currentCurrency.code ? '<i class="fas fa-check" style="color: var(--success);"></i>' : ''}
        </button>
    `).join('');
}

function setCurrency(code) {
    const newCurrency = ARABIC_CURRENCIES.find(c => c.code === code);
    if (newCurrency) {
        currentCurrency = newCurrency;
        localStorage.setItem('currencyCode', code);
        document.getElementById('currentCurrencyDisplay').textContent = `Ø§Ù„Ø¹Ù…Ù„Ø©: ${newCurrency.name} (${newCurrency.symbol})`;
        updateBalanceDisplay();
        updateStats();
        toastMsg(`ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø© Ø¥Ù„Ù‰ ${newCurrency.name}`);
        closeLayer('currency');
    }
}
document.addEventListener('DOMContentLoaded', () => {
    const display = document.getElementById('currentCurrencyDisplay');
    if (display) {
        display.textContent = `Ø§Ù„Ø¹Ù…Ù„Ø©: ${currentCurrency.name} (${currentCurrency.symbol})`;
    }
});


// ----------------- Ø¯ÙˆØ§Ù„ Ø¥Ø±ÙØ§Ù‚ Ø§Ù„ØµÙˆØ±Ø© -----------------

function openCameraInput() {
    document.getElementById('eImgCamera').click();
    closeLayer('imageSource');
}

function openGalleryInput() {
    document.getElementById('eImgGallery').click();
    closeLayer('imageSource');
}

function showImageSourceModal() { 
    openLayer('imageSource'); 
    const overlay = document.getElementById('imageSourceOverlay');
    if (overlay) overlay.classList.add('open');
}

// ----------------- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ§Ù„ØªØµØ¯ÙŠØ± -----------------

function exportData() {
    const dataToExport = {
        db: db,
        meta: {
            currentBalance: currentBalance,
            currencyCode: currentCurrency.code,
            darkMode: localStorage.getItem('darkMode')
        }
    };
    const dataStr = JSON.stringify(dataToExport, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `smart_budget_backup_${new Date().toISOString().slice(0, 10)}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    toastMsg("ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
}

function importData(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const importedData = JSON.parse(e.target.result);
            if (!importedData.db) throw new Error("Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ù…ÙÙ‚ÙˆØ¯Ø©.");

            // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            await clearAllStores();
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            db = importedData.db;
            currentBalance = db.bal.amount || 0;
            
            // Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù€ IndexedDB
            await Promise.all(STORE_NAMES.map(store => {
                if (store === 'bal') {
                    return saveData('bal', db.bal);
                } else {
                    // Ù†Ø³ØªØ®Ø¯Ù… put Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† add Ù„Ø¶Ù…Ø§Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¥Ø¶Ø§ÙØªÙ‡Ø§ ÙÙ‚Ø·
                    return Promise.all(db[store].map(item => saveData(store, item))); 
                }
            }));
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            if (importedData.meta) {
                 localStorage.setItem('currencyCode', importedData.meta.currencyCode || 'SAR');
                 localStorage.setItem('darkMode', importedData.meta.darkMode || 'false');
                 currentCurrency = ARABIC_CURRENCIES.find(c => c.code === importedData.meta.currencyCode) || ARABIC_CURRENCIES[0];
                 loadDarkModePreference();
            }
            
            updateStats();
            updateBalanceDisplay();
            document.getElementById('importFile').value = ''; 
            toastMsg("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.");
            
        } catch (error) {
            console.error("Import error:", error);
            toastMsg(`ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: ${error.message}`);
        }
    };
    reader.readAsText(file);
}

function confirmResetData() {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ø³ÙŠØªÙ… ÙÙ‚Ø¯Ø§Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª.')) {
        clearAllStores();
    }
}

function clearAllStores() {
    return new Promise((resolve, reject) => {
        if (!IDB_connection) { reject(new Error("DB not connected")); return; }
        
        let storesCleared = 0;
        STORE_NAMES.forEach(storeName => {
            const transaction = IDB_connection.transaction([storeName], "readwrite");
            const store = transaction.objectStore(storeName);
            const request = store.clear();

            request.onsuccess = () => {
                storesCleared++;
                if (storesCleared === STORE_NAMES.length) {
                    db.exp = []; db.rig = []; db.deb = []; 
                    db.bal = { clientId: 1, amount: 0, changes: [] };
                    saveData('bal', db.bal).then(() => {
                        loadAllData().then(() => {
                            updateStats(); 
                            updateBalanceDisplay();
                            toastMsg("ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
                            resolve();
                        });
                    });
                }
            };

            request.onerror = () => {
                toastMsg("ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
                reject(new Error("Clear failed."));
            };
        });
    });
}
</script>
</body>
</html>
