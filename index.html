<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ© | Smart Budget</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">

<style>
/* ---------------------------------------------------- */
/* Variables and Base Styling - LIGHT MODE (Default) */
/* ---------------------------------------------------- */
:root{
    --p: #0077b6; /* Primary Blue (Vibrant) */
    --s: #48cae4; /* Secondary Light Blue */
    --bg: #f7f9fc; /* Light Background */
    --danger: #ef476f; 
    --success: #2a9d8f;
    --warning: #fbc02d;
    --text-dark: #333;
    --text-light: #f7f9fc;
    --shadow-light: 0 4px 8px rgba(0, 0, 0, 0.08);
    --shadow-hover: 0 6px 15px rgba(0, 0, 0, 0.15);
    --card-bg: #fff;
    --input-bg: #fff;
    --border-color: #ddd;
    --tab-active-bg: #fff;
}

/* ---------------------------------------------------- */
/* Dark Mode Variables */
/* ---------------------------------------------------- */
body.dark-mode {
    --p: #90e0ef; /* Lighter Primary Blue for contrast */
    --s: #48cae4; 
    --bg: #1f1f1f; /* Dark Background */
    --danger: #ff8a80;
    --success: #66bb6a;
    --warning: #fbc02d;
    --text-dark: #e0e0e0; /* Light Text */
    --text-light: #1f1f1f;
    --shadow-light: 0 4px 10px rgba(0, 0, 0, 0.5);
    --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.8);
    --card-bg: #2d2d2d;
    --input-bg: #3c3c3c;
    --border-color: #555;
    --tab-active-bg: #2d2d2d;
}

/* ---------------------------------------------------- */
/* Global Reset and Base Styling */
/* ---------------------------------------------------- */
* {
    box-sizing: border-box;
}
body{
    margin:0;
    font-family: 'Tajawal', 'Arial', sans-serif;
    background: var(--bg);
    color: var(--text-dark);
    overflow-x: hidden;
    line-height: 1.6;
    transition: background 0.3s, color 0.3s;
}

/* Global Dark Mode Overrides for Specific Elements */
.card, .sidebar, .modal { background: var(--card-bg); }
.modal header { background: var(--card-bg); border-bottom: 1px solid var(--border-color); }

/* ---------------------------------------------------- */
/* Header & Navigation */
/* ---------------------------------------------------- */
header{
    background: var(--p);
    color: var(--text-light);
    padding: 15px;
    font-size: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-hover);
    position: sticky;
    top: 0;
    z-index: 10;
}
header .title { flex-grow: 1; text-align: center; font-weight: 800; }
header button {
    background: none; 
    border: none; 
    color: var(--text-light); 
    font-size: 20px; 
    cursor: pointer; 
    padding: 0 10px;
    transition: transform 0.2s;
}
header button:hover { transform: scale(1.1); }

.tabs{
    display:flex;
    background: var(--card-bg);
    border-bottom: 2px solid var(--border-color);
    box-shadow: var(--shadow-light);
    overflow-x: auto; 
    white-space: nowrap;
}
.tabs button{
    flex: 1 1 auto; 
    min-width: 0; 
    padding: 15px 10px;
    border:none;
    background: var(--card-bg);
    color: var(--text-dark);
    font-weight: 700;
    font-size: 14px;
    transition: all 0.3s;
    border-bottom: 3px solid transparent;
}
.tabs button.active{
    color: var(--p);
    border-bottom: 3px solid var(--p);
    background: color-mix(in srgb, var(--bg) 90%, var(--p)); 
}
body.dark-mode .tabs button.active {
    background: color-mix(in srgb, var(--bg) 85%, var(--p)); 
}

/* ---------------------------------------------------- */
/* General Layout & Cards */
/* ---------------------------------------------------- */
.section{ display:none; padding: 15px; }
.section.active{ display:block; }
.card{
    background:var(--card-bg);
    padding: 20px;
    border-radius: 15px;
    box-shadow: var(--shadow-light);
    margin-bottom: 15px;
    border-top: 5px solid var(--s); 
    transition: background 0.3s, border-color 0.3s;
}

/* ---------------------------------------------------- */
/* Overview Section Styling (New Dashboard) */
/* ---------------------------------------------------- */
#overview .balance-display {
    text-align: center;
    padding: 30px 20px;
    margin-bottom: 20px;
    border-radius: 15px;
    background: var(--card-bg);
    box-shadow: var(--shadow-hover);
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    align-items: center;
}
#overview .balance-display h2 {
    margin: 0 0 5px 0;
    font-size: 18px;
    color: #999;
}
#overview .balance-display p {
    font-size: 38px;
    font-weight: 800;
    margin: 5px 0 0 0;
    color: var(--p);
    display: flex;
    align-items: center;
}
#overview .balance-display button {
    background: none;
    border: none;
    color: var(--p);
    font-size: 24px;
    cursor: pointer;
    margin-right: 10px;
    transition: color 0.2s;
}
#overview .balance-display button:hover {
    color: var(--s);
}
#overview .balance-actions {
    display: flex;
    gap: 15px;
    margin-top: 10px;
}
#overview .balance-actions .action {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    color: var(--text-dark);
    border-radius: 10px;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-light);
    transition: all 0.2s;
    background: var(--input-bg);
}
#overview .balance-actions .action:hover {
    box-shadow: var(--shadow-hover);
    transform: translateY(-2px);
    border-color: var(--p);
}
#overview .balance-actions .action i {
    font-size: 24px;
    margin-bottom: 5px;
}
#overview .balance-actions .deposit i { color: var(--success); }
#overview .balance-actions .withdraw i { color: var(--danger); }

/* ---------------------------------------------------- */
/* Form Elements & Inputs */
/* ---------------------------------------------------- */
input, select, .datetime-container input[type="datetime-local"] {
    width: 100%;
    padding: 14px;
    margin: 8px 0;
    font-size: 16px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    box-sizing: border-box;
    background: var(--input-bg);
    color: var(--text-dark);
    transition: all 0.3s;
}
input:focus, select:focus, .datetime-container input[type="datetime-local"]:focus {
    border-color: var(--s);
    box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.2);
    outline: none;
}
body.dark-mode input:focus, body.dark-mode select:focus, body.dark-mode .datetime-container input[type="datetime-local"]:focus {
    box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.3);
}

.datetime-container { position: relative; width: 100%; margin: 8px 0; }
.datetime-container input[type="datetime-local"] { margin: 0; padding-left: 40px; }

.calendar-icon {
    position: absolute;
    top: 50%;
    left: 15px; 
    transform: translateY(-50%);
    font-size: 1.4em;
    z-index: 2;
    pointer-events: none; 
    color: var(--p); 
}

/* ---------------------------------------------------- */
/* Buttons & Actions */
/* ---------------------------------------------------- */
button.action{
    background: var(--p);
    color: var(--text-light);
    border: none;
    padding: 16px;
    width: 100%;
    border-radius: 10px;
    font-size: 18px;
    font-weight: bold;
    margin-top: 10px;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
    box-shadow: var(--shadow-light);
}
button.action:hover{
    background: color-mix(in srgb, var(--p) 85%, black); 
    transform: translateY(-2px);
}

button.secondary{
    background: var(--input-bg);
    color: var(--text-dark);
    padding: 12px;
    width: 100%;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    margin-top: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s;
}
button.secondary:hover {
    background: color-mix(in srgb, var(--input-bg) 80%, #999); 
}

/* ---------------------------------------------------- */
/* Utility & Custom Elements */
/* ---------------------------------------------------- */
.toast{
    position:fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: var(--text-light);
    padding: 12px 25px;
    border-radius: 30px;
    display:none;
    z-index: 100;
    font-size: 15px;
    box-shadow: var(--shadow-hover);
    white-space: nowrap;
}

.currency-symbol { color: var(--p); font-weight: bold; font-size: 1.1em; margin-right: 5px; }
.hidden-balance { font-size: 38px; font-weight: 800; letter-spacing: 5px; color: var(--p); }

/* ---------------------------------------------------- */
/* Modals and Sidebar Refinements */
/* ---------------------------------------------------- */
.modal{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background: var(--bg);
    display:none;
    flex-direction:column;
    z-index: 30;
    overflow-y: auto;
}
.modal header{
    display:flex;
    gap: 10px;
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    background: var(--card-bg);
    align-items: center;
    box-shadow: var(--shadow-light);
    position: sticky;
    top: 0;
    z-index: 35;
}
.modal header .title { flex-grow: 1; text-align: center; font-weight: 700; }
.modal header button {
    background: none; 
    border: none; 
    color: var(--text-dark); 
    font-size: 20px; 
    cursor: pointer; 
    padding: 0 10px;
}
.modal-content {
    flex-grow: 1;
    padding: 15px;
}

.sidebar {
    position: fixed;
    top: 0;
    right: 0; 
    width: 300px; 
    max-width: 85%;
    height: 100%;
    background: var(--card-bg);
    box-shadow: -4px 0 12px rgba(0, 0, 0, 0.2);
    transform: translateX(100%); 
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
    z-index: 25; 
    display: flex;
    flex-direction: column;
}
.sidebar.open { transform: translateX(0); }

/* Switch Style (Dark Mode) */
.switch-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    font-size: 17px;
    color: var(--text-dark);
}
/* ... (ÙƒÙˆØ¯ Ø§Ù„Ù€ switch Ù„Ù… ÙŠØªØºÙŠØ±) ... */
.switch { position: relative; display: inline-block; width: 45px; height: 25px; }
.switch input {opacity: 0; width: 0; height: 0;}
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: var(--border-color); transition: .4s; border-radius: 25px;
}
.slider:before {
    position: absolute; content: ""; height: 19px; width: 19px; left: 3px; bottom: 3px;
    background-color: white; transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: var(--p); }
input:checked + .slider:before { transform: translateX(20px); }


/* Sidebar */
.sidebar-header {
    padding: 15px;
    background: var(--p);
    color: var(--text-light);
    font-size: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
}
.sidebar-content {
    flex-grow: 1;
    padding: 15px 0;
    overflow-y: auto;
}

.sidebar-menu-item {
    padding: 15px 20px;
    margin: 5px 0;
    display: flex;
    align-items: center;
    justify-content: space-between; 
    gap: 15px;
    font-size: 17px;
    color: var(--text-dark);
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
}

.sidebar-menu-item:hover {
    background: var(--s);
    color: var(--text-dark); 
}
.sidebar-menu-item i { font-size: 1.2em; }

.sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    z-index: 24;
}
.sidebar-overlay.open { display: block; }

/* Small Image Source Modal */
#imageSourceModal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80%;
    max-width: 350px;
    height: auto;
    background: var(--card-bg);
    border-radius: 15px;
    box-shadow: var(--shadow-hover);
    padding: 20px;
    z-index: 150;
    display: none; 
    flex-direction: column;
    align-items: center;
}
/* **Ø§Ù„Ø¥ØµÙ„Ø§Ø­:** Ø¬Ø¹Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…Ø±Ø¦ÙŠØ© Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ open */
#imageSourceModal.open {
    display: flex;
}

#imageSourceModal h3 {
    margin-top: 0;
    color: var(--p);
    text-align: center;
}
#imageSourceModal button {
    margin: 10px 0;
    padding: 15px;
    font-size: 16px;
    border-radius: 10px;
    width: 100%;
}

/* Toast Animation */
.toast.show{
    display:block;
    animation: fadeInOut 2.5s ease-in-out forwards;
}

@keyframes fadeInOut {
    0% { opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { opacity: 0; }
}

/* List Item */
.list-item{
    background: var(--card-bg);
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    border-right: 5px solid var(--s); 
    color: var(--text-dark);
}
.list-item:hover {
    background: color-mix(in srgb, var(--card-bg) 95%, #999);
    box-shadow: var(--shadow-light);
}
.list-item .details {
    font-size: 0.9em; 
    color: #666; 
    text-align: right;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 5px;
}

/* ---------------------------------------------------- */
/* Responsive Fix for Tabs (Small Screens) */
/* ---------------------------------------------------- */
@media (max-width: 450px) {
    .tabs button {
        padding: 15px 5px; 
        font-size: 13px; 
    }
}
</style>
</head>

<body>

<header>
    <button onclick="openSidebar()"><i class="fas fa-bars"></i></button> 
    <span class="title">Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</span>
    <button style="visibility: hidden;"><i class="fas fa-search"></i></button> 
</header>

<div class="tabs">
    <button class="active" onclick="openTab('overview')">
        <i class="fas fa-tachometer-alt" style="margin-left: 5px;"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©
    </button>
    <button onclick="openTab('expenses')">
        <i class="fas fa-money-bill-wave" style="margin-left: 5px;"></i> Ù…ØµØ±ÙˆÙØ§Øª
    </button>
    <button onclick="openTab('rights')">
        <i class="fas fa-handshake" style="margin-left: 5px;"></i> Ø­Ù‚ÙˆÙ‚
    </button>
    <button onclick="openTab('debts')">
        <i class="fas fa-file-invoice" style="margin-left: 5px;"></i> Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    </button>
</div>

<div id="overview" class="section active">
    <div class="balance-display">
        <h2>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
        <p id="currentBalanceDisplay">
            <i class="fas fa-spinner fa-spin"></i>
        </p>
        <button onclick="toggleBalanceVisibility()" id="balanceVisibilityToggle" title="Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±ØµÙŠØ¯">
             <i class="fas fa-eye"></i>
        </button>
    </div>

    <div class="balance-actions">
        <button class="action deposit" onclick="openBalanceActionModal('deposit')">
            <i class="fas fa-plus-circle"></i> Ø¥ÙŠØ¯Ø§Ø¹
        </button>
        <button class="action withdraw" onclick="openBalanceActionModal('withdraw')">
            <i class="fas fa-minus-circle"></i> Ø³Ø­Ø¨
        </button>
    </div>
    
    <button class="secondary" onclick="openBalanceLogModal()" style="margin-top: 15px;">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯
    </button>
    <div class="card" style="margin-top: 20px; border-top: 5px solid var(--p);">
        <h3 style="color: var(--p); margin-top: 0;"><i class="fas fa-calculator" style="margin-left: 5px;"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
        <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (ØªØ´Ù…Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª):</span> <b id="sExpTotal">0</b></p>
        <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©:</span> <b id="sRigTotal">0</b></p>
        <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©:</span> <b id="sDebTotal">0</b></p>
        <p><span>Ø§Ù„Ù…Ø­ØµÙ„ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ‚:</span> <b id="sRigPaid">0</b></p>
        <p><span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª:</span> <b id="sDebPaid">0</b></p>
        </div>
</div>

<div id="expenses" class="section">
    <div class="card">
    <p style="color: var(--danger); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡Ø§ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙˆØ±Ø§Ù‹</p>
    <input id="eAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
    <select id="eType">
    <option value="">ğŸ›’ Ø§Ù„ÙØ¦Ø© (Ù†ÙÙ‚Ø§Øª Ù…ØªØºÙŠØ±Ø©)</option>
    <option>Ø·Ø¹Ø§Ù…</option><option>Ù…ÙˆØ§ØµÙ„Ø§Øª</option>
    <option>Ø±Ø¹Ø§ÙŠØ© Ø´Ø®ØµÙŠØ©</option><option>Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
    <option>ØµØ­Ø©</option><option>ØªØ±ÙÙŠÙ‡</option><option>ØªØ³ÙˆÙ‚</option>
    <option>ØªØ¹Ù„ÙŠÙ…</option><option>ØµÙŠØ§Ù†Ø© ÙˆØ¥ØµÙ„Ø§Ø­</option><option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="eDesc" placeholder="ğŸ“ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
    <div class="datetime-container">
        <input id="eDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    
    <button class="secondary" onclick="showImageSourceModal()">
        <i class="fas fa-camera" style="margin-left: 5px;"></i> Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    </button>
    <span id="eImgName" style="display: block; font-size: 0.8em; color: var(--success); text-align: right; margin-top: 5px;"></span>
    <input type="file" id="eImgCamera" accept="image/*" capture="camera" style="display: none;" onchange="updateFileName(this, 'eImgName')">
    <input type="file" id="eImgGallery" accept="image/*" style="display: none;" onchange="updateFileName(this, 'eImgName')">
    <button class="action" onclick="addExpense()">
        <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ
    </button>
    <button class="secondary" onclick="openLog('exp')">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
    </button>
    </div>
</div>

<div id="rights" class="section">
    <div class="card">
    <p style="color: var(--success); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„Ø© (Ø¯ÙØ¹ Ø§Ù„Ø¯ÙŠÙ†/Ø§Ù„Ø¢Ø¬Ù„) ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
    <select id="rType" onchange="updateRightFields(this.value)">
    <option value="">ğŸ¤ Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚</option>
    <option>Ø¯ÙŠÙ†</option>
    <option>Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„</option>
    <option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="rAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚ (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ)" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
    <div id="rDynamicFields"></div>
    <input id="rDesc" placeholder="ğŸ‘¤ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ù„Ù…Ø¯ÙŠÙ†/Ø§Ù„Ø¬Ù‡Ø©)">
    <div class="datetime-container">
        <input id="rDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    <select id="rStatus">
    <option value="">âœ… Ø§Ù„Ø­Ø§Ù„Ø©</option>
    <option value="ÙƒØ§Ù…Ù„">Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</option>
    <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ Ø¨Ø¹Ø¯</option>
    </select>
    <button class="action" onclick="addRight()">
        <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ø­Ù‚
    </button>
    <button class="secondary" onclick="openLog('rig')">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ‚
    </button>
    </div>
</div>

<div id="debts" class="section">
    <div class="card">
    <p style="color: var(--danger); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø¯ÙØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
    <select id="dType" onchange="updateDebtFields(this.value)">
    <option value="">ğŸ§¾ Ù†ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</option>
    <option>Ø¥ÙŠØ¬Ø§Ø±</option>
    <option>ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
    <option>Ù…Ø§Ø¡</option>
    <option>Ø¥Ù†ØªØ±Ù†Øª</option>
    <option>Ù‚Ø±Ø¶</option> <option>Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ</option> <option>Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø© Ø£Ø®Ø±Ù‰</option>
    <option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="dAmount" type="text" placeholder="ğŸ’µ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©/Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">

    <div id="dDynamicFields"></div>
    <input id="dDesc" placeholder="ğŸ¢ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ù„Ø¯Ø§Ø¦Ù†/Ø§Ù„Ø¬Ù‡Ø©)">
    <div class="datetime-container">
        <input id="dDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    <select id="dStatus">
    <option value="">âœ… Ø§Ù„Ø­Ø§Ù„Ø©</option>
    <option value="Ù…Ø¯ÙÙˆØ¹">Ù…Ø¯ÙÙˆØ¹</option>
    <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
    </select>
    <button class="action" onclick="addDebt()">
        <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…
    </button>
    <button class="secondary" onclick="openLog('deb')">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    </button>
    </div>
</div>

<div class="modal" id="logModal">
    <header>
        <input id="search" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„..." oninput="renderLog()">
        <button onclick="closeLayer('log')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content" id="logContent"></div>
</div>

<div class="modal" id="detailModal">
    <header>
        <span class="title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</span>
        <button onclick="closeLayer('detail')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content detail" id="detailContent"></div>
</div>

<div class="modal" id="editModal">
    <header>
        <span class="title" id="editModalTitle">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</span>
        <button onclick="closeLayer('edit')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <div id="editFormContainer">
            <div id="editExpForm" style="display:none;">
                <input id="eEditAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
                <select id="eEditType"></select> <input id="eEditDesc" placeholder="ğŸ“ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
                <div class="datetime-container">
                    <input id="eEditDate" type="datetime-local">
                    <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
                </div>
                
                <p id="eEditImgInfo" style="font-size: 0.9em; color: var(--p); text-align: right; margin-top: 10px;"></p>
                <button class="secondary" onclick="document.getElementById('eEditImgNew').click()">
                    <i class="fas fa-camera" style="margin-left: 5px;"></i> Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                </button>
                <input type="file" id="eEditImgNew" accept="image/*" style="display: none;" onchange="updateEditFileName(this, 'eEditImgInfo')">
                <button class="secondary" id="eEditImgRemoveBtn" style="background: var(--danger); color: var(--text-light); border: none; margin-top: 5px; display: none;" onclick="removeEditImage('eEditImgInfo')">
                     <i class="fas fa-trash-alt" style="margin-left: 5px;"></i> Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                </button>
            </div>

            <div id="editRigDebForm" style="display:none;">
                <select id="rdEditType"></select> <input id="rdEditAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
                <div id="rdEditDynamicFields"></div>
                <input id="rdEditDesc" placeholder="ğŸ“ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
                <div class="datetime-container">
                    <input id="rdEditDate" type="datetime-local">
                    <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
                </div>
                <select id="rdEditStatus"></select> <p id="rdEditPaidInfo" style="font-size: 0.9em; color: var(--success); text-align: right; margin-top: 10px; font-weight: bold;"></p>
            </div>

        </div>

        <button class="action" onclick="updateTransaction()">
            <i class="fas fa-check" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
        </button>
    </div>
</div>


<div class="modal" id="balanceActionModal">
    <header>
        <span class="title" id="actionModalTitle"></span>
        <button onclick="closeLayer('balanceAction')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <p style="text-align: center; font-size: 1.1em;">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="currentBalanceInAction" style="color: var(--p); font-weight: bold;"></span></p>
        <input id="bAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
        <input id="bDesc" placeholder="ğŸ“ ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Ù…Ø«Ù„: Ø±Ø§ØªØ¨ØŒ ØªØ­ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ)">
        <div class="datetime-container">
            <input id="bDate" type="datetime-local">
            <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
        </div>
        <button class="action" onclick="processBalanceAction()">
            <i class="fas fa-check" style="margin-left: 5px;"></i> ØªÙ†ÙÙŠØ°
        </button>
    </div>
</div>

<div class="modal" id="balanceLogModal">
    <header>
        <span class="title">Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯</span>
        <button onclick="closeLayer('balanceLog')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content" id="balanceLogContent">
        </div>
</div>

<div id="imageSourceModal">
    <h3 style="margin-bottom: 20px;">Ø§Ø®ØªÙŠØ§Ø± Ù…ØµØ¯Ø± Ø§Ù„ØµÙˆØ±Ø©</h3>
    <button class="action" onclick="openCameraInput()"><i class="fas fa-camera" style="margin-left: 10px;"></i> Ø§Ù„ØªÙ‚Ø§Ø· Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
    <button class="secondary" onclick="openGalleryInput()"><i class="fas fa-images" style="margin-left: 10px;"></i> Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ø¶</button>
    <button class="secondary" style="background: none; border: none; color: var(--danger); margin-top: 10px;" onclick="closeLayer('imageSource')">Ø¥Ù„ØºØ§Ø¡</button>
</div>
<div class="sidebar-overlay" id="imageSourceOverlay" style="z-index: 140; display: none;" onclick="closeLayer('imageSource')"></div>

<div class="toast" id="toast"></div>

<div class="sidebar-overlay" onclick="closeLayer('sidebar')"></div>

<div class="sidebar" id="appSidebar">
    <div class="sidebar-header">
        <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        <button onclick="closeLayer('sidebar')"><i class="fas fa-times"></i></button>
    </div>
    <div class="sidebar-content">
        <div class="card" style="margin: 0 15px 15px; border-top: 5px solid var(--s);">
             <p style="font-weight: bold; margin-top: 0; color: var(--p);">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</p>
             
             <div class="switch-container">
                 <i class="fas fa-moon" style="margin-left: 10px;"></i> <span>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span>
                 <label class="switch">
                     <input type="checkbox" id="darkModeToggle" onclick="toggleDarkMode()">
                     <span class="slider"></span>
                 </label>
             </div>
             
             <div class="switch-container" style="margin-top: 10px; border-top: 1px dashed var(--border-color);">
                 <i class="fas fa-language" style="margin-left: 10px;"></i> <span id="currentLangDisplay">Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¶: Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</span>
                 <label class="switch">
                     <input type="checkbox" id="langToggle" onclick="toggleLanguage()">
                     <span class="slider"></span>
                 </label>
             </div>
             
             <button class="secondary" onclick="openCurrencyModal()" style="display: flex; justify-content: space-between; align-items: center; border: none; background: var(--card-bg); margin-top: 15px;">
                 <span id="currentCurrencyDisplay" style="font-weight: bold;">Ø§Ù„Ø¹Ù…Ù„Ø©: Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ (Ø±.Ø³)</span>
                 <span style="color: var(--p);"><i class="fas fa-exchange-alt"></i> ØªØºÙŠÙŠØ±</span>
             </button>
        </div>
        
        <div class="sidebar-menu-item" onclick="exportData()">
            <i class="fas fa-file-export"></i> <span>ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</span>
        </div>
        
        <div class="sidebar-menu-item" onclick="document.getElementById('importFile').click()">
            <i class="fas fa-file-import"></i> <span>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</span>
        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
        <div class="sidebar-menu-item" onclick="openAboutModal()">
            <i class="fas fa-info-circle"></i> <span>Ø­ÙˆÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>
        </div>
        <div class="sidebar-menu-item" onclick="confirmResetData()" style="color: var(--danger);">
            <i class="fas fa-exclamation-triangle"></i> <span>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        </div>
    </div>
</div>

<div class="modal" id="aboutModal">
    <header>
        <h3 style="color: var(--p);">Ø­ÙˆÙ„ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ©</h3>
        <button onclick="closeLayer('about')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <p>ØªØ·Ø¨ÙŠÙ‚ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© Ù‡Ùˆ Ø£Ø¯Ø§Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ ØªØªØ¨Ø¹:</p>
        <ul>
            <li><i class="fas fa-wallet" style="color: var(--s);"></i> **Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø©** Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.</li>
            <li><i class="fas fa-receipt" style="color: var(--s);"></i> **Ø§Ù„Ø­Ù‚ÙˆÙ‚** Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ù„Ùƒ (Ø¯ÙŠÙˆÙ†ØŒ Ø¨ÙŠØ¹ Ø¢Ø¬Ù„).</li>
            <li><i class="fas fa-clipboard-list" style="color: var(--s);"></i> **Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª** Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ø¹Ù„ÙŠÙƒ (ÙÙˆØ§ØªÙŠØ±ØŒ Ø£Ù‚Ø³Ø§Ø·ØŒ Ù‚Ø±ÙˆØ¶).</li>
        </ul>
        <p class="card" style="border-top: 3px solid var(--danger);">
            <strong>Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©:</strong> ÙŠØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ© IndexedDBØŒ ÙˆÙ„Ø§ ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ø£ÙŠ Ø®Ø§Ø¯Ù… Ø®Ø§Ø±Ø¬ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ.
        </p>
        <p style="text-align: center; margin-top: 20px; color: #999; font-size: 0.9em;">Ø§Ù„Ø¥ØµØ¯Ø§Ø± 3.2 (Ù…Ø¹ Ù…ÙŠØ²Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙÙˆØ±ÙŠ)</p>
    </div>
</div>

<div class="modal" id="currencyModal">
    <header>
        <h3 style="color: var(--p);">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø©</h3>
        <button onclick="closeLayer('currency')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <input id="currencySearch" type="text" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„Ø© (Ø±ÙŠØ§Ù„ØŒ Ø¬Ù†ÙŠÙ‡ØŒ Ø¯ÙˆÙ„Ø§Ø±...)" oninput="renderCurrencyList()">
        <div id="currencyList">
        </div>
    </div>
</div>

<script>
// ===================================================
// 1. Ø¥Ø¹Ø¯Ø§Ø¯ IndexedDB ÙˆÙ…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Øª
// ===================================================
const IDB_NAME = "MySmartBudgetDB";
const IDB_VERSION = 4;
const STORE_NAMES = ["exp", "rig", "deb", "bal"];
let db = { exp: [], rig: [], deb: [], bal: { clientId: 1, amount: 0, changes: [] } };
let IDB_connection = null;

// Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
let currentLog = "", editMode = null, balanceActionType = null;
let currentBalance = 0;
let balanceHidden = localStorage.getItem('balanceHidden') === 'true';
let currentImageBase64 = null; // Ø¬Ø¯ÙŠØ¯: Ù„Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„

let currentLang = localStorage.getItem('appLang') || 'ar'; // Ø¬Ø¯ÙŠØ¯: Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù„ØºØ©

// Ø¬Ø¯ÙŠØ¯: ÙˆØ¸ÙŠÙØ© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù…Ø² Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©
function getCurrencySymbol(currency) {
    if (currency.code === 'SDG' && currentLang === 'en') {
        return currency.symbol_en; // SDG
    }
    return currency.symbol_ar; // Ø¬.Ø³ Ø£Ùˆ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù„Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
}

// Ø¬Ø¯ÙŠØ¯: ÙˆØ¸ÙŠÙØ© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©
function getCurrencyName(currency) {
    return currentLang === 'ar' ? currency.name_ar : currency.name_en;
}

const EXP_TYPES = ["Ø·Ø¹Ø§Ù…", "Ù…ÙˆØ§ØµÙ„Ø§Øª", "Ø±Ø¹Ø§ÙŠØ© Ø´Ø®ØµÙŠØ©", "Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©", "ØµØ­Ø©", "ØªØ±ÙÙŠÙ‡", "ØªØ³ÙˆÙ‚", "ØªØ¹Ù„ÙŠÙ…", "ØµÙŠØ§Ù†Ø© ÙˆØ¥ØµÙ„Ø§Ø­", "Ø£Ø®Ø±Ù‰"];
const RIG_TYPES = ["Ø¯ÙŠÙ†", "Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„", "Ø£Ø®Ø±Ù‰"];
const DEB_TYPES = ["Ø¥ÙŠØ¬Ø§Ø±", "ÙƒÙ‡Ø±Ø¨Ø§Ø¡", "Ù…Ø§Ø¡", "Ø¥Ù†ØªØ±Ù†Øª", "Ù‚Ø±Ø¶", "Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ", "Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø© Ø£Ø®Ø±Ù‰", "Ø£Ø®Ø±Ù‰"];

// Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ù‚Ù„ (ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© 'edit')
const LAYERS = {
    'sidebar': { elementId: 'appSidebar', type: 'menu' },
    'log': { elementId: 'logModal', type: 'modal' },
    'detail': { elementId: 'detailModal', type: 'modal' },
    'currency': { elementId: 'currencyModal', type: 'modal' },
    'about': { elementId: 'aboutModal', type: 'modal' },
    'balanceAction': { elementId: 'balanceActionModal', type: 'modal' },
    'balanceLog': { elementId: 'balanceLogModal', type: 'modal' },
    'imageSource': { elementId: 'imageSourceModal', type: 'menu' },
    'edit': { elementId: 'editModal', type: 'modal' }
};
let historyStack = [];

// ØªØ­Ø¯ÙŠØ«: Ù…ØµÙÙˆÙØ© Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© Ù…Ø¹ Ø¯Ø¹Ù… Ù„Ù„Ø§Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
const ARABIC_CURRENCIES = [ 
    // Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: Ø§Ù„Ø¬Ù†ÙŠÙ‡ Ø§Ù„Ø³ÙˆØ¯Ø§Ù†ÙŠ (SDG)
    { code: 'SDG', symbol_ar: 'Ø¬.Ø³', symbol_en: 'SDG', name_ar: 'Ø§Ù„Ø¬Ù†ÙŠÙ‡ Ø§Ù„Ø³ÙˆØ¯Ø§Ù†ÙŠ', name_en: 'Sudanese Pound' },
    // Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø®Ù„ÙŠØ¬
    { code: 'SAR', symbol_ar: 'Ø±.Ø³', symbol_en: 'SAR', name_ar: 'Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ', name_en: 'Saudi Riyal' },
    { code: 'AED', symbol_ar: 'Ø¯.Ø¥', symbol_en: 'AED', name_ar: 'Ø¯Ø±Ù‡Ù… Ø¥Ù…Ø§Ø±Ø§ØªÙŠ', name_en: 'UAE Dirham' },
    { code: 'QAR', symbol_ar: 'Ø±.Ù‚', symbol_en: 'QAR', name_ar: 'Ø±ÙŠØ§Ù„ Ù‚Ø·Ø±ÙŠ', name_en: 'Qatari Riyal' },
    { code: 'KWD', symbol_ar: 'Ø¯.Ùƒ', symbol_en: 'KWD', name_ar: 'Ø¯ÙŠÙ†Ø§Ø± ÙƒÙˆÙŠØªÙŠ', name_en: 'Kuwaiti Dinar' },
    { code: 'BHD', symbol_ar: 'Ø¯.Ø¨', symbol_en: 'BHD', name_ar: 'Ø¯ÙŠÙ†Ø§Ø± Ø¨Ø­Ø±ÙŠÙ†ÙŠ', name_en: 'Bahraini Dinar' },
    { code: 'OMR', symbol_ar: 'Ø±.Ø¹.', symbol_en: 'OMR', name_ar: 'Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ', name_en: 'Omani Rial' },
    // Ø¹Ù…Ù„Ø§Øª Ø¹Ø±Ø¨ÙŠØ© Ø£Ø®Ø±Ù‰
    { code: 'EGP', symbol_ar: 'Ø¬.Ù…', symbol_en: 'EGP', name_ar: 'Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ', name_en: 'Egyptian Pound' },
    { code: 'JOD', symbol_ar: 'Ø¯.Ø§', symbol_en: 'JOD', name_ar: 'Ø¯ÙŠÙ†Ø§Ø± Ø£Ø±Ø¯Ù†ÙŠ', name_en: 'Jordanian Dinar' },
    { code: 'LBP', symbol_ar: 'Ù„.Ù„', symbol_en: 'LBP', name_ar: 'Ù„ÙŠØ±Ø© Ù„Ø¨Ù†Ø§Ù†ÙŠØ©', name_en: 'Lebanese Pound' },
    { code: 'SYP', symbol_ar: 'Ù„.Ø³', symbol_en: 'SYP', name_ar: 'Ù„ÙŠØ±Ø© Ø³ÙˆØ±ÙŠØ©', name_en: 'Syrian Pound' },
    { code: 'DZD', symbol_ar: 'Ø¯.Ø¬', symbol_en: 'DZD', name_ar: 'Ø¯ÙŠÙ†Ø§Ø± Ø¬Ø²Ø§Ø¦Ø±ÙŠ', name_en: 'Algerian Dinar' },
    { code: 'TND', symbol_ar: 'Ø¯.Øª', symbol_en: 'TND', name_ar: 'Ø¯ÙŠÙ†Ø§Ø± ØªÙˆÙ†Ø³ÙŠ', name_en: 'Tunisian Dinar' },
    { code: 'LYD', symbol_ar: 'Ø¯.Ù„', symbol_en: 'LYD', name_ar: 'Ø¯ÙŠÙ†Ø§Ø± Ù„ÙŠØ¨ÙŠ', name_en: 'Libyan Dinar' },
    { code: 'MAD', symbol_ar: 'Ø¯.Ù…', symbol_en: 'MAD', name_ar: 'Ø¯Ø±Ù‡Ù… Ù…ØºØ±Ø¨ÙŠ', name_en: 'Moroccan Dirham' },
    { code: 'YER', symbol_ar: 'Ø±.ÙŠ', symbol_en: 'YER', name_ar: 'Ø±ÙŠØ§Ù„ ÙŠÙ…Ù†ÙŠ', name_en: 'Yemeni Rial' },
    { code: 'IQD', symbol_ar: 'Ø¯.Ø¹', symbol_en: 'IQD', name_ar: 'Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ', name_en: 'Iraqi Dinar' },
    // Ø¹Ù…Ù„Ø§Øª Ø¹Ø§Ù„Ù…ÙŠØ©
    { code: 'USD', symbol_ar: '$', symbol_en: '$', name_ar: 'Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ', name_en: 'US Dollar' },
    { code: 'EUR', symbol_ar: 'â‚¬', symbol_en: 'â‚¬', name_ar: 'ÙŠÙˆØ±Ùˆ', name_en: 'Euro' },
    { code: 'GBP', symbol_ar: 'Â£', symbol_en: 'Â£', name_ar: 'Ø¬Ù†ÙŠÙ‡ Ø¥Ø³ØªØ±Ù„ÙŠÙ†ÙŠ', name_en: 'British Pound' },
    { code: 'JPY', symbol_ar: 'Â¥', symbol_en: 'Â¥', name_ar: 'ÙŠÙ† ÙŠØ§Ø¨Ø§Ù†ÙŠ', name_en: 'Japanese Yen' },
    { code: 'CNY', symbol_ar: 'Â¥', symbol_en: 'Â¥', name_ar: 'ÙŠÙˆØ§Ù† ØµÙŠÙ†ÙŠ', name_en: 'Chinese Yuan' },
    { code: 'RUB', symbol_ar: 'â‚½', symbol_en: 'â‚½', name_ar: 'Ø±ÙˆØ¨Ù„ Ø±ÙˆØ³ÙŠ', name_en: 'Russian Ruble' },
    { code: 'INR', symbol_ar: 'â‚¹', symbol_en: 'â‚¹', name_ar: 'Ø±ÙˆØ¨ÙŠØ© Ù‡Ù†Ø¯ÙŠØ©', name_en: 'Indian Rupee' },
    { code: 'TRY', symbol_ar: 'â‚º', symbol_en: 'â‚º', name_ar: 'Ù„ÙŠØ±Ø© ØªØ±ÙƒÙŠØ©', name_en: 'Turkish Lira' },
    { code: 'CAD', symbol_ar: '$', symbol_en: '$', name_ar: 'Ø¯ÙˆÙ„Ø§Ø± ÙƒÙ†Ø¯ÙŠ', name_en: 'Canadian Dollar' },
    { code: 'AUD', symbol_ar: '$', symbol_en: '$', name_ar: 'Ø¯ÙˆÙ„Ø§Ø± Ø£Ø³ØªØ±Ø§Ù„ÙŠ', name_en: 'Australian Dollar' },
    { code: 'CHF', symbol_ar: 'CHF', symbol_en: 'CHF', name_ar: 'ÙØ±Ù†Ùƒ Ø³ÙˆÙŠØ³Ø±ÙŠ', name_en: 'Swiss Franc' },
    { code: 'KRW', symbol_ar: 'â‚©', symbol_en: 'â‚©', name_ar: 'ÙˆÙˆÙ† ÙƒÙˆØ±ÙŠ Ø¬Ù†ÙˆØ¨ÙŠ', name_en: 'South Korean Won' },
    { code: 'SEK', symbol_ar: 'kr', symbol_en: 'kr', name_ar: 'ÙƒØ±ÙˆÙ†Ø§ Ø³ÙˆÙŠØ¯ÙŠØ©', name_en: 'Swedish Krona' },
    { code: 'NOK', symbol_ar: 'kr', symbol_en: 'kr', name_ar: 'ÙƒØ±ÙˆÙ†Ø© Ù†Ø±ÙˆÙŠØ¬ÙŠØ©', name_en: 'Norwegian Krone' },
    { code: 'DKK', symbol_ar: 'kr', symbol_en: 'kr', name_ar: 'ÙƒØ±ÙˆÙ†Ø© Ø¯Ù†Ù…Ø§Ø±ÙƒÙŠØ©', name_en: 'Danish Krone' },
    { code: 'ZAR', symbol_ar: 'R', symbol_en: 'R', name_ar: 'Ø±Ø§Ù†Ø¯ Ø¬Ù†ÙˆØ¨ Ø£ÙØ±ÙŠÙ‚ÙŠ', name_en: 'South African Rand' },
    { code: 'BRL', symbol_ar: 'R$', symbol_en: 'R$', name_ar: 'Ø±ÙŠØ§Ù„ Ø¨Ø±Ø§Ø²ÙŠÙ„ÙŠ', name_en: 'Brazilian Real' },
];

let currentCurrency = ARABIC_CURRENCIES.find(c => c.code === (localStorage.getItem('currencyCode') || 'SDG')); // ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¥Ù„Ù‰ 'SDG'

// ===================================================
// 2. ÙˆØ¸Ø§Ø¦Ù IndexedDB ÙˆØ§Ù„Ø­ÙØ¸
// ===================================================
function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(IDB_NAME, IDB_VERSION);

        request.onupgradeneeded = (event) => {
            IDB_connection = event.target.result;
            STORE_NAMES.forEach(storeName => {
                if (!IDB_connection.objectStoreNames.contains(storeName)) {
                    IDB_connection.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
                }
            });
        };

        request.onsuccess = (event) => {
            IDB_connection = event.target.result;
            loadAllData().then(resolve);
        };

        request.onerror = (event) => {
            console.error("IndexedDB error:", event.target.errorCode);
            toastMsg("ÙØ´Ù„ ÙÙŠ ÙØªØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©.");
            reject(event.target.error);
        };
    });
}

function saveData(storeName, data) {
    return new Promise((resolve, reject) => {
        if (!IDB_connection) return reject("Database not connected.");
        const transaction = IDB_connection.transaction([storeName], "readwrite");
        const store = transaction.objectStore(storeName);
        
        const request = store.put(data);

        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

function deleteData(storeName, id) {
    return new Promise((resolve, reject) => {
        if (!IDB_connection) return reject("Database not connected.");
        const transaction = IDB_connection.transaction([storeName], "readwrite");
        const store = transaction.objectStore(storeName);
        
        const request = store.delete(id);

        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
    });
}

function loadStore(storeName) {
    return new Promise((resolve, reject) => {
        if (!IDB_connection) return reject("Database not connected.");
        
        const transaction = IDB_connection.transaction([storeName], "readonly");
        const store = transaction.objectStore(storeName);
        const request = store.getAll();

        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

function loadAllData() {
    return Promise.all([
        loadStore('exp').then(data => db.exp = data.sort((a, b) => new Date(b.date) - new Date(a.date))),
        loadStore('rig').then(data => db.rig = data.sort((a, b) => new Date(b.date) - new Date(a.date))),
        loadStore('deb').then(data => db.deb = data.sort((a, b) => new Date(b.date) - new Date(a.date))),
        loadStore('bal').then(data => {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø³Ø¬Ù„ Ø§Ù„Ø±ØµÙŠØ¯ØŒ ÙˆØ¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ØŒ ÙŠØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡.
            if (data.length === 0) {
                 db.bal = { clientId: 1, amount: 0, changes: [] };
                 return saveData('bal', db.bal);
            } else {
                 db.bal = data[0];
            }
        })
    ]).then(() => {
        currentBalance = db.bal.amount;
        updateStats();
        updateBalanceDisplay();
        console.log("Data loaded successfully.");
    }).catch(error => {
        console.error("Error loading data:", error);
    });
}


// ===================================================
// 3. ÙˆØ¸Ø§Ø¦Ù ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (UI)
// ===================================================

function updateBalanceDisplay() {
    const balanceP = document.getElementById('currentBalanceDisplay');
    const symbol = getCurrencySymbol(currentCurrency); // *** ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù…Ø² Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ© ***
    const currencyName = getCurrencyName(currentCurrency); // *** ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ø³Ù… Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ© ***

    const locale = currentLang === 'ar' ? 'ar-SA' : 'en-US'; 
    const formattedBalance = currentBalance.toLocaleString(locale, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    
    if (balanceHidden) {
        balanceP.innerHTML = `<span class="hidden-balance">â€¢â€¢â€¢â€¢â€¢â€¢</span>`;
        document.getElementById('balanceVisibilityToggle').innerHTML = `<i class="fas fa-eye-slash"></i>`;
    } else {
        balanceP.innerHTML = `<span class="currency-symbol">${symbol}</span>${formattedBalance}`;
        document.getElementById('balanceVisibilityToggle').innerHTML = `<i class="fas fa-eye"></i>`;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
    const balanceInAction = document.getElementById('currentBalanceInAction');
    if (balanceInAction) {
        balanceInAction.innerHTML = `<span class="currency-symbol">${symbol}</span>${formattedBalance}`;
    }

    const displayElement = document.getElementById('currentCurrencyDisplay');
    if (displayElement) {
        // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù‡Ù†Ø§ Ù„Ø£Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        displayElement.innerText = `Ø§Ù„Ø¹Ù…Ù„Ø©: ${currentCurrency.name_ar} (${symbol})`;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø±Ù…Ø² Ø§Ù„Ø¹Ù…Ù„Ø© ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    document.getElementById('sExpTotal').innerHTML = `<span class="currency-symbol">${symbol}</span>0`;
    document.getElementById('sRigTotal').innerHTML = `<span class="currency-symbol">${symbol}</span>0`;
    document.getElementById('sDebTotal').innerHTML = `<span class="currency-symbol">${symbol}</span>0`;
    document.getElementById('sRigPaid').innerHTML = `<span class="currency-symbol">${symbol}</span>0`;
    document.getElementById('sDebPaid').innerHTML = `<span class="currency-symbol">${symbol}</span>0`;
}

function updateStats() {
    const symbol = getCurrencySymbol(currentCurrency);
    const locale = currentLang === 'ar' ? 'ar-SA' : 'en-US'; 

    let totalExp = db.exp.reduce((sum, item) => sum + item.amount, 0);
    let totalRig = db.rig.reduce((sum, item) => sum + item.amount, 0);
    let totalDeb = db.deb.reduce((sum, item) => sum + item.amount, 0);
    let totalRigPaid = db.rig.filter(item => item.paidAmount && item.paidAmount > 0).reduce((sum, item) => sum + item.paidAmount, 0);
    let totalDebPaid = db.deb.filter(item => item.paidAmount && item.paidAmount > 0).reduce((sum, item) => sum + item.paidAmount, 0);

    const format = (amount) => {
        const formattedAmount = amount.toLocaleString(locale, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        return `<span class="currency-symbol">${symbol}</span>${formattedAmount}`;
    };

    document.getElementById('sExpTotal').innerHTML = format(totalExp);
    document.getElementById('sRigTotal').innerHTML = format(totalRig);
    document.getElementById('sDebTotal').innerHTML = format(totalDeb);
    document.getElementById('sRigPaid').innerHTML = format(totalRigPaid);
    document.getElementById('sDebPaid').innerHTML = format(totalDebPaid);
}


function toggleBalanceVisibility() {
    balanceHidden = !balanceHidden;
    localStorage.setItem('balanceHidden', balanceHidden);
    updateBalanceDisplay();
}

function openTab(tabName) {
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    document.querySelectorAll('.tabs button').forEach(button => {
        button.classList.remove('active');
    });

    document.getElementById(tabName).classList.add('active');
    document.querySelector(`.tabs button[onclick="openTab('${tabName}')"]`).classList.add('active');
}

function openLayer(layerName) {
    const layer = LAYERS[layerName];
    if (layer.type === 'modal') {
        document.getElementById(layer.elementId).style.display = 'flex';
    } else if (layer.type === 'menu') {
        document.getElementById(layer.elementId).classList.add('open');
    }
    historyStack.push(layerName);
}

function closeLayer(layerName) {
    const layer = LAYERS[layerName];
    if (layer.type === 'modal') {
        document.getElementById(layer.elementId).style.display = 'none';
    } else if (layer.type === 'menu') {
        document.getElementById(layer.elementId).classList.remove('open');
        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ±Ø§ÙƒØ¨ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙÙ‚Ø·
        if (layerName === 'sidebar') {
            document.querySelector('.sidebar-overlay').classList.remove('open');
        }
    }
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ù‚Ø© Ù…Ù† Ø§Ù„Ù…ÙƒØ¯Ø³
    historyStack = historyStack.filter(name => name !== layerName);
}

function openSidebar() {
    document.getElementById('appSidebar').classList.add('open');
    document.querySelector('.sidebar-overlay').classList.add('open');
    openLayer('sidebar');
}

function toastMsg(msg) {
    const toast = document.getElementById('toast');
    toast.innerText = msg;
    toast.classList.add('show');
    setTimeout(() => {
        toast.classList.remove('show');
    }, 2500);
}

// ------------------------------------
// ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ (Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª)
// ------------------------------------
function formatAmount(input) {
    let value = input.value.replace(/,/g, ''); 
    if (isNaN(value) || value.trim() === '') {
        input.value = '';
        return;
    }
    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ù‚Ù… Ù…Ø¹ ÙØ§ØµÙ„Ø© Ø§Ù„Ø¢Ù„Ø§Ù
    input.value = parseFloat(value).toLocaleString('en-US', { maximumFractionDigits: 2 });
}

function parseAmount(value) {
    return parseFloat(value.replace(/,/g, ''));
}

function openBalanceActionModal(actionType) {
    balanceActionType = actionType;
    document.getElementById('actionModalTitle').innerText = actionType === 'deposit' ? 'Ø¹Ù…Ù„ÙŠØ© Ø¥ÙŠØ¯Ø§Ø¹' : 'Ø¹Ù…Ù„ÙŠØ© Ø³Ø­Ø¨';
    document.getElementById('bAmount').value = '';
    document.getElementById('bDesc').value = '';
    document.getElementById('bDate').value = new Date().toISOString().slice(0, 16);
    openLayer('balanceAction');
}

function processBalanceAction() {
    const amountInput = document.getElementById('bAmount');
    const desc = document.getElementById('bDesc').value.trim();
    const date = document.getElementById('bDate').value;

    const amount = parseAmount(amountInput.value);

    if (isNaN(amount) || amount <= 0 || !date) {
        return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­ ÙˆØªØ§Ø±ÙŠØ®.");
    }

    if (balanceActionType === 'withdraw' && amount > currentBalance) {
        return toastMsg("ÙØ´Ù„: Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³Ø­ÙˆØ¨ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ.");
    }

    const type = balanceActionType;
    const sign = type === 'deposit' ? 1 : -1;
    const newBalance = currentBalance + (amount * sign);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±
    const changeRecord = {
        id: Date.now(),
        type: type,
        amount: amount,
        desc: desc || (type === 'deposit' ? 'Ø¥ÙŠØ¯Ø§Ø¹ Ù†Ù‚Ø¯ÙŠ' : 'Ø³Ø­Ø¨ Ù†Ù‚Ø¯ÙŠ'),
        date: date,
        newBalance: newBalance,
    };
    
    db.bal.amount = newBalance;
    db.bal.changes.unshift(changeRecord);
    currentBalance = newBalance;

    saveData('bal', db.bal).then(() => {
        updateBalanceDisplay();
        closeLayer('balanceAction');
        toastMsg(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© ${type === 'deposit' ? 'Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹' : 'Ø§Ù„Ø³Ø­Ø¨'} Ø¨Ù†Ø¬Ø§Ø­.`);
        document.getElementById('bAmount').value = '';
    }).catch(() => {
        toastMsg("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.");
    });
}

function openBalanceLogModal() {
    const container = document.getElementById('balanceLogContent');
    const symbol = getCurrencySymbol(currentCurrency);
    const locale = currentLang === 'ar' ? 'ar-SA' : 'en-US';

    if (db.bal.changes.length === 0) {
        container.innerHTML = `<p style="text-align: center; color: #999;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯.</p>`;
        openLayer('balanceLog');
        return;
    }

    let html = '';
    db.bal.changes.forEach(c => {
        const typeClass = c.type === 'deposit' ? 'success' : 'danger';
        const typeText = c.type === 'deposit' ? 'Ø¥ÙŠØ¯Ø§Ø¹' : 'Ø³Ø­Ø¨';
        const formattedAmount = c.amount.toLocaleString(locale, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const dateString = new Date(c.date).toLocaleString('ar-SA', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        
        html += `
            <div class="list-item" style="border-right: 5px solid var(--${typeClass}); padding-bottom: 5px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: var(--${typeClass}); font-weight: bold; font-size: 1.1em;">
                        ${typeText} (${c.type === 'deposit' ? '+' : '-'}) <span class="currency-symbol" style="margin: 0 2px;">${symbol}</span>${formattedAmount}
                    </span>
                    <i class="fas fa-trash-alt" style="color: var(--danger); font-size: 0.9em;" onclick="deleteBalanceChange(${c.id})"></i>
                </div>
                <div class="details">
                    <span>${c.desc || '---'}</span>
                    <span style="color: #999; font-size: 0.8em;">${dateString}</span>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
    openLayer('balanceLog');
}

function deleteBalanceChange(id) {
    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ")) return;

    const index = db.bal.changes.findIndex(c => c.id === id);
    if (index === -1) return toastMsg("Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.");

    const deletedChange = db.bal.changes[index];
    const sign = deletedChange.type === 'deposit' ? -1 : 1; // Ø¹ÙƒØ³ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
    const newBalance = currentBalance + (deletedChange.amount * sign);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    db.bal.amount = newBalance;
    db.bal.changes.splice(index, 1);
    currentBalance = newBalance;

    saveData('bal', db.bal).then(() => {
        updateBalanceDisplay();
        openBalanceLogModal(); // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„
        toastMsg("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­.");
    }).catch(() => {
        toastMsg("ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.");
    });
}

// ------------------------------------
// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (Expenses)
// ------------------------------------

function addExpense() {
    const amount = parseAmount(document.getElementById('eAmount').value);
    const type = document.getElementById('eType').value;
    const desc = document.getElementById('eDesc').value.trim();
    const date = document.getElementById('eDate').value;

    if (isNaN(amount) || amount <= 0 || !type || !date) {
        return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­ ÙˆØ§Ø®ØªÙŠØ§Ø± ÙØ¦Ø© ÙˆØªØ§Ø±ÙŠØ®.");
    }
    
    if (amount > currentBalance) {
        return toastMsg("ÙØ´Ù„: Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØµØ±ÙˆÙ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ.");
    }

    const newExpense = {
        id: Date.now(),
        amount: amount,
        type: type,
        desc: desc,
        date: date,
        img: currentImageBase64,
    };
    
    // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ (Ø®ØµÙ… Ø§Ù„Ù…ØµØ±ÙˆÙ)
    const oldBalance = currentBalance;
    currentBalance -= amount;

    const changeRecord = {
        id: Date.now() + 1, // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ID ÙŠØ®ØªÙ„Ù Ø¹Ù† Ø§Ù„Ù…ØµØ±ÙˆÙ
        type: 'expense',
        amount: amount,
        desc: `Ù…ØµØ±ÙˆÙ: ${type}` + (desc ? ` (${desc})` : ''),
        date: date,
        newBalance: currentBalance,
        linkedId: newExpense.id
    };
    
    db.bal.amount = currentBalance;
    db.bal.changes.unshift(changeRecord);
    
    // 2. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„
    db.exp.unshift(newExpense);

    Promise.all([
        saveData('exp', newExpense),
        saveData('bal', db.bal)
    ]).then(() => {
        updateStats();
        updateBalanceDisplay();
        toastMsg("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­.");
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„
        document.getElementById('eAmount').value = '';
        document.getElementById('eType').value = '';
        document.getElementById('eDesc').value = '';
        document.getElementById('eDate').value = new Date().toISOString().slice(0, 16);
        currentImageBase64 = null;
        document.getElementById('eImgName').innerText = '';
    }).catch(error => {
        // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ØŒ Ø£Ø¹Ø¯ Ø§Ù„Ø±ØµÙŠØ¯ Ø¥Ù„Ù‰ Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        currentBalance = oldBalance;
        db.bal.amount = oldBalance;
        db.exp.shift();
        db.bal.changes.shift();
        toastMsg("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ.");
        console.error(error);
    });
}

// ------------------------------------
// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­Ù‚ÙˆÙ‚ (Rights) ÙˆØ§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª (Debts)
// ------------------------------------

function updateDynamicFields(type, containerId) {
    const container = document.getElementById(containerId);
    let html = '';
    
    if (type === 'Ø¯ÙŠÙ†' || type === 'Ù‚Ø±Ø¶' || type === 'Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„' || type === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ') {
        html += `<input id="${containerId.replace('DynamicFields', 'Repayment')}" type="text" placeholder="ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹/Ø§Ù„Ù…Ø­ØµÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">`;
        html += `<input id="${containerId.replace('DynamicFields', 'Total')}" type="text" placeholder="ğŸ“ˆ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (ØºÙŠØ± Ø¶Ø±ÙˆØ±ÙŠ)" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">`;
    }
    
    container.innerHTML = html;
}

function updateRightFields(type) { updateDynamicFields(type, 'rDynamicFields'); }
function updateDebtFields(type) { updateDynamicFields(type, 'dDynamicFields'); }


function addRight() {
    const amount = parseAmount(document.getElementById('rAmount').value);
    const type = document.getElementById('rType').value;
    const desc = document.getElementById('rDesc').value.trim();
    const date = document.getElementById('rDate').value;
    const status = document.getElementById('rStatus').value;
    const paidAmount = parseAmount(document.getElementById('rRepayment') ? document.getElementById('rRepayment').value : '0');

    if (isNaN(amount) || amount <= 0 || !type || !date || !status) {
        return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ ÙˆØ§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ ÙˆØªØ§Ø±ÙŠØ® ÙˆØ­Ø§Ù„Ø©.");
    }

    // ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„ (Ø¥Ù† ÙˆØ¬Ø¯) Ø¥Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯
    let balanceChange = 0;
    let changeRecord = null;
    let finalStatus = status;

    if (paidAmount > 0) {
        balanceChange = paidAmount;
        currentBalance += paidAmount;
        db.bal.amount = currentBalance;
        
        finalStatus = (paidAmount >= amount) ? 'ÙƒØ§Ù…Ù„' : 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ (Ø¬Ø²Ø¦ÙŠ)';

        changeRecord = {
            id: Date.now() + 1,
            type: 'right_paid',
            amount: paidAmount,
            desc: `ØªØ­ØµÙŠÙ„ Ø­Ù‚: ${type}` + (desc ? ` (${desc})` : ''),
            date: date,
            newBalance: currentBalance,
        };
    }

    const newRight = {
        id: Date.now(),
        amount: amount,
        type: type,
        desc: desc,
        date: date,
        status: finalStatus,
        total: parseAmount(document.getElementById('rTotal') ? document.getElementById('rTotal').value : amount),
        paidAmount: paidAmount,
        changeId: changeRecord ? changeRecord.id : null,
    };
    
    db.rig.unshift(newRight);
    
    const promises = [saveData('rig', newRight)];
    if (changeRecord) {
        db.bal.changes.unshift(changeRecord);
        promises.push(saveData('bal', db.bal));
    }

    Promise.all(promises).then(() => {
        updateStats();
        updateBalanceDisplay();
        toastMsg("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ù‚ Ø¨Ù†Ø¬Ø§Ø­.");
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„
        document.getElementById('rAmount').value = '';
        document.getElementById('rType').value = '';
        document.getElementById('rDesc').value = '';
        document.getElementById('rDate').value = new Date().toISOString().slice(0, 16);
        document.getElementById('rStatus').value = '';
        document.getElementById('rDynamicFields').innerHTML = '';
    }).catch(error => {
        if (changeRecord) {
            currentBalance -= balanceChange;
            db.bal.amount = currentBalance;
            db.bal.changes.shift();
        }
        db.rig.shift();
        toastMsg("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø­Ù‚.");
        console.error(error);
    });
}

function addDebt() {
    const amount = parseAmount(document.getElementById('dAmount').value);
    const type = document.getElementById('dType').value;
    const desc = document.getElementById('dDesc').value.trim();
    const date = document.getElementById('dDate').value;
    const status = document.getElementById('dStatus').value;
    const paidAmount = parseAmount(document.getElementById('dRepayment') ? document.getElementById('dRepayment').value : '0');

    if (isNaN(amount) || amount <= 0 || !type || !date || !status) {
        return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© ÙˆØ§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ ÙˆØªØ§Ø±ÙŠØ® ÙˆØ­Ø§Ù„Ø©.");
    }
    
    // ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ø¥Ù† ÙˆØ¬Ø¯) Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
    let balanceChange = 0;
    let changeRecord = null;
    let finalStatus = status;

    if (paidAmount > 0) {
        if (paidAmount > currentBalance) {
            return toastMsg("ÙØ´Ù„: Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ.");
        }
        balanceChange = paidAmount;
        currentBalance -= paidAmount;
        db.bal.amount = currentBalance;
        
        finalStatus = (paidAmount >= amount && status === 'Ù…Ø¯ÙÙˆØ¹') ? 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„' : status;

        changeRecord = {
            id: Date.now() + 1,
            type: 'debt_paid',
            amount: paidAmount,
            desc: `Ø¯ÙØ¹ Ø§Ù„ØªØ²Ø§Ù…: ${type}` + (desc ? ` (${desc})` : ''),
            date: date,
            newBalance: currentBalance,
        };
    }


    const newDebt = {
        id: Date.now(),
        amount: amount,
        type: type,
        desc: desc,
        date: date,
        status: finalStatus,
        total: parseAmount(document.getElementById('dTotal') ? document.getElementById('dTotal').value : amount),
        paidAmount: paidAmount,
        changeId: changeRecord ? changeRecord.id : null,
    };
    
    db.deb.unshift(newDebt);

    const promises = [saveData('deb', newDebt)];
    if (changeRecord) {
        db.bal.changes.unshift(changeRecord);
        promises.push(saveData('bal', db.bal));
    }

    Promise.all(promises).then(() => {
        updateStats();
        updateBalanceDisplay();
        toastMsg("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­.");
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„
        document.getElementById('dAmount').value = '';
        document.getElementById('dType').value = '';
        document.getElementById('dDesc').value = '';
        document.getElementById('dDate').value = new Date().toISOString().slice(0, 16);
        document.getElementById('dStatus').value = '';
        document.getElementById('dDynamicFields').innerHTML = '';
    }).catch(error => {
        if (changeRecord) {
            currentBalance += balanceChange;
            db.bal.amount = currentBalance;
            db.bal.changes.shift();
        }
        db.deb.shift();
        toastMsg("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù….");
        console.error(error);
    });
}

// ------------------------------------
// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù
// ------------------------------------

function openLog(type) {
    currentLog = type;
    document.getElementById('search').value = '';
    renderLog();
    openLayer('log');
}

function renderLog() {
    const container = document.getElementById('logContent');
    const searchVal = document.getElementById('search').value.toLowerCase();
    const symbol = getCurrencySymbol(currentCurrency);
    const locale = currentLang === 'ar' ? 'ar-SA' : 'en-US';

    let logData = db[currentLog];
    
    const filteredLog = logData.filter(item => 
        (item.desc && item.desc.toLowerCase().includes(searchVal)) ||
        (item.type && item.type.toLowerCase().includes(searchVal)) ||
        (item.amount && item.amount.toLocaleString().includes(searchVal))
    );

    if (filteredLog.length === 0) {
        container.innerHTML = `<p style="text-align: center; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©.</p>`;
        return;
    }

    let html = '';
    filteredLog.forEach(item => {
        const amount = item.amount || 0;
        const formattedAmount = amount.toLocaleString(locale, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const dateString = new Date(item.date).toLocaleString('ar-SA', { day: '2-digit', month: 'short', year: 'numeric' });
        
        let typeText = item.type;
        let typeClass = 's'; // Secondary
        let statusText = '';
        let paidInfo = '';

        if (currentLog === 'exp') {
            typeClass = 'danger';
        } else if (currentLog === 'rig') {
            typeClass = 'success';
            statusText = ` | Ø§Ù„Ø­Ø§Ù„Ø©: ${item.status}`;
            if (item.paidAmount && item.paidAmount > 0) {
                paidInfo = ` (Ù…ÙØ­ØµÙ„: ${item.paidAmount.toLocaleString(locale)})`;
            }
        } else if (currentLog === 'deb') {
            typeClass = 'warning';
            statusText = ` | Ø§Ù„Ø­Ø§Ù„Ø©: ${item.status}`;
            if (item.paidAmount && item.paidAmount > 0) {
                paidInfo = ` (Ù…Ø¯ÙÙˆØ¹: ${item.paidAmount.toLocaleString(locale)})`;
            }
        }
        
        html += `
            <div class="list-item" onclick="openDetailModal('${currentLog}', ${item.id})" style="border-right: 5px solid var(--${typeClass});">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: bold; font-size: 1.1em; color: var(--text-dark);">
                        ${typeText} 
                    </span>
                    <span style="color: var(--${typeClass}); font-weight: bold;">
                        <span class="currency-symbol" style="margin: 0 2px;">${symbol}</span>${formattedAmount}
                    </span>
                </div>
                <div class="details">
                    <span>${item.desc || '---'} ${paidInfo}</span>
                    <span style="color: #999; font-size: 0.8em;">${dateString}${statusText}</span>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}


function openDetailModal(type, id) {
    const item = db[type].find(i => i.id === id);
    if (!item) return toastMsg("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.");

    const container = document.getElementById('detailContent');
    const symbol = getCurrencySymbol(currentCurrency);
    const locale = currentLang === 'ar' ? 'ar-SA' : 'en-US';
    const formattedAmount = (item.amount || 0).toLocaleString(locale, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const dateString = new Date(item.date).toLocaleString('ar-SA', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' });

    let html = `<div class="card" style="border-top: 5px solid var(--p);">`;
    html += `<p><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${item.type}</p>`;
    html += `<p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ:</strong> <span style="font-weight: bold; color: var(--p);"><span class="currency-symbol">${symbol}</span>${formattedAmount}</span></p>`;
    html += `<p><strong>Ø§Ù„ÙˆØµÙ/Ø§Ù„Ø¬Ù‡Ø©:</strong> ${item.desc || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>`;
    html += `<p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª:</strong> ${dateString}</p>`;

    if (type === 'rig' || type === 'deb') {
        html += `<p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span style="font-weight: bold; color: ${item.status.includes('ÙƒØ§Ù…Ù„') || item.status.includes('Ù…Ø¯ÙÙˆØ¹') ? 'var(--success)' : 'var(--danger)'};">${item.status}</span></p>`;
        if (item.paidAmount && item.paidAmount > 0) {
            html += `<p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹/Ø§Ù„Ù…Ø­ØµÙ„ Ø³Ø§Ø¨Ù‚Ø§Ù‹:</strong> <span style="font-weight: bold; color: var(--success);"><span class="currency-symbol">${symbol}</span>${item.paidAmount.toLocaleString(locale)}</span></p>`;
        }
        
        // Ø²Ø± Ù„ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ø¯ÙØ¹ Ø§Ù„ØªØ²Ø§Ù… Ø£Ùˆ ØªØ­ØµÙŠÙ„ Ø­Ù‚)
        const actionType = (type === 'rig' ? 'ØªØ­ØµÙŠÙ„ Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©' : 'Ø¯ÙØ¹ Ù‚Ø³Ø· Ø¬Ø¯ÙŠØ¯');
        const actionFunction = (type === 'rig' ? 'openRepaymentModal(\'rig\', ' : 'openRepaymentModal(\'deb\', ');

        html += `<button class="secondary" onclick="${actionFunction}${item.id})"><i class="fas fa-plus-circle" style="margin-left: 5px;"></i> ${actionType}</button>`;
    }
    
    if (type === 'exp' && item.img) {
        html += `<div style="text-align: center; margin-top: 20px;">
                    <img src="${item.img}" style="max-width: 100%; border-radius: 10px; box-shadow: var(--shadow-light);" alt="ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©">
                </div>
                <p style="font-size: 0.8em; color: #999; text-align: center;">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© Ù„ØªÙƒØ¨ÙŠØ±Ù‡Ø§ (ØºÙŠØ± Ù…Ø·Ø¨Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹)</p>`;
    }
    
    html += `</div>`;
    
    html += `<div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="secondary" onclick="openEditModal('${type}', ${id})" style="flex: 1;"><i class="fas fa-edit" style="margin-left: 5px;"></i> ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="action" onclick="deleteTransaction('${type}', ${id})" style="flex: 1; background: var(--danger);"><i class="fas fa-trash-alt" style="margin-left: 5px;"></i> Ø­Ø°Ù</button>
             </div>`;
             
    container.innerHTML = html;
    openLayer('detail');
}

// ** ÙˆØ¸ÙŠÙØ© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¯ÙØ¹/Ø§Ù„ØªØ­ØµÙŠÙ„ (ØºÙŠØ± Ù…Ø·Ø¨Ù‚Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ø§Ù„Ø£ØµÙ„ØŒ ØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡Ø§ Ù‡Ù†Ø§ Ù„Ù„ÙƒÙ…Ø§Ù„) **
function openRepaymentModal(type, id) {
    const item = db[type].find(i => i.id === id);
    if (!item) return toastMsg("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.");

    const actionText = type === 'rig' ? 'ØªØ­ØµÙŠÙ„ Ø¯ÙØ¹Ø© Ø­Ù‚' : 'Ø¯ÙØ¹ Ù‚Ø³Ø· Ø§Ù„ØªØ²Ø§Ù…';
    const descText = type === 'rig' ? 'Ø§Ù„Ù…Ø¯ÙŠÙ†' : 'Ø§Ù„Ø¯Ø§Ø¦Ù†';
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø¹ ØªÙ‡ÙŠØ¦Ø© Ø®Ø§ØµØ©
    closeLayer('detail');
    openBalanceActionModal(type === 'rig' ? 'deposit' : 'withdraw');
    
    document.getElementById('actionModalTitle').innerText = actionText;
    document.getElementById('bDesc').value = `${item.type} - ${item.desc} (${item.id})`;
    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø®Ø§Øµ Ø£Ùˆ ØªØ®ØµÙŠØµ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØŒ ÙˆÙ„ÙƒÙ† Ù„Ù„ØªØ¨Ø³ÙŠØ· Ø³Ù†ÙƒØªÙÙŠ Ø¨Ù…Ù„Ø¡ Ø§Ù„ÙˆØµÙ.
    toastMsg("ØªÙ… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº.");
}

function deleteTransaction(type, id) {
    if (!confirm("ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŸ Ø³ÙŠØªÙ… Ø¹ÙƒØ³ ØªØ£Ø«ÙŠØ±Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯.")) return;

    const item = db[type].find(i => i.id === id);
    if (!item) return toastMsg("Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.");

    const oldBalance = currentBalance;
    const itemIndex = db[type].findIndex(i => i.id === id);
    
    let linkedChangeId = null;

    // 1. Ø¹ÙƒØ³ ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯ (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª)
    if (type === 'exp') {
        currentBalance += item.amount; // Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØµØ±ÙˆÙ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
        linkedChangeId = item.linkedId;
    } 
    
    // 2. Ø¹ÙƒØ³ ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©/Ø§Ù„Ù…Ø­ØµÙ„Ø© (Ø®Ø§Øµ Ø¨Ø§Ù„Ø­Ù‚ÙˆÙ‚ ÙˆØ§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª)
    if ((type === 'rig' || type === 'deb') && item.paidAmount && item.paidAmount > 0) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø­Ù‚Ø§Ù‹ Ù…Ø­ØµÙ„Ø§Ù‹ØŒ Ù†Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº. Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ²Ø§Ù…Ø§Ù‹ Ù…Ø¯ÙÙˆØ¹Ø§Ù‹ØŒ Ù†Ø¶ÙŠÙ Ø§Ù„Ù…Ø¨Ù„Øº.
        const sign = (type === 'rig' ? -1 : 1);
        currentBalance += item.paidAmount * sign;
        linkedChangeId = item.changeId;
    }
    
    // 3. Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ©
    db[type].splice(itemIndex, 1);

    // 4. Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª
    Promise.all([
        deleteData(type, id),
        ...(linkedChangeId ? [deleteBalanceChangeWithoutPrompt(linkedChangeId)] : []) 
    ]).then(() => {
        db.bal.amount = currentBalance;
        return saveData('bal', db.bal);
    }).then(() => {
        updateStats();
        updateBalanceDisplay();
        closeLayer('detail');
        if(LAYERS.log.elementId && document.getElementById(LAYERS.log.elementId).style.display === 'flex') {
             renderLog(); // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØªÙˆØ­Ø§Ù‹
        }
        toastMsg("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­.");
    }).catch(error => {
        // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø­Ø°ÙØŒ Ø£Ø¹Ø¯ Ø§Ù„Ø±ØµÙŠØ¯ Ø¥Ù„Ù‰ Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        currentBalance = oldBalance;
        db.bal.amount = oldBalance;
        db[type].splice(itemIndex, 0, item); // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø³Ø¬Ù„
        toastMsg("ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.");
        console.error(error);
    });
}

function deleteBalanceChangeWithoutPrompt(id) {
    const index = db.bal.changes.findIndex(c => c.id === id);
    if (index === -1) return Promise.resolve(); // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±ØªØ¨Ø·ØŒ Ø£ÙƒÙ…Ù„
    
    const deletedChange = db.bal.changes[index];
    const sign = deletedChange.type === 'deposit' || deletedChange.type === 'right_paid' ? -1 : 1; // Ø¹ÙƒØ³ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
    currentBalance += (deletedChange.amount * sign);

    db.bal.changes.splice(index, 1);
    return Promise.resolve();
}

// ------------------------------------
// ÙˆØ¸Ø§Ø¦Ù ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ©
// ------------------------------------

function initLanguage() {
    const htmlTag = document.documentElement;
    const langToggle = document.getElementById('langToggle');
    const langDisplay = document.getElementById('currentLangDisplay');

    if (currentLang === 'en') {
        htmlTag.setAttribute('lang', 'en');
        htmlTag.setAttribute('dir', 'ltr');
        langToggle.checked = true;
        langDisplay.innerText = "Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¶: Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©";
    } else {
        htmlTag.setAttribute('lang', 'ar');
        htmlTag.setAttribute('dir', 'rtl');
        langToggle.checked = false;
        langDisplay.innerText = "Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¶: Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©";
    }
}

function toggleLanguage() {
    currentLang = currentLang === 'ar' ? 'en' : 'ar';
    localStorage.setItem('appLang', currentLang);
    initLanguage(); // ØªØ­Ø¯ÙŠØ« Ø®ØµØ§Ø¦Øµ HTML ÙˆØ§Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
    updateBalanceDisplay(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶
    updateStats(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯
    // ÙŠØªÙ… ØªØ±Ùƒ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØµÙˆØµ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù„Ø£Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù… ÙŠÙØ¹ÙØ±Ù‘ÙØ¨ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
    toastMsg(`ØªÙ… ØªØºÙŠÙŠØ± Ø±Ù…Ø² Ø§Ù„Ø¹Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!`); 
}

// ------------------------------------
// ÙˆØ¸Ø§Ø¦Ù Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø©
// ------------------------------------

function openCurrencyModal() {
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
    closeLayer('sidebar');
    // ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Øª
    renderCurrencyList();
    openLayer('currency');
}

function renderCurrencyList() {
    const container = document.getElementById('currencyList');
    const searchVal = document.getElementById('currencySearch').value.toLowerCase();
    
    const filteredCurrencies = ARABIC_CURRENCIES.filter(c => 
        c.name_ar.toLowerCase().includes(searchVal) || c.name_en.toLowerCase().includes(searchVal) || c.code.toLowerCase().includes(searchVal)
    );
    
    let html = '<div style="margin-top: 10px;">';
    filteredCurrencies.forEach(c => {
        const isActive = c.code === currentCurrency.code;
        // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù…Ø² Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù„Ù„Ø¹Ø±Ø¶ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø© (Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)
        const displaySymbol = c.symbol_ar; 
        const displayName = c.name_ar;
        html += `
            <div class="list-item" onclick="setCurrency('${c.code}')" style="border-right: 5px solid ${isActive ? 'var(--p)' : 'var(--border-color)'};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: bold; font-size: 1.1em; color: var(--text-dark);">
                        ${displayName} (${displaySymbol})
                    </span>
                    ${isActive ? '<i class="fas fa-check-circle" style="color: var(--success);"></i>' : ''}
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function setCurrency(code) {
    currentCurrency = ARABIC_CURRENCIES.find(c => c.code === code);
    localStorage.setItem('currencyCode', code);
    updateBalanceDisplay();
    updateStats(); 
    closeLayer('currency');
    
    const toastSymbol = getCurrencySymbol(currentCurrency); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù…Ø² Ø§Ù„ØµØ­ÙŠØ­ ÙÙŠ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙˆØ³Øª
    const toastName = currentCurrency.name_ar; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ ÙÙŠ Ø§Ù„ØªÙˆØ³Øª
    toastMsg(`ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù…Ù„Ø© Ø¥Ù„Ù‰ ${toastName} (${toastSymbol})`);
}

// ------------------------------------
// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø®Ù„ÙÙŠ
// ------------------------------------

window.onload = () => {
    initLanguage(); // ØªØ´ØºÙŠÙ„ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„ØºØ©
    updateBalanceDisplay(); 
    const now = new Date().toISOString().slice(0, 16);
    document.getElementById('eDate').value = now;
    document.getElementById('rDate').value = now;
    document.getElementById('dDate').value = now;

    // ØªÙ‡ÙŠØ¦Ø© IndexedDB
    initDB().then(() => {
        // ØªÙ‡ÙŠØ¦Ø© Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†ÙˆØ¹ (EXP_TYPES, RIG_TYPES, DEB_TYPES)
        const eTypeSelect = document.getElementById('eType');
        eTypeSelect.innerHTML = `<option value="">ğŸ›’ Ø§Ù„ÙØ¦Ø© (Ù†ÙÙ‚Ø§Øª Ù…ØªØºÙŠØ±Ø©)</option>` + EXP_TYPES.map(t => `<option>${t}</option>`).join('');
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            document.getElementById('darkModeToggle').checked = true;
        }

    });
};

window.onpopstate = () => {
    if (historyStack.length > 0) {
        const topLayerName = historyStack[historyStack.length - 1];
        closeLayer(topLayerName);
    }
};

// ... Ø¨Ù‚ÙŠØ© Ø§Ù„ÙˆØ¸Ø§Ø¦Ù (ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§ØªØŒ Ø§Ù„ØµÙˆØ±ØŒ Ø§Ù„ØªØµØ¯ÙŠØ±ØŒ Ø¥Ù„Ø®) Ù„Ù… ÙŠØªÙ… ØªØ¶Ù…ÙŠÙ†Ù‡Ø§ Ù‡Ù†Ø§ Ù„Ù„Ø§Ø®ØªØµØ§Ø± ÙˆÙ„ÙƒÙ†Ù‡Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù…Ù„ÙÙƒ Ø§Ù„Ø£ØµÙ„ÙŠ.
// Ù„Ø§Ø­Ø¸ Ø£Ù† Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ù‡Ù…Ø© Ù…Ø«Ù„ openEditModal Ùˆ updateTransaction Ùˆ exportData ÙˆØºÙŠØ±Ù‡Ø§ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ Ù„Ù€ getCurrencySymbol Ùˆ getCurrencyName Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØªØ¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø©.
// ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (updateBalanceDisplay, updateStats, renderCurrencyList, setCurrency) ÙÙ‚Ø· ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙƒØ§Ù…Ù„.
</script>
</body>
</html>
