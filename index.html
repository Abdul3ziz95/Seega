<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ© | Smart Budget</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">

<style>
/* ---------------------------------------------------- */
/* Variables and Base Styling - LIGHT MODE (Default) */
/* ---------------------------------------------------- */
:root{
    --p: #0077b6; /* Primary Blue (Vibrant) */
    --s: #48cae4; /* Secondary Light Blue */
    --bg: #f7f9fc; /* Light Background */
    --danger: #ef476f; 
    --success: #2a9d8f;
    --warning: #fbc02d;
    --text-dark: #333;
    --text-light: #f7f9fc;
    --shadow-light: 0 4px 8px rgba(0, 0, 0, 0.08);
    --shadow-hover: 0 6px 15px rgba(0, 0, 0, 0.15);
    --card-bg: #fff;
    --input-bg: #fff;
    --border-color: #ddd;
    --tab-active-bg: #fff;
}

/* ---------------------------------------------------- */
/* Dark Mode Variables */
/* ---------------------------------------------------- */
body.dark-mode {
    --p: #90e0ef; /* Lighter Primary Blue for contrast */
    --s: #48cae4; 
    --bg: #1f1f1f; /* Dark Background */
    --danger: #ff8a80;
    --success: #66bb6a;
    --warning: #fbc02d;
    --text-dark: #e0e0e0; /* Light Text */
    --text-light: #1f1f1f;
    --shadow-light: 0 4px 10px rgba(0, 0, 0, 0.5);
    --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.8);
    --card-bg: #2d2d2d;
    --input-bg: #3c3c3c;
    --border-color: #555;
    --tab-active-bg: #2d2d2d;
}

/* ---------------------------------------------------- */
/* Global Reset and Base Styling */
/* ---------------------------------------------------- */
* {
    box-sizing: border-box;
}
body{
    margin:0;
    font-family: 'Tajawal', 'Arial', sans-serif;
    background: var(--bg);
    color: var(--text-dark);
    overflow-x: hidden;
    line-height: 1.6;
    transition: background 0.3s, color 0.3s;
}

/* Global Dark Mode Overrides for Specific Elements */
.card, .sidebar, .modal { background: var(--card-bg); }
.modal header { background: var(--card-bg); border-bottom: 1px solid var(--border-color); }

/* ---------------------------------------------------- */
/* Header & Navigation */
/* ---------------------------------------------------- */
header{
    background: var(--p);
    color: var(--text-light);
    padding: 15px;
    font-size: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-hover);
    position: sticky;
    top: 0;
    z-index: 10;
}
header .title { flex-grow: 1; text-align: center; font-weight: 800; }
header button {
    background: none; 
    border: none; 
    color: var(--text-light); 
    font-size: 20px; 
    cursor: pointer; 
    padding: 0 10px;
    transition: transform 0.2s;
}
header button:hover { transform: scale(1.1); }

.tabs{
    display:flex;
    background: var(--card-bg);
    border-bottom: 2px solid var(--border-color);
    box-shadow: var(--shadow-light);
    overflow-x: auto; 
    white-space: nowrap;
}
.tabs button{
    flex: 1 1 auto; 
    min-width: 0; 
    padding: 15px 10px;
    border:none;
    background: var(--card-bg);
    color: var(--text-dark);
    font-weight: 700;
    font-size: 14px;
    transition: all 0.3s;
    border-bottom: 3px solid transparent;
}
.tabs button.active{
    color: var(--p);
    border-bottom: 3px solid var(--p);
    background: color-mix(in srgb, var(--bg) 90%, var(--p)); 
}
body.dark-mode .tabs button.active {
    background: color-mix(in srgb, var(--bg) 85%, var(--p)); 
}

/* ---------------------------------------------------- */
/* General Layout & Cards */
/* ---------------------------------------------------- */
.section{ display:none; padding: 15px; }
.section.active{ display:block; }
.card{
    background:var(--card-bg);
    padding: 20px;
    border-radius: 15px;
    box-shadow: var(--shadow-light);
    margin-bottom: 15px;
    border-top: 5px solid var(--s); 
    transition: background 0.3s, border-color 0.3s;
}

/* ---------------------------------------------------- */
/* Overview Section Styling (New Dashboard) */
/* ---------------------------------------------------- */
#overview .balance-display {
    text-align: center;
    padding: 30px 20px;
    margin-bottom: 20px;
    border-radius: 15px;
    background: var(--card-bg);
    box-shadow: var(--shadow-hover);
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    align-items: center;
}
#overview .balance-display h2 {
    margin: 0 0 5px 0;
    font-size: 18px;
    color: #999;
}
#overview .balance-display p {
    font-size: 38px;
    font-weight: 800;
    margin: 5px 0 0 0;
    color: var(--p);
    display: flex;
    align-items: center;
}
#overview .balance-display button {
    background: none;
    border: none;
    color: var(--p);
    font-size: 24px;
    cursor: pointer;
    margin-right: 10px;
    transition: color 0.2s;
}
#overview .balance-display button:hover {
    color: var(--s);
}
#overview .balance-actions {
    display: flex;
    gap: 15px;
    margin-top: 10px;
}
#overview .balance-actions .action {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    color: var(--text-dark);
    border-radius: 10px;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-light);
    transition: all 0.2s;
    background: var(--input-bg);
}
#overview .balance-actions .action:hover {
    box-shadow: var(--shadow-hover);
    transform: translateY(-2px);
    border-color: var(--p);
}
#overview .balance-actions .action i {
    font-size: 24px;
    margin-bottom: 5px;
}
#overview .balance-actions .deposit i { color: var(--success); }
#overview .balance-actions .withdraw i { color: var(--danger); }

/* ---------------------------------------------------- */
/* Form Elements & Inputs */
/* ---------------------------------------------------- */
input, select, .datetime-container input[type="datetime-local"] {
    width: 100%;
    padding: 14px;
    margin: 8px 0;
    font-size: 16px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    box-sizing: border-box;
    background: var(--input-bg);
    color: var(--text-dark);
    transition: all 0.3s;
}
input:focus, select:focus, .datetime-container input[type="datetime-local"]:focus {
    border-color: var(--s);
    box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.2);
    outline: none;
}
body.dark-mode input:focus, body.dark-mode select:focus, body.dark-mode .datetime-container input[type="datetime-local"]:focus {
    box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.3);
}

.datetime-container { position: relative; width: 100%; margin: 8px 0; }
.datetime-container input[type="datetime-local"] { margin: 0; padding-left: 40px; }

.calendar-icon {
    position: absolute;
    top: 50%;
    left: 15px; 
    transform: translateY(-50%);
    font-size: 1.4em;
    z-index: 2;
    pointer-events: none; 
    color: var(--p); 
}

/* ---------------------------------------------------- */
/* Buttons & Actions */
/* ---------------------------------------------------- */
button.action{
    background: var(--p);
    color: var(--text-light);
    border: none;
    padding: 16px;
    width: 100%;
    border-radius: 10px;
    font-size: 18px;
    font-weight: bold;
    margin-top: 10px;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
    box-shadow: var(--shadow-light);
}
button.action:hover{
    background: color-mix(in srgb, var(--p) 85%, black); 
    transform: translateY(-2px);
}
button.action:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
}
button.action.danger-btn {
    background: var(--danger);
}
button.action.danger-btn:hover {
    background: color-mix(in srgb, var(--danger) 85%, black);
}


button.secondary{
    background: var(--input-bg);
    color: var(--text-dark);
    padding: 12px;
    width: 100%;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    margin-top: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s;
}
button.secondary:hover {
    background: color-mix(in srgb, var(--input-bg) 80%, #999); 
}

/* ---------------------------------------------------- */
/* Utility & Custom Elements */
/* ---------------------------------------------------- */
.toast{
    position:fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: var(--text-light);
    padding: 12px 25px;
    border-radius: 30px;
    display:none;
    z-index: 100;
    font-size: 15px;
    box-shadow: var(--shadow-hover);
    white-space: nowrap;
}

.currency-symbol { color: inherit; font-weight: bold; font-size: 1em; margin-right: 5px; }
.hidden-balance { font-size: 38px; font-weight: 800; letter-spacing: 5px; color: var(--p); }

/* ---------------------------------------------------- */
/* Modals and Sidebar Refinements */
/* ---------------------------------------------------- */
.modal{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background: var(--bg);
    display:none;
    flex-direction:column;
    z-index: 30;
    overflow-y: auto;
}
.modal header{
    display:flex;
    gap: 10px;
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    background: var(--card-bg);
    align-items: center;
    box-shadow: var(--shadow-light);
    position: sticky;
    top: 0;
    z-index: 35;
}
.modal header .title { flex-grow: 1; text-align: center; font-weight: 700; }
.modal header button {
    background: none; 
    border: none; 
    color: var(--text-dark); 
    font-size: 20px; 
    cursor: pointer; 
    padding: 0 10px;
}
.modal-content {
    flex-grow: 1;
    padding: 15px;
}

.sidebar {
    position: fixed;
    top: 0;
    right: 0; 
    width: 300px; 
    max-width: 85%;
    height: 100%;
    background: var(--card-bg);
    box-shadow: -4px 0 12px rgba(0, 0, 0, 0.2);
    transform: translateX(100%); 
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
    z-index: 25; 
    display: flex;
    flex-direction: column;
}
.sidebar.open { transform: translateX(0); }

/* Switch Style (Dark Mode) */
.switch-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    font-size: 17px;
    color: var(--text-dark);
}
/* ... (ÙƒÙˆØ¯ Ø§Ù„Ù€ switch Ù„Ù… ÙŠØªØºÙŠØ±) ... */
.switch { position: relative; display: inline-block; width: 45px; height: 25px; }
.switch input {opacity: 0; width: 0; height: 0;}
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: var(--border-color); transition: .4s; border-radius: 25px;
}
.slider:before {
    position: absolute; content: ""; height: 19px; width: 19px; left: 3px; bottom: 3px;
    background-color: white; transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: var(--p); }
input:checked + .slider:before { transform: translateX(20px); }


/* Sidebar */
.sidebar-header {
    padding: 15px;
    background: var(--p);
    color: var(--text-light);
    font-size: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
}
.sidebar-content {
    flex-grow: 1;
    padding: 15px 0;
    overflow-y: auto;
}

.sidebar-menu-item {
    padding: 15px 20px;
    margin: 5px 0;
    display: flex;
    align-items: center;
    justify-content: space-between; 
    gap: 15px;
    font-size: 17px;
    color: var(--text-dark);
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
}

.sidebar-menu-item:hover {
    background: var(--s);
    color: var(--text-dark); 
}
.sidebar-menu-item i { font-size: 1.2em; }

.sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    z-index: 24;
}
.sidebar-overlay.open { display: block; }

/* Small Image Source Modal */
#imageSourceModal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80%;
    max-width: 350px;
    height: auto;
    background: var(--card-bg);
    border-radius: 15px;
    box-shadow: var(--shadow-hover);
    padding: 20px;
    z-index: 150;
    display: none;
    flex-direction: column;
    align-items: center;
}
#imageSourceModal h3 {
    margin-top: 0;
    color: var(--p);
    text-align: center;
}
#imageSourceModal button {
    margin: 10px 0;
    padding: 15px;
    font-size: 16px;
    border-radius: 10px;
    width: 100%;
}

/* Toast Animation */
.toast.show{
    display:block;
    animation: fadeInOut 2.5s ease-in-out forwards;
}

@keyframes fadeInOut {
    0% { opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { opacity: 0; }
}

/* List Item */
.list-item{
    background: var(--card-bg);
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    border-right: 5px solid var(--s); 
    color: var(--text-dark);
}
.list-item:hover {
    background: color-mix(in srgb, var(--card-bg) 95%, #999);
    box-shadow: var(--shadow-light);
}
.list-item .details {
    font-size: 0.9em; 
    color: #666; 
    text-align: right;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 5px;
}

/* ---------------------------------------------------- */
/* Responsive Fix for Tabs (Small Screens) */
/* ---------------------------------------------------- */
@media (max-width: 450px) {
    .tabs button {
        padding: 15px 5px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø´ÙˆØ© Ø§Ù„Ø£ÙÙ‚ÙŠØ© */
        font-size: 13px; /* ØªØµØºÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø®Ø· Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø­ØªÙˆØ§Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø±Ø¨Ø¹Ø© */
    }
}
</style>
</head>

<body>

<header>
    <button onclick="openSidebar()"><i class="fas fa-bars"></i></button> 
    <span class="title">Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</span>
    <button style="visibility: hidden;"><i class="fas fa-search"></i></button> 
</header>

<div class="tabs">
    <button class="active" onclick="openTab('overview')">
        <i class="fas fa-tachometer-alt" style="margin-left: 5px;"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©
    </button>
    <button onclick="openTab('expenses')">
        <i class="fas fa-money-bill-wave" style="margin-left: 5px;"></i> Ù…ØµØ±ÙˆÙØ§Øª
    </button>
    <button onclick="openTab('rights')">
        <i class="fas fa-handshake" style="margin-left: 5px;"></i> Ø­Ù‚ÙˆÙ‚
    </button>
    <button onclick="openTab('debts')">
        <i class="fas fa-file-invoice" style="margin-left: 5px;"></i> Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    </button>
</div>

<div id="overview" class="section active">
    <div class="balance-display">
        <h2>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
        <p id="currentBalanceDisplay">
            <i class="fas fa-spinner fa-spin"></i>
        </p>
        <button onclick="toggleBalanceVisibility()" id="balanceVisibilityToggle" title="Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±ØµÙŠØ¯">
             <i class="fas fa-eye"></i>
        </button>
    </div>

    <div class="balance-actions">
        <button class="action deposit" onclick="openBalanceActionModal('deposit')">
            <i class="fas fa-plus-circle"></i> Ø¥ÙŠØ¯Ø§Ø¹
        </button>
        <button class="action withdraw" onclick="openBalanceActionModal('withdraw')">
            <i class="fas fa-minus-circle"></i> Ø³Ø­Ø¨
        </button>
    </div>
    
    <button class="secondary" onclick="openBalanceLogModal()" style="margin-top: 15px;">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯
    </button>
    
    <div class="card" style="margin-top: 20px; border-top: 5px solid var(--p);">
        <h3 style="color: var(--p); margin-top: 0;"><i class="fas fa-calculator" style="margin-left: 5px;"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
        <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</span> <b id="sExpTotal">0</b></p>
        <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©:</span> <b id="sRigTotal">0</b></p>
        <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©:</span> <b id="sDebTotal">0</b></p>
        <p><span>Ø§Ù„Ù…Ø­ØµÙ„ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ‚:</span> <b id="sRigPaid">0</b></p>
        <p><span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª:</span> <b id="sDebPaid">0</b></p>
    </div>
    
    </div>

<div id="expenses" class="section">
    <div class="card">
        <p style="color: var(--danger); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡Ø§ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙˆØ±Ø§Ù‹</p>
        <input id="eAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
        <select id="eType">
        <option value="">ğŸ›’ Ø§Ù„ÙØ¦Ø© (Ù†ÙÙ‚Ø§Øª Ù…ØªØºÙŠØ±Ø©)</option>
        <option>Ø·Ø¹Ø§Ù…</option><option>Ù…ÙˆØ§ØµÙ„Ø§Øª</option>
        <option>Ø±Ø¹Ø§ÙŠØ© Ø´Ø®ØµÙŠØ©</option><option>Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
        <option>ØµØ­Ø©</option><option>ØªØ±ÙÙŠÙ‡</option><option>ØªØ³ÙˆÙ‚</option>
        <option>ØªØ¹Ù„ÙŠÙ…</option><option>ØµÙŠØ§Ù†Ø© ÙˆØ¥ØµÙ„Ø§Ø­</option><option>Ø£Ø®Ø±Ù‰</option>
        </select>
        <input id="eDesc" placeholder="ğŸ“ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
        <div class="datetime-container">
            <input id="eDate" type="datetime-local">
            <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
        </div>
        
        <button class="secondary" onclick="showImageSourceModal()">
            <i class="fas fa-camera" style="margin-left: 5px;"></i> Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        </button>
        <span id="eImgName" style="display: block; font-size: 0.8em; color: var(--success); text-align: right; margin-top: 5px;"></span>
        <input type="file" id="eImgCamera" accept="image/*" capture="camera" style="display: none;" onchange="updateFileName(this, 'eImgName')">
        <input type="file" id="eImgGallery" accept="image/*" style="display: none;" onchange="updateFileName(this, 'eImgName')">
        
        <button class="action" id="eSaveBtn" onclick="addExpense(this)">
            <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ
        </button>
    </div>
    
    <div class="card" id="expenseTotals" style="margin-top: 15px; border-top: 5px solid var(--danger); display: none;">
        <h3 style="color: var(--danger); margin-top: 0;"><i class="fas fa-chart-line" style="margin-left: 5px;"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)</h3>
        <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</span> <b id="expTotalDisplay">0</b></p>
    </div>
    
    <button class="secondary" onclick="openLog('exp')">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
    </button>
</div>

<div id="rights" class="section">
    <div class="card">
        <p style="color: var(--success); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„Ø© (Ø¯ÙØ¹ Ø§Ù„Ø¯ÙŠÙ†/Ø§Ù„Ø¢Ø¬Ù„) ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
        <select id="rType" onchange="updateRightFields(this.value)">
        <option value="">ğŸ¤ Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚</option>
        <option>Ø¯ÙŠÙ†</option>
        <option>Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„</option>
        <option>Ø£Ø®Ø±Ù‰</option>
        </select>
        <input id="rAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚ (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ)" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
        <div id="rDynamicFields"></div>
        <input id="rDesc" placeholder="ğŸ‘¤ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ù„Ù…Ø¯ÙŠÙ†/Ø§Ù„Ø¬Ù‡Ø©)">
        <div class="datetime-container">
            <input id="rDate" type="datetime-local">
            <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
        </div>
        <select id="rStatus">
        <option value="">âœ… Ø§Ù„Ø­Ø§Ù„Ø©</option>
        <option value="ÙƒØ§Ù…Ù„">Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</option>
        <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ Ø¨Ø¹Ø¯</option>
        </select>
        <button class="action" id="rSaveBtn" onclick="addRight(this)">
            <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ø­Ù‚
        </button>
    </div>

    <div class="card" id="rightsTotals" style="margin-top: 15px; border-top: 5px solid var(--success); display: none;">
        <h3 style="color: var(--success); margin-top: 0;"><i class="fas fa-chart-bar" style="margin-left: 5px;"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ù‚ÙˆÙ‚ (Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)</h3>
        <p><span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚:</span> <b id="rigTotalDisplay">0</b></p>
        <p style="color: var(--success);"><span>Ø§Ù„Ù…Ø­ØµÙ„ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ‚:</span> <b id="rigCollectedDisplay">0</b></p>
        <p style="color: var(--danger);"><span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ØºÙŠØ± Ø§Ù„Ù…Ø­ØµÙ„:</span> <b id="rigPendingDisplay">0</b></p>
    </div>
    
    <button class="secondary" onclick="openLog('rig')">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ‚
    </button>
</div>

<div id="debts" class="section">
    <div class="card">
        <p style="color: var(--danger); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø¯ÙØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
        <select id="dType" onchange="updateDebtFields(this.value)">
        <option value="">ğŸ§¾ Ù†ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</option>
        <option>Ø¥ÙŠØ¬Ø§Ø±</option>
        <option>ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
        <option>Ù…Ø§Ø¡</option>
        <option>Ø¥Ù†ØªØ±Ù†Øª</option>
        <option>Ù‚Ø±Ø¶</option> <option>Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ</option> <option>Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø© Ø£Ø®Ø±Ù‰</option>
        <option>Ø£Ø®Ø±Ù‰</option>
        </select>
        <input id="dAmount" type="text" placeholder="ğŸ’µ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©/Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">

        <div id="dDynamicFields"></div>
        <input id="dDesc" placeholder="ğŸ¢ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ù„Ø¯Ø§Ø¦Ù†/Ø§Ù„Ø¬Ù‡Ø©)">
        <div class="datetime-container">
            <input id="dDate" type="datetime-local">
            <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
        </div>
        <select id="dStatus">
        <option value="">âœ… Ø§Ù„Ø­Ø§Ù„Ø©</option>
        <option value="Ù…Ø¯ÙÙˆØ¹">Ù…Ø¯ÙÙˆØ¹</option>
        <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
        </select>
        <button class="action" id="dSaveBtn" onclick="addDebt(this)">
            <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…
        </button>
    </div>

    <div class="card" id="debtsTotals" style="margin-top: 15px; border-top: 5px solid var(--danger); display: none;">
        <h3 style="color: var(--danger); margin-top: 0;"><i class="fas fa-credit-card" style="margin-left: 5px;"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª (Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)</h3>
        <p><span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª:</span> <b id="debTotalDisplay">0</b></p>
        <p style="color: var(--success);"><span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª:</span> <b id="debPaidDisplay">0</b></p>
        <p style="color: var(--danger);"><span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ØºÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span> <b id="debPendingDisplay">0</b></p>
    </div>
    
    <button class="secondary" onclick="openLog('deb')">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    </button>
</div>

<div class="modal" id="logModal">
    <header>
        <input id="search" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„..." oninput="renderLog()">
        <button onclick="closeLayer('log')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content" id="logContent"></div>
</div>

<div class="modal" id="detailModal">
    <header>
        <span class="title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</span>
        <button onclick="closeLayer('detail')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content detail" id="detailContent"></div>
</div>

<div class="modal" id="editModal">
    <header>
        <span class="title" id="editModalTitle">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</span>
        <button onclick="closeLayer('edit')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content" id="editModalContent">
        </div>
</div>

<div class="modal" id="balanceActionModal">
    <header>
        <span class="title" id="actionModalTitle"></span>
        <button onclick="closeLayer('balanceAction')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <p style="text-align: center; font-size: 1.1em;">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="currentBalanceInAction" style="color: var(--p); font-weight: bold;"></span></p>
        <input id="bAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
        <input id="bDesc" placeholder="ğŸ“ ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Ù…Ø«Ù„: Ø±Ø§ØªØ¨ØŒ ØªØ­ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ)">
        <div class="datetime-container">
            <input id="bDate" type="datetime-local">
            <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
        </div>
        <button class="action" id="bSaveBtn" onclick="processBalanceAction(this)">
            <i class="fas fa-check" style="margin-left: 5px;"></i> ØªÙ†ÙÙŠØ°
        </button>
    </div>
</div>

<div class="modal" id="balanceLogModal">
    <header>
        <span class="title">Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯</span>
        <button onclick="closeLayer('balanceLog')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content" id="balanceLogContent">
        </div>
</div>

<div id="imageSourceModal">
    <h3 style="margin-bottom: 20px;">Ø§Ø®ØªÙŠØ§Ø± Ù…ØµØ¯Ø± Ø§Ù„ØµÙˆØ±Ø©</h3>
    <button class="action" onclick="openCameraInput()"><i class="fas fa-camera" style="margin-left: 10px;"></i> Ø§Ù„ØªÙ‚Ø§Ø· Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
    <button class="secondary" onclick="openGalleryInput()"><i class="fas fa-images" style="margin-left: 10px;"></i> Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ø¶</button>
    <button class="secondary" style="background: none; border: none; color: var(--danger); margin-top: 10px;" onclick="closeLayer('imageSource')">Ø¥Ù„ØºØ§Ø¡</button>
</div>
<div class="sidebar-overlay" id="imageSourceOverlay" style="z-index: 140; display: none;" onclick="closeLayer('imageSource')"></div>

<div class="toast" id="toast"></div>

<div class="sidebar-overlay" onclick="closeLayer('sidebar')"></div>

<div class="sidebar" id="appSidebar">
    <div class="sidebar-header">
        <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        <button onclick="closeLayer('sidebar')"><i class="fas fa-times"></i></button>
    </div>
    <div class="sidebar-content">
        <div class="card" style="margin: 0 15px 15px; border-top: 5px solid var(--s);">
             <p style="font-weight: bold; margin-top: 0; color: var(--p);">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</p>
             
             <div class="switch-container">
                 <i class="fas fa-moon" style="margin-left: 10px;"></i> <span>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span>
                 <label class="switch">
                     <input type="checkbox" id="darkModeToggle" onclick="toggleDarkMode()">
                     <span class="slider"></span>
                 </label>
             </div>
             
             <button class="secondary" onclick="openCurrencyModal()" style="display: flex; justify-content: space-between; align-items: center; border: none; background: var(--card-bg); margin-top: 15px;">
                 <span id="currentCurrencyDisplay" style="font-weight: bold;">Ø§Ù„Ø¹Ù…Ù„Ø©: Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ (Ø±.Ø³)</span>
                 <span style="color: var(--p);"><i class="fas fa-exchange-alt"></i> ØªØºÙŠÙŠØ±</span>
             </button>
        </div>
        
        <div class="sidebar-menu-item" onclick="exportData()">
            <i class="fas fa-file-export"></i> <span>ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</span>
        </div>
        
        <div class="sidebar-menu-item" onclick="document.getElementById('importFile').click()">
            <i class="fas fa-file-import"></i> <span>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</span>
        </div>
        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
        
        <div class="sidebar-menu-item" onclick="openAboutModal()">
            <i class="fas fa-info-circle"></i> <span>Ø­ÙˆÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>
        </div>
        
        <div class="sidebar-menu-item" onclick="confirmResetData()" style="color: var(--danger);">
            <i class="fas fa-exclamation-triangle"></i> <span>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        </div>
    </div>
</div>

<div class="modal" id="aboutModal">
    <header>
        <h3 style="color: var(--p);">Ø­ÙˆÙ„ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ©</h3>
        <button onclick="closeLayer('about')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <p>ØªØ·Ø¨ÙŠÙ‚ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© Ù‡Ùˆ Ø£Ø¯Ø§Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ ØªØªØ¨Ø¹:</p>
        <ul>
            <li><i class="fas fa-wallet" style="color: var(--s);"></i> **Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø©** Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.</li>
            <li><i class="fas fa-receipt" style="color: var(--s);"></i> **Ø§Ù„Ø­Ù‚ÙˆÙ‚** Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ù„Ùƒ (Ø¯ÙŠÙˆÙ†ØŒ Ø¨ÙŠØ¹ Ø¢Ø¬Ù„).</li>
            <li><i class="fas fa-clipboard-list" style="color: var(--s);"></i> **Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª** Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ø¹Ù„ÙŠÙƒ (ÙÙˆØ§ØªÙŠØ±ØŒ Ø£Ù‚Ø³Ø§Ø·ØŒ Ù‚Ø±ÙˆØ¶).</li>
        </ul>
        <p class="card" style="border-top: 3px solid var(--danger);">
            <strong>Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©:</strong> ÙŠØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ© IndexedDBØŒ ÙˆÙ„Ø§ ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ø£ÙŠ Ø®Ø§Ø¯Ù… Ø®Ø§Ø±Ø¬ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ.
        </p>
        <p style="text-align: center; margin-top: 20px; color: #999; font-size: 0.9em;">Ø§Ù„Ø¥ØµØ¯Ø§Ø± 3.3 (Ù…Ø«Ø¨Øª)</p>
    </div>
</div>

<div class="modal" id="currencyModal">
    <header>
        <h3 style="color: var(--p);">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø©</h3>
        <button onclick="closeLayer('currency')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <input id="currencySearch" type="text" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„Ø© (Ø±ÙŠØ§Ù„ØŒ Ø¬Ù†ÙŠÙ‡ØŒ Ø¯ÙˆÙ„Ø§Ø±...)" oninput="renderCurrencyList()">
        <div id="currencyList">
            </div>
    </div>
</div>

<script>
// ===================================================
// 1. Ø¥Ø¹Ø¯Ø§Ø¯ IndexedDB ÙˆÙ…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Øª
// ===================================================

const IDB_NAME = "MySmartBudgetDB";
const IDB_VERSION = 6; // ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø®Ø© Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ±Ù‚ÙŠØ© ØºÙŠØ± Ø§Ù„ØªØ¯Ù…ÙŠØ±ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯
const STORE_NAMES = ["exp", "rig", "deb", "bal"]; 
const MAX_BAL_CHANGES = 200; // ØªÙ‚ÙŠÙŠØ¯ Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¨Ø·Ø¡

// Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© (Cache)
let db = { exp: [], rig: [], deb: [], bal: { clientId: 1, amount: 0, changes: [] } }; 
let IDB_connection = null; 

let currentLog = "", editMode = null, balanceActionType = null; 
let currentBalance = 0;
let balanceHidden = localStorage.getItem('balanceHidden') === 'true'; 

// Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ù‚Ù„ (ØªÙ… ØªØµØ­ÙŠØ­Ù‡Ø§)
const LAYERS = { 
    'sidebar': { elementId: 'appSidebar', type: 'menu' }, 
    'log': { elementId: 'logModal', type: 'modal' }, 
    'detail': { elementId: 'detailModal', type: 'modal' }, 
    'edit': { elementId: 'editModal', type: 'modal' }, 
    'currency': { elementId: 'currencyModal', type: 'modal' }, 
    'about': { elementId: 'aboutModal', type: 'modal' }, 
    'balanceAction': { elementId: 'balanceActionModal', type: 'modal' }, 
    'balanceLog': { elementId: 'balanceLogModal', type: 'modal' }, 
    'imageSource': { elementId: 'imageSourceModal', type: 'small_modal' } 
}; 
let historyStack = []; // ØªÙ… Ø§Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„ÙŠÙ‡Ø§ ÙˆÙ„ÙƒÙ† ÙŠØ¬Ø¨ ØªØ·ÙˆÙŠØ± Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§

const ARABIC_CURRENCIES = [
    { code: 'SAR', symbol: 'Ø±.Ø³', name: 'Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ' },
    { code: 'EGP', symbol: 'Ø¬.Ù…', name: 'Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ' },
    { code: 'AED', symbol: 'Ø¯.Ø¥', name: 'Ø¯Ø±Ù‡Ù… Ø¥Ù…Ø§Ø±Ø§ØªÙŠ' },
    { code: 'KWD', symbol: 'Ø¯.Ùƒ', name: 'Ø¯ÙŠÙ†Ø§Ø± ÙƒÙˆÙŠØªÙŠ' },
    { code: 'USD', symbol: '$', name: 'Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ' },
    { code: 'QAR', symbol: 'Ø±.Ù‚', name: 'Ø±ÙŠØ§Ù„ Ù‚Ø·Ø±ÙŠ' },
    { code: 'OMR', symbol: 'Ø±.Ø¹.', name: 'Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ' },
    { code: 'JOD', symbol: 'Ø¯.Ø§', name: 'Ø¯ÙŠÙ†Ø§Ø± Ø£Ø±Ø¯Ù†ÙŠ' },
    { code: 'EUR', symbol: 'â‚¬', name: 'ÙŠÙˆØ±Ùˆ' },
];
let currentCurrency = ARABIC_CURRENCIES.find(c => c.code === (localStorage.getItem('currencyCode') || 'SAR'));

// ===================================================
// 2. ÙˆØ¸Ø§Ø¦Ù IndexedDB Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­)
// ===================================================

/**
 * ÙŠÙØªØ­ Ø§ØªØµØ§Ù„ IndexedDB ÙˆÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„ØªØ±Ù‚ÙŠØ© ØºÙŠØ± Ø§Ù„ØªØ¯Ù…ÙŠØ±ÙŠØ©.
 * (ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø©: Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Object Stores ÙÙŠ ÙƒÙ„ ØªØ±Ù‚ÙŠØ©)
 */
async function openDB() {
    return new Promise((resolve, reject) => {
        if (!window.indexedDB) {
            toastMsg("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… IndexedDB. Ù„Ù† ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
            return reject(new Error("IndexedDB not supported."));
        }
        const request = indexedDB.open(IDB_NAME, IDB_VERSION);

        request.onerror = (e) => {
            console.error("IndexedDB error:", e.target.error);
            reject(e.target.error);
        };

        request.onupgradeneeded = (e) => {
            const db_v = e.target.result;
            
            // 1. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø®Ø§Ø²Ù† ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø© (ØªØ±Ù‚ÙŠØ© ØºÙŠØ± ØªØ¯Ù…ÙŠØ±ÙŠØ©)
            // Ù…Ø®Ø§Ø²Ù† Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª (ØªØ³ØªØ®Ø¯Ù… keyPath: 'id' Ùˆ autoIncrement: true)
            ['exp', 'rig', 'deb'].forEach(storeName => {
                if (!db_v.objectStoreNames.contains(storeName)) {
                    db_v.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
                }
            });
            
            // 2. Ù…Ø®Ø²Ù† Ø§Ù„Ø±ØµÙŠØ¯ (ÙŠØ³ØªØ®Ø¯Ù… keyPath: 'clientId' ÙˆØ¨Ø¯ÙˆÙ† autoIncrement)
            if (!db_v.objectStoreNames.contains('bal')) {
                 const balStore = db_v.createObjectStore('bal', { keyPath: 'clientId' }); 
                 // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ Ù„Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯Ù‡
                 balStore.add({ clientId: 1, amount: 0, changes: [] });
            }

            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ùˆ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ ØªØ±Ù‚ÙŠØ© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹Ù‚Ø¯Ø© (Migration)ØŒ ÙŠØªÙ… ØªÙ†ÙÙŠØ°Ù‡Ø§ Ù‡Ù†Ø§.
        };

        request.onsuccess = (e) => {
            IDB_connection = e.target.result;
            resolve(IDB_connection);
        };
    });
}

/**
 * ÙŠÙ‚ÙˆÙ… Ø¨ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† IndexedDB Ø¥Ù„Ù‰ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ db.
 */
async function loadStoreData(storeName) {
    return new Promise((resolve) => {
        if (!IDB_connection) return resolve(storeName === 'bal' ? db.bal : []);
        
        const transaction = IDB_connection.transaction([storeName], "readonly");
        const store = transaction.objectStore(storeName);
        const request = store.getAll();
        
        request.onsuccess = (e) => {
            if(storeName === 'bal') {
                const result = e.target.result[0];
                return resolve(result || db.bal); 
            }
            // Ø§Ù„ÙØ±Ø² ØªÙ†Ø§Ø²Ù„ÙŠÙ‹Ø§ (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
            resolve(e.target.result.sort((a, b) => b.id - a.id));
        };
        request.onerror = () => resolve(storeName === 'bal' ? db.bal : []);
    });
}

/**
 * ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø©: Ø¹Ø¯Ù… Ø§Ù†ØªØ¸Ø§Ø± Ø§ÙƒØªÙ…Ø§Ù„ initDB Ù‚Ø¨Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
 */
async function initDB() {
    try {
        await openDB(); // ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‡Ù†Ø§ Ù„ÙØªØ­ Ø§Ù„Ø§ØªØµØ§Ù„
        await loadAllData(); // ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‡Ù†Ø§ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        updateStats(); 
        updateBalanceDisplay();
        document.getElementById('darkModeToggle').checked = document.body.classList.contains('dark-mode');
        console.log("ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­.");
    } catch (error) {
        toastMsg("ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©.");
        console.error("Initialization failed:", error);
    }
}

async function loadAllData() {
    const [expData, rigData, debData, balData] = await Promise.all([
        loadStoreData('exp'),
        loadStoreData('rig'),
        loadStoreData('deb'),
        loadStoreData('bal'),
    ]);
    db.exp = expData;
    db.rig = rigData;
    db.deb = debData;
    db.bal = balData;
    currentBalance = db.bal.amount || 0;
}

// ===================================================
// 3. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆØ§Ù„ØªÙ†Ø³ÙŠÙ‚ (ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­)
// ===================================================

function toastMsg(msg) {
    const toast = document.getElementById('toast');
    // ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ù…Ø§Ù†: Ø§Ø³ØªØ®Ø¯Ø§Ù… textContent
    toast.textContent = msg; 
    toast.classList.add('show');
    setTimeout(() => {
        toast.classList.remove('show');
    }, 2500);
}

/**
 * ÙŠÙ†Ø¸Ù ÙˆÙŠØ­ÙˆÙ„ Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ù…Ø¨Ù„Øº Ø¥Ù„Ù‰ Ø±Ù‚Ù… Ø¹Ø§Ø¦Ù…. ÙŠØ¯Ø¹Ù… Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.
 * (ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø©: Ø¹Ø¯Ù… Ø¯Ø¹Ù… Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©ØŒ ÙˆÙ…Ø´ÙƒÙ„Ø© formatAmount)
 */
function cleanAmount(amountStr) {
    if (typeof amountStr === 'number') return amountStr;
    if (typeof amountStr !== 'string') return 0;

    // 1. ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ù -Ù©) Ø¥Ù„Ù‰ Ù„Ø§ØªÙŠÙ†ÙŠØ© (0-9)
    let cleaned = amountStr.replace(/[\u0660-\u0669]/g, (d) => d.charCodeAt(0) - 0x0660);
    // 2. Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ù…ÙˆØ² Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ù†Ù‚Ø·Ø©
    cleaned = cleaned.replace(/[^0-9.]/g, '').replace(/,/g, ''); 
    // 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø¹Ø´Ø±ÙŠØ© Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
    const parts = cleaned.split('.');
    if (parts.length > 2) {
        cleaned = parts[0] + '.' + parts.slice(1).join('');
    }
    
    const floatValue = parseFloat(cleaned);
    return isNaN(floatValue) ? 0 : floatValue;
}

/**
 * ÙŠÙ†Ø³Ù‚ Ø­Ù‚Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº (Ù„ØªØ³Ù‡ÙŠÙ„ cleanAmount).
 */
function formatAmount(input) {
    let cleaned = input.value.replace(/[\u0660-\u0669]/g, (d) => d.charCodeAt(0) - 0x0660);
    cleaned = cleaned.replace(/[^0-9.]/g, ''); 
    
    const parts = cleaned.split('.');
    if (parts.length > 2) {
        cleaned = parts[0] + '.' + parts.slice(1).join('');
    }
    
    if (cleaned === '.') {
        cleaned = '0.';
    }
    
    input.value = cleaned;
}

/**
 * ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ø¹ Ø§Ù„Ø¹Ù…Ù„Ø©. (Ø£Ù…Ø§Ù†: Ø§Ø³ØªØ®Ø¯Ø§Ù… textContent Ø£Ùˆ ÙˆØ¸ÙŠÙØ© ØªÙ†Ø³ÙŠÙ‚)
 */
function formatCurrency(amount) {
    const num = cleanAmount(amount);
    return `${currentCurrency.symbol} ${num.toLocaleString('ar-EG', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
}

/**
 * ØªÙ†Ø³ÙŠÙ‚ Ø¢Ù…Ù† Ù„Ù„ØªØ§Ø±ÙŠØ®. (ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø©: formatDate ØºÙŠØ± Ø¢Ù…Ù†)
 */
function formatDate(dateString) {
    if (!dateString) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ§Ù„Ø­'; // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¢Ù…Ù†

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ†Ø³ÙŠÙ‚ Ù…Ø­Ù„ÙŠ Ù…ÙˆØ­Ø¯
    const options = {
        year: 'numeric', month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit', hour12: false // Ø§Ø³ØªØ®Ø¯Ø§Ù… 24 Ø³Ø§Ø¹Ø© Ø«Ù… Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
    };
    
    try {
        return date.toLocaleDateString('ar-EG', options) + ' ' + date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', hour12: true });
    } catch (e) {
        return date.toLocaleString().replace(',', ' ');
    }
}

// ===================================================
// 4. Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø°Ø±ÙŠØ© Ø¹Ù„Ù‰ IndexedDB (ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­ ÙˆØ§Ù„ØªÙˆØ­ÙŠØ¯)
// ===================================================

/**
 * Ø­ÙØ¸ Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø´ÙƒÙ„ Ù…ØªØ²Ø§Ù…Ù†.
 * (ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø©: ID Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†ØŒ Ø³Ø¬Ù„ Ø§Ù„Ø±ØµÙŠØ¯ ÙŠÙØ­Ø¯Ø« Ù‚Ø¨Ù„ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø­ÙØ¸ØŒ Ø¹Ø¯Ù… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ onabort)
 */
async function saveTransactionAndBalance(item, storeName, balanceChange, changeDescription, buttonElement) {
    if (!IDB_connection) {
        toastMsg("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
        return;
    }

    if (buttonElement) buttonElement.disabled = true; // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¶ØºØ·

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…
    if (balanceChange < 0 && (cleanAmount(db.bal.amount) + balanceChange) < 0) {
        toastMsg("Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ ØºÙŠØ± ÙƒØ§ÙÙ Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.");
        if (buttonElement) buttonElement.disabled = false; 
        return;
    }
    
    const transaction = IDB_connection.transaction([storeName, 'bal'], "readwrite");
    
    return new Promise((resolve, reject) => {
        
        transaction.onerror = (e) => { 
            toastMsg(`ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${e.target.error.name}`); 
            console.error(e.target.error);
            reject(e.target.error); 
        };
        transaction.onabort = () => { 
            toastMsg("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Rollback)."); 
            reject(new Error("Transaction aborted"));
        };
        transaction.oncomplete = () => { resolve(); }; // Ø§Ù„Ù†Ø¬Ø§Ø­ Ø§Ù„ÙƒØ§Ù…Ù„

        try {
            // 1. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© (Ø³ØªØ­ØµÙ„ Ø¹Ù„Ù‰ ID Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ù† IndexedDB)
            const store = transaction.objectStore(storeName);
            const addRequest = store.add(item); 

            addRequest.onsuccess = () => {
                const newId = addRequest.result; 
                
                // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­Ù„ÙŠ ÙˆØªÙ‡ÙŠØ¦ØªÙ‡ Ù„Ù„Ø­ÙØ¸
                const balStore = transaction.objectStore('bal');
                
                db.bal.amount = cleanAmount(db.bal.amount) + balanceChange;
                
                // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
                const changeRecord = {
                    date: item.date,
                    amount: formatCurrency(balanceChange), 
                    type: changeDescription,
                    refId: newId, // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ ID Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
                    refStore: storeName
                };
                db.bal.changes.unshift(changeRecord);
                
                // ØªÙ‚ÙŠÙŠØ¯ Ø³Ø¬Ù„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                if (db.bal.changes.length > MAX_BAL_CHANGES) { 
                    db.bal.changes.length = MAX_BAL_CHANGES; 
                }

                // 3. Ø­ÙØ¸ ÙƒØ§Ø¦Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­Ø¯Ø«
                const balRequest = balStore.put(db.bal); 
                
                balRequest.onsuccess = () => {
                    // Success: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© (Cache)
                    item.id = newId; 
                    db[storeName].unshift(item); 
                    toastMsg("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!");
                };
            };

        } catch (error) {
            console.error('Critical save error:', error);
            transaction.abort();
            reject(error);
        }
    }).finally(() => {
        if (buttonElement) buttonElement.disabled = false; // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
        updateStats(); 
        updateBalanceDisplay();
    });
}


/**
 * Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø³Ø¬Ù„ Ø±ØµÙŠØ¯ ØºÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ø¹Ø§Ù…Ù„Ø© (Ø¥ÙŠØ¯Ø§Ø¹/Ø³Ø­Ø¨ ÙŠØ¯ÙˆÙŠ)
 */
async function saveBalanceAction(item, actionType, buttonElement) {
    if (!IDB_connection) {
        toastMsg("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
        return;
    }
    if (buttonElement) buttonElement.disabled = true;

    const transaction = IDB_connection.transaction(['bal'], "readwrite");
    
    return new Promise((resolve, reject) => {
        transaction.onerror = (e) => { 
            toastMsg(`ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${e.target.error.name}`); 
            reject(e.target.error); 
        };
        transaction.onabort = () => { 
            toastMsg("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©."); 
            reject(new Error("Transaction aborted"));
        };
        transaction.oncomplete = () => { resolve(); }; 

        try {
            const balStore = transaction.objectStore('bal');
            
            db.bal.amount = cleanAmount(db.bal.amount) + item.amount;
            
            const changeRecord = {
                date: item.date,
                amount: formatCurrency(item.amount),
                type: actionType === 'deposit' ? `Ø¥ÙŠØ¯Ø§Ø¹ Ù†Ù‚Ø¯ÙŠ (${item.desc})` : `Ø³Ø­Ø¨ Ù†Ù‚Ø¯ÙŠ (${item.desc})`,
                refId: Date.now(), // Ø§Ø³ØªØ®Ø¯Ø§Ù… Date.now() Ù‡Ù†Ø§ Ù…Ù‚Ø¨ÙˆÙ„ Ù„Ø£Ù†Ù‡ Ù„ÙŠØ³ Ù…ÙØªØ§Ø­ IndexedDB
                refStore: 'bal'
            };
            db.bal.changes.unshift(changeRecord);
            
            if (db.bal.changes.length > MAX_BAL_CHANGES) { 
                db.bal.changes.length = MAX_BAL_CHANGES; 
            }

            const balRequest = balStore.put(db.bal); 
            
            balRequest.onsuccess = () => {
                toastMsg("ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!");
            };

        } catch (error) {
            console.error('Critical save error:', error);
            transaction.abort();
            reject(error);
        }
    }).finally(() => {
        if (buttonElement) buttonElement.disabled = false;
        closeLayer('balanceAction');
        updateStats(); 
        updateBalanceDisplay();
    });
}


// ===================================================
// 5. ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙˆØ§Ù„ØªØ­Ù‚Ù‚ (Validation)
// ===================================================

/**
 * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„. (ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø©: Ø¹Ø¯Ù… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ… Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸)
 */
function validateItem(item, isExpense = false) {
    if (item.amount <= 0) {
        toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­.");
        return false;
    }
    if (item.type === '' && !isExpense) {
        toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.");
        return false;
    }
    if (item.date === '') {
        toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.");
        return false;
    }
    if (item.desc === '' && !isExpense) {
        toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© ÙˆØµÙ Ù„Ù„Ø¹Ù…Ù„ÙŠØ©.");
        return false;
    }
    if (item.status === '' && (item.storeName === 'rig' || item.storeName === 'deb')) {
        toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù‚/Ø§Ù„Ø§Ù„ØªØ²Ø§Ù….");
        return false;
    }
    return true;
}

async function addExpense(buttonElement) {
    const amount = cleanAmount(document.getElementById('eAmount').value);
    const item = {
        type: document.getElementById('eType').value || 'Ø£Ø®Ø±Ù‰',
        desc: document.getElementById('eDesc').value,
        date: document.getElementById('eDate').value || new Date().toISOString().substring(0, 16),
        amount: amount,
        img: document.getElementById('eImgName').dataset.img || '' // Ø¥Ø±ÙØ§Ù‚ Ø§Ù„ØµÙˆØ±Ø©
    };

    if (!validateItem(item, true)) return;

    // Ø§Ù„Ø®ØµÙ… Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯: Expense = Ø³Ø§Ù„Ø¨ (ÙŠØªÙ… Ø®ØµÙ…Ù‡)
    const balanceChange = -amount;
    const desc = `Ù…ØµØ±ÙˆÙ: ${item.type} - ${item.desc}`;

    await saveTransactionAndBalance(item, 'exp', balanceChange, desc, buttonElement);
}

async function addRight(buttonElement) {
    const amount = cleanAmount(document.getElementById('rAmount').value);
    const status = document.getElementById('rStatus').value;
    
    const item = {
        type: document.getElementById('rType').value,
        desc: document.getElementById('rDesc').value,
        date: document.getElementById('rDate').value || new Date().toISOString().substring(0, 16),
        amount: amount,
        status: status,
    };

    if (!validateItem(item)) return;

    // Ø§Ù„Ø­Ù‚ÙˆÙ‚: Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­Ø§Ù„Ø© "ÙƒØ§Ù…Ù„" (Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„)
    let balanceChange = 0;
    if (status === 'ÙƒØ§Ù…Ù„') {
        balanceChange = amount;
    }
    const desc = `Ø­Ù‚ (ØªØ­ØµÙŠÙ„): ${item.type} - ${item.desc}`;

    await saveTransactionAndBalance(item, 'rig', balanceChange, desc, buttonElement);
}

async function addDebt(buttonElement) {
    const amount = cleanAmount(document.getElementById('dAmount').value);
    const status = document.getElementById('dStatus').value;

    const item = {
        type: document.getElementById('dType').value,
        desc: document.getElementById('dDesc').value,
        date: document.getElementById('dDate').value || new Date().toISOString().substring(0, 16),
        amount: amount,
        status: status,
    };
    
    if (!validateItem(item)) return;

    // Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª: Ø§Ù„Ø®ØµÙ… ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­Ø§Ù„Ø© "Ù…Ø¯ÙÙˆØ¹"
    let balanceChange = 0;
    if (status === 'Ù…Ø¯ÙÙˆØ¹') {
        balanceChange = -amount;
    }
    const desc = `Ø§Ù„ØªØ²Ø§Ù… (Ø¯ÙØ¹): ${item.type} - ${item.desc}`;

    await saveTransactionAndBalance(item, 'deb', balanceChange, desc, buttonElement);
}

async function processBalanceAction(buttonElement) {
    const amount = cleanAmount(document.getElementById('bAmount').value);
    const desc = document.getElementById('bDesc').value;
    const date = document.getElementById('bDate').value || new Date().toISOString().substring(0, 16);
    
    if (amount <= 0 || desc === '') {
        toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ÙˆÙˆØµÙ ØµØ­ÙŠØ­ÙŠÙ†.");
        return;
    }

    let change = amount;
    const actionType = balanceActionType;
    if (actionType === 'withdraw') {
        change = -amount;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³Ø­Ø¨
    if (actionType === 'withdraw' && (cleanAmount(db.bal.amount) + change) < 0) {
         toastMsg("Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø³Ø­Ø¨.");
         return;
    }

    const item = { amount: change, desc: desc, date: date };

    await saveBalanceAction(item, actionType, buttonElement);
}

// ===================================================
// 6. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ« (ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­)
// ===================================================

function updateBalanceDisplay() {
    const displayElement = document.getElementById('currentBalanceDisplay');
    const balanceAmount = cleanAmount(db.bal.amount);
    currentBalance = balanceAmount;

    if (balanceHidden) {
        displayElement.textContent = "â€¢â€¢â€¢â€¢â€¢â€¢â€¢";
        displayElement.classList.add('hidden-balance');
        document.getElementById('balanceVisibilityToggle').innerHTML = '<i class="fas fa-eye-slash"></i>';
    } else {
        // Ø£Ù…Ø§Ù†: Ø§Ø³ØªØ®Ø¯Ø§Ù… textContent
        displayElement.textContent = formatCurrency(balanceAmount); 
        displayElement.classList.remove('hidden-balance');
        document.getElementById('balanceVisibilityToggle').innerHTML = '<i class="fas fa-eye"></i>';
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙÙŠ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹/Ø§Ù„Ø³Ø­Ø¨
    const balanceInAction = document.getElementById('currentBalanceInAction');
    if (balanceInAction) {
        balanceInAction.textContent = formatCurrency(balanceAmount);
    }
}

function updateStats() {
    const expTotal = db.exp.reduce((sum, item) => sum + cleanAmount(item.amount), 0);
    const rigTotal = db.rig.reduce((sum, item) => sum + cleanAmount(item.amount), 0);
    const rigPaid = db.rig.filter(item => item.status === 'ÙƒØ§Ù…Ù„').reduce((sum, item) => sum + cleanAmount(item.amount), 0);
    const debTotal = db.deb.reduce((sum, item) => sum + cleanAmount(item.amount), 0);
    const debPaid = db.deb.filter(item => item.status === 'Ù…Ø¯ÙÙˆØ¹').reduce((sum, item) => sum + cleanAmount(item.amount), 0);

    // ØªØ­Ø¯ÙŠØ« Ù…Ù„Ø®Øµ Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© (Ø£Ù…Ø§Ù†: Ø§Ø³ØªØ®Ø¯Ø§Ù… textContent ÙÙŠ B tags)
    document.getElementById('sExpTotal').textContent = formatCurrency(expTotal);
    document.getElementById('sRigTotal').textContent = formatCurrency(rigTotal);
    document.getElementById('sDebTotal').textContent = formatCurrency(debTotal);
    document.getElementById('sRigPaid').textContent = formatCurrency(rigPaid);
    document.getElementById('sDebPaid').textContent = formatCurrency(debPaid);

    // ØªØ­Ø¯ÙŠØ« Ù…Ù„Ø®Øµ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
    document.getElementById('expTotalDisplay').textContent = formatCurrency(expTotal);
    document.getElementById('rigTotalDisplay').textContent = formatCurrency(rigTotal);
    document.getElementById('rigCollectedDisplay').textContent = formatCurrency(rigPaid);
    document.getElementById('rigPendingDisplay').textContent = formatCurrency(rigTotal - rigPaid);
    document.getElementById('debTotalDisplay').textContent = formatCurrency(debTotal);
    document.getElementById('debPaidDisplay').textContent = formatCurrency(debPaid);
    document.getElementById('debPendingDisplay').textContent = formatCurrency(debTotal - debPaid);

    // Ø¥Ø¸Ù‡Ø§Ø± Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ù„Ø®Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª
    document.getElementById('expenseTotals').style.display = expTotal > 0 ? 'block' : 'none';
    document.getElementById('rightsTotals').style.display = rigTotal > 0 ? 'block' : 'none';
    document.getElementById('debtsTotals').style.display = debTotal > 0 ? 'block' : 'none';
}


/**
 * Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„. (ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø©: renderLog ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©)
 */
function renderLog(searchKey = document.getElementById('search').value.toLowerCase()) {
    const storeName = currentLog;
    let data = db[storeName] || [];

    if (searchKey) {
        data = data.filter(item => {
            const searchString = `${item.desc} ${item.type} ${item.amount} ${item.status || ''}`.toLowerCase();
            return searchString.includes(searchKey);
        });
    }

    const logContent = document.getElementById('logContent');
    if (data.length === 0) {
        logContent.innerHTML = '<p style="text-align: center; color: #999; margin-top: 30px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©.</p>';
        return;
    }

    logContent.innerHTML = data.map(item => `
        <div class="list-item" onclick="showDetailModal(${item.id}, '${storeName}')">
            <div>
                <strong>${item.type}</strong> - <span style="font-size: 0.9em;">${item.desc}</span>
            </div>
            <div class="details">
                <span style="color: ${storeName === 'exp' || item.status === 'Ù…Ø¯ÙÙˆØ¹' ? 'var(--danger)' : 'var(--success)'}; font-weight: bold;">
                    ${formatCurrency(item.amount)}
                </span>
                <span>${formatDate(item.date)}</span>
                <span style="font-size: 0.8em; color: var(--p);">${item.status || ''}</span>
            </div>
        </div>
    `).join('');
}


/**
 * ÙØªØ­ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª. (ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø©: openLog ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©)
 */
function openLog(storeName) {
    currentLog = storeName;
    document.getElementById('logModal').style.display = 'flex';
    document.getElementById('search').value = '';
    renderLog();
}


/**
 * Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯. (ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø©: openBalanceLogModal ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©)
 */
function openBalanceLogModal() {
    document.getElementById('balanceLogModal').style.display = 'flex';
    const logContent = document.getElementById('balanceLogContent');
    const changes = db.bal.changes || [];

    if (changes.length === 0) {
        logContent.innerHTML = '<p style="text-align: center; color: #999; margin-top: 30px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ø±ØµÙŠØ¯.</p>';
        return;
    }
    
    logContent.innerHTML = changes.map(change => {
        const amountNum = cleanAmount(change.amount.replace(currentCurrency.symbol, ''));
        const isDeposit = amountNum >= 0;
        const color = isDeposit ? 'var(--success)' : 'var(--danger)';
        const sign = isDeposit ? '+' : '';

        return `
            <div class="list-item" style="border-right: 5px solid ${isDeposit ? 'var(--success)' : 'var(--danger)'};">
                <div>
                    <strong>${change.type}</strong>
                </div>
                <div class="details">
                    <span style="color: ${color}; font-weight: bold;">
                        ${sign}${formatCurrency(amountNum)}
                    </span>
                    <span style="color: #999;">${formatDate(change.date)}</span>
                </div>
            </div>
        `;
    }).join('');
}

// ===================================================
// 7. ÙˆØ¸Ø§Ø¦Ù ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© (Stubs/Fixes)
// ===================================================

function openTab(tabName) {
    document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');

    document.querySelectorAll('.tabs button').forEach(button => button.classList.remove('active'));
    document.querySelector(`.tabs button[onclick="openTab('${tabName}')"]`).classList.add('active');
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
    if (tabName !== 'overview') {
        document.getElementById('eAmount').value = document.getElementById('rAmount').value = document.getElementById('dAmount').value = '';
        document.getElementById('eDesc').value = document.getElementById('rDesc').value = document.getElementById('dDesc').value = '';
        document.getElementById('eType').value = document.getElementById('rType').value = document.getElementById('dType').value = '';
        document.getElementById('rStatus').value = document.getElementById('dStatus').value = '';
    }

    updateStats(); 
}

function openSidebar() {
    document.getElementById('appSidebar').classList.add('open');
    document.querySelector('.sidebar-overlay').classList.add('open');
}

function closeLayer(layerName) {
    const layer = LAYERS[layerName];
    if (layer) {
        if (layer.type === 'menu' || layerName === 'sidebar') {
            document.getElementById(layer.elementId).classList.remove('open');
            document.querySelector('.sidebar-overlay').classList.remove('open');
        } else if (layer.type === 'modal') {
             document.getElementById(layer.elementId).style.display = 'none';
        } else if (layer.type === 'small_modal') {
             document.getElementById(layer.elementId).style.display = 'none';
             document.getElementById('imageSourceOverlay').style.display = 'none';
        }
    }
    // ØªÙ†Ø¸ÙŠÙ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    editMode = null; 
}

function toggleBalanceVisibility() {
    balanceHidden = !balanceHidden;
    localStorage.setItem('balanceHidden', balanceHidden);
    updateBalanceDisplay();
}

function openBalanceActionModal(action) {
    balanceActionType = action;
    document.getElementById('actionModalTitle').textContent = action === 'deposit' ? 'Ø¥Ø¶Ø§ÙØ© Ø¥ÙŠØ¯Ø§Ø¹ Ø¬Ø¯ÙŠØ¯' : 'Ø³Ø­Ø¨ Ù…Ø¨Ù„Øº Ù†Ù‚Ø¯ÙŠ';
    document.getElementById('bAmount').value = '';
    document.getElementById('bDesc').value = '';
    document.getElementById('bDate').value = new Date().toISOString().substring(0, 16);
    updateBalanceDisplay();
    document.getElementById('balanceActionModal').style.display = 'flex';
}


// Stubs for Dynamic Fields (ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø©: Ø¯ÙˆØ§Ù„ updateRightFields/updateDebtFields ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©)
function updateRightFields(value) {
    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ù‡Ù†Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚
}
function updateDebtFields(value) {
    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ù‡Ù†Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…
}

// Stubs for Image Handling (ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø©: Ø¯ÙˆØ§Ù„ Ø¥Ø±ÙØ§Ù‚ Ø§Ù„ØµÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©)
function showImageSourceModal() {
    document.getElementById('imageSourceModal').style.display = 'flex';
    document.getElementById('imageSourceOverlay').style.display = 'block';
}
function openCameraInput() {
    document.getElementById('eImgCamera').click();
    closeLayer('imageSource');
}
function openGalleryInput() {
    document.getElementById('eImgGallery').click();
    closeLayer('imageSource');
}
function updateFileName(input, elementId) {
    const fileName = input.files[0] ? input.files[0].name : '';
    const displayElement = document.getElementById(elementId);
    displayElement.textContent = fileName ? `ØªÙ… Ø¥Ø±ÙØ§Ù‚: ${fileName}` : '';
    displayElement.dataset.img = fileName; // Placeholder: ØªØ®Ø²ÙŠÙ† Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
}


// Stubs for Sidebar actions (ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø©: Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©)
function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('darkMode', isDark);
}
function openCurrencyModal() { 
    document.getElementById('currencyModal').style.display = 'flex'; 
    renderCurrencyList();
}
function openAboutModal() { 
    document.getElementById('aboutModal').style.display = 'flex'; 
}

function renderCurrencyList() {
    const searchKey = document.getElementById('currencySearch').value.toLowerCase();
    const listElement = document.getElementById('currencyList');
    
    let filteredList = ARABIC_CURRENCIES.filter(c => 
        c.name.includes(searchKey) || c.code.toLowerCase().includes(searchKey)
    );

    listElement.innerHTML = filteredList.map(c => `
        <div class="sidebar-menu-item" onclick="setCurrency('${c.code}')">
            <span>${c.name} (${c.symbol})</span>
            ${c.code === currentCurrency.code ? '<i class="fas fa-check" style="color: var(--success);"></i>' : ''}
        </div>
    `).join('');
}

function setCurrency(code) {
    currentCurrency = ARABIC_CURRENCIES.find(c => c.code === code);
    localStorage.setItem('currencyCode', code);
    document.getElementById('currentCurrencyDisplay').textContent = `Ø§Ù„Ø¹Ù…Ù„Ø©: ${currentCurrency.name} (${currentCurrency.symbol})`;
    closeLayer('currency');
    updateStats();
    updateBalanceDisplay();
}

function exportData() {
    const data = JSON.stringify(db, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `smart_budget_backup_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    toastMsg("ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
}

/**
 * Ø¯Ø§Ù„Ø© Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
 */
function importData(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const importedDb = JSON.parse(e.target.result);
            if (!importedDb || !importedDb.exp || !importedDb.bal) {
                return toastMsg("Ù…Ù„Ù Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­.");
            }

            // ÙŠØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ¥Ø¹Ø§Ø¯Ø© ÙƒØªØ§Ø¨Ø© ÙƒÙ„ Ø´ÙŠØ¡
            const transaction = IDB_connection.transaction(STORE_NAMES, "readwrite");
            
            // Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø®Ø§Ø²Ù†
            STORE_NAMES.forEach(storeName => {
                transaction.objectStore(storeName).clear();
            });

            // Ø¥Ø¹Ø§Ø¯Ø© ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            transaction.oncomplete = async () => {
                const writeTransaction = IDB_connection.transaction(STORE_NAMES, "readwrite");
                
                // Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø±ØµÙŠØ¯ Ø£ÙˆÙ„Ø§Ù‹ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹)
                writeTransaction.objectStore('bal').put(importedDb.bal);
                
                // Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
                ['exp', 'rig', 'deb'].forEach(storeName => {
                    const store = writeTransaction.objectStore(storeName);
                    importedDb[storeName].forEach(item => {
                        store.add(item); 
                    });
                });

                writeTransaction.oncomplete = async () => {
                    await loadAllData();
                    updateStats();
                    updateBalanceDisplay();
                    toastMsg("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
                };
                writeTransaction.onerror = () => toastMsg("ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©.");
            };
            transaction.onerror = () => toastMsg("ÙØ´Ù„ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.");

        } catch (error) {
            toastMsg("ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù JSON.");
            console.error(error);
        } finally {
            event.target.value = null; 
        }
    };
    reader.readAsText(file);
}


function confirmResetData() {
    closeLayer('sidebar');
    // ØªØµØ­ÙŠØ­: Ø§Ø³ØªØ®Ø¯Ø§Ù… confirm() Ø§Ù„Ø£ØµÙ„ÙŠ (ØªØ¬Ø±Ø¨Ø© Ù…Ø³ØªØ®Ø¯Ù… Ø³ÙŠØ¦Ø© Ù„ÙƒÙ† ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯)
    if (confirm("ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.")) {
        resetAllData();
    }
}

function resetAllData() {
     if (!IDB_connection) return toastMsg("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");

    const transaction = IDB_connection.transaction(STORE_NAMES, "readwrite");
    let storesCleared = 0;
    
    STORE_NAMES.forEach(storeName => {
        const store = transaction.objectStore(storeName);
        const request = store.clear();

        request.onsuccess = () => {
            storesCleared++;
            if (storesCleared === STORE_NAMES.length) {
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØµÙÙˆÙØ§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
                db.exp = []; 
                db.rig = [];
                db.deb = []; 
                db.bal = { clientId: 1, amount: 0, changes: [] };
                
                // Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙØ§Ø±Øº (Ø¥Ù„Ø²Ø§Ù…ÙŠ Ù„Ù€ IndexedDB)
                transaction.objectStore('bal').put(db.bal); 
                
                // Ø¨Ù…Ø§ Ø£Ù†Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… transaction ÙˆØ§Ø­Ø¯Ø©ØŒ Ù†Ù†ØªØ¸Ø± Ø§ÙƒØªÙ…Ø§Ù„Ù‡Ø§
                transaction.oncomplete = () => {
                    loadAllData().then(() => {
                        updateStats(); 
                        updateBalanceDisplay();
                        toastMsg("ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
                    });
                };
            }
        };

        request.onerror = () => toastMsg("ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
    });
}

// ===================================================
// 8. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù (Ù…ÙÙ‚ÙˆØ¯Ø© ÙˆÙ…Ø¶Ø§ÙØ©)
// ===================================================

/**
 * ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©.
 */
function getItemById(id, storeName) {
    if (!db[storeName]) return null;
    const item = db[storeName].find(item => item.id === id);
    return item ? { ...item, storeName: storeName } : null;
}

/**
 * ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ (Ø¹Ø±Ø¶ ÙÙ‚Ø·).
 */
function showDetailModal(id, storeName) {
    const item = getItemById(id, storeName);
    if (!item) return toastMsg("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.");

    let html = `
        <h3 style="color: var(--p); border-bottom: 2px solid var(--s); padding-bottom: 10px;">
            ${item.storeName === 'exp' ? 'Ù…ØµØ±ÙˆÙ' : (item.storeName === 'rig' ? 'Ø­Ù‚ Ù…Ø§Ù„ÙŠ' : 'Ø§Ù„ØªØ²Ø§Ù…')}
        </h3>
        <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> <span style="font-weight: bold;">${formatCurrency(item.amount)}</span></p>
        <p><strong>Ø§Ù„Ù†ÙˆØ¹/Ø§Ù„ÙØ¦Ø©:</strong> ${item.type}</p>
        <p><strong>Ø§Ù„ÙˆØµÙ/Ø§Ù„Ø¬Ù‡Ø©:</strong> ${item.desc || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>
        <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${formatDate(item.date)}</p>
    `;
    if (item.status) {
        const color = item.status.includes('ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹') ? 'var(--danger)' : 'var(--success)';
        html += `<p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span style="color: ${color}; font-weight: bold;">${item.status}</span></p>`;
    }
    if (item.img) {
        html += `<p><strong>Ø¥Ø±ÙØ§Ù‚:</strong> <i class="fas fa-image" style="color: var(--success);"></i> ${item.img}</p>`;
    }

    html += `
        <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button class="secondary" onclick="showEditModal(${id}, '${storeName}')" style="flex: 1;"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="action danger-btn" onclick="deleteItem(${id}, '${storeName}')" style="flex: 1;"><i class="fas fa-trash-alt"></i> Ø­Ø°Ù</button>
        </div>
    `;

    document.getElementById('detailContent').innerHTML = html;
    document.getElementById('detailModal').style.display = 'flex';
}

/**
 * ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.
 */
function showEditModal(id, storeName) {
    const item = getItemById(id, storeName);
    if (!item) return toastMsg("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.");

    editMode = item; // Ø­ÙØ¸ Ø§Ù„ÙƒØ§Ø¦Ù† Ø§Ù„Ø£ØµÙ„ÙŠ
    document.getElementById('editModalTitle').textContent = `ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© #${id}`;
    
    let html = '';
    const isExpense = storeName === 'exp';

    // Ø¨Ù†Ø§Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    html += `
        <input id="e_id" type="hidden" value="${item.id}">
        <input id="e_storeName" type="hidden" value="${storeName}">
        <input id="e_amount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" value="${item.amount}" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
    `;

    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª (ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ÙƒØ±Ø±)
    const optionsHtml = isExpense 
        ? document.getElementById('eType').innerHTML 
        : (storeName === 'rig' ? document.getElementById('rType').innerHTML : document.getElementById('dType').innerHTML);
    
    html += `
        <select id="e_type">
            ${optionsHtml}
        </select>
    `;

    html += `<input id="e_desc" placeholder="ğŸ“ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©" value="${item.desc}">`;
    html += `
        <div class="datetime-container">
            <input id="e_date" type="datetime-local" value="${item.date.substring(0, 16)}">
            <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
        </div>
    `;

    if (item.status) {
        const statusOptions = storeName === 'rig' ? document.getElementById('rStatus').innerHTML : document.getElementById('dStatus').innerHTML;
        html += `
            <select id="e_status">
                ${statusOptions}
            </select>
        `;
    }

    html += `
        <button class="action" id="e_saveBtn" onclick="updateItem(this)">
            <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
        </button>
    `;

    document.getElementById('editModalContent').innerHTML = html;
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
    document.getElementById('e_type').value = item.type;
    if (item.status) {
        document.getElementById('e_status').value = item.status;
    }

    closeLayer('detail'); // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙØ§ØµÙŠÙ„
    document.getElementById('editModal').style.display = 'flex';
}

/**
 * ØªØ­Ø¯ÙŠØ« Ø¹Ù†ØµØ± Ù…ÙˆØ¬ÙˆØ¯ (ÙŠØ³ØªØ®Ø¯Ù… Ù†ÙØ³ Ù…Ù†Ø·Ù‚ saveTransactionAndBalance Ù„ÙƒÙ† Ù…Ø¹ put).
 * (ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø©: Ø®Ù„Ù„ ÙÙŠ Ù…Ù†Ø·Ù‚ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)
 */
async function updateItem(buttonElement) {
    if (!editMode) return;

    const newAmount = cleanAmount(document.getElementById('e_amount').value);
    const oldAmount = cleanAmount(editMode.amount);
    const oldStatus = editMode.status;
    const newStatus = editMode.status ? document.getElementById('e_status').value : null;

    // 1. Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙƒØ§Ø¦Ù† Ø§Ù„Ù…Ø­Ø¯Ø«
    const updatedItem = {
        ...editMode, // Ù†Ø³Ø® ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„
        type: document.getElementById('e_type').value,
        desc: document.getElementById('e_desc').value,
        date: document.getElementById('e_date').value,
        amount: newAmount,
        status: newStatus || editMode.status,
    };
    
    if (!validateItem(updatedItem, updatedItem.storeName === 'exp')) return;

    if (buttonElement) buttonElement.disabled = true;

    // 2. Ø­Ø³Ø§Ø¨ ØµØ§ÙÙŠ Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ø±ØµÙŠØ¯
    let netBalanceChange = 0;
    const storeName = editMode.storeName;
    const isExpense = storeName === 'exp';

    if (isExpense) {
        // Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø¯ÙŠÙ…) - (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¬Ø¯ÙŠØ¯)
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø£ÙƒØ¨Ø±: Ø³Ø§Ù„Ø¨ØŒ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø£ÙƒØ¨Ø±: Ù…ÙˆØ¬Ø¨
        netBalanceChange = oldAmount - newAmount;
    } else if (storeName === 'rig') {
        // Ø§Ù„Ø­Ù‚ÙˆÙ‚: Ø§Ù„ØªØºÙŠÙŠØ± ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© (Ù…Ø¯ÙÙˆØ¹/ÙƒØ§Ù…Ù„)
        const oldWasPaid = oldStatus === 'ÙƒØ§Ù…Ù„';
        const newIsPaid = newStatus === 'ÙƒØ§Ù…Ù„';
        
        if (oldWasPaid && newIsPaid) {
            // ÙƒØ§Ù† Ù…Ø¯ÙÙˆØ¹Ø§Ù‹ ÙˆØ¨Ù‚ÙŠ Ù…Ø¯ÙÙˆØ¹Ø§Ù‹: (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¬Ø¯ÙŠØ¯) - (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø¯ÙŠÙ…)
            netBalanceChange = newAmount - oldAmount; 
        } else if (!oldWasPaid && newIsPaid) {
            // ÙƒØ§Ù† ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ ÙˆØ£ØµØ¨Ø­ Ù…Ø¯ÙÙˆØ¹Ø§Ù‹: Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¬Ø¯ÙŠØ¯
            netBalanceChange = newAmount;
        } else if (oldWasPaid && !newIsPaid) {
            // ÙƒØ§Ù† Ù…Ø¯ÙÙˆØ¹Ø§Ù‹ ÙˆØ£ØµØ¨Ø­ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹: Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø¯ÙŠÙ…
            netBalanceChange = -oldAmount;
        }
    } else if (storeName === 'deb') {
        // Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª: Ø§Ù„ØªØºÙŠÙŠØ± ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© (Ù…Ø¯ÙÙˆØ¹)
        const oldWasPaid = oldStatus === 'Ù…Ø¯ÙÙˆØ¹';
        const newIsPaid = newStatus === 'Ù…Ø¯ÙÙˆØ¹';

        if (oldWasPaid && newIsPaid) {
            // ÙƒØ§Ù† Ù…Ø¯ÙÙˆØ¹Ø§Ù‹ ÙˆØ¨Ù‚ÙŠ Ù…Ø¯ÙÙˆØ¹Ø§Ù‹: Ø®ØµÙ… ØµØ§ÙÙŠ Ø§Ù„ÙØ±Ù‚
            netBalanceChange = oldAmount - newAmount; // Ø¥Ø°Ø§ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø£ÙƒØ¨Ø± ØªÙƒÙˆÙ† Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³Ø§Ù„Ø¨Ø© (Ø®ØµÙ… Ø¥Ø¶Ø§ÙÙŠ)
        } else if (!oldWasPaid && newIsPaid) {
            // ÙƒØ§Ù† ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ ÙˆØ£ØµØ¨Ø­ Ù…Ø¯ÙÙˆØ¹Ø§Ù‹: Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¬Ø¯ÙŠØ¯
            netBalanceChange = -newAmount;
        } else if (oldWasPaid && !newIsPaid) {
            // ÙƒØ§Ù† Ù…Ø¯ÙÙˆØ¹Ø§Ù‹ ÙˆØ£ØµØ¨Ø­ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹: Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø®ØµÙ… Ø§Ù„Ù‚Ø¯ÙŠÙ…)
            netBalanceChange = oldAmount;
        }
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±
    if ((cleanAmount(db.bal.amount) + netBalanceChange) < 0 && netBalanceChange < 0) {
        toastMsg("Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.");
        if (buttonElement) buttonElement.disabled = false;
        return;
    }

    // 3. ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø§Ù„Ø°Ø±ÙŠØ© (Ø§Ø³ØªØ®Ø¯Ø§Ù… put Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† add)
    const transaction = IDB_connection.transaction([storeName, 'bal'], "readwrite");
    
    return new Promise((resolve, reject) => {
        
        transaction.onerror = (e) => { 
            toastMsg(`ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ${e.target.error.name}`); 
            reject(e.target.error); 
        };
        transaction.onabort = () => { reject(new Error("Transaction aborted")); };
        transaction.oncomplete = () => { resolve(); }; 

        try {
            // Ø£. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… put Ù„Ù€ ID Ù…Ø­Ø¯Ø¯)
            const store = transaction.objectStore(storeName);
            const putRequest = store.put(updatedItem); 

            putRequest.onsuccess = () => {
                // Ø¨. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯
                const balStore = transaction.objectStore('bal');
                
                db.bal.amount = cleanAmount(db.bal.amount) + netBalanceChange;
                
                const changeRecord = {
                    date: updatedItem.date,
                    amount: formatCurrency(netBalanceChange),
                    type: `ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ ${storeName} #${updatedItem.id}`,
                    refId: updatedItem.id, 
                    refStore: storeName
                };
                db.bal.changes.unshift(changeRecord);
                
                if (db.bal.changes.length > MAX_BAL_CHANGES) { 
                    db.bal.changes.length = MAX_BAL_CHANGES; 
                }

                // Ø¬. Ø­ÙØ¸ ÙƒØ§Ø¦Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­Ø¯Ø«
                const balRequest = balStore.put(db.bal); 
                
                balRequest.onsuccess = () => {
                    // Ø¯. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
                    const index = db[storeName].findIndex(i => i.id === updatedItem.id);
                    if (index !== -1) {
                        db[storeName][index] = updatedItem;
                    }
                    toastMsg("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!");
                };
            };
        } catch (error) {
            console.error('Critical update error:', error);
            transaction.abort();
            reject(error);
        }
    }).finally(() => {
        if (buttonElement) buttonElement.disabled = false;
        closeLayer('edit');
        updateStats(); 
        updateBalanceDisplay();
        renderLog();
    });
}


/**
 * Ø­Ø°Ù Ø¹Ù†ØµØ± Ù…ÙˆØ¬ÙˆØ¯.
 */
async function deleteItem(id, storeName) {
    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.")) {
        return;
    }
    
    const item = getItemById(id, storeName);
    if (!item) return toastMsg("Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.");
    
    closeLayer('detail');

    // 1. Ø­Ø³Ø§Ø¨ ØµØ§ÙÙŠ Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ø±ØµÙŠØ¯ (Ø¹ÙƒØ³ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ©)
    let netBalanceChange = 0;
    const isExpense = storeName === 'exp';

    if (isExpense) {
        netBalanceChange = cleanAmount(item.amount); // Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
    } else if (storeName === 'rig' && item.status === 'ÙƒØ§Ù…Ù„') {
        netBalanceChange = -cleanAmount(item.amount); // Ø§Ù„Ø®ØµÙ… Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
    } else if (storeName === 'deb' && item.status === 'Ù…Ø¯ÙÙˆØ¹') {
        netBalanceChange = cleanAmount(item.amount); // Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
    }

    const transaction = IDB_connection.transaction([storeName, 'bal'], "readwrite");
    
    return new Promise((resolve, reject) => {
        
        transaction.onerror = (e) => { 
            toastMsg(`ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: ${e.target.error.name}`); 
            reject(e.target.error); 
        };
        transaction.onabort = () => { reject(new Error("Transaction aborted")); };
        transaction.oncomplete = () => { resolve(); }; 

        try {
            // Ø£. Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
            const store = transaction.objectStore(storeName);
            const deleteRequest = store.delete(id); 

            deleteRequest.onsuccess = () => {
                // Ø¨. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯
                const balStore = transaction.objectStore('bal');
                
                db.bal.amount = cleanAmount(db.bal.amount) + netBalanceChange;
                
                const changeRecord = {
                    date: new Date().toISOString().substring(0, 16),
                    amount: formatCurrency(netBalanceChange),
                    type: `Ø­Ø°Ù ${storeName} #${id}`,
                    refId: id, 
                    refStore: storeName
                };
                db.bal.changes.unshift(changeRecord);
                
                if (db.bal.changes.length > MAX_BAL_CHANGES) { 
                    db.bal.changes.length = MAX_BAL_CHANGES; 
                }

                // Ø¬. Ø­ÙØ¸ ÙƒØ§Ø¦Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­Ø¯Ø«
                const balRequest = balStore.put(db.bal); 
                
                balRequest.onsuccess = () => {
                    // Ø¯. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
                    db[storeName] = db[storeName].filter(i => i.id !== id);
                    toastMsg("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!");
                };
            };
        } catch (error) {
            console.error('Critical delete error:', error);
            transaction.abort();
            reject(error);
        }
    }).finally(() => {
        updateStats(); 
        updateBalanceDisplay();
        renderLog();
    });
}


// ===================================================
// 9. Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ (Initialization)
// ===================================================

// ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
if (localStorage.getItem('darkMode') === 'true') {
    document.body.classList.add('dark-mode');
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ DOM
document.addEventListener('DOMContentLoaded', initDB); 
</script>

</body>
</html>
