<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ© | Smart Budget</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">

<style>
/* ---------------------------------------------------- */
/* Variables and Base Styling - LIGHT MODE (Default) */
/* ---------------------------------------------------- */
:root{
    --p: #0077b6; /* Primary Blue (Vibrant) */
    --s: #48cae4; /* Secondary Light Blue */
    --bg: #f7f9fc; /* Light Background */
    --danger: #ef476f; 
    --success: #2a9d8f;
    --warning: #fbc02d;
    --text-dark: #333;
    --text-light: #f7f9fc;
    --shadow-light: 0 4px 8px rgba(0, 0, 0, 0.08);
    --shadow-hover: 0 6px 15px rgba(0, 0, 0, 0.15);
    --card-bg: #fff;
    --input-bg: #fff;
    --border-color: #ddd;
    --tab-active-bg: #fff;
}

/* ---------------------------------------------------- */
/* Dark Mode Variables */
/* ---------------------------------------------------- */
body.dark-mode {
    --p: #90e0ef; /* Lighter Primary Blue for contrast */
    --s: #48cae4; 
    --bg: #1f1f1f; /* Dark Background */
    --danger: #ff8a80;
    --success: #66bb6a;
    --warning: #fbc02d;
    --text-dark: #e0e0e0; /* Light Text */
    --text-light: #1f1f1f;
    --shadow-light: 0 4px 10px rgba(0, 0, 0, 0.5);
    --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.8);
    --card-bg: #2d2d2d;
    --input-bg: #3c3c3c;
    --border-color: #555;
    --tab-active-bg: #2d2d2d;
}

/* ---------------------------------------------------- */
/* Global Reset and Base Styling */
/* ---------------------------------------------------- */
* {
    box-sizing: border-box;
}
body{
    margin:0;
    font-family: 'Tajawal', 'Arial', sans-serif;
    background: var(--bg);
    color: var(--text-dark);
    overflow-x: hidden;
    line-height: 1.6;
    transition: background 0.3s, color 0.3s;
}

/* Global Dark Mode Overrides for Specific Elements */
.card, .sidebar, .modal { background: var(--card-bg); }
.modal header { background: var(--card-bg); border-bottom: 1px solid var(--border-color); }

/* ---------------------------------------------------- */
/* Header & Navigation */
/* ---------------------------------------------------- */
header{
    background: var(--p);
    color: var(--text-light);
    padding: 15px;
    font-size: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-hover);
    position: sticky;
    top: 0;
    z-index: 10;
}
header .title { flex-grow: 1; text-align: center; font-weight: 800; }
header button {
    background: none; 
    border: none; 
    color: var(--text-light); 
    font-size: 20px; 
    cursor: pointer; 
    padding: 0 10px;
    transition: transform 0.2s;
}
header button:hover { transform: scale(1.1); }

.tabs{
    display:flex;
    background: var(--card-bg);
    border-bottom: 2px solid var(--border-color);
    box-shadow: var(--shadow-light);
    overflow-x: auto; 
    white-space: nowrap;
}
.tabs button{
    flex: 1 1 auto; 
    min-width: 0; 
    padding: 15px 10px;
    border:none;
    background: var(--card-bg);
    color: var(--text-dark);
    font-weight: 700;
    font-size: 14px;
    transition: all 0.3s;
    border-bottom: 3px solid transparent;
}
.tabs button.active{
    color: var(--p);
    border-bottom: 3px solid var(--p);
    background: color-mix(in srgb, var(--bg) 90%, var(--p)); 
}
body.dark-mode .tabs button.active {
    background: color-mix(in srgb, var(--bg) 85%, var(--p)); 
}

/* ---------------------------------------------------- */
/* General Layout & Cards */
/* ---------------------------------------------------- */
.section{ display:none; padding: 15px; }
.section.active{ display:block; }
.card{
    background:var(--card-bg);
    padding: 20px;
    border-radius: 15px;
    box-shadow: var(--shadow-light);
    margin-bottom: 15px;
    border-top: 5px solid var(--s); 
    transition: background 0.3s, border-color 0.3s;
}

/* ---------------------------------------------------- */
/* Overview Section Styling (New Dashboard) */
/* ---------------------------------------------------- */
#overview .balance-display {
    text-align: center;
    padding: 30px 20px;
    margin-bottom: 20px;
    border-radius: 15px;
    background: var(--card-bg);
    box-shadow: var(--shadow-hover);
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    align-items: center;
}
#overview .balance-display h2 {
    margin: 0 0 5px 0;
    font-size: 18px;
    color: #999;
}
#overview .balance-display p {
    font-size: 38px;
    font-weight: 800;
    margin: 5px 0 0 0;
    color: var(--p);
    display: flex;
    align-items: center;
}
#overview .balance-display button {
    background: none;
    border: none;
    color: var(--p);
    font-size: 24px;
    cursor: pointer;
    margin-right: 10px;
    transition: color 0.2s;
}
#overview .balance-display button:hover {
    color: var(--s);
}
#overview .balance-actions {
    display: flex;
    gap: 15px;
    margin-top: 10px;
}
#overview .balance-actions .action {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    color: var(--text-dark);
    border-radius: 10px;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-light);
    transition: all 0.2s;
    background: var(--input-bg);
}
#overview .balance-actions .action:hover {
    box-shadow: var(--shadow-hover);
    transform: translateY(-2px);
    border-color: var(--p);
}
#overview .balance-actions .action i {
    font-size: 24px;
    margin-bottom: 5px;
}
#overview .balance-actions .deposit i { color: var(--success); }
#overview .balance-actions .withdraw i { color: var(--danger); }

/* ---------------------------------------------------- */
/* Form Elements & Inputs */
/* ---------------------------------------------------- */
input, select, .datetime-container input[type="datetime-local"] {
    width: 100%;
    padding: 14px;
    margin: 8px 0;
    font-size: 16px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    box-sizing: border-box;
    background: var(--input-bg);
    color: var(--text-dark);
    transition: all 0.3s;
}
input:focus, select:focus, .datetime-container input[type="datetime-local"]:focus {
    border-color: var(--s);
    box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.2);
    outline: none;
}

.datetime-container { position: relative; width: 100%; margin: 8px 0; }
.datetime-container input[type="datetime-local"] { margin: 0; padding-left: 40px; }

.calendar-icon {
    position: absolute;
    top: 50%;
    left: 15px; 
    transform: translateY(-50%);
    font-size: 1.4em;
    z-index: 2;
    pointer-events: none; 
    color: var(--p); 
}

/* ---------------------------------------------------- */
/* Buttons & Actions */
/* ---------------------------------------------------- */
button.action{
    background: var(--p);
    color: var(--text-light);
    border: none;
    padding: 16px;
    width: 100%;
    border-radius: 10px;
    font-size: 18px;
    font-weight: bold;
    margin-top: 10px;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
    box-shadow: var(--shadow-light);
}
button.action:hover{
    background: color-mix(in srgb, var(--p) 85%, black); 
    transform: translateY(-2px);
}

button.secondary{
    background: var(--input-bg);
    color: var(--text-dark);
    padding: 12px;
    width: 100%;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    margin-top: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s;
}

/* ---------------------------------------------------- */
/* Utility & Custom Elements */
/* ---------------------------------------------------- */
.toast{
    position:fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: var(--text-light);
    padding: 12px 25px;
    border-radius: 30px;
    display:none;
    z-index: 100;
    font-size: 15px;
    box-shadow: var(--shadow-hover);
    white-space: nowrap;
}

.currency-symbol { color: var(--p); font-weight: bold; font-size: 1.1em; margin-right: 5px; }
.hidden-balance { font-size: 38px; font-weight: 800; letter-spacing: 5px; color: var(--p); }

/* ---------------------------------------------------- */
/* Modals and Sidebar Refinements */
/* ---------------------------------------------------- */
.modal{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background: var(--bg);
    display:none;
    flex-direction:column;
    z-index: 30;
    overflow-y: auto;
}
.modal header{
    display:flex;
    gap: 10px;
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    background: var(--card-bg);
    align-items: center;
    box-shadow: var(--shadow-light);
    position: sticky;
    top: 0;
    z-index: 35;
}
.modal header .title { flex-grow: 1; text-align: center; font-weight: 700; }
.modal header button {
    background: none; 
    border: none; 
    color: var(--text-dark); 
    font-size: 20px; 
    cursor: pointer; 
    padding: 0 10px;
}
.modal-content {
    flex-grow: 1;
    padding: 15px;
}

.sidebar {
    position: fixed;
    top: 0;
    right: 0; 
    width: 300px; 
    max-width: 85%;
    height: 100%;
    background: var(--card-bg);
    box-shadow: -4px 0 12px rgba(0, 0, 0, 0.2);
    transform: translateX(100%); 
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
    z-index: 25; 
    display: flex;
    flex-direction: column;
}
.sidebar.open { transform: translateX(0); }

/* Switch Style (Dark Mode) */
.switch-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    font-size: 17px;
    color: var(--text-dark);
}
.switch { position: relative; display: inline-block; width: 45px; height: 25px; }
.switch input {opacity: 0; width: 0; height: 0;}
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: var(--border-color); transition: .4s; border-radius: 25px;
}
.slider:before {
    position: absolute; content: ""; height: 19px; width: 19px; left: 3px; bottom: 3px;
    background-color: white; transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: var(--p); }
input:checked + .slider:before { transform: translateX(20px); }

.sidebar-header {
    padding: 15px;
    background: var(--p);
    color: var(--text-light);
    font-size: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
}
.sidebar-content {
    flex-grow: 1;
    padding: 15px 0;
    overflow-y: auto;
}

.sidebar-menu-item {
    padding: 15px 20px;
    margin: 5px 0;
    display: flex;
    align-items: center;
    justify-content: space-between; 
    gap: 15px;
    font-size: 17px;
    color: var(--text-dark);
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
}

.sidebar-menu-item:hover {
    background: var(--s);
    color: var(--text-dark); 
}

.sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    z-index: 24;
}
.sidebar-overlay.open { display: block; }

/* Small Image Source Modal */
#imageSourceModal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80%;
    max-width: 350px;
    height: auto;
    background: var(--card-bg);
    border-radius: 15px;
    box-shadow: var(--shadow-hover);
    padding: 20px;
    z-index: 150;
    display: none;
    flex-direction: column;
    align-items: center;
}

/* List Item */
.list-item{
    background: var(--card-bg);
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    border-right: 5px solid var(--s); 
    color: var(--text-dark);
}
.list-item .details {
    font-size: 0.9em; 
    color: #666; 
    text-align: right;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 5px;
}

@media (max-width: 450px) {
    .tabs button {
        padding: 15px 5px; 
        font-size: 13px;
    }
}
</style>
</head>

<body>

<header>
    <button onclick="openSidebar()"><i class="fas fa-bars"></i></button> 
    <span class="title">Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</span>
    <button style="visibility: hidden;"><i class="fas fa-search"></i></button> 
</header>

<div class="tabs">
    <button class="active" onclick="openTab('overview')">
        <i class="fas fa-tachometer-alt" style="margin-left: 5px;"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©
    </button>
    <button onclick="openTab('expenses')">
        <i class="fas fa-money-bill-wave" style="margin-left: 5px;"></i> Ù…ØµØ±ÙˆÙØ§Øª
    </button>
    <button onclick="openTab('rights')">
        <i class="fas fa-handshake" style="margin-left: 5px;"></i> Ø­Ù‚ÙˆÙ‚
    </button>
    <button onclick="openTab('debts')">
        <i class="fas fa-file-invoice" style="margin-left: 5px;"></i> Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    </button>
</div>

<div id="overview" class="section active">
    <div class="balance-display">
        <h2>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
        <p id="currentBalanceDisplay"><i class="fas fa-spinner fa-spin"></i></p>
        <button onclick="toggleBalanceVisibility()" id="balanceVisibilityToggle">
             <i class="fas fa-eye"></i>
        </button>
    </div>

    <div class="balance-actions">
        <button class="action deposit" onclick="openBalanceActionModal('deposit')">
            <i class="fas fa-plus-circle"></i> Ø¥ÙŠØ¯Ø§Ø¹
        </button>
        <button class="action withdraw" onclick="openBalanceActionModal('withdraw')">
            <i class="fas fa-minus-circle"></i> Ø³Ø­Ø¨
        </button>
    </div>
    
    <button class="secondary" onclick="openBalanceLogModal()" style="margin-top: 15px; width: 100%;">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯
    </button>

    <div class="card" style="margin-top: 20px; border-top: 5px solid var(--p);">
        <h3 style="color: var(--p); margin-top: 0;"><i class="fas fa-calculator" style="margin-left: 5px;"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
        <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</span> <b id="sExpTotal">0</b></p>
        <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©:</span> <b id="sRigTotal">0</b></p>
        <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©:</span> <b id="sDebTotal">0</b></p>
        <p><span>Ø§Ù„Ù…Ø­ØµÙ„ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ‚:</span> <b id="sRigPaid">0</b></p>
        <p><span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª:</span> <b id="sDebPaid">0</b></p>
    </div>
</div>

<div id="expenses" class="section">
    <div class="card">
    <p style="color: var(--danger); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡Ø§ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙˆØ±Ø§Ù‹</p>
    <input id="eAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" inputmode="decimal">
    <select id="eType">
    <option value="">ğŸ›’ Ø§Ù„ÙØ¦Ø© (Ù†ÙÙ‚Ø§Øª Ù…ØªØºÙŠØ±Ø©)</option>
    <option>Ø·Ø¹Ø§Ù…</option><option>Ù…ÙˆØ§ØµÙ„Ø§Øª</option>
    <option>Ø±Ø¹Ø§ÙŠØ© Ø´Ø®ØµÙŠØ©</option><option>Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
    <option>ØµØ­Ø©</option><option>ØªØ±ÙÙŠÙ‡</option><option>ØªØ³ÙˆÙ‚</option>
    <option>ØªØ¹Ù„ÙŠÙ…</option><option>ØµÙŠØ§Ù†Ø© ÙˆØ¥ØµÙ„Ø§Ø­</option><option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="eDesc" placeholder="ğŸ“ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
    <div class="datetime-container">
        <input id="eDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    
    <button class="secondary" onclick="showImageSourceModal()" style="width: 100%;">
        <i class="fas fa-camera" style="margin-left: 5px;"></i> Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©
    </button>
    <span id="eImgName" style="display: block; font-size: 0.8em; color: var(--success); text-align: right; margin-top: 5px;"></span>
    <input type="file" id="eImgCamera" accept="image/*" capture="camera" style="display: none;" onchange="updateFileName(this, 'eImgName')">
    <input type="file" id="eImgGallery" accept="image/*" style="display: none;" onchange="updateFileName(this, 'eImgName')">
    
    <button class="action" onclick="addExpense()">Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
    <button class="secondary" onclick="openLog('exp')" style="width: 100%;">Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
    </div>
</div>

<div id="rights" class="section">
    <div class="card">
    <p style="color: var(--success); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„Ø© ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ</p>
    <select id="rType" onchange="updateRightFields(this.value)">
    <option value="">ğŸ¤ Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚</option>
    <option>Ø¯ÙŠÙ†</option>
    <option>Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„</option>
    <option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="rAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚" oninput="formatAmount(this)" inputmode="decimal">
    <div id="rDynamicFields"></div>
    <input id="rDesc" placeholder="ğŸ‘¤ ÙˆØµÙ (Ø§Ù„Ù…Ø¯ÙŠÙ†/Ø§Ù„Ø¬Ù‡Ø©)">
    <div class="datetime-container">
        <input id="rDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    <select id="rStatus">
    <option value="">âœ… Ø§Ù„Ø­Ø§Ù„Ø©</option>
    <option value="ÙƒØ§Ù…Ù„">Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</option>
    <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ Ø¨Ø¹Ø¯</option>
    </select>
    <button class="action" onclick="addRight()">Ø­ÙØ¸ Ø§Ù„Ø­Ù‚</button>
    <button class="secondary" onclick="openLog('rig')" style="width: 100%;">Ø³Ø¬Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ‚</button>
    </div>
</div>

<div id="debts" class="section">
    <div class="card">
    <p style="color: var(--danger); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø¯ÙØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ</p>
    <select id="dType" onchange="updateDebtFields(this.value)">
    <option value="">ğŸ§¾ Ù†ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</option>
    <option>Ø¥ÙŠØ¬Ø§Ø±</option><option>ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option><option>Ù…Ø§Ø¡</option>
    <option>Ø¥Ù†ØªØ±Ù†Øª</option><option>Ù‚Ø±Ø¶</option><option>Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ</option>
    <option>Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø© Ø£Ø®Ø±Ù‰</option><option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="dAmount" type="text" placeholder="ğŸ’µ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©/Ø§Ù„Ù‚Ø³Ø·" oninput="formatAmount(this)" inputmode="decimal">
    <div id="dDynamicFields"></div>
    <input id="dDesc" placeholder="ğŸ¢ ÙˆØµÙ (Ø§Ù„Ø¯Ø§Ø¦Ù†/Ø§Ù„Ø¬Ù‡Ø©)">
    <div class="datetime-container">
        <input id="dDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    <select id="dStatus">
    <option value="">âœ… Ø§Ù„Ø­Ø§Ù„Ø©</option>
    <option value="Ù…Ø¯ÙÙˆØ¹">Ù…Ø¯ÙÙˆØ¹</option>
    <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
    </select>
    <button class="action" onclick="addDebt()">Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</button>
    <button class="secondary" onclick="openLog('deb')" style="width: 100%;">Ø³Ø¬Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</button>
    </div>
</div>

<div class="modal" id="logModal">
    <header>
        <input id="search" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„..." oninput="renderLog()">
        <button onclick="closeLayer('log')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content" id="logContent"></div>
</div>

<div class="modal" id="detailModal">
    <header>
        <span class="title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</span>
        <button onclick="closeLayer('detail')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content detail" id="detailContent"></div>
</div>

<div class="modal" id="balanceActionModal">
    <header>
        <span class="title" id="actionModalTitle"></span>
        <button onclick="closeLayer('balanceAction')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <p style="text-align: center;">Ø±ØµÙŠØ¯Ùƒ: <span id="currentBalanceInAction" style="font-weight: bold; color: var(--p);"></span></p>
        <input id="bAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" inputmode="decimal">
        <input id="bDesc" placeholder="ğŸ“ ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©">
        <div class="datetime-container">
            <input id="bDate" type="datetime-local">
            <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
        </div>
        <button class="action" onclick="processBalanceAction()">ØªÙ†ÙÙŠØ°</button>
    </div>
</div>

<div class="modal" id="balanceLogModal">
    <header>
        <span class="title">Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯</span>
        <button onclick="closeLayer('balanceLog')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content" id="balanceLogContent"></div>
</div>

<div class="sidebar-overlay" onclick="closeLayer('sidebar')"></div>
<div class="sidebar" id="appSidebar">
    <div class="sidebar-header">
        <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        <button onclick="closeLayer('sidebar')"><i class="fas fa-times"></i></button>
    </div>
    <div class="sidebar-content">
        <div class="card" style="margin: 15px;">
             <div class="switch-container">
                 <span>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span>
                 <label class="switch">
                     <input type="checkbox" id="darkModeToggle" onclick="toggleDarkMode()">
                     <span class="slider"></span>
                 </label>
             </div>
             <button class="secondary" onclick="openCurrencyModal()" style="width: 100%; border:none; margin-top:10px;">
                 <span id="currentCurrencyDisplay">Ø§Ù„Ø¹Ù…Ù„Ø©: Ø±.Ø³</span>
             </button>
        </div>
        <div class="sidebar-menu-item" onclick="exportData()"><i class="fas fa-file-export"></i> ØªØµØ¯ÙŠØ± (JSON)</div>
        <div class="sidebar-menu-item" onclick="document.getElementById('importFile').click()"><i class="fas fa-file-import"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ (JSON)</div>
        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
        <div class="sidebar-menu-item" onclick="confirmResetData()" style="color: var(--danger);"><i class="fas fa-trash"></i> Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
    </div>
</div>

<div id="imageSourceModal">
    <h3>Ù…ØµØ¯Ø± Ø§Ù„ØµÙˆØ±Ø©</h3>
    <button class="action" onclick="openCameraInput()">Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
    <button class="secondary" onclick="openGalleryInput()" style="width: 100%;">Ø§Ù„Ù…Ø¹Ø±Ø¶</button>
    <button class="secondary" onclick="closeLayer('imageSource')" style="border:none;">Ø¥Ù„ØºØ§Ø¡</button>
</div>
<div class="sidebar-overlay" id="imageSourceOverlay" style="z-index: 140;" onclick="closeLayer('imageSource')"></div>
<div class="toast" id="toast"></div>

<script>
// ===================================================
// Core Logic & Database
// ===================================================
const IDB_NAME = "MySmartBudgetDB";
const IDB_VERSION = 4;
const STORE_NAMES = ["exp", "rig", "deb", "bal"];
let db = { exp: [], rig: [], deb: [], bal: { clientId: 1, amount: 0, changes: [] } };
let IDB_connection = null;
let currentCurrency = { code: 'SAR', symbol: 'Ø±.Ø³', name: 'Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ' };
let currentLog = "", editMode = null, balanceActionType = null, currentBalance = 0;
let balanceHidden = localStorage.getItem('balanceHidden') === 'true';
let historyStack = [];

const LAYERS = {
    'sidebar': { elementId: 'appSidebar', type: 'menu' },
    'log': { elementId: 'logModal', type: 'modal' },
    'detail': { elementId: 'detailModal', type: 'modal' },
    'balanceAction': { elementId: 'balanceActionModal', type: 'modal' },
    'balanceLog': { elementId: 'balanceLogModal', type: 'modal' },
    'imageSource': { elementId: 'imageSourceModal', type: 'menu' }
};

// ===================================================
// Database Functions
// ===================================================
function initDB() {
    return new Promise((resolve) => {
        const request = indexedDB.open(IDB_NAME, IDB_VERSION);
        request.onupgradeneeded = (e) => {
            let conn = e.target.result;
            STORE_NAMES.forEach(s => {
                if (!conn.objectStoreNames.contains(s)) {
                    conn.createObjectStore(s, { keyPath: (s==='bal'?'clientId':'id'), autoIncrement: (s!=='bal') });
                }
            });
        };
        request.onsuccess = (e) => {
            IDB_connection = e.target.result;
            loadAllData().then(resolve);
        };
    });
}

async function loadAllData() {
    for (let s of STORE_NAMES) {
        const trans = IDB_connection.transaction([s], "readonly");
        const store = trans.objectStore(s);
        const req = store.getAll();
        await new Promise(r => req.onsuccess = (e) => {
            if (s === 'bal') {
                db.bal = e.target.result[0] || { clientId: 1, amount: 0, changes: [] };
                currentBalance = db.bal.amount;
            } else {
                db[s] = e.target.result.reverse();
            }
            r();
        });
    }
    updateBalanceDisplay();
    updateStats();
}

async function saveData(storeName, data) {
    const trans = IDB_connection.transaction([storeName], "readwrite");
    const store = trans.objectStore(storeName);
    return new Promise(r => {
        const req = store.put(data);
        req.onsuccess = () => r(req.result);
    });
}

// ===================================================
// UI & Formatting Functions
// ===================================================
function formatAmount(input) {
    let val = input.value.replace(/[^\d.]/g, '');
    let parts = val.split('.');
    if (parts.length > 2) val = parts[0] + '.' + parts.slice(1).join('');
    let num = parseFloat(parts[0]);
    input.value = (isNaN(num) ? '' : num.toLocaleString('ar')) + (parts[1] !== undefined ? '.' + parts[1] : '');
}

function parseAmount(val) {
    if (!val) return 0;
    let s = String(val).replace(/[ØŒ\u066c]/g, '').replace(/[^\d.]/g, '');
    s = s.replace(/([Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©])/g, d => d.charCodeAt(0) - 1632);
    return parseFloat(s) || 0;
}

function getFormattedAmount(num) {
    return num.toLocaleString('ar', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
}

function formatCurrency(amount, withColor = false) {
    if (balanceHidden) return '<span class="hidden-balance">***</span>';
    let num = parseAmount(amount);
    let color = withColor ? (num > 0 ? 'var(--success)' : (num < 0 ? 'var(--danger)' : '')) : '';
    return `<span style="color:${color}">${getFormattedAmount(num)} <small class="currency-symbol">${currentCurrency.symbol}</small></span>`;
}

function formatDateTime(dateStr) {
    if (!dateStr) return 'â€”';
    return new Date(dateStr).toLocaleString('ar-EG', { year:'numeric', month:'short', day:'numeric', hour:'numeric', minute:'2-digit' });
}

// ===================================================
// Logic & CRUD
// ===================================================
async function processBalanceChange(amount, type, desc, recordId, isEdit = false, oldAmt = 0) {
    let amt = parseAmount(amount);
    let net = (['expense', 'debt_payment', 'withdraw'].includes(type)) ? amt * -1 : amt;
    let diff = isEdit ? (net - oldAmt) : net;

    currentBalance += diff;
    db.bal.amount = currentBalance;
    
    let entry = { id: recordId, Ø§Ù„ØªØ§Ø±ÙŠØ®: new Date().toISOString().slice(0, 16), Ø§Ù„Ù†ÙˆØ¹: desc, Ø§Ù„Ù…Ø¨Ù„Øº: amt, Ø§Ù„Ù‚ÙŠÙ…Ø©_Ø§Ù„ØµØ§ÙÙŠØ©: net, Ø§Ù„Ø±ØµÙŠØ¯_Ø¨Ø¹Ø¯_Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: currentBalance };
    let idx = db.bal.changes.findIndex(c => c.id === recordId);
    if (idx > -1) db.bal.changes[idx] = entry; else db.bal.changes.unshift(entry);

    await saveData('bal', db.bal);
    updateBalanceDisplay();
}

async function addExpense() {
    const amt = document.getElementById('eAmount').value;
    const type = document.getElementById('eType').value;
    const date = document.getElementById('eDate').value;
    if (!amt || !type || !date) return toastMsg("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©");

    const isEdit = editMode && editMode.type === 'exp';
    const oldData = isEdit ? db.exp[editMode.index] : {};
    const oldNet = isEdit ? parseAmount(oldData.Ø§Ù„Ù…Ø¨Ù„Øº) * -1 : 0;

    let data = {
        id: isEdit ? oldData.id : undefined,
        clientId: isEdit ? oldData.clientId : `exp-${Date.now()}`,
        Ø§Ù„Ù…Ø¨Ù„Øº: getFormattedAmount(parseAmount(amt)),
        Ø§Ù„ÙØ¦Ø©: type,
        Ø§Ù„ÙˆØµÙ: document.getElementById('eDesc').value,
        Ø§Ù„ØªØ§Ø±ÙŠØ®: date
    };

    const file = document.getElementById('eImgCamera').files[0] || document.getElementById('eImgGallery').files[0];
    if (file) {
        data.ØµÙˆØ±Ø© = await new Promise(r => { let fr = new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(file); });
    } else if (isEdit) data.ØµÙˆØ±Ø© = oldData.ØµÙˆØ±Ø©;

    await saveData('exp', data);
    await processBalanceChange(amt, 'expense', `Ù…ØµØ±ÙˆÙ: ${type}`, data.clientId, isEdit, oldNet);
    toastMsg("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­");
    finishAction('exp');
}

async function addRight() {
    const amt = document.getElementById('rAmount').value;
    const type = document.getElementById('rType').value;
    if (!amt || !type) return toastMsg("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

    const isEdit = editMode && editMode.type === 'rig';
    const oldData = isEdit ? db.rig[editMode.index] : {};
    const oldCollected = isEdit ? parseAmount(oldData.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø­ØµÙ„ || 0) : 0;

    let collected = 0;
    if (type === 'Ø¯ÙŠÙ†') {
        collected = parseAmount(document.getElementById('rPaidAmount').value);
    } else {
        collected = (document.getElementById('rStatus').value === 'ÙƒØ§Ù…Ù„') ? parseAmount(amt) : 0;
    }

    let data = {
        id: isEdit ? oldData.id : undefined,
        clientId: isEdit ? oldData.clientId : `rig-${Date.now()}`,
        Ø§Ù„Ù†ÙˆØ¹: type,
        Ø§Ù„Ù…Ø¨Ù„Øº: getFormattedAmount(parseAmount(amt)),
        Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø­ØµÙ„: collected,
        Ø§Ù„ÙˆØµÙ: document.getElementById('rDesc').value,
        Ø§Ù„ØªØ§Ø±ÙŠØ®: document.getElementById('rDate').value,
        Ø§Ù„Ø­Ø§Ù„Ø©: (collected >= parseAmount(amt)) ? "Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„" : (collected > 0 ? "Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹" : "ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹")
    };

    await saveData('rig', data);
    await processBalanceChange(collected, 'deposit', `ØªØ­ØµÙŠÙ„: ${type}`, data.clientId, isEdit, oldCollected);
    finishAction('rig');
}

async function addDebt() {
    const type = document.getElementById('dType').value;
    if (!type) return toastMsg("Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…");

    const isEdit = editMode && editMode.type === 'deb';
    const oldData = isEdit ? db.deb[editMode.index] : {};
    const oldPaid = isEdit ? parseAmount(oldData.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¯ÙÙˆØ¹ || 0) * -1 : 0;

    let totalAmt = 0, paidAmt = 0;
    if (['Ù‚Ø±Ø¶', 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ'].includes(type)) {
        totalAmt = parseAmount(document.getElementById('dTotalAmount').value);
        if (type === 'Ù‚Ø±Ø¶') {
             let install = parseAmount(document.getElementById('dInstallments').value) || 1;
             let count = parseAmount(document.getElementById('dPaidInstallments').value);
             paidAmt = (totalAmt / install) * count;
        } else paidAmt = parseAmount(document.getElementById('dPaidAmount').value);
    } else {
        totalAmt = parseAmount(document.getElementById('dAmount').value);
        paidAmt = (document.getElementById('dStatus').value === 'Ù…Ø¯ÙÙˆØ¹') ? totalAmt : 0;
    }

    let data = {
        id: isEdit ? oldData.id : undefined,
        clientId: isEdit ? oldData.clientId : `deb-${Date.now()}`,
        Ø§Ù„Ù†ÙˆØ¹: type,
        Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ: getFormattedAmount(totalAmt),
        Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¯ÙÙˆØ¹: paidAmt,
        Ø§Ù„ÙˆØµÙ: document.getElementById('dDesc').value,
        Ø§Ù„ØªØ§Ø±ÙŠØ®: document.getElementById('dDate').value,
        Ø§Ù„Ø­Ø§Ù„Ø©: (paidAmt >= totalAmt && totalAmt > 0) ? "Ù…Ø¯ÙÙˆØ¹" : "ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"
    };

    await saveData('deb', data);
    await processBalanceChange(paidAmt, 'withdraw', `Ø¯ÙØ¹: ${type}`, data.clientId, isEdit, oldPaid);
    finishAction('deb');
}

// ===================================================
// Navigation & Modals
// ===================================================
function openTab(id) {
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    const btn = document.querySelector(`.tabs button[onclick*="${id}"]`);
    if(btn) btn.classList.add("active");
    if(id==='overview') updateStats();
    clearFields();
    editMode = null;
}

function openLayer(name, data = {}) {
    const l = LAYERS[name];
    const el = document.getElementById(l.elementId);
    if (l.type === 'modal') {
        el.style.display = 'flex';
        if(name==='log') { currentLog = data.logType; renderLog(); }
        if(name==='detail') renderDetail(data.logType, data.id);
        if(name==='balanceAction') {
            balanceActionType = data.actionType;
            document.getElementById('actionModalTitle').innerText = (data.actionType==='deposit'?'Ø¥ÙŠØ¯Ø§Ø¹':'Ø³Ø­Ø¨');
            document.getElementById('currentBalanceInAction').innerHTML = formatCurrency(currentBalance);
        }
    } else el.classList.add('open');
    history.pushState({layer: name}, null);
}

function closeLayer(name) {
    const l = LAYERS[name];
    const el = document.getElementById(l.elementId);
    if (l.type === 'modal') el.style.display = 'none'; else el.classList.remove('open');
}

window.onpopstate = () => {
    Object.keys(LAYERS).forEach(name => closeLayer(name));
};

// ===================================================
// Helpers
// ===================================================
function finishAction(type) {
    loadAllData().then(() => {
        closeLayer('detail');
        closeLayer('log');
        toastMsg("ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­");
        openTab('overview');
    });
}

function updateStats() {
    let e = 0, r = 0, d = 0, rp = 0, dp = 0;
    db.exp.forEach(i => e += parseAmount(i.Ø§Ù„Ù…Ø¨Ù„Øº));
    db.rig.forEach(i => { r += parseAmount(i.Ø§Ù„Ù…Ø¨Ù„Øº); rp += parseAmount(i.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø­ØµÙ„); });
    db.deb.forEach(i => { d += parseAmount(i.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ); dp += parseAmount(i.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¯ÙÙˆØ¹); });
    
    document.getElementById('sExpTotal').innerHTML = formatCurrency(e);
    document.getElementById('sRigTotal').innerHTML = formatCurrency(r);
    document.getElementById('sDebTotal').innerHTML = formatCurrency(d);
    document.getElementById('sRigPaid').innerHTML = formatCurrency(rp);
    document.getElementById('sDebPaid').innerHTML = formatCurrency(dp);
}

function updateBalanceDisplay() {
    document.getElementById("currentBalanceDisplay").innerHTML = formatCurrency(currentBalance);
    document.getElementById('balanceVisibilityToggle').innerHTML = balanceHidden ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
}

function toggleBalanceVisibility() {
    balanceHidden = !balanceHidden;
    localStorage.setItem('balanceHidden', balanceHidden);
    updateBalanceDisplay();
}

function updateRightFields(type) {
    const div = document.getElementById('rDynamicFields');
    div.innerHTML = (type === 'Ø¯ÙŠÙ†') ? `<input id="rPaidAmount" type="text" placeholder="ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø­Ø§Ù„ÙŠØ§Ù‹" oninput="formatAmount(this)">` : '';
}

function updateDebtFields(type) {
    const div = document.getElementById('dDynamicFields');
    const amtInput = document.getElementById('dAmount');
    if (['Ù‚Ø±Ø¶', 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ'].includes(type)) {
        amtInput.style.display = 'none';
        div.innerHTML = `<input id="dTotalAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ" oninput="formatAmount(this)">` +
            (type==='Ù‚Ø±Ø¶' ? `<input id="dInstallments" type="number" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·"><input id="dPaidInstallments" type="number" placeholder="Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©">` : `<input id="dPaidAmount" type="text" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹" oninput="formatAmount(this)">`);
    } else {
        amtInput.style.display = 'block';
        div.innerHTML = '';
    }
}

function renderLog() {
    const content = document.getElementById('logContent');
    const q = document.getElementById('search').value.toLowerCase();
    const items = db[currentLog].filter(i => JSON.stringify(i).toLowerCase().includes(q));
    content.innerHTML = items.map(i => `
        <div class="list-item" onclick="openLayer('detail', {logType:'${currentLog}', id:${i.id}})">
            <div style="display:flex; justify-content:space-between; font-weight:bold;">
                <span>${i.Ø§Ù„ÙˆØµÙ || i.Ø§Ù„ÙØ¦Ø© || i.Ø§Ù„Ù†ÙˆØ¹}</span>
                <span>${formatCurrency(i.Ø§Ù„Ù…Ø¨Ù„Øº || i.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ)}</span>
            </div>
            <div class="details"><span>${formatDateTime(i.Ø§Ù„ØªØ§Ø±ÙŠØ®)}</span> <span>${i.Ø§Ù„Ø­Ø§Ù„Ø© || ''}</span></div>
        </div>
    `).join('') || '<p style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
}

function renderDetail(type, id) {
    const item = db[type].find(x => x.id == id);
    editMode = { type, index: db[type].indexOf(item) };
    let html = `<div class="card">`;
    for(let [k, v] of Object.entries(item)) {
        if(['id', 'clientId', 'ØµÙˆØ±Ø©'].includes(k)) continue;
        html += `<p><strong>${k.replace('_', ' ')}:</strong> ${k.includes('Ø§Ù„Ù…Ø¨Ù„Øº') ? formatCurrency(v) : v}</p>`;
    }
    if(item.ØµÙˆØ±Ø©) html += `<img src="${item.ØµÙˆØ±Ø©}" style="width:100%; border-radius:10px; margin-top:10px;">`;
    html += `<div style="display:flex; gap:10px; margin-top:15px;">
        <button class="secondary" onclick="editEntry()" style="flex:1;">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="action" onclick="deleteEntry()" style="flex:1; background:var(--danger);">Ø­Ø°Ù</button>
    </div></div>`;
    document.getElementById('detailContent').innerHTML = html;
}

function editEntry() {
    const item = db[editMode.type][editMode.index];
    closeLayer('detail'); closeLayer('log');
    openTab(editMode.type==='exp'?'expenses':(editMode.type==='rig'?'rights':'debts'));
    setTimeout(() => {
        if(editMode.type==='exp') {
            document.getElementById('eAmount').value = item.Ø§Ù„Ù…Ø¨Ù„Øº;
            document.getElementById('eType').value = item.Ø§Ù„ÙØ¦Ø©;
            document.getElementById('eDesc').value = item.Ø§Ù„ÙˆØµÙ;
            document.getElementById('eDate').value = item.Ø§Ù„ØªØ§Ø±ÙŠØ®;
        }
        // ... ØªÙØ¹ÙŠÙ„ Ø¨Ù‚ÙŠØ© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ù†ÙØ³ Ø§Ù„Ù†Ù…Ø·
    }, 100);
}

async function deleteEntry() {
    if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…Ø¨Ù„Øº ÙÙŠ Ø§Ù„Ø±ØµÙŠØ¯.")) return;
    const item = db[editMode.type][editMode.index];
    const trans = IDB_connection.transaction([editMode.type, 'bal'], "readwrite");
    trans.objectStore(editMode.type).delete(item.id);
    
    const balIdx = db.bal.changes.findIndex(c => c.id === item.clientId);
    if(balIdx > -1) {
        currentBalance -= db.bal.changes[balIdx].Ø§Ù„Ù‚ÙŠÙ…Ø©_Ø§Ù„ØµØ§ÙÙŠØ©;
        db.bal.changes.splice(balIdx, 1);
        db.bal.amount = currentBalance;
        trans.objectStore('bal').put(db.bal);
    }
    finishAction();
}

// System Init
function toastMsg(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none', 2000); }
function clearFields() { document.querySelectorAll('input').forEach(i=>i.value=''); document.querySelectorAll('select').forEach(s=>s.selectedIndex=0); }
function openSidebar() { openLayer('sidebar'); }
function showImageSourceModal() { openLayer('imageSource'); }
function openCameraInput() { document.getElementById('eImgCamera').click(); closeLayer('imageSource'); }
function openGalleryInput() { document.getElementById('eImgGallery').click(); closeLayer('imageSource'); }
function updateFileName(input, id) { document.getElementById(id).innerText = input.files[0]?.name || ''; }
function toggleDarkMode() { document.body.classList.toggle('dark-mode'); localStorage.setItem('darkMode', document.body.classList.contains('dark-mode')); }

window.onload = () => {
    initDB().then(() => {
        if(localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            document.getElementById('darkModeToggle').checked = true;
        }
    });
};
</script>
</body>
</html>
