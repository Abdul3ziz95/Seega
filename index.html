<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ© | Smart Budget</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">

<style>
/* ---------------------------------------------------- */
/* Variables and Base Styling */
/* ---------------------------------------------------- */
:root{
    --p: #0077b6; --s: #48cae4; --bg: #f7f9fc; 
    --danger: #ef476f; --success: #2a9d8f; --warning: #fbc02d;
    --text-dark: #333; --text-light: #f7f9fc;
    --shadow-light: 0 4px 8px rgba(0, 0, 0, 0.08);
    --shadow-hover: 0 6px 15px rgba(0, 0, 0, 0.15);
    --card-bg: #fff; --input-bg: #fff; --border-color: #ddd;
}

body.dark-mode {
    --p: #90e0ef; --s: #48cae4; --bg: #1f1f1f; 
    --danger: #ff8a80; --success: #66bb6a; --warning: #fbc02d;
    --text-dark: #e0e0e0; --text-light: #1f1f1f;
    --card-bg: #2d2d2d; --input-bg: #3c3c3c; --border-color: #555;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body{
    margin:0; font-family: 'Tajawal', sans-serif;
    background: var(--bg); color: var(--text-dark);
    line-height: 1.6; transition: 0.3s; padding-bottom: 20px;
}

/* Header */
header{
    background: var(--p); color: var(--text-light);
    padding: 15px; font-size: 18px; display: flex;
    justify-content: space-between; align-items: center;
    position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow-hover);
}
header button { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }

/* Tabs */
.tabs{ display:flex; background: var(--card-bg); border-bottom: 2px solid var(--border-color); overflow-x: auto; white-space: nowrap; }
.tabs button{
    flex: 1; padding: 15px 10px; border:none; background: none;
    color: var(--text-dark); font-weight: 700; font-size: 13px; cursor: pointer; min-width: 90px;
}
.tabs button.active{ color: var(--p); border-bottom: 3px solid var(--p); background: rgba(0,0,0,0.02); }

/* Layout */
.section{ display:none; padding: 15px; animation: fadeIn 0.3s; }
.section.active{ display:block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

.card{
    background:var(--card-bg); padding: 20px; border-radius: 15px;
    box-shadow: var(--shadow-light); margin-bottom: 15px; border-top: 5px solid var(--s);
}

/* Overview */
.balance-display {
    text-align: center; padding: 25px; background: var(--card-bg);
    border-radius: 15px; box-shadow: var(--shadow-hover); margin-bottom: 20px;
    border: 1px solid var(--border-color);
}
#currentBalanceDisplay { font-size: 34px; font-weight: 800; color: var(--p); margin: 10px 0; direction: ltr; }

.balance-actions { display: flex; gap: 10px; margin-top: 15px; }
.balance-actions .action { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 10px; font-size: 14px; background: var(--input-bg); color: var(--text-dark); border: 1px solid var(--border-color); border-radius: 10px; }
.balance-actions .action i { font-size: 20px; margin-bottom: 5px; }
.balance-actions .deposit i { color: var(--success); }
.balance-actions .withdraw i { color: var(--danger); }

/* Inputs */
input, select {
    width: 100%; padding: 14px; margin: 8px 0; border-radius: 10px;
    border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-dark);
    font-size: 16px; font-family: 'Tajawal', sans-serif;
}
input:focus, select:focus { border-color: var(--p); outline: none; box-shadow: 0 0 0 2px rgba(0,119,182,0.1); }

/* Buttons */
button.action {
    background: var(--p); color: white; border: none; padding: 15px;
    width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px;
}
button.secondary {
    background: var(--input-bg); color: var(--text-dark); border: 1px solid var(--border-color);
    padding: 12px; width: 100%; border-radius: 10px; cursor: pointer; margin-top: 8px; font-weight: bold;
}

/* Modals */
.modal{
    position:fixed; top:0; left:0; width:100%; height:100%;
    background: var(--bg); display:none; flex-direction:column; z-index: 200;
}
.modal header{ background: var(--card-bg); color: var(--text-dark); border-bottom: 1px solid var(--border-color); padding: 15px; display: flex; align-items: center; }
.modal header .title { flex-grow: 1; text-align: center; font-weight: bold; }
.modal-content { padding: 20px; overflow-y: auto; flex-grow: 1; }

/* Sidebar */
.sidebar {
    position: fixed; top: 0; right: 0; width: 280px; height: 100%;
    background: var(--card-bg); z-index: 300; transform: translateX(100%);
    transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: -5px 0 15px rgba(0,0,0,0.1);
    display: flex; flex-direction: column;
}
.sidebar.open { transform: translateX(0); }
.sidebar-header { padding: 20px; background: var(--p); color: white; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
.sidebar-menu-item { padding: 15px 20px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; align-items: center; gap: 10px; }

/* Utilities */
.toast {
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
    background: #333; color: white; padding: 12px 25px; border-radius: 30px;
    display: none; z-index: 10000; font-size: 14px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
.toast.show { display: block; animation: fadeInOut 2.5s forwards; }
@keyframes fadeInOut { 0% {opacity:0; transform: translate(-50%, 20px);} 10% {opacity:1; transform: translate(-50%, 0);} 90% {opacity:1;} 100% {opacity:0;} }

.list-item {
    background: var(--card-bg); padding: 15px; border-radius: 10px;
    margin-bottom: 10px; border-right: 5px solid var(--s); box-shadow: var(--shadow-light);
    cursor: pointer; transition: 0.2s;
}
.list-item .details { font-size: 12px; color: #888; margin-top: 5px; display: flex; justify-content: space-between; }
.currency-symbol { font-size: 0.8em; margin-right: 3px; }

/* Dark Mode Switch */
.switch { position: relative; display: inline-block; width: 50px; height: 26px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
.slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: var(--p); }
input:checked + .slider:before { transform: translateX(24px); }
</style>
</head>

<body>

<header>
    <button onclick="openLayer('sidebar')"><i class="fas fa-bars"></i></button> 
    <span class="title">Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ©</span>
    <button style="visibility: hidden;"><i class="fas fa-search"></i></button> 
</header>

<div class="tabs">
    <button class="active" onclick="openTab('overview', event)"><i class="fas fa-chart-pie"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</button>
    <button onclick="openTab('expenses', event)"><i class="fas fa-wallet"></i> Ù…ØµØ±ÙˆÙØ§Øª</button>
    <button onclick="openTab('rights', event)"><i class="fas fa-hand-holding-usd"></i> Ø­Ù‚ÙˆÙ‚</button>
    <button onclick="openTab('debts', event)"><i class="fas fa-file-invoice-dollar"></i> Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</button>
</div>

<div id="overview" class="section active">
    <div class="balance-display">
        <h2 style="font-size: 16px; color: #777; margin:0;">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
        <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
            <p id="currentBalanceDisplay">0.00</p>
            <button onclick="toggleBalanceVisibility()" id="balanceVisibilityToggle" style="color:var(--p); font-size: 18px; border:none; background:none;">
                 <i class="fas fa-eye"></i>
            </button>
        </div>
        
        <div class="balance-actions">
            <button class="action deposit" onclick="openBalanceActionModal('deposit')"><i class="fas fa-plus-circle"></i> Ø¥ÙŠØ¯Ø§Ø¹</button>
            <button class="action withdraw" onclick="openBalanceActionModal('withdraw')"><i class="fas fa-minus-circle"></i> Ø³Ø­Ø¨</button>
        </div>
    </div>
    
    <button class="secondary" onclick="openLayer('balanceLog')"><i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯</button>

    <div class="card" style="margin-top: 15px;">
        <h3 style="color:var(--p); margin-top:0"><i class="fas fa-chart-bar"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
        <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: <b id="sExpTotal">0</b></p>
        <p>Ø§Ù„Ù…Ø­ØµÙ„ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ‚: <b id="sRigPaid">0</b></p>
        <p>Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª: <b id="sDebPaid">0</b></p>
    </div>
</div>

<div id="expenses" class="section">
    <div class="card">
        <input id="eAmount" type="tel" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)">
        <select id="eType">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©</option>
            <option>Ø·Ø¹Ø§Ù…</option><option>Ù…ÙˆØ§ØµÙ„Ø§Øª</option><option>ÙÙˆØ§ØªÙŠØ±</option><option>ØªØ³ÙˆÙ‚</option><option>ØµØ­Ø©</option><option>Ø£Ø®Ø±Ù‰</option>
        </select>
        <input id="eDesc" placeholder="ğŸ“ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
        <input id="eDate" type="datetime-local">
        
        <button class="secondary" onclick="openLayer('imageSource')"><i class="fas fa-camera"></i> Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</button>
        <span id="eImgName" style="display:block; font-size:0.8em; color:var(--success); text-align:right;"></span>
        <input type="file" id="eImgCamera" accept="image/*" capture="camera" style="display:none" onchange="updateFileName(this, 'eImgName')">
        <input type="file" id="eImgGallery" accept="image/*" style="display:none" onchange="updateFileName(this, 'eImgName')">
        
        <button class="action" onclick="addExpense()">Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
        <button class="secondary" onclick="openLog('exp')">Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
    </div>
</div>

<div id="rights" class="section">
    <div class="card">
        <select id="rType" onchange="updateRightFields(this.value)">
            <option value="">Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚</option>
            <option value="Ø¯ÙŠÙ†">Ø¯ÙŠÙ† (Ù„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø§Ø³)</option>
            <option value="Ø¨ÙŠØ¹">Ø¨ÙŠØ¹ Ø¢Ø¬Ù„</option>
            <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
        </select>
        <input id="rAmount" type="tel" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚" oninput="formatAmount(this)">
        <div id="rDynamicFields"></div>
        <input id="rDesc" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ / Ø§Ù„Ø¬Ù‡Ø©">
        <input id="rDate" type="datetime-local">
        <select id="rStatus">
            <option value="">Ø§Ù„Ø­Ø§Ù„Ø©</option>
            <option value="ÙƒØ§Ù…Ù„">Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</option>
            <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
        </select>
        <button class="action" onclick="addRight()">Ø­ÙØ¸ Ø§Ù„Ø­Ù‚</button>
        <button class="secondary" onclick="openLog('rig')">Ø³Ø¬Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ‚</button>
    </div>
</div>

<div id="debts" class="section">
    <div class="card">
        <select id="dType" onchange="updateDebtFields(this.value)">
            <option value="">Ù†ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</option>
            <option value="Ù‚Ø³Ø·">ÙØ§ØªÙˆØ±Ø© / Ù‚Ø³Ø·</option>
            <option value="Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ">Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ</option>
        </select>
        <input id="dAmount" type="tel" placeholder="ğŸ’µ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…" oninput="formatAmount(this)">
        <div id="dDynamicFields"></div>
        <input id="dDesc" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯Ø§Ø¦Ù† / Ø§Ù„Ø¬Ù‡Ø©">
        <input id="dDate" type="datetime-local">
        <select id="dStatus">
            <option value="">Ø§Ù„Ø­Ø§Ù„Ø©</option>
            <option value="Ù…Ø¯ÙÙˆØ¹">Ù…Ø¯ÙÙˆØ¹</option>
            <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
        </select>
        <button class="action" onclick="addDebt()">Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</button>
        <button class="secondary" onclick="openLog('deb')">Ø³Ø¬Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</button>
    </div>
</div>

<div class="modal" id="logModal">
    <header><button onclick="closeLayer('log')"><i class="fas fa-times"></i></button><span class="title">Ø§Ù„Ø³Ø¬Ù„</span><div style="width:20px"></div></header>
    <div style="padding:10px"><input id="search" placeholder="Ø¨Ø­Ø«..." oninput="renderLog()"></div>
    <div class="modal-content" id="logContent"></div>
</div>

<div class="modal" id="detailModal">
    <header><button onclick="closeLayer('detail')"><i class="fas fa-times"></i></button><span class="title">Ø§Ù„ØªÙØ§ØµÙŠÙ„</span><div style="width:20px"></div></header>
    <div class="modal-content" id="detailContent"></div>
</div>

<div class="modal" id="balanceActionModal">
    <header><button onclick="closeLayer('balanceAction')"><i class="fas fa-times"></i></button><span class="title" id="actionModalTitle">Ø¥Ø¬Ø±Ø§Ø¡</span><div style="width:20px"></div></header>
    <div class="modal-content">
        <input id="bAmount" type="tel" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)">
        <input id="bDesc" placeholder="ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©">
        <input id="bDate" type="datetime-local">
        <button class="action" onclick="processBalanceAction()">ØªÙ†ÙÙŠØ°</button>
    </div>
</div>

<div class="modal" id="balanceLogModal">
    <header><button onclick="closeLayer('balanceLog')"><i class="fas fa-times"></i></button><span class="title">Ø³Ø¬Ù„ Ø§Ù„Ø±ØµÙŠØ¯</span><div style="width:20px"></div></header>
    <div class="modal-content" id="balanceLogContent"></div>
</div>

<div id="imageSourceModal" class="modal" style="background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
    <div class="card" style="width:80%; max-width:300px; padding:20px;">
        <h3 style="text-align:center; margin-top:0">Ù…ØµØ¯Ø± Ø§Ù„ØµÙˆØ±Ø©</h3>
        <button class="action" onclick="openCameraInput()">Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
        <button class="secondary" onclick="openGalleryInput()">Ø§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ</button>
        <button class="secondary" style="border:none; color:red" onclick="closeLayer('imageSource')">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<div class="sidebar-overlay" id="mainOverlay" onclick="closeLayer('sidebar')"></div>
<div class="sidebar" id="appSidebar">
    <div class="sidebar-header"><span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span><button onclick="closeLayer('sidebar')" style="background:none; border:none; color:white; font-size:20px"><i class="fas fa-times"></i></button></div>
    <div class="sidebar-menu-item">
        <span>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span>
        <label class="switch"><input type="checkbox" id="darkModeToggle" onclick="toggleDarkMode()"><span class="slider"></span></label>
    </div>
    <div class="sidebar-menu-item" onclick="openLayer('currency')"><span>ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø©</span><i class="fas fa-chevron-left"></i></div>
    <div class="sidebar-menu-item" onclick="exportData()"><span>ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span><i class="fas fa-file-export"></i></div>
    <label class="sidebar-menu-item"><span>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</span><input type="file" hidden onchange="importData(event)"><i class="fas fa-file-import"></i></label>
    <div class="sidebar-menu-item" style="color:var(--danger)" onclick="confirmResetData()"><span>Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span><i class="fas fa-trash"></i></div>
</div>

<div class="modal" id="currencyModal">
    <header><button onclick="closeLayer('currency')"><i class="fas fa-times"></i></button><span class="title">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„Ø©</span><div style="width:20px"></div></header>
    <div class="modal-content" id="currencyList"></div>
</div>

<div class="toast" id="toast"></div>

<script>
// --- ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
const DB_NAME = "SmartBudgetProDB";
const STORES = ["exp", "rig", "deb", "bal"];
let db = { exp: [], rig: [], deb: [], bal: { clientId: 1, amount: 0, changes: [] } };
let idb = null;
let currentBalance = 0;
let editMode = null;
let balanceActionType = null;
let balanceHidden = localStorage.getItem('balanceHidden') === 'true';

const CURRENCIES = [
    {code:'SAR', symbol:'Ø±.Ø³'}, {code:'EGP', symbol:'Ø¬.Ù…'}, {code:'USD', symbol:'$'},
    {code:'EUR', symbol:'â‚¬'}, {code:'AED', symbol:'Ø¯.Ø¥'}, {code:'KWD', symbol:'Ø¯.Ùƒ'}
];
let currentCurrency = CURRENCIES.find(c => c.code === (localStorage.getItem('curr') || 'SAR'));

// --- IndexedDB ---
function initDB() {
    const req = indexedDB.open(DB_NAME, 4);
    req.onupgradeneeded = e => {
        idb = e.target.result;
        STORES.forEach(s => {
            if(!idb.objectStoreNames.contains(s)) idb.createObjectStore(s, {keyPath: s==='bal'?'clientId':'id', autoIncrement: s!=='bal'});
        });
        if(!idb.objectStoreNames.contains('bal')) e.target.transaction.objectStore('bal').add({clientId:1, amount:0, changes:[]});
    };
    req.onsuccess = e => {
        idb = e.target.result;
        loadData();
    };
}

async function loadData() {
    const tx = idb.transaction(STORES, 'readonly');
    for(const s of STORES) {
        db[s] = await new Promise(res => {
            const req = tx.objectStore(s).getAll();
            req.onsuccess = () => res(s==='bal' ? (req.result[0] || {clientId:1, amount:0, changes:[]}) : req.result.reverse());
        });
    }
    currentBalance = db.bal.amount || 0;
    updateUI();
}

function saveData(store, data) {
    return new Promise((res, rej) => {
        const tx = idb.transaction([store], 'readwrite');
        tx.objectStore(store).put(data).onsuccess = () => res();
        tx.onerror = rej;
    });
}

function deleteData(store, id) {
    return new Promise((res, rej) => {
        const tx = idb.transaction([store], 'readwrite');
        tx.objectStore(store).delete(id).onsuccess = () => res();
    });
}

// --- Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ---
function formatAmount(input) {
    let val = input.value.replace(/[^\d.]/g, '');
    const parts = val.split('.');
    if(parts.length > 2) val = parts[0] + '.' + parts.slice(1).join('');
    if(val) {
        const intPart = parseFloat(parts[0]).toLocaleString('en-US');
        input.value = intPart + (parts.length > 1 ? '.' + parts[1] : '');
    } else {
        input.value = '';
    }
}

function parseAmt(val) {
    return parseFloat(String(val).replace(/,/g, '')) || 0;
}

function formatCurr(amt) {
    if(balanceHidden) return '****';
    return parseAmt(amt).toLocaleString('en-US', {minimumFractionDigits:0, maximumFractionDigits:2}) + ' <span class="currency-symbol">'+currentCurrency.symbol+'</span>';
}

function toast(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg; t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
}

// --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ---
function updateUI() {
    document.getElementById('currentBalanceDisplay').innerHTML = formatCurr(currentBalance);
    document.getElementById('sExpTotal').innerHTML = formatCurr(db.exp.reduce((a,b)=>a+parseAmt(b.Ø§Ù„Ù…Ø¨Ù„Øº),0));
    document.getElementById('sRigPaid').innerHTML = formatCurr(db.rig.reduce((a,b)=>a+parseAmt(b.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¶Ø§Ù_Ù„Ù„Ø±ØµÙŠØ¯||0),0));
    document.getElementById('sDebPaid').innerHTML = formatCurr(db.deb.reduce((a,b)=>a+parseAmt(b.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø®ØµÙˆÙ…_Ù„Ù„Ø±ØµÙŠØ¯||0),0));
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    const now = new Date().toISOString().slice(0,16);
    ['eDate','rDate','dDate','bDate'].forEach(id => {
        if(!document.getElementById(id).value) document.getElementById(id).value = now;
    });
}

function openTab(id, e) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(e) e.currentTarget.classList.add('active');
    else document.querySelector(`.tabs button[onclick*="${id}"]`).classList.add('active');
    
    if(!editMode) clearInputs();
}

function openLayer(name, data) {
    if(name === 'sidebar') { document.getElementById('appSidebar').classList.add('open'); document.getElementById('mainOverlay').style.display='block'; return; }
    
    const el = document.getElementById(name + 'Modal');
    if(el) {
        el.style.display = 'flex';
        if(name === 'log') {
            el.dataset.type = data;
            renderLog(data);
        }
        else if(name === 'balanceLog') renderBalanceLog();
    }
}

function closeLayer(name) {
    if(name === 'sidebar') { document.getElementById('appSidebar').classList.remove('open'); document.getElementById('mainOverlay').style.display='none'; return; }
    const el = document.getElementById(name + 'Modal');
    if(el) el.style.display = 'none';
    if(name === 'detail') editMode = null;
}

function clearInputs() {
    document.querySelectorAll('input').forEach(i => {
        if(i.type !== 'datetime-local') i.value = '';
    });
    document.getElementById('eImgName').innerText = '';
    document.getElementById('eImgCamera').value = '';
    document.getElementById('eImgGallery').value = '';
}

// --- Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---
async function processBalanceChange(amt, type, desc, id, isEdit, oldAmt=0) {
    const val = parseAmt(amt);
    let net = val;
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
    if(['exp','deb_pay','withdraw'].includes(type)) net *= -1;
    
    let change = net;
    if(isEdit) change = net - oldAmt;
    
    currentBalance += change;
    db.bal.amount = currentBalance;
    
    const record = {
        id: id || Date.now(),
        date: new Date().toISOString(),
        desc: desc,
        amount: val,
        net: net,
        balanceAfter: currentBalance
    };
    
    if(isEdit) {
        const idx = db.bal.changes.findIndex(c => c.id === id);
        if(idx > -1) db.bal.changes[idx] = record;
    } else {
        db.bal.changes.unshift(record);
    }
    
    await saveData('bal', db.bal);
    updateUI();
}

// 1. Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
async function addExpense() {
    const amt = document.getElementById('eAmount').value;
    const type = document.getElementById('eType').value;
    const desc = document.getElementById('eDesc').value;
    const date = document.getElementById('eDate').value;
    const cam = document.getElementById('eImgCamera');
    const gal = document.getElementById('eImgGallery');
    const file = cam.files[0] || gal.files[0];
    
    if(!amt || !type) return toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„ÙØ¦Ø©');
    
    const isEdit = !!editMode;
    const oldData = isEdit ? db.exp[editMode.index] : {};
    const oldNet = isEdit ? (parseAmt(oldData.Ø§Ù„Ù…Ø¨Ù„Øº) * -1) : 0;
    
    const data = {
        id: isEdit ? oldData.id : Date.now(),
        clientId: isEdit ? oldData.clientId : 'exp-'+Date.now(),
        Ø§Ù„Ù…Ø¨Ù„Øº: amt,
        Ø§Ù„ÙØ¦Ø©: type,
        Ø§Ù„ÙˆØµÙ: desc,
        Ø§Ù„ØªØ§Ø±ÙŠØ®: date,
        ØµÙˆØ±Ø©: oldData.ØµÙˆØ±Ø© 
    };
    
    if(file) {
        const reader = new FileReader();
        reader.onload = async () => {
            data.ØµÙˆØ±Ø© = reader.result;
            await finalizeExpense(data, isEdit, oldNet);
        };
        reader.readAsDataURL(file);
    } else {
        await finalizeExpense(data, isEdit, oldNet);
    }
}

async function finalizeExpense(data, isEdit, oldNet) {
    if(isEdit) db.exp[editMode.index] = data;
    else db.exp.unshift(data);
    
    await saveData('exp', data);
    await processBalanceChange(data.Ø§Ù„Ù…Ø¨Ù„Øº, 'exp', `Ù…ØµØ±ÙˆÙ: ${data.Ø§Ù„ÙØ¦Ø©}`, data.clientId, isEdit, oldNet);
    
    toast('ØªÙ… Ø§Ù„Ø­ÙØ¸');
    editMode = null;
    clearInputs();
    openTab('overview');
}

// 2. Ø§Ù„Ø­Ù‚ÙˆÙ‚
async function addRight() {
    const amt = document.getElementById('rAmount').value;
    const type = document.getElementById('rType').value;
    const desc = document.getElementById('rDesc').value;
    const status = document.getElementById('rStatus').value;
    
    if(!amt || !type) return toast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    
    const isEdit = !!editMode;
    const oldData = isEdit ? db.rig[editMode.index] : {};
    
    let paid = 0;
    if(type === 'Ø¯ÙŠÙ†') {
        paid = parseAmt(document.getElementById('rPaidAmount')?.value || 0);
    } else {
        if(status === 'ÙƒØ§Ù…Ù„') paid = parseAmt(amt);
    }
    
    const oldPaidNet = isEdit ? (parseAmt(oldData.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¶Ø§Ù_Ù„Ù„Ø±ØµÙŠØ¯ || 0)) : 0;
    
    const data = {
        id: isEdit ? oldData.id : Date.now(),
        clientId: isEdit ? oldData.clientId : 'rig-'+Date.now(),
        Ø§Ù„Ù…Ø¨Ù„Øº: amt,
        Ø§Ù„Ù†ÙˆØ¹: type,
        Ø§Ù„ÙˆØµÙ: desc,
        Ø§Ù„Ø­Ø§Ù„Ø©: status || (paid >= parseAmt(amt) ? 'Ù…Ø¯ÙÙˆØ¹' : 'Ù…ØªØ¨Ù‚ÙŠ'),
        Ø§Ù„ØªØ§Ø±ÙŠØ®: document.getElementById('rDate').value,
        Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¶Ø§Ù_Ù„Ù„Ø±ØµÙŠØ¯: paid
    };
    
    if(isEdit) db.rig[editMode.index] = data;
    else db.rig.unshift(data);
    
    await saveData('rig', data);
    await processBalanceChange(paid, 'rig_collect', `ØªØ­ØµÙŠÙ„: ${type}`, data.clientId, isEdit, oldPaidNet);
    
    toast('ØªÙ… Ø§Ù„Ø­ÙØ¸');
    editMode = null;
    clearInputs();
    openTab('overview');
}

// 3. Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
async function addDebt() {
    const amt = document.getElementById('dAmount').value;
    const type = document.getElementById('dType').value;
    const status = document.getElementById('dStatus').value;
    
    if(!type) return toast('Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹');
    
    const isEdit = !!editMode;
    const oldData = isEdit ? db.deb[editMode.index] : {};
    
    let paid = 0;
    let total = amt;
    
    if(type === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ') {
        total = document.getElementById('dTotalAmount').value;
        paid = parseAmt(document.getElementById('dPaidAmount').value);
    } else {
        if(!amt) return toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº');
        total = amt;
        if(status === 'Ù…Ø¯ÙÙˆØ¹') paid = parseAmt(amt);
    }
    
    const oldPaidNet = isEdit ? (parseAmt(oldData.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø®ØµÙˆÙ…_Ù„Ù„Ø±ØµÙŠØ¯ || 0) * -1) : 0;
    
    const data = {
        id: isEdit ? oldData.id : Date.now(),
        clientId: isEdit ? oldData.clientId : 'deb-'+Date.now(),
        Ø§Ù„Ù…Ø¨Ù„Øº: total,
        Ø§Ù„Ù†ÙˆØ¹: type,
        Ø§Ù„ÙˆØµÙ: document.getElementById('dDesc').value,
        Ø§Ù„Ø­Ø§Ù„Ø©: status,
        Ø§Ù„ØªØ§Ø±ÙŠØ®: document.getElementById('dDate').value,
        Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø®ØµÙˆÙ…_Ù„Ù„Ø±ØµÙŠØ¯: paid
    };
    
    if(isEdit) db.deb[editMode.index] = data;
    else db.deb.unshift(data);
    
    await saveData('deb', data);
    await processBalanceChange(paid, 'deb_pay', `Ø¯ÙØ¹: ${type}`, data.clientId, isEdit, oldPaidNet);
    
    toast('ØªÙ… Ø§Ù„Ø­ÙØ¸');
    editMode = null;
    clearInputs();
    openTab('overview');
}

// --- Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙˆØ§Ù„ØªÙØ§ØµÙŠÙ„ ---
function renderLog(type) {
    const list = db[type];
    const container = document.getElementById('logContent');
    const search = document.getElementById('search').value.toLowerCase();
    
    container.innerHTML = list.filter(i => JSON.stringify(i).toLowerCase().includes(search)).map(i => `
        <div class="list-item" onclick="showDetail(${i.id}, '${type}')">
            <div style="font-weight:bold; display:flex; justify-content:space-between">
                <span>${i.Ø§Ù„Ù†ÙˆØ¹ || i.Ø§Ù„ÙØ¦Ø©}</span>
                <span style="color:${type==='exp'?'var(--danger)':'var(--success)'}">${i.Ø§Ù„Ù…Ø¨Ù„Øº}</span>
            </div>
            <div class="details">
                <span>${i.Ø§Ù„ÙˆØµÙ || '-'}</span>
                <span>${new Date(i.Ø§Ù„ØªØ§Ø±ÙŠØ®).toLocaleDateString()}</span>
            </div>
        </div>
    `).join('') || '<p style="text-align:center; color:#999">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
}

function showDetail(id, type) {
    const item = db[type].find(i => i.id === id);
    const idx = db[type].indexOf(item);
    
    let html = `<div class="card">`;
    for(const [k,v] of Object.entries(item)) {
        if(!['id','clientId','ØµÙˆØ±Ø©'].includes(k)) html += `<p><strong>${k}:</strong> ${v}</p>`;
    }
    if(item.ØµÙˆØ±Ø©) html += `<img src="${item.ØµÙˆØ±Ø©}" style="width:100%; border-radius:10px; margin-top:10px">`;
    
    html += `<div style="display:flex; gap:10px; margin-top:20px">
        <button class="secondary" onclick="prepareEdit('${type}', ${idx})">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="action" style="background:var(--danger)" onclick="deleteItem('${type}', ${idx})">Ø­Ø°Ù</button>
    </div></div>`;
    
    document.getElementById('detailContent').innerHTML = html;
    openLayer('detail');
}

function prepareEdit(type, idx) {
    editMode = { type, index: idx };
    const item = db[type][idx];
    closeLayer('detail');
    closeLayer('log');
    
    if(type === 'exp') {
        openTab('expenses');
        document.getElementById('eAmount').value = item.Ø§Ù„Ù…Ø¨Ù„Øº;
        document.getElementById('eType').value = item.Ø§Ù„ÙØ¦Ø©;
        document.getElementById('eDesc').value = item.Ø§Ù„ÙˆØµÙ;
        document.getElementById('eDate').value = item.Ø§Ù„ØªØ§Ø±ÙŠØ®;
        if(item.ØµÙˆØ±Ø©) document.getElementById('eImgName').innerText = 'ØµÙˆØ±Ø© Ù…Ø­ÙÙˆØ¸Ø©';
    } else if(type === 'rig') {
        openTab('rights');
        document.getElementById('rType').value = item.Ø§Ù„Ù†ÙˆØ¹;
        updateRightFields(item.Ø§Ù„Ù†ÙˆØ¹);
        document.getElementById('rAmount').value = item.Ø§Ù„Ù…Ø¨Ù„Øº;
        document.getElementById('rDesc').value = item.Ø§Ù„ÙˆØµÙ;
        if(item.Ø§Ù„Ù†ÙˆØ¹ === 'Ø¯ÙŠÙ†') document.getElementById('rPaidAmount').value = item.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¶Ø§Ù_Ù„Ù„Ø±ØµÙŠØ¯;
        document.getElementById('rStatus').value = item.Ø§Ù„Ø­Ø§Ù„Ø© === 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„' ? 'ÙƒØ§Ù…Ù„' : (item.Ø§Ù„Ø­Ø§Ù„Ø©.includes('ØºÙŠØ±') ? 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹' : '');
    } else {
        openTab('debts');
        document.getElementById('dType').value = item.Ø§Ù„Ù†ÙˆØ¹;
        updateDebtFields(item.Ø§Ù„Ù†ÙˆØ¹);
        if(item.Ø§Ù„Ù†ÙˆØ¹ === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ') {
            document.getElementById('dTotalAmount').value = item.Ø§Ù„Ù…Ø¨Ù„Øº;
            document.getElementById('dPaidAmount').value = item.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø®ØµÙˆÙ…_Ù„Ù„Ø±ØµÙŠØ¯;
        } else {
            document.getElementById('dAmount').value = item.Ø§Ù„Ù…Ø¨Ù„Øº;
            document.getElementById('dStatus').value = item.Ø§Ù„Ø­Ø§Ù„Ø©;
        }
        document.getElementById('dDesc').value = item.Ø§Ù„ÙˆØµÙ;
    }
}

async function deleteItem(type, idx) {
    if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
    const item = db[type][idx];
    
    // Ø¹ÙƒØ³ ØªØ£Ø«ÙŠØ± Ø§Ù„Ø±ØµÙŠØ¯
    let reverseAmt = 0;
    if(type === 'exp') reverseAmt = parseAmt(item.Ø§Ù„Ù…Ø¨Ù„Øº) * -1; // ÙƒØ§Ù† Ø®ØµÙ…ØŒ Ù†Ø±Ø¬Ø¹Ù‡
    else if(type === 'rig') reverseAmt = parseAmt(item.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¶Ø§Ù_Ù„Ù„Ø±ØµÙŠØ¯ || 0);
    else if(type === 'deb') reverseAmt = parseAmt(item.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø®ØµÙˆÙ…_Ù„Ù„Ø±ØµÙŠØ¯ || 0) * -1;
    
    // Ø¥Ø°Ø§ reverseAmt Ø³Ø§Ù„Ø¨ ÙŠØ¹Ù†ÙŠ Ø®ØµÙ…ØŒ Ù…ÙˆØ¬Ø¨ ÙŠØ¹Ù†ÙŠ Ø¥Ø¶Ø§ÙØ© (Ù„Ø¹ÙƒØ³ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŒ Ù†Ø¹ÙƒØ³ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨)
    // Ù„ÙƒÙ† Ù‡Ù†Ø§ processBalanceChange ØªØ£Ø®Ø° Ø§Ù„Ù…Ø¨Ù„Øº "Ø§Ù„Ø®Ø§Ù…" ÙˆØªØ­Ø¯Ø¯ Ø§Ù„Ø¥Ø´Ø§Ø±Ø©.
    // Ø§Ù„Ø£Ø³Ù‡Ù„: Ù†Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† changes ÙˆÙ†Ø¹ÙŠØ¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ØŸ Ù„Ø§ØŒ Ù†Ø¶ÙŠÙ Ø­Ø±ÙƒØ© Ø¹ÙƒØ³ÙŠØ©.
    // Ø³Ù†Ù‚ÙˆÙ… Ø¨ØªÙ…Ø±ÙŠØ± 0 ÙƒÙ‚ÙŠÙ…Ø© Ø¬Ø¯ÙŠØ¯Ø© Ùˆ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙƒÙ‚ÙŠÙ…Ø© Ø³Ø§Ø¨Ù‚Ø© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„ÙŠØªÙ… Ø¹ÙƒØ³ Ø§Ù„ÙØ§Ø±Ù‚.
    
    await processBalanceChange(0, type==='exp'?'exp':(type==='deb'?'deb_pay':'rig_collect'), 'Ø­Ø°Ù Ù…Ø¹Ø§Ù…Ù„Ø©', item.clientId, true, reverseAmt);
    
    await deleteData(type, item.id);
    db[type].splice(idx, 1);
    
    toast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
    closeLayer('detail');
    loadData();
}

// --- Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© ---
function updateRightFields(val) {
    const div = document.getElementById('rDynamicFields');
    div.innerHTML = val === 'Ø¯ÙŠÙ†' ? '<input id="rPaidAmount" type="tel" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù… (Ø¥Ù† ÙˆØ¬Ø¯)" oninput="formatAmount(this)">' : '';
    document.getElementById('rStatus').style.display = val === 'Ø¯ÙŠÙ†' ? 'none' : 'block';
}

function updateDebtFields(val) {
    const div = document.getElementById('dDynamicFields');
    const amt = document.getElementById('dAmount');
    const stat = document.getElementById('dStatus');
    
    if(val === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ') {
        div.innerHTML = `<input id="dTotalAmount" type="tel" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ" oninput="formatAmount(this)">
                         <input id="dPaidAmount" type="tel" placeholder="Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†" oninput="formatAmount(this)">`;
        amt.style.display = 'none'; stat.style.display = 'none';
    } else {
        div.innerHTML = '';
        amt.style.display = 'block'; stat.style.display = 'block';
    }
}

// --- Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙŠØ¯ÙˆÙŠ ---
function openBalanceActionModal(type) {
    balanceActionType = type;
    document.getElementById('actionModalTitle').innerText = type==='deposit' ? 'Ø¥ÙŠØ¯Ø§Ø¹ Ø±ØµÙŠØ¯' : 'Ø³Ø­Ø¨ Ø±ØµÙŠØ¯';
    openLayer('balanceAction');
}

async function processBalanceAction() {
    const amt = document.getElementById('bAmount').value;
    const desc = document.getElementById('bDesc').value;
    if(!amt) return;
    
    await processBalanceChange(amt, balanceActionType==='deposit'?'deposit':'withdraw', desc || (balanceActionType==='deposit'?'Ø¥ÙŠØ¯Ø§Ø¹ ÙŠØ¯ÙˆÙŠ':'Ø³Ø­Ø¨ ÙŠØ¯ÙˆÙŠ'));
    closeLayer('balanceAction');
    document.getElementById('bAmount').value = '';
}

function renderBalanceLog() {
    document.getElementById('balanceLogContent').innerHTML = db.bal.changes.map(c => `
        <div class="list-item" style="border-right-color:${c.net>0?'var(--success)':'var(--danger)'}">
            <div style="display:flex; justify-content:space-between; font-weight:bold">
                <span>${c.net>0?'Ø¥ÙŠØ¯Ø§Ø¹':'Ø®ØµÙ…'}</span>
                <span style="color:${c.net>0?'var(--success)':'var(--danger)'}">${Math.abs(c.net).toLocaleString()}</span>
            </div>
            <div class="details"><span>${c.desc}</span><span>${new Date(c.date).toLocaleDateString()}</span></div>
            <div style="font-size:0.8em; text-align:left; color:#777">Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯: ${c.balanceAfter?.toLocaleString() || '-'}</div>
        </div>
    `).join('');
}

// --- Ø§Ù„Ø¹Ù…Ù„Ø§Øª ÙˆØ§Ù„ØµÙˆØ± ---
function openCameraInput() { document.getElementById('eImgCamera').click(); closeLayer('imageSource'); }
function openGalleryInput() { document.getElementById('eImgGallery').click(); closeLayer('imageSource'); }
function updateFileName(inp, id) { document.getElementById(id).innerText = inp.files[0]?.name || ''; }

function toggleBalanceVisibility() {
    balanceHidden = !balanceHidden;
    localStorage.setItem('balanceHidden', balanceHidden);
    updateUI();
}
function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
function renderCurrencyList() {
    document.getElementById('currencyList').innerHTML = CURRENCIES.map(c => `
        <div class="list-item" onclick="setCurrency('${c.code}')">
            <b>${c.symbol} ${c.code}</b>
            ${currentCurrency.code===c.code?'<i class="fas fa-check"></i>':''}
        </div>
    `).join('');
}
function setCurrency(c) {
    currentCurrency = CURRENCIES.find(x => x.code === c);
    localStorage.setItem('curr', c);
    closeLayer('currency');
    updateUI();
}

// --- Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ±/Ù…Ø³Ø­ ---
function exportData() {
    const blob = new Blob([JSON.stringify(db)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `budget_backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
}
function importData(e) {
    const r = new FileReader();
    r.onload = async () => {
        try {
            const data = JSON.parse(r.result);
            if(data.exp && data.bal) {
                if(confirm('Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
                    // ØªÙØ±ÙŠØº Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                    for(const s of STORES) await new Promise(res => {
                         const tx = idb.transaction(s, 'readwrite');
                         tx.objectStore(s).clear().onsuccess = res;
                    });
                    
                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                    const tx = idb.transaction(STORES, 'readwrite');
                    for(const s of STORES) {
                        if(s === 'bal') tx.objectStore(s).put(data[s]);
                        else data[s].forEach(i => tx.objectStore(s).put(i));
                    }
                    toast('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
                    setTimeout(() => location.reload(), 1000);
                }
            }
        } catch(err) { toast('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); }
    };
    r.readAsText(e.target.files[0]);
}
function confirmResetData() {
    if(confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹!')) {
        indexedDB.deleteDatabase(DB_NAME);
        location.reload();
    }
}

// Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
window.onload = () => {
    initDB();
    renderCurrencyList();
};
</script>
</body>
</html>
