<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ© | Smart Budget</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">

    <style>
        /* ---------------------------------------------------- */
        /* 1. Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­) */
        /* ---------------------------------------------------- */
        :root{
            --p: #0077b6; /* Primary Blue (Vibrant) */
            --s: #48cae4; /* Secondary Light Blue */
            --bg: #f7f9fc; /* Light Background */
            --danger: #ef476f; 
            --success: #2a9d8f;
            --warning: #fbc02d;
            --text-dark: #333;
            --text-light: #f7f9fc;
            --shadow-light: 0 4px 8px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 6px 15px rgba(0, 0, 0, 0.15);
            --card-bg: #fff;
            --input-bg: #fff;
            --border-color: #ddd;
            --tab-active-bg: #fff;
        }

        /* ---------------------------------------------------- */
        /* 2. Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ (Dark Mode) */
        /* ---------------------------------------------------- */
        body.dark-mode {
            --p: #90e0ef; /* Lighter Primary Blue for contrast */
            --s: #48cae4; 
            --bg: #1f1f1f; /* Dark Background */
            --danger: #ff8a80;
            --success: #66bb6a;
            --warning: #fbc02d;
            --text-dark: #e0e0e0; /* Light Text */
            --text-light: #1f1f1f;
            --shadow-light: 0 4px 10px rgba(0, 0, 0, 0.5);
            --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.8);
            --card-bg: #2d2d2d;
            --input-bg: #3c3c3c;
            --border-color: #555;
            --tab-active-bg: #2d2d2d;
        }

        /* ---------------------------------------------------- */
        /* 3. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø· ÙˆØ§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
        /* ---------------------------------------------------- */
        * {
            box-sizing: border-box;
        }
        body{
            margin:0;
            font-family: 'Tajawal', 'Arial', sans-serif;
            background: var(--bg);
            color: var(--text-dark);
            overflow-x: hidden;
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
        }
        .card, .sidebar, .modal { background: var(--card-bg); }
        .modal header { background: var(--card-bg); border-bottom: 1px solid var(--border-color); }

        /* ---------------------------------------------------- */
        /* 4. Ø§Ù„Ø±Ø£Ø³ (Header) ÙˆØ§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø£ÙÙ‚ÙŠ (Tabs) */
        /* ---------------------------------------------------- */
        header{
            background: var(--p);
            color: var(--text-light);
            padding: 15px;
            font-size: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-hover);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        header .title { flex-grow: 1; text-align: center; font-weight: 800; }
        header button {
            background: none; 
            border: none; 
            color: var(--text-light); 
            font-size: 20px; 
            cursor: pointer; 
            padding: 0 10px;
            transition: transform 0.2s;
        }
        header button:hover { transform: scale(1.1); }

        .tabs{
            display:flex;
            background: var(--card-bg);
            border-bottom: 2px solid var(--border-color);
            box-shadow: var(--shadow-light);
            overflow-x: auto; 
            white-space: nowrap;
        }
        .tabs button{
            flex: 1 1 auto; 
            min-width: 0; 
            padding: 15px 10px;
            border:none;
            background: var(--card-bg);
            color: var(--text-dark);
            font-weight: 700;
            font-size: 14px;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            cursor: pointer;
        }
        .tabs button.active{
            color: var(--p);
            border-bottom: 3px solid var(--p);
            background: color-mix(in srgb, var(--bg) 90%, var(--p)); 
        }
        body.dark-mode .tabs button.active {
            background: color-mix(in srgb, var(--bg) 85%, var(--p)); 
        }

        /* ---------------------------------------------------- */
        /* 5. Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø¹Ø§Ù… ÙˆØ§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª (Cards) */
        /* ---------------------------------------------------- */
        .section{ display:none; padding: 15px; }
        .section.active{ display:block; }
        .card{
            background:var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--shadow-light);
            margin-bottom: 15px;
            border-top: 5px solid var(--s); 
            transition: background 0.3s, border-color 0.3s;
        }

        /* Overview Section Styling */
        #overview .balance-display {
            text-align: center;
            padding: 30px 20px;
            margin-bottom: 20px;
            border-radius: 15px;
            background: var(--card-bg);
            box-shadow: var(--shadow-hover);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #overview .balance-display h2 { margin: 0 0 5px 0; font-size: 18px; color: #999; }
        #overview .balance-display p {
            font-size: 38px;
            font-weight: 800;
            margin: 5px 0 0 0;
            color: var(--p);
            display: flex;
            align-items: center;
        }
        #overview .balance-display button {
            background: none; border: none; color: var(--p); font-size: 24px; cursor: pointer;
            margin-right: 10px; transition: color 0.2s;
        }
        #overview .balance-display button:hover { color: var(--s); }
        #overview .balance-actions {
            display: flex; gap: 15px; margin-top: 10px;
        }
        #overview .balance-actions .action {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            padding: 15px; color: var(--text-dark); border-radius: 10px;
            border: 1px solid var(--border-color); box-shadow: var(--shadow-light);
            transition: all 0.2s; background: var(--input-bg); cursor: pointer;
        }
        #overview .balance-actions .action:hover {
            box-shadow: var(--shadow-hover); transform: translateY(-2px); border-color: var(--p);
        }
        #overview .balance-actions .action i { font-size: 24px; margin-bottom: 5px; }
        #overview .balance-actions .deposit i { color: var(--success); }
        #overview .balance-actions .withdraw i { color: var(--danger); }

        /* ---------------------------------------------------- */
        /* 6. Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (Form Elements) */
        /* ---------------------------------------------------- */
        input, select, .datetime-container input[type="datetime-local"] {
            width: 100%; padding: 14px; margin: 8px 0; font-size: 16px; border-radius: 10px;
            border: 1px solid var(--border-color); box-sizing: border-box;
            background: var(--input-bg); color: var(--text-dark); transition: all 0.3s;
        }
        input:focus, select:focus, .datetime-container input[type="datetime-local"]:focus {
            border-color: var(--s); box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.2); outline: none;
        }
        body.dark-mode input:focus, body.dark-mode select:focus, body.dark-mode .datetime-container input[type="datetime-local"]:focus {
            box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.3);
        }
        .datetime-container { position: relative; width: 100%; margin: 8px 0; }
        .datetime-container input[type="datetime-local"] { margin: 0; padding-left: 40px; }
        .calendar-icon {
            position: absolute; top: 50%; left: 15px; transform: translateY(-50%);
            font-size: 1.4em; z-index: 2; pointer-events: none; color: var(--p); 
        }

        /* Buttons & Actions */
        button.action{
            background: var(--p); color: var(--text-light); border: none; padding: 16px;
            width: 100%; border-radius: 10px; font-size: 18px; font-weight: bold;
            margin-top: 10px; cursor: pointer; transition: background 0.3s, transform 0.2s;
            box-shadow: var(--shadow-light);
        }
        button.action:hover{
            background: color-mix(in srgb, var(--p) 85%, black); 
            transform: translateY(-2px);
        }
        button.secondary{
            background: var(--input-bg); color: var(--text-dark); padding: 12px;
            width: 100%; border: 1px solid var(--border-color); border-radius: 10px;
            margin-top: 8px; font-size: 16px; cursor: pointer; transition: background 0.3s;
        }
        button.secondary:hover {
            background: color-mix(in srgb, var(--input-bg) 80%, #999); 
        }
        .currency-symbol { color: var(--p); font-weight: bold; font-size: 1.1em; margin-right: 5px; }
        .hidden-balance { font-size: 38px; font-weight: 800; letter-spacing: 5px; color: var(--p); }

        /* ---------------------------------------------------- */
        /* 7. Ø§Ù„Ø³Ø¬Ù„Ø§Øª (List Item) ÙˆØ§Ù„Ù…Ø­Ø§ÙƒÙŠ (Toast) */
        /* ---------------------------------------------------- */
        .toast{
            position:fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #333; color: var(--text-light); padding: 12px 25px;
            border-radius: 30px; display:none; z-index: 100; font-size: 15px;
            box-shadow: var(--shadow-hover); white-space: nowrap;
        }
        .toast.show{
            display:block; animation: fadeInOut 2.5s ease-in-out forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }

        .list-item{
            background: var(--card-bg); padding: 16px; border-radius: 12px;
            margin-bottom: 10px; cursor: pointer; transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); border-right: 5px solid var(--s); 
            color: var(--text-dark);
        }
        .list-item:hover {
            background: color-mix(in srgb, var(--card-bg) 95%, #999);
            box-shadow: var(--shadow-light);
        }
        .list-item .details {
            font-size: 0.9em; color: #666; text-align: right; display: flex;
            justify-content: space-between; align-items: center; margin-top: 5px;
        }

        /* ---------------------------------------------------- */
        /* 8. Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modals) ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Sidebar) */
        /* ---------------------------------------------------- */
        .modal{
            position:fixed; top:0; left:0; width:100%; height:100%; background: var(--bg);
            display:none; flex-direction:column; z-index: 30; overflow-y: auto;
        }
        .modal header{
            display:flex; gap: 10px; padding: 15px; border-bottom: 1px solid var(--border-color);
            background: var(--card-bg); align-items: center; box-shadow: var(--shadow-light);
            position: sticky; top: 0; z-index: 35;
        }
        .modal header .title { flex-grow: 1; text-align: center; font-weight: 700; }
        .modal header button {
            background: none; border: none; color: var(--text-dark); font-size: 20px;
            cursor: pointer; padding: 0 10px;
        }
        .modal-content { flex-grow: 1; padding: 15px; }

        .sidebar {
            position: fixed; top: 0; right: 0; width: 300px; max-width: 85%;
            height: 100%; background: var(--card-bg);
            box-shadow: -4px 0 12px rgba(0, 0, 0, 0.2);
            transform: translateX(100%); 
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            z-index: 25; display: flex; flex-direction: column;
        }
        .sidebar.open { transform: translateX(0); }
        .sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); display: none; z-index: 24;
        }
        .sidebar-overlay.open { display: block; }

        /* Switch Style (Dark Mode) */
        .switch-container {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; font-size: 17px; color: var(--text-dark);
        }
        .switch { position: relative; display: inline-block; width: 45px; height: 25px; }
        .switch input {opacity: 0; width: 0; height: 0;}
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--border-color); transition: .4s; border-radius: 25px;
        }
        .slider:before {
            position: absolute; content: ""; height: 19px; width: 19px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--p); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Sidebar Header & Content */
        .sidebar-header {
            padding: 15px; background: var(--p); color: var(--text-light);
            font-size: 20px; display: flex; justify-content: space-between;
            align-items: center; font-weight: bold;
        }
        .sidebar-content { flex-grow: 1; padding: 15px 0; overflow-y: auto; }
        .sidebar-menu-item {
            padding: 15px 20px; margin: 5px 0; display: flex; align-items: center;
            justify-content: space-between; gap: 15px; font-size: 17px;
            color: var(--text-dark); cursor: pointer; transition: background 0.2s, color 0.2s;
        }
        .sidebar-menu-item:hover { background: var(--s); color: var(--text-dark); }
        .sidebar-menu-item i { font-size: 1.2em; }
        
        /* ---------------------------------------------------- */
        /* 9. Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù„Ù„ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© (Responsive) */
        /* ---------------------------------------------------- */
        @media (max-width: 450px) {
            .tabs button {
                padding: 15px 5px; 
                font-size: 13px; 
            }
        }
    </style>
</head>

<body>

    <header>
        <button onclick="openSidebar()"><i class="fas fa-bars"></i></button> 
        <span class="title">Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</span>
        <button style="visibility: hidden;"><i class="fas fa-search"></i></button> 
    </header>

    <div class="tabs">
        <button class="active" onclick="openTab('overview')">
            <i class="fas fa-tachometer-alt" style="margin-left: 5px;"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©
        </button>
        <button onclick="openTab('expenses')">
            <i class="fas fa-money-bill-wave" style="margin-left: 5px;"></i> Ù…ØµØ±ÙˆÙØ§Øª
        </button>
        <button onclick="openTab('rights')">
            <i class="fas fa-handshake" style="margin-left: 5px;"></i> Ø­Ù‚ÙˆÙ‚
        </button>
        <button onclick="openTab('debts')">
            <i class="fas fa-file-invoice" style="margin-left: 5px;"></i> Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
        </button>
    </div>

    <div id="overview" class="section active">
        <div class="balance-display">
            <h2>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
            <p id="currentBalanceDisplay">
                <i class="fas fa-spinner fa-spin"></i>
            </p>
            <button onclick="toggleBalanceVisibility()" id="balanceVisibilityToggle" title="Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±ØµÙŠØ¯">
                 <i class="fas fa-eye"></i>
            </button>
        </div>

        <div class="balance-actions">
            <button class="action deposit" onclick="openBalanceActionModal('deposit')">
                <i class="fas fa-plus-circle"></i> Ø¥ÙŠØ¯Ø§Ø¹
            </button>
            <button class="action withdraw" onclick="openBalanceActionModal('withdraw')">
                <i class="fas fa-minus-circle"></i> Ø³Ø­Ø¨
            </button>
        </div>
        
        <button class="secondary" onclick="openBalanceLogModal()" style="margin-top: 15px;">
            <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯
        </button>

        <div class="card" style="margin-top: 20px; border-top: 5px solid var(--p);">
            <h3 style="color: var(--p); margin-top: 0;"><i class="fas fa-calculator" style="margin-left: 5px;"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
            <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (ØªØ´Ù…Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª):</span> <b id="sExpTotal">0</b></p>
            <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©:</span> <b id="sRigTotal">0</b></p>
            <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©:</span> <b id="sDebTotal">0</b></p>
            <p><span>Ø§Ù„Ù…Ø­ØµÙ„ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ‚:</span> <b id="sRigPaid">0</b></p>
            <p><span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª:</span> <b id="sDebPaid">0</b></p>
        </div>
    </div>

    <div id="expenses" class="section">
        <div class="card">
            <p style="color: var(--danger); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡Ø§ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙˆØ±Ø§Ù‹</p>
            <input id="eAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
            <select id="eType">
                <option value="">ğŸ›’ Ø§Ù„ÙØ¦Ø© (Ù†ÙÙ‚Ø§Øª Ù…ØªØºÙŠØ±Ø©)</option>
                <option>Ø·Ø¹Ø§Ù…</option><option>Ù…ÙˆØ§ØµÙ„Ø§Øª</option>
                <option>Ø±Ø¹Ø§ÙŠØ© Ø´Ø®ØµÙŠØ©</option><option>Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
                <option>ØµØ­Ø©</option><option>ØªØ±ÙÙŠÙ‡</option><option>ØªØ³ÙˆÙ‚</option>
                <option>ØªØ¹Ù„ÙŠÙ…</option><option>ØµÙŠØ§Ù†Ø© ÙˆØ¥ØµÙ„Ø§Ø­</option><option>Ø£Ø®Ø±Ù‰</option>
            </select>
            <input id="eDesc" placeholder="ğŸ“ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
            <div class="datetime-container">
                <input id="eDate" type="datetime-local">
                <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
            </div>
            
            <button class="secondary" onclick="showImageSourceModal()">
                <i class="fas fa-camera" style="margin-left: 5px;"></i> Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            </button>
            <span id="eImgName" style="display: block; font-size: 0.8em; color: var(--success); text-align: right; margin-top: 5px;"></span>
            <input type="file" id="eImgCamera" accept="image/*" capture="camera" style="display: none;" onchange="updateFileName(this, 'eImgName')">
            <input type="file" id="eImgGallery" accept="image/*" style="display: none;" onchange="updateFileName(this, 'eImgName')">
            
            <button class="action" onclick="addExpense()">
                <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ
            </button>
            <button class="secondary" onclick="openLog('exp')">
                <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
            </button>
        </div>
    </div>

    <div id="rights" class="section">
        <div class="card">
            <p style="color: var(--success); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„Ø© (Ø¯ÙØ¹ Ø§Ù„Ø¯ÙŠÙ†/Ø§Ù„Ø¢Ø¬Ù„) ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
            <select id="rType" onchange="updateRightFields(this.value)">
                <option value="">ğŸ¤ Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚</option>
                <option>Ø¯ÙŠÙ†</option>
                <option>Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„</option>
                <option>Ø£Ø®Ø±Ù‰</option>
            </select>
            <input id="rAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚ (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ)" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
            <div id="rDynamicFields"></div>
            <input id="rDesc" placeholder="ğŸ‘¤ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ù„Ù…Ø¯ÙŠÙ†/Ø§Ù„Ø¬Ù‡Ø©)">
            <div class="datetime-container">
                <input id="rDate" type="datetime-local">
                <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
            </div>
            <select id="rStatus">
                <option value="">âœ… Ø§Ù„Ø­Ø§Ù„Ø©</option>
                <option value="ÙƒØ§Ù…Ù„">Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</option>
                <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ Ø¨Ø¹Ø¯</option>
            </select>
            <button class="action" onclick="addRight()">
                <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ø­Ù‚
            </button>
            <button class="secondary" onclick="openLog('rig')">
                <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ‚
            </button>
        </div>
    </div>

    <div id="debts" class="section">
        <div class="card">
            <p style="color: var(--danger); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø¯ÙØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
            <select id="dType" onchange="updateDebtFields(this.value)">
                <option value="">ğŸ§¾ Ù†ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</option>
                <option>Ø¥ÙŠØ¬Ø§Ø±</option>
                <option>ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
                <option>Ù…Ø§Ø¡</option>
                <option>Ø¥Ù†ØªØ±Ù†Øª</option>
                <option>Ù‚Ø±Ø¶</option> <option>Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ</option> <option>Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø© Ø£Ø®Ø±Ù‰</option>
                <option>Ø£Ø®Ø±Ù‰</option>
            </select>
            <input id="dAmount" type="text" placeholder="ğŸ’µ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©/Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">

            <div id="dDynamicFields"></div>
            <input id="dDesc" placeholder="ğŸ¢ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ù„Ø¯Ø§Ø¦Ù†/Ø§Ù„Ø¬Ù‡Ø©)">
            <div class="datetime-container">
                <input id="dDate" type="datetime-local">
                <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
            </div>
            <select id="dStatus">
                <option value="">âœ… Ø§Ù„Ø­Ø§Ù„Ø©</option>
                <option value="Ù…Ø¯ÙÙˆØ¹">Ù…Ø¯ÙÙˆØ¹</option>
                <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
            </select>
            <button class="action" onclick="addDebt()">
                <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…
            </button>
            <button class="secondary" onclick="openLog('deb')">
                <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
            </button>
        </div>
    </div>

    <div class="modal" id="logModal">
        <header>
            <input id="search" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„..." oninput="renderLog()">
            <button onclick="closeLayer('log')"><i class="fas fa-times"></i></button>
        </header>
        <div class="modal-content" id="logContent"></div>
    </div>

    <div class="modal" id="detailModal">
        <header>
            <span class="title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</span>
            <button onclick="closeLayer('detail')"><i class="fas fa-times"></i></button>
        </header>
        <div class="modal-content detail" id="detailContent"></div>
    </div>

    <div class="modal" id="balanceActionModal">
        <header>
            <span class="title" id="actionModalTitle"></span>
            <button onclick="closeLayer('balanceAction')"><i class="fas fa-times"></i></button>
        </header>
        <div class="modal-content">
            <p style="text-align: center; font-size: 1.1em;">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="currentBalanceInAction" style="color: var(--p); font-weight: bold;"></span></p>
            <input id="bAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
            <input id="bDesc" placeholder="ğŸ“ ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Ù…Ø«Ù„: Ø±Ø§ØªØ¨ØŒ ØªØ­ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ)">
            <div class="datetime-container">
                <input id="bDate" type="datetime-local">
                <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
            </div>
            <button class="action" onclick="processBalanceAction()">
                <i class="fas fa-check" style="margin-left: 5px;"></i> ØªÙ†ÙÙŠØ°
            </button>
        </div>
    </div>
    
    <div class="modal" id="balanceLogModal">
        <header>
            <span class="title">Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯</span>
            <button onclick="closeLayer('balanceLog')"><i class="fas fa-times"></i></button>
        </header>
        <div class="modal-content" id="balanceLogContent"></div>
    </div>

    <div id="imageSourceModal">
        <h3 style="margin-bottom: 20px;">Ø§Ø®ØªÙŠØ§Ø± Ù…ØµØ¯Ø± Ø§Ù„ØµÙˆØ±Ø©</h3>
        <button class="action" onclick="openCameraInput()"><i class="fas fa-camera" style="margin-left: 10px;"></i> Ø§Ù„ØªÙ‚Ø§Ø· Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
        <button class="secondary" onclick="openGalleryInput()"><i class="fas fa-images" style="margin-left: 10px;"></i> Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ø¶</button>
        <button class="secondary" style="background: none; border: none; color: var(--danger); margin-top: 10px;" onclick="closeLayer('imageSource')">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
    <div class="sidebar-overlay" id="imageSourceOverlay" style="z-index: 140; display: none;" onclick="closeLayer('imageSource')"></div>

    <div class="modal" id="currencyModal">
        <header>
            <h3 style="color: var(--p);">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø©</h3>
            <button onclick="closeLayer('currency')"><i class="fas fa-times"></i></button>
        </header>
        <div class="modal-content">
            <input id="currencySearch" type="text" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„Ø© (Ø±ÙŠØ§Ù„ØŒ Ø¬Ù†ÙŠÙ‡ØŒ Ø¯ÙˆÙ„Ø§Ø±...)" oninput="renderCurrencyList()">
            <div id="currencyList"></div>
        </div>
    </div>

    <div class="modal" id="aboutModal">
        <header>
            <h3 style="color: var(--p);">Ø­ÙˆÙ„ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ©</h3>
            <button onclick="closeLayer('about')"><i class="fas fa-times"></i></button>
        </header>
        <div class="modal-content">
            <p>ØªØ·Ø¨ÙŠÙ‚ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© Ù‡Ùˆ Ø£Ø¯Ø§Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ ØªØªØ¨Ø¹:</p>
            <ul>
                <li><i class="fas fa-wallet" style="color: var(--s);"></i> **Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø©** Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.</li>
                <li><i class="fas fa-receipt" style="color: var(--s);"></i> **Ø§Ù„Ø­Ù‚ÙˆÙ‚** Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ù„Ùƒ (Ø¯ÙŠÙˆÙ†ØŒ Ø¨ÙŠØ¹ Ø¢Ø¬Ù„).</li>
                <li><i class="fas fa-clipboard-list" style="color: var(--s);"></i> **Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª** Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ø¹Ù„ÙŠÙƒ (ÙÙˆØ§ØªÙŠØ±ØŒ Ø£Ù‚Ø³Ø§Ø·ØŒ Ù‚Ø±ÙˆØ¶).</li>
            </ul>
            <p class="card" style="border-top: 3px solid var(--danger);">
                <strong>Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©:</strong> ÙŠØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ© IndexedDBØŒ ÙˆÙ„Ø§ ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ø£ÙŠ Ø®Ø§Ø¯Ù… Ø®Ø§Ø±Ø¬ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ.
            </p>
            <p style="text-align: center; margin-top: 20px; color: #999; font-size: 0.9em;">Ø§Ù„Ø¥ØµØ¯Ø§Ø± 3.1 (Ù…Ø·ÙˆØ± ÙˆÙ…Ø«Ø¨Øª)</p>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <div class="sidebar-overlay" onclick="closeLayer('sidebar')"></div>

    <div class="sidebar" id="appSidebar">
        <div class="sidebar-header">
            <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
            <button onclick="closeLayer('sidebar')"><i class="fas fa-times"></i></button>
        </div>
        <div class="sidebar-content">
            <div class="card" style="margin: 0 15px 15px; border-top: 5px solid var(--s);">
                 <p style="font-weight: bold; margin-top: 0; color: var(--p);">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</p>
                 
                 <div class="switch-container">
                     <i class="fas fa-moon" style="margin-left: 10px;"></i> <span>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span>
                     <label class="switch">
                         <input type="checkbox" id="darkModeToggle" onclick="toggleDarkMode()">
                         <span class="slider"></span>
                     </label>
                 </div>
                 
                 <button class="secondary" onclick="openCurrencyModal()" style="display: flex; justify-content: space-between; align-items: center; border: none; background: var(--card-bg); margin-top: 15px;">
                     <span id="currentCurrencyDisplay" style="font-weight: bold;">Ø§Ù„Ø¹Ù…Ù„Ø©: Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ (Ø±.Ø³)</span>
                     <span style="color: var(--p);"><i class="fas fa-exchange-alt"></i> ØªØºÙŠÙŠØ±</span>
                 </button>
            </div>
            
            <div class="sidebar-menu-item" onclick="exportData()">
                <i class="fas fa-file-export"></i> <span>ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</span>
            </div>
            
            <div class="sidebar-menu-item" onclick="document.getElementById('importFile').click()">
                <i class="fas fa-file-import"></i> <span>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</span>
            </div>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
            
            <div class="sidebar-menu-item" onclick="openAboutModal()">
                <i class="fas fa-info-circle"></i> <span>Ø­ÙˆÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>
            </div>
            
            <div class="sidebar-menu-item" onclick="confirmResetData()" style="color: var(--danger);">
                <i class="fas fa-exclamation-triangle"></i> <span>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
            </div>
        </div>
    </div>


    <script>
        // ===================================================
        // 1. Ø¥Ø¹Ø¯Ø§Ø¯ IndexedDB ÙˆÙ…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Øª
        // ===================================================

        const IDB_NAME = "MySmartBudgetDB";
        const IDB_VERSION = 4; 
        const STORE_NAMES = ["exp", "rig", "deb", "bal"]; 

        // Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        let db = { 
            exp: [], // Ù…ØµØ±ÙˆÙØ§Øª
            rig: [], // Ø­Ù‚ÙˆÙ‚ (Ø¯ÙŠÙˆÙ† Ù…Ø³ØªØ­Ù‚Ø© Ù„Ùƒ)
            deb: [], // Ø§Ù„ØªØ²Ø§Ù…Ø§Øª (Ø¯ÙŠÙˆÙ† Ù…Ø³ØªØ­Ù‚Ø© Ø¹Ù„ÙŠÙƒ)
            bal: { clientId: 1, amount: 0, changes: [] } // Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ³Ø¬Ù„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        }; 
        let IDB_connection = null; 

        // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
        let currentLog = "", editMode = null, balanceActionType = null;
        let currentBalance = 0; 
        let balanceHidden = localStorage.getItem('balanceHidden') === 'true'; 

        // Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ù‚Ù„ ÙˆØ§Ù„Ø·Ø¨Ù‚Ø§Øª (Modals, Sidebar)
        const LAYERS = {
            'sidebar': { elementId: 'appSidebar', type: 'menu' },
            'log': { elementId: 'logModal', type: 'modal' },
            'detail': { elementId: 'detailModal', type: 'modal' },
            'currency': { elementId: 'currencyModal', type: 'modal' },
            'about': { elementId: 'aboutModal', type: 'modal' },
            'balanceAction': { elementId: 'balanceActionModal', type: 'modal' },
            'balanceLog': { elementId: 'balanceLogModal', type: 'modal' }, 
            'imageSource': { elementId: 'imageSourceModal', type: 'menu' } 
        };
        let historyStack = []; // Ù„ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ (Back Button)

        // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©
        const ARABIC_CURRENCIES = [
            { code: 'SAR', symbol: 'Ø±.Ø³', name: 'Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ' },
            { code: 'EGP', symbol: 'Ø¬.Ù…', name: 'Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ' },
            { code: 'AED', symbol: 'Ø¯.Ø¥', name: 'Ø¯Ø±Ù‡Ù… Ø¥Ù…Ø§Ø±Ø§ØªÙŠ' },
            { code: 'KWD', symbol: 'Ø¯.Ùƒ', name: 'Ø¯ÙŠÙ†Ø§Ø± ÙƒÙˆÙŠØªÙŠ' },
            { code: 'USD', symbol: '$', name: 'Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ' },
            { code: 'QAR', symbol: 'Ø±.Ù‚', name: 'Ø±ÙŠØ§Ù„ Ù‚Ø·Ø±ÙŠ' },
            { code: 'OMR', symbol: 'Ø±.Ø¹.', name: 'Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ' },
            { code: 'JOD', symbol: 'Ø¯.Ø§', name: 'Ø¯ÙŠÙ†Ø§Ø± Ø£Ø±Ø¯Ù†ÙŠ' },
            { code: 'EUR', symbol: 'â‚¬', name: 'ÙŠÙˆØ±Ùˆ' },
        ];
        let currentCurrency = ARABIC_CURRENCIES.find(c => c.code === (localStorage.getItem('currencyCode') || 'SAR'));


        // ===================================================
        // 2. ÙˆØ¸Ø§Ø¦Ù IndexedDB (Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©)
        // ===================================================

        function initDB() {
            return new Promise((resolve, reject) => {
                if (!window.indexedDB) {
                    toastMsg("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… IndexedDB. Ù„Ù† ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
                    return reject(new Error("IndexedDB not supported."));
                }

                const request = indexedDB.open(IDB_NAME, IDB_VERSION);

                request.onerror = (e) => {
                    console.error("IndexedDB error:", e.target.error);
                    reject(e.target.error);
                };

                request.onupgradeneeded = (e) => {
                    IDB_connection = e.target.result;
                    STORE_NAMES.forEach(storeName => {
                        // Ø­Ø°Ù Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«
                        if (IDB_connection.objectStoreNames.contains(storeName)) {
                            IDB_connection.deleteObjectStore(storeName); 
                        }
                        
                        const keyPath = (storeName === 'bal') ? 'clientId' : 'id'; 
                        const autoIncrement = (storeName !== 'bal'); 
                        const store = IDB_connection.createObjectStore(storeName, { keyPath: keyPath, autoIncrement: autoIncrement });

                        // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                        if(storeName === 'bal') {
                            store.add({ clientId: 1, amount: 0, changes: [] });
                        }
                    });
                };
                
                request.onsuccess = (e) => {
                    IDB_connection = e.target.result;
                    resolve(IDB_connection);
                    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù†Ø§Ø¬Ø­
                    loadAllData().then(() => {
                        updateStats();
                        updateBalanceDisplay();
                    });
                };
            });
        }
        initDB();

        /** Ø­ÙØ¸ Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù…ØªØ¬Ø± Ù…Ø­Ø¯Ø¯ */
        function saveData(storeName, data) {
            return new Promise((resolve, reject) => {
                if (!IDB_connection) return reject(new Error("Database not connected."));

                const transaction = IDB_connection.transaction([storeName], "readwrite");
                const store = transaction.objectStore(storeName);
                const request = store.put(data); 

                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /** Ø­Ø°Ù Ø³Ø¬Ù„ Ù…Ù† Ù…ØªØ¬Ø± Ù…Ø­Ø¯Ø¯ */
        function deleteFromDB(storeName, id) {
            return new Promise((resolve, reject) => {
                if (!IDB_connection) return reject(new Error("Database not connected."));

                const transaction = IDB_connection.transaction([storeName], "readwrite");
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /** ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…ØªØ¬Ø± Ù…Ø­Ø¯Ø¯ */
        function loadStoreData(storeName) {
            return new Promise((resolve) => {
                if (!IDB_connection) return resolve([]);
                
                const transaction = IDB_connection.transaction([storeName], "readonly");
                const store = transaction.objectStore(storeName);
                const request = store.getAll();

                request.onsuccess = (e) => {
                    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø§ØµØ© Ù„Ù…ØªØ¬Ø± Ø§Ù„Ø±ØµÙŠØ¯ (bal) Ù„Ø£Ù†Ù‡ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø³Ø¬Ù„ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·
                    if(storeName === 'bal') {
                        const result = e.target.result[0];
                        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¬Ù„ØŒ Ù†Ø±Ø¬Ø¹ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                        return resolve(result || { clientId: 1, amount: 0, changes: [] });
                    }
                    // Ø¹ÙƒØ³ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
                    resolve(e.target.result.reverse());
                };
                request.onerror = () => resolve(storeName === 'bal' ? { clientId: 1, amount: 0, changes: [] } : []);
            });
        }

        /** ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØ§Ø¬Ø± */
        async function loadAllData() {
            const [expData, rigData, debData, balData] = await Promise.all([
                loadStoreData('exp'),
                loadStoreData('rig'),
                loadStoreData('deb'),
                loadStoreData('bal'),
            ]);
            db.exp = expData;
            db.rig = rigData;
            db.deb = debData;
            db.bal = balData;
            currentBalance = db.bal.amount || 0;
        }

        // ===================================================
        // 3. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆØ§Ù„ØªÙ†Ø³ÙŠÙ‚
        // ===================================================

        /** ÙŠØ¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø¥Ø´Ø¹Ø§Ø± Ù…Ø¤Ù‚ØªØ© (Toast) */
        function toastMsg(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2500);
        }
        
        /** ÙŠÙ…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙÙŠ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        function clearInputFields(prefix) {
            document.getElementById(prefix + 'Amount').value = '';
            document.getElementById(prefix + 'Desc').value = '';
            
            const typeElement = document.getElementById(prefix + 'Type');
            if(typeElement) typeElement.value = '';
            
            const statusElement = document.getElementById(prefix + 'Status');
            if(statusElement) statusElement.value = '';

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
            const dynamicFields = document.getElementById(prefix + 'DynamicFields');
            if (dynamicFields) dynamicFields.innerHTML = '';

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚Ù„ Ø§Ù„ØµÙˆØ±Ø©
            if (prefix === 'e') {
                document.getElementById('eImgName').textContent = '';
                document.getElementById('eImgCamera').value = null;
                document.getElementById('eImgGallery').value = null;
            }
        }
        
        /** ÙŠÙ‚ÙˆÙ… Ø¨ØªÙ‡ÙŠØ¦Ø© Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ù„Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© */
        function setDefaultDateTime(prefix) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            const formattedDate = `${year}-${month}-${day}T${hours}:${minutes}`;
            document.getElementById(prefix + 'Date').value = formattedDate;
        }
        
        /** ØªÙ†Ø³ÙŠÙ‚ Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ù„ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙÙˆØ§ØµÙ„ Ø¢Ù„Ø§Ù */
        function formatAmount(input) {
            let value = input.value.replace(/[^0-9.]/g, ''); // Ø¥Ø²Ø§Ù„Ø© ØºÙŠØ± Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆÙ†Ù‚Ø·Ø© ÙˆØ§Ø­Ø¯Ø©
            
            // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø¹Ø´Ø±ÙŠØ© (Ø§Ù„Ù†Ù‚Ø·Ø©)
            const parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }

            // Ø¥Ø²Ø§Ù„Ø© ÙÙˆØ§ØµÙ„ Ø§Ù„Ø¢Ù„Ø§Ù Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
            value = value.replace(/,/g, '');

            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„ØµØ­ÙŠØ­ ÙˆØ§Ù„Ø¹Ø´Ø±ÙŠ
            const integerPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            const decimalPart = parts.length > 1 ? '.' + parts[1] : '';

            // Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‚ÙŠÙ…Ø© ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
            input.value = integerPart + decimalPart;
        }

        /** ÙŠØ­ÙˆÙ„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø© Ù…Ù† Ù†Øµ Ù…Ù†Ø³Ù‚ Ø¥Ù„Ù‰ Ø±Ù‚Ù… (Float) */
        function parseAmount(formattedAmount) {
            if (!formattedAmount) return 0;
            // Ø¥Ø²Ø§Ù„Ø© ÙÙˆØ§ØµÙ„ Ø§Ù„Ø¢Ù„Ø§Ù
            const cleaned = String(formattedAmount).replace(/,/g, ''); 
            // Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø±Ù‚Ù… Ø¹Ø´Ø±ÙŠ
            return parseFloat(cleaned) || 0;
        }

        /** ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ø¹Ø±Ø¶Ù‡ Ù…Ø¹ Ø§Ù„Ø¹Ù…Ù„Ø© */
        function formatCurrency(amount) {
            const formatted = parseAmount(amount).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            // Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø¹Ø±Ø¨ÙŠ (Ø§Ù„Ø¹Ù…Ù„Ø© ÙŠÙ…ÙŠÙ†Ù‹Ø§)
            return `<span class="currency-symbol">${currentCurrency.symbol}</span>${formatted}`;
        }

        /** ÙŠØ­Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© */
        function setCurrency(currencyCode) {
            const newCurrency = ARABIC_CURRENCIES.find(c => c.code === currencyCode);
            if (newCurrency) {
                currentCurrency = newCurrency;
                localStorage.setItem('currencyCode', currencyCode);
                updateCurrencyDisplay();
                updateStats(); // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                updateBalanceDisplay();
                toastMsg(`ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰: ${newCurrency.name}`);
                closeLayer('currency');
            }
        }

        /** ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        function updateCurrencyDisplay() {
            document.getElementById('currentCurrencyDisplay').textContent = 
                `Ø§Ù„Ø¹Ù…Ù„Ø©: ${currentCurrency.name} (${currentCurrency.symbol})`;
        }


        // ===================================================
        // 4. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø³ÙˆÙ…ÙŠØ© ÙˆØ§Ù„ØªÙ†Ù‚Ù„
        // ===================================================

        /** ØªØ­Ù…ÙŠÙ„ ØªÙØ¶ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
        function loadDarkModePreference() {
            const isDark = localStorage.getItem('darkMode') === 'true';
            if (isDark) {
                document.body.classList.add('dark-mode');
                const toggle = document.getElementById('darkModeToggle');
                if (toggle) toggle.checked = true;
            }
        }
        loadDarkModePreference();

        /** ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
        function toggleDarkMode() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDark);
        }

        /** ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯ Ø¨ÙŠÙ† Ù…Ø®ÙÙŠ ÙˆÙ…Ø±Ø¦ÙŠ */
        function toggleBalanceVisibility() {
            balanceHidden = !balanceHidden;
            localStorage.setItem('balanceHidden', balanceHidden);
            updateBalanceDisplay();
        }

        /** Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù†Ø´Ø· ÙˆØªØ¨Ø¯ÙŠÙ„ Ø²Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø© */
        function openTab(tabId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');

            document.querySelectorAll('.tabs button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`.tabs button[onclick="openTab('${tabId}')"]`).classList.add('active');
            
            // ØªÙ‡ÙŠØ¦Ø© Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØªØ¨ÙˆÙŠØ¨Ø© Ø¬Ø¯ÙŠØ¯Ø©
            if(tabId === 'expenses') setDefaultDateTime('e');
            if(tabId === 'rights') {setDefaultDateTime('r'); updateRightFields(document.getElementById('rType').value);}
            if(tabId === 'debts') {setDefaultDateTime('d'); updateDebtFields(document.getElementById('dType').value);}

            history.replaceState({ layer: 'main', tab: tabId }, null, `#${tabId}`);
            if (historyStack.length === 0 || historyStack[0].layer !== 'main') {
                historyStack.splice(0, historyStack.length, { layer: 'main', tab: tabId });
            }
        }

        /** ÙˆØ¸ÙŠÙØ© Ø¯Ø§Ø®Ù„ÙŠØ© Ù„ÙØªØ­ Ø£ÙŠ Ø·Ø¨Ù‚Ø© (Modal/Sidebar) Ø¨ØµØ±ÙŠØ§Ù‹ */
        function _visualOpen(layerName, data = {}) {
            const layer = LAYERS[layerName];
            if (!layer) return;
            const element = document.getElementById(layer.elementId);
            
            if (layer.type === 'modal') {
                element.style.display = 'flex';
                // ØªÙ‡ÙŠØ¦Ø© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù€ Modal Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
                if (layerName === 'log') {
                    currentLog = data.logType;
                    renderLog();
                } else if (layerName === 'detail') {
                    const o = db[data.logType].find(item => item.id === data.id);
                    if (!o) return toastMsg("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.");
                    const index = db[data.logType].findIndex(item => item.id === data.id);
                    editMode = { type: data.logType, index: index };
                    _renderDetailContent(o, data.logType);
                } else if (layerName === 'balanceAction') {
                    balanceActionType = data.actionType;
                    document.getElementById('actionModalTitle').textContent = balanceActionType === 'deposit' ? 'Ø¥ÙŠØ¯Ø§Ø¹ Ø±ØµÙŠØ¯ Ø¬Ø¯ÙŠØ¯' : 'Ø³Ø­Ø¨/ØªØ­ÙˆÙŠÙ„ Ø±ØµÙŠØ¯';
                    document.getElementById('currentBalanceInAction').innerHTML = formatCurrency(currentBalance);
                    document.getElementById('bAmount').value = '';
                    document.getElementById('bDesc').value = '';
                    setDefaultDateTime('b');
                } else if (layerName === 'currency') {
                    document.getElementById('currencySearch').value = '';
                    renderCurrencyList();
                } else if (layerName === 'balanceLog') {
                    renderBalanceLog();
                }
            } else if (layer.type === 'menu') {
                element.classList.add('open');
                const overlay = document.querySelector(layerName === 'imageSource' ? '#imageSourceOverlay' : '.sidebar-overlay');
                if (overlay) overlay.classList.add('open');
            }
        }

        /** ÙˆØ¸ÙŠÙØ© Ø¯Ø§Ø®Ù„ÙŠØ© Ù„Ø¥ØºÙ„Ø§Ù‚ Ø£ÙŠ Ø·Ø¨Ù‚Ø© (Modal/Sidebar) Ø¨ØµØ±ÙŠØ§Ù‹ */
        function _visualClose(layerName, clearEdit = true) {
            const layer = LAYERS[layerName];
            if (!layer) return;
            const element = document.getElementById(layer.elementId);

            if (layer.type === 'modal') {
                element.style.display = 'none';
                if (clearEdit && (layerName === 'detail' || layerName === 'log')) {
                    editMode = null;
                }
            } else if (layer.type === 'menu') {
                element.classList.remove('open');
                const overlay = document.querySelector(layerName === 'imageSource' ? '#imageSourceOverlay' : '.sidebar-overlay');
                if (overlay) overlay.classList.remove('open');
            }
        }

        /** ÙŠÙØªØ­ Ø·Ø¨Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆÙŠØ¶ÙŠÙÙ‡Ø§ Ø¥Ù„Ù‰ Ù…ÙƒØ¯Ø³ Ø§Ù„ØªØ§Ø±ÙŠØ® */
        function openLayer(layerName, data = {}) {
            // ØªØ¬Ù†Ø¨ Ø§Ù„ÙØªØ­ Ø§Ù„Ù…ØªÙƒØ±Ø± Ù„Ù†ÙØ³ Ø§Ù„Ø·Ø¨Ù‚Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª
            if (historyStack.length > 0 && historyStack[historyStack.length - 1].layer === layerName) return; 

            const state = { layer: layerName, data: data };
            historyStack.push(state);
            history.pushState(state, null, `#${layerName}`);
            _visualOpen(layerName, data);
        }

        /** ÙŠØºÙ„Ù‚ Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ */
        function closeLayer(layerName) {
            const top = historyStack[historyStack.length - 1];
            if (top && top.layer === layerName) {
                history.back(); // Ù‡Ø°Ø§ Ø³ÙŠÙ‚ÙˆÙ… Ø¨ØªØ´ØºÙŠÙ„ window.onpopstate
            } else {
                _visualClose(layerName);
            }
        }

        /** Ù…Ø¹Ø§Ù„Ø¬ Ø­Ø¯Ø« Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ */
        window.onpopstate = (event) => {
            const closedLayer = historyStack.pop();
            if (closedLayer) {
                _visualClose(closedLayer.layer, false); // Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨ØµØ±ÙŠ Ù„Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…ØºÙ„Ù‚Ø©
            }
            
            if (historyStack.length === 0) {
                // Ø¥Ø°Ø§ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ø¨Ù‚Ø§ØªØŒ Ù†Ø¹ÙˆØ¯ Ø¥Ù„Ù‰ Ø­Ø§Ù„Ø© 'main' Ø£Ùˆ Ø§Ù„Ø®Ø±ÙˆØ¬
                const mainState = { layer: 'main', tab: 'overview' };
                historyStack.push(mainState);
                history.replaceState(mainState, null, `#overview`);
                openTab('overview');
            } else {
                const newTop = historyStack[historyStack.length - 1];
                if (newTop.layer !== 'main') {
                    _visualOpen(newTop.layer, newTop.data); // ÙØªØ­ Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø§Ù„Ù‚Ù…Ø©
                } else {
                    openTab(newTop.tab);
                }
            }
        };

        /** ØªÙ‡ÙŠØ¦Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© */
        window.onload = () => {
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙØ­Ø© Ù…Ø­Ù…Ù„Ø© Ø­Ø¯ÙŠØ«Ù‹Ø§ ÙˆÙ„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø§Ù„Ø©ØŒ Ù†Ø¨Ø¯Ø£ Ù…Ù† 'main'
            if (history.state === null || history.state.layer === undefined) {
                const initialTab = 'overview';
                const mainState = { layer: 'main', tab: initialTab };
                history.replaceState(mainState, null, `#${initialTab}`);
                historyStack.push(mainState);
                openTab(initialTab);
            } else {
                historyStack.push(history.state);
                if (history.state.layer === 'main' && history.state.tab) {
                    openTab(history.state.tab);
                } else {
                    _visualOpen(history.state.layer, history.state.data || {});
                }
            }
        };

        // Ø¯ÙˆØ§Ù„ API Ù…Ø¨Ø³Ø·Ø© Ù„ÙØªØ­ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª
        function openSidebar() { openLayer('sidebar'); }
        function openBalanceLogModal() { openLayer('balanceLog'); }
        function openBalanceActionModal(type) { openLayer('balanceAction', { actionType: type }); }
        function openLog(t) { openLayer('log', { logType: t }); }
        function openAboutModal() { openLayer('about'); }
        function openCurrencyModal() { openLayer('currency'); }
        function showImageSourceModal() { openLayer('imageSource'); }
        
        // Ø¯ÙˆØ§Ù„ ÙØªØ­ Ø­Ù‚Ù„ Ø§Ù„ØµÙˆØ±Ø©
        function openCameraInput() { document.getElementById('eImgCamera').click(); closeLayer('imageSource'); }
        function openGalleryInput() { document.getElementById('eImgGallery').click(); closeLayer('imageSource'); }

        /** Ù„ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚ Ù„Ù„Ø¹Ø±Ø¶ */
        function updateFileName(input, displayId) {
            const fileName = input.files[0] ? input.files[0].name : '';
            document.getElementById(displayId).textContent = fileName ? `âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù: ${fileName}` : '';
        }

        /** Ù„Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Øª ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø© */
        function renderCurrencyList() {
            const container = document.getElementById('currencyList');
            const searchTerm = document.getElementById('currencySearch').value.toLowerCase();
            container.innerHTML = '';

            const fragment = document.createDocumentFragment();

            ARABIC_CURRENCIES.filter(c => 
                c.name.toLowerCase().includes(searchTerm) || 
                c.code.toLowerCase().includes(searchTerm)
            ).forEach(currency => {
                const isCurrent = currency.code === currentCurrency.code;
                const div = document.createElement('div');
                div.className = 'list-item';
                if (isCurrent) {
                    div.style.borderRight = `5px solid var(--p)`;
                    div.style.fontWeight = 'bold';
                }
                div.onclick = () => setCurrency(currency.code);
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--p);">${currency.symbol}</span>
                        <span>${currency.name} (${currency.code})</span>
                        ${isCurrent ? '<i class="fas fa-check-circle" style="color: var(--success);"></i>' : ''}
                    </div>
                `;
                fragment.appendChild(div);
            });

            container.appendChild(fragment);
        }


        // ===================================================
        // 5. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ (Business Logic)
        // ===================================================

        /** ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ */
        function updateBalanceDisplay() {
            const display = document.getElementById('currentBalanceDisplay');
            const toggleIcon = document.getElementById('balanceVisibilityToggle').querySelector('i');

            if (balanceHidden) {
                display.innerHTML = '<span class="hidden-balance">â€¢â€¢â€¢â€¢â€¢â€¢</span>';
                toggleIcon.className = 'fas fa-eye-slash';
            } else {
                display.innerHTML = formatCurrency(currentBalance);
                toggleIcon.className = 'fas fa-eye';
            }
        }

        /** ØªØ­Ø¯ÙŠØ« Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© */
        function updateStats() {
            const expTotal = db.exp.reduce((sum, item) => sum + item.amount, 0);
            const rigTotal = db.rig.reduce((sum, item) => sum + item.amount, 0);
            const debTotal = db.deb.reduce((sum, item) => sum + item.amount, 0);
            
            const rigPaid = db.rig.filter(r => r.status === 'ÙƒØ§Ù…Ù„' && r.paymentType === 'Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯').reduce((sum, item) => sum + item.paidAmount, 0);
            const debPaid = db.deb.filter(d => d.status === 'Ù…Ø¯ÙÙˆØ¹' && d.paymentType === 'Ø®ØµÙ… Ø±ØµÙŠØ¯').reduce((sum, item) => sum + item.paidAmount, 0);

            document.getElementById('sExpTotal').innerHTML = formatCurrency(expTotal);
            document.getElementById('sRigTotal').innerHTML = formatCurrency(rigTotal);
            document.getElementById('sDebTotal').innerHTML = formatCurrency(debTotal);
            document.getElementById('sRigPaid').innerHTML = formatCurrency(rigPaid);
            document.getElementById('sDebPaid').innerHTML = formatCurrency(debPaid);
        }

        /** Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø¶Ø§ÙØ©/Ø³Ø­Ø¨ Ø±ØµÙŠØ¯ (Deposit/Withdraw) */
        async function processBalanceAction() {
            const amount = parseAmount(document.getElementById('bAmount').value);
            const desc = document.getElementById('bDesc').value.trim();
            const date = document.getElementById('bDate').value;
            const type = balanceActionType;

            if (amount <= 0) return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„ØµÙØ±.");
            if (!desc) return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØµÙ Ù„Ù„Ø¹Ù…Ù„ÙŠØ©.");
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯
            if (type === 'deposit') {
                currentBalance += amount;
                toastMsg(`ØªÙ… Ø¥ÙŠØ¯Ø§Ø¹ ${formatCurrency(amount)} Ø¨Ù†Ø¬Ø§Ø­.`);
            } else if (type === 'withdraw') {
                if (amount > currentBalance) return toastMsg("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø³Ø­Ø¨ Ù…Ø¨Ù„Øº Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ.");
                currentBalance -= amount;
                toastMsg(`ØªÙ… Ø³Ø­Ø¨ ${formatCurrency(amount)} Ø¨Ù†Ø¬Ø§Ø­.`);
            }

            // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ø±ØµÙŠØ¯
            db.bal.amount = currentBalance;
            db.bal.changes.unshift({
                id: Date.now(),
                type: type,
                amount: amount,
                desc: desc,
                date: date,
                newBalance: currentBalance
            });
            await saveData('bal', db.bal);

            updateBalanceDisplay();
            closeLayer('balanceAction');
        }


        /** Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯ */
        async function addExpense() {
            const amount = parseAmount(document.getElementById('eAmount').value);
            const type = document.getElementById('eType').value;
            const desc = document.getElementById('eDesc').value.trim();
            const date = document.getElementById('eDate').value;
            const imgName = document.getElementById('eImgName').textContent.replace('âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù: ', '').trim();
            
            if (amount <= 0 || !type || !desc) {
                return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„ÙØ¦Ø© ÙˆØ§Ù„ÙˆØµÙ.");
            }
            if (amount > currentBalance) {
                if (!confirm(`ØªØ­Ø°ÙŠØ±: Ø§Ù„Ù…ØµØ±ÙˆÙ ${formatCurrency(amount)} Ø£ÙƒØ¨Ø± Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ${formatCurrency(currentBalance)}. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`)) {
                    return;
                }
            }

            const newExpense = {
                id: Date.now(),
                amount: amount,
                type: type,
                desc: desc,
                date: date,
                imgName: imgName
            };

            // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ­ÙØ¸ Ø­Ø±ÙƒØ© Ø§Ù„Ø±ØµÙŠØ¯
            currentBalance -= amount;
            db.bal.amount = currentBalance;
            db.bal.changes.unshift({
                id: newExpense.id,
                type: 'expense',
                amount: amount,
                desc: desc,
                date: date,
                newBalance: currentBalance
            });

            // 2. Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            const newId = await saveData('exp', newExpense);
            db.exp.unshift({ ...newExpense, id: newId });
            await saveData('bal', db.bal);
            
            // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            updateBalanceDisplay();
            updateStats();
            clearInputFields('e');
            setDefaultDateTime('e');
            toastMsg(`ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ ÙˆØ®ØµÙ… ${formatCurrency(amount)}.`);
        }

        /** Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ Ø¬Ø¯ÙŠØ¯ (Ø¯ÙŠÙ† Ø£Ùˆ Ø¨ÙŠØ¹ Ø¢Ø¬Ù„) */
        async function addRight() {
            const amount = parseAmount(document.getElementById('rAmount').value);
            const type = document.getElementById('rType').value;
            const desc = document.getElementById('rDesc').value.trim();
            const date = document.getElementById('rDate').value;
            const status = document.getElementById('rStatus').value;
            const paidAmountElement = document.getElementById('rPaidAmount');
            const paidAmount = paidAmountElement ? parseAmount(paidAmountElement.value) : 0;
            
            if (amount <= 0 || !type || !desc || !status) {
                return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.");
            }
            if (paidAmount > amount) {
                 return toastMsg("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø­Ù‚.");
            }

            const newRight = {
                id: Date.now(),
                amount: amount,
                type: type,
                desc: desc,
                date: date,
                status: status,
                paidAmount: paidAmount,
                paymentType: paidAmount > 0 ? 'Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯',
                remaining: amount - paidAmount
            };

            // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø¨Ù„Øº Ù…Ø­ØµÙ„
            if (paidAmount > 0) {
                currentBalance += paidAmount;
                db.bal.amount = currentBalance;
                db.bal.changes.unshift({
                    id: newRight.id,
                    type: 'right_collected',
                    amount: paidAmount,
                    desc: `ØªØ­ØµÙŠÙ„ ${type} Ù…Ù† ${desc}`,
                    date: date,
                    newBalance: currentBalance
                });
                await saveData('bal', db.bal);
                toastMsg(`ØªÙ… ØªØ­ØµÙŠÙ„ ${formatCurrency(paidAmount)} ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ø±ØµÙŠØ¯.`);
            }

            // 2. Ø­ÙØ¸ Ø§Ù„Ø­Ù‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            const newId = await saveData('rig', newRight);
            db.rig.unshift({ ...newRight, id: newId });

            // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            updateBalanceDisplay();
            updateStats();
            clearInputFields('r');
            setDefaultDateTime('r');
            toastMsg(`ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø­Ù‚ Ø¨Ù†Ø¬Ø§Ø­.`);
        }

        /** Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ²Ø§Ù… Ø¬Ø¯ÙŠØ¯ (ÙØ§ØªÙˆØ±Ø©ØŒ Ù‚Ø±Ø¶ØŒ Ø¥ÙŠØ¬Ø§Ø±) */
        async function addDebt() {
            const amount = parseAmount(document.getElementById('dAmount').value);
            const type = document.getElementById('dType').value;
            const desc = document.getElementById('dDesc').value.trim();
            const date = document.getElementById('dDate').value;
            const status = document.getElementById('dStatus').value;
            const paidAmount = (status === 'Ù…Ø¯ÙÙˆØ¹') ? amount : 0;
            
            if (amount <= 0 || !type || !desc || !status) {
                return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.");
            }

            if (status === 'Ù…Ø¯ÙÙˆØ¹' && amount > currentBalance) {
                if (!confirm(`ØªØ­Ø°ÙŠØ±: Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹ ${formatCurrency(amount)} Ø£ÙƒØ¨Ø± Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ${formatCurrency(currentBalance)}. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`)) {
                    return;
                }
            }

            const newDebt = {
                id: Date.now(),
                amount: amount,
                type: type,
                desc: desc,
                date: date,
                status: status,
                paidAmount: paidAmount,
                paymentType: status === 'Ù…Ø¯ÙÙˆØ¹' ? 'Ø®ØµÙ… Ø±ØµÙŠØ¯' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯',
                remaining: status === 'Ù…Ø¯ÙÙˆØ¹' ? 0 : amount
            };

            // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ù…Ø¯ÙÙˆØ¹Ù‹Ø§
            if (status === 'Ù…Ø¯ÙÙˆØ¹') {
                currentBalance -= amount;
                db.bal.amount = currentBalance;
                db.bal.changes.unshift({
                    id: newDebt.id,
                    type: 'debt_paid',
                    amount: amount,
                    desc: `Ø¯ÙØ¹ ${type} Ù„Ù€ ${desc}`,
                    date: date,
                    newBalance: currentBalance
                });
                await saveData('bal', db.bal);
                toastMsg(`ØªÙ… Ø¯ÙØ¹ ${formatCurrency(amount)} ÙˆØ®ØµÙ…Ù‡ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯.`);
            }

            // 2. Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
            const newId = await saveData('deb', newDebt);
            db.deb.unshift({ ...newDebt, id: newId });

            // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            updateBalanceDisplay();
            updateStats();
            clearInputFields('d');
            setDefaultDateTime('d');
            toastMsg(`ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­.`);
        }


        /** Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ù…ØµØ±ÙˆÙØ§ØªØŒ Ø­Ù‚ÙˆÙ‚ØŒ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª) */
        function renderLog() {
            const logType = currentLog;
            const data = db[logType];
            const container = document.getElementById('logContent');
            const searchTerm = document.getElementById('search').value.toLowerCase().trim();
            container.innerHTML = '';
            
            let filteredData = data;
            if (searchTerm) {
                 filteredData = data.filter(item => 
                    item.desc.toLowerCase().includes(searchTerm) ||
                    (item.type && item.type.toLowerCase().includes(searchTerm)) ||
                    formatCurrency(item.amount).replace(/[^0-9.]/g, '').includes(searchTerm.replace(/[^0-9.]/g, ''))
                );
            }

            if (filteredData.length === 0) {
                container.innerHTML = `<p style="text-align: center; color: #999; margin-top: 50px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©.</p>`;
                return;
            }

            const fragment = document.createDocumentFragment();
            filteredData.forEach(item => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.onclick = () => openLayer('detail', { logType: logType, id: item.id });

                let amountColor, icon, subInfo, borderS;

                if (logType === 'exp') {
                    amountColor = 'var(--danger)';
                    icon = 'fas fa-money-bill-wave';
                    subInfo = item.type;
                    borderS = 'var(--danger)';
                } else if (logType === 'rig') {
                    amountColor = item.status === 'ÙƒØ§Ù…Ù„' ? 'var(--success)' : 'var(--warning)';
                    icon = 'fas fa-handshake';
                    subInfo = item.desc;
                    borderS = 'var(--success)';
                } else if (logType === 'deb') {
                    amountColor = item.status === 'Ù…Ø¯ÙÙˆØ¹' ? 'var(--success)' : 'var(--danger)';
                    icon = 'fas fa-file-invoice';
                    subInfo = item.desc;
                    borderS = 'var(--danger)';
                }
                
                div.style.borderRight = `5px solid ${borderS}`;
                
                const paidInfo = (logType === 'rig' || logType === 'deb') ? 
                    `<span style="color: #666; font-size: 0.85em;">(${formatCurrency(item.paidAmount)} Ù…Ø¯ÙÙˆØ¹)</span>` : '';

                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: bold; color: ${amountColor};">${formatCurrency(item.amount)}</span>
                        <span style="font-size: 1.1em;"><i class="${icon}" style="margin-left: 5px; color: ${borderS};"></i> ${subInfo}</span>
                    </div>
                    <div class="details">
                        <span>${new Date(item.date).toLocaleDateString('ar-EG', { dateStyle: 'medium' })}</span>
                        ${logType === 'exp' ? `<span>${item.desc}</span>` : `<span>${item.status} ${paidInfo}</span>`}
                    </div>
                `;
                fragment.appendChild(div);
            });
            container.appendChild(fragment);
        }

        /** Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯ ÙÙ‚Ø· */
        function renderBalanceLog() {
            const container = document.getElementById('balanceLogContent');
            const data = db.bal.changes; 
            container.innerHTML = '';

            if (data.length === 0) {
                container.innerHTML = `<p style="text-align: center; color: #999; margin-top: 50px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø±ØµÙŠØ¯.</p>`;
                return;
            }

            const fragment = document.createDocumentFragment();
            data.forEach(item => {
                const isDeposit = item.type === 'deposit' || item.type === 'right_collected';
                const amountColor = isDeposit ? 'var(--success)' : 'var(--danger)';
                const icon = isDeposit ? 'fas fa-arrow-up' : 'fas fa-arrow-down';
                const actionText = (item.type === 'deposit') ? 'Ø¥ÙŠØ¯Ø§Ø¹' : 
                                   (item.type === 'withdraw') ? 'Ø³Ø­Ø¨' : 
                                   (item.type === 'expense') ? 'Ù…ØµØ±ÙˆÙ' : 
                                   (item.type === 'debt_paid') ? 'Ø¯ÙØ¹ Ø§Ù„ØªØ²Ø§Ù…' : 
                                   (item.type === 'right_collected') ? 'ØªØ­ØµÙŠÙ„ Ø­Ù‚' : item.type;
                
                const div = document.createElement('div');
                div.className = 'list-item';
                div.style.borderRight = `5px solid ${isDeposit ? 'var(--success)' : 'var(--danger)'}`;
                
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: bold; color: ${amountColor};">
                            <i class="${icon}" style="margin-left: 5px;"></i> ${formatCurrency(item.amount)}
                        </span>
                        <span style="font-size: 1.1em;">${actionText}</span>
                    </div>
                    <div class="details">
                        <span>${new Date(item.date).toLocaleDateString('ar-EG', { dateStyle: 'medium' })}</span>
                        <span style="color: var(--p);">Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯: ${formatCurrency(item.newBalance)}</span>
                    </div>
                    <div style="font-size: 0.9em; color: #999; margin-top: 5px;">
                        ${item.desc || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}
                    </div>
                `;
                fragment.appendChild(div);
            });
            container.appendChild(fragment);
        }

        /** Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù…Ø¹ Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù */
        function _renderDetailContent(item, logType) {
            const container = document.getElementById('detailContent');
            const typeLabels = { 'exp': 'Ù…ØµØ±ÙˆÙ', 'rig': 'Ø­Ù‚', 'deb': 'Ø§Ù„ØªØ²Ø§Ù…' };
            const type = typeLabels[logType] || 'Ù…Ø¹Ø§Ù…Ù„Ø©';
            const amountColor = (logType === 'rig' && item.status === 'ÙƒØ§Ù…Ù„') || (logType === 'deb' && item.status === 'Ù…Ø¯ÙÙˆØ¹') || logType === 'exp' ? 'var(--p)' : 'var(--danger)';

            let contentHTML = `
                <div class="card" style="border-top: 5px solid ${logType === 'rig' ? 'var(--success)' : 'var(--danger)'};">
                    <p><strong><i class="fas fa-tag"></i> Ø§Ù„Ù†ÙˆØ¹:</strong> ${item.type || type}</p>
                    <p><strong><i class="fas fa-calendar-alt"></i> Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date(item.date).toLocaleDateString('ar-EG', { dateStyle: 'full', timeStyle: 'short' })}</p>
                    <p><strong><i class="fas fa-comment-alt"></i> Ø§Ù„ÙˆØµÙ/Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ${item.desc || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>
                    <p style="font-size: 1.3em; font-weight: bold; color: ${amountColor}; border-top: 1px solid var(--border-color); padding-top: 10px;">
                        <i class="fas fa-coins" style="margin-left: 5px;"></i> Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ: ${formatCurrency(item.amount)}
                    </p>
            `;

            if (logType === 'exp' && item.imgName) {
                 contentHTML += `<p><strong><i class="fas fa-image"></i> ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> ${item.imgName}</p>`;
            } else if (logType === 'rig' || logType === 'deb') {
                contentHTML += `
                    <p><strong><i class="fas fa-check-circle"></i> Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span style="font-weight: bold; color: ${item.status.includes('Ù…Ø¯ÙÙˆØ¹') || item.status.includes('ÙƒØ§Ù…Ù„') ? 'var(--success)' : 'var(--danger)'}">${item.status}</span></p>
                    <p><strong><i class="fas fa-money-bill-wave"></i> Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong> ${formatCurrency(item.paidAmount)}</p>
                    <p><strong><i class="fas fa-hourglass-half"></i> Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> ${formatCurrency(item.remaining)}</p>
                    <p><strong><i class="fas fa-exchange-alt"></i> ØªØ£Ø«ÙŠØ± Ø§Ù„Ø­Ø±ÙƒØ©:</strong> ${item.paymentType}</p>
                `;
            }
            contentHTML += '</div>';
            
            // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
            contentHTML += `
                <div class="card" style="display: flex; gap: 10px; border-top: 5px solid var(--s);">
                    <button class="action" style="flex: 1; background: var(--s);" onclick="editTransaction()"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="action" style="flex: 1; background: var(--danger);" onclick="confirmDeleteTransaction()"><i class="fas fa-trash"></i> Ø­Ø°Ù</button>
                </div>
            `;
            container.innerHTML = contentHTML;
        }
        
        /** Ø¨Ø¯Ø£ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ù„Ù… ÙŠØªÙ… ØªÙ†ÙÙŠØ° ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø© ÙÙŠ Ø§Ù„Ø£ØµÙ„ØŒ Ù„ÙƒÙ† Ù†Ø¬Ù‡Ø² Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©) */
        function editTransaction() {
            closeLayer('detail');
            toastMsg("ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ØºÙŠØ± Ù…ÙØ¹Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø±.");
            // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ù…Ù„Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ§Ù„ØªØ­ÙˆÙŠÙ„ Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            // Ù…Ø«Ø§Ù„: fillFormForEdit(editMode.type, db[editMode.type][editMode.index]);
        }

        /** Ø·Ù„Ø¨ ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© */
        function confirmDeleteTransaction() {
            if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ Ø³ÙŠØªÙ… Ø¹ÙƒØ³ ØªØ£Ø«ÙŠØ±Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯.")) {
                deleteTransaction();
            }
        }

        /** Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØ¹ÙƒØ³ ØªØ£Ø«ÙŠØ±Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯ */
        async function deleteTransaction() {
            if (!editMode) return;
            const { type, index } = editMode;
            const item = db[type][index];

            let amountToAffectBalance = 0;
            let transactionType = '';

            if (type === 'exp') {
                // Ø¹ÙƒØ³ Ø§Ù„Ù…ØµØ±ÙˆÙ: Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù„Øº Ø¥Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯
                amountToAffectBalance = item.amount;
                transactionType = 'Ø¹ÙƒØ³ Ù…ØµØ±ÙˆÙ';
            } else if (type === 'rig') {
                // Ø¹ÙƒØ³ ØªØ­ØµÙŠÙ„ Ø­Ù‚: Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
                amountToAffectBalance = -item.paidAmount;
                transactionType = 'Ø¹ÙƒØ³ ØªØ­ØµÙŠÙ„ Ø­Ù‚';
            } else if (type === 'deb') {
                // Ø¹ÙƒØ³ Ø¯ÙØ¹ Ø§Ù„ØªØ²Ø§Ù…: Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø¥Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯
                amountToAffectBalance = item.paidAmount;
                transactionType = 'Ø¹ÙƒØ³ Ø¯ÙØ¹ Ø§Ù„ØªØ²Ø§Ù…';
            }

            // 1. Ø¹ÙƒØ³ ØªØ£Ø«ÙŠØ± Ø§Ù„Ø±ØµÙŠØ¯
            currentBalance += amountToAffectBalance;
            db.bal.amount = currentBalance;

            // 2. ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø±ØµÙŠØ¯ (Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø£ØµÙ„ÙŠ ÙˆØ¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙƒØ³)
            db.bal.changes = db.bal.changes.filter(c => c.id !== item.id);
            if (amountToAffectBalance !== 0) {
                 db.bal.changes.unshift({
                    id: Date.now(),
                    type: transactionType,
                    amount: Math.abs(amountToAffectBalance),
                    desc: `ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ©: ${item.desc}`,
                    date: new Date().toISOString().slice(0, 16),
                    newBalance: currentBalance
                });
            }
            await saveData('bal', db.bal);

            // 3. Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡ ÙˆÙ…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø©
            await deleteFromDB(type, item.id);
            db[type].splice(index, 1);
            
            // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            updateBalanceDisplay();
            updateStats();
            closeLayer('detail');
            toastMsg(`ØªÙ… Ø­Ø°Ù ${type} ÙˆØ¹ÙƒØ³ ØªØ£Ø«ÙŠØ±Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­.`);
        }

        /** ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ù‚ÙˆÙ‚ */
        function updateRightFields(type) {
            const container = document.getElementById('rDynamicFields');
            container.innerHTML = '';
            
            if (type === 'Ø¯ÙŠÙ†' || type === 'Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„') {
                container.innerHTML = `
                    <input id="rPaidAmount" type="text" placeholder="ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ ØªÙ… ØªØ­ØµÙŠÙ„Ù‡ (Ø¬Ø²Ø¦ÙŠ Ø£Ùˆ ÙƒÙ„ÙŠ)" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
                `;
            }
        }

        /** ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ù„Ù‚Ø³Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª */
        function updateDebtFields(type) {
            const container = document.getElementById('dDynamicFields');
            container.innerHTML = '';
            
            // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ„ Ù…Ø®ØµØµØ© Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø± Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ù…Ø­Ø¯Ø¯Ø©
            // Ù…Ø«Ø§Ù„: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†ÙˆØ¹ 'Ù‚Ø±Ø¶' ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ 'Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠ'
        }


        // ===================================================
        // 6. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Import/Export/Reset)
        // ===================================================

        /** ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ù…Ù„Ù JSON */
        function exportData() {
            closeLayer('sidebar');
            const dataToExport = {
                version: IDB_VERSION,
                currencyCode: currentCurrency.code,
                data: db
            };
            const json = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `smart_budget_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            toastMsg("ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
        }

        /** Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù JSON */
        function importData(event) {
            closeLayer('sidebar');
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (!imported || !imported.data || !imported.data.bal) {
                        return toastMsg("ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­.");
                    }

                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆØ§ÙÙ‚ Ø§Ù„Ø¥ØµØ¯Ø§Ø±
                    if (imported.version && imported.version < IDB_VERSION) {
                        toastMsg("ØªØ­Ø°ÙŠØ±: Ø¥ØµØ¯Ø§Ø± Ù…Ù„Ù Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‚Ø¯ÙŠÙ…. Ù‚Ø¯ ØªÙÙ‚Ø¯ Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
                    }

                    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    const importedDB = imported.data;
                    const balData = importedDB.bal;
                    
                    // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ø±ØµÙŠØ¯ (bal) ÙƒØ£ÙˆÙ„ Ø®Ø·ÙˆØ©
                    await saveData('bal', { clientId: 1, amount: balData.amount, changes: balData.changes });

                    // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„Ø§Øª exp, rig, deb
                    for (const storeName of ["exp", "rig", "deb"]) {
                        const transaction = IDB_connection.transaction([storeName], "readwrite");
                        const store = transaction.objectStore(storeName);
                        
                        // Ù…Ø³Ø­ Ø§Ù„Ù…ØªØ¬Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
                        await new Promise((res, rej) => {
                            const req = store.clear();
                            req.onsuccess = res;
                            req.onerror = rej;
                        });
                        
                        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©
                        for (const item of importedDB[storeName]) {
                            await new Promise((res, rej) => {
                                const req = store.add(item);
                                req.onsuccess = res;
                                req.onerror = rej;
                            });
                        }
                    }

                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø©
                    if (imported.currencyCode) {
                        setCurrency(imported.currencyCode);
                    }
                    await loadAllData();
                    updateStats(); 
                    updateBalanceDisplay();
                    toastMsg("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­!");

                } catch (error) {
                    toastMsg("ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù Ø¨ØµÙŠØºØ© JSON ØµØ­ÙŠØ­Ø©.");
                    console.error("Import Error:", error);
                } finally {
                    event.target.value = null; // Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„Ù…Ù„Ù
                }
            };
            reader.readAsText(file);
        }

        /** ØªØ£ÙƒÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
        function confirmResetData() {
            closeLayer('sidebar');
            if (confirm("ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.")) {
                resetAllData();
            }
        }

        /** Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø­Ø§Ù„Ø© */
        function resetAllData() {
             if (!IDB_connection) return toastMsg("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");

            const transaction = IDB_connection.transaction(STORE_NAMES, "readwrite");
            let storesCleared = 0;
            
            STORE_NAMES.forEach(storeName => {
                const store = transaction.objectStore(storeName);
                const request = store.clear();

                request.onsuccess = () => {
                    storesCleared++;
                    if (storesCleared === STORE_NAMES.length) {
                        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                        db.exp = db.rig = db.deb = []; 
                        db.bal = { clientId: 1, amount: 0, changes: [] };

                        // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
                        saveData('bal', db.bal).then(() => {
                            loadAllData().then(() => {
                                updateStats(); 
                                updateBalanceDisplay();
                                toastMsg("ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
                            });
                        });
                    }
                };

                request.onerror = () => toastMsg("ÙØ´Ù„... (Ù‚Ø¯ ØªÙƒÙˆÙ† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹Ø·ÙˆØ¨Ø©).");
            });
        }
    </script>
</body>
</html>
