
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ©</title>

<style>
/* ... (ÙƒÙˆØ¯ Ø§Ù„Ù€ CSS Ù„Ù… ÙŠØªØºÙŠØ±) ... */
:root{--p:#0d6efd;--s:#28a745;--bg:#f4f6f8}
body{margin:0;font-family:Tahom,a;background:var(--bg)}
header{background:var(--p);color:#fff;padding:15px;text-align:center;font-size:20px}
.tabs{display:flex;background:#fff}
.tabs button{flex:1;padding:12px;border:none;background:#fff}
.tabs button.active{background:var(--p);color:#fff}
.section{display:none;padding:15px}
.section.active{display:block}
.card{background:#fff;padding:15px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.1);margin-bottom:12px}
input,select{width:100%;padding:12px;margin:6px 0;font-size:15px;border-radius:8px;border:1px solid #ccc;box-sizing: border-box;}

.datetime-container {
    position: relative;
    width: 100%; 
    margin: 6px 0; 
}

.datetime-container input[type="datetime-local"] {
    margin: 0; 
    padding-left: 35px; 
    box-sizing: border-box;
}

.calendar-icon {
    position: absolute;
    top: 50%;
    left: 10px; 
    transform: translateY(-50%);
    font-size: 1.2em;
    z-index: 2;
    pointer-events: none; 
    color: var(--p); 
}

button.action{background:var(--s);color:#fff;border:none;padding:14px;width:100%;border-radius:8px;font-size:16px}
button.secondary{background:#ddd;padding:10px;width:100%;border:none;border-radius:8px;margin-top:6px}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:12px 22px;border-radius:30px;display:none;z-index:100}
.toast.show{display:block}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;display:none;flex-direction:column;z-index:10}
.modal header{display:flex;gap:6px;padding:10px;border-bottom:1px solid #ddd}
.modal-content{padding:15px;overflow:auto;flex:1}
.list-item{background:#eef6ff;padding:14px;border-radius:12px;margin-bottom:8px;cursor:pointer}
.detail p{margin:8px 0}
.detail img{width:100%;border-radius:10px;margin-top:10px}
input[type="file"]:before {
    content: "Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©";
    color: #777;
    font-size: 14px;
    display: block;
    padding: 8px;
    text-align: center;
    background: #f4f6f8;
    border: 1px solid #ccc;
    border-radius: 8px;
    margin: 10px 0;
    cursor: pointer;
}
.currency-symbol { 
    color: #28a745;
    font-weight: bold;
    font-size: 1.1em;
}
</style>
</head>

<body>

<header>Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</header>

<div class="tabs">
<button class="active" onclick="openTab('expenses')">ğŸ’¸ Ù…ØµØ±ÙˆÙØ§Øª</button>
<button onclick="openTab('rights')">ğŸ¤ Ø­Ù‚ÙˆÙ‚</button>
<button onclick="openTab('debts')">ğŸ“Œ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</button>
<button onclick="openTab('stats')">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
</div>

<div id="expenses" class="section active">
<div class="card">
<input id="eAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
<select id="eType">
<option value="">Ø§Ù„ÙØ¦Ø© (Ù†ÙÙ‚Ø§Øª Ù…ØªØºÙŠØ±Ø©)</option>
<option>Ø·Ø¹Ø§Ù…</option><option>Ù…ÙˆØ§ØµÙ„Ø§Øª</option>
<option>Ø±Ø¹Ø§ÙŠØ© Ø´Ø®ØµÙŠØ©</option><option>Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
<option>ØµØ­Ø©</option><option>ØªØ±ÙÙŠÙ‡</option><option>ØªØ³ÙˆÙ‚</option>
<option>ØªØ¹Ù„ÙŠÙ…</option><option>ØµÙŠØ§Ù†Ø© ÙˆØ¥ØµÙ„Ø§Ø­</option><option>Ø£Ø®Ø±Ù‰</option>
</select>
<input id="eDesc" placeholder="ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
<div class="datetime-container">
    <input id="eDate" type="datetime-local">
    <span class="calendar-icon">ğŸ“…</span>
</div>
<input id="eImg" type="file" accept="image/*">
<button class="action" onclick="addExpense()">Ø­ÙØ¸</button>
<button class="secondary" onclick="openLog('exp')">ğŸ“‚ Ø§Ù„Ø³Ø¬Ù„</button>
</div>
</div>

<div id="rights" class="section">
<div class="card">
<input id="rName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†" data-default-placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ">
<select id="rType" onchange="updateRightFields(this.value)">
<option value="">Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚</option>
<option>Ø¯ÙŠÙ†</option>
<option>Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„</option>
<option>Ø£Ø®Ø±Ù‰</option>
</select>
<input id="rAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚ (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ)" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
<div id="rDynamicFields"></div>
<input id="rDesc" placeholder="ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
<div class="datetime-container">
    <input id="rDate" type="datetime-local">
    <span class="calendar-icon">ğŸ“…</span>
</div>
<select id="rStatus">
<option value="">Ø§Ù„Ø­Ø§Ù„Ø©</option>
<option>Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</option>
<option>ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ Ø¨Ø¹Ø¯</option>
</select>
<button class="action" onclick="addRight()">Ø­ÙØ¸</button>
<button class="secondary" onclick="openLog('rig')">ğŸ“‚ Ø§Ù„Ø³Ø¬Ù„</button>
</div>
</div>

<div id="debts" class="section">
<div class="card">
<input id="dName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯Ø§Ø¦Ù†" data-default-placeholder="Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø©">
<select id="dType" onchange="updateDebtFields(this.value)">
<option value="">Ù†ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</option>
<option>Ø¥ÙŠØ¬Ø§Ø±</option>
<option>ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
<option>Ù…Ø§Ø¡</option>
<option>Ø¥Ù†ØªØ±Ù†Øª</option>
<option>Ù‚Ø±Ø¶</option> <option>Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ</option> <option>Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø© Ø£Ø®Ø±Ù‰</option>
<option>Ø£Ø®Ø±Ù‰</option>
</select>
<input id="dAmount" type="text" placeholder="ğŸ’µ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©/Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">

<div id="dDynamicFields"></div>
<input id="dDesc" placeholder="ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
<div class="datetime-container">
    <input id="dDate" type="datetime-local">
    <span class="calendar-icon">ğŸ“…</span>
</div>
<select id="dStatus">
<option value="">Ø§Ù„Ø­Ø§Ù„Ø©</option>
<option>Ù…Ø¯ÙÙˆØ¹</option>
<option>ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
</select>
<button class="action" onclick="addDebt()">Ø­ÙØ¸</button>
<button class="secondary" onclick="openLog('deb')">ğŸ“‚ Ø§Ù„Ø³Ø¬Ù„</button>
</div>
</div>

<div id="stats" class="section">
<div class="card">
<h3>ğŸ’¸ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (Ø§Ù„Ù…ØªØºÙŠØ±Ø© ÙˆØ§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª)</h3>
<p>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: <b id="sExpTotal">0</b></p>
<p>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: <b id="sExpCount">0</b></p>
<p>Ø£Ø¹Ù„Ù‰ ÙØ¦Ø©: <b id="sTopCat">â€”</b></p>
</div>
<div class="card">
<h3>ğŸ¤ Ø§Ù„Ø­Ù‚ÙˆÙ‚</h3>
<p>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚: <b id="sRigTotal">0</b></p>
<p>Ø§Ù„Ù…Ø­ØµÙ„: <b id="sRigPaid">0</b></p>
<p>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ØªØ­ØµÙŠÙ„Ù‡: <b id="sRigUnpaid">0</b></p>
</div>
<div class="card">
<h3>ğŸ“Œ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª (Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„ÙƒÙ„ÙŠØ© Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ§Øª)</h3>
<p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©: <b id="sDebTotal">0</b></p>
<p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù† (Ù…ØµØ±ÙˆÙ): <b id="sDebPaid">0</b></p>
<p>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ù‚Ø±ÙˆØ¶/Ø§Ù„Ø¯ÙŠÙˆÙ†/Ø§Ù„ÙÙˆØ§ØªÙŠØ±: <b id="sDebUnpaid">0</b></p>
</div>
</div>

<div class="modal" id="logModal">
<header>
<input id="search" placeholder="ğŸ” Ø¨Ø­Ø«" oninput="renderLog()">
<button onclick="closeLog()">Ø¥ØºÙ„Ø§Ù‚</button>
</header>
<div class="modal-content" id="logContent"></div>
</div>

<div class="modal" id="detailModal">
<header>
<button onclick="closeDetailAndClearEditMode()">Ø¥ØºÙ„Ø§Ù‚</button>
</header>
<div class="modal-content detail" id="detailContent"></div>
</div>

<div class="toast" id="toast"></div>

<script>
// ===================================================
// 1. Ø¥Ø¹Ø¯Ø§Ø¯ IndexedDB ÙˆÙ…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©
// ===================================================
const IDB_NAME = "MySmartBudgetDB";
const IDB_VERSION = 1;
const STORE_NAMES = ["exp", "rig", "deb"]; 
let db = { exp: [], rig: [], deb: [] }; 
let IDB_connection = null; 

let currentLog = "", editMode = null;

// ===================================================
// 2. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆØ§Ù„Ù…Ù„Ø§Ø­ÙŠØ©
// ===================================================

function formatAmount(input) {
  let value = input.value.replace(/[^\d.]/g, ''); 
  const parts = value.split('.');
  
  if (parts.length > 2) {
    value = parts[0] + '.' + parts.slice(1).join('');
  }
  
  const integerPart = parts[0];
  const decimalPart = parts[1] ? '.' + parts[1] : '';
  
  const number = parseFloat(integerPart.replace(/,/g, '')); 
  let formattedIntegerPart = isNaN(number) ? '' : number.toLocaleString('ar');
  
  if (input.value.endsWith('.') && !decimalPart) {
      formattedIntegerPart += '.';
  }

  input.value = formattedIntegerPart + decimalPart;
}

function parseAmount(amount) {
  // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ ÙÙˆØ§ØµÙ„ Ø®Ø§ØµØ© Ø¨Ø§Ù„ØµÙŠØºØ© (Ù…Ø«Ù„ Ø§Ù„Ø¢Ù„Ø§Ù) ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© ÙƒØ±Ù‚Ù…
  return parseFloat(String(amount).replace(/[^0-9.]/g, '')) || 0;
}

function formatCurrency(amount) {
    const num = parseAmount(amount);
    const formattedNum = num.toLocaleString('ar', { 
        minimumFractionDigits: num % 1 === 0 ? 0 : 2,
        maximumFractionDigits: 2 
    });
    return `<span class="currency-symbol">ğŸ’°</span> ${formattedNum}`;
}

function formatDateTime(dateString) {
    if (!dateString) return 'â€”';
    const date = new Date(dateString);
    if (isNaN(date)) return 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ§Ù„Ø­';
    return date.toLocaleString('ar-EG', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true 
    });
}

function toastMsg(m) {
  const toast = document.getElementById("toast");
  toast.textContent = m;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 2000);
}

function clearFields(keepExpenseImage = false) {
  // Expense fields
  eAmount.value = eDesc.value = eType.value = eDate.value = "";
  eImg.value = ""; 
  
  // Rights fields
  rName.value = rAmount.value = rDesc.value = rDate.value = rType.value = rStatus.value = "";
  document.getElementById('rDynamicFields').innerHTML = '';
  rName.placeholder = rName.getAttribute('data-default-placeholder');

  // Debts fields
  dName.value = dType.value = dAmount.value = dDesc.value = dDate.value = dStatus.value = "";
  document.getElementById('dDynamicFields').innerHTML = '';
  dName.placeholder = dName.getAttribute('data-default-placeholder');
  
  // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
  document.getElementById('dAmount').style.display = 'block'; 
  document.getElementById('dStatus').style.display = 'block'; 
}

// **ÙˆØ¸Ø§Ø¦Ù ØªØ®ØµÙŠØµ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©**
function updateNamePlaceholder(type, nameInputId) {
    const nameInput = document.getElementById(nameInputId);
    if (!nameInput) return;

    let placeholder;
    if (nameInputId === 'dName') {
        switch (type) {
            case 'Ø¥ÙŠØ¬Ø§Ø±':
                placeholder = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ/Ø§Ù„Ø´Ø±ÙƒØ©'; break;
            case 'Ù‚Ø±Ø¶':
            case 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ':
                placeholder = 'Ø§Ø³Ù… Ø§Ù„Ø¯Ø§Ø¦Ù†/Ø§Ù„Ø¬Ù‡Ø©'; break;
            default:
                placeholder = nameInput.getAttribute('data-default-placeholder');
        }
    } else if (nameInputId === 'rName') {
        switch (type) {
            case 'Ø¯ÙŠÙ†':
                placeholder = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ† (Ø§Ù„Ø°ÙŠ ÙŠØ¯ÙØ¹ Ù„Ùƒ)'; break;
            case 'Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„':
                placeholder = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠ'; break;
            default:
                placeholder = nameInput.getAttribute('data-default-placeholder');
        }
    }
    nameInput.placeholder = placeholder;
}

function updateRightFields(type) {
    const dynamicContainer = document.getElementById('rDynamicFields');
    dynamicContainer.innerHTML = '';
    updateNamePlaceholder(type, 'rName');

    if (type === 'Ø¯ÙŠÙ†' || type === 'Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„') {
        dynamicContainer.innerHTML = `
            <div class="datetime-container">
                <input id="rExpectedDate" type="datetime-local">
                <span class="calendar-icon">ğŸ—“ï¸</span>
            </div>
            <label for="rExpectedDate" style="display:block; font-size: 0.9em; color: #555; text-align: right; margin-top: -10px;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ (Ø¥Ù† ÙˆØ¬Ø¯)</label>
        `;
    }
}

function calculateInstallmentValue() {
    const totalInput = document.getElementById('dTotalAmount');
    const installmentsInput = document.getElementById('dInstallments');
    const valueDisplay = document.getElementById('dInstallmentValue');

    if (!totalInput || !installmentsInput || !valueDisplay) return;

    const total = parseAmount(totalInput.value);
    const installments = parseInt(installmentsInput.value) || 0;

    if (total > 0 && installments > 0) {
        const value = total / installments;
        valueDisplay.textContent = `Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø·: ${formatCurrency(value.toFixed(2))}`;
    } else {
        valueDisplay.textContent = 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø·: â€”';
    }
}

function updateDebtFields(type) {
    const dynamicContainer = document.getElementById('dDynamicFields');
    dynamicContainer.innerHTML = '';
    updateNamePlaceholder(type, 'dName');
    
    const dAmountInput = document.getElementById('dAmount');
    const dStatusSelect = document.getElementById('dStatus'); 

    if (type === 'Ù‚Ø±Ø¶') {
        dAmountInput.style.display = 'none'; 
        dStatusSelect.style.display = 'none'; 

        dynamicContainer.innerHTML = `
            <input id="dTotalAmount" type="text" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ù‚Ø±Ø¶" oninput="calculateInstallmentValue(); formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
            <input id="dInstallments" type="number" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„ÙƒÙ„ÙŠ" min="1" oninput="calculateInstallmentValue()">
            <p id="dInstallmentValue" style="margin: 0; padding: 10px 0; font-size: 0.9em; color: var(--p); font-weight: bold;">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø·: â€”</p>
            <input id="dPaidInstallments" type="number" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†" min="0">
        `;
        
    } else if (type === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ') {
        dAmountInput.style.display = 'none'; 
        dStatusSelect.style.display = 'none'; 

        dynamicContainer.innerHTML = `
            <input id="dTotalAmount" type="text" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø¯ÙŠÙ†" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
            <input id="dPaidInstallments" type="text" placeholder="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù†Ù‚Ø¯Ø§Ù‹ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
        `;
        
    } else {
        // Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© (ÙÙˆØ§ØªÙŠØ±ØŒ Ø¥ÙŠØ¬Ø§Ø±ØŒ Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø© Ø£Ø®Ø±Ù‰)
        dAmountInput.style.display = 'block';
        dStatusSelect.style.display = 'block'; 
    }
}

function openTab(id) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
  document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  
  const button = event.currentTarget || document.querySelector(`.tabs button[onclick="openTab('${id}')"]`);
  if(button) button.classList.add("active");
  
  editMode = null; 
  clearFields(); 
  
  if (document.getElementById('search')) {
      document.getElementById('search').value = "";
  }
}

function closeDetailAndClearEditMode() {
  const detailModal = document.getElementById("detailModal");
  detailModal.style.display = "none";
  editMode = null; 
}


// **ÙˆØ¸Ø§Ø¦Ù IndexedDB**
function initDB() {
  return new Promise((resolve, reject) => {
    if (!window.indexedDB) {
        toastMsg("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… IndexedDB.");
        return reject(new Error("IndexedDB not supported."));
    }

    const request = indexedDB.open(IDB_NAME, IDB_VERSION);

    request.onerror = (e) => {
      console.error("IndexedDB error:", e.target.error);
      reject(e.target.error);
    };

    request.onsuccess = (e) => {
      IDB_connection = e.target.result;
      console.log("IndexedDB opened successfully.");
      resolve(IDB_connection);
      loadAllData().then(updateStats);
    };

    request.onupgradeneeded = (e) => {
      IDB_connection = e.target.result;
      STORE_NAMES.forEach(storeName => {
        if (!IDB_connection.objectStoreNames.contains(storeName)) {
          IDB_connection.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
        }
      });
      console.log("Database upgrade complete.");
    };
  });
}

initDB();

function saveData(storeName, data) {
  return new Promise((resolve, reject) => {
    if (!IDB_connection) return reject(new Error("Database not connected."));

    const transaction = IDB_connection.transaction([storeName], "readwrite");
    const store = transaction.objectStore(storeName);
    // put() updates if ID exists, adds if not. Essential for the fix.
    const request = store.put(data); 

    request.onsuccess = () => resolve(request.result);
    request.onerror = (e) => reject(e.target.error);
  });
}

function deleteFromDB(storeName, id) {
  return new Promise((resolve, reject) => {
    if (!IDB_connection) return reject(new Error("Database not connected."));

    const transaction = IDB_connection.transaction([storeName], "readwrite");
    const store = transaction.objectStore(storeName);
    const request = store.delete(id); 

    request.onsuccess = () => resolve();
    request.onerror = (e) => reject(e.target.error);
  });
}

function loadStoreData(storeName) {
  return new Promise((resolve) => {
    if (!IDB_connection) return resolve([]); 
    
    const transaction = IDB_connection.transaction([storeName], "readonly");
    const store = transaction.objectStore(storeName);
    const request = store.getAll();

    // ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ÙƒÙˆØ³Ø© Ù„Ø¶Ù…Ø§Ù† Ø£Ù† Ø§Ù„Ø£Ø­Ø¯Ø« ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ø±Ø¶
    request.onsuccess = (e) => resolve(e.target.result.reverse());
    request.onerror = () => resolve([]);
  });
}

async function loadAllData() {
    const [expData, rigData, debData] = await Promise.all([
        loadStoreData('exp'),
        loadStoreData('rig'),
        loadStoreData('deb')
    ]);
    db.exp = expData;
    db.rig = rigData;
    db.deb = debData;
    const logModal = document.getElementById("logModal");
    if (logModal.style.display === "flex") renderLog();
}

// **ÙˆØ¸ÙŠÙØ© Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸ (Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø§Ù„Ø³Ø¬Ù„)**
function postSaveCleanup(isEditing, type) {
    editMode = null; 
    clearFields(); // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
    updateStats();
    
    // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
    document.getElementById("detailModal").style.display = "none";
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ØªØ¹Ø¯ÙŠÙ„Ø§Ù‹ØŒ Ù‚Ù… Ø¨Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø³Ø¬Ù„ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
    if (isEditing) {
        openLog(type); 
    }
}


// ===================================================
// 3. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù (CRUD)
// ===================================================

async function addExpense() { 
  if (!eAmount.value || !eType.value || !eDate.value) return toastMsg("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  
  const isEditing = editMode && editMode.type === "exp";
  const oldData = isEditing ? db.exp[editMode.index] : {}; 
  
  // Ù†Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù€ ID Ø¥Ù† ÙˆØ¬Ø¯
  const data = isEditing ? { ...oldData } : {}; 

  data.Ø§Ù„Ù…Ø¨Ù„Øº = eAmount.value; 
  data.Ø§Ù„ÙØ¦Ø© = eType.value; 
  data.Ø§Ù„ÙˆØµÙ = eDesc.value; 
  data.Ø§Ù„ØªØ§Ø±ÙŠØ® = eDate.value; 
  data.ØµÙˆØ±Ø© = oldData.ØµÙˆØ±Ø© || null; // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©

  // **Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ø­Ø§Ø³Ù…: Ø§Ù„ØªØ£ÙƒØ¯ Ø§Ù„ØµØ±ÙŠØ­ Ù…Ù† Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù€ ID Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„**
  if (isEditing) {
      data.id = oldData.id; 
  }
  
  const done = async () => {
    try {
        await saveData('exp', data); 
        toastMsg(isEditing ? "ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ" : "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ");
        
        await loadAllData(); 
        postSaveCleanup(isEditing, 'exp'); 

    } catch (error) {
        toastMsg("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸. ØªØ­Ù‚Ù‚ Ù…Ù† Console.");
        console.error(error);
    }
  };

  if (eImg.files[0]) {
    const r = new FileReader();
    r.onload = () => { data.ØµÙˆØ±Ø© = r.result; done(); };
    r.readAsDataURL(eImg.files[0]);
  } else {
      done(); 
  }
}

async function addRight() {
  if (!rName.value || !rAmount.value || !rDate.value || !rStatus.value || !rType.value) return toastMsg("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  
  const isEditing = editMode && editMode.type === "rig";
  const oldData = isEditing ? db.rig[editMode.index] : {};
  const rExpectedDate = document.getElementById('rExpectedDate');

  const data = isEditing ? { ...oldData } : {};

  data.Ø§Ù„Ø§Ø³Ù… = rName.value; 
  data.Ø§Ù„Ù†ÙˆØ¹ = rType.value; 
  data.Ø§Ù„Ù…Ø¨Ù„Øº = rAmount.value; 
  data.Ø§Ù„ÙˆØµÙ = rDesc.value; 
  data.Ø§Ù„ØªØ§Ø±ÙŠØ® = rDate.value; 
  data.Ø§Ù„Ø­Ø§Ù„Ø© = rStatus.value;
  data.ØªØ§Ø±ÙŠØ®_Ù…ØªÙˆÙ‚Ø¹ = rExpectedDate ? rExpectedDate.value : null; 
  
  // **Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ø­Ø§Ø³Ù…: Ø§Ù„ØªØ£ÙƒØ¯ Ø§Ù„ØµØ±ÙŠØ­ Ù…Ù† Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù€ ID Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„**
  if (isEditing) {
      data.id = oldData.id;
  }
  
  try {
      await saveData('rig', data);
      toastMsg(isEditing ? "ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ù‚" : "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ù‚");
      
      await loadAllData(); 
      postSaveCleanup(isEditing, 'rig');

  } catch (error) {
      toastMsg("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸. ØªØ­Ù‚Ù‚ Ù…Ù† Console.");
      console.error(error);
  }
}

async function addDebt() {
  if (!dName.value || !dType.value || !dDate.value) return toastMsg("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©");
  
  const isMasterLiability = (dType.value === 'Ù‚Ø±Ø¶' || dType.value === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ');
  
  const dTotalAmountInput = document.getElementById('dTotalAmount');
  const dInstallmentsInput = document.getElementById('dInstallments');
  const dPaidInstallmentsInput = document.getElementById('dPaidInstallments'); 
  
  if (!isMasterLiability && (!dAmount.value || !dStatus.value)) return toastMsg("Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©/Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø¹Ø§Ø¯ÙŠ.");
  if (isMasterLiability && !dTotalAmountInput.value) return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø§Ù„ØªØ²Ø§Ù….");

  const isEditing = editMode && editMode.type === "deb";
  const oldData = isEditing ? db.deb[editMode.index] : {};

  const data = isEditing ? { ...oldData } : {};

  data.Ø§Ù„Ø§Ø³Ù… = dName.value;
  data.Ø§Ù„Ù†ÙˆØ¹ = dType.value; 
  data.Ø§Ù„ÙˆØµÙ = dDesc.value; 
  data.Ø§Ù„ØªØ§Ø±ÙŠØ® = dDate.value; 
  
  if (isMasterLiability) {
      const totalAmount = parseAmount(dTotalAmountInput.value);
      let totalPaidAmount = 0;
      let remainingAmount = 0;

      if (data.Ø§Ù„Ù†ÙˆØ¹ === 'Ù‚Ø±Ø¶') {
          const paidInstallmentsCount = parseInt(dPaidInstallmentsInput.value) || 0;
          const installmentsTotal = parseInt(dInstallmentsInput.value) || 0;
          
          if (installmentsTotal <= 0) return toastMsg("Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±.");
          if (paidInstallmentsCount > installmentsTotal) return toastMsg("Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„ÙƒÙ„ÙŠ.");

          const installmentValue = totalAmount / installmentsTotal;
          totalPaidAmount = paidInstallmentsCount * installmentValue;
          
          data.Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ù‚Ø³Ø§Ø· = installmentsTotal;
          data.Ù‚ÙŠÙ…Ø©_Ø§Ù„Ù‚Ø³Ø· = formatCurrency(installmentValue.toFixed(2));
          data.Ø§Ù„Ø£Ù‚Ø³Ø§Ø·_Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© = paidInstallmentsCount;
          
      } else if (data.Ø§Ù„Ù†ÙˆØ¹ === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ') {
          totalPaidAmount = parseAmount(dPaidInstallmentsInput.value);
          
          if (totalPaidAmount > totalAmount) return toastMsg("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø¯ÙŠÙ†.");
          
          delete data.Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ù‚Ø³Ø§Ø·;
          delete data.Ù‚ÙŠÙ…Ø©_Ø§Ù„Ù‚Ø³Ø·;
          data.Ø§Ù„Ø£Ù‚Ø³Ø§Ø·_Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© = null;
      }
      
      remainingAmount = totalAmount - totalPaidAmount;
      
      data.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù… = dTotalAmountInput.value;
      data.Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„Ù…Ø¯ÙÙˆØ¹ = formatCurrency(totalPaidAmount); 
      data.Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù… = formatCurrency(remainingAmount);
      
      data.Ø§Ù„Ù…Ø¨Ù„Øº = "â€”";
      data.Ø§Ù„Ø­Ø§Ù„Ø© = "â€”";
      
  } else {
      data.Ø§Ù„Ù…Ø¨Ù„Øº = dAmount.value; 
      data.Ø§Ù„Ø­Ø§Ù„Ø© = dStatus.value;
      
      delete data.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…;
      delete data.Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„Ù…Ø¯ÙÙˆØ¹;
      delete data.Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…;
      delete data.Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ù‚Ø³Ø§Ø·;
      delete data.Ù‚ÙŠÙ…Ø©_Ø§Ù„Ù‚Ø³Ø·;
      delete data.Ø§Ù„Ø£Ù‚Ø³Ø§Ø·_Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©;
  }
  
  // **Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ø­Ø§Ø³Ù…: Ø§Ù„ØªØ£ÙƒØ¯ Ø§Ù„ØµØ±ÙŠØ­ Ù…Ù† Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù€ ID Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„**
  if (isEditing) {
      data.id = oldData.id;
  }
  
  try {
      await saveData('deb', data);
      toastMsg(isEditing ? "ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…" : "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…");
      
      await loadAllData(); 
      postSaveCleanup(isEditing, 'deb');

  } catch (error) {
      toastMsg("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸. ØªØ­Ù‚Ù‚ Ù…Ù† Console.");
      console.error(error);
  }
}

function openLog(t) {
  const logModal = document.getElementById("logModal");
  currentLog = t;
  logModal.style.display = "flex";
  renderLog();
}

function closeLog() { 
    const logModal = document.getElementById("logModal");
    logModal.style.display = "none"; 
}

function renderLog() {
  const logContent = document.getElementById("logContent");
  const search = document.getElementById("search");
  const q = (search.value || "").toLowerCase();
  
  const filteredData = db[currentLog]
    .filter(i => JSON.stringify(i).toLowerCase().includes(q));

  logContent.innerHTML = filteredData
    .map((i) => {
        let subText = i.Ø§Ù„Ø­Ø§Ù„Ø© || '';
        let displayAmount = i.Ø§Ù„Ù…Ø¨Ù„Øº;
        let displayTitle = i.Ø§Ù„Ù†ÙˆØ¹ || i.Ø§Ù„ÙØ¦Ø© || i.Ø§Ù„Ø§Ø³Ù… || 'Ù…Ø¹Ø§Ù…Ù„Ø©';
        
        if (i.Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…) {
             subText = `Ù…Ø¯ÙÙˆØ¹: ${i.Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„Ù…Ø¯ÙÙˆØ¹} / Ù…ØªØ¨Ù‚ÙŠ: ${i.Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…}`;
             displayAmount = i.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…;
        }

        return `
            <div class="list-item" onclick='showDetailById(${i.id},"${currentLog}")'>
                <div style="font-weight: bold; margin-bottom: 5px;">
                    ${displayTitle} - ${formatCurrency(displayAmount)}
                </div>
                <div style="font-size: 0.9em; color: #666; direction: ltr; text-align: right;">
                    ${subText} | ${formatDateTime(i.Ø§Ù„ØªØ§Ø±ÙŠØ®)}
                </div>
            </div>
        `;
    })
    .join("");
}

function showDetailById(id, type) {
    const o = db[type].find(item => item.id === id);
    if (!o) return toastMsg("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.");
    
    const index = db[type].findIndex(item => item.id === id);
    if (index === -1) return toastMsg("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙ‡Ø±Ø³ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.");
    
    editMode = { type, index }; 
    
    _renderDetailContent(o, type); 
}

function _renderDetailContent(o, type) {
    const detailModal = document.getElementById("detailModal");
    const detailContent = document.getElementById("detailContent");

    detailModal.style.display = "flex";

    const customMap = {
        'ØªØ§Ø±ÙŠØ®_Ù…ØªÙˆÙ‚Ø¹': 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹',
        'Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…': 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø§Ù„ØªØ²Ø§Ù… (Ø§Ù„Ø£ØµÙ„ÙŠ)',
        'Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„Ù…Ø¯ÙÙˆØ¹': 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù† (Ù…ØµØ±ÙˆÙ)',
        'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…': 'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…',
        'Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ù‚Ø³Ø§Ø·': 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„ÙƒÙ„ÙŠ',
        'Ù‚ÙŠÙ…Ø©_Ø§Ù„Ù‚Ø³Ø·': 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø·',
        'Ø§Ù„Ø£Ù‚Ø³Ø§Ø·_Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©': 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©',
        'Ø§Ù„Ù…Ø¨Ù„Øº': 'Ø§Ù„Ù…Ø¨Ù„Øº (Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø©)',
        'Ø§Ù„Ø§Ø³Ù…': type === 'rig' ? 'Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†' : type === 'deb' ? 'Ø§Ø³Ù… Ø§Ù„Ø¯Ø§Ø¦Ù†/Ø§Ù„Ø¬Ù‡Ø©' : 'â€”',
    };

    detailContent.innerHTML = Object.entries(o).map(([k, v]) => {
        if (k === "ØµÙˆØ±Ø©" && v) return `<p><b>ØµÙˆØ±Ø©:</b></p><img src="${v}">`;
        if (k === "id") return ""; 
        
        const displayKey = customMap[k] || k;
        
        if (k === "Ø§Ù„Ù…Ø¨Ù„Øº" || k === "Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…") {
            if (v === "â€”" || v === null) return "";
            return `<p><b>${displayKey}:</b> ${formatCurrency(v)}</p>`;
        }
        
        if (k === "Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…" || k === "Ù‚ÙŠÙ…Ø©_Ø§Ù„Ù‚Ø³Ø·" || k === "Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„Ù…Ø¯ÙÙˆØ¹") {
             if (v === "â€”" || v === null) return "";
             return `<p><b>${displayKey}:</b> ${v}</p>`;
        }
        
        if (k === "Ø§Ù„ØªØ§Ø±ÙŠØ®" || k === "ØªØ§Ø±ÙŠØ®_Ù…ØªÙˆÙ‚Ø¹") {
            return `<p><b>${displayKey}:</b> ${formatDateTime(v)}</p>`;
        }
        
        if (v === null || v === undefined || v === "" || v === "â€”") return "";
        
        return `<p><b>${displayKey}:</b> ${v}</p>`;
    }).filter(p => p !== "").join("") + 
    `<button class="action" onclick="editTransaction()">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
    <button class="secondary" onclick="deleteTransaction()">ğŸ—‘ï¸ Ø­Ø°Ù</button>`;
}

function editTransaction() {
  if (!editMode) return;
  const currentData = db[editMode.type][editMode.index];

  // **Ø§Ù„ØªØµØ­ÙŠØ­: Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°ØªÙŠ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„Ø³Ø¬Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„**
  const detailModal = document.getElementById("detailModal");
  const logModal = document.getElementById("logModal");
  detailModal.style.display = "none";
  logModal.style.display = "none"; 
  
  if (editMode.type === "exp") {
    openTab('expenses'); 
    eAmount.value = currentData.Ø§Ù„Ù…Ø¨Ù„Øº;
    eType.value = currentData.Ø§Ù„ÙØ¦Ø©;
    eDesc.value = currentData.Ø§Ù„ÙˆØµÙ;
    eDate.value = currentData.Ø§Ù„ØªØ§Ø±ÙŠØ®;
  }
  
  if (editMode.type === "rig") {
    openTab('rights'); 
    rName.value = currentData.Ø§Ù„Ø§Ø³Ù…;
    rType.value = currentData.Ø§Ù„Ù†ÙˆØ¹;
    updateRightFields(rType.value); 
    rAmount.value = currentData.Ø§Ù„Ù…Ø¨Ù„Øº;
    rDesc.value = currentData.Ø§Ù„ÙˆØµÙ;
    rDate.value = currentData.Ø§Ù„ØªØ§Ø±ÙŠØ®;
    rStatus.value = currentData.Ø§Ù„Ø­Ø§Ù„Ø©;
    if (currentData.ØªØ§Ø±ÙŠØ®_Ù…ØªÙˆÙ‚Ø¹ && document.getElementById('rExpectedDate')) {
        document.getElementById('rExpectedDate').value = currentData.ØªØ§Ø±ÙŠØ®_Ù…ØªÙˆÙ‚Ø¹;
    }
  }
  
  if (editMode.type === "deb") {
    openTab('debts'); 
    
    dName.value = currentData.Ø§Ù„Ø§Ø³Ù…; 
    dType.value = currentData.Ø§Ù„Ù†ÙˆØ¹;
    dDesc.value = currentData.Ø§Ù„ÙˆØµÙ;
    dDate.value = currentData.Ø§Ù„ØªØ§Ø±ÙŠØ®;

    updateDebtFields(dType.value); 

    if (currentData.Ø§Ù„Ù†ÙˆØ¹ === 'Ù‚Ø±Ø¶' || currentData.Ø§Ù„Ù†ÙˆØ¹ === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ') {
        if (currentData.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù… && document.getElementById('dTotalAmount')) {
            document.getElementById('dTotalAmount').value = currentData.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…;
        }
        
        if (currentData.Ø§Ù„Ù†ÙˆØ¹ === 'Ù‚Ø±Ø¶') {
            if (currentData.Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ù‚Ø³Ø§Ø· && document.getElementById('dInstallments')) {
                document.getElementById('dInstallments').value = currentData.Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ù‚Ø³Ø§Ø·;
            }
            if (currentData.Ø§Ù„Ø£Ù‚Ø³Ø§Ø·_Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© !== null && document.getElementById('dPaidInstallments')) {
                document.getElementById('dPaidInstallments').value = currentData.Ø§Ù„Ø£Ù‚Ø³Ø§Ø·_Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©;
            }
            calculateInstallmentValue();

        } else if (currentData.Ø§Ù„Ù†ÙˆØ¹ === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ') {
            const paidAmountUnformatted = parseAmount(currentData.Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„Ù…Ø¯ÙÙˆØ¹) || 0;
            if (document.getElementById('dPaidInstallments')) {
                document.getElementById('dPaidInstallments').value = paidAmountUnformatted.toLocaleString('ar');
            }
        }
    } else {
        dAmount.value = currentData.Ø§Ù„Ù…Ø¨Ù„Øº;
        dStatus.value = currentData.Ø§Ù„Ø­Ø§Ù„Ø©;
    }
  }
}

async function deleteTransaction() {
  if (!editMode) return;
  if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŸ")) return;
  
  const typeToDelete = editMode.type;
  const idToDelete = db[typeToDelete][editMode.index].id;
  
  try {
      await deleteFromDB(typeToDelete, idToDelete);
      editMode = null; 
      await loadAllData(); 
      toastMsg("ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­");
      
      const detailModal = document.getElementById("detailModal");
      detailModal.style.display = "none";
      
      updateStats();
      
      openLog(typeToDelete); 
      
  } catch (error) {
      toastMsg("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù.");
      console.error(error);
  }
}

// ===================================================
// 4. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Stats) Ù…Ø¹ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯
// ===================================================

function updateStats() {
  let et = 0, ec = 0; 
  let cats = {}; 
  
  let rt = 0, rp = 0, ru = 0; 
  let dt = 0, dp = 0, du = 0; 

  // 1. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø© (Variable Expenses)
  db.exp.forEach(e => { 
    let a = parseAmount(e.Ø§Ù„Ù…Ø¨Ù„Øº); 
    et += a; 
    ec++;
    cats[e.Ø§Ù„ÙØ¦Ø©] = (cats[e.Ø§Ù„ÙØ¦Ø©] || 0) + a;
  });

  // 2. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙˆØ§Ù„Ù†Ù‚Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©
  db.deb.forEach(d => { 
    const isMasterLiability = (d.Ø§Ù„Ù†ÙˆØ¹ === 'Ù‚Ø±Ø¶' || d.Ø§Ù„Ù†ÙˆØ¹ === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ');
    
    if (isMasterLiability) {
        const totalLiability = parseAmount(d.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„ÙƒÙ„ÙŠ_Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…);
        const paidAmount = parseAmount(d.Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„Ù…Ø¯ÙÙˆØ¹); 
        
        dt += totalLiability; 
        dp += paidAmount;
        
        const remaining = totalLiability - paidAmount;
        du += remaining;
        
        if (paidAmount > 0) {
            et += paidAmount; 
            ec++; 
            const category = `Ù‚Ø±Ø¶/Ø¯ÙŠÙ†: ${d.Ø§Ù„Ø§Ø³Ù…} (${d.Ø§Ù„Ù†ÙˆØ¹})`;
            cats[category] = (cats[category] || 0) + paidAmount;
        }

    } else {
        // Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© (ÙÙˆØ§ØªÙŠØ±ØŒ Ø£Ù‚Ø³Ø§Ø·/ÙÙˆØ§ØªÙŠØ± Ø£Ø®Ø±Ù‰)
        let amount = parseAmount(d.Ø§Ù„Ù…Ø¨Ù„Øº); 
        dt += amount; 
        
        if (d.Ø§Ù„Ø­Ø§Ù„Ø© === "Ù…Ø¯ÙÙˆØ¹") {
            dp += amount;
            
            et += amount; 
            ec++;
            
            const category = `Ø§Ù„ØªØ²Ø§Ù… Ù…Ø¯ÙÙˆØ¹: ${d.Ø§Ù„Ø§Ø³Ù…} (${d.Ø§Ù„Ù†ÙˆØ¹})`;
            cats[category] = (cats[category] || 0) + amount;
        } else {
            du += amount;
        }
    }
  });
  
  // 3. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ù‚ÙˆÙ‚
  db.rig.forEach(r => { 
    let a = parseAmount(r.Ø§Ù„Ù…Ø¨Ù„Øº); 
    rt += a; 
    r.Ø§Ù„Ø­Ø§Ù„Ø© === "Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„" ? rp += a : ru += a;
  });

  // ØªØ­Ø¯ÙŠØ¯ Ø£Ø¹Ù„Ù‰ ÙØ¦Ø© Ù…ØµØ±ÙˆÙØ§Øª
  let topCatName = 'â€”';
  let maxCatAmount = 0;
  for (let cat in cats) { 
    if (cats[cat] > maxCatAmount) {
      maxCatAmount = cats[cat];
      topCatName = cat;
    }
  }

  // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
  document.getElementById("sExpTotal").innerHTML = formatCurrency(et); 
  document.getElementById("sExpCount").textContent = ec;
  document.getElementById("sTopCat").textContent = topCatName;

  document.getElementById("sRigTotal").innerHTML = formatCurrency(rt); 
  document.getElementById("sRigPaid").innerHTML = formatCurrency(rp); 
  document.getElementById("sRigUnpaid").innerHTML = formatCurrency(ru);
  
  document.getElementById("sDebTotal").innerHTML = formatCurrency(dt); 
  document.getElementById("sDebPaid").innerHTML = formatCurrency(dp); 
  document.getElementById("sDebUnpaid").innerHTML = formatCurrency(du);
}
</script>

</body>
</html>
