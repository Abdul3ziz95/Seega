<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>ميزانيتك الذكية Pro</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">

<style>
:root {
    --p: #0077b6; --s: #48cae4; --bg: #f7f9fc;
    --danger: #ef476f; --success: #2a9d8f; --warning: #fbc02d;
    --text-dark: #333; --text-light: #f7f9fc;
    --card-bg: #fff; --input-bg: #fff;
    --transition: all 0.3s ease;
}

body.dark-mode {
    --bg: #121212; --card-bg: #1e1e1e; --text-dark: #e0e0e0;
    --input-bg: #2d2d2d;
}

* { box-sizing: border-box; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; }
body { margin: 0; background-color: var(--bg); color: var(--text-dark); transition: var(--transition); overflow-x: hidden; }

/* Header & Balance */
.header { background: linear-gradient(135deg, var(--p), var(--s)); color: white; padding: 25px 20px; text-align: center; border-radius: 0 0 30px 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
.balance-card { margin-top: 15px; }
.balance-amount { font-size: 2.2rem; font-weight: 800; display: block; margin: 5px 0; }

/* Grid Layout */
.container { padding: 20px; max-width: 600px; margin: auto; padding-bottom: 100px; }
.stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
.stat-item { background: var(--card-bg); padding: 15px; border-radius: 20px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
.stat-item i { font-size: 1.5rem; margin-bottom: 8px; display: block; }

/* Layers & Modals */
.layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 1000; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); overflow-y: auto; }
.layer.active { transform: translateY(0); }
.layer-header { padding: 20px; display: flex; align-items: center; background: var(--card-bg); border-bottom: 1px solid rgba(0,0,0,0.05); position: sticky; top: 0; }

/* Forms */
.form-group { margin-bottom: 20px; padding: 0 20px; }
label { display: block; margin-bottom: 8px; font-weight: bold; }
input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 12px; background: var(--input-bg); color: var(--text-dark); font-size: 1rem; }

/* Bottom Nav */
.bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--card-bg); display: flex; justify-content: space-around; padding: 12px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 900; }
.nav-item { border: none; background: none; color: #888; display: flex; flex-direction: column; align-items: center; font-size: 0.8rem; cursor: pointer; }
.nav-item.active { color: var(--p); }
.nav-item i { font-size: 1.4rem; margin-bottom: 4px; }

/* Buttons */
.btn-main { background: var(--p); color: white; border: none; padding: 15px 30px; border-radius: 15px; width: calc(100% - 40px); margin: 20px; font-weight: bold; font-size: 1.1rem; }
.fab { position: fixed; bottom: 85px; left: 20px; width: 60px; height: 60px; background: var(--p); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: none; z-index: 850; }

/* List Items */
.item-card { background: var(--card-bg); margin: 10px 20px; padding: 15px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; border-right: 5px solid var(--p); }
</style>
</head>
<body>

<div class="header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <i class="fas fa-bars" onclick="openLayer('sidebar')" style="font-size: 1.2rem;"></i>
        <h2 style="margin:0">ميزانيتك الذكية</h2>
        <i class="fas fa-moon" onclick="toggleDarkMode()"></i>
    </div>
    <div class="balance-card">
        <span>الرصيد الحالي</span>
        <span class="balance-amount" id="main-balance">0.00</span>
        <small id="currency-label">ريال سعودي</small>
    </div>
</div>

<div class="container">
    <div class="stats-grid">
        <div class="stat-item" style="color: var(--danger);">
            <i class="fas fa-arrow-up"></i>
            <small>المصروفات</small>
            <div id="stat-exp" style="font-weight:bold">0</div>
        </div>
        <div class="stat-item" style="color: var(--success);">
            <i class="fas fa-hand-holding-usd"></i>
            <small>الحقوق</small>
            <div id="stat-rig" style="font-weight:bold">0</div>
        </div>
    </div>
    
    <h3 style="padding: 0 5px;">آخر العمليات</h3>
    <div id="recent-list">
        </div>
</div>

<button class="fab" onclick="openLayer('add-exp-layer')"><i class="fas fa-plus"></i></button>

<nav class="bottom-nav">
    <button class="nav-item active" onclick="showTab('home')"><i class="fas fa-home"></i>الرئيسية</button>
    <button class="nav-item" onclick="openLayer('exp-list-layer')"><i class="fas fa-file-invoice-dollar"></i>المصروفات</button>
    <button class="nav-item" onclick="openLayer('debts-layer')"><i class="fas fa-user-clock"></i>الديون</button>
</nav>

<div id="add-exp-layer" class="layer">
    <div class="layer-header">
        <i class="fas fa-times" onclick="history.back()" style="font-size: 1.5rem; margin-left: 20px;"></i>
        <h3>إضافة عملية جديدة</h3>
    </div>
    <div class="form-group">
        <label>المبلغ</label>
        <input type="number" id="exp-amount" placeholder="0.00" inputmode="decimal">
    </div>
    <div class="form-group">
        <label>التصنيف</label>
        <select id="exp-category">
            <option value="طعام">طعام ومطاعم</option>
            <option value="فواتير">فواتير وخدمات</option>
            <option value="مواصلات">مواصلات وبنزين</option>
            <option value="صحة">صحة وأدوية</option>
            <option value="ترفيه">ترفيه وتسوق</option>
            <option value="أخرى">أخرى</option>
        </select>
    </div>
    <div class="form-group">
        <label>التاريخ</label>
        <input type="datetime-local" id="exp-date">
    </div>
    <button class="btn-main" onclick="saveExpense()">حفظ العملية</button>
</div>

<div id="sidebar" class="layer" style="width: 280px; box-shadow: 2px 0 10px rgba(0,0,0,0.2);">
    <div class="layer-header">
        <h3>الإعدادات</h3>
    </div>
    <div style="padding: 20px;">
        <p onclick="resetAllData()" style="color: var(--danger);"><i class="fas fa-trash"></i> مسح جميع البيانات</p>
        <p onclick="exportData()"><i class="fas fa-download"></i> تصدير نسخة احتياطية</p>
        <p><i class="fas fa-info-circle"></i> إصدار التطبيق 1.0.1</p>
    </div>
</div>

<script>
// --- قاعدة البيانات والإعدادات ---
let db = { exp: [], rig: [], deb: [], bal: 0 };
const IDB_NAME = "SmartBudgetDB";
const STORE_NAME = "dataStore";

// تحسين دقة الأرقام
const round = (num) => Math.round(num * 100) / 100;

// نظام التنقل المطور
function openLayer(id) {
    document.getElementById(id).classList.add('active');
    history.pushState({ layer: id }, "");
}

window.onpopstate = function(event) {
    const activeLayers = document.querySelectorAll('.layer.active');
    if (activeLayers.length > 0) {
        activeLayers[activeLayers.length - 1].classList.remove('active');
    }
};

// تشغيل الوضع المظلم
function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
}

// حفظ المصروفات
function saveExpense() {
    const amt = parseFloat(document.getElementById('exp-amount').value);
    const cat = document.getElementById('exp-category').value;
    const date = document.getElementById('exp-date').value;

    if (!amt || amt <= 0) {
        alert("يرجى إدخال مبلغ صحيح");
        return;
    }

    const newExp = { id: Date.now(), amount: round(amt), category: cat, date: date || new Date().toISOString() };
    db.exp.push(newExp);
    db.bal = round(db.bal - amt);
    
    updateUI();
    saveToLocalStorage();
    history.back(); // لإغلاق الطبقة تلقائياً
}

function updateUI() {
    document.getElementById('main-balance').innerText = db.bal.toLocaleString();
    document.getElementById('stat-exp').innerText = db.exp.reduce((a, b) => a + b.amount, 0).toLocaleString();
    
    // تحديث القائمة المصغرة
    const list = document.getElementById('recent-list');
    list.innerHTML = db.exp.slice(-5).reverse().map(item => `
        <div class="item-card">
            <div>
                <strong>${item.category}</strong><br>
                <small>${new Date(item.date).toLocaleDateString()}</small>
            </div>
            <span style="color: var(--danger)">-${item.amount}</span>
        </div>
    `).join('');
}

// تخزين بسيط (يمكن تطويره لـ IndexedDB لاحقاً)
function saveToLocalStorage() {
    localStorage.setItem('budgetData', JSON.stringify(db));
}

function loadData() {
    const saved = localStorage.getItem('budgetData');
    if (saved) {
        db = JSON.parse(saved);
        updateUI();
    }
    if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode');
    document.getElementById('exp-date').value = new Date().toISOString().slice(0, 16);
}

function resetAllData() {
    if(confirm("هل أنت متأكد من حذف كل البيانات؟")) {
        localStorage.clear();
        location.reload();
    }
}

window.onload = loadData;
</script>
</body>
</html>
