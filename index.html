<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ© | SQLite Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
    
    <style>
/* ---------------------------------------------------- */
/* Variables and Base Styling - LIGHT MODE (Default) */
/* ---------------------------------------------------- */
:root{
    --p: #0077b6; /* Primary Blue (Vibrant) */
    --s: #48cae4; /* Secondary Light Blue */
    --bg: #f7f9fc; /* Light Background */
    --danger: #ef476f; 
    --success: #2a9d8f;
    --warning: #fbc02d;
    --text-dark: #333;
    --text-light: #f7f9fc;
    --shadow-light: 0 4px 8px rgba(0, 0, 0, 0.08);
    --shadow-hover: 0 6px 15px rgba(0, 0, 0, 0.15);
    --card-bg: #fff;
    --input-bg: #fff;
    --border-color: #ddd;
    --tab-active-bg: #fff;
}

/* ---------------------------------------------------- */
/* Dark Mode Variables */
/* ---------------------------------------------------- */
body.dark-mode {
    --p: #90e0ef; /* Lighter Primary Blue for contrast */
    --s: #48cae4; 
    --bg: #1f1f1f; /* Dark Background */
    --danger: #ff8a80;
    --success: #66bb6a;
    --warning: #fbc02d;
    --text-dark: #e0e0e0; /* Light Text */
    --text-light: #1f1f1f;
    --shadow-light: 0 4px 10px rgba(0, 0, 0, 0.5);
    --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.8);
    --card-bg: #2d2d2d;
    --input-bg: #3c3c3c;
    --border-color: #555;
    --tab-active-bg: #2d2d2d;
}

/* ---------------------------------------------------- */
/* Global Reset and Base Styling */
/* ---------------------------------------------------- */
* {
    box-sizing: border-box;
}
body{
    margin:0;
    font-family: 'Tajawal', 'Arial', sans-serif;
    background: var(--bg);
    color: var(--text-dark);
    overflow-x: hidden;
    line-height: 1.6;
    transition: background 0.3s, color 0.3s;
}

/* Global Dark Mode Overrides for Specific Elements */
.card, .sidebar, .modal { background: var(--card-bg); }
.modal header { background: var(--card-bg); border-bottom: 1px solid var(--border-color); }

/* ---------------------------------------------------- */
/* Header & Navigation */
/* ---------------------------------------------------- */
header{
    background: var(--p);
    color: var(--text-light);
    padding: 15px;
    font-size: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-hover);
    position: sticky;
    top: 0;
    z-index: 10;
}
header .title { flex-grow: 1; text-align: center; font-weight: 800; }
header button {
    background: none; 
    border: none; 
    color: var(--text-light); 
    font-size: 20px; 
    cursor: pointer; 
    padding: 0 10px;
    transition: transform 0.2s;
}
header button:hover { transform: scale(1.1); }

.tabs{
    display:flex;
    background: var(--card-bg);
    border-bottom: 2px solid var(--border-color);
    box-shadow: var(--shadow-light);
    overflow-x: auto; 
    white-space: nowrap;
}
.tabs button{
    flex: 1 1 auto; 
    min-width: 0; 
    padding: 15px 10px;
    border:none;
    background: var(--card-bg);
    color: var(--text-dark);
    font-weight: 700;
    font-size: 14px;
    transition: all 0.3s;
    border-bottom: 3px solid transparent;
}
.tabs button.active{
    color: var(--p);
    border-bottom: 3px solid var(--p);
    background: color-mix(in srgb, var(--bg) 90%, var(--p)); 
}
body.dark-mode .tabs button.active {
    background: color-mix(in srgb, var(--bg) 85%, var(--p)); 
}

/* ---------------------------------------------------- */
/* General Layout & Cards */
/* ---------------------------------------------------- */
.section{ display:none; padding: 15px; }
.section.active{ display:block; }
.card{
    background:var(--card-bg);
    padding: 20px;
    border-radius: 15px;
    box-shadow: var(--shadow-light);
    margin-bottom: 15px;
    border-top: 5px solid var(--s); 
    transition: background 0.3s, border-color 0.3s;
}

/* ---------------------------------------------------- */
/* Overview Section Styling (New Dashboard) */
/* ---------------------------------------------------- */
#overview .balance-display {
    text-align: center;
    padding: 30px 20px;
    margin-bottom: 20px;
    border-radius: 15px;
    background: var(--card-bg);
    box-shadow: var(--shadow-hover);
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    align-items: center;
}
#overview .balance-display h2 {
    margin: 0 0 5px 0;
    font-size: 18px;
    color: #999;
}
#overview .balance-display p {
    font-size: 38px;
    font-weight: 800;
    margin: 5px 0 0 0;
    color: var(--p);
    display: flex;
    align-items: center;
}
#overview .balance-display button {
    background: none;
    border: none;
    color: var(--p);
    font-size: 24px;
    cursor: pointer;
    margin-right: 10px;
    transition: color 0.2s;
}
#overview .balance-display button:hover {
    color: var(--s);
}
#overview .balance-actions {
    display: flex;
    gap: 15px;
    margin-top: 10px;
}
#overview .balance-actions .action {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    color: var(--text-dark);
    border-radius: 10px;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-light);
    transition: all 0.2s;
    background: var(--input-bg);
}
#overview .balance-actions .action:hover {
    box-shadow: var(--shadow-hover);
    transform: translateY(-2px);
    border-color: var(--p);
}
#overview .balance-actions .action i {
    font-size: 24px;
    margin-bottom: 5px;
}
#overview .balance-actions .deposit i { color: var(--success); }
#overview .balance-actions .withdraw i { color: var(--danger); }

/* ---------------------------------------------------- */
/* Form Elements & Inputs */
/* ---------------------------------------------------- */
input, select, .datetime-container input[type="datetime-local"] {
    width: 100%;
    padding: 14px;
    margin: 8px 0;
    font-size: 16px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    box-sizing: border-box;
    background: var(--input-bg);
    color: var(--text-dark);
    transition: all 0.3s;
    /* Ø§Ù„Ø£Ù‡Ù…: Ø¶Ù…Ø§Ù† Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© */
    direction: ltr;
    text-align: right;
}

input:focus, select:focus, .datetime-container input[type="datetime-local"]:focus {
    border-color: var(--s);
    box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.2);
    outline: none;
}
body.dark-mode input:focus, body.dark-mode select:focus, body.dark-mode .datetime-container input[type="datetime-local"]:focus {
    box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.3);
}

.datetime-container { position: relative; width: 100%; margin: 8px 0; }
.datetime-container input[type="datetime-local"] { margin: 0; padding-left: 40px; }

.calendar-icon {
    position: absolute;
    top: 50%;
    left: 15px; 
    transform: translateY(-50%);
    font-size: 1.4em;
    z-index: 2;
    pointer-events: none; 
    color: var(--p); 
}

/* ---------------------------------------------------- */
/* Buttons & Actions */
/* ---------------------------------------------------- */
button.action{
    background: var(--p);
    color: var(--text-light);
    border: none;
    padding: 16px;
    width: 100%;
    border-radius: 10px;
    font-size: 18px;
    font-weight: bold;
    margin-top: 10px;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
    box-shadow: var(--shadow-light);
}
button.action:hover{
    background: color-mix(in srgb, var(--p) 85%, black); 
    transform: translateY(-2px);
}

button.secondary{
    background: var(--input-bg);
    color: var(--text-dark);
    padding: 12px;
    width: 100%;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    margin-top: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s;
}
button.secondary:hover {
    background: color-mix(in srgb, var(--input-bg) 80%, #999); 
}

/* ---------------------------------------------------- */
/* Utility & Custom Elements */
/* ---------------------------------------------------- */
.toast{
    position:fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: var(--text-light);
    padding: 12px 25px;
    border-radius: 30px;
    display:none;
    z-index: 100;
    font-size: 15px;
    box-shadow: var(--shadow-hover);
    white-space: nowrap;
}

.currency-symbol { color: var(--p); font-weight: bold; font-size: 1.1em; margin-right: 5px; }
.hidden-balance { font-size: 38px; font-weight: 800; letter-spacing: 5px; color: var(--p); }

/* ---------------------------------------------------- */
/* Modals and Sidebar Refinements */
/* ---------------------------------------------------- */
.modal{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background: var(--bg);
    display:none;
    flex-direction:column;
    z-index: 30;
    overflow-y: auto;
}
.modal header{
    display:flex;
    gap: 10px;
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    background: var(--card-bg);
    align-items: center;
    box-shadow: var(--shadow-light);
    position: sticky;
    top: 0;
    z-index: 35;
}
.modal header .title { flex-grow: 1; text-align: center; font-weight: 700; }
.modal header button {
    background: none; 
    border: none; 
    color: var(--text-dark); 
    font-size: 20px; 
    cursor: pointer; 
    padding: 0 10px;
}
.modal-content {
    flex-grow: 1;
    padding: 15px;
}

.sidebar {
    position: fixed;
    top: 0;
    right: 0; 
    width: 300px; 
    max-width: 85%;
    height: 100%;
    background: var(--card-bg);
    box-shadow: -4px 0 12px rgba(0, 0, 0, 0.2);
    transform: translateX(100%); 
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
    z-index: 25; 
    display: flex;
    flex-direction: column;
}
.sidebar.open { transform: translateX(0); }

/* Switch Style (Dark Mode) */
.switch-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    font-size: 17px;
    color: var(--text-dark);
}
/* ... (ÙƒÙˆØ¯ Ø§Ù„Ù€ switch Ù„Ù… ÙŠØªØºÙŠØ±) ... */
.switch { position: relative; display: inline-block; width: 45px; height: 25px; }
.switch input {opacity: 0; width: 0; height: 0;}
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: var(--border-color); transition: .4s; border-radius: 25px;
}
.slider:before {
    position: absolute; content: ""; height: 19px; width: 19px; left: 3px; bottom: 3px;
    background-color: white; transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: var(--p); }
input:checked + .slider:before { transform: translateX(20px); }


/* Sidebar */
.sidebar-header {
    padding: 15px;
    background: var(--p);
    color: var(--text-light);
    font-size: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
}
.sidebar-content {
    flex-grow: 1;
    padding: 15px 0;
    overflow-y: auto;
}

.sidebar-menu-item {
    padding: 15px 20px;
    margin: 5px 0;
    display: flex;
    align-items: center;
    justify-content: space-between; 
    gap: 15px;
    font-size: 17px;
    color: var(--text-dark);
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
}

.sidebar-menu-item:hover {
    background: var(--s);
    color: var(--text-dark); 
}
.sidebar-menu-item i { font-size: 1.2em; }

.sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    z-index: 24;
}
.sidebar-overlay.open { display: block; }

/* Small Image Source Modal */
#imageSourceModal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80%;
    max-width: 350px;
    height: auto;
    background: var(--card-bg);
    border-radius: 15px;
    box-shadow: var(--shadow-hover);
    padding: 20px;
    z-index: 150;
    display: none; 
    flex-direction: column;
    align-items: center;
}
/* **Ø§Ù„Ø¥ØµÙ„Ø§Ø­:** Ø¬Ø¹Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…Ø±Ø¦ÙŠØ© Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ open */
#imageSourceModal.open {
    display: flex;
}

#imageSourceModal h3 {
    margin-top: 0;
    color: var(--p);
    text-align: center;
}
#imageSourceModal button {
    margin: 10px 0;
    padding: 15px;
    font-size: 16px;
    border-radius: 10px;
    width: 100%;
}

/* Toast Animation */
.toast.show{
    display:block;
    animation: fadeInOut 2.5s ease-in-out forwards;
}

@keyframes fadeInOut {
    0% { opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { opacity: 0; }
}

/* List Item */
.list-item{
    background: var(--card-bg);
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    border-right: 5px solid var(--s); 
    color: var(--text-dark);
}
.list-item:hover {
    background: color-mix(in srgb, var(--card-bg) 95%, #999);
    box-shadow: var(--shadow-light);
}
.list-item .details {
    font-size: 0.9em; 
    color: #666; 
    text-align: right;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 5px;
}

/* ---------------------------------------------------- */
/* Responsive Fix for Tabs (Small Screens) */
/* ---------------------------------------------------- */
@media (max-width: 450px) {
    .tabs button {
        padding: 15px 5px; 
        font-size: 13px; 
    }
}
</style>
</head>

<body>

<header>
    <button onclick="openSidebar()"><i class="fas fa-bars"></i></button> 
    <span class="title">Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</span>
    <button style="visibility: hidden;"><i class="fas fa-search"></i></button> 
</header>

<div class="tabs">
    <button class="active" onclick="openTab('overview')">
        <i class="fas fa-tachometer-alt" style="margin-left: 5px;"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©
    </button>
    <button onclick="openTab('expenses')">
        <i class="fas fa-money-bill-wave" style="margin-left: 5px;"></i> Ù…ØµØ±ÙˆÙØ§Øª
    </button>
    <button onclick="openTab('rights')">
        <i class="fas fa-handshake" style="margin-left: 5px;"></i> Ø­Ù‚ÙˆÙ‚
    </button>
    <button onclick="openTab('debts')">
        <i class="fas fa-file-invoice" style="margin-left: 5px;"></i> Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    </button>
</div>

<div id="overview" class="section active">
    <div class="balance-display">
        <h2>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
        <p id="currentBalanceDisplay">
            <i class="fas fa-spinner fa-spin"></i>
        </p>
        <button onclick="toggleBalanceVisibility()" id="balanceVisibilityToggle" title="Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±ØµÙŠØ¯">
             <i class="fas fa-eye"></i>
        </button>
    </div>

    <div class="balance-actions">
        <button class="action deposit" onclick="openBalanceActionModal('deposit')">
            <i class="fas fa-plus-circle"></i> Ø¥ÙŠØ¯Ø§Ø¹
        </button>
        <button class="action withdraw" onclick="openBalanceActionModal('withdraw')">
            <i class="fas fa-minus-circle"></i> Ø³Ø­Ø¨
        </button>
    </div>
    
    <button class="secondary" onclick="openBalanceLogModal()" style="margin-top: 15px;">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯
    </button>
    <div class="card" style="margin-top: 20px; border-top: 5px solid var(--p);">
        <h3 style="color: var(--p); margin-top: 0;"><i class="fas fa-calculator" style="margin-left: 5px;"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
        <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (ØªØ´Ù…Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª):</span> <b id="sExpTotal">0</b></p>
        <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©:</span> <b id="sRigTotal">0</b></p>
        <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©:</span> <b id="sDebTotal">0</b></p>
        <p><span>Ø§Ù„Ù…Ø­ØµÙ„ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ‚:</span> <b id="sRigPaid">0</b></p>
        <p><span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª:</span> <b id="sDebPaid">0</b></p>
        </div>
</div>

<div id="expenses" class="section">
    <div class="card">
    <p style="color: var(--danger); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡Ø§ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙˆØ±Ø§Ù‹</p>
    <input id="eAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
    <select id="eType">
    <option value="">ğŸ›’ Ø§Ù„ÙØ¦Ø© (Ù†ÙÙ‚Ø§Øª Ù…ØªØºÙŠØ±Ø©)</option>
    <option>Ø·Ø¹Ø§Ù…</option><option>Ù…ÙˆØ§ØµÙ„Ø§Øª</option>
    <option>Ø±Ø¹Ø§ÙŠØ© Ø´Ø®ØµÙŠØ©</option><option>Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
    <option>ØµØ­Ø©</option><option>ØªØ±ÙÙŠÙ‡</option><option>ØªØ³ÙˆÙ‚</option>
    <option>ØªØ¹Ù„ÙŠÙ…</option><option>ØµÙŠØ§Ù†Ø© ÙˆØ¥ØµÙ„Ø§Ø­</option><option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="eDesc" placeholder="ğŸ“ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
    <div class="datetime-container">
        <input id="eDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    
    <button class="secondary" onclick="showImageSourceModal()">
        <i class="fas fa-camera" style="margin-left: 5px;"></i> Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    </button>
    <span id="eImgName" style="display: block; font-size: 0.8em; color: var(--success); text-align: right; margin-top: 5px;"></span>
    <input type="file" id="eImgCamera" accept="image/*" capture="camera" style="display: none;" onchange="updateFileName(this, 'eImgName')">
    <input type="file" id="eImgGallery" accept="image/*" style="display: none;" onchange="updateFileName(this, 'eImgName')">
    <button class="action" onclick="addExpense()">
        <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ
    </button>
    <button class="secondary" onclick="openLog('exp')">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
    </button>
    </div>
</div>

<div id="rights" class="section">
    <div class="card">
    <p style="color: var(--success); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„Ø© (Ø¯ÙØ¹ Ø§Ù„Ø¯ÙŠÙ†/Ø§Ù„Ø¢Ø¬Ù„) ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
    <select id="rType" onchange="updateRightFields(this.value)">
    <option value="">ğŸ¤ Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚</option>
    <option>Ø¯ÙŠÙ†</option>
    <option>Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„</option>
    <option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="rAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚ (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ)" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
    <div id="rDynamicFields"></div>
    <input id="rDesc" placeholder="ğŸ‘¤ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ù„Ù…Ø¯ÙŠÙ†/Ø§Ù„Ø¬Ù‡Ø©)">
    <div class="datetime-container">
        <input id="rDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    <select id="rStatus">
    <option value="">âœ… Ø§Ù„Ø­Ø§Ù„Ø©</option>
    <option value="ÙƒØ§Ù…Ù„">Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</option>
    <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ Ø¨Ø¹Ø¯</option>
    </select>
    <button class="action" onclick="addRight()">
        <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ø­Ù‚
    </button>
    <button class="secondary" onclick="openLog('rig')">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ‚
    </button>
    </div>
</div>

<div id="debts" class="section">
    <div class="card">
    <p style="color: var(--danger); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø¯ÙØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
    <select id="dType" onchange="updateDebtFields(this.value)">
    <option value="">ğŸ§¾ Ù†ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</option>
    <option>Ø¥ÙŠØ¬Ø§Ø±</option>
    <option>ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
    <option>Ù…Ø§Ø¡</option>
    <option>Ø¥Ù†ØªØ±Ù†Øª</option>
    <option>Ù‚Ø±Ø¶</option> <option>Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ</option> <option>Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø© Ø£Ø®Ø±Ù‰</option>
    <option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="dAmount" type="text" placeholder="ğŸ’µ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©/Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">

    <div id="dDynamicFields"></div>
    <input id="dDesc" placeholder="ğŸ¢ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ù„Ø¯Ø§Ø¦Ù†/Ø§Ù„Ø¬Ù‡Ø©)">
    <div class="datetime-container">
        <input id="dDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    <select id="dStatus">
    <option value="">âœ… Ø§Ù„Ø­Ø§Ù„Ø©</option>
    <option value="Ù…Ø¯ÙÙˆØ¹">Ù…Ø¯ÙÙˆØ¹</option>
    <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
    </select>
    <button class="action" onclick="addDebt()">
        <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…
    </button>
    <button class="secondary" onclick="openLog('deb')">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    </button>
    </div>
</div>

<div class="modal" id="logModal">
    <header>
        <input id="search" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„..." oninput="renderLog()">
        <button onclick="closeLayer('log')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content" id="logContent"></div>
</div>

<div class="modal" id="detailModal">
    <header>
        <span class="title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</span>
        <button onclick="closeLayer('detail')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content detail" id="detailContent"></div>
</div>

<div class="modal" id="editModal">
    <header>
        <span class="title" id="editModalTitle">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</span>
        <button onclick="closeLayer('edit')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <div id="editFormContainer">
            <div id="editExpForm" style="display:none;">
                <input id="eEditAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
                <select id="eEditType"></select> <input id="eEditDesc" placeholder="ğŸ“ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
                <div class="datetime-container">
                    <input id="eEditDate" type="datetime-local">
                    <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
                </div>
                
                <p id="eEditImgInfo" style="font-size: 0.9em; color: var(--p); text-align: right; margin-top: 10px;"></p>
                <button class="secondary" onclick="document.getElementById('eEditImgNew').click()">
                    <i class="fas fa-camera" style="margin-left: 5px;"></i> Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                </button>
                <input type="file" id="eEditImgNew" accept="image/*" style="display: none;" onchange="updateEditFileName(this, 'eEditImgInfo')">
                <button class="secondary" id="eEditImgRemoveBtn" style="background: var(--danger); color: var(--text-light); border: none; margin-top: 5px; display: none;" onclick="removeEditImage('eEditImgInfo')">
                     <i class="fas fa-trash-alt" style="margin-left: 5px;"></i> Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                </button>
            </div>

            <div id="editRigDebForm" style="display:none;">
                <select id="rdEditType"></select> <input id="rdEditAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
                <div id="rdEditDynamicFields"></div>
                <input id="rdEditDesc" placeholder="ğŸ“ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
                <div class="datetime-container">
                    <input id="rdEditDate" type="datetime-local">
                    <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
                </div>
                <select id="rdEditStatus"></select> <p id="rdEditPaidInfo" style="font-size: 0.9em; color: var(--success); text-align: right; margin-top: 10px; font-weight: bold;"></p>
            </div>

        </div>

        <button class="action" onclick="updateTransaction()">
            <i class="fas fa-check" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
        </button>
    </div>
</div>


<div class="modal" id="balanceActionModal">
    <header>
        <span class="title" id="actionModalTitle"></span>
        <button onclick="closeLayer('balanceAction')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <p style="text-align: center; font-size: 1.1em;">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="currentBalanceInAction" style="color: var(--p); font-weight: bold;"></span></p>
        <input id="bAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
        <input id="bDesc" placeholder="ğŸ“ ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Ù…Ø«Ù„: Ø±Ø§ØªØ¨ØŒ ØªØ­ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ)">
        <div class="datetime-container">
            <input id="bDate" type="datetime-local">
            <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
        </div>
        <button class="action" onclick="processBalanceAction()">
            <i class="fas fa-check" style="margin-left: 5px;"></i> ØªÙ†ÙÙŠØ°
        </button>
    </div>
</div>

<div class="modal" id="balanceLogModal">
    <header>
        <span class="title">Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯</span>
        <button onclick="closeLayer('balanceLog')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content" id="balanceLogContent">
        </div>
</div>

<div id="imageSourceModal">
    <h3 style="margin-bottom: 20px;">Ø§Ø®ØªÙŠØ§Ø± Ù…ØµØ¯Ø± Ø§Ù„ØµÙˆØ±Ø©</h3>
    <button class="action" onclick="openCameraInput()"><i class="fas fa-camera" style="margin-left: 10px;"></i> Ø§Ù„ØªÙ‚Ø§Ø· Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
    <button class="secondary" onclick="openGalleryInput()"><i class="fas fa-images" style="margin-left: 10px;"></i> Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ø¶</button>
    <button class="secondary" style="background: none; border: none; color: var(--danger); margin-top: 10px;" onclick="closeLayer('imageSource')">Ø¥Ù„ØºØ§Ø¡</button>
</div>
<div class="sidebar-overlay" id="imageSourceOverlay" style="z-index: 140; display: none;" onclick="closeLayer('imageSource')"></div>

<div class="toast" id="toast"></div>

<div class="sidebar-overlay" onclick="closeLayer('sidebar')"></div>

<div class="sidebar" id="appSidebar">
    <div class="sidebar-header">
        <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        <button onclick="closeLayer('sidebar')"><i class="fas fa-times"></i></button>
    </div>
    <div class="sidebar-content">
        <div class="card" style="margin: 0 15px 15px; border-top: 5px solid var(--s);">
             <p style="font-weight: bold; margin-top: 0; color: var(--p);">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</p>
             
             <div class="switch-container">
                 <i class="fas fa-moon" style="margin-left: 10px;"></i> <span>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span>
                 <label class="switch">
                     <input type="checkbox" id="darkModeToggle" onclick="toggleDarkMode()">
                     <span class="slider"></span>
                 </label>
             </div>
             
             <button class="secondary" onclick="openCurrencyModal()" style="display: flex; justify-content: space-between; align-items: center; border: none; background: var(--card-bg); margin-top: 15px;">
                 <span id="currentCurrencyDisplay" style="font-weight: bold;">Ø§Ù„Ø¹Ù…Ù„Ø©: Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ (Ø±.Ø³)</span>
                 <span style="color: var(--p);"><i class="fas fa-exchange-alt"></i> ØªØºÙŠÙŠØ±</span>
             </button>
        </div>
        
        <div class="sidebar-menu-item" onclick="exportData()">
            <i class="fas fa-file-export"></i> <span>ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</span>
        </div>
        
        <div class="sidebar-menu-item" onclick="document.getElementById('importFile').click()">
            <i class="fas fa-file-import"></i> <span>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</span>
        </div>
        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
        
        <div class="sidebar-menu-item" onclick="openAboutModal()">
            <i class="fas fa-info-circle"></i> <span>Ø­ÙˆÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>
        </div>
        
        <div class="sidebar-menu-item" onclick="confirmResetData()" style="color: var(--danger);">
            <i class="fas fa-exclamation-triangle"></i> <span>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        </div>
    </div>
</div>

<div class="modal" id="aboutModal">
    <header>
        <h3 style="color: var(--p);">Ø­ÙˆÙ„ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ©</h3>
        <button onclick="closeLayer('about')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <p>ØªØ·Ø¨ÙŠÙ‚ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© Ù‡Ùˆ Ø£Ø¯Ø§Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ ØªØªØ¨Ø¹:</p>
        <ul>
            <li><i class="fas fa-wallet" style="color: var(--s);"></i> **Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø©** Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.</li>
            <li><i class="fas fa-receipt" style="color: var(--s);"></i> **Ø§Ù„Ø­Ù‚ÙˆÙ‚** Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ù„Ùƒ (Ø¯ÙŠÙˆÙ†ØŒ Ø¨ÙŠØ¹ Ø¢Ø¬Ù„).</li>
            <li><i class="fas fa-clipboard-list" style="color: var(--s);"></i> **Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª** Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ø¹Ù„ÙŠÙƒ (ÙÙˆØ§ØªÙŠØ±ØŒ Ø£Ù‚Ø³Ø§Ø·ØŒ Ù‚Ø±ÙˆØ¶).</li>
        </ul>
        <p class="card" style="border-top: 3px solid var(--danger);">
            <strong>Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©:</strong> ÙŠØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ© SQLite Ø¹Ø¨Ø± `sql.js`. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ.
        </p>
        <p style="text-align: center; margin-top: 20px; color: #999; font-size: 0.9em;">Ø§Ù„Ø¥ØµØ¯Ø§Ø± 4.0 (SQLite Edition)</p>
    </div>
</div>

<div class="modal" id="currencyModal">
    <header>
        <h3 style="color: var(--p);">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø©</h3>
        <button onclick="closeLayer('currency')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <input id="currencySearch" type="text" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„Ø© (Ø±ÙŠØ§Ù„ØŒ Ø¬Ù†ÙŠÙ‡ØŒ Ø¯ÙˆÙ„Ø§Ø±...)" oninput="renderCurrencyList()">
        <div id="currencyList">
            </div>
    </div>
</div>

<script>
// ===================================================
// 1. Ø¥Ø¹Ø¯Ø§Ø¯ SQLite Ùˆ IndexedDB Ù„Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ…Ø± (Persistent Storage)
// ===================================================

const DB_FILENAME = "budget.sqlite"; // Ø§Ø³Ù… Ù…Ù„Ù Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
const IDB_STORE_NAME = "sqlite-storage";
let SQL_DB = null; // ÙƒØ§Ø¦Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª SQLite 
let SQL_INIT = null; // Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù sql-wasm.js Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©

// Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
let currentBalance = 0; 
let balanceHidden = localStorage.getItem('balanceHidden') === 'true'; 
let currentImageBase64 = null; 
let transactionCache = { exp: [], rig: [], deb: [], bal: { changes: [] } }; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„

const EXP_TYPES = ["Ø·Ø¹Ø§Ù…", "Ù…ÙˆØ§ØµÙ„Ø§Øª", "Ø±Ø¹Ø§ÙŠØ© Ø´Ø®ØµÙŠØ©", "Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©", "ØµØ­Ø©", "ØªØ±ÙÙŠÙ‡", "ØªØ³ÙˆÙ‚", "ØªØ¹Ù„ÙŠÙ…", "ØµÙŠØ§Ù†Ø© ÙˆØ¥ØµÙ„Ø§Ø­", "Ø£Ø®Ø±Ù‰"];
const RIG_TYPES = ["Ø¯ÙŠÙ†", "Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„", "Ø£Ø®Ø±Ù‰"];
const DEB_TYPES = ["Ø¥ÙŠØ¬Ø§Ø±", "ÙƒÙ‡Ø±Ø¨Ø§Ø¡", "Ù…Ø§Ø¡", "Ø¥Ù†ØªØ±Ù†Øª", "Ù‚Ø±Ø¶", "Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ", "Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø© Ø£Ø®Ø±Ù‰", "Ø£Ø®Ø±Ù‰"];

// Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ù‚Ù„
const LAYERS = {
    'sidebar': { elementId: 'appSidebar', type: 'menu' },
    'log': { elementId: 'logModal', type: 'modal' },
    'detail': { elementId: 'detailModal', type: 'modal' },
    'currency': { elementId: 'currencyModal', type: 'modal' },
    'about': { elementId: 'aboutModal', type: 'modal' },
    'balanceAction': { elementId: 'balanceActionModal', type: 'modal' },
    'balanceLog': { elementId: 'balanceLogModal', type: 'modal' },
    'imageSource': { elementId: 'imageSourceModal', type: 'menu' },
    'edit': { elementId: 'editModal', type: 'modal' }
};
let historyStack = [];

const ARABIC_CURRENCIES = [
    { code: 'SAR', symbol: 'Ø±.Ø³', name: 'Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ' },
    { code: 'EGP', symbol: 'Ø¬.Ù…', name: 'Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ' },
    { code: 'AED', symbol: 'Ø¯.Ø¥', name: 'Ø¯Ø±Ù‡Ù… Ø¥Ù…Ø§Ø±Ø§ØªÙŠ' },
    { code: 'KWD', symbol: 'Ø¯.Ùƒ', name: 'Ø¯ÙŠÙ†Ø§Ø± ÙƒÙˆÙŠØªÙŠ' },
    { code: 'USD', symbol: '$', name: 'Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ' },
    { code: 'QAR', symbol: 'Ø±.Ù‚', name: 'Ø±ÙŠØ§Ù„ Ù‚Ø·Ø±ÙŠ' },
    { code: 'OMR', symbol: 'Ø±.Ø¹.', name: 'Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ' },
    { code: 'JOD', symbol: 'Ø¯.Ø§', name: 'Ø¯ÙŠÙ†Ø§Ø± Ø£Ø±Ø¯Ù†ÙŠ' },
    { code: 'ILS', symbol: 'Ø´.Ø¬', name: 'Ø´ÙŠÙƒÙ„ ÙÙ„Ø³Ø·ÙŠÙ†ÙŠ Ø¬Ø¯ÙŠØ¯' }, 
    { code: 'EUR', symbol: 'â‚¬', name: 'ÙŠÙˆØ±Ùˆ' },
];

let currentCurrency = ARABIC_CURRENCIES.find(c => c.code === (localStorage.getItem('currencyCode') || 'SAR'));

// ------------------------------------------------------------------
// IndexedDB Wrapper for saving the SQL file (Persistence Layer)
// ------------------------------------------------------------------

function initIDBForSQL() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_FILENAME, 1);
        
        request.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(IDB_STORE_NAME)) {
                db.createObjectStore(IDB_STORE_NAME, { keyPath: 'id' });
            }
        };

        request.onsuccess = (e) => resolve(e.target.result);
        request.onerror = (e) => reject(e.target.error);
    });
}

async function loadDatabaseFile(dbName) {
    const idb = await initIDBForSQL();
    return new Promise((resolve, reject) => {
        const transaction = idb.transaction([IDB_STORE_NAME], "readonly");
        const store = transaction.objectStore(IDB_STORE_NAME);
        const request = store.get(dbName);
        
        request.onsuccess = (e) => resolve(e.target.result ? e.target.result.data : null);
        request.onerror = (e) => reject(e.target.error);
    });
}

async function saveDatabaseFile(dbName, data) {
    const idb = await initIDBForSQL();
    return new Promise((resolve, reject) => {
        const transaction = idb.transaction([IDB_STORE_NAME], "readwrite");
        const store = transaction.objectStore(IDB_STORE_NAME);
        const request = store.put({ id: dbName, data: data });
        
        request.onsuccess = () => resolve();
        request.onerror = (e) => reject(e.target.error);
    });
}

// ------------------------------------------------------------------
// SQLite Initialization and Structure
// ------------------------------------------------------------------

async function initDB() {
    try {
        // ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© sql-wasm
        SQL_INIT = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}` });
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ù† IndexedDB
        const savedData = await loadDatabaseFile(DB_FILENAME);
        
        if (savedData) {
            SQL_DB = new SQL_INIT.Database(savedData);
            toastMsg("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª SQLite Ø¨Ù†Ø¬Ø§Ø­.");
        } else {
            // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª
            SQL_DB = new SQL_INIT.Database();
            createTables();
            toastMsg("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª SQLite Ø¬Ø¯ÙŠØ¯Ø©.");
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await loadAllData(); 
        updateStats();
        updateBalanceDisplay();
        
        // ØªØ¹ÙŠÙŠÙ† Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù
        setInterval(saveDBToFile, 5000); 

    } catch (e) {
        console.error("Failed to initialize SQLite:", e);
        toastMsg("Ø®Ø·Ø£ ÙØ§Ø¯Ø­: ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ SQLite.");
    }
}

function createTables() {
    const tableQueries = [
        `CREATE TABLE IF NOT EXISTS transactions (
            id TEXT PRIMARY KEY,
            type TEXT NOT NULL, 
            amount REAL NOT NULL, 
            currentAmount REAL, 
            paidAmount REAL DEFAULT 0, 
            desc TEXT, 
            date TEXT NOT NULL, 
            currency TEXT NOT NULL,
            status TEXT, 
            dueDate TEXT, 
            person TEXT,
            img TEXT
        );`,
        `CREATE TABLE IF NOT EXISTS balance (
            id INTEGER PRIMARY KEY,
            amount REAL NOT NULL
        );`,
        `CREATE TABLE IF NOT EXISTS balance_changes (
            id TEXT PRIMARY KEY,
            type TEXT NOT NULL, 
            amount REAL NOT NULL, 
            desc TEXT, 
            date TEXT NOT NULL, 
            currency TEXT NOT NULL,
            newBalance REAL NOT NULL
        );`
    ];

    SQL_DB.exec(tableQueries.join(''));
    
    // Ø¥Ø¯Ø±Ø§Ø¬ Ø³Ø¬Ù„ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙØ§Ø±ØºÙ‹Ø§
    const balanceCount = SQL_DB.exec("SELECT COUNT(*) FROM balance;")[0].values[0][0];
    if (balanceCount === 0) {
        SQL_DB.exec("INSERT INTO balance (id, amount) VALUES (1, 0);");
    }
}

function executeSql(query, params = {}) {
    if (!SQL_DB) throw new Error("SQLite DB not initialized.");
    try {
        const stmt = SQL_DB.prepare(query);
        stmt.bind(params);
        let rows = [];
        while (stmt.step()) {
            let row = stmt.getAsObject();
            // ØªØ­ÙˆÙŠÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø¯Ø¯ÙŠØ© Ø§Ù„ØªÙŠ ØªÙ… ØªØ®Ø²ÙŠÙ†Ù‡Ø§ ÙƒØ³Ù„Ø³Ù„Ø© (Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±)
            rows.push(row);
        }
        stmt.free();
        return rows;
    } catch (e) {
        console.error("SQL Execution Error:", e);
        toastMsg("Ø®Ø·Ø£ ÙÙŠ ØªÙ†ÙÙŠØ° Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
        throw e;
    }
}

function executeRun(query, params = {}) {
    if (!SQL_DB) throw new Error("SQLite DB not initialized.");
    try {
        SQL_DB.run(query, params);
    } catch (e) {
        console.error("SQL Run Error:", e);
        toastMsg("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
        throw e;
    }
}

async function saveDBToFile() {
    if (!SQL_DB) return;
    try {
        const data = SQL_DB.export();
        await saveDatabaseFile(DB_FILENAME, data);
    } catch (e) {
        console.error("Error saving SQLite file:", e);
    }
}

// ===================================================
// 2. ÙˆØ¸Ø§Ø¦Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Load All Data)
// ===================================================

async function loadAllData() {
    if (!SQL_DB) return;
    try {
        // 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
        const balanceResult = executeSql("SELECT amount FROM balance WHERE id = 1;");
        currentBalance = balanceResult.length ? balanceResult[0].amount : 0;
        
        // 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ§Øª
        transactionCache.exp = executeSql("SELECT * FROM transactions WHERE type = 'exp' ORDER BY date DESC;");
        transactionCache.rig = executeSql("SELECT * FROM transactions WHERE type = 'rig' ORDER BY date DESC;");
        transactionCache.deb = executeSql("SELECT * FROM transactions WHERE type = 'deb' ORDER BY date DESC;");
        
        // 3. ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯
        transactionCache.bal.changes = executeSql("SELECT * FROM balance_changes ORDER BY date DESC;");

    } catch(e) {
        console.error("Failed to load all data from SQLite:", e);
        toastMsg("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† SQLite.");
    }
}


// ===================================================
// 3. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆØ§Ù„Ù…Ù„Ø§Ø­ÙŠØ© (Ù„Ù… ØªØªØºÙŠØ±)
// ===================================================

function loadDarkModePreference() {
    const isDark = localStorage.getItem('darkMode') === 'true';
    if (isDark) {
        document.body.classList.add('dark-mode');
        const toggle = document.getElementById('darkModeToggle');
        if (toggle) toggle.checked = true;
    }
}

function toggleDarkMode() {
    const isDark = document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', isDark);
}

function toggleBalanceVisibility() {
    balanceHidden = !balanceHidden;
    localStorage.setItem('balanceHidden', balanceHidden);
    updateBalanceDisplay();
}

function toastMsg(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => {
        toast.classList.remove('show');
    }, 2500);
}

function getCurrencySymbol() {
    return currentCurrency.symbol;
}

function toEasternArabic(s) {
    return String(s).replace(/[0-9]/g, function(d) {
        return d.charCodeAt(0) - 48 + 1632; // 1632 is the base Unicode for Ù 
    });
}

function formatCurrency(amount) {
    if (balanceHidden) return "XXXXX";
    const formatted = formatCurrencyPlain(amount); 
    return `${formatted} ${getCurrencySymbol()}`;
}

function formatCurrencyPlain(amount) {
    const num = parseFloat(amount);
    if (isNaN(num)) return "0.00";
    const formatted = num.toLocaleString('en-US', { 
        minimumFractionDigits: 2, 
        maximumFractionDigits: 2 
    });
    return toEasternArabic(formatted);
}

function formatAmount(input) {
    let value = input.value.replace(/[^\d.]/g, ''); 
    const parts = value.split('.');
    if (parts.length > 2) {
        value = parts[0] + '.' + parts.slice(1).join('');
    }
    input.value = value;
}

function getCurrentTimestamp() {
    return new Date().toISOString();
}

function generateUniqueID() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

function openTab(tabName) {
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    document.querySelectorAll('.tabs button').forEach(button => {
        button.classList.remove('active');
    });

    document.getElementById(tabName).classList.add('active');
    document.querySelector(`.tabs button[onclick="openTab('${tabName}')"]`).classList.add('active');
    history.pushState({ layer: 'tab', tab: tabName }, '');
}

function openLayer(layerName) {
    const layer = LAYERS[layerName];
    if (layer) {
        document.getElementById(layer.elementId).style.display = (layer.type === 'modal' ? 'flex' : 'block');
        if (layer.type === 'menu' && layerName !== 'imageSource') { // Sidebar specific
            document.getElementById(layer.elementId).classList.add('open');
            document.querySelector('.sidebar-overlay').classList.add('open');
        } else if (layerName === 'imageSource') {
             document.getElementById('imageSourceModal').classList.add('open');
             document.getElementById('imageSourceOverlay').style.display = 'block';
        }
        historyStack.push({ layer: layerName });
        history.pushState({ layer: layerName }, '');
    }
}

function closeLayer(layerName) {
    const layer = LAYERS[layerName];
    if (layer) {
        if (layer.type === 'menu' && layerName !== 'imageSource') {
             document.getElementById(layer.elementId).classList.remove('open');
             document.querySelector('.sidebar-overlay').classList.remove('open');
        } else if (layerName === 'imageSource') {
             document.getElementById('imageSourceModal').classList.remove('open');
             document.getElementById('imageSourceOverlay').style.display = 'none';
        } else {
            document.getElementById(layer.elementId).style.display = 'none';
        }

        if (historyStack.length > 0 && historyStack[historyStack.length - 1].layer === layerName) {
            historyStack.pop();
        }
        
        if (layerName === 'edit') editMode = null;
        if (layerName === 'balanceAction') balanceActionType = null;
    }
}

function openSidebar() {
    openLayer('sidebar');
    loadDarkModePreference();
    document.getElementById('currentCurrencyDisplay').textContent = `Ø§Ù„Ø¹Ù…Ù„Ø©: ${currentCurrency.name} (${currentCurrency.symbol})`;
}

window.addEventListener('popstate', (event) => {
    if (event.state && event.state.layer) {
        // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ù€ handleBackNavigation() Ù‡Ù†Ø§ Ø·Ø§Ù„Ù…Ø§ Ø£Ù†Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… popstate
    } else if (historyStack.length > 0) {
        const lastLayer = historyStack[historyStack.length - 1].layer;
        closeLayer(lastLayer);
    }
});


// ===================================================
// 4. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„Ø±ØµÙŠØ¯ (ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ø´)
// ===================================================

function updateStats() {
    const currencySymbol = getCurrencySymbol();
    let expTotal = 0;
    let rigTotal = 0;
    let debTotal = 0;
    let rigPaid = 0;
    let debPaid = 0;

    transactionCache.exp.forEach(e => { expTotal += e.amount; });
    transactionCache.rig.forEach(r => {
        rigTotal += r.amount;
        rigPaid += r.paidAmount || 0;
    });
    transactionCache.deb.forEach(d => {
        debTotal += d.currentAmount || d.amount; 
        debPaid += d.paidAmount || 0;
    });
    
    document.getElementById('sExpTotal').textContent = formatCurrencyPlain(expTotal) + ' ' + currencySymbol;
    document.getElementById('sRigTotal').textContent = formatCurrencyPlain(rigTotal) + ' ' + currencySymbol;
    document.getElementById('sDebTotal').textContent = formatCurrencyPlain(debTotal) + ' ' + currencySymbol;
    document.getElementById('sRigPaid').textContent = formatCurrencyPlain(rigPaid) + ' ' + currencySymbol;
    document.getElementById('sDebPaid').textContent = formatCurrencyPlain(debPaid) + ' ' + currencySymbol;
}

function updateBalanceDisplay() {
    const displayElement = document.getElementById('currentBalanceDisplay');
    const toggleButton = document.getElementById('balanceVisibilityToggle');
    const currencySymbol = getCurrencySymbol();
    
    if (balanceHidden) {
        displayElement.innerHTML = `<span class="hidden-balance">â€¢â€¢â€¢â€¢â€¢â€¢</span>`;
        toggleButton.innerHTML = `<i class="fas fa-eye-slash"></i>`;
    } else {
        const balanceHTML = `<span class="currency-symbol">${currencySymbol}</span>${formatCurrencyPlain(currentBalance)}`;
        displayElement.innerHTML = balanceHTML;
        toggleButton.innerHTML = `<i class="fas fa-eye"></i>`;
    }
}

function openBalanceActionModal(type) {
    balanceActionType = type;
    const titleElement = document.getElementById('actionModalTitle');
    const currentBalanceElement = document.getElementById('currentBalanceInAction');
    
    titleElement.textContent = (type === 'deposit') ? 'Ø¥ÙŠØ¯Ø§Ø¹ Ù†Ù‚Ø¯ÙŠ / Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯' : 'Ø³Ø­Ø¨ Ù†Ù‚Ø¯ÙŠ / Ø®ØµÙ… Ø±ØµÙŠØ¯';
    currentBalanceElement.textContent = formatCurrency(currentBalance);
    
    document.getElementById('bAmount').value = '';
    document.getElementById('bDesc').value = '';
    document.getElementById('bDate').value = getCurrentTimestamp().slice(0, 16);
    
    openLayer('balanceAction');
}

async function processBalanceAction() {
    const amountStr = document.getElementById('bAmount').value;
    const desc = document.getElementById('bDesc').value.trim();
    const date = document.getElementById('bDate').value;

    const amount = parseFloat(amountStr);

    if (isNaN(amount) || amount <= 0) {
        return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­.");
    }
    if (!desc) {
        return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØµÙ Ù„Ù„Ø¹Ù…Ù„ÙŠØ©.");
    }
    
    const type = balanceActionType;
    let newBalance = currentBalance;
    const sign = (type === 'deposit') ? 1 : -1;
    
    newBalance += amount * sign;

    if (type === 'withdraw' && newBalance < 0) {
         if(!confirm(`Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø³Ø­Ø¨ Ø³ØªØ¬Ø¹Ù„ Ø±ØµÙŠØ¯Ùƒ Ø¨Ø§Ù„Ø³Ø§Ù„Ø¨ (${formatCurrency(newBalance)}). Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±ØŸ`)) {
            return;
        }
    }

    const newChange = {
        id: generateUniqueID(),
        type: type,
        amount: amount,
        desc: desc,
        date: date,
        currency: currentCurrency.code,
        newBalance: newBalance 
    };

    try {
        // 1. ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±ØµÙŠØ¯
        executeRun("UPDATE balance SET amount = :amount WHERE id = 1;", { ':amount': newBalance });
        
        // 2. Ø¥Ø¯Ø±Ø§Ø¬ Ø³Ø¬Ù„ Ø­Ø±ÙƒØ© Ø§Ù„Ø±ØµÙŠØ¯
        executeRun(`INSERT INTO balance_changes (id, type, amount, desc, date, currency, newBalance) 
                    VALUES (:id, :type, :amount, :desc, :date, :currency, :newBalance);`, {
                        ':id': newChange.id,
                        ':type': newChange.type,
                        ':amount': newChange.amount,
                        ':desc': newChange.desc,
                        ':date': newChange.date,
                        ':currency': newChange.currency,
                        ':newBalance': newChange.newBalance
                    });

        currentBalance = newBalance;
        transactionCache.bal.changes.unshift(newChange); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´
        updateBalanceDisplay();
        closeLayer('balanceAction');
        toastMsg(`ØªÙ… ${type === 'deposit' ? 'Ø¥ÙŠØ¯Ø§Ø¹' : 'Ø³Ø­Ø¨'} ${formatCurrency(amount)} Ø¨Ù†Ø¬Ø§Ø­.`);

    } catch (error) {
        console.error("Error saving balance action to SQL:", error);
        toastMsg("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
    }
}

// ===================================================
// 5. ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª (CRUD - Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… SQL)
// ===================================================

function validateInputs(amountId, typeId) {
    const amountStr = document.getElementById(amountId).value;
    const amount = parseFloat(amountStr);
    const type = document.getElementById(typeId).value;

    if (isNaN(amount) || amount <= 0) {
        toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­.");
        return false;
    }
    if (type === "") {
        toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹/ÙØ¦Ø©.");
        return false;
    }
    return amount;
}

function clearInputs(amountId, typeId, descId, dateId, imgNameId) {
    document.getElementById(amountId).value = '';
    document.getElementById(typeId).value = '';
    document.getElementById(descId).value = '';
    document.getElementById(dateId).value = getCurrentTimestamp().slice(0, 16);
    if(imgNameId) document.getElementById(imgNameId).textContent = '';
    currentImageBase64 = null;
    const rDynamicFields = document.getElementById('rDynamicFields');
    if(rDynamicFields) rDynamicFields.innerHTML = '';
    const dDynamicFields = document.getElementById('dDynamicFields');
    if(dDynamicFields) dDynamicFields.innerHTML = '';
}

// Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
async function addExpense() {
    const amount = validateInputs('eAmount', 'eType');
    if (!amount) return;

    const type = document.getElementById('eType').value;
    const desc = document.getElementById('eDesc').value.trim();
    const date = document.getElementById('eDate').value;
    const imgData = currentImageBase64;
    
    if (currentBalance < amount) {
        if(!confirm(`Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ (${formatCurrency(currentBalance)}) Ù„Ø§ ÙŠÙƒÙÙŠ Ù„ØªØºØ·ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙ (${formatCurrency(amount)}). Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ`)) {
            return;
        }
    }

    const newExpense = {
        id: generateUniqueID(),
        type: 'exp',
        amount: amount,
        desc: desc,
        date: date,
        currency: currentCurrency.code,
        img: imgData || null 
    };
    
    const oldBalance = currentBalance;
    const newBalance = oldBalance - amount;

    try {
        // 1. Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ù…ØµØ±ÙˆÙ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
        executeRun(`INSERT INTO transactions (id, type, amount, desc, date, currency, img) 
                    VALUES (:id, 'exp', :amount, :desc, :date, :currency, :img);`, {
                        ':id': newExpense.id,
                        ':amount': newExpense.amount,
                        ':desc': newExpense.desc,
                        ':date': newExpense.date,
                        ':currency': newExpense.currency,
                        ':img': newExpense.img
                    });

        // 2. ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯
        executeRun("UPDATE balance SET amount = :amount WHERE id = 1;", { ':amount': newBalance });
        executeRun(`INSERT INTO balance_changes (id, type, amount, desc, date, currency, newBalance) 
                    VALUES (:id, 'expense', :amount, :desc, :date, :currency, :newBalance);`, {
                        ':id': generateUniqueID(),
                        ':amount': amount,
                        ':desc': `Ù…ØµØ±ÙˆÙ: ${type} - ${desc}`,
                        ':date': date,
                        ':currency': currentCurrency.code,
                        ':newBalance': newBalance
                    });

        currentBalance = newBalance;
        transactionCache.exp.unshift(newExpense); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´
        await loadAllData(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ±ØªÙŠØ¨
        
        updateBalanceDisplay();
        updateStats();
        clearInputs('eAmount', 'eType', 'eDesc', 'eDate', 'eImgName');
        toastMsg(`ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ ÙˆØ®ØµÙ… ${formatCurrency(amount)} Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯.`);
    } catch (error) {
        console.error("Error saving expense to SQL:", error);
        toastMsg("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ.");
    }
}

// Ø§Ù„Ø­Ù‚ÙˆÙ‚ (Ù„Ùƒ)
async function addRight() {
    const amount = validateInputs('rAmount', 'rType');
    if (!amount) return;

    const type = document.getElementById('rType').value;
    const desc = document.getElementById('rDesc').value.trim();
    const date = document.getElementById('rDate').value;
    const status = document.getElementById('rStatus').value;
    const dueDate = document.getElementById('rDueDate')?.value || null;
    const person = document.getElementById('rPerson')?.value.trim() || null;
    
    if (status === "") {
        return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù‚.");
    }
    
    const isPaid = (status === 'ÙƒØ§Ù…Ù„');
    const paidAmount = isPaid ? amount : 0;
    
    const newRight = {
        id: generateUniqueID(),
        type: 'rig',
        amount: amount,
        paidAmount: paidAmount, 
        desc: desc,
        date: date,
        currency: currentCurrency.code,
        status: status,
        dueDate: dueDate,
        person: person
    };
    
    try {
        // 1. Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø­Ù‚ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
        executeRun(`INSERT INTO transactions (id, type, amount, paidAmount, desc, date, currency, status, dueDate, person) 
                    VALUES (:id, 'rig', :amount, :paidAmount, :desc, :date, :currency, :status, :dueDate, :person);`, {
                        ':id': newRight.id,
                        ':amount': newRight.amount,
                        ':paidAmount': newRight.paidAmount,
                        ':desc': newRight.desc,
                        ':date': newRight.date,
                        ':currency': newRight.currency,
                        ':status': newRight.status,
                        ':dueDate': newRight.dueDate,
                        ':person': newRight.person
                    });
        
        // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¯ÙÙˆØ¹Ø§Ù‹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        if (isPaid) {
            const oldBalance = currentBalance;
            const newBalance = oldBalance + amount;
            executeRun("UPDATE balance SET amount = :amount WHERE id = 1;", { ':amount': newBalance });
            executeRun(`INSERT INTO balance_changes (id, type, amount, desc, date, currency, newBalance) 
                        VALUES (:id, 'right_collection', :amount, :desc, :date, :currency, :newBalance);`, {
                            ':id': generateUniqueID(),
                            ':amount': amount,
                            ':desc': `ØªØ­ØµÙŠÙ„ Ø­Ù‚: ${type} - ${desc}`,
                            ':date': date,
                            ':currency': currentCurrency.code,
                            ':newBalance': newBalance
                        });
            currentBalance = newBalance;
        }

        await loadAllData();
        updateBalanceDisplay();
        updateStats();
        clearInputs('rAmount', 'rType', 'rDesc', 'rDate');
        document.getElementById('rStatus').value = '';
        toastMsg(`ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ù‚ ${isPaid ? 'ÙˆØªØ­ØµÙŠÙ„ Ù…Ø¨Ù„ØºÙ‡ ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ø±ØµÙŠØ¯.' : 'ÙƒØ­Ù‚ Ù…Ø³ØªØ­Ù‚.'}`);
    } catch (error) {
        console.error("Error saving right to SQL:", error);
        toastMsg("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø­Ù‚.");
    }
}

function updateRightFields(type) {
    const container = document.getElementById('rDynamicFields');
    let html = '';
    if (type === 'Ø¯ÙŠÙ†' || type === 'Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„') {
        html += '<input id="rPerson" placeholder="ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†/Ø§Ù„Ø¬Ù‡Ø©">';
        html += '<div class="datetime-container"><input id="rDueDate" type="datetime-local" placeholder="ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"><span class="calendar-icon"><i class="far fa-calendar-alt"></i></span></div>';
    }
    container.innerHTML = html;
}


// Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª (Ø¹Ù„ÙŠÙƒ)
async function addDebt() {
    const amount = validateInputs('dAmount', 'dType');
    if (!amount) return;

    const type = document.getElementById('dType').value;
    const desc = document.getElementById('dDesc').value.trim();
    const date = document.getElementById('dDate').value;
    const status = document.getElementById('dStatus').value;
    
    const totalAmountInput = document.getElementById('dTotalAmount')?.value;
    const totalAmount = (totalAmountInput && !isNaN(parseFloat(totalAmountInput)) && parseFloat(totalAmountInput) > 0) ? parseFloat(totalAmountInput) : amount;
    
    const dueDate = document.getElementById('dDueDate')?.value || null;
    
    if (status === "") {
        return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù….");
    }

    const isPaid = (status === 'Ù…Ø¯ÙÙˆØ¹');
    const paidAmount = isPaid ? amount : 0;
    
    if (isPaid && currentBalance < amount) {
        if(!confirm(`Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ (${formatCurrency(currentBalance)}) Ù„Ø§ ÙŠÙƒÙÙŠ Ù„Ø¯ÙØ¹ Ù‡Ø°Ø§ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… (${formatCurrency(amount)}). Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… ÙƒÙ…Ø¯ÙÙˆØ¹ (Ø³ÙŠØµØ¨Ø­ Ø±ØµÙŠØ¯Ùƒ Ø¨Ø§Ù„Ø³Ø§Ù„Ø¨)ØŸ`)) {
            return;
        }
    }

    const newDebt = {
        id: generateUniqueID(),
        type: 'deb',
        amount: totalAmount, // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…
        currentAmount: amount, // Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø·/Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        paidAmount: paidAmount, // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø­Ø§Ù„ÙŠØ§Ù‹
        desc: desc,
        date: date,
        currency: currentCurrency.code,
        status: status,
        dueDate: dueDate,
        isInstallment: totalAmount > amount
    };

    try {
        // 1. Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
        executeRun(`INSERT INTO transactions (id, type, amount, currentAmount, paidAmount, desc, date, currency, status, dueDate) 
                    VALUES (:id, 'deb', :amount, :currentAmount, :paidAmount, :desc, :date, :currency, :status, :dueDate);`, {
                        ':id': newDebt.id,
                        ':amount': newDebt.amount,
                        ':currentAmount': newDebt.currentAmount,
                        ':paidAmount': newDebt.paidAmount,
                        ':desc': newDebt.desc,
                        ':date': newDebt.date,
                        ':currency': newDebt.currency,
                        ':status': newDebt.status,
                        ':dueDate': newDebt.dueDate
                    });

        // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¯ÙÙˆØ¹Ø§Ù‹
        if (isPaid) {
            const oldBalance = currentBalance;
            const newBalance = oldBalance - amount;
            executeRun("UPDATE balance SET amount = :amount WHERE id = 1;", { ':amount': newBalance });
            executeRun(`INSERT INTO balance_changes (id, type, amount, desc, date, currency, newBalance) 
                        VALUES (:id, 'debt_payment', :amount, :desc, :date, :currency, :newBalance);`, {
                            ':id': generateUniqueID(),
                            ':amount': amount,
                            ':desc': `Ø¯ÙØ¹ Ø§Ù„ØªØ²Ø§Ù…: ${type} - ${desc}`,
                            ':date': date,
                            ':currency': currentCurrency.code,
                            ':newBalance': newBalance
                        });
            currentBalance = newBalance;
        }

        await loadAllData();
        updateBalanceDisplay();
        updateStats();
        clearInputs('dAmount', 'dType', 'dDesc', 'dDate');
        document.getElementById('dStatus').value = '';
        toastMsg(`ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… ${isPaid ? 'ÙˆØ¯ÙØ¹Ù‡ ÙˆØ®ØµÙ…Ù‡ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯.' : 'ÙƒØ§Ù„ØªØ²Ø§Ù… Ù…Ø³ØªØ­Ù‚.'}`);
    } catch (error) {
        console.error("Error saving debt to SQL:", error);
        toastMsg("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù….");
    }
}

function updateDebtFields(type) {
    const container = document.getElementById('dDynamicFields');
    let html = '';
    if (type === 'Ù‚Ø±Ø¶' || type === 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ' || type === 'Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø© Ø£Ø®Ø±Ù‰') {
        html += '<input id="dTotalAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø§Ù„ØªØ²Ø§Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">';
        html += '<div class="datetime-container"><input id="dDueDate" type="datetime-local" placeholder="ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"><span class="calendar-icon"><i class="far fa-calendar-alt"></i></span></div>';
    }
    container.innerHTML = html;
}

// ------------------------------------
// ÙˆØ¸ÙŠÙØ© Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© (Delete)
// ------------------------------------
async function deleteTransaction(id, type, isRigDeb, paidAmount) {
    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.")) return;

    let balanceImpact = 0;
    const item = getItemById(id, type);
    if (!item) return;

    // 1. Ø­Ø³Ø§Ø¨ ØªØ£Ø«ÙŠØ± Ø§Ù„Ø±ØµÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù
    if (type === 'exp') {
        balanceImpact = item.amount; // ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø®ØµÙˆÙ… Ø³Ø§Ø¨Ù‚Ø§Ù‹
    } else if (isRigDeb && paidAmount > 0) {
        balanceImpact = (type === 'rig') ? -paidAmount : paidAmount; 
    }

    try {
        // 2. Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ù…Ù† Ø¬Ø¯ÙˆÙ„ transactions
        executeRun("DELETE FROM transactions WHERE id = :id;", { ':id': id });

        // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯
        if (balanceImpact !== 0) {
            const oldBalance = currentBalance;
            const newBalance = oldBalance + balanceImpact;
            
            executeRun("UPDATE balance SET amount = :amount WHERE id = 1;", { ':amount': newBalance });
            executeRun(`INSERT INTO balance_changes (id, type, amount, desc, date, currency, newBalance) 
                        VALUES (:id, :type, :amount, :desc, :date, :currency, :newBalance);`, {
                            ':id': generateUniqueID(),
                            ':type': `delete_${type}`,
                            ':amount': Math.abs(balanceImpact),
                            ':desc': `Ø­Ø°Ù Ù…Ø¹Ø§Ù…Ù„Ø© ${type === 'exp' ? 'Ù…ØµØ±ÙˆÙ' : (type === 'rig' ? 'Ø­Ù‚' : 'Ø§Ù„ØªØ²Ø§Ù…')}`,
                            ':date': getCurrentTimestamp(),
                            ':currency': currentCurrency.code,
                            ':newBalance': newBalance
                        });
            currentBalance = newBalance;
        }

        await loadAllData(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù
        updateBalanceDisplay();
        updateStats();
        renderLog(); 
        closeLayer('detail');
        toastMsg("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­.");
    } catch (error) {
        console.error("Error deleting transaction from SQL:", error);
        toastMsg("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.");
    }
}


// ------------------------------------
// ÙˆØ¸ÙŠÙØ© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© (Update)
// ------------------------------------
async function updateTransaction() {
    if (!editMode) return;
    const { id, type } = editMode;
    let item = getItemById(id, type);
    if (!item) return toastMsg("Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.");

    let oldAmount = type === 'exp' ? item.amount : (item.paidAmount || 0); // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ Ø£Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯ Ø³Ø§Ø¨Ù‚Ø§Ù‹
    let newAmount = 0; // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ Ø³ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¢Ù†
    let balanceChangeNeeded = false;
    let newBalanceImpact = 0;
    let updateParams = { ':id': id };
    let updateQuery = "UPDATE transactions SET ";

    if (type === 'exp') {
        newAmount = parseFloat(document.getElementById('eEditAmount').value);
        if (isNaN(newAmount) || newAmount <= 0) return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­.");
        
        updateQuery += "amount = :amount, desc = :desc, date = :date, img = :img";
        updateParams[':amount'] = newAmount;
        updateParams[':desc'] = document.getElementById('eEditDesc').value.trim();
        updateParams[':date'] = document.getElementById('eEditDate').value;
        updateParams[':img'] = currentImageBase64;
        
        if (newAmount !== oldAmount) {
            balanceChangeNeeded = true;
            newBalanceImpact = oldAmount - newAmount; 
        }
    } else { // rig or deb
        const isRig = type === 'rig';
        const newTotalAmount = parseFloat(document.getElementById('rdEditAmount').value);
        const newStatus = document.getElementById('rdEditStatus').value;
        const newCurrentAmount = (type === 'deb' && document.getElementById('rdEditCurrentAmount')) ? 
            parseFloat(document.getElementById('rdEditCurrentAmount').value) : newTotalAmount;
        
        if (isNaN(newTotalAmount) || newTotalAmount <= 0) return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ÙƒÙ„ÙŠ ØµØ­ÙŠØ­.");
        if (type === 'deb' && (isNaN(newCurrentAmount) || newCurrentAmount <= 0)) return toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ù‚Ø³Ø· ØµØ­ÙŠØ­Ø©.");

        const wasPaidInFull = (isRig && item.status === 'ÙƒØ§Ù…Ù„') || (!isRig && item.status === 'Ù…Ø¯ÙÙˆØ¹');
        const isNowPaidInFull = (isRig && newStatus === 'ÙƒØ§Ù…Ù„') || (!isRig && newStatus === 'Ù…Ø¯ÙÙˆØ¹');
        
        newAmount = isNowPaidInFull ? newCurrentAmount : 0;
        
        // Ø­Ø³Ø§Ø¨ ØªØ£Ø«ÙŠØ± Ø§Ù„Ø±ØµÙŠØ¯
        if (wasPaidInFull !== isNowPaidInFull) {
            balanceChangeNeeded = true;
            newBalanceImpact = isNowPaidInFull ? ((isRig ? 1 : -1) * newCurrentAmount) : ((isRig ? -1 : 1) * oldAmount);
        } else if (isNowPaidInFull && newAmount !== oldAmount) {
             balanceChangeNeeded = true;
             newBalanceImpact = ((isRig ? -1 : 1) * oldAmount) + ((isRig ? 1 : -1) * newCurrentAmount);
        }

        updateQuery += "amount = :amount, currentAmount = :currentAmount, paidAmount = :paidAmount, desc = :desc, date = :date, status = :status, person = :person, dueDate = :dueDate";
        updateParams[':amount'] = newTotalAmount;
        updateParams[':currentAmount'] = newCurrentAmount;
        updateParams[':paidAmount'] = isNowPaidInFull ? newCurrentAmount : 0;
        updateParams[':desc'] = document.getElementById('rdEditDesc').value.trim();
        updateParams[':date'] = document.getElementById('rdEditDate').value;
        updateParams[':status'] = newStatus;
        updateParams[':person'] = document.getElementById('rdEditPerson')?.value.trim() || null;
        updateParams[':dueDate'] = document.getElementById('rdEditDueDate')?.value || null;
    }
    
    try {
        // 1. ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ transactions
        executeRun(updateQuery + " WHERE id = :id;", updateParams);

        if (balanceChangeNeeded) {
            const oldBalance = currentBalance;
            const newBalance = oldBalance + newBalanceImpact;
            
            // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯
            executeRun("UPDATE balance SET amount = :amount WHERE id = 1;", { ':amount': newBalance });
            executeRun(`INSERT INTO balance_changes (id, type, amount, desc, date, currency, newBalance) 
                        VALUES (:id_change, :type_change, :amount_change, :desc_change, :date_change, :currency_change, :newBalance_change);`, {
                            ':id_change': generateUniqueID(),
                            ':type_change': `edit_${type}`,
                            ':amount_change': Math.abs(newBalanceImpact),
                            ':desc_change': `ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ø§Ù…Ù„Ø© ${type === 'exp' ? 'Ù…ØµØ±ÙˆÙ' : (type === 'rig' ? 'Ø­Ù‚' : 'Ø§Ù„ØªØ²Ø§Ù…')}`,
                            ':date_change': getCurrentTimestamp(),
                            ':currency_change': currentCurrency.code,
                            ':newBalance_change': newBalance
                        });
            currentBalance = newBalance;
        }
        
        await loadAllData(); 
        updateBalanceDisplay();
        updateStats();
        renderLog();
        closeLayer('edit');
        toastMsg("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.");
    } catch (error) {
        console.error("Error updating transaction in SQL:", error);
        toastMsg("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª.");
    }
}


// ------------------------------------
// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¹Ø±Ø¶ (Log/Detail/Edit)
// ------------------------------------

function getItemById(id, type) {
    // Ù†Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø®Ø²Ù†
    return transactionCache[type].find(item => item.id === id);
}

function openLog(type) {
    currentLog = type;
    document.getElementById('search').value = '';
    renderLog();
    openLayer('log');
}

function renderLog() {
    const container = document.getElementById('logContent');
    const searchTerm = document.getElementById('search').value.toLowerCase();
    
    let data = transactionCache[currentLog] || [];
    
    // Ø§Ù„ØªØµÙÙŠØ©
    const filteredData = data.filter(item => {
        if (!searchTerm) return true;
        return (item.desc && item.desc.toLowerCase().includes(searchTerm)) || 
               (item.type && item.type.toLowerCase().includes(searchTerm));
    });

    if (filteredData.length === 0) {
        container.innerHTML = `<p style="text-align: center; color: #999; padding-top: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©.</p>`;
        return;
    }

    let html = '';
    filteredData.forEach(item => {
        const amountToDisplay = item.currentAmount || item.amount;
        const amountDisplay = formatCurrency(amountToDisplay);
        let title = item.type || (currentLog === 'exp' ? 'Ù…ØµØ±ÙˆÙ' : 'Ù…Ø¹Ø§Ù…Ù„Ø©');
        let icon = '';
        let color = '';
        let secondaryText = '';
        
        const itemAmountPlain = formatCurrencyPlain(item.amount);
        const itemPaidPlain = formatCurrencyPlain(item.paidAmount || 0);

        if (currentLog === 'exp') {
            color = 'var(--danger)';
            icon = 'fas fa-money-bill-wave';
            secondaryText = `Ù…Ù„Ø§Ø­Ø¸Ø©: ${item.desc || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}`;
        } else if (currentLog === 'rig') {
            color = item.status === 'ÙƒØ§Ù…Ù„' ? 'var(--success)' : 'var(--warning)';
            icon = 'fas fa-handshake';
            const remaining = item.amount - (item.paidAmount || 0);
            secondaryText = `Ø§Ù„Ø­Ø§Ù„Ø©: ${item.status} | Ø§Ù„Ù…Ø³ØªØ­Ù‚: ${formatCurrencyPlain(remaining)} ${getCurrencySymbol()}`;
        } else if (currentLog === 'deb') {
            color = item.status === 'Ù…Ø¯ÙÙˆØ¹' ? 'var(--success)' : 'var(--warning)';
            icon = 'fas fa-file-invoice';
            secondaryText = `Ø§Ù„Ø­Ø§Ù„Ø©: ${item.status} | Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ÙƒÙ„ÙŠØ©: ${itemAmountPlain} ${getCurrencySymbol()}`;
        }

        html += `
            <div class="list-item" onclick="openDetailModal('${item.id}', '${currentLog}')" style="border-right-color: ${color};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: bold; font-size: 1.1em; color: ${color};">
                        <i class="${icon}" style="margin-left: 5px;"></i> ${title}
                    </span>
                    <span style="font-weight: bold; color: ${color};">${amountDisplay}</span>
                </div>
                <div class="details">
                    <span>${new Date(item.date).toLocaleDateString('ar-SA')} - ${new Date(item.date).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}</span>
                    <span style="color: #999; font-size: 0.8em;">${secondaryText}</span>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

function renderBalanceLog() {
    const container = document.getElementById('balanceLogContent');
    const log = transactionCache.bal.changes || []; 
    
    if (log.length === 0) {
        container.innerHTML = `<p style="text-align: center; color: #999; padding-top: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ø±ØµÙŠØ¯ Ø³Ø§Ø¨Ù‚Ø©.</p>`;
        return;
    }

    let html = '';
    log.forEach(item => {
        let color = 'var(--s)';
        let sign = '';
        let icon = 'fas fa-circle-info';
        
        if (item.type === 'deposit' || item.type === 'right_collection') {
            color = 'var(--success)';
            icon = 'fas fa-plus';
            sign = '+';
        } else if (item.type === 'withdraw' || item.type === 'expense' || item.type === 'debt_payment') {
            color = 'var(--danger)';
            icon = 'fas fa-minus';
            sign = '-';
        }

        const amountDisplay = formatCurrency(item.amount);
        const newBalanceDisplay = formatCurrency(item.newBalance);

        html += `
            <div class="list-item" style="border-right-color: ${color};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: bold; font-size: 1.1em; color: var(--text-dark);">
                        <i class="${icon}" style="margin-left: 5px; color: ${color};"></i> ${item.desc}
                    </span>
                    <span style="font-weight: bold; color: ${color};">${sign}${amountDisplay.replace(getCurrencySymbol(), '').trim()} ${getCurrencySymbol()}</span>
                </div>
                <div class="details">
                    <span>${new Date(item.date).toLocaleDateString('ar-SA')} ${new Date(item.date).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}</span>
                    <span style="color: var(--p); font-weight: bold;">Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${newBalanceDisplay}</span>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
    openLayer('balanceLog');
}

function openDetailModal(id, type) {
    const item = getItemById(id, type);
    if (!item) return;

    const container = document.getElementById('detailContent');
    let html = `<div class="card" style="border-top-color: var(--p); margin-top: 0;">`;
    
    const amount = item.currentAmount || item.amount;
    const isRigDeb = (type === 'rig' || type === 'deb');
    const color = (type === 'exp' || type === 'deb') ? 'var(--danger)' : 'var(--success)';
    const statusColor = item.status === 'Ù…Ø¯ÙÙˆØ¹' || item.status === 'ÙƒØ§Ù…Ù„' ? 'var(--success)' : 'var(--danger)';
    
    const formattedAmount = formatCurrency(amount);
    const formattedTotalAmount = item.amount ? formatCurrency(item.amount) : '';
    const formattedPaidAmount = formatCurrency(item.paidAmount || 0);

    html += `<h3 style="color: var(--p); text-align: center; margin-bottom: 20px;">${item.type}</h3>`;
    html += `<p style="font-size: 1.5em; font-weight: bold; text-align: center; color: ${color};">
                Ø§Ù„Ù…Ø¨Ù„Øº: ${formattedAmount}
            </p>`;

    html += `<p><strong>Ø§Ù„ÙˆØµÙ/Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ${item.desc || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>`;
    html += `<p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date(item.date).toLocaleString('ar-SA')}</p>`;
    
    if (isRigDeb) {
        html += `<p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span style="font-weight: bold; color: ${statusColor};">${item.status}</span></p>`;
        if (item.dueDate) {
            html += `<p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚:</strong> ${new Date(item.dueDate).toLocaleDateString('ar-SA')}</p>`;
        }
        if (item.person) {
            html += `<p><strong>Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±:</strong> ${item.person}</p>`;
        }
        if (item.currentAmount) {
            html += `<p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…/Ø§Ù„Ø­Ù‚:</strong> ${formattedTotalAmount}</p>`;
            html += `<p><strong>Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø·/Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</strong> ${formatCurrency(item.currentAmount)}</p>`;
        }
        html += `<p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹/Ø§Ù„Ù…Ø­ØµÙ„:</strong> ${formattedPaidAmount}</p>`;
    }

    if (item.img) {
        html += `<h4 style="margin-top: 20px; color: var(--p);">ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©/Ø§Ù„Ù…Ø³ØªÙ†Ø¯:</h4>`;
        html += `<a href="${item.img}" target="_blank"><img src="${item.img}" style="width: 100%; border-radius: 10px; margin-top: 10px; border: 1px solid var(--border-color);"></a>`;
    }

    html += `</div>`;
    
    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
    html += `<div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="action" onclick="openEditModal('${item.id}', '${type}')" style="flex: 1; background: var(--s);">
            <i class="fas fa-edit" style="margin-left: 5px;"></i> ØªØ¹Ø¯ÙŠÙ„
        </button>
        <button class="action" onclick="deleteTransaction('${item.id}', '${type}', ${isRigDeb}, ${item.paidAmount || 0})" style="flex: 1; background: var(--danger);">
            <i class="fas fa-trash-alt" style="margin-left: 5px;"></i> Ø­Ø°Ù
        </button>
    </div>`;

    if (isRigDeb && item.status !== 'ÙƒØ§Ù…Ù„' && item.status !== 'Ù…Ø¯ÙÙˆØ¹') {
         const btnText = type === 'rig' ? 'ØªØ­ØµÙŠÙ„ Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©' : 'Ø¯ÙØ¹ Ù‚Ø³Ø· Ø¬Ø¯ÙŠØ¯';
         const btnColor = type === 'rig' ? 'var(--success)' : 'var(--danger)';
         html += `<button class="action" onclick="openBalanceActionModal('${type === 'rig' ? 'collect' : 'pay_installment'}', '${item.id}')" style="margin-top: 10px; background: ${btnColor};">
                     <i class="fas fa-money-bill-transfer" style="margin-left: 5px;"></i> ${btnText}
                  </button>`;
    }

    container.innerHTML = html;
    openLayer('detail');
}

function populateEditForm(item, type) {
    if (type === 'exp') {
        const typeSelect = document.getElementById('eEditType');
        typeSelect.innerHTML = EXP_TYPES.map(t => `<option value="${t}" ${item.type === t ? 'selected' : ''}>${t}</option>`).join('');
        document.getElementById('eEditAmount').value = item.amount;
        document.getElementById('eEditDesc').value = item.desc || '';
        document.getElementById('eEditDate').value = item.date.slice(0, 16);
        
        const imgInfo = document.getElementById('eEditImgInfo');
        const imgRemoveBtn = document.getElementById('eEditImgRemoveBtn');
        if (item.img) {
            imgInfo.textContent = 'ØµÙˆØ±Ø© Ù…Ø±ÙÙ‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.';
            imgRemoveBtn.style.display = 'block';
            currentImageBase64 = item.img;
        } else {
            imgInfo.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù…Ø±ÙÙ‚Ø©.';
            imgRemoveBtn.style.display = 'none';
        }
        document.getElementById('eEditImgNew').value = ''; 
    } else {
        const types = type === 'rig' ? RIG_TYPES : DEB_TYPES;
        const typeSelect = document.getElementById('rdEditType');
        typeSelect.innerHTML = types.map(t => `<option value="${t}" ${item.type === t ? 'selected' : ''}>${t}</option>`).join('');
        
        const statusOptions = type === 'rig' ? 
            [{v: 'ÙƒØ§Ù…Ù„', n: 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„'}, {v: 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹', n: 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ Ø¨Ø¹Ø¯'}] : 
            [{v: 'Ù…Ø¯ÙÙˆØ¹', n: 'Ù…Ø¯ÙÙˆØ¹'}, {v: 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹', n: 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹'}];
        const statusSelect = document.getElementById('rdEditStatus');
        statusSelect.innerHTML = statusOptions.map(s => `<option value="${s.v}" ${item.status === s.v ? 'selected' : ''}>${s.n}</option>`).join('');
        
        document.getElementById('rdEditAmount').value = item.amount;
        document.getElementById('rdEditDesc').value = item.desc || '';
        document.getElementById('rdEditDate').value = item.date.slice(0, 16);
        
        const container = document.getElementById('rdEditDynamicFields');
        let html = '';
        if (item.person) html += `<input id="rdEditPerson" placeholder="ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†/Ø§Ù„Ø¬Ù‡Ø©" value="${item.person}">`;
        if (item.dueDate) html += `<div class="datetime-container"><input id="rdEditDueDate" type="datetime-local" placeholder="ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" value="${item.dueDate.slice(0, 16)}"><span class="calendar-icon"><i class="far fa-calendar-alt"></i></span></div>`;
        if (item.currentAmount && type === 'deb') html += `<input id="rdEditCurrentAmount" type="text" placeholder="ğŸ’µ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal" value="${item.currentAmount}">`;
        container.innerHTML = html;
        
        document.getElementById('rdEditPaidInfo').textContent = `ØªÙ… Ø¯ÙØ¹/ØªØ­ØµÙŠÙ„: ${formatCurrency(item.paidAmount || 0)}`;
    }
}


// ------------------------------------
// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØµÙˆØ± (Ù„Ù… ØªØªØºÙŠØ±)
// ------------------------------------

function showImageSourceModal() { openLayer('imageSource'); }
function openCameraInput() { document.getElementById('eImgCamera').click(); closeLayer('imageSource'); }
function openGalleryInput() { document.getElementById('eImgGallery').click(); closeLayer('imageSource'); }

function updateFileName(input, nameDisplayId) {
    const file = input.files[0];
    const displayElement = document.getElementById(nameDisplayId);
    if (file) {
        displayElement.textContent = `ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: ${file.name}`;
        loadDataURLFromLocalFile(file);
    } else {
        displayElement.textContent = '';
        currentImageBase64 = null;
    }
}

function updateEditFileName(input, nameDisplayId) {
     const file = input.files[0];
    const displayElement = document.getElementById(nameDisplayId);
    const removeBtn = document.getElementById('eEditImgRemoveBtn');
    
    if (file) {
        displayElement.textContent = `ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯: ${file.name}`;
        removeBtn.style.display = 'block';
        loadDataURLFromLocalFile(file);
    } else {
        displayElement.textContent = 'ØµÙˆØ±Ø© Ù…Ø±ÙÙ‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.'; 
    }
}

function removeEditImage(nameDisplayId) {
    currentImageBase64 = null;
    document.getElementById(nameDisplayId).textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù…Ø±ÙÙ‚Ø©.';
    document.getElementById('eEditImgNew').value = ''; 
    document.getElementById('eEditImgRemoveBtn').style.display = 'none';
}

function loadDataURLFromLocalFile(file) {
    const reader = new FileReader();
    reader.onload = function (event) {
        currentImageBase64 = event.target.result;
    };
    reader.onerror = function (error) {
        console.error("Error reading file:", error);
        toastMsg("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„ØµÙˆØ±Ø©.");
        currentImageBase64 = null;
    };
    reader.readAsDataURL(file);
}

// ------------------------------------
// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø§Ù„Ø¹Ù…Ù„Ø§ØªØŒ Ø§Ø³ØªÙŠØ±Ø§Ø¯ØŒ ØªØµØ¯ÙŠØ±)
// ------------------------------------

function openCurrencyModal() {
    renderCurrencyList();
    closeLayer('sidebar');
    openLayer('currency');
}

function renderCurrencyList() {
    const container = document.getElementById('currencyList');
    const searchTerm = document.getElementById('currencySearch').value.toLowerCase();
    
    const filteredCurrencies = ARABIC_CURRENCIES.filter(c => 
        c.name.toLowerCase().includes(searchTerm) || c.code.toLowerCase().includes(searchTerm)
    );

    let html = '<div style="margin-top: 10px;">';
    filteredCurrencies.forEach(c => {
        const isActive = c.code === currentCurrency.code;
        html += `
            <div class="list-item" onclick="setCurrency('${c.code}')" style="border-right: 5px solid ${isActive ? 'var(--p)' : 'var(--border-color)'};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: bold; font-size: 1.1em; color: var(--text-dark);">
                        ${c.name} (${c.symbol})
                    </span>
                    ${isActive ? '<i class="fas fa-check-circle" style="color: var(--success);"></i>' : ''}
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function setCurrency(code) {
    currentCurrency = ARABIC_CURRENCIES.find(c => c.code === code);
    localStorage.setItem('currencyCode', code);
    updateBalanceDisplay();
    updateStats(); 
    document.getElementById('currentCurrencyDisplay').textContent = `Ø§Ù„Ø¹Ù…Ù„Ø©: ${currentCurrency.name} (${currentCurrency.symbol})`;
    closeLayer('currency');
    toastMsg(`ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù…Ù„Ø© Ø¥Ù„Ù‰ ${currentCurrency.name} (${currentCurrency.symbol})`);
}

function exportData() {
    if (!SQL_DB) {
        toastMsg("Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ØªØµØ¯ÙŠØ±.");
        return;
    }
    const data = SQL_DB.export();
    const buffer = data.buffer;
    const blob = new Blob([buffer], { type: 'application/x-sqlite3' });
    const url = URL.createObjectURL(blob);
    
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", url);
    downloadAnchorNode.setAttribute("download", `budget_backup_${new Date().toISOString().slice(0, 10)}.sqlite`);
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
    URL.revokeObjectURL(url);
    toastMsg("ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ ÙƒÙ…Ù„Ù SQLite.");
}

function importData(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„ÙØŸ Ø³ÙŠØ¤Ø¯ÙŠ Ù‡Ø°Ø§ Ø¥Ù„Ù‰ Ù…Ø³Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯.")) return;

    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const importedData = new Uint8Array(e.target.result);
            
            // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©
            await saveDatabaseFile(DB_FILENAME, importedData);
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© SQLite Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯
            SQL_DB.close();
            await initDB();
            
            toastMsg("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.");
            
        } catch (error) {
            console.error("Error importing SQLite file:", error);
            toastMsg("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯.");
        }
    };
    reader.readAsArrayBuffer(file);
    event.target.value = '';
}

function openAboutModal() {
    closeLayer('sidebar');
    openLayer('about');
}

function confirmResetData() {
    if (confirm("ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø§Ù…Ø§Ù‹ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ø³ÙŠØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø´ÙŠØ¡ ÙˆÙ„Ù† ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡.")) {
        if (confirm("ØªØ£ÙƒÙŠØ¯ Ø£Ø®ÙŠØ±: Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) {
            resetData();
        }
    }
}

async function resetData() {
    if (!SQL_DB) return;
    try {
        SQL_DB.exec("DROP TABLE IF EXISTS transactions;");
        SQL_DB.exec("DROP TABLE IF EXISTS balance;");
        SQL_DB.exec("DROP TABLE IF EXISTS balance_changes;");
        createTables(); // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙØ§Ø±ØºØ©
        
        // Ù…Ø³Ø­ Ù…Ù„Ù Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ù…Ù† IndexedDB
        const idb = await initIDBForSQL();
        const transaction = idb.transaction([IDB_STORE_NAME], "readwrite");
        const store = transaction.objectStore(IDB_STORE_NAME);
        store.delete(DB_FILENAME);

        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        currentBalance = 0;
        await loadAllData(); 
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        updateStats();
        updateBalanceDisplay();
        closeLayer('sidebar');
        toastMsg("ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.");

    } catch (error) {
        console.error("Error resetting data:", error);
        toastMsg("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
    }
}

// ------------------------------------
// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
// ------------------------------------
window.onload = () => {
    initDB(); // Ø§Ù„Ø¨Ø¯Ø¡ Ø¨ØªØ­Ù…ÙŠÙ„ SQLite
    loadDarkModePreference();
    const now = getCurrentTimestamp().slice(0, 16);
    document.getElementById('eDate').value = now;
    document.getElementById('rDate').value = now;
    document.getElementById('dDate').value = now;
    
    document.getElementById('rType').dispatchEvent(new Event('change'));
    document.getElementById('dType').dispatchEvent(new Event('change'));
};
</script>
</body>
</html>
