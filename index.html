<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ© | Smart Budget</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">

<style>
/* ---------------------------------------------------- */
/* Variables and Base Styling - LIGHT MODE (Default) */
/* ---------------------------------------------------- */
:root{
    --p: #0077b6; /* Primary Blue (Vibrant) */
    --s: #48cae4; /* Secondary Light Blue */
    --bg: #f7f9fc; /* Light Background */
    --danger: #ef476f; 
    --success: #2a9d8f;
    --warning: #fbc02d;
    --text-dark: #333;
    --text-light: #f7f9fc;
    --shadow-light: 0 4px 8px rgba(0, 0, 0, 0.08);
    --shadow-hover: 0 6px 15px rgba(0, 0, 0, 0.15);
    --card-bg: #fff;
    --input-bg: #fff;
    --border-color: #ddd;
    --tab-active-bg: #fff;
}

/* ---------------------------------------------------- */
/* Dark Mode Variables */
/* ---------------------------------------------------- */
body.dark-mode {
    --p: #90e0ef; /* Lighter Primary Blue for contrast */
    --s: #48cae4; 
    --bg: #1f1f1f; /* Dark Background */
    --danger: #ff8a80;
    --success: #66bb6a;
    --warning: #fbc02d;
    --text-dark: #e0e0e0; /* Light Text */
    --text-light: #1f1f1f;
    --shadow-light: 0 4px 10px rgba(0, 0, 0, 0.5);
    --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.8);
    --card-bg: #2d2d2d;
    --input-bg: #3c3c3c;
    --border-color: #555;
    --tab-active-bg: #2d2d2d;
}

/* ---------------------------------------------------- */
/* Global Reset and Base Styling */
/* ---------------------------------------------------- */
* {
    box-sizing: border-box;
}
body{
    margin:0;
    font-family: 'Tajawal', 'Arial', sans-serif;
    background: var(--bg);
    color: var(--text-dark);
    overflow-x: hidden;
    line-height: 1.6;
    transition: background 0.3s, color 0.3s;
}

/* Global Dark Mode Overrides for Specific Elements */
.card, .sidebar, .modal { background: var(--card-bg); }
.modal header { background: var(--card-bg); border-bottom: 1px solid var(--border-color); }

/* ---------------------------------------------------- */
/* Header & Navigation */
/* ---------------------------------------------------- */
header{
    background: var(--p);
    color: var(--text-light);
    padding: 15px;
    font-size: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-hover);
    position: sticky;
    top: 0;
    z-index: 10;
}
header .title { flex-grow: 1; text-align: center; font-weight: 800; }
header button {
    background: none; 
    border: none; 
    color: var(--text-light); 
    font-size: 20px; 
    cursor: pointer; 
    padding: 0 10px;
    transition: transform 0.2s;
}
header button:hover { transform: scale(1.1); }

.tabs{
    display:flex;
    background: var(--card-bg);
    border-bottom: 2px solid var(--border-color);
    box-shadow: var(--shadow-light);
    overflow-x: auto; 
    white-space: nowrap;
}
.tabs button{
    flex: 1 1 auto; 
    min-width: 0; 
    padding: 15px 10px;
    border:none;
    background: var(--card-bg);
    color: var(--text-dark);
    font-weight: 700;
    font-size: 14px;
    transition: all 0.3s;
    border-bottom: 3px solid transparent;
}
.tabs button.active{
    color: var(--p);
    border-bottom: 3px solid var(--p);
    background: color-mix(in srgb, var(--bg) 90%, var(--p)); 
}
body.dark-mode .tabs button.active {
    background: color-mix(in srgb, var(--bg) 85%, var(--p)); 
}

/* ---------------------------------------------------- */
/* General Layout & Cards */
/* ---------------------------------------------------- */
.section{ display:none; padding: 15px; }
.section.active{ display:block; }
.card{
    background:var(--card-bg);
    padding: 20px;
    border-radius: 15px;
    box-shadow: var(--shadow-light);
    margin-bottom: 15px;
    border-top: 5px solid var(--s); 
    transition: background 0.3s, border-color 0.3s;
}

/* ---------------------------------------------------- */
/* Overview Section Styling (New Dashboard) */
/* ---------------------------------------------------- */
#overview .balance-display {
    text-align: center;
    padding: 30px 20px;
    margin-bottom: 20px;
    border-radius: 15px;
    background: var(--card-bg);
    box-shadow: var(--shadow-hover);
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    align-items: center;
}
#overview .balance-display h2 {
    margin: 0 0 5px 0;
    font-size: 18px;
    color: #999;
}
#overview .balance-display p {
    font-size: 38px;
    font-weight: 800;
    margin: 5px 0 0 0;
    color: var(--p);
    display: flex;
    align-items: center;
}
#overview .balance-display button {
    background: none;
    border: none;
    color: var(--p);
    font-size: 24px;
    cursor: pointer;
    margin-right: 10px;
    transition: color 0.2s;
}
#overview .balance-display button:hover {
    color: var(--s);
}
#overview .balance-actions {
    display: flex;
    gap: 15px;
    margin-top: 10px;
}
#overview .balance-actions .action {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    color: var(--text-dark);
    border-radius: 10px;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-light);
    transition: all 0.2s;
    background: var(--input-bg);
}
#overview .balance-actions .action:hover {
    box-shadow: var(--shadow-hover);
    transform: translateY(-2px);
    border-color: var(--p);
}
#overview .balance-actions .action i {
    font-size: 24px;
    margin-bottom: 5px;
}
#overview .balance-actions .deposit i { color: var(--success); }
#overview .balance-actions .withdraw i { color: var(--danger); }

/* ---------------------------------------------------- */
/* Form Elements & Inputs */
/* ---------------------------------------------------- */
input, select, .datetime-container input[type="datetime-local"] {
    width: 100%;
    padding: 14px;
    margin: 8px 0;
    font-size: 16px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    box-sizing: border-box;
    background: var(--input-bg);
    color: var(--text-dark);
    transition: all 0.3s;
}
input:focus, select:focus, .datetime-container input[type="datetime-local"]:focus {
    border-color: var(--s);
    box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.2);
    outline: none;
}
body.dark-mode input:focus, body.dark-mode select:focus, body.dark-mode .datetime-container input[type="datetime-local"]:focus {
    box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.3);
}

.datetime-container { position: relative; width: 100%; margin: 8px 0; }
.datetime-container input[type="datetime-local"] { margin: 0; padding-left: 40px; }

.calendar-icon {
    position: absolute;
    top: 50%;
    left: 15px; 
    transform: translateY(-50%);
    font-size: 1.4em;
    z-index: 2;
    pointer-events: none; 
    color: var(--p); 
}

/* ---------------------------------------------------- */
/* Buttons & Actions */
/* ---------------------------------------------------- */
button.action{
    background: var(--p);
    color: var(--text-light);
    border: none;
    padding: 16px;
    width: 100%;
    border-radius: 10px;
    font-size: 18px;
    font-weight: bold;
    margin-top: 10px;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
    box-shadow: var(--shadow-light);
}
button.action:hover{
    background: color-mix(in srgb, var(--p) 85%, black); 
    transform: translateY(-2px);
}

button.secondary{
    background: var(--input-bg);
    color: var(--text-dark);
    padding: 12px;
    width: 100%;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    margin-top: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s;
}
button.secondary:hover {
    background: color-mix(in srgb, var(--input-bg) 80%, #999); 
}

/* ---------------------------------------------------- */
/* Utility & Custom Elements */
/* ---------------------------------------------------- */
.toast{
    position:fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: var(--text-light);
    padding: 12px 25px;
    border-radius: 30px;
    display:none;
    z-index: 100;
    font-size: 15px;
    box-shadow: var(--shadow-hover);
    white-space: nowrap;
}

.currency-symbol { color: var(--p); font-weight: bold; font-size: 1.1em; margin-right: 5px; }
.hidden-balance { font-size: 38px; font-weight: 800; letter-spacing: 5px; color: var(--p); }

/* ---------------------------------------------------- */
/* Modals and Sidebar Refinements */
/* ---------------------------------------------------- */
.modal{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background: var(--bg);
    display:none;
    flex-direction:column;
    z-index: 30;
    overflow-y: auto;
}
.modal header{
    display:flex;
    gap: 10px;
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    background: var(--card-bg);
    align-items: center;
    box-shadow: var(--shadow-light);
    position: sticky;
    top: 0;
    z-index: 35;
}
.modal header .title { flex-grow: 1; text-align: center; font-weight: 700; }
.modal header button {
    background: none; 
    border: none; 
    color: var(--text-dark); 
    font-size: 20px; 
    cursor: pointer; 
    padding: 0 10px;
}
.modal-content {
    flex-grow: 1;
    padding: 15px;
}

.sidebar {
    position: fixed;
    top: 0;
    right: 0; 
    width: 300px; 
    max-width: 85%;
    height: 100%;
    background: var(--card-bg);
    box-shadow: -4px 0 12px rgba(0, 0, 0, 0.2);
    transform: translateX(100%); 
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
    z-index: 25; 
    display: flex;
    flex-direction: column;
}
.sidebar.open { transform: translateX(0); }

/* Switch Style (Dark Mode) */
.switch-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    font-size: 17px;
    color: var(--text-dark);
}
.switch { position: relative; display: inline-block; width: 45px; height: 25px; }
.switch input {opacity: 0; width: 0; height: 0;}
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: var(--border-color); transition: .4s; border-radius: 25px;
}
.slider:before {
    position: absolute; content: ""; height: 19px; width: 19px; left: 3px; bottom: 3px;
    background-color: white; transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: var(--p); }
input:checked + .slider:before { transform: translateX(20px); }


/* Sidebar */
.sidebar-header {
    padding: 15px;
    background: var(--p);
    color: var(--text-light);
    font-size: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
}
.sidebar-content {
    flex-grow: 1;
    padding: 15px 0;
    overflow-y: auto;
}

.sidebar-menu-item {
    padding: 15px 20px;
    margin: 5px 0;
    display: flex;
    align-items: center;
    justify-content: space-between; 
    gap: 15px;
    font-size: 17px;
    color: var(--text-dark);
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
}

.sidebar-menu-item:hover {
    background: var(--s);
    color: var(--text-dark); 
}
.sidebar-menu-item i { font-size: 1.2em; }

.sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    z-index: 24;
}
.sidebar-overlay.open { display: block; }

/* Small Image Source Modal */
#imageSourceModal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80%;
    max-width: 350px;
    height: auto;
    background: var(--card-bg);
    border-radius: 15px;
    box-shadow: var(--shadow-hover);
    padding: 20px;
    z-index: 150;
    display: none; 
    flex-direction: column;
    align-items: center;
}
#imageSourceModal.open {
    display: flex;
}

#imageSourceModal h3 {
    margin-top: 0;
    color: var(--p);
    text-align: center;
}
#imageSourceModal button {
    margin: 10px 0;
    padding: 15px;
    font-size: 16px;
    border-radius: 10px;
    width: 100%;
}

/* Toast Animation */
.toast.show{
    display:block;
    animation: fadeInOut 2.5s ease-in-out forwards;
}

@keyframes fadeInOut {
    0% { opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { opacity: 0; }
}

/* List Item */
.list-item{
    background: var(--card-bg);
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    border-right: 5px solid var(--s); 
    color: var(--text-dark);
}
.list-item:hover {
    background: color-mix(in srgb, var(--card-bg) 95%, #999);
    box-shadow: var(--shadow-light);
}
.list-item .details {
    font-size: 0.9em; 
    color: #666; 
    text-align: right;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 5px;
}

/* ---------------------------------------------------- */
/* Responsive Fix for Tabs (Small Screens) */
/* ---------------------------------------------------- */
@media (max-width: 450px) {
    .tabs button {
        padding: 15px 5px; 
        font-size: 13px; 
    }
}
</style>
</head>

<body>

<header>
    <button onclick="openSidebar()"><i class="fas fa-bars"></i></button> 
    <span class="title" id="appTitle">Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</span>
    <button onclick="toggleLanguage()">
        <span id="languageToggleText" style="font-size: 14px; font-weight: 700;">English</span>
    </button>
</header>

<div class="tabs">
    <button class="active" onclick="openTab('overview')" id="tabOverview">
        <i class="fas fa-tachometer-alt" style="margin-left: 5px;"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©
    </button>
    <button onclick="openTab('expenses')" id="tabExpenses">
        <i class="fas fa-money-bill-wave" style="margin-left: 5px;"></i> Ù…ØµØ±ÙˆÙØ§Øª
    </button>
    <button onclick="openTab('rights')" id="tabRights">
        <i class="fas fa-handshake" style="margin-left: 5px;"></i> Ø­Ù‚ÙˆÙ‚
    </button>
    <button onclick="openTab('debts')" id="tabDebts">
        <i class="fas fa-file-invoice" style="margin-left: 5px;"></i> Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    </button>
</div>

<div id="overview" class="section active">
    <div class="balance-display">
        <h2 id="balanceTitle">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
        <p id="currentBalanceDisplay">
            <i class="fas fa-spinner fa-spin"></i>
        </p>
        <button onclick="toggleBalanceVisibility()" id="balanceVisibilityToggle" title="Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±ØµÙŠØ¯">
             <i class="fas fa-eye"></i>
        </button>
    </div>

    <div class="balance-actions">
        <button class="action deposit" onclick="openBalanceActionModal('deposit')" id="btnDeposit">
            <i class="fas fa-plus-circle"></i> Ø¥ÙŠØ¯Ø§Ø¹
        </button>
        <button class="action withdraw" onclick="openBalanceActionModal('withdraw')" id="btnWithdraw">
            <i class="fas fa-minus-circle"></i> Ø³Ø­Ø¨
        </button>
    </div>
    
    <button class="secondary" onclick="openBalanceLogModal()" style="margin-top: 15px;" id="btnBalanceLog">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯
    </button>
    <div class="card" style="margin-top: 20px; border-top: 5px solid var(--p);">
        <h3 style="color: var(--p); margin-top: 0;" id="summaryTitle"><i class="fas fa-calculator" style="margin-left: 5px;"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
        <p><span id="sExpLabel">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (ØªØ´Ù…Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª):</span> <b id="sExpTotal">0</b></p>
        <p><span id="sRigLabel">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©:</span> <b id="sRigTotal">0</b></p>
        <p><span id="sDebLabel">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©:</span> <b id="sDebTotal">0</b></p>
        <p><span id="sRigPaidLabel">Ø§Ù„Ù…Ø­ØµÙ„ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ‚:</span> <b id="sRigPaid">0</b></p>
        <p><span id="sDebPaidLabel">Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª:</span> <b id="sDebPaid">0</b></p>
        </div>
</div>

<div id="expenses" class="section">
    <div class="card">
    <p style="color: var(--danger); font-weight: bold; font-size: 0.9em; text-align: right;" id="expNote">* Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡Ø§ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙˆØ±Ø§Ù‹</p>
    <input id="eAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
    <select id="eType">
    <option value="" id="eTypePlaceholder">ğŸ›’ Ø§Ù„ÙØ¦Ø© (Ù†ÙÙ‚Ø§Øª Ù…ØªØºÙŠØ±Ø©)</option>
    <option>Ø·Ø¹Ø§Ù…</option><option>Ù…ÙˆØ§ØµÙ„Ø§Øª</option>
    <option>Ø±Ø¹Ø§ÙŠØ© Ø´Ø®ØµÙŠØ©</option><option>Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
    <option>ØµØ­Ø©</option><option>ØªØ±ÙÙŠÙ‡</option><option>ØªØ³ÙˆÙ‚</option>
    <option>ØªØ¹Ù„ÙŠÙ…</option><option>ØµÙŠØ§Ù†Ø© ÙˆØ¥ØµÙ„Ø§Ø­</option><option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="eDesc" placeholder="ğŸ“ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
    <div class="datetime-container">
        <input id="eDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    
    <button class="secondary" onclick="showImageSourceModal()">
        <i class="fas fa-camera" style="margin-left: 5px;"></i> Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    </button>
    <span id="eImgName" style="display: block; font-size: 0.8em; color: var(--success); text-align: right; margin-top: 5px;"></span>
    <input type="file" id="eImgCamera" accept="image/*" capture="camera" style="display: none;" onchange="updateFileName(this, 'eImgName')">
    <input type="file" id="eImgGallery" accept="image/*" style="display: none;" onchange="updateFileName(this, 'eImgName')">
    <button class="action" onclick="addExpense()" id="btnSaveExpense">
        <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ
    </button>
    <button class="secondary" onclick="openLog('exp')" id="btnExpenseLog">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
    </button>
    </div>
</div>

<div id="rights" class="section">
    <div class="card">
    <p style="color: var(--success); font-weight: bold; font-size: 0.9em; text-align: right;" id="rigNote">* Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„Ø© (Ø¯ÙØ¹ Ø§Ù„Ø¯ÙŠÙ†/Ø§Ù„Ø¢Ø¬Ù„) ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
    <select id="rType" onchange="updateRightFields(this.value)">
    <option value="" id="rTypePlaceholder">ğŸ¤ Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚</option>
    <option>Ø¯ÙŠÙ†</option>
    <option>Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„</option>
    <option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="rAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚ (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ)" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
    <div id="rDynamicFields"></div>
    <input id="rDesc" placeholder="ğŸ‘¤ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ù„Ù…Ø¯ÙŠÙ†/Ø§Ù„Ø¬Ù‡Ø©)">
    <div class="datetime-container">
        <input id="rDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    <select id="rStatus">
    <option value="" id="rStatusPlaceholder">âœ… Ø§Ù„Ø­Ø§Ù„Ø©</option>
    <option value="ÙƒØ§Ù…Ù„" id="rStatusPaid">Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</option>
    <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹" id="rStatusUnpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ Ø¨Ø¹Ø¯</option>
    </select>
    <button class="action" onclick="addRight()" id="btnSaveRight">
        <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ø­Ù‚
    </button>
    <button class="secondary" onclick="openLog('rig')" id="btnRightLog">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ‚
    </button>
    </div>
</div>

<div id="debts" class="section">
    <div class="card">
    <p style="color: var(--danger); font-weight: bold; font-size: 0.9em; text-align: right;" id="debNote">* Ø¯ÙØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
    <select id="dType" onchange="updateDebtFields(this.value)">
    <option value="" id="dTypePlaceholder">ğŸ§¾ Ù†ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</option>
    <option>Ø¥ÙŠØ¬Ø§Ø±</option>
    <option>ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
    <option>Ù…Ø§Ø¡</option>
    <option>Ø¥Ù†ØªØ±Ù†Øª</option>
    <option>Ù‚Ø±Ø¶</option> <option>Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ</option> <option>Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø© Ø£Ø®Ø±Ù‰</option>
    <option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="dAmount" type="text" placeholder="ğŸ’µ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©/Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">

    <div id="dDynamicFields"></div>
    <input id="dDesc" placeholder="ğŸ¢ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ù„Ø¯Ø§Ø¦Ù†/Ø§Ù„Ø¬Ù‡Ø©)">
    <div class="datetime-container">
        <input id="dDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    <select id="dStatus">
    <option value="" id="dStatusPlaceholder">âœ… Ø§Ù„Ø­Ø§Ù„Ø©</option>
    <option value="Ù…Ø¯ÙÙˆØ¹" id="dStatusPaid">Ù…Ø¯ÙÙˆØ¹</option>
    <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹" id="dStatusUnpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
    </select>
    <button class="action" onclick="addDebt()" id="btnSaveDebt">
        <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…
    </button>
    <button class="secondary" onclick="openLog('deb')" id="btnDebtLog">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    </button>
    </div>
</div>

<div class="modal" id="logModal">
    <header>
        <input id="search" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„..." oninput="renderLog()">
        <button onclick="closeLayer('log')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content" id="logContent"></div>
</div>

<div class="modal" id="detailModal">
    <header>
        <span class="title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</span>
        <button onclick="closeLayer('detail')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content detail" id="detailContent"></div>
</div>

<div class="modal" id="editModal">
    <header>
        <span class="title" id="editModalTitle">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</span>
        <button onclick="closeLayer('edit')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <div id="editFormContainer">
            <div id="editExpForm" style="display:none;">
                <input id="eEditAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
                <select id="eEditType"></select> <input id="eEditDesc" placeholder="ğŸ“ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
                <div class="datetime-container">
                    <input id="eEditDate" type="datetime-local">
                    <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
                </div>
                
                <p id="eEditImgInfo" style="font-size: 0.9em; color: var(--p); text-align: right; margin-top: 10px;"></p>
                <button class="secondary" onclick="document.getElementById('eEditImgNew').click()">
                    <i class="fas fa-camera" style="margin-left: 5px;"></i> Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                </button>
                <input type="file" id="eEditImgNew" accept="image/*" style="display: none;" onchange="updateEditFileName(this, 'eEditImgInfo')">
                <button class="secondary" id="eEditImgRemoveBtn" style="background: var(--danger); color: var(--text-light); border: none; margin-top: 5px; display: none;" onclick="removeEditImage('eEditImgInfo')">
                     <i class="fas fa-trash-alt" style="margin-left: 5px;"></i> Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                </button>
            </div>

            <div id="editRigDebForm" style="display:none;">
                <select id="rdEditType"></select> <input id="rdEditAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
                <div id="rdEditDynamicFields"></div>
                <input id="rdEditDesc" placeholder="ğŸ“ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
                <div class="datetime-container">
                    <input id="rdEditDate" type="datetime-local">
                    <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
                </div>
                <select id="rdEditStatus"></select> <p id="rdEditPaidInfo" style="font-size: 0.9em; color: var(--success); text-align: right; margin-top: 10px; font-weight: bold;"></p>
            </div>

        </div>

        <button class="action" onclick="updateTransaction()">
            <i class="fas fa-check" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
        </button>
    </div>
</div>


<div class="modal" id="balanceActionModal">
    <header>
        <span class="title" id="actionModalTitle"></span>
        <button onclick="closeLayer('balanceAction')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <p style="text-align: center; font-size: 1.1em;">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="currentBalanceInAction" style="color: var(--p); font-weight: bold;"></span></p>
        <input id="bAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
        <input id="bDesc" placeholder="ğŸ“ ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Ù…Ø«Ù„: Ø±Ø§ØªØ¨ØŒ ØªØ­ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ)">
        <div class="datetime-container">
            <input id="bDate" type="datetime-local">
            <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
        </div>
        <button class="action" onclick="processBalanceAction()">
            <i class="fas fa-check" style="margin-left: 5px;"></i> ØªÙ†ÙÙŠØ°
        </button>
    </div>
</div>

<div class="modal" id="balanceLogModal">
    <header>
        <span class="title">Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯</span>
        <button onclick="closeLayer('balanceLog')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content" id="balanceLogContent">
        </div>
</div>

<div id="imageSourceModal">
    <h3 style="margin-bottom: 20px;">Ø§Ø®ØªÙŠØ§Ø± Ù…ØµØ¯Ø± Ø§Ù„ØµÙˆØ±Ø©</h3>
    <button class="action" onclick="openCameraInput()"><i class="fas fa-camera" style="margin-left: 10px;"></i> Ø§Ù„ØªÙ‚Ø§Ø· Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
    <button class="secondary" onclick="openGalleryInput()"><i class="fas fa-images" style="margin-left: 10px;"></i> Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ø¶</button>
    <button class="secondary" style="background: none; border: none; color: var(--danger); margin-top: 10px;" onclick="closeLayer('imageSource')">Ø¥Ù„ØºØ§Ø¡</button>
</div>
<div class="sidebar-overlay" id="imageSourceOverlay" style="z-index: 140; display: none;" onclick="closeLayer('imageSource')"></div>

<div class="toast" id="toast"></div>

<div class="sidebar-overlay" onclick="closeLayer('sidebar')"></div>

<div class="sidebar" id="appSidebar">
    <div class="sidebar-header" id="sidebarHeader">
        <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        <button onclick="closeLayer('sidebar')"><i class="fas fa-times"></i></button>
    </div>
    <div class="sidebar-content">
        <div class="card" style="margin: 0 15px 15px; border-top: 5px solid var(--s);">
             <p style="font-weight: bold; margin-top: 0; color: var(--p);" id="settingsTitle">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</p>
             
             <div class="switch-container">
                 <i class="fas fa-moon" style="margin-left: 10px;"></i> <span id="darkModeLabel">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span>
                 <label class="switch">
                     <input type="checkbox" id="darkModeToggle" onclick="toggleDarkMode()">
                     <span class="slider"></span>
                 </label>
             </div>

             <button class="secondary" onclick="openCurrencyModal()" style="display: flex; justify-content: space-between; align-items: center; border: none; background: var(--card-bg); margin-top: 15px;">
                 <span id="currentCurrencyDisplay" style="font-weight: bold;">
                    Ø§Ù„Ø¹Ù…Ù„Ø©: Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ (Ø±.Ø³) <span style="color: var(--p);"><i class="fas fa-exchange-alt"></i> <span id="changeCurrencyBtn">ØªØºÙŠÙŠØ±</span></span>
                 </span>
             </button>

             <button class="secondary" onclick="toggleLanguage()" style="display: flex; justify-content: center; align-items: center; border: none; background: var(--card-bg); margin-top: 5px; color: var(--p); font-weight: bold;">
                 <i class="fas fa-language" style="margin-left: 10px;"></i> <span id="languageToggleTextSidebar">English</span>
             </button>
        </div>
        
        <div class="sidebar-menu-item" onclick="exportData()" id="exportData">
            <i class="fas fa-file-export"></i> <span>ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</span>
        </div>
        
        <div class="sidebar-menu-item" onclick="document.getElementById('importFile').click()" id="importData">
            <i class="fas fa-file-import"></i> <span>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</span>
        </div>
        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
        
        <div class="sidebar-menu-item" onclick="openAboutModal()" id="aboutApp">
            <i class="fas fa-info-circle"></i> <span>Ø­ÙˆÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>
        </div>
        
        <div class="sidebar-menu-item" onclick="confirmResetData()" style="color: var(--danger);" id="resetData">
            <i class="fas fa-exclamation-triangle"></i> <span>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        </div>
    </div>
</div>

<div class="modal" id="aboutModal">
    <header>
        <h3 style="color: var(--p);" id="aboutModalTitle">Ø­ÙˆÙ„ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ©</h3>
        <button onclick="closeLayer('about')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <p>ØªØ·Ø¨ÙŠÙ‚ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© Ù‡Ùˆ Ø£Ø¯Ø§Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ ØªØªØ¨Ø¹:</p>
        <ul>
            <li><i class="fas fa-wallet" style="color: var(--s);"></i> **Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø©** Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.</li>
            <li><i class="fas fa-receipt" style="color: var(--s);"></i> **Ø§Ù„Ø­Ù‚ÙˆÙ‚** Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ù„Ùƒ (Ø¯ÙŠÙˆÙ†ØŒ Ø¨ÙŠØ¹ Ø¢Ø¬Ù„).</li>
            <li><i class="fas fa-clipboard-list" style="color: var(--s);"></i> **Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª** Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ø¹Ù„ÙŠÙƒ (ÙÙˆØ§ØªÙŠØ±ØŒ Ø£Ù‚Ø³Ø§Ø·ØŒ Ù‚Ø±ÙˆØ¶).</li>
        </ul>
        <p class="card" style="border-top: 3px solid var(--danger);"> 
            <strong>Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©:</strong> ÙŠØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ© IndexedDBØŒ ÙˆÙ„Ø§ ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ø£ÙŠ Ø®Ø§Ø¯Ù… Ø®Ø§Ø±Ø¬ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ. 
        </p>
        <p style="text-align: center; margin-top: 20px; color: #999; font-size: 0.9em;" id="appVersion">Ø§Ù„Ø¥ØµØ¯Ø§Ø± 3.2 (Ù…Ø¹ Ù…ÙŠØ²Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙÙˆØ±ÙŠ)</p>
    </div>
</div>

<div class="modal" id="currencyModal">
    <header>
        <h3 style="color: var(--p);" id="currencyModalTitle">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø©</h3>
        <button onclick="closeLayer('currency')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <input id="currencySearch" type="text" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„Ø© (Ø±ÙŠØ§Ù„ØŒ Ø¬Ù†ÙŠÙ‡ØŒ Ø¯ÙˆÙ„Ø§Ø±...)" oninput="renderCurrencyList()">
        <div id="currencyList"> 
        </div>
    </div>
</div>

<script>
// ===================================================
// 1. Ø¥Ø¹Ø¯Ø§Ø¯ IndexedDB ÙˆÙ…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Øª
// (ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Øª ÙˆÙ…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©)
// ===================================================
const IDB_NAME = "MySmartBudgetDB";
const IDB_VERSION = 4;
const STORE_NAMES = ["exp", "rig", "deb", "bal"];
let db = { exp: [], rig: [], deb: [], bal: { clientId: 1, amount: 0, changes: [] } };
let IDB_connection = null;

// Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
let currentLanguage = localStorage.getItem('language') || 'ar'; // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
let currentLog = "", editMode = null, balanceActionType = null; 
let currentBalance = 0; 
let balanceHidden = localStorage.getItem('balanceHidden') === 'true'; 
let currentImageBase64 = null; 

// ===================================================
// Ø§Ù„Ø®Ø·ÙˆØ© 1: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø© (Ø¹Ø±Ø¨ÙŠ - Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)
// ===================================================
const WORLD_CURRENCIES = [
    // --- Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
    { code: 'SDG', symbol: 'Ø¬.Ø³', name_ar: 'Ø¬Ù†ÙŠÙ‡ Ø³ÙˆØ¯Ø§Ù†ÙŠ', name_en: 'Sudanese Pound' },
    { code: 'SAR', symbol: 'Ø±.Ø³', name_ar: 'Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ', name_en: 'Saudi Riyal' },
    { code: 'EGP', symbol: 'Ø¬.Ù…', name_ar: 'Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ', name_en: 'Egyptian Pound' },
    { code: 'AED', symbol: 'Ø¯.Ø¥', name_ar: 'Ø¯Ø±Ù‡Ù… Ø¥Ù…Ø§Ø±Ø§ØªÙŠ', name_en: 'UAE Dirham' },
    { code: 'KWD', symbol: 'Ø¯.Ùƒ', name_ar: 'Ø¯ÙŠÙ†Ø§Ø± ÙƒÙˆÙŠØªÙŠ', name_en: 'Kuwaiti Dinar' },
    { code: 'QAR', symbol: 'Ø±.Ù‚', name_ar: 'Ø±ÙŠØ§Ù„ Ù‚Ø·Ø±ÙŠ', name_en: 'Qatari Riyal' },
    { code: 'BHD', symbol: 'Ø¯.Ø¨', name_ar: 'Ø¯ÙŠÙ†Ø§Ø± Ø¨Ø­Ø±ÙŠÙ†ÙŠ', name_en: 'Bahraini Dinar' },
    { code: 'OMR', symbol: 'Ø±.Ø¹.', name_ar: 'Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ', name_en: 'Omani Rial' },
    { code: 'JOD', symbol: 'Ø¯.Ø§', name_ar: 'Ø¯ÙŠÙ†Ø§Ø± Ø£Ø±Ø¯Ù†ÙŠ', name_en: 'Jordanian Dinar' },
    { code: 'LBP', symbol: 'Ù„.Ù„', name_ar: 'Ù„ÙŠØ±Ø© Ù„Ø¨Ù†Ø§Ù†ÙŠØ©', name_en: 'Lebanese Pound' },
    { code: 'SYP', symbol: 'Ù„.Ø³', name_ar: 'Ù„ÙŠØ±Ø© Ø³ÙˆØ±ÙŠØ©', name_en: 'Syrian Pound' },
    { code: 'IQD', symbol: 'Ø¹.Ø¯', name_ar: 'Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ', name_en: 'Iraqi Dinar' },
    { code: 'YER', symbol: 'Ø±.ÙŠ', name_ar: 'Ø±ÙŠØ§Ù„ ÙŠÙ…Ù†ÙŠ', name_en: 'Yemeni Rial' },
    { code: 'DZD', symbol: 'Ø¯.Ø¬', name_ar: 'Ø¯ÙŠÙ†Ø§Ø± Ø¬Ø²Ø§Ø¦Ø±ÙŠ', name_en: 'Algerian Dinar' },
    { code: 'MAD', symbol: 'Ø¯.Ù….', name_ar: 'Ø¯Ø±Ù‡Ù… Ù…ØºØ±Ø¨ÙŠ', name_en: 'Moroccan Dirham' },
    { code: 'TND', symbol: 'Ø¯.Øª', name_ar: 'Ø¯ÙŠÙ†Ø§Ø± ØªÙˆÙ†Ø³ÙŠ', name_en: 'Tunisian Dinar' },
    { code: 'LYD', symbol: 'Ù„.Ø¯', name_ar: 'Ø¯ÙŠÙ†Ø§Ø± Ù„ÙŠØ¨ÙŠ', name_en: 'Libyan Dinar' },
    { code: 'MRU', symbol: 'Ø£.Ù…', name_ar: 'Ø£ÙˆÙ‚ÙŠØ© Ù…ÙˆØ±ÙŠØªØ§Ù†ÙŠØ©', name_en: 'Mauritanian Ouguiya' },
    { code: 'SOS', symbol: 'S', name_ar: 'Ø´Ù„Ù† ØµÙˆÙ…Ø§Ù„ÙŠ', name_en: 'Somali Shilling' },
    { code: 'DJF', symbol: 'Fdj', name_ar: 'ÙØ±Ù†Ùƒ Ø¬ÙŠØ¨ÙˆØªÙŠ', name_en: 'Djiboutian Franc' },
    { code: 'KMF', symbol: 'CF', name_ar: 'ÙØ±Ù†Ùƒ Ù‚Ù…Ø±ÙŠ', name_en: 'Comorian Franc' },

    // --- Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---
    { code: 'USD', symbol: '$', name_ar: 'Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ', name_en: 'US Dollar' },
    { code: 'EUR', symbol: 'â‚¬', name_ar: 'ÙŠÙˆØ±Ùˆ', name_en: 'Euro' },
    { code: 'GBP', symbol: 'Â£', name_ar: 'Ø¬Ù†ÙŠÙ‡ Ø¥Ø³ØªØ±Ù„ÙŠÙ†ÙŠ', name_en: 'British Pound' },
    { code: 'JPY', symbol: 'Â¥', name_ar: 'ÙŠÙ† ÙŠØ§Ø¨Ø§Ù†ÙŠ', name_en: 'Japanese Yen' },
    { code: 'CNY', symbol: 'Â¥', name_ar: 'ÙŠÙˆØ§Ù† ØµÙŠÙ†ÙŠ', name_en: 'Chinese Yuan' },
    { code: 'RUB', symbol: 'â‚½', name_ar: 'Ø±ÙˆØ¨Ù„ Ø±ÙˆØ³ÙŠ', name_en: 'Russian Ruble' },
    { code: 'INR', symbol: 'â‚¹', name_ar: 'Ø±ÙˆØ¨ÙŠØ© Ù‡Ù†Ø¯ÙŠØ©', name_en: 'Indian Rupee' },
    { code: 'TRY', symbol: 'â‚º', name_ar: 'Ù„ÙŠØ±Ø© ØªØ±ÙƒÙŠØ©', name_en: 'Turkish Lira' },
    { code: 'CAD', symbol: 'C$', name_ar: 'Ø¯ÙˆÙ„Ø§Ø± ÙƒÙ†Ø¯ÙŠ', name_en: 'Canadian Dollar' },
    { code: 'AUD', symbol: 'A$', name_ar: 'Ø¯ÙˆÙ„Ø§Ø± Ø£Ø³ØªØ±Ø§Ù„ÙŠ', name_en: 'Australian Dollar' },
    { code: 'CHF', symbol: 'Fr', name_ar: 'ÙØ±Ù†Ùƒ Ø³ÙˆÙŠØ³Ø±ÙŠ', name_en: 'Swiss Franc' },
    { code: 'ZAR', symbol: 'R', name_ar: 'Ø±Ø§Ù†Ø¯ Ø¬Ù†ÙˆØ¨ Ø£ÙØ±ÙŠÙ‚ÙŠ', name_en: 'South African Rand' },
    { code: 'BRL', symbol: 'R$', name_ar: 'Ø±ÙŠØ§Ù„ Ø¨Ø±Ø§Ø²ÙŠÙ„ÙŠ', name_en: 'Brazilian Real' },
    { code: 'KRW', symbol: 'â‚©', name_ar: 'ÙˆÙˆÙ† ÙƒÙˆØ±ÙŠ Ø¬Ù†ÙˆØ¨ÙŠ', name_en: 'South Korean Won' },
    { code: 'MXN', symbol: '$', name_ar: 'Ø¨ÙŠØ²Ùˆ Ù…ÙƒØ³ÙŠÙƒÙŠ', name_en: 'Mexican Peso' },
    { code: 'IDR', symbol: 'Rp', name_ar: 'Ø±ÙˆØ¨ÙŠØ© Ø¥Ù†Ø¯ÙˆÙ†ÙŠØ³ÙŠØ©', name_en: 'Indonesian Rupiah' },
    { code: 'MYR', symbol: 'RM', name_ar: 'Ø±ÙŠÙ†ØºÙŠØª Ù…Ø§Ù„ÙŠØ²ÙŠ', name_en: 'Malaysian Ringgit' },
    { code: 'PHP', symbol: 'â‚±', name_ar: 'Ø¨ÙŠØ²Ùˆ ÙÙ„Ø¨ÙŠÙ†ÙŠ', name_en: 'Philippine Peso' },
    { code: 'THB', symbol: 'à¸¿', name_ar: 'Ø¨Ø§Øª ØªØ§ÙŠÙ„Ø§Ù†Ø¯ÙŠ', name_en: 'Thai Baht' },
    { code: 'VND', symbol: 'â‚«', name_ar: 'Ø¯ÙˆÙ†Øº ÙÙŠØªÙ†Ø§Ù…ÙŠ', name_en: 'Vietnamese Dong' },
    { code: 'NGN', symbol: 'â‚¦', name_ar: 'Ù†Ø§ÙŠØ±Ø§ Ù†ÙŠØ¬ÙŠØ±ÙŠ', name_en: 'Nigerian Naira' },
    { code: 'KES', symbol: 'KSh', name_ar: 'Ø´Ù„Ù† ÙƒÙŠÙ†ÙŠ', name_en: 'Kenyan Shilling' },
    { code: 'GHS', symbol: 'â‚µ', name_ar: 'Ø³ÙŠØ¯ÙŠ ØºØ§Ù†ÙŠ', name_en: 'Ghanaian Cedi' },
    { code: 'ETB', symbol: 'Br', name_ar: 'Ø¨ÙŠØ± Ø¥Ø«ÙŠÙˆØ¨ÙŠ', name_en: 'Ethiopian Birr' },
    { code: 'PKR', symbol: 'â‚¨', name_ar: 'Ø±ÙˆØ¨ÙŠØ© Ø¨Ø§ÙƒØ³ØªØ§Ù†ÙŠØ©', name_en: 'Pakistani Rupee' },
    { code: 'BDT', symbol: 'à§³', name_ar: 'ØªØ§ÙƒØ§ Ø¨Ù†ØºÙ„Ø§Ø¯ÙŠØ´ÙŠ', name_en: 'Bangladeshi Taka' },
    { code: 'LKR', symbol: 'Rs', name_ar: 'Ø±ÙˆØ¨ÙŠØ© Ø³Ø±ÙŠÙ„Ø§Ù†ÙƒÙŠØ©', name_en: 'Sri Lankan Rupee' },
    { code: 'AFN', symbol: 'Ø‹', name_ar: 'Ø£ÙØºØ§Ù†ÙŠ', name_en: 'Afghan Afghani' },
    { code: 'IRR', symbol: 'ï·¼', name_ar: 'Ø±ÙŠØ§Ù„ Ø¥ÙŠØ±Ø§Ù†ÙŠ', name_en: 'Iranian Rial' },
    { code: 'SEK', symbol: 'kr', name_ar: 'ÙƒØ±ÙˆÙ†Ø© Ø³ÙˆÙŠØ¯ÙŠØ©', name_en: 'Swedish Krona' },
    { code: 'NOK', symbol: 'kr', name_ar: 'ÙƒØ±ÙˆÙ†Ø© Ù†Ø±ÙˆÙŠØ¬ÙŠØ©', name_en: 'Norwegian Krone' },
    { code: 'DKK', symbol: 'kr', name_ar: 'ÙƒØ±ÙˆÙ†Ø© Ø¯Ù†Ù…Ø§Ø±ÙƒÙŠØ©', name_en: 'Danish Krone' },
    { code: 'PLN', symbol: 'zÅ‚', name_ar: 'Ø²Ù„ÙˆØªÙŠ Ø¨ÙˆÙ„Ù†Ø¯ÙŠ', name_en: 'Polish ZÅ‚oty' },
    { code: 'HUF', symbol: 'Ft', name_ar: 'ÙÙˆØ±Ù†Øª Ù…Ø¬Ø±ÙŠ', name_en: 'Hungarian Forint' },
    { code: 'CZK', symbol: 'KÄ', name_ar: 'ÙƒØ±ÙˆÙ†Ø© ØªØ´ÙŠÙƒÙŠØ©', name_en: 'Czech Koruna' },
    { code: 'ILS', symbol: 'â‚ª', name_ar: 'Ø´ÙŠÙƒÙ„', name_en: 'Shekel' },
    { code: 'NZD', symbol: '$', name_ar: 'Ø¯ÙˆÙ„Ø§Ø± Ù†ÙŠÙˆØ²ÙŠÙ„Ù†Ø¯ÙŠ', name_en: 'New Zealand Dollar' },
    { code: 'SGD', symbol: '$', name_ar: 'Ø¯ÙˆÙ„Ø§Ø± Ø³Ù†ØºØ§ÙÙˆØ±ÙŠ', name_en: 'Singapore Dollar' },
    { code: 'HKD', symbol: '$', name_ar: 'Ø¯ÙˆÙ„Ø§Ø± Ù‡ÙˆÙ†Ø¬ ÙƒÙˆÙ†Ø¬', name_en: 'Hong Kong Dollar' },
    { code: 'TWD', symbol: 'NT$', name_ar: 'Ø¯ÙˆÙ„Ø§Ø± ØªØ§ÙŠÙˆØ§Ù†ÙŠ', name_en: 'New Taiwan Dollar' },
];

let currentCurrency = WORLD_CURRENCIES.find(c => c.code === (localStorage.getItem('currencyCode') || 'SAR')) || WORLD_CURRENCIES[0];

const EXP_TYPES = ["Ø·Ø¹Ø§Ù…", "Ù…ÙˆØ§ØµÙ„Ø§Øª", "Ø±Ø¹Ø§ÙŠØ© Ø´Ø®ØµÙŠØ©", "Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©", "ØµØ­Ø©", "ØªØ±ÙÙŠÙ‡", "ØªØ³ÙˆÙ‚", "ØªØ¹Ù„ÙŠÙ…", "ØµÙŠØ§Ù†Ø© ÙˆØ¥ØµÙ„Ø§Ø­", "Ø£Ø®Ø±Ù‰"];
const RIG_TYPES = ["Ø¯ÙŠÙ†", "Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„", "Ø£Ø®Ø±Ù‰"];
const DEB_TYPES = ["Ø¥ÙŠØ¬Ø§Ø±", "ÙƒÙ‡Ø±Ø¨Ø§Ø¡", "Ù…Ø§Ø¡", "Ø¥Ù†ØªØ±Ù†Øª", "Ù‚Ø±Ø¶", "Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ", "Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø© Ø£Ø®Ø±Ù‰", "Ø£Ø®Ø±Ù‰"];

// Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª
const Translations = {
    'ar': {
        title: 'Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©',
        tabOverview: 'Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©',
        tabExpenses: 'Ù…ØµØ±ÙˆÙØ§Øª',
        tabRights: 'Ø­Ù‚ÙˆÙ‚',
        tabDebts: 'Ø§Ù„ØªØ²Ø§Ù…Ø§Øª',
        balanceTitle: 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ',
        btnDeposit: 'Ø¥ÙŠØ¯Ø§Ø¹',
        btnWithdraw: 'Ø³Ø­Ø¨',
        btnBalanceLog: 'Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯',
        summaryTitle: '<i class="fas fa-calculator" style="margin-left: 5px;"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª',
        sExpLabel: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (ØªØ´Ù…Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª):',
        sRigLabel: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©:',
        sDebLabel: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©:',
        sRigPaidLabel: 'Ø§Ù„Ù…Ø­ØµÙ„ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ‚:',
        sDebPaidLabel: 'Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª:',
        expNote: '* Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡Ø§ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙˆØ±Ø§Ù‹',
        rigNote: '* Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„Ø© (Ø¯ÙØ¹ Ø§Ù„Ø¯ÙŠÙ†/Ø§Ù„Ø¢Ø¬Ù„) ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ',
        debNote: '* Ø¯ÙØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ',
        eTypePlaceholder: 'ğŸ›’ Ø§Ù„ÙØ¦Ø© (Ù†ÙÙ‚Ø§Øª Ù…ØªØºÙŠØ±Ø©)',
        rTypePlaceholder: 'ğŸ¤ Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚',
        dTypePlaceholder: 'ğŸ§¾ Ù†ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…',
        rStatusPlaceholder: 'âœ… Ø§Ù„Ø­Ø§Ù„Ø©',
        rStatusPaid: 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„',
        rStatusUnpaid: 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ Ø¨Ø¹Ø¯',
        dStatusPlaceholder: 'âœ… Ø§Ù„Ø­Ø§Ù„Ø©',
        dStatusPaid: 'Ù…Ø¯ÙÙˆØ¹',
        dStatusUnpaid: 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹',
        btnSaveExpense: 'Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ',
        btnExpenseLog: 'Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
        btnSaveRight: 'Ø­ÙØ¸ Ø§Ù„Ø­Ù‚',
        btnRightLog: 'Ø³Ø¬Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ‚',
        btnSaveDebt: 'Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…',
        btnDebtLog: 'Ø³Ø¬Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª',
        sidebarHeader: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
        settingsTitle: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©',
        darkModeLabel: 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ',
        exportData: 'ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)',
        importData: 'Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)',
        aboutApp: 'Ø­ÙˆÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚',
        resetData: 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
        changeCurrencyBtn: 'ØªØºÙŠÙŠØ±',
        currency: 'Ø§Ù„Ø¹Ù…Ù„Ø©', 
        languageToggleText: 'English',
        aboutModalTitle: 'Ø­ÙˆÙ„ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ©',
        appVersion: 'Ø§Ù„Ø¥ØµØ¯Ø§Ø± 3.2 (Ù…Ø¹ Ù…ÙŠØ²Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙÙˆØ±ÙŠ)',
        currencyModalTitle: 'Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø©', 
        searchCurrency: 'Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„Ø©...', 
        
    },
    'en': {
        title: 'Smart Budget | Financial Management',
        tabOverview: 'Overview',
        tabExpenses: 'Expenses',
        tabRights: 'Receivables',
        tabDebts: 'Payables',
        balanceTitle: 'Current Cash Balance',
        btnDeposit: 'Deposit',
        btnWithdraw: 'Withdraw',
        btnBalanceLog: 'Balance Log',
        summaryTitle: '<i class="fas fa-calculator" style="margin-right: 5px;"></i> Statistics Summary',
        sExpLabel: 'Total Expenses (incl. Payments):',
        sRigLabel: 'Total Receivables Due:',
        sDebLabel: 'Total Payables:',
        sRigPaidLabel: 'Received from Rights:',
        sDebPaidLabel: 'Paid from Debts:',
        expNote: '* Expenses are deducted from your current balance immediately.',
        rigNote: '* Collected amounts (debt/credit sale payment) are added to your balance.',
        debNote: '* Debt payments are deducted from your current balance.',
        eTypePlaceholder: 'ğŸ›’ Category (Variable Expenses)',
        rTypePlaceholder: 'ğŸ¤ Right Type',
        dTypePlaceholder: 'ğŸ§¾ Obligation Type',
        rStatusPlaceholder: 'âœ… Status',
        rStatusPaid: 'Fully Paid',
        rStatusUnpaid: 'Unpaid',
        dStatusPlaceholder: 'âœ… Status',
        dStatusPaid: 'Paid',
        dStatusUnpaid: 'Unpaid',
        btnSaveExpense: 'Save Expense',
        btnExpenseLog: 'Expense Log',
        btnSaveRight: 'Save Receivable',
        btnRightLog: 'Receivable Log',
        btnSaveDebt: 'Save Payable',
        btnDebtLog: 'Payable Log',
        sidebarHeader: 'Settings & Data',
        settingsTitle: 'General Settings',
        darkModeLabel: 'Dark Mode',
        exportData: 'Export Data (JSON)',
        importData: 'Import Data (JSON)',
        aboutApp: 'About App',
        resetData: 'Reset Data',
        changeCurrencyBtn: 'Change',
        currency: 'Currency', 
        languageToggleText: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
        aboutModalTitle: 'About Smart Budget',
        appVersion: 'Version 3.2 (with instant editing feature)',
        currencyModalTitle: 'Select Currency', 
        searchCurrency: 'Search currency...',
    }
};

// Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ù‚Ù„ (ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© 'edit')
const LAYERS = { 
    'sidebar': { elementId: 'appSidebar', type: 'menu' }, 
    'log': { elementId: 'logModal', type: 'modal' }, 
    'detail': { elementId: 'detailModal', type: 'modal' }, 
    'currency': { elementId: 'currencyModal', type: 'modal' }, 
    'about': { elementId: 'aboutModal', type: 'modal' }, 
    'balanceAction': { elementId: 'balanceActionModal', type: 'modal' }, 
    'balanceLog': { elementId: 'balanceLogModal', type: 'modal' }, 
    'imageSource': { elementId: 'imageSourceModal', type: 'menu' }, 
    'edit': { elementId: 'editModal', type: 'modal' } 
};
let historyStack = [];

// ===================================================
// 2. ÙˆØ¸Ø§Ø¦Ù IndexedDB ÙˆØ§Ù„Ø­ÙØ¸ (Ù„Ù… ØªØªØºÙŠØ±)
// ===================================================
function initDB() { 
    // ... (ÙƒÙˆØ¯ IndexedDB Ù„Ù… ÙŠØªØºÙŠØ±) ... 
    return new Promise((resolve, reject) => {
        if (!window.indexedDB) {
            toastMsg("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… IndexedDB. Ù„Ù† ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
            return reject(new Error("IndexedDB not supported."));
        }
        const request = indexedDB.open(IDB_NAME, IDB_VERSION);
        request.onerror = (e) => {
            console.error("IndexedDB error:", e.target.error);
            reject(e.target.error);
        };
        request.onupgradeneeded = (e) => {
            IDB_connection = e.target.result;
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø®Ø§Ø²Ù† Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© Ù„ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø¥ØµØ¯Ø§Ø±
            if (!IDB_connection.objectStoreNames.contains('exp')) IDB_connection.createObjectStore("exp", { keyPath: "id", autoIncrement: true });
            if (!IDB_connection.objectStoreNames.contains('rig')) IDB_connection.createObjectStore("rig", { keyPath: "id", autoIncrement: true });
            if (!IDB_connection.objectStoreNames.contains('deb')) IDB_connection.createObjectStore("deb", { keyPath: "id", autoIncrement: true });
            // Ù…Ø®Ø²Ù† Ø®Ø§Øµ Ø¨Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø±ÙƒØ§Øª (Ù„Ø£Ù†Ù‡ Ø³Ø¬Ù„ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·)
            if (!IDB_connection.objectStoreNames.contains('bal')) IDB_connection.createObjectStore("bal", { keyPath: "clientId" });
        };
        request.onsuccess = (e) => {
            IDB_connection = e.target.result;
            console.log("IndexedDB initialized successfully.");
            resolve();
        };
    });
}

function saveData(storeName, data) {
    if (!IDB_connection) return Promise.reject("Database not connected.");
    
    return new Promise((resolve, reject) => {
        const transaction = IDB_connection.transaction(storeName, "readwrite");
        const store = transaction.objectStore(storeName);
        let request;

        if (storeName === 'bal') {
            request = store.put(data); // Ù†Ø³ØªØ®Ø¯Ù… put Ù„Ù„Ù€ balance Ù„Ø£Ù†Ù‡ Ø³Ø¬Ù„ ÙˆØ§Ø­Ø¯
        } else if (Array.isArray(data)) {
            // Ø­ÙØ¸ Ø§Ù„Ù…ØµÙÙˆÙØ§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (ÙƒÙ…Ø§ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ù€ logs)
            // Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø·Ù‚ ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ø¶Ø§ÙØ©/Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ±Ø¯ÙŠ
            // Ù„ÙƒÙ† Ù†Ø¨Ù‚ÙŠÙ‡ ÙƒØ§Ø­ØªÙŠØ§Ø·
            store.clear().onsuccess = () => {
                 data.forEach(item => store.add(item));
            };
            request = transaction; // Ù†Ù†ØªØ¸Ø± Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ±Ø§Ù†Ø²ÙƒØ´Ù† Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        } else {
            // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯
            request = store.add(data);
        }

        request.onsuccess = () => resolve(request.result);
        request.onerror = (e) => {
            console.error(`Error saving to ${storeName}:`, e.target.error);
            reject(e.target.error);
        };
    });
}

function updateData(storeName, data) {
    if (!IDB_connection) return Promise.reject("Database not connected.");
    
    return new Promise((resolve, reject) => {
        const transaction = IDB_connection.transaction(storeName, "readwrite");
        const store = transaction.objectStore(storeName);
        const request = store.put(data); // put ÙŠØ³ØªØ®Ø¯Ù… Ù„Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ø§Ù„ØªØ­Ø¯ÙŠØ« (Ø¨Ø´Ø±Ø· ÙˆØ¬ÙˆØ¯ keyPath)

        request.onsuccess = () => resolve(request.result);
        request.onerror = (e) => {
            console.error(`Error updating ${storeName}:`, e.target.error);
            reject(e.target.error);
        };
    });
}

function deleteData(storeName, id) {
    if (!IDB_connection) return Promise.reject("Database not connected.");
    
    return new Promise((resolve, reject) => {
        const transaction = IDB_connection.transaction(storeName, "readwrite");
        const store = transaction.objectStore(storeName);
        const request = store.delete(id);

        request.onsuccess = () => resolve();
        request.onerror = (e) => {
            console.error(`Error deleting from ${storeName}:`, e.target.error);
            reject(e.target.error);
        };
    });
}

function loadAllData() {
    if (!IDB_connection) return Promise.reject("Database not connected.");

    return Promise.all(STORE_NAMES.map(storeName => {
        return new Promise((resolve, reject) => {
            const transaction = IDB_connection.transaction(storeName, "readonly");
            const store = transaction.objectStore(storeName);
            const request = store.getAll();

            request.onsuccess = (e) => {
                const results = e.target.result;
                if (storeName === 'bal') {
                    db.bal = results[0] || { clientId: 1, amount: 0, changes: [] };
                    currentBalance = db.bal.amount;
                } else {
                    db[storeName] = results.sort((a, b) => new Date(b.date) - new Date(a.date));
                }
                resolve();
            };

            request.onerror = (e) => {
                console.error(`Error loading ${storeName}:`, e.target.error);
                reject(e.target.error);
            };
        });
    }));
}

// ----------------------------------------------------
// ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØµØ¯ÙŠØ±Ù‡Ø§ ÙˆØ§Ø³ØªÙŠØ±Ø§Ø¯Ù‡Ø§
// ----------------------------------------------------
function exportData() {
    closeLayer('sidebar');
    const dataToExport = {
        meta: { 
            app: 'SmartBudget', 
            version: '3.2', 
            exportedAt: new Date().toISOString(),
            currencyCode: currentCurrency.code,
            language: currentLanguage
        },
        data: db
    };
    const jsonString = JSON.stringify(dataToExport, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `SmartBudget_Export_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    toastMsg("ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
}

function importData(event) {
    closeLayer('sidebar');
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const importedData = JSON.parse(e.target.result);
            if (!importedData.data || !importedData.data.bal) {
                throw new Error("Invalid format");
            }

            // ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            db = importedData.data;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ù„Ø© ÙˆØ§Ù„Ù„ØºØ©
            if (importedData.meta) {
                currentCurrency = WORLD_CURRENCIES.find(c => c.code === importedData.meta.currencyCode) || WORLD_CURRENCIES[0];
                currentLanguage = importedData.meta.language || 'ar';
                localStorage.setItem('currencyCode', currentCurrency.code);
                localStorage.setItem('language', currentLanguage);
            }
            
            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ IndexedDB
            const transaction = IDB_connection.transaction(STORE_NAMES, "readwrite");
            let storesCleared = 0;

            STORE_NAMES.forEach(storeName => {
                const store = transaction.objectStore(storeName);
                store.clear().onsuccess = () => {
                    storesCleared++;
                    if (storeName === 'bal') {
                         store.put(db.bal);
                    } else {
                        (db[storeName] || []).forEach(item => {
                            // ÙŠØ¬Ø¨ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù€ ID Ø¥Ø°Ø§ ÙƒØ§Ù† autoIncrement ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
                            // Ù„ÙƒÙ† ÙÙŠ Ø­Ø§Ù„ØªÙ†Ø§ØŒ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù€ put/add Ø§Ù„ØªÙŠ ØªØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù€ keyPath
                            store.add(item); 
                        });
                    }
                };
            });

            transaction.oncomplete = () => {
                loadAllData().then(() => {
                    updateUI(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„Ù„ØºØ©
                    updateStats(); 
                    toastMsg("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­!");
                });
            };

        } catch (error) {
            toastMsg("ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù Ø¨ØµÙŠØºØ© JSON ØµØ­ÙŠØ­Ø©.");
            console.error("Import Error:", error);
        } finally {
            event.target.value = null; 
        }
    };
    reader.readAsText(file);
}

function confirmResetData() {
    closeLayer('sidebar');
    if (confirm(Translations[currentLanguage].resetDataConfirmation || "ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.")) {
        resetAllData();
    }
}

function resetAllData() {
     if (!IDB_connection) return toastMsg("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");

    const transaction = IDB_connection.transaction(STORE_NAMES, "readwrite");
    let storesCleared = 0;
    
    STORE_NAMES.forEach(storeName => {
        const store = transaction.objectStore(storeName);
        const request = store.clear();

        request.onsuccess = () => {
            storesCleared++;
            if (storesCleared === STORE_NAMES.length) {
                db.exp = db.rig = db.deb = []; 
                db.bal = { clientId: 1, amount: 0, changes: [] };
                saveData('bal', db.bal).then(() => {
                    loadAllData().then(() => {
                        updateStats(); 
                        updateBalanceDisplay();
                        toastMsg(Translations[currentLanguage].resetSuccess || "ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
                    });
                });
            }
        };

        request.onerror = () => toastMsg("ÙØ´Ù„... (Ù„Ù… ÙŠØªÙ… ØªØ±Ø¬Ù…Ø© Ù‡Ø°Ø§ Ø§Ù„Ø®Ø·Ø£)");
    });
}


// ===================================================
// 3. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¹Ù…Ù„Ø§Øª ÙˆØ§Ù„Ù„ØºØ© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)
// ===================================================

function updateUI() {
    const t = Translations[currentLanguage];
    const html = document.documentElement;

    html.setAttribute('lang', currentLanguage);
    html.setAttribute('dir', currentLanguage === 'ar' ? 'rtl' : 'ltr');
    document.title = t.title;

    // --- ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø«Ø§Ø¨ØªØ© ---
    document.getElementById('appTitle').textContent = t.title;
    
    // Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    document.getElementById('tabOverview').textContent = t.tabOverview;
    document.getElementById('tabExpenses').textContent = t.tabExpenses;
    document.getElementById('tabRights').textContent = t.tabRights;
    document.getElementById('tabDebts').textContent = t.tabDebts;

    // Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©
    document.getElementById('balanceTitle').textContent = t.balanceTitle;
    document.getElementById('btnDeposit').textContent = t.btnDeposit;
    document.getElementById('btnWithdraw').textContent = t.btnWithdraw;
    document.getElementById('btnBalanceLog').innerHTML = `<i class="fas fa-history" style="margin-${currentLanguage === 'ar' ? 'left' : 'right'}: 5px;"></i> ${t.btnBalanceLog}`;
    document.getElementById('summaryTitle').innerHTML = t.summaryTitle;
    
    // ØªØ³Ù…ÙŠØ§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    document.getElementById('sExpLabel').textContent = t.sExpLabel;
    document.getElementById('sRigLabel').textContent = t.sRigLabel;
    document.getElementById('sDebLabel').textContent = t.sDebLabel;
    document.getElementById('sRigPaidLabel').textContent = t.sRigPaidLabel;
    document.getElementById('sDebPaidLabel').textContent = t.sDebPaidLabel;

    // Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
    document.getElementById('expNote').textContent = t.expNote;
    document.getElementById('rigNote').textContent = t.rigNote;
    document.getElementById('debNote').textContent = t.debNote;

    // Ø§Ù„Ù†ØµÙˆØµ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ (Placeholders)
    document.getElementById('eTypePlaceholder').textContent = t.eTypePlaceholder;
    document.getElementById('rTypePlaceholder').textContent = t.rTypePlaceholder;
    document.getElementById('dTypePlaceholder').textContent = t.dTypePlaceholder;
    
    document.getElementById('rStatusPlaceholder').textContent = t.rStatusPlaceholder;
    document.getElementById('rStatusPaid').textContent = t.rStatusPaid;
    document.getElementById('rStatusUnpaid').textContent = t.rStatusUnpaid;
    
    document.getElementById('dStatusPlaceholder').textContent = t.dStatusPlaceholder;
    document.getElementById('dStatusPaid').textContent = t.dStatusPaid;
    document.getElementById('dStatusUnpaid').textContent = t.dStatusUnpaid;

    // Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    document.getElementById('btnSaveExpense').innerHTML = `<i class="fas fa-save" style="margin-${currentLanguage === 'ar' ? 'left' : 'right'}: 5px;"></i> ${t.btnSaveExpense}`;
    document.getElementById('btnExpenseLog').innerHTML = `<i class="fas fa-history" style="margin-${currentLanguage === 'ar' ? 'left' : 'right'}: 5px;"></i> ${t.btnExpenseLog}`;
    document.getElementById('btnSaveRight').innerHTML = `<i class="fas fa-save" style="margin-${currentLanguage === 'ar' ? 'left' : 'right'}: 5px;"></i> ${t.btnSaveRight}`;
    document.getElementById('btnRightLog').innerHTML = `<i class="fas fa-history" style="margin-${currentLanguage === 'ar' ? 'left' : 'right'}: 5px;"></i> ${t.btnRightLog}`;
    document.getElementById('btnSaveDebt').innerHTML = `<i class="fas fa-save" style="margin-${currentLanguage === 'ar' ? 'left' : 'right'}: 5px;"></i> ${t.btnSaveDebt}`;
    document.getElementById('btnDebtLog').innerHTML = `<i class="fas fa-history" style="margin-${currentLanguage === 'ar' ? 'left' : 'right'}: 5px;"></i> ${t.btnDebtLog}`;

    // Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
    document.getElementById('sidebarHeader').textContent = t.sidebarHeader;
    document.getElementById('settingsTitle').textContent = t.settingsTitle;
    document.getElementById('darkModeLabel').textContent = t.darkModeLabel;
    document.getElementById('exportData').children[1].textContent = t.exportData;
    document.getElementById('importData').children[1].textContent = t.importData;
    document.getElementById('aboutApp').children[1].textContent = t.aboutApp;
    document.getElementById('resetData').children[1].textContent = t.resetData;
    document.getElementById('changeCurrencyBtn').textContent = t.changeCurrencyBtn; // Ù†Øµ Ø²Ø± "ØªØºÙŠÙŠØ±"

    // *** Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠ: Ø§Ø³Ù… Ø§Ù„Ø¹Ù…Ù„Ø© ÙŠØªØºÙŠØ± Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ© ***
    const currencyName = currentLanguage === 'ar' ? currentCurrency.name_ar : currentCurrency.name_en;
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
    document.getElementById('currentCurrencyDisplay').innerHTML = 
        `${t.currency || 'Ø§Ù„Ø¹Ù…Ù„Ø©'}: ${currencyName} (${currentCurrency.symbol}) <span style="color: var(--p);"><i class="fas fa-exchange-alt"></i> <span id="changeCurrencyBtn">${t.changeCurrencyBtn}</span></span>`;


    // ØªØ­Ø¯ÙŠØ« Ù†Øµ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ© (ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ)
    document.getElementById('languageToggleText').textContent = t.languageToggleText;
    document.getElementById('languageToggleTextSidebar').textContent = t.languageToggleText;

    // Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª (Modals)
    document.getElementById('aboutModalTitle').textContent = t.aboutModalTitle;
    document.getElementById('appVersion').textContent = t.appVersion;
    document.getElementById('currencyModalTitle').textContent = t.currencyModalTitle;
    document.getElementById('currencySearch').placeholder = t.searchCurrency;

    // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„ØªØ·Ø¨ÙŠÙ‚ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø¥Ø°Ø§ Ø§Ø®ØªÙ„Ù Ø§Ù„ÙØ§ØµÙ„Ø©)
    updateBalanceDisplay();
    updateStats();
    // ÙŠØ¬Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Øª ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù† Ù…ÙØªÙˆØ­Ø§Ù‹
    if (document.getElementById('currencyModal').style.display === 'flex') {
        renderCurrencyList();
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ§Ù„Ø¹Ù…Ù„Ø©
function updateBalanceDisplay() {
    const display = document.getElementById('currentBalanceDisplay');
    const symbol = currentCurrency.symbol;
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… currentLanguage ÙÙŠ toLocaleString ÙŠØ¶Ù…Ù† ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„ØºØ© (ÙÙˆØ§ØµÙ„ Ø§Ù„Ø¢Ù„Ø§Ù ÙˆØ§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø¹Ø´Ø±ÙŠØ©)
    const formattedBalance = currentBalance.toLocaleString(currentLanguage, { minimumFractionDigits: 0, maximumFractionDigits: 2 });
    
    if (balanceHidden) {
        display.innerHTML = `<span class="hidden-balance">â€¢â€¢â€¢â€¢</span> ${symbol}`;
    } else {
        display.innerHTML = `<span class="currency-symbol">${symbol}</span>${formattedBalance}`;
    }

    const toggleButton = document.getElementById('balanceVisibilityToggle');
    toggleButton.innerHTML = balanceHidden ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ø£ÙŠØ¶Ø§Ù‹ Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ (Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£Ø¹Ù„Ø§Ù‡)
    const t = Translations[currentLanguage];
    const currencyName = currentLanguage === 'ar' ? currentCurrency.name_ar : currentCurrency.name_en;
    document.getElementById('currentCurrencyDisplay').innerHTML = 
        `${t.currency || 'Ø§Ù„Ø¹Ù…Ù„Ø©'}: ${currencyName} (${currentCurrency.symbol}) <span style="color: var(--p);"><i class="fas fa-exchange-alt"></i> <span id="changeCurrencyBtn">${t.changeCurrencyBtn}</span></span>`;
}


function toggleLanguage() {
    currentLanguage = currentLanguage === 'ar' ? 'en' : 'ar';
    localStorage.setItem('language', currentLanguage);

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ÙƒØ§Ø¦Ù† Ø§Ù„Ø¹Ù…Ù„Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØµØ­ÙŠØ­ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    currentCurrency = WORLD_CURRENCIES.find(c => c.code === currentCurrency.code) || WORLD_CURRENCIES[0];

    updateUI();
    updateStats(); 
    renderLog(); // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø¨ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
}

function openCurrencyModal() {
    document.getElementById('currencySearch').value = '';
    renderCurrencyList();
    openLayer('currency');
}

// Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø¨Ø­Ø« Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø«Ù†Ø§Ø¦ÙŠ Ø§Ù„Ù„ØºØ©
function renderCurrencyList() {
    const search = document.getElementById('currencySearch').value.toLowerCase();
    const container = document.getElementById('currencyList');
    const t = Translations[currentLanguage];
    
    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ØŒ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØŒ ÙˆØ§Ù„Ø§Ø³Ù… Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ ÙˆØ§Ù„Ø±Ù…Ø²
    let filteredCurrencies = WORLD_CURRENCIES.filter(c => 
        c.name_ar.toLowerCase().includes(search) || 
        c.name_en.toLowerCase().includes(search) || 
        c.code.toLowerCase().includes(search) || 
        c.symbol.toLowerCase().includes(search)
    );

    // ÙØ±Ø² Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø£Ø¨Ø¬Ø¯ÙŠØ§Ù‹
    filteredCurrencies.sort((a, b) => {
        if (a.code === currentCurrency.code) return -1;
        if (b.code === currentCurrency.code) return 1;
        // Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        const nameA = currentLanguage === 'ar' ? a.name_ar : a.name_en;
        const nameB = currentLanguage === 'ar' ? b.name_ar : b.name_en;
        return nameA.localeCompare(nameB);
    });

    let html = '<div style="margin-top: 10px;">';
    filteredCurrencies.forEach(c => {
        const isActive = c.code === currentCurrency.code;
        const displayName = currentLanguage === 'ar' ? c.name_ar : c.name_en; // Ø§Ù„Ø§Ø³Ù… Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©
        const secondaryName = currentLanguage === 'ar' ? c.name_en : c.name_ar; // Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ

        html += `
            <div class="list-item" onclick="setCurrency('${c.code}')" style="border-right: 5px solid ${isActive ? 'var(--p)' : 'var(--border-color)'};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: bold; font-size: 1.1em; color: var(--text-dark);">
                        ${displayName} <small style="color: #888; font-size: 0.8em;">(${c.code})</small>
                    </span>
                    <span style="color: var(--p); font-weight: bold;">${c.symbol}</span>
                </div>
                <div style="font-size: 0.85em; color: #666; margin-top: 2px;">
                    ${secondaryName}
                </div>
                ${isActive ? `<div style="color: var(--success); font-size: 0.8em; margin-top: 2px;"><i class="fas fa-check-circle"></i> ${currentLanguage === 'ar' ? 'Ù…Ø®ØªØ§Ø±' : 'Selected'}</div>` : ''}
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function setCurrency(code) {
    // Ù†Ø³ØªØ®Ø¯Ù… WORLD_CURRENCIES
    currentCurrency = WORLD_CURRENCIES.find(c => c.code === code);
    localStorage.setItem('currencyCode', code);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹
    updateUI(); 
    updateStats(); 
    
    closeLayer('currency');

    // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const name = currentLanguage === 'ar' ? currentCurrency.name_ar : currentCurrency.name_en;
    toastMsg(`${currentLanguage === 'ar' ? 'ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù…Ù„Ø© Ø¥Ù„Ù‰' : 'Currency set to'} ${name} (${currentCurrency.symbol})`);
}

// ----------------------------------------------------
// ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¶Ø§ÙÙŠØ© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Ù„Ù… ØªØªØºÙŠØ± Ø¥Ù„Ø§ Ø¨Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡)
// ----------------------------------------------------

function formatAmount(input) {
    let value = input.value.replace(/,/g, ''); 
    
    // ÙŠØ¶Ù…Ù† Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø±Ù‚Ù… Ù…ÙˆØ¬Ø¨Ø§Ù‹ ÙÙ‚Ø· 
    if (value.startsWith('-')) {
        value = value.substring(1);
    }
    
    // ÙŠØ³Ù…Ø­ ÙÙ‚Ø· Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„ÙØ§ØµÙ„Ø© Ø§Ù„Ø¹Ø´Ø±ÙŠØ©
    value = value.replace(/[^0-9.]/g, ''); 

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙØ§ØµÙ„Ø© Ø§Ù„Ø¹Ø´Ø±ÙŠØ© Ù„ØªÙƒÙˆÙ† ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
    const parts = value.split('.');
    if (parts.length > 2) {
        value = parts[0] + '.' + parts.slice(1).join('');
    }

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£ØµÙØ§Ø± ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©
    if (value.length > 1 && value.startsWith('0') && !value.startsWith('0.')) {
        value = value.substring(1);
    }

    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙÙˆØ§ØµÙ„ Ø¨Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ ØªÙˆØ·ÙŠÙ† Ø§Ù„Ù„ØºØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const number = parseFloat(value);
    if (!isNaN(number)) {
        // Ù†Ø³ØªØ®Ø¯Ù… toLocaleString Ù…Ø¹ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¢Ù„Ø§Ù (Ù…Ø«Ù„Ø§Ù‹ 1,000 ÙÙŠ EN Ùˆ 1.000 ÙÙŠ AR)
        // ÙˆÙ†Ø­ÙØ¸ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙØ¹Ù„ÙŠ ÙÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ù‚Ù„ Ø¨Ø¯ÙˆÙ† ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙÙˆØ§ØµÙ„ Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        // Ù„ÙƒÙ†Ù†Ø§ Ù„Ø§ Ù†Ø±ÙŠØ¯ Ø£Ù† Ù†Ø¶ÙŠØ¹ Ø§Ù„ÙØ§ØµÙ„Ø© Ø§Ù„Ø¹Ø´Ø±ÙŠØ© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
        if (!value.endsWith('.')) {
             input.value = number.toLocaleString(currentLanguage, { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        } else {
             input.value = value;
        }

    } else {
        input.value = value;
    }
}

function openTab(tabName) {
    const tabs = document.querySelectorAll('.tabs button');
    const sections = document.querySelectorAll('.section');

    tabs.forEach(tab => {
        if (tab.textContent.toLowerCase().includes(Translations['ar']['tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)].toLowerCase()) || tab.textContent.toLowerCase().includes(Translations['en']['tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)].toLowerCase())) {
            tab.classList.add('active');
        } else {
            tab.classList.remove('active');
        }
    });

    sections.forEach(section => {
        section.classList.remove('active');
    });

    document.getElementById(tabName).classList.add('active');
}

function updateStats() {
    const t = Translations[currentLanguage];
    let totalExp = 0;
    let totalRig = 0;
    let totalDeb = 0;
    let paidRig = 0;
    let paidDeb = 0;
    
    db.exp.forEach(e => totalExp += e.amount);
    db.rig.forEach(r => {
        totalRig += r.amount;
        if (r.status === 'ÙƒØ§Ù…Ù„' || r.status === 'Fully Paid') paidRig += r.amount;
    });
    db.deb.forEach(d => {
        totalDeb += d.amount;
        if (d.status === 'Ù…Ø¯ÙÙˆØ¹' || d.status === 'Paid') paidDeb += d.amount;
    });

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… toLocaleString Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
    const lang = currentLanguage;
    const formatOptions = { minimumFractionDigits: 0, maximumFractionDigits: 2 };

    document.getElementById('sExpTotal').textContent = `${totalExp.toLocaleString(lang, formatOptions)} ${currentCurrency.symbol}`;
    document.getElementById('sRigTotal').textContent = `${totalRig.toLocaleString(lang, formatOptions)} ${currentCurrency.symbol}`;
    document.getElementById('sDebTotal').textContent = `${totalDeb.toLocaleString(lang, formatOptions)} ${currentCurrency.symbol}`;
    document.getElementById('sRigPaid').textContent = `${paidRig.toLocaleString(lang, formatOptions)} ${currentCurrency.symbol}`;
    document.getElementById('sDebPaid').textContent = `${paidDeb.toLocaleString(lang, formatOptions)} ${currentCurrency.symbol}`;
}

// ----------------------------------------------------
// ÙˆØ¸Ø§Ø¦Ù Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±ØµÙŠØ¯
// ----------------------------------------------------

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDarkMode = document.body.classList.contains('dark-mode');
    localStorage.setItem('darkMode', isDarkMode);
}

function toggleBalanceVisibility() {
    balanceHidden = !balanceHidden;
    localStorage.setItem('balanceHidden', balanceHidden);
    updateBalanceDisplay();
}

// ----------------------------------------------------
// ÙˆØ¸Ø§Ø¦Ù ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª (Modals, Sidebar)
// ----------------------------------------------------

function openLayer(layerKey, pushToHistory = true) {
    const layer = LAYERS[layerKey];
    if (layer) {
        document.getElementById(layer.elementId).classList.add(layer.type === 'menu' ? 'open' : 'active');
        document.getElementById(layer.elementId).style.display = layer.type === 'menu' ? 'flex' : 'flex';

        if (layer.type === 'menu') {
            const overlay = layerKey === 'imageSource' ? document.getElementById('imageSourceOverlay') : document.querySelector('.sidebar-overlay');
            overlay.classList.add('open');
            overlay.style.display = 'block';
        }

        if (pushToHistory) {
            historyStack.push(layerKey);
        }
    }
}

function closeLayer(layerKey, popHistory = true) {
    const layer = LAYERS[layerKey];
    if (layer) {
        document.getElementById(layer.elementId).classList.remove(layer.type === 'menu' ? 'open' : 'active');
        document.getElementById(layer.elementId).style.display = 'none';

        if (layer.type === 'menu') {
            const overlay = layerKey === 'imageSource' ? document.getElementById('imageSourceOverlay') : document.querySelector('.sidebar-overlay');
            overlay.classList.remove('open');
            overlay.style.display = 'none';
        }
        
        if (popHistory) {
            historyStack = historyStack.filter(item => item !== layerKey);
        }
    }
    if (layerKey === 'edit') {
        editMode = null; // Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    }
}

function handleBackNavigation() {
    if (historyStack.length > 0) {
        const lastLayerKey = historyStack.pop();
        closeLayer(lastLayerKey, false);
    } else {
        // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ù„Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù‡Ù†Ø§ ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù† Ù…Ù„Ù APK
        // Ù…Ø«Ù„Ø§Ù‹: if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŸ')) { closeApp(); }
    }
}

window.addEventListener('popstate', handleBackNavigation);

function openSidebar() {
    openLayer('sidebar');
}
function openAboutModal() {
    openLayer('about');
}

// ----------------------------------------------------
// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Toast)
// ----------------------------------------------------

function toastMsg(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => {
        toast.classList.remove('show');
    }, 2500);
}


// ----------------------------------------------------
// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ§Ù„Ø³Ø­Ø¨ (Balance Actions)
// ----------------------------------------------------

function openBalanceActionModal(type) {
    balanceActionType = type;
    const t = Translations[currentLanguage];
    const title = type === 'deposit' ? `${t.btnDeposit}` : `${t.btnWithdraw}`;
    document.getElementById('actionModalTitle').textContent = title;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø©
    const symbol = currentCurrency.symbol;
    const formattedBalance = currentBalance.toLocaleString(currentLanguage, { minimumFractionDigits: 0, maximumFractionDigits: 2 });
    document.getElementById('currentBalanceInAction').innerHTML = `<span class="currency-symbol">${symbol}</span>${formattedBalance}`;
    
    // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
    document.getElementById('bAmount').value = '';
    document.getElementById('bDesc').value = '';
    document.getElementById('bDate').value = new Date().toISOString().slice(0, 16);
    
    openLayer('balanceAction');
}

function processBalanceAction() {
    const t = Translations[currentLanguage];
    const amountStr = document.getElementById('bAmount').value.replace(/[^0-9.]/g, '');
    const amount = parseFloat(amountStr);
    const desc = document.getElementById('bDesc').value.trim();
    const date = document.getElementById('bDate').value;
    
    if (isNaN(amount) || amount <= 0) {
        return toastMsg(t.errorAmount || "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­.");
    }
    
    const isDeposit = balanceActionType === 'deposit';
    let newBalance = isDeposit ? currentBalance + amount : currentBalance - amount;
    
    if (!isDeposit && newBalance < 0) {
        const confirmWithdraw = confirm(t.warningNegativeBalance || "ØªØ­Ø°ÙŠØ±: Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³Ø­ÙˆØ¨ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ");
        if (!confirmWithdraw) return;
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ©
    const logEntry = {
        type: isDeposit ? 'Ø¥ÙŠØ¯Ø§Ø¹' : 'Ø³Ø­Ø¨',
        amount: amount,
        desc: desc || (isDeposit ? t.defaultDepositDesc || 'Ø¥ÙŠØ¯Ø§Ø¹ Ù†Ù‚Ø¯ÙŠ' : t.defaultWithdrawDesc || 'Ø³Ø­Ø¨ Ù†Ù‚Ø¯ÙŠ'),
        date: date,
        balanceBefore: currentBalance,
        balanceAfter: newBalance,
        id: Date.now()
    };

    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    db.bal.amount = newBalance;
    db.bal.changes.unshift(logEntry); // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
    currentBalance = newBalance;

    saveData('bal', db.bal).then(() => {
        updateBalanceDisplay();
        closeLayer('balanceAction');
        toastMsg(`${isDeposit ? t.depositSuccess || 'ØªÙ… Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹' : t.withdrawSuccess || 'ØªÙ… Ø§Ù„Ø³Ø­Ø¨'} ${amount.toLocaleString(currentLanguage)} ${currentCurrency.symbol} ${t.successMessage || 'Ø¨Ù†Ø¬Ø§Ø­!'}`);
    }).catch(e => {
        console.error(e);
        toastMsg(t.errorDB || "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
    });
}


function openBalanceLogModal() {
    renderBalanceLog();
    openLayer('balanceLog');
}

function renderBalanceLog() {
    const container = document.getElementById('balanceLogContent');
    const t = Translations[currentLanguage];
    const logs = db.bal.changes;
    const lang = currentLanguage;
    const formatOptions = { minimumFractionDigits: 0, maximumFractionDigits: 2 };

    if (logs.length === 0) {
        container.innerHTML = `<p style="text-align: center; color: #999; margin-top: 50px;">${t.noBalanceLogs || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ù„Ù„Ø±ØµÙŠØ¯ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.'}</p>`;
        return;
    }

    let html = '';
    logs.forEach(log => {
        const isDeposit = log.type === 'Ø¥ÙŠØ¯Ø§Ø¹' || log.type === 'Deposit';
        const amountDisplay = isDeposit ? `+${log.amount.toLocaleString(lang, formatOptions)}` : `-${log.amount.toLocaleString(lang, formatOptions)}`;
        const typeDisplay = isDeposit ? (t.btnDeposit || 'Ø¥ÙŠØ¯Ø§Ø¹') : (t.btnWithdraw || 'Ø³Ø­Ø¨');

        html += `
            <div class="list-item" style="border-right: 5px solid ${isDeposit ? 'var(--success)' : 'var(--danger)'};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: bold; color: ${isDeposit ? 'var(--success)' : 'var(--danger)'};">
                        ${typeDisplay}
                    </span>
                    <span style="font-weight: bold; font-size: 1.1em; color: var(--text-dark);">
                        ${amountDisplay} ${currentCurrency.symbol}
                    </span>
                </div>
                <div class="details">
                    <span>${log.desc || (isDeposit ? t.defaultDepositDesc : t.defaultWithdrawDesc)}</span>
                    <small style="color: #999;">${new Date(log.date).toLocaleDateString(lang)}</small>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

// ----------------------------------------------------
// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (Expenses)
// ----------------------------------------------------

function getNumericAmount(id) {
    const input = document.getElementById(id).value;
    return parseFloat(input.replace(/[^0-9.]/g, '')) || 0;
}

function addExpense() {
    const t = Translations[currentLanguage];
    const amount = getNumericAmount('eAmount');
    const type = document.getElementById('eType').value;
    const desc = document.getElementById('eDesc').value.trim();
    const date = document.getElementById('eDate').value;
    const imageBase64 = currentImageBase64;
    
    if (amount <= 0 || !type || !date) {
        return toastMsg(t.errorExpenseFields || "ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„Ù†ÙˆØ¹ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®.");
    }
    
    // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ (Ø®ØµÙ…)
    const newBalance = currentBalance - amount;

    // 2. Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
    const expenseEntry = {
        amount, type, desc, date, id: Date.now(),
        imageBase64: imageBase64,
        typeLabel: 'Ù…ØµØ±ÙˆÙ'
    };
    
    // 3. ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ø±ØµÙŠØ¯
    const balanceLogEntry = {
        type: 'Ø®ØµÙ… Ù…ØµØ±ÙˆÙ',
        amount: amount,
        desc: `${t.expenseLogPrefix || 'Ù…ØµØ±ÙˆÙ:'} ${type} - ${desc}`,
        date: date,
        balanceBefore: currentBalance,
        balanceAfter: newBalance,
        id: Date.now() + 0.1 // Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ØªØ±ØªÙŠØ¨ Ù…Ø®ØªÙ„Ù ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙ‚ÙŠØª Ù†ÙØ³Ù‡
    };

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„Ø­ÙØ¸
    db.exp.unshift(expenseEntry);
    db.bal.amount = newBalance;
    db.bal.changes.unshift(balanceLogEntry);
    currentBalance = newBalance;

    Promise.all([
        saveData('exp', expenseEntry),
        saveData('bal', db.bal)
    ]).then(() => {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        updateBalanceDisplay();
        updateStats();
        // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙˆØ±Ø©
        document.getElementById('eAmount').value = '';
        document.getElementById('eType').value = '';
        document.getElementById('eDesc').value = '';
        document.getElementById('eDate').value = new Date().toISOString().slice(0, 16);
        currentImageBase64 = null;
        document.getElementById('eImgName').textContent = '';
        document.getElementById('eImgCamera').value = '';
        document.getElementById('eImgGallery').value = '';

        toastMsg(`${t.expenseSuccess || 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­!'} ${amount.toLocaleString(currentLanguage)} ${currentCurrency.symbol}`);
    }).catch(e => {
        console.error(e);
        toastMsg(t.errorDB || "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
    });
}

// ----------------------------------------------------
// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­Ù‚ÙˆÙ‚ ÙˆØ§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª (Rights/Debts)
// ----------------------------------------------------

function updateRightFields(type) {
    // ÙƒÙˆØ¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ù„Ù„Ø­Ù‚ÙˆÙ‚ (Ù„Ù… ÙŠØªØºÙŠØ±)
}

function addRight() {
    const t = Translations[currentLanguage];
    const type = document.getElementById('rType').value;
    const amount = getNumericAmount('rAmount');
    const desc = document.getElementById('rDesc').value.trim();
    const date = document.getElementById('rDate').value;
    const status = document.getElementById('rStatus').value;

    if (amount <= 0 || !type || !date || !status) {
        return toastMsg(t.errorRightFields || "ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ‚.");
    }

    // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¯ÙÙˆØ¹Ø§Ù‹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
    let newBalance = currentBalance;
    let balanceLogEntry = null;
    let toastMessage = `${t.rightSaved || 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ù‚.'}`;

    if (status === 'ÙƒØ§Ù…Ù„' || status === 'Fully Paid') {
        newBalance = currentBalance + amount;
        
        balanceLogEntry = {
            type: 'ØªØ­ØµÙŠÙ„ Ø­Ù‚',
            amount: amount,
            desc: `${t.rightLogPrefix || 'ØªØ­ØµÙŠÙ„ Ø­Ù‚:'} ${type} - ${desc}`,
            date: date,
            balanceBefore: currentBalance,
            balanceAfter: newBalance,
            id: Date.now() + 0.1
        };
        toastMessage = `${t.rightCollected || 'ØªÙ… ØªØ­ØµÙŠÙ„ Ø§Ù„Ø­Ù‚ ÙˆØ§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø±ØµÙŠØ¯'} ${amount.toLocaleString(currentLanguage)} ${currentCurrency.symbol}`;
    }

    // 2. Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ‚
    const rightEntry = {
        amount, type, desc, date, status, id: Date.now(),
        typeLabel: 'Ø­Ù‚',
    };
    
    // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„Ø­ÙØ¸
    db.rig.unshift(rightEntry);
    currentBalance = newBalance;

    const savePromises = [saveData('rig', rightEntry)];
    if (balanceLogEntry) {
        db.bal.amount = newBalance;
        db.bal.changes.unshift(balanceLogEntry);
        savePromises.push(saveData('bal', db.bal));
    }

    Promise.all(savePromises).then(() => {
        updateBalanceDisplay();
        updateStats();
        // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
        document.getElementById('rAmount').value = '';
        document.getElementById('rType').value = '';
        document.getElementById('rDesc').value = '';
        document.getElementById('rDate').value = new Date().toISOString().slice(0, 16);
        document.getElementById('rStatus').value = '';
        document.getElementById('rDynamicFields').innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©

        toastMsg(toastMessage);
    }).catch(e => {
        console.error(e);
        toastMsg(t.errorDB || "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
    });
}

function updateDebtFields(type) {
    // ÙƒÙˆØ¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª (Ù„Ù… ÙŠØªØºÙŠØ±)
}

function addDebt() {
    const t = Translations[currentLanguage];
    const type = document.getElementById('dType').value;
    const amount = getNumericAmount('dAmount');
    const desc = document.getElementById('dDesc').value.trim();
    const date = document.getElementById('dDate').value;
    const status = document.getElementById('dStatus').value;

    if (amount <= 0 || !type || !date || !status) {
        return toastMsg(t.errorDebtFields || "ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª.");
    }

    // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¯ÙÙˆØ¹Ø§Ù‹
    let newBalance = currentBalance;
    let balanceLogEntry = null;
    let toastMessage = `${t.debtSaved || 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù….'}`;

    if (status === 'Ù…Ø¯ÙÙˆØ¹' || status === 'Paid') {
        newBalance = currentBalance - amount;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø³Ø§Ù„Ø¨
        if (newBalance < 0) {
             const confirmPay = confirm(t.warningNegativeBalanceDebt || "ØªØ­Ø°ÙŠØ±: Ø¯ÙØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… ÙŠØ¬Ø¹Ù„ Ø§Ù„Ø±ØµÙŠØ¯ Ø³Ø§Ù„Ø¨Ø§Ù‹. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ");
             if (!confirmPay) return;
        }

        balanceLogEntry = {
            type: 'Ø¯ÙØ¹ Ø§Ù„ØªØ²Ø§Ù…',
            amount: amount,
            desc: `${t.debtLogPrefix || 'Ø¯ÙØ¹ Ø§Ù„ØªØ²Ø§Ù…:'} ${type} - ${desc}`,
            date: date,
            balanceBefore: currentBalance,
            balanceAfter: newBalance,
            id: Date.now() + 0.1
        };
        toastMessage = `${t.debtPaid || 'ØªÙ… Ø¯ÙØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… ÙˆØ§Ù„Ø®ØµÙ… Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯'} ${amount.toLocaleString(currentLanguage)} ${currentCurrency.symbol}`;
    }

    // 2. Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    const debtEntry = {
        amount, type, desc, date, status, id: Date.now(),
        typeLabel: 'Ø§Ù„ØªØ²Ø§Ù…',
    };
    
    // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„Ø­ÙØ¸
    db.deb.unshift(debtEntry);
    currentBalance = newBalance;

    const savePromises = [saveData('deb', debtEntry)];
    if (balanceLogEntry) {
        db.bal.amount = newBalance;
        db.bal.changes.unshift(balanceLogEntry);
        savePromises.push(saveData('bal', db.bal));
    }

    Promise.all(savePromises).then(() => {
        updateBalanceDisplay();
        updateStats();
        // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
        document.getElementById('dAmount').value = '';
        document.getElementById('dType').value = '';
        document.getElementById('dDesc').value = '';
        document.getElementById('dDate').value = new Date().toISOString().slice(0, 16);
        document.getElementById('dStatus').value = '';
        document.getElementById('dDynamicFields').innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©

        toastMsg(toastMessage);
    }).catch(e => {
        console.error(e);
        toastMsg(t.errorDB || "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
    });
}

// ----------------------------------------------------
// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„
// ----------------------------------------------------

// ØªÙ… Ø­Ø°Ù ÙƒÙˆØ¯ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„ (openLog/renderLog/showDetail/prepareEdit) Ù„Ù„Ø§Ø®ØªØµØ§Ø±ØŒ Ø¨Ø§ÙØªØ±Ø§Ø¶ Ø£Ù†Ù‡ Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙŠØ¹Ù…Ù„. 
// Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø³ÙŠØ­ØªÙˆÙŠ Ø¹Ù„ÙŠÙ‡ ÙƒØ§Ù…Ù„Ø§Ù‹.


// ----------------------------------------------------
// ÙˆØ¸Ø§Ø¦Ù Ø¥Ø±ÙØ§Ù‚ Ø§Ù„ØµÙˆØ± (Ù„Ù… ØªØªØºÙŠØ±)
// ----------------------------------------------------

function showImageSourceModal() {
    openLayer('imageSource');
}

function openCameraInput() {
    closeLayer('imageSource');
    document.getElementById('eImgCamera').click();
}

function openGalleryInput() {
    closeLayer('imageSource');
    document.getElementById('eImgGallery').click();
}

function updateFileName(input, displayId) {
    if (input.files.length > 0) {
        const file = input.files[0];
        document.getElementById(displayId).textContent = `âœ… ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
        
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Base64
        const reader = new FileReader();
        reader.onload = (e) => {
            currentImageBase64 = e.target.result;
        };
        reader.readAsDataURL(file);
    } else {
        document.getElementById(displayId).textContent = '';
        currentImageBase64 = null;
    }
}

// ------------------------------------
// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø®Ù„ÙÙŠ
// ------------------------------------

window.onload = () => {
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        document.getElementById('darkModeToggle').checked = true;
    }
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±ØµÙŠØ¯
    if (localStorage.getItem('balanceHidden') === 'true') {
        balanceHidden = true;
    }

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù„ØºØ©
    updateUI(); 

    // ØªÙ‡ÙŠØ¦Ø© IndexedDB ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    initDB().then(() => {
        loadAllData().then(() => {
            updateUI(); // ØªØ­Ø¯ÙŠØ« Ù†Ù‡Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            updateStats(); 
        });
    });

    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒÙ‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    const now = new Date().toISOString().slice(0, 16);
    document.getElementById('eDate').value = now;
    document.getElementById('rDate').value = now;
    document.getElementById('dDate').value = now;

    // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ© ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
    document.getElementById('languageToggleTextSidebar').textContent = Translations[currentLanguage].languageToggleText;

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø­Ø¯Ø« Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø®Ù„Ù Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ ØºÙŠØ± Ø§Ù„Ù…Ù‚ØµÙˆØ¯
    window.history.pushState(null, null, window.location.href);
    window.addEventListener('popstate', handleBackNavigation);
};

// ===================================================
// ÙƒÙˆØ¯ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ (Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù„Ù)
// (Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù… ÙŠØªØºÙŠØ± ÙˆÙ„ÙƒÙ† ÙŠÙØ¹Ø§Ø¯ Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„ØªÙƒØ§Ù…Ù„)
// ===================================================

function openLog(type) {
    currentLog = type;
    document.getElementById('search').value = ''; 
    renderLog();
    openLayer('log');
}

function renderLog() {
    const t = Translations[currentLanguage];
    const container = document.getElementById('logContent');
    const search = document.getElementById('search').value.toLowerCase();
    const lang = currentLanguage;
    const formatOptions = { minimumFractionDigits: 0, maximumFractionDigits: 2 };

    let logs = [];
    let logTypeLabel = '';

    if (currentLog === 'exp') {
        logs = db.exp;
        logTypeLabel = t.tabExpenses;
    } else if (currentLog === 'rig') {
        logs = db.rig;
        logTypeLabel = t.tabRights;
    } else if (currentLog === 'deb') {
        logs = db.deb;
        logTypeLabel = t.tabDebts;
    } else {
        container.innerHTML = `<p style="text-align: center; color: #999; margin-top: 50px;">${t.selectLogType || 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¬Ù„.'}</p>`;
        return;
    }

    // ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨Ø­Ø«
    const filteredLogs = logs.filter(item => 
        item.desc.toLowerCase().includes(search) || 
        item.type.toLowerCase().includes(search)
    );

    if (filteredLogs.length === 0) {
        container.innerHTML = `<p style="text-align: center; color: #999; margin-top: 50px;">${t.noResults || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.'}</p>`;
        return;
    }

    let html = '';
    filteredLogs.forEach(item => {
        const dateDisplay = new Date(item.date).toLocaleDateString(lang);
        const timeDisplay = new Date(item.date).toLocaleTimeString(lang, { hour: '2-digit', minute: '2-digit' });
        const isExp = currentLog === 'exp';
        const isPaid = (currentLog === 'rig' && (item.status === 'ÙƒØ§Ù…Ù„' || item.status === 'Fully Paid')) || (currentLog === 'deb' && (item.status === 'Ù…Ø¯ÙÙˆØ¹' || item.status === 'Paid'));
        const isUnpaid = (currentLog === 'rig' && (item.status === 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹' || item.status === 'Unpaid')) || (currentLog === 'deb' && (item.status === 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹' || item.status === 'Unpaid'));
        const borderColor = isExp ? 'var(--danger)' : (isPaid ? 'var(--success)' : (isUnpaid ? 'var(--warning)' : 'var(--s)'));
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Ø§Ù„Ø­Ø§Ù„Ø©)
        let statusText = '';
        if (currentLog === 'rig' || currentLog === 'deb') {
             statusText = isPaid ? t.rStatusPaid : t.rStatusUnpaid;
        }

        html += `
            <div class="list-item" onclick="showDetail(${item.id}, '${currentLog}')" style="border-right: 5px solid ${borderColor};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: bold; color: var(--text-dark);">
                        ${item.type}
                    </span>
                    <span style="font-weight: bold; font-size: 1.1em; color: ${isExp ? 'var(--danger)' : (isPaid ? 'var(--success)' : 'var(--text-dark)')};">
                        ${item.amount.toLocaleString(lang, formatOptions)} ${currentCurrency.symbol}
                    </span>
                </div>
                <div class="details">
                    <span>${item.desc}</span>
                    <small style="color: #999;">${dateDisplay} ${timeDisplay}</small>
                </div>
                ${(currentLog === 'rig' || currentLog === 'deb') ? 
                    `<div style="font-size: 0.9em; color: ${isPaid ? 'var(--success)' : 'var(--warning)'}; text-align: ${lang === 'ar' ? 'right' : 'left'}; margin-top: 5px;">
                        <i class="fas fa-circle" style="font-size: 0.7em; margin-left: 5px;"></i> ${statusText}
                    </div>` : ''}
            </div>
        `;
    });
    container.innerHTML = html;
}

function showDetail(id, storeName) {
    const t = Translations[currentLanguage];
    const item = db[storeName].find(i => i.id === id);
    if (!item) return toastMsg(t.errorItemNotFound || "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„.");

    const lang = currentLanguage;
    const formatOptions = { minimumFractionDigits: 0, maximumFractionDigits: 2 };
    
    let detailContent = `<div class="card" style="border-top: 5px solid var(--p);">`;
    detailContent += `<h3 style="color: var(--p); margin-top: 0;">${item.typeLabel || item.type}</h3>`;
    detailContent += `<p><strong>${t.amount || 'Ø§Ù„Ù…Ø¨Ù„Øº'}:</strong> <span style="font-size: 1.1em; font-weight: bold; color: var(--danger);"> ${item.amount.toLocaleString(lang, formatOptions)} ${currentCurrency.symbol}</span></p>`;
    detailContent += `<p><strong>${t.type || 'Ø§Ù„Ù†ÙˆØ¹'}:</strong> ${item.type}</p>`;
    detailContent += `<p><strong>${t.description || 'Ø§Ù„ÙˆØµÙ/Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª'}:</strong> ${item.desc || (t.noDesc || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯')}</p>`;
    detailContent += `<p><strong>${t.date || 'Ø§Ù„ØªØ§Ø±ÙŠØ®'}:</strong> ${new Date(item.date).toLocaleDateString(lang)} - ${new Date(item.date).toLocaleTimeString(lang)}</p>`;
    
    if (storeName === 'rig' || storeName === 'deb') {
        const isPaid = (storeName === 'rig' && (item.status === 'ÙƒØ§Ù…Ù„' || item.status === 'Fully Paid')) || (storeName === 'deb' && (item.status === 'Ù…Ø¯ÙÙˆØ¹' || item.status === 'Paid'));
        const statusText = isPaid ? (t.rStatusPaid || t.dStatusPaid) : (t.rStatusUnpaid || t.dStatusUnpaid);
        detailContent += `<p><strong>${t.status || 'Ø§Ù„Ø­Ø§Ù„Ø©'}:</strong> <span style="font-weight: bold; color: ${isPaid ? 'var(--success)' : 'var(--warning)'};">${statusText}</span></p>`;
        
        if (!isPaid) {
            detailContent += `<button class="action" onclick="markAsPaid(${item.id}, '${storeName}')" style="background: var(--success);">
                <i class="fas fa-check" style="margin-left: 5px;"></i> ${storeName === 'rig' ? t.markAsCollected || 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ØµÙŠÙ„' : t.markAsPaid || 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹'}
            </button>`;
        }
    }

    if (storeName === 'exp' && item.imageBase64) {
        detailContent += `<p><strong>${t.invoiceImage || 'ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©'}:</strong></p>`;
        detailContent += `<img src="${item.imageBase64}" style="width: 100%; border-radius: 10px; margin-top: 10px; border: 1px solid var(--border-color);" alt="${t.invoiceImage || 'ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©'}">`;
    }
    
    detailContent += '</div>';

    detailContent += `<button class="secondary" onclick="prepareEdit(${item.id}, '${storeName}')">
        <i class="fas fa-edit" style="margin-left: 5px;"></i> ${t.btnEdit || 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„'}
    </button>`;
    detailContent += `<button class="secondary" onclick="confirmDelete(${item.id}, '${storeName}')" style="background: var(--danger); color: var(--text-light); border: none;">
        <i class="fas fa-trash-alt" style="margin-left: 5px;"></i> ${t.btnDelete || 'Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„'}
    </button>`;

    document.getElementById('detailContent').innerHTML = detailContent;
    openLayer('detail');
}

function confirmDelete(id, storeName) {
    const t = Translations[currentLanguage];
    if (confirm(t.confirmDelete || "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ")) {
        deleteTransaction(id, storeName);
    }
}

function deleteTransaction(id, storeName) {
    const t = Translations[currentLanguage];
    const item = db[storeName].find(i => i.id === id);
    if (!item) return;

    // 1. Ø¹ÙƒØ³ ØªØ£Ø«ÙŠØ± Ø§Ù„Ø±ØµÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ù‡ ØªØ£Ø«ÙŠØ±
    let amount = item.amount;
    let newBalance = currentBalance;
    let balanceChangeType = null;

    if (storeName === 'exp') {
        newBalance += amount;
        balanceChangeType = 'Ø®ØµÙ… Ù…ØµØ±ÙˆÙ';
    } else if (storeName === 'rig' && (item.status === 'ÙƒØ§Ù…Ù„' || item.status === 'Fully Paid')) {
        newBalance -= amount;
        balanceChangeType = 'ØªØ­ØµÙŠÙ„ Ø­Ù‚';
    } else if (storeName === 'deb' && (item.status === 'Ù…Ø¯ÙÙˆØ¹' || item.status === 'Paid')) {
        newBalance += amount;
        balanceChangeType = 'Ø¯ÙØ¹ Ø§Ù„ØªØ²Ø§Ù…';
    }

    // 2. ØªØ­Ø¯ÙŠØ« DB
    deleteData(storeName, id).then(() => {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        db[storeName] = db[storeName].filter(i => i.id !== id);
        
        if (balanceChangeType) {
            // Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„ Ù…Ù† Ø§Ù„Ù€ balance changes (Ù‚Ø¯ ÙŠÙƒÙˆÙ† ØµØ¹Ø¨Ø§Ù‹ØŒ Ù„Ø°Ø§ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙÙ‚Ø·)
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ© ÙˆØ­Ø°ÙÙ‡
            const logId = item.id + 0.1; 
            db.bal.changes = db.bal.changes.filter(log => !(log.type.includes(balanceChangeType.split(' ')[0]) && log.amount === amount && log.date === item.date));

            db.bal.amount = newBalance;
            currentBalance = newBalance;

            return saveData('bal', db.bal);
        }
    }).then(() => {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        loadAllData().then(() => { // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†Ø§Ø³Ù‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            updateBalanceDisplay();
            updateStats();
            closeLayer('detail');
            closeLayer('log'); 
            toastMsg(t.deleteSuccess || "ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­!");
        });
    }).catch(e => {
        console.error(e);
        toastMsg(t.errorDelete || "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù.");
    });
}

function markAsPaid(id, storeName) {
    const t = Translations[currentLanguage];
    const item = db[storeName].find(i => i.id === id);
    if (!item) return;
    
    if ((storeName === 'rig' && (item.status === 'ÙƒØ§Ù…Ù„' || item.status === 'Fully Paid')) || (storeName === 'deb' && (item.status === 'Ù…Ø¯ÙÙˆØ¹' || item.status === 'Paid'))) {
        return toastMsg(t.alreadyPaid || "ØªÙ… Ø§Ù„Ø¯ÙØ¹/Ø§Ù„ØªØ­ØµÙŠÙ„ Ù…Ø³Ø¨Ù‚Ø§Ù‹.");
    }

    // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯
    const amount = item.amount;
    let newBalance = currentBalance;
    let logType = '';

    if (storeName === 'rig') {
        newBalance += amount;
        item.status = 'ÙƒØ§Ù…Ù„'; // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø¬Ù„ Ù…Ø­Ù„ÙŠØ§Ù‹
        logType = 'ØªØ­ØµÙŠÙ„ Ø­Ù‚';
    } else if (storeName === 'deb') {
        newBalance -= amount;

         if (newBalance < 0) {
             const confirmPay = confirm(t.warningNegativeBalanceDebt || "ØªØ­Ø°ÙŠØ±: Ø¯ÙØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… ÙŠØ¬Ø¹Ù„ Ø§Ù„Ø±ØµÙŠØ¯ Ø³Ø§Ù„Ø¨Ø§Ù‹. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ");
             if (!confirmPay) return;
        }

        item.status = 'Ù…Ø¯ÙÙˆØ¹'; // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø¬Ù„ Ù…Ø­Ù„ÙŠØ§Ù‹
        logType = 'Ø¯ÙØ¹ Ø§Ù„ØªØ²Ø§Ù…';
    }
    
    // 2. Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø­Ø±ÙƒØ© Ø±ØµÙŠØ¯
    const balanceLogEntry = {
        type: logType,
        amount: amount,
        desc: `${logType === 'ØªØ­ØµÙŠÙ„ Ø­Ù‚' ? t.rightLogPrefix : t.debtLogPrefix} ${item.type} - ${item.desc}`,
        date: new Date().toISOString().slice(0, 16),
        balanceBefore: currentBalance,
        balanceAfter: newBalance,
        id: Date.now() + 0.1 
    };

    // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„Ø­ÙØ¸
    db.bal.amount = newBalance;
    db.bal.changes.unshift(balanceLogEntry);
    currentBalance = newBalance;

    Promise.all([
        updateData(storeName, item), // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ IndexedDB
        saveData('bal', db.bal)
    ]).then(() => {
        updateBalanceDisplay();
        updateStats();
        closeLayer('detail');
        renderLog();
        toastMsg(`${logType === 'ØªØ­ØµÙŠÙ„ Ø­Ù‚' ? t.collectSuccess : t.paySuccess} ${amount.toLocaleString(currentLanguage)} ${currentCurrency.symbol}`);
    }).catch(e => {
        console.error(e);
        toastMsg(t.errorDB || "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
    });
}

function prepareEdit(id, storeName) {
    const t = Translations[currentLanguage];
    const item = db[storeName].find(i => i.id === id);
    if (!item) return toastMsg(t.errorItemNotFound || "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„.");

    editMode = { id, storeName, oldItem: JSON.parse(JSON.stringify(item)) }; // Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©

    closeLayer('detail');
    document.getElementById('editModalTitle').textContent = `${t.btnEdit || 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„'}: ${item.typeLabel || item.type}`;

    document.getElementById('editExpForm').style.display = 'none';
    document.getElementById('editRigDebForm').style.display = 'none';

    if (storeName === 'exp') {
        document.getElementById('editExpForm').style.display = 'block';
        
        document.getElementById('eEditAmount').value = item.amount.toLocaleString(currentLanguage, { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        document.getElementById('eEditDesc').value = item.desc;
        document.getElementById('eEditDate').value = item.date.slice(0, 16);
        
        // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù†ÙˆØ§Ø¹
        const eEditTypeSelect = document.getElementById('eEditType');
        eEditTypeSelect.innerHTML = EXP_TYPES.map(type => 
            `<option value="${type}" ${item.type === type ? 'selected' : ''}>${type}</option>`
        ).join('');

        // Ø§Ù„ØµÙˆØ±Ø©
        if (item.imageBase64) {
            document.getElementById('eEditImgInfo').textContent = t.imageAttached || "ØµÙˆØ±Ø© Ù…Ø±ÙÙ‚Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø£Ùˆ Ø¥Ø²Ø§Ù„ØªÙ‡Ø§.";
            document.getElementById('eEditImgRemoveBtn').style.display = 'block';
            currentImageBase64 = item.imageBase64;
        } else {
            document.getElementById('eEditImgInfo').textContent = t.noImageAttached || "Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù…Ø±ÙÙ‚Ø©.";
            document.getElementById('eEditImgRemoveBtn').style.display = 'none';
            currentImageBase64 = null;
        }

    } else if (storeName === 'rig' || storeName === 'deb') {
        document.getElementById('editRigDebForm').style.display = 'block';

        const types = storeName === 'rig' ? RIG_TYPES : DEB_TYPES;
        const rdEditTypeSelect = document.getElementById('rdEditType');
        rdEditTypeSelect.innerHTML = types.map(type => 
            `<option value="${type}" ${item.type === type ? 'selected' : ''}>${type}</option>`
        ).join('');

        document.getElementById('rdEditAmount').value = item.amount.toLocaleString(currentLanguage, { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        document.getElementById('rdEditDesc').value = item.desc;
        document.getElementById('rdEditDate').value = item.date.slice(0, 16);

        // Ø§Ù„Ø­Ø§Ù„Ø©
        const rdEditStatusSelect = document.getElementById('rdEditStatus');
        if (storeName === 'rig') {
            rdEditStatusSelect.innerHTML = `
                <option value="ÙƒØ§Ù…Ù„" ${item.status === 'ÙƒØ§Ù…Ù„' || item.status === 'Fully Paid' ? 'selected' : ''}>${t.rStatusPaid}</option>
                <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹" ${item.status === 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹' || item.status === 'Unpaid' ? 'selected' : ''}>${t.rStatusUnpaid}</option>
            `;
        } else { // deb
            rdEditStatusSelect.innerHTML = `
                <option value="Ù…Ø¯ÙÙˆØ¹" ${item.status === 'Ù…Ø¯ÙÙˆØ¹' || item.status === 'Paid' ? 'selected' : ''}>${t.dStatusPaid}</option>
                <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹" ${item.status === 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹' || item.status === 'Unpaid' ? 'selected' : ''}>${t.dStatusUnpaid}</option>
            `;
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ ÙÙŠ Ø­Ø§Ù„ ÙˆØ¬ÙˆØ¯Ù‡ (Ù„Ù„ØªØ°ÙƒÙŠØ±)
        const isPaid = (storeName === 'rig' && (item.status === 'ÙƒØ§Ù…Ù„' || item.status === 'Fully Paid')) || (storeName === 'deb' && (item.status === 'Ù…Ø¯ÙÙˆØ¹' || item.status === 'Paid'));
        document.getElementById('rdEditPaidInfo').textContent = isPaid ? (t.paidInFull || 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„') : (t.notPaid || 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹');
        
        // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
        document.getElementById('rdEditDynamicFields').innerHTML = '';
    }

    openLayer('edit');
}

function removeEditImage(displayId) {
    const t = Translations[currentLanguage];
    currentImageBase64 = null;
    document.getElementById(displayId).textContent = t.imageRemoved || "ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø©. Ù„Ø§ ØªÙ†Ø³ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª.";
    document.getElementById('eEditImgRemoveBtn').style.display = 'none';
    document.getElementById('eEditImgNew').value = ''; 
}


function updateTransaction() {
    if (!editMode) return;
    const t = Translations[currentLanguage];
    const { id, storeName, oldItem } = editMode;
    
    // 1. Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    let newItem = { id: oldItem.id, date: oldItem.date, typeLabel: oldItem.typeLabel }; // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙˆÙŠØ©
    let oldAmount = oldItem.amount;
    let newAmount = 0;
    let oldStatus = oldItem.status;
    let newStatus = '';
    
    if (storeName === 'exp') {
        newAmount = getNumericAmount('eEditAmount');
        newItem.amount = newAmount;
        newItem.type = document.getElementById('eEditType').value;
        newItem.desc = document.getElementById('eEditDesc').value.trim();
        newItem.date = document.getElementById('eEditDate').value;
        newItem.imageBase64 = currentImageBase64;

        if (newAmount <= 0 || !newItem.type || !newItem.date) {
            return toastMsg(t.errorExpenseFields || "ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„Ù†ÙˆØ¹ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®.");
        }

    } else if (storeName === 'rig' || storeName === 'deb') {
        newAmount = getNumericAmount('rdEditAmount');
        newStatus = document.getElementById('rdEditStatus').value;
        newItem.amount = newAmount;
        newItem.type = document.getElementById('rdEditType').value;
        newItem.desc = document.getElementById('rdEditDesc').value.trim();
        newItem.date = document.getElementById('rdEditDate').value;
        newItem.status = newStatus;

        if (newAmount <= 0 || !newItem.type || !newItem.date || !newStatus) {
            return toastMsg(t.errorRightFields || t.errorDebtFields || "ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.");
        }
    }

    // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ø±ØµÙŠØ¯
    let balanceChange = 0;
    let logType = '';
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø¹ÙƒØ³ Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)
    if (storeName === 'exp') {
        balanceChange += oldAmount; // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø¯ÙŠÙ…
        balanceChange -= newAmount; // Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¬Ø¯ÙŠØ¯
        logType = 'Ù…ØµØ±ÙˆÙ';
    } else if (storeName === 'rig') {
        if (oldStatus === 'ÙƒØ§Ù…Ù„' || oldStatus === 'Fully Paid') balanceChange -= oldAmount; // Ø¹ÙƒØ³ Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…
        if (newStatus === 'ÙƒØ§Ù…Ù„' || newStatus === 'Fully Paid') balanceChange += newAmount; // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        logType = 'Ø­Ù‚';
    } else if (storeName === 'deb') {
        if (oldStatus === 'Ù…Ø¯ÙÙˆØ¹' || oldStatus === 'Paid') balanceChange += oldAmount; // Ø¹ÙƒØ³ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø¥Ø¶Ø§ÙØ©)
        if (newStatus === 'Ù…Ø¯ÙÙˆØ¹' || newStatus === 'Paid') balanceChange -= newAmount; // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø®ØµÙ…)
        logType = 'Ø§Ù„ØªØ²Ø§Ù…';

        // ÙØ­Øµ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø³Ø§Ù„Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        if (currentBalance + balanceChange < 0 && (newStatus === 'Ù…Ø¯ÙÙˆØ¹' || newStatus === 'Paid')) {
            const confirmNegative = confirm(t.warningNegativeBalance || "ØªØ­Ø°ÙŠØ±: Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¬Ø¹Ù„ Ø§Ù„Ø±ØµÙŠØ¯ Ø³Ø§Ù„Ø¨Ø§Ù‹. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ");
            if (!confirmNegative) return;
        }
    }

    // 3. ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    updateData(storeName, newItem).then(() => {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        const index = db[storeName].findIndex(i => i.id === id);
        if (index !== -1) {
            db[storeName][index] = newItem;
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ø±ØµÙŠØ¯
        if (balanceChange !== 0) {
            const newBalance = currentBalance + balanceChange;
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ­Ø°ÙÙ‡ (ØµØ¹Ø¨ØŒ Ù„Ø°Ø§ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«)
            // Ù†Ø­Ø¯Ø« Ø§Ù„Ø±ØµÙŠØ¯ ÙˆÙ†Ø¶ÙŠÙ Ø³Ø¬Ù„ Ø­Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯ ÙŠÙˆØ¶Ø­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            db.bal.amount = newBalance;
            currentBalance = newBalance;

            const adjustmentLog = {
                type: `${t.adjustment || 'ØªØ¹Ø¯ÙŠÙ„'} ${logType}`,
                amount: Math.abs(balanceChange),
                desc: `${t.adjustmentNote || 'ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¬Ù„ Ø±Ù‚Ù…'} ${id}. ${balanceChange > 0 ? t.added || 'Ø£Ø¶ÙŠÙ' : t.deducted || 'Ø®ØµÙ…'}: ${Math.abs(balanceChange).toLocaleString(currentLanguage)} ${currentCurrency.symbol}`,
                date: new Date().toISOString().slice(0, 16),
                balanceBefore: newBalance - balanceChange,
                balanceAfter: newBalance,
                id: Date.now() + 0.5 
            };
            db.bal.changes.unshift(adjustmentLog); 
            
            return saveData('bal', db.bal);
        }
    }).then(() => {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        loadAllData().then(() => {
            updateBalanceDisplay();
            updateStats();
            closeLayer('edit');
            renderLog();
            toastMsg(t.editSuccess || "ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
        });
    }).catch(e => {
        console.error(e);
        toastMsg(t.errorDB || "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
    });

}

</script>
</body>
</html>
