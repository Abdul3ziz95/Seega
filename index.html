<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ميزانيتك الذكية | Smart Budget</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">

<style>
/* ---------------------------------------------------- */
/* التنسيقات الأصلية الخاصة بك بدون أي تغيير في التصميم */
/* ---------------------------------------------------- */
:root{
    --p: #0077b6; --s: #48cae4; --bg: #f7f9fc;
    --danger: #ef476f; --success: #2a9d8f; --warning: #fbc02d;
    --text-dark: #333; --text-light: #f7f9fc;
    --shadow-light: 0 4px 8px rgba(0, 0, 0, 0.08);
    --shadow-hover: 0 6px 15px rgba(0, 0, 0, 0.15);
    --card-bg: #fff; --input-bg: #fff;
    --border-color: #ddd; --tab-active-bg: #fff;
}

body.dark-mode {
    --p: #90e0ef; --bg: #1f1f1f; --text-dark: #e0e0e0;
    --text-light: #1f1f1f; --card-bg: #2d2d2d; --input-bg: #3c3c3c;
    --border-color: #555;
}

* { box-sizing: border-box; }
body{
    margin:0; font-family: 'Tajawal', sans-serif;
    background: var(--bg); color: var(--text-dark);
    overflow-x: hidden; line-height: 1.6; transition: 0.3s;
}

header{
    background: var(--p); color: var(--text-light); padding: 15px;
    display: flex; justify-content: space-between; align-items: center;
    position: sticky; top: 0; z-index: 10;
}

.tabs{ display:flex; background: var(--card-bg); overflow-x: auto; }
.tabs button{
    flex: 1; padding: 15px 10px; border:none; background: var(--card-bg);
    color: var(--text-dark); font-weight: 700; font-size: 14px;
}
.tabs button.active{ color: var(--p); border-bottom: 3px solid var(--p); }

.section{ display:none; padding: 15px; }
.section.active{ display:block; }

.modal{
    position:fixed; top:0; left:0; width:100%; height:100%;
    background: var(--bg); display:none; flex-direction:column; z-index: 30;
}

.sidebar {
    position: fixed; top: 0; right: 0; width: 300px; height: 100%;
    background: var(--card-bg); transform: translateX(100%); transition: 0.4s; z-index: 25;
}
.sidebar.open { transform: translateX(0); }

/* إضافات لتحسين تجربة المستخدم */
.layer-active { overflow: hidden; }
</style>
</head>

<body>

<header>
    <button onclick="openSidebar()"><i class="fas fa-bars"></i></button> 
    <span class="title">ميزانيتك المالية الذكية</span>
    <button style="visibility: hidden;"><i class="fas fa-search"></i></button> 
</header>

<div class="tabs">
    <button class="active" onclick="openTab('overview')"><i class="fas fa-tachometer-alt"></i> لوحة القيادة</button>
    <button onclick="openTab('expenses')"><i class="fas fa-money-bill-wave"></i> مصروفات</button>
    <button onclick="openTab('rights')"><i class="fas fa-handshake"></i> حقوق</button>
    <button onclick="openTab('debts')"><i class="fas fa-file-invoice"></i> التزامات</button>
</div>

<div id="overview" class="section active">
    <div class="card" style="text-align:center; padding:30px;">
        <h2>الرصيد الحالي</h2>
        <p id="currentBalanceDisplay" style="font-size:38px; font-weight:800; color:var(--p);">0.00</p>
        <button onclick="toggleBalanceVisibility()"><i class="fas fa-eye"></i></button>
    </div>
    <div style="display:flex; gap:10px; margin-top:15px;">
        <button class="action" onclick="openBalanceActionModal('deposit')" style="background:var(--success); color:white; flex:1; padding:15px; border:none; border-radius:10px;">إيداع</button>
        <button class="action" onclick="openBalanceActionModal('withdraw')" style="background:var(--danger); color:white; flex:1; padding:15px; border:none; border-radius:10px;">سحب</button>
    </div>
    <div class="card" style="margin-top:20px;">
        <h3>ملخص مالي</h3>
        <p>إجمالي المصروفات: <b id="sExpTotal">0</b></p>
        <p>إجمالي الحقوق: <b id="sRigTotal">0</b></p>
        <p>إجمالي الالتزامات: <b id="sDebTotal">0</b></p>
    </div>
</div>

<div id="expenses" class="section">
    <div class="card">
        <input id="eAmount" type="number" placeholder="المبلغ">
        <select id="eType"><option>طعام</option><option>مواصلات</option><option>أخرى</option></select>
        <input id="eDesc" placeholder="الوصف">
        <button class="action" onclick="addExpense()" style="width:100%; background:var(--p); color:white; padding:15px; border:none; margin-top:10px;">حفظ المصروف</button>
    </div>
</div>

<script>
// ===================================================
// الإصلاحات البرمجية المدمجة في كودك الأصلي
// ===================================================

const IDB_NAME = "MySmartBudgetDB";
const IDB_VERSION = 4;
const STORE_NAMES = ["exp", "rig", "deb", "bal"];
let db = { exp: [], rig: [], deb: [], bal: { clientId: 1, amount: 0, changes: [] } };
let IDB_connection = null;

// وظيفة إصلاح الحسابات العشرية
const fixMath = (num) => Math.round(num * 100) / 100;

// نظام التنقل المحسن (زر الرجوع)
let historyStack = [];

function openLayer(layerId, data = {}) {
    const state = { layer: layerId, data: data };
    historyStack.push(state);
    history.pushState(state, null, `#${layerId}`);
    _showVisualLayer(layerId, data);
}

function _showVisualLayer(layerId, data) {
    // منطق إظهار النوافذ بناءً على IDs الخاصة بك
    if(layerId === 'sidebar') document.getElementById('appSidebar').classList.add('open');
    const modal = document.getElementById(layerId + 'Modal');
    if(modal) modal.style.display = 'flex';
}

window.onpopstate = function(event) {
    const closed = historyStack.pop();
    if(closed) {
        _hideVisualLayer(closed.layer);
    }
};

function _hideVisualLayer(layerId) {
    if(layerId === 'sidebar') document.getElementById('appSidebar').classList.remove('open');
    const modal = document.getElementById(layerId + 'Modal');
    if(modal) modal.style.display = 'none';
}

// دالة حفظ المصروف المعدلة بدقة الحسابات
async function addExpense() {
    const amt = parseFloat(document.getElementById('eAmount').value);
    if (!amt || amt <= 0) return alert("أدخل مبلغاً صحيحاً");

    const newExp = {
        id: Date.now(),
        amount: fixMath(amt),
        type: document.getElementById('eType').value,
        desc: document.getElementById('eDesc').value,
        date: new Date().toISOString()
    };

    // تحديث الرصيد بدقة
    db.bal.amount = fixMath(db.bal.amount - amt);
    
    await saveData('exp', newExp);
    await saveData('bal', db.bal);
    
    updateUI();
    alert("تم حفظ المصروف وخصمه من الرصيد");
}

// تهيئة قاعدة البيانات عند التحميل
async function init() {
    const request = indexedDB.open(IDB_NAME, IDB_VERSION);
    request.onsuccess = (e) => {
        IDB_connection = e.target.result;
        loadAllData();
    };
    // نفس منطق upgradeneeded الخاص بك...
}

function updateUI() {
    document.getElementById('currentBalanceDisplay').innerText = db.bal.amount.toLocaleString();
    // تحديث باقي الإحصائيات...
}

window.onload = init;
</script>
</body>
</html>
