<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ© | Smart Budget</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">

<style>
/* ---------------------------------------------------- */
/* Variables and Base Styling - LIGHT MODE (Default) */
/* ---------------------------------------------------- */
:root{
    --p: #0077b6; /* Primary Blue (Vibrant) */
    --s: #48cae4; /* Secondary Light Blue */
    --bg: #f7f9fc; /* Light Background */
    --danger: #ef476f; 
    --success: #2a9d8f;
    --warning: #fbc02d;
    --text-dark: #333;
    --text-light: #f7f9fc;
    --shadow-light: 0 4px 8px rgba(0, 0, 0, 0.08);
    --shadow-hover: 0 6px 15px rgba(0, 0, 0, 0.15);
    --card-bg: #fff;
    --input-bg: #fff;
    --border-color: #ddd;
    --tab-active-bg: #fff;
}

/* ---------------------------------------------------- */
/* Dark Mode Variables */
/* ---------------------------------------------------- */
body.dark-mode {
    --p: #90e0ef; /* Lighter Primary Blue for contrast */
    --s: #48cae4; 
    --bg: #1f1f1f; /* Dark Background */
    --danger: #ff8a80;
    --success: #66bb6a;
    --warning: #fbc02d;
    --text-dark: #e0e0e0; /* Light Text */
    --text-light: #1f1f1f;
    --shadow-light: 0 4px 10px rgba(0, 0, 0, 0.5);
    --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.8);
    --card-bg: #2d2d2d;
    --input-bg: #3c3c3c;
    --border-color: #555;
    --tab-active-bg: #2d2d2d;
}

/* ---------------------------------------------------- */
/* Global Reset and Base Styling */
/* ---------------------------------------------------- */
* {
    box-sizing: border-box;
}
body{
    margin:0;
    font-family: 'Tajawal', 'Arial', sans-serif;
    background: var(--bg);
    color: var(--text-dark);
    overflow-x: hidden;
    line-height: 1.6;
    transition: background 0.3s, color 0.3s;
}

/* Global Dark Mode Overrides for Specific Elements */
.card, .sidebar, .modal { background: var(--card-bg); }
.modal header { background: var(--card-bg); border-bottom: 1px solid var(--border-color); }

/* ---------------------------------------------------- */
/* Header & Navigation */
/* ---------------------------------------------------- */
header{
    background: var(--p);
    color: var(--text-light);
    padding: 15px;
    font-size: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-hover);
    position: sticky;
    top: 0;
    z-index: 10;
}
header .title { flex-grow: 1; text-align: center; font-weight: 800; }
header button {
    background: none; 
    border: none; 
    color: var(--text-light); 
    font-size: 20px; 
    cursor: pointer; 
    padding: 0 10px;
    transition: transform 0.2s;
}
header button:hover { transform: scale(1.1); }

.tabs{
    display:flex;
    background: var(--card-bg);
    border-bottom: 2px solid var(--border-color);
    box-shadow: var(--shadow-light);
    overflow-x: auto; 
    white-space: nowrap;
}
.tabs button{
    flex: 1 1 auto; 
    min-width: 0; 
    padding: 15px 10px;
    border:none;
    background: var(--card-bg);
    color: var(--text-dark);
    font-weight: 700;
    font-size: 14px;
    transition: all 0.3s;
    border-bottom: 3px solid transparent;
}
.tabs button.active{
    color: var(--p);
    border-bottom: 3px solid var(--p);
    background: color-mix(in srgb, var(--bg) 90%, var(--p)); 
}
body.dark-mode .tabs button.active {
    background: color-mix(in srgb, var(--bg) 85%, var(--p)); 
}

/* ---------------------------------------------------- */
/* General Layout & Cards */
/* ---------------------------------------------------- */
.section{ display:none; padding: 15px; }
.section.active{ display:block; }
.card{
    background:var(--card-bg);
    padding: 20px;
    border-radius: 15px;
    box-shadow: var(--shadow-light);
    margin-bottom: 15px;
    border-top: 5px solid var(--s); 
    transition: background 0.3s, border-color 0.3s;
}

/* ---------------------------------------------------- */
/* Overview Section Styling (New Dashboard) */
/* ---------------------------------------------------- */
#overview .balance-display {
    text-align: center;
    padding: 30px 20px;
    margin-bottom: 20px;
    border-radius: 15px;
    background: var(--card-bg);
    box-shadow: var(--shadow-hover);
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    align-items: center;
}
#overview .balance-display h2 {
    margin: 0 0 5px 0;
    font-size: 18px;
    color: #999;
}
#overview .balance-display p {
    font-size: 38px;
    font-weight: 800;
    margin: 5px 0 0 0;
    color: var(--p);
    display: flex;
    align-items: center;
}
#overview .balance-display button {
    background: none;
    border: none;
    color: var(--p);
    font-size: 24px;
    cursor: pointer;
    margin-right: 10px;
    transition: color 0.2s;
}
#overview .balance-display button:hover {
    color: var(--s);
}
#overview .balance-actions {
    display: flex;
    gap: 15px;
    margin-top: 10px;
}
#overview .balance-actions .action {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    color: var(--text-dark);
    border-radius: 10px;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-light);
    transition: all 0.2s;
    background: var(--input-bg);
}
#overview .balance-actions .action:hover {
    box-shadow: var(--shadow-hover);
    transform: translateY(-2px);
    border-color: var(--p);
}
#overview .balance-actions .action i {
    font-size: 24px;
    margin-bottom: 5px;
}
#overview .balance-actions .deposit i { color: var(--success); }
#overview .balance-actions .withdraw i { color: var(--danger); }

/* ---------------------------------------------------- */
/* Form Elements & Inputs */
/* ---------------------------------------------------- */
input, select, .datetime-container input[type="datetime-local"] {
    width: 100%;
    padding: 14px;
    margin: 8px 0;
    font-size: 16px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    box-sizing: border-box;
    background: var(--input-bg);
    color: var(--text-dark);
    transition: all 0.3s;
}
input:focus, select:focus, .datetime-container input[type="datetime-local"]:focus {
    border-color: var(--s);
    box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.2);
    outline: none;
}
body.dark-mode input:focus, body.dark-mode select:focus, body.dark-mode .datetime-container input[type="datetime-local"]:focus {
    box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.3);
}

.datetime-container { position: relative; width: 100%; margin: 8px 0; }
.datetime-container input[type="datetime-local"] { margin: 0; padding-left: 40px; }

.calendar-icon {
    position: absolute;
    top: 50%;
    left: 15px; 
    transform: translateY(-50%);
    font-size: 1.4em;
    z-index: 2;
    pointer-events: none; 
    color: var(--p); 
}

/* ---------------------------------------------------- */
/* Buttons & Actions */
/* ---------------------------------------------------- */
button.action{
    background: var(--p);
    color: var(--text-light);
    border: none;
    padding: 16px;
    width: 100%;
    border-radius: 10px;
    font-size: 18px;
    font-weight: bold;
    margin-top: 10px;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
    box-shadow: var(--shadow-light);
}
button.action:hover{
    background: color-mix(in srgb, var(--p) 85%, black); 
    transform: translateY(-2px);
}

button.secondary{
    background: var(--input-bg);
    color: var(--text-dark);
    padding: 12px;
    width: 100%;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    margin-top: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s;
}
button.secondary:hover {
    background: color-mix(in srgb, var(--input-bg) 80%, #999); 
}

/* ---------------------------------------------------- */
/* Utility & Custom Elements */
/* ---------------------------------------------------- */
.toast{
    position:fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: var(--text-light);
    padding: 12px 25px;
    border-radius: 30px;
    display:none;
    z-index: 100;
    font-size: 15px;
    box-shadow: var(--shadow-hover);
    white-space: nowrap;
}

.currency-symbol { color: var(--p); font-weight: bold; font-size: 1.1em; margin-right: 5px; }
.hidden-balance { font-size: 38px; font-weight: 800; letter-spacing: 5px; color: var(--p); }

/* ---------------------------------------------------- */
/* Modals and Sidebar Refinements */
/* ---------------------------------------------------- */
.modal{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background: var(--bg);
    display:none;
    flex-direction:column;
    z-index: 30;
    overflow-y: auto;
}
.modal header{
    display:flex;
    gap: 10px;
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    background: var(--card-bg);
    align-items: center;
    box-shadow: var(--shadow-light);
    position: sticky;
    top: 0;
    z-index: 35;
}
.modal header .title { flex-grow: 1; text-align: center; font-weight: 700; }
.modal header button {
    background: none; 
    border: none; 
    color: var(--text-dark); 
    font-size: 20px; 
    cursor: pointer; 
    padding: 0 10px;
}
.modal-content {
    flex-grow: 1;
    padding: 15px;
}

.sidebar {
    position: fixed;
    top: 0;
    right: 0; 
    width: 300px; 
    max-width: 85%;
    height: 100%;
    background: var(--card-bg);
    box-shadow: -4px 0 12px rgba(0, 0, 0, 0.2);
    transform: translateX(100%); 
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
    z-index: 25; 
    display: flex;
    flex-direction: column;
}
.sidebar.open { transform: translateX(0); }

/* Switch Style (Dark Mode) */
.switch-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    font-size: 17px;
    color: var(--text-dark);
}

.switch { position: relative; display: inline-block; width: 45px; height: 25px; }
.switch input {opacity: 0; width: 0; height: 0;}
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: var(--border-color); transition: .4s; border-radius: 25px;
}
.slider:before {
    position: absolute; content: ""; height: 19px; width: 19px; left: 3px; bottom: 3px;
    background-color: white; transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: var(--p); }
input:checked + .slider:before { transform: translateX(20px); }


/* Sidebar */
.sidebar-header {
    padding: 15px;
    background: var(--p);
    color: var(--text-light);
    font-size: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
}
.sidebar-content {
    flex-grow: 1;
    padding: 15px 0;
    overflow-y: auto;
}

.sidebar-menu-item {
    padding: 15px 20px;
    margin: 5px 0;
    display: flex;
    align-items: center;
    justify-content: space-between; 
    gap: 15px;
    font-size: 17px;
    color: var(--text-dark);
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
}

.sidebar-menu-item:hover {
    background: var(--s);
    color: var(--text-dark); 
}
.sidebar-menu-item i { font-size: 1.2em; }

.sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    z-index: 24;
}
.sidebar-overlay.open { display: block; }

/* Small Image Source Modal */
#imageSourceModal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80%;
    max-width: 350px;
    height: auto;
    background: var(--card-bg);
    border-radius: 15px;
    box-shadow: var(--shadow-hover);
    padding: 20px;
    z-index: 150;
    display: none;
    flex-direction: column;
    align-items: center;
}
#imageSourceModal h3 {
    margin-top: 0;
    color: var(--p);
    text-align: center;
}
#imageSourceModal button {
    margin: 10px 0;
    padding: 15px;
    font-size: 16px;
    border-radius: 10px;
    width: 100%;
}

/* Toast Animation */
.toast.show{
    display:block;
    animation: fadeInOut 2.5s ease-in-out forwards;
}

@keyframes fadeInOut {
    0% { opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { opacity: 0; }
}

/* List Item */
.list-item{
    background: var(--card-bg);
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    border-right: 5px solid var(--s); 
    color: var(--text-dark);
}
.list-item:hover {
    background: color-mix(in srgb, var(--card-bg) 95%, #999);
    box-shadow: var(--shadow-light);
}
.list-item .details {
    font-size: 0.9em; 
    color: #666; 
    text-align: right;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 5px;
}
.list-item .amount.expense { color: var(--danger); font-weight: bold; }
.list-item .amount.right { color: var(--success); font-weight: bold; }
.list-item .amount.debt { color: var(--warning); font-weight: bold; }

/* ---------------------------------------------------- */
/* Responsive Fix for Tabs (Small Screens) */
/* ---------------------------------------------------- */
@media (max-width: 450px) {
    .tabs button {
        padding: 15px 5px; 
        font-size: 13px; 
    }
}
</style>
</head>

<body onload="App.init()">

<header>
    <button onclick="App.openSidebar()"><i class="fas fa-bars"></i></button> 
    <span class="title">Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</span>
    <button style="visibility: hidden;"><i class="fas fa-search"></i></button> 
</header>

<div class="tabs">
    <button class="active" onclick="App.openTab('overview')">
        <i class="fas fa-tachometer-alt" style="margin-left: 5px;"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©
    </button>
    <button onclick="App.openTab('expenses')">
        <i class="fas fa-money-bill-wave" style="margin-left: 5px;"></i> Ù…ØµØ±ÙˆÙØ§Øª
    </button>
    <button onclick="App.openTab('rights')">
        <i class="fas fa-handshake" style="margin-left: 5px;"></i> Ø­Ù‚ÙˆÙ‚
    </button>
    <button onclick="App.openTab('debts')">
        <i class="fas fa-file-invoice" style="margin-left: 5px;"></i> Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    </button>
</div>

<div id="overview" class="section active">
    <div class="balance-display">
        <h2>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
        <p id="currentBalanceDisplay">
            <i class="fas fa-spinner fa-spin"></i>
        </p>
        <button onclick="App.toggleBalanceVisibility()" id="balanceVisibilityToggle" title="Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±ØµÙŠØ¯">
             <i class="fas fa-eye"></i>
        </button>
    </div>

    <div class="balance-actions">
        <button class="action deposit" onclick="App.openBalanceActionModal('deposit')">
            <i class="fas fa-plus-circle"></i> Ø¥ÙŠØ¯Ø§Ø¹
        </button>
        <button class="action withdraw" onclick="App.openBalanceActionModal('withdraw')">
            <i class="fas fa-minus-circle"></i> Ø³Ø­Ø¨
        </button>
    </div>
    
    <button class="secondary" onclick="App.openBalanceLogModal()" style="margin-top: 15px;">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯
    </button>
    <div class="card" style="margin-top: 20px; border-top: 5px solid var(--p);">
        <h3 style="color: var(--p); margin-top: 0;"><i class="fas fa-calculator" style="margin-left: 5px;"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
        <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (ØªØ´Ù…Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª):</span> <b id="sExpTotal">0</b></p>
        <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©:</span> <b id="sRigTotal">0</b></p>
        <p><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©:</span> <b id="sDebTotal">0</b></p>
        <p><span>Ø§Ù„Ù…Ø­ØµÙ„ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ‚:</span> <b id="sRigPaid">0</b></p>
        <p><span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª:</span> <b id="sDebPaid">0</b></p>
        </div>
</div>

<div id="expenses" class="section">
    <div class="card">
    <p style="color: var(--danger); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡Ø§ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙˆØ±Ø§Ù‹</p>
    <input id="eAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="App.formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
    <select id="eType">
    <option value="">ğŸ›’ Ø§Ù„ÙØ¦Ø© (Ù†ÙÙ‚Ø§Øª Ù…ØªØºÙŠØ±Ø©)</option>
    <option>Ø·Ø¹Ø§Ù…</option><option>Ù…ÙˆØ§ØµÙ„Ø§Øª</option>
    <option>Ø±Ø¹Ø§ÙŠØ© Ø´Ø®ØµÙŠØ©</option><option>Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
    <option>ØµØ­Ø©</option><option>ØªØ±ÙÙŠÙ‡</option><option>ØªØ³ÙˆÙ‚</option>
    <option>ØªØ¹Ù„ÙŠÙ…</option><option>ØµÙŠØ§Ù†Ø© ÙˆØ¥ØµÙ„Ø§Ø­</option><option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="eDesc" placeholder="ğŸ“ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
    <div class="datetime-container">
        <input id="eDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    
    <button class="secondary" onclick="App.showImageSourceModal()">
        <i class="fas fa-camera" style="margin-left: 5px;"></i> Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    </button>
    <span id="eImgName" style="display: block; font-size: 0.8em; color: var(--success); text-align: right; margin-top: 5px;"></span>
    <input type="file" id="eImgCamera" accept="image/*" capture="camera" style="display: none;" onchange="App.updateFileName(this, 'eImgName')">
    <input type="file" id="eImgGallery" accept="image/*" style="display: none;" onchange="App.updateFileName(this, 'eImgName')">
    <button class="action" onclick="App.addExpense()">
        <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ
    </button>
    <button class="secondary" onclick="App.openLog('exp')">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
    </button>
    </div>
</div>

<div id="rights" class="section">
    <div class="card">
    <p style="color: var(--success); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„Ø© (Ø¯ÙØ¹ Ø§Ù„Ø¯ÙŠÙ†/Ø§Ù„Ø¢Ø¬Ù„) ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
    <select id="rType" onchange="App.updateRightFields(this.value)">
    <option value="">ğŸ¤ Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚</option>
    <option>Ø¯ÙŠÙ†</option>
    <option>Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„</option>
    <option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="rAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚ (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ)" oninput="App.formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
    <div id="rDynamicFields"></div>
    <input id="rDesc" placeholder="ğŸ‘¤ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ù„Ù…Ø¯ÙŠÙ†/Ø§Ù„Ø¬Ù‡Ø©)">
    <div class="datetime-container">
        <input id="rDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    <select id="rStatus">
    <option value="">âœ… Ø§Ù„Ø­Ø§Ù„Ø©</option>
    <option value="ÙƒØ§Ù…Ù„">Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</option>
    <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ Ø¨Ø¹Ø¯</option>
    </select>
    <button class="action" onclick="App.addRight()">
        <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ø­Ù‚
    </button>
    <button class="secondary" onclick="App.openLog('rig')">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ‚
    </button>
    </div>
</div>

<div id="debts" class="section">
    <div class="card">
    <p style="color: var(--danger); font-weight: bold; font-size: 0.9em; text-align: right;">* Ø¯ÙØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙŠØªÙ… Ø®ØµÙ…Ù‡ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
    <select id="dType" onchange="App.updateDebtFields(this.value)">
    <option value="">ğŸ§¾ Ù†ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</option>
    <option>Ø¥ÙŠØ¬Ø§Ø±</option>
    <option>ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
    <option>Ù…Ø§Ø¡</option>
    <option>Ø¥Ù†ØªØ±Ù†Øª</option>
    <option>Ù‚Ø±Ø¶</option> <option>Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ</option> <option>Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø© Ø£Ø®Ø±Ù‰</option>
    <option>Ø£Ø®Ø±Ù‰</option>
    </select>
    <input id="dAmount" type="text" placeholder="ğŸ’µ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©/Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ" oninput="App.formatAmount(this)" pattern="[0-9]*" inputmode="decimal">

    <div id="dDynamicFields"></div>
    <input id="dDesc" placeholder="ğŸ¢ ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ù„Ø¯Ø§Ø¦Ù†/Ø§Ù„Ø¬Ù‡Ø©)">
    <div class="datetime-container">
        <input id="dDate" type="datetime-local">
        <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
    </div>
    <select id="dStatus">
    <option value="">âœ… Ø§Ù„Ø­Ø§Ù„Ø©</option>
    <option value="Ù…Ø¯ÙÙˆØ¹">Ù…Ø¯ÙÙˆØ¹</option>
    <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
    </select>
    <button class="action" onclick="App.addDebt()">
        <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…
    </button>
    <button class="secondary" onclick="App.openLog('deb')">
        <i class="fas fa-history" style="margin-left: 5px;"></i> Ø³Ø¬Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    </button>
    </div>
</div>

<div class="modal" id="logModal">
    <header>
        <input id="search" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„..." oninput="App.renderLog()">
        <button onclick="App.closeLayer('log')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content" id="logContent"></div>
</div>

<div class="modal" id="detailModal">
    <header>
        <span class="title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</span>
        <button onclick="App.closeLayer('detail')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content detail" id="detailContent"></div>
</div>

<div class="modal" id="balanceActionModal">
    <header>
        <span class="title" id="actionModalTitle"></span>
        <button onclick="App.closeLayer('balanceAction')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <p style="text-align: center; font-size: 1.1em;">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="currentBalanceInAction" style="color: var(--p); font-weight: bold;"></span></p>
        <input id="bAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="App.formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
        <input id="bDesc" placeholder="ğŸ“ ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Ù…Ø«Ù„: Ø±Ø§ØªØ¨ØŒ ØªØ­ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ)">
        <div class="datetime-container">
            <input id="bDate" type="datetime-local">
            <span class="calendar-icon"><i class="far fa-calendar-alt"></i></span>
        </div>
        <button class="action" onclick="App.processBalanceAction()">
            <i class="fas fa-check" style="margin-left: 5px;"></i> ØªÙ†ÙÙŠØ°
        </button>
    </div>
</div>

<div class="modal" id="balanceLogModal">
    <header>
        <span class="title">Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯</span>
        <button onclick="App.closeLayer('balanceLog')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content" id="balanceLogContent">
        </div>
</div>

<div id="imageSourceModal">
    <h3 style="margin-bottom: 20px;">Ø§Ø®ØªÙŠØ§Ø± Ù…ØµØ¯Ø± Ø§Ù„ØµÙˆØ±Ø©</h3>
    <button class="action" onclick="App.openCameraInput()"><i class="fas fa-camera" style="margin-left: 10px;"></i> Ø§Ù„ØªÙ‚Ø§Ø· Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
    <button class="secondary" onclick="App.openGalleryInput()"><i class="fas fa-images" style="margin-left: 10px;"></i> Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ø¶</button>
    <button class="secondary" style="background: none; border: none; color: var(--danger); margin-top: 10px;" onclick="App.closeLayer('imageSource')">Ø¥Ù„ØºØ§Ø¡</button>
</div>
<div class="sidebar-overlay" id="imageSourceOverlay" style="z-index: 140; display: none;" onclick="App.closeLayer('imageSource')"></div>

<div class="toast" id="toast"></div>

<div class="sidebar-overlay" onclick="App.closeLayer('sidebar')"></div>

<div class="sidebar" id="appSidebar">
    <div class="sidebar-header">
        <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        <button onclick="App.closeLayer('sidebar')"><i class="fas fa-times"></i></button>
    </div>
    <div class="sidebar-content">
        <div class="card" style="margin: 0 15px 15px; border-top: 5px solid var(--s);">
             <p style="font-weight: bold; margin-top: 0; color: var(--p);">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</p>
             
             <div class="switch-container">
                 <i class="fas fa-moon" style="margin-left: 10px;"></i> <span>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span>
                 <label class="switch">
                     <input type="checkbox" id="darkModeToggle" onclick="App.toggleDarkMode()">
                     <span class="slider"></span>
                 </label>
             </div>
             
             <button class="secondary" onclick="App.openCurrencyModal()" style="display: flex; justify-content: space-between; align-items: center; border: none; background: var(--card-bg); margin-top: 15px;">
                 <span id="currentCurrencyDisplay" style="font-weight: bold;">Ø§Ù„Ø¹Ù…Ù„Ø©: Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ (Ø±.Ø³)</span>
                 <span style="color: var(--p);"><i class="fas fa-exchange-alt"></i> ØªØºÙŠÙŠØ±</span>
             </button>
        </div>
        
        <div class="sidebar-menu-item" onclick="App.exportData()">
            <i class="fas fa-file-export"></i> <span>ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</span>
        </div>
        
        <div class="sidebar-menu-item" onclick="document.getElementById('importFile').click()">
            <i class="fas fa-file-import"></i> <span>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</span>
        </div>
        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="App.importData(event)">
        
        <div class="sidebar-menu-item" onclick="App.openAboutModal()">
            <i class="fas fa-info-circle"></i> <span>Ø­ÙˆÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>
        </div>
        
        <div class="sidebar-menu-item" onclick="App.confirmResetData()" style="color: var(--danger);">
            <i class="fas fa-exclamation-triangle"></i> <span>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        </div>
    </div>
</div>

<div class="modal" id="aboutModal">
    <header>
        <h3 style="color: var(--p);">Ø­ÙˆÙ„ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ©</h3>
        <button onclick="App.closeLayer('about')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <p>ØªØ·Ø¨ÙŠÙ‚ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© Ù‡Ùˆ Ø£Ø¯Ø§Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ ØªØªØ¨Ø¹:</p>
        <ul>
            <li><i class="fas fa-wallet" style="color: var(--s);"></i> **Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø©** Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.</li>
            <li><i class="fas fa-receipt" style="color: var(--s);"></i> **Ø§Ù„Ø­Ù‚ÙˆÙ‚** Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ù„Ùƒ (Ø¯ÙŠÙˆÙ†ØŒ Ø¨ÙŠØ¹ Ø¢Ø¬Ù„).</li>
            <li><i class="fas fa-clipboard-list" style="color: var(--s);"></i> **Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª** Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ø¹Ù„ÙŠÙƒ (ÙÙˆØ§ØªÙŠØ±ØŒ Ø£Ù‚Ø³Ø§Ø·ØŒ Ù‚Ø±ÙˆØ¶).</li>
        </ul>
        <p class="card" style="border-top: 3px solid var(--danger);">
            <strong>Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©:</strong> ÙŠØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ© IndexedDBØŒ ÙˆÙ„Ø§ ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ø£ÙŠ Ø®Ø§Ø¯Ù… Ø®Ø§Ø±Ø¬ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ.
        </p>
        <p style="text-align: center; margin-top: 20px; color: #999; font-size: 0.9em;">Ø§Ù„Ø¥ØµØ¯Ø§Ø± 4.0 (Ù…Ø·ÙˆØ± ÙˆÙ…Ø«Ø¨Øª)</p>
    </div>
</div>

<div class="modal" id="currencyModal">
    <header>
        <h3 style="color: var(--p);">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø©</h3>
        <button onclick="App.closeLayer('currency')"><i class="fas fa-times"></i></button>
    </header>
    <div class="modal-content">
        <input id="currencySearch" type="text" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„Ø© (Ø±ÙŠØ§Ù„ØŒ Ø¬Ù†ÙŠÙ‡ØŒ Ø¯ÙˆÙ„Ø§Ø±...)" oninput="App.renderCurrencyList()">
        <div id="currencyList">
            </div>
    </div>
</div>

<script>
// ===================================================
// 1. IndexedDB Wrapper - Modern Async/Await Logic
// ===================================================
class SmartBudgetDB {
    constructor(dbName, version, stores) {
        this.dbName = dbName;
        this.version = version;
        this.stores = stores;
        this.db = null;
    }

    // Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Promise Ù„Ù€ async/await
    connect() {
        return new Promise((resolve, reject) => {
            if (!window.indexedDB) {
                return reject(new Error("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… IndexedDB. Ù„Ù† ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª."));
            }
            if (this.db) return resolve(this.db);

            const request = indexedDB.open(this.dbName, this.version);

            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                this.stores.forEach(storeName => {
                    if (db.objectStoreNames.contains(storeName)) {
                        db.deleteObjectStore(storeName);
                    }
                    // 'bal' store uses 'clientId' as keyPath and is not auto-incremented
                    const keyPath = (storeName === 'bal') ? 'clientId' : 'id';
                    const autoIncrement = (storeName !== 'bal');
                    const store = db.createObjectStore(storeName, { keyPath, autoIncrement });
                    
                    if(storeName === 'bal') {
                        store.add({ clientId: 1, amount: 0, changes: [] });
                    }
                });
            };

            request.onsuccess = (event) => {
                this.db = event.target.result;
                resolve(this.db);
            };

            request.onerror = (event) => {
                console.error("IndexedDB connection error:", event.target.error);
                reject(event.target.error);
            };
        });
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
    _transact(storeName, mode = "readonly") {
        if (!this.db) throw new Error("Database not connected.");
        return this.db.transaction(storeName, mode).objectStore(storeName);
    }

    // Ø­ÙØ¸/ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (put) Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Promise
    put(storeName, data) {
        return new Promise((resolve, reject) => {
            try {
                const store = this._transact(storeName, "readwrite");
                const request = store.put(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            } catch (error) {
                reject(error);
            }
        });
    }

    // Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (delete) Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Promise
    delete(storeName, id) {
        return new Promise((resolve, reject) => {
            try {
                const store = this._transact(storeName, "readwrite");
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e.target.error);
            } catch (error) {
                reject(error);
            }
        });
    }

    // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ø®Ø²Ù† (getAll) Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Promise
    getAll(storeName) {
        return new Promise((resolve, reject) => {
            try {
                const store = this._transact(storeName, "readonly");
                const request = store.getAll();
                request.onsuccess = (e) => {
                     // Balance store is always a single object
                    if(storeName === 'bal') {
                        const result = e.target.result[0];
                        return resolve(result || { clientId: 1, amount: 0, changes: [] });
                    }
                    // Reverse for chronological order (newest first)
                    resolve(e.target.result.reverse());
                };
                request.onerror = (e) => reject(e.target.error);
            } catch (error) {
                reject(error);
            }
        });
    }

    // Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø®Ø§Ø²Ù†
    clearAll() {
        return new Promise(async (resolve, reject) => {
            try {
                const transaction = this.db.transaction(this.stores, "readwrite");
                await Promise.all(this.stores.map(storeName => {
                    return new Promise((res, rej) => {
                        const request = transaction.objectStore(storeName).clear();
                        request.onsuccess = res;
                        request.onerror = rej;
                    });
                }));

                // Re-initialize balance store after clearing
                await this.put('bal', { clientId: 1, amount: 0, changes: [] }); 

                resolve();
            } catch (error) {
                reject(error);
            }
        });
    }
}

// ===================================================
// 2. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
// ===================================================

const IDB_NAME = "MySmartBudgetDB";
const IDB_VERSION = 5; // ØªÙ… Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡ÙŠÙƒÙ„ÙŠØ©
const STORE_NAMES = ["exp", "rig", "deb", "bal"]; 

const Database = new SmartBudgetDB(IDB_NAME, IDB_VERSION, STORE_NAMES);

// ÙƒØ§Ø¦Ù† Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚
const AppState = {
    db: { exp: [], rig: [], deb: [], bal: { clientId: 1, amount: 0, changes: [] } },
    currentBalance: 0,
    currentLog: "",
    editMode: null, // { type: 'exp', index: 5 }
    balanceActionType: null,
    balanceHidden: localStorage.getItem('balanceHidden') === 'true',
    
    // Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ù‚Ù„ (Layers & Modals)
    LAYERS: {
        'sidebar': { elementId: 'appSidebar', type: 'menu' },
        'log': { elementId: 'logModal', type: 'modal' },
        'detail': { elementId: 'detailModal', type: 'modal' },
        'currency': { elementId: 'currencyModal', type: 'modal' },
        'about': { elementId: 'aboutModal', type: 'modal' },
        'balanceAction': { elementId: 'balanceActionModal', type: 'modal' },
        'balanceLog': { elementId: 'balanceLogModal', type: 'modal' }, 
        'imageSource': { elementId: 'imageSourceModal', type: 'menu' } 
    },
    historyStack: [],
    
    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Øª
    ARABIC_CURRENCIES: [
        { code: 'SAR', symbol: 'Ø±.Ø³', name: 'Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ' },
        { code: 'EGP', symbol: 'Ø¬.Ù…', name: 'Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ' },
        { code: 'AED', symbol: 'Ø¯.Ø¥', name: 'Ø¯Ø±Ù‡Ù… Ø¥Ù…Ø§Ø±Ø§ØªÙŠ' },
        { code: 'KWD', symbol: 'Ø¯.Ùƒ', name: 'Ø¯ÙŠÙ†Ø§Ø± ÙƒÙˆÙŠØªÙŠ' },
        { code: 'USD', symbol: '$', name: 'Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ' },
        { code: 'QAR', symbol: 'Ø±.Ù‚', name: 'Ø±ÙŠØ§Ù„ Ù‚Ø·Ø±ÙŠ' },
        { code: 'OMR', symbol: 'Ø±.Ø¹.', name: 'Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ' },
        { code: 'JOD', symbol: 'Ø¯.Ø§', name: 'Ø¯ÙŠÙ†Ø§Ø± Ø£Ø±Ø¯Ù†ÙŠ' },
        { code: 'EUR', symbol: 'â‚¬', name: 'ÙŠÙˆØ±Ùˆ' },
    ],
    currentCurrency: null
};

// ===================================================
// 3. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Main Application Logic)
// ===================================================
const App = {
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    async init() {
        App.loadDarkModePreference();
        App.loadCurrencyPreference();
        try {
            await Database.connect();
            await App.loadAllData();
            App.updateStats(); 
            App.updateBalanceDisplay();
            App.toastMsg("ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.");
        } catch (error) {
            App.toastMsg("Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: " + error.message);
            console.error(error);
        }
    },

    // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† IndexedDB Ø¨Ø¹Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„
    async loadAllData() {
        const [expData, rigData, debData, balData] = await Promise.all([
            Database.getAll('exp'),
            Database.getAll('rig'),
            Database.getAll('deb'),
            Database.getAll('bal'),
        ]);
        AppState.db.exp = expData;
        AppState.db.rig = rigData;
        AppState.db.deb = debData;
        AppState.db.bal = balData;
        AppState.currentBalance = AppState.db.bal.amount || 0;
    },

    // --------------------------------------------------
    // ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±ØµÙŠØ¯
    // --------------------------------------------------

    // Ø¥Ø¶Ø§ÙØ©/Ø®ØµÙ… Ù…Ø¨Ù„Øº Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ (Async)
    async updateBalance(amount, description, date, type, linkId = null) {
        AppState.currentBalance += amount;
        AppState.db.bal.amount = AppState.currentBalance;

        // Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ© Ø¥Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ø±ØµÙŠØ¯
        const change = {
            id: Date.now(), // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ§Ø±ÙŠØ® ÙƒÙ€ ID Ù…Ø¤Ù‚Øª Ù„Ù„Ø­Ø±ÙƒØ©
            amount: amount,
            desc: description,
            date: date,
            type: type, // 'deposit', 'withdraw', 'expense', 'right', 'debt'
            linkId: linkId, // Ø±Ø¨Ø· Ø¨Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù†Øª Ø­Ø±ÙƒØ© ØªØ¨Ø¹ÙŠØ©
        };
        AppState.db.bal.changes.unshift(change); // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)

        try {
            await Database.put('bal', AppState.db.bal);
            App.updateBalanceDisplay();
            App.updateStats(); 
            return true;
        } catch (error) {
            App.toastMsg("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯!");
            console.error(error);
            return false;
        }
    },

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹/Ø§Ù„Ø³Ø­Ø¨ Ù…Ù† Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø±ØµÙŠØ¯ (Async)
    async processBalanceAction() {
        const amountEl = document.getElementById('bAmount');
        const descEl = document.getElementById('bDesc');
        const dateEl = document.getElementById('bDate');

        const amount = App.parseAmount(amountEl.value);
        const description = descEl.value.trim();
        const date = dateEl.value || new Date().toISOString().slice(0, 16);
        const type = AppState.balanceActionType;

        if (!amount || amount <= 0) return App.toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­.");
        if (!description) return App.toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØµÙ Ù„Ù„Ø¹Ù…Ù„ÙŠØ©.");

        const finalAmount = type === 'deposit' ? amount : -amount;

        if (type === 'withdraw' && AppState.currentBalance + finalAmount < 0) {
            return App.toastMsg("Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ Ù„ØªÙ†ÙÙŠØ° Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø³Ø­Ø¨.");
        }

        try {
            await App.updateBalance(finalAmount, description, date, type);
            App.toastMsg(type === 'deposit' ? "ØªÙ… Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø¨Ù†Ø¬Ø§Ø­!" : "ØªÙ… Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­!");
            App.closeLayer('balanceAction');
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            amountEl.value = descEl.value = dateEl.value = '';
        } catch (e) {
            App.toastMsg("ÙØ´Ù„ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.");
        }
    },

    // --------------------------------------------------
    // ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª (Async)
    // --------------------------------------------------

    async addTransaction(storeName, data, balanceUpdate = 0) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø±ÙŠØ±
        if (AppState.editMode) {
            const { type, index } = AppState.editMode;
            // Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø§Ù„Ù…ÙØ¹Ø¯Ù„Ø©
            data.id = AppState.db[type][index].id;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯: ÙŠØ¬Ø¨ Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯
            // *ØªØ¬Ø§Ù‡Ù„ Ù…Ù†Ø·Ù‚ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø¹Ù‚Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹ ÙˆØ§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ ØªØ­Ø¯ÙŠØ« IndexedDB*
            // ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ù…ØªØ·ÙˆØ±ØŒ ÙŠØ¬Ø¨ Ø¹ÙƒØ³ Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.
            
            // Ø¨Ø¨Ø³Ø§Ø·Ø©ØŒ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ IndexedDB
            const newId = await Database.put(storeName, data);
            AppState.db[type][index] = data; // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø¦Ù† ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¶Ù…Ø§Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ§Ù„Ø§Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
            await App.loadAllData();
            App.updateStats();
            App.updateBalanceDisplay();

            App.toastMsg("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!");
            App.closeLayer('detail');
            App.renderLog(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ

        } else {
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
            if (balanceUpdate !== 0) {
                if (AppState.currentBalance + balanceUpdate < 0) {
                    return App.toastMsg("Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ Ù„Ø¥ØªÙ…Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© (Ø§Ù„Ù…ØµØ±ÙˆÙ/Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…).");
                }
            }

            const newId = await Database.put(storeName, data);
            data.id = newId;
            AppState.db[storeName].unshift(data); // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø°Ø§ÙƒØ±Ø©

            if (balanceUpdate !== 0) {
                 const typeMap = { exp: 'expense', rig: 'right-collection', deb: 'debt-payment' };
                await App.updateBalance(balanceUpdate, `Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: ${data.desc || data.type}`, data.date, typeMap[storeName], newId);
            } else {
                App.updateStats();
            }

            App.toastMsg("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!");
        }

        App.clearFormInputs(storeName);
        AppState.editMode = null;
    },

    async addExpense() {
        const amount = App.parseAmount(document.getElementById('eAmount').value);
        const type = document.getElementById('eType').value;
        const desc = document.getElementById('eDesc').value;
        const date = document.getElementById('eDate').value || new Date().toISOString().slice(0, 16);
        const img = document.getElementById('eImgName').dataset.imgBase64 || null;

        if (!amount || amount <= 0) return App.toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­.");
        if (!type) return App.toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙØ¦Ø©.");

        const newExpense = { amount, type, desc, date, img };
        await App.addTransaction('exp', newExpense, -amount);
    },

    async addRight() {
        const amount = App.parseAmount(document.getElementById('rAmount').value);
        const type = document.getElementById('rType').value;
        const desc = document.getElementById('rDesc').value;
        const date = document.getElementById('rDate').value || new Date().toISOString().slice(0, 16);
        const status = document.getElementById('rStatus').value;
        const paidAmount = App.parseAmount(document.getElementById('rPaidAmount')?.value || '0'); 
        
        if (!amount || amount <= 0) return App.toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­.");
        if (!type) return App.toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚.");
        
        if(paidAmount > amount) return App.toastMsg("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚.");

        const newRight = { amount, type, desc, date, status, paidAmount, balanceImpacted: paidAmount };
        
        // Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ© ØªØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯ ÙÙ‚Ø· Ø¨Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ø§Ù„Ù…Ø­ØµÙ„)
        await App.addTransaction('rig', newRight, paidAmount);
    },

    async addDebt() {
        const amount = App.parseAmount(document.getElementById('dAmount').value);
        const type = document.getElementById('dType').value;
        const desc = document.getElementById('dDesc').value;
        const date = document.getElementById('dDate').value || new Date().toISOString().slice(0, 16);
        const status = document.getElementById('dStatus').value;
        const paidAmount = App.parseAmount(document.getElementById('dPaidAmount')?.value || '0'); 

        if (!amount || amount <= 0) return App.toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø©.");
        if (!type) return App.toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù….");
        
        if(paidAmount > amount) return App.toastMsg("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªØ¬Ø§ÙˆØ² Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù….");

        // Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ© ØªØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯ ÙÙ‚Ø· Ø¨Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ù…Ø®ØµÙˆÙ…)
        const newDebt = { amount, type, desc, date, status, paidAmount, balanceImpacted: -paidAmount };
        await App.addTransaction('deb', newDebt, -paidAmount);
    },

    // --------------------------------------------------
    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ§Ù„Ø¹Ø±Ø¶
    // --------------------------------------------------

    updateStats() {
        const expTotal = AppState.db.exp.reduce((sum, item) => sum + item.amount, 0);
        const rigTotal = AppState.db.rig.reduce((sum, item) => sum + item.amount, 0);
        const debTotal = AppState.db.deb.reduce((sum, item) => sum + item.amount, 0);
        const rigPaid = AppState.db.rig.reduce((sum, item) => sum + item.paidAmount, 0);
        const debPaid = AppState.db.deb.reduce((sum, item) => sum + item.paidAmount, 0);

        document.getElementById('sExpTotal').textContent = App.formatCurrency(expTotal, true);
        document.getElementById('sRigTotal').textContent = App.formatCurrency(rigTotal, true);
        document.getElementById('sDebTotal').textContent = App.formatCurrency(debTotal, true);
        document.getElementById('sRigPaid').textContent = App.formatCurrency(rigPaid, true);
        document.getElementById('sDebPaid').textContent = App.formatCurrency(debPaid, true);
    },
    
    updateBalanceDisplay() {
        const display = document.getElementById('currentBalanceDisplay');
        const icon = document.getElementById('balanceVisibilityToggle').querySelector('i');
        
        if (AppState.balanceHidden) {
            display.innerHTML = `<span class="hidden-balance">â€¢â€¢â€¢â€¢â€¢â€¢</span>`;
            icon.className = 'fas fa-eye-slash';
        } else {
            display.innerHTML = App.formatCurrency(AppState.currentBalance);
            icon.className = 'fas fa-eye';
        }
    },

    renderLog() {
        const logType = AppState.currentLog;
        const logContent = document.getElementById('logContent');
        const searchInput = document.getElementById('search').value.toLowerCase().trim();
        logContent.innerHTML = '<p style="text-align: center; color: #999;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
        
        const data = AppState.db[logType];
        if (!data || data.length === 0) return;

        let filteredData = data;
        if (searchInput) {
            filteredData = data.filter(item => 
                item.desc?.toLowerCase().includes(searchInput) || 
                item.type?.toLowerCase().includes(searchInput) ||
                item.amount.toString().includes(searchInput)
            );
        }
        
        if (filteredData.length === 0) {
            logContent.innerHTML = '<p style="text-align: center; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø­Ø« Ù…Ø·Ø§Ø¨Ù‚Ø©.</p>';
            return;
        }

        const html = filteredData.map(item => App.renderListItem(item, logType)).join('');
        logContent.innerHTML = html;
    },

    renderListItem(item, type) {
        const date = App.formatDate(item.date);
        let amountClass = '', icon = '', statusText = '', paidStatus = '';
        
        if (type === 'exp') {
            amountClass = 'expense';
            icon = 'fa-money-bill-wave';
            statusText = `Ø§Ù„ÙØ¦Ø©: ${item.type}`;
        } else if (type === 'rig') {
            amountClass = 'right';
            icon = 'fa-handshake';
            statusText = `Ø§Ù„Ù†ÙˆØ¹: ${item.type} | Ø§Ù„Ø­Ø§Ù„Ø©: ${item.status}`;
            paidStatus = item.paidAmount > 0 ? `<span style="color:var(--success); margin-left: 10px;">(Ù…Ø­ØµÙ„: ${App.formatCurrency(item.paidAmount, true)})</span>` : '';
        } else if (type === 'deb') {
            amountClass = 'debt';
            icon = 'fa-file-invoice';
            statusText = `Ø§Ù„Ù†ÙˆØ¹: ${item.type} | Ø§Ù„Ø­Ø§Ù„Ø©: ${item.status}`;
            paidStatus = item.paidAmount > 0 ? `<span style="color:var(--danger); margin-left: 10px;">(Ù…Ø¯ÙÙˆØ¹: ${App.formatCurrency(item.paidAmount, true)})</span>` : '';
        }
        
        return `
            <div class="list-item" onclick="App.openDetailModal(${item.id}, '${type}')">
                <div style="display:flex; justify-content:space-between; align-items: center;">
                    <span class="amount ${amountClass}">${App.formatCurrency(item.amount)}</span>
                    <span style="font-weight: bold;"><i class="fas ${icon}" style="margin-left: 8px; color: var(--p);"></i> ${item.desc || item.type || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</span>
                </div>
                <div class="details">
                    <span>${statusText}${paidStatus}</span>
                    <span><i class="far fa-calendar-alt" style="margin-left: 5px;"></i> ${date}</span>
                </div>
            </div>
        `;
    },

    // --------------------------------------------------
    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆØ§Ù„Ù…Ù„Ø§Ø­ÙŠØ© (Helpers & UI)
    // --------------------------------------------------

    // ÙØªØ­ Ø´Ø±ÙŠØ­Ø© (Tab)
    openTab(tabId) {
        document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
        document.querySelectorAll('.tabs button').forEach(btn => btn.classList.remove('active'));
        
        document.getElementById(tabId).classList.add('active');
        document.querySelector(`.tabs button[onclick="App.openTab('${tabId}')"]`).classList.add('active');
    },

    // ÙØªØ­ Ø·Ø¨Ù‚Ø© (Modal/Sidebar)
    openLayer(layerName, data = {}) {
        const layer = AppState.LAYERS[layerName];
        if (!layer) return;

        const element = document.getElementById(layer.elementId);
        
        if (layer.type === 'modal') {
            element.style.display = 'flex';
        } else if (layer.type === 'menu') {
            element.classList.add('open');
            if (layerName === 'sidebar') {
                 document.querySelector('.sidebar-overlay').classList.add('open');
            } else if (layerName === 'imageSource') {
                document.getElementById('imageSourceOverlay').style.display = 'block';
            }
        }
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
        if (layerName === 'log') {
            AppState.currentLog = data.logType;
            App.renderLog();
        } else if (layerName === 'detail') {
            App.openDetailModal(data.id, data.logType);
        } else if (layerName === 'balanceAction') {
            AppState.balanceActionType = data.actionType;
            document.getElementById('actionModalTitle').textContent = AppState.balanceActionType === 'deposit' ? 'Ø¥ÙŠØ¯Ø§Ø¹ Ø±ØµÙŠØ¯ Ø¬Ø¯ÙŠØ¯' : 'Ø³Ø­Ø¨/ØªØ­ÙˆÙŠÙ„ Ø±ØµÙŠØ¯';
            document.getElementById('currentBalanceInAction').innerHTML = App.formatCurrency(AppState.currentBalance);
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
            document.getElementById('bDate').value = new Date().toISOString().slice(0, 16); 
        } else if (layerName === 'balanceLog') {
            App.renderBalanceLog();
        } else if (layerName === 'currency') {
            App.renderCurrencyList();
        }

        // Ø¯ÙØ¹ Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙƒØ¯Ø³
        AppState.historyStack.push(layerName);
    },

    // Ø¥ØºÙ„Ø§Ù‚ Ø·Ø¨Ù‚Ø©
    closeLayer(layerName) {
        const layer = AppState.LAYERS[layerName];
        if (!layer) return;

        const element = document.getElementById(layer.elementId);
        
        if (layer.type === 'modal') {
            element.style.display = 'none';
        } else if (layer.type === 'menu') {
            element.classList.remove('open');
            if (layerName === 'sidebar') {
                document.querySelector('.sidebar-overlay').classList.remove('open');
            } else if (layerName === 'imageSource') {
                document.getElementById('imageSourceOverlay').style.display = 'none';
            }
        }

        // Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ù…ÙƒØ¯Ø³ Ø§Ù„ØªØ§Ø±ÙŠØ®
        const index = AppState.historyStack.lastIndexOf(layerName);
        if (index > -1) {
            AppState.historyStack.splice(index, 1);
        }

        if(layerName === 'detail') {
            AppState.editMode = null; // Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø±ÙŠØ±
        }
    },
    
    // Ø§Ø®ØªØµØ§Ø±Ø§Øª Ø§Ù„ÙØªØ­
    openSidebar: () => App.openLayer('sidebar'),
    openLog: (logType) => App.openLayer('log', { logType }),
    openBalanceActionModal: (actionType) => App.openLayer('balanceAction', { actionType }),
    openBalanceLogModal: () => App.openLayer('balanceLog'),
    openAboutModal: () => App.openLayer('about'),
    openCurrencyModal: () => App.openLayer('currency'),
    showImageSourceModal: () => App.openLayer('imageSource'),

    // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø±ÙŠØ±
    openDetailModal(id, logType) {
        const item = AppState.db[logType].find(i => i.id === id);
        if (!item) return App.toastMsg("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.");
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø±ÙŠØ±
        const index = AppState.db[logType].findIndex(i => i.id === id);
        AppState.editMode = { type: logType, index: index };
        
        App._renderDetailContent(item, logType);
        App.openLayer('detail');
    },

    _renderDetailContent(item, logType) {
        const content = document.getElementById('detailContent');
        const isExpense = logType === 'exp';
        const isRight = logType === 'rig';
        const isDebt = logType === 'deb';

        // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø§Ù†Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        const createInput = (id, label, value, type = 'text', readOnly = false) => `
            <label style="display:block; margin-top: 15px; font-size: 0.9em; color: #666;">${label}</label>
            <input id="${id}" type="${type}" value="${value || ''}" ${readOnly ? 'readonly' : ''} style="font-size: 15px; padding: 12px;" ${type === 'text' ? 'placeholder="Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„"' : ''}>
        `;

        // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†Ø³Ø¯Ù„Ø©
        const createSelect = (id, label, options, currentValue) => {
            const optionsHtml = options.map(opt => 
                `<option value="${opt}" ${opt === currentValue ? 'selected' : ''}>${opt}</option>`
            ).join('');
            return `
                <label style="display:block; margin-top: 15px; font-size: 0.9em; color: #666;">${label}</label>
                <select id="${id}" style="font-size: 15px; padding: 12px;">
                    ${optionsHtml}
                </select>
            `;
        };

        let html = `
            <div class="card" style="border-top: 5px solid ${isExpense ? 'var(--danger)' : isRight ? 'var(--success)' : 'var(--warning)'}; margin-bottom: 20px;">
                <h3 style="margin-top:0; color:var(--p);">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ: ${App.formatCurrency(item.amount)}</h3>
                <p><strong><i class="fas fa-calendar-alt"></i> Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${App.formatDate(item.date, true)}</p>
                ${isExpense ? `
                    <p><strong><i class="fas fa-tag"></i> Ø§Ù„ÙØ¦Ø©:</strong> ${item.type}</p>
                ` : `
                    <p><strong><i class="fas fa-handshake"></i> Ø§Ù„Ù†ÙˆØ¹:</strong> ${item.type}</p>
                `}
            </div>
        `;

        // Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ­Ø±ÙŠØ±
        html += '<h4 style="color: var(--s); margin-bottom: 15px;"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4>';
        
        // Ø§Ù„Ù…Ø¨Ù„Øº (Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø±ÙŠØ±Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„ØªØ¬Ù†Ø¨ ØªØ¹Ù‚ÙŠØ¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ØŒ ÙŠÙØ¶Ù„ Ø­Ø°ÙÙ‡ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¥Ø¶Ø§ÙØªÙ‡)
        html += createInput('detailAmount', 'ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ (Ù„Ù„ØªØ­Ø¯ÙŠØ«):', item.amount, 'text', false);
        
        if (isRight || isDebt) {
            html += createInput('detailPaidAmount', isRight ? 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹:' : 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø­Ø§Ù„ÙŠØ§Ù‹:', item.paidAmount || 0, 'text', false);
        }
        
        const typeOptions = isExpense ? ['Ø·Ø¹Ø§Ù…', 'Ù…ÙˆØ§ØµÙ„Ø§Øª', 'Ø±Ø¹Ø§ÙŠØ© Ø´Ø®ØµÙŠØ©', 'Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©', 'ØµØ­Ø©', 'ØªØ±ÙÙŠÙ‡', 'ØªØ³ÙˆÙ‚', 'ØªØ¹Ù„ÙŠÙ…', 'ØµÙŠØ§Ù†Ø© ÙˆØ¥ØµÙ„Ø§Ø­', 'Ø£Ø®Ø±Ù‰'] :
                          isRight ? ['Ø¯ÙŠÙ†', 'Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„', 'Ø£Ø®Ø±Ù‰'] :
                          ['Ø¥ÙŠØ¬Ø§Ø±', 'ÙƒÙ‡Ø±Ø¨Ø§Ø¡', 'Ù…Ø§Ø¡', 'Ø¥Ù†ØªØ±Ù†Øª', 'Ù‚Ø±Ø¶', 'Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ', 'Ù‚Ø³Ø·/ÙØ§ØªÙˆØ±Ø© Ø£Ø®Ø±Ù‰', 'Ø£Ø®Ø±Ù‰'];

        html += createSelect('detailType', isExpense ? 'ğŸ›’ Ø§Ù„ÙØ¦Ø©' : 'ğŸ¤ Ø§Ù„Ù†ÙˆØ¹', typeOptions, item.type);
        
        if (isRight || isDebt) {
            const statusOptions = isRight ? ['ÙƒØ§Ù…Ù„', 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹'] : ['Ù…Ø¯ÙÙˆØ¹', 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹'];
            html += createSelect('detailStatus', 'âœ… Ø§Ù„Ø­Ø§Ù„Ø©', statusOptions, item.status);
        }

        html += createInput('detailDesc', 'ğŸ“ Ø§Ù„ÙˆØµÙ / Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©:', item.desc, 'text', false);
        html += `
            <label style="display:block; margin-top: 15px; font-size: 0.9em; color: #666;">ğŸ—“ï¸ Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
            <input id="detailDate" type="datetime-local" value="${item.date.slice(0, 16)}" style="font-size: 15px; padding: 12px; width: 100%; border-radius: 10px;">
        `;

        if (item.img) {
             html += `
                <div style="margin-top: 20px; text-align: center;">
                    <h5 style="color: var(--p);">ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø©</h5>
                    <img src="${item.img}" style="max-width: 100%; height: auto; border-radius: 10px; box-shadow: var(--shadow-light);">
                </div>
            `;
        }

        html += `
            <button class="action" style="background: var(--success); margin-top: 25px;" onclick="App.saveDetailEdit()">
                <i class="fas fa-save" style="margin-left: 5px;"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
            </button>
            <button class="action" style="background: var(--danger);" onclick="App.confirmDeleteTransaction()">
                <i class="fas fa-trash-alt" style="margin-left: 5px;"></i> Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
            </button>
        `;
        
        content.innerHTML = html;
    },

    // Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ (Async)
    async saveDetailEdit() {
        const { type, index } = AppState.editMode;
        const currentItem = AppState.db[type][index];

        const newAmount = App.parseAmount(document.getElementById('detailAmount').value);
        const newDesc = document.getElementById('detailDesc').value;
        const newType = document.getElementById('detailType').value;
        const newDate = document.getElementById('detailDate').value;
        let newStatus = currentItem.status;
        let newPaidAmount = currentItem.paidAmount || 0;

        if (type !== 'exp') {
            newStatus = document.getElementById('detailStatus').value;
            if (document.getElementById('detailPaidAmount')) {
                newPaidAmount = App.parseAmount(document.getElementById('detailPaidAmount').value);
            }
        }
        
        if (!newAmount || newAmount <= 0) return App.toastMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­.");
        
        if(newPaidAmount > newAmount) return App.toastMsg("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹/Ø§Ù„Ù…Ø­ØµÙ„ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ.");

        const updatedItem = {
            ...currentItem,
            amount: newAmount,
            desc: newDesc,
            type: newType,
            date: newDate,
            status: newStatus,
            paidAmount: newPaidAmount,
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø®Ø§Øµ Ø¨ØªØ£Ø«ÙŠØ± Ø§Ù„Ø±ØµÙŠØ¯ (Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª/Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø¹Ù‚Ø¯)
            balanceImpacted: type === 'rig' ? newPaidAmount : (type === 'deb' ? -newPaidAmount : (type === 'exp' ? -newAmount : 0))
        };
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø±ÙŠØ±
        await App.addTransaction(type, updatedItem, 0); // balanceUpdate = 0 Ù„Ø£Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙŠØªÙ… Ø¹Ø¨Ø± loadAllData
    },

    // ØªØ£ÙƒÙŠØ¯ ÙˆØ­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© (Async)
    confirmDeleteTransaction() {
        const { type, index } = AppState.editMode;
        const item = AppState.db[type][index];
        
        if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù…Ø¹Ø§Ù…Ù„Ø© "${item.desc || item.type}" Ø¨Ù‚ÙŠÙ…Ø© ${App.formatCurrency(item.amount)}ØŸ Ø³ÙŠØ¤Ø¯ÙŠ Ù‡Ø°Ø§ Ø¥Ù„Ù‰ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ.`)) {
            App.deleteTransaction(item.id, type);
        }
    },

    async deleteTransaction(id, storeName) {
        try {
            await Database.delete(storeName, id);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
            const index = AppState.db[storeName].findIndex(i => i.id === id);
            const deletedItem = AppState.db[storeName].splice(index, 1)[0];
            
            // Ø¹ÙƒØ³ ØªØ£Ø«ÙŠØ± Ø§Ù„Ø±ØµÙŠØ¯ (Ù…ØµØ±ÙˆÙ/Ø§Ù„ØªØ²Ø§Ù… Ù…Ø¯ÙÙˆØ¹: Ø¥Ø¶Ø§ÙØ©ØŒ Ø­Ù‚ Ù…Ø­ØµÙ„: Ø®ØµÙ…)
            const typeMap = { exp: 'expense-revert', rig: 'right-revert', deb: 'debt-revert' };
            let balanceRevert = 0;
            
            if (storeName === 'exp') {
                balanceRevert = deletedItem.amount;
            } else if (storeName === 'rig') {
                balanceRevert = -deletedItem.paidAmount;
            } else if (storeName === 'deb') {
                balanceRevert = deletedItem.paidAmount;
            }
            
            if (balanceRevert !== 0) {
                await App.updateBalance(balanceRevert, `Ø¥Ù„ØºØ§Ø¡ Ù…Ø¹Ø§Ù…Ù„Ø© Ù…Ø­Ø°ÙˆÙØ©: ${deletedItem.desc || deletedItem.type}`, new Date().toISOString().slice(0, 16), typeMap[storeName]);
            } else {
                App.updateStats();
            }

            App.toastMsg("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­.");
            App.closeLayer('detail');
            App.renderLog(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„
        } catch (error) {
            App.toastMsg("ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.");
            console.error(error);
        }
    },

    // --------------------------------------------------
    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¹Ù…Ù„Ø§Øª ÙˆØ§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
    // --------------------------------------------------

    loadDarkModePreference() {
        const isDark = localStorage.getItem('darkMode') === 'true';
        if (isDark) {
            document.body.classList.add('dark-mode');
            const toggle = document.getElementById('darkModeToggle');
            if (toggle) toggle.checked = true;
        }
    },

    toggleDarkMode() {
        const isDark = document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', isDark);
    },

    loadCurrencyPreference() {
        const code = localStorage.getItem('currencyCode') || 'SAR';
        AppState.currentCurrency = AppState.ARABIC_CURRENCIES.find(c => c.code === code) || AppState.ARABIC_CURRENCIES[0];
        document.getElementById('currentCurrencyDisplay').textContent = `Ø§Ù„Ø¹Ù…Ù„Ø©: ${AppState.currentCurrency.name} (${AppState.currentCurrency.symbol})`;
    },

    setCurrency(currency) {
        AppState.currentCurrency = currency;
        localStorage.setItem('currencyCode', currency.code);
        document.getElementById('currentCurrencyDisplay').textContent = `Ø§Ù„Ø¹Ù…Ù„Ø©: ${currency.name} (${currency.symbol})`;
        App.closeLayer('currency');
        App.updateBalanceDisplay();
        App.updateStats();
        if(AppState.currentLog) App.renderLog();
    },

    renderCurrencyList() {
        const listEl = document.getElementById('currencyList');
        const search = document.getElementById('currencySearch').value.toLowerCase();
        
        const filtered = AppState.ARABIC_CURRENCIES.filter(c => 
            c.name.includes(search) || c.code.toLowerCase().includes(search)
        );

        listEl.innerHTML = filtered.map(c => `
            <button class="secondary" onclick="App.setCurrency({code: '${c.code}', symbol: '${c.symbol}', name: '${c.name}'})"
                style="display: flex; justify-content: space-between; margin-bottom: 10px; border-color: ${c.code === AppState.currentCurrency.code ? 'var(--p)' : 'var(--border-color)'};">
                <span style="font-weight: bold;">${c.symbol} ${c.name}</span>
                <span style="color: ${c.code === AppState.currentCurrency.code ? 'var(--p)' : '#999'};">${c.code}</span>
            </button>
        `).join('');
    },

    // --------------------------------------------------
    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯ÙˆØ§Øª (Utils)
    // --------------------------------------------------

    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø¨Ù„Øº Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
    formatAmount(input) {
        let value = input.value.replace(/[^0-9.]/g, ''); // Ø¥Ø²Ø§Ù„Ø© ØºÙŠØ± Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ù†Ù‚Ø·Ø©
        const parts = value.split('.');
        if (parts.length > 2) {
            value = parts[0] + '.' + parts.slice(1).join('');
        }
        input.value = value;
    },

    // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ø¥Ù„Ù‰ Ø±Ù‚Ù…
    parseAmount(value) {
        return parseFloat(value.toString().replace(/,/g, '')) || 0;
    },

    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø¹Ù…Ù„Ø©
    formatCurrency(amount, skipSymbol = false) {
        const value = App.parseAmount(amount);
        const formatted = new Intl.NumberFormat('ar-SA', { 
            style: 'decimal',
            minimumFractionDigits: 0,
            maximumFractionDigits: 2
        }).format(value);
        
        if (skipSymbol) return formatted;
        
        const symbol = AppState.currentCurrency ? AppState.currentCurrency.symbol : 'Ø±.Ø³';
        return `<span class="currency-symbol">${symbol}</span> ${formatted}`;
    },

    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
    formatDate(isoDate, withTime = false) {
        if (!isoDate) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const date = new Date(isoDate);
        if (isNaN(date)) return 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­';

        const options = { year: 'numeric', month: 'numeric', day: 'numeric' };
        if (withTime) {
            options.hour = '2-digit';
            options.minute = '2-digit';
        }
        return date.toLocaleString('ar-SA', options);
    },

    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±ØµÙŠØ¯
    toggleBalanceVisibility() {
        AppState.balanceHidden = !AppState.balanceHidden;
        localStorage.setItem('balanceHidden', AppState.balanceHidden);
        App.updateBalanceDisplay();
    },

    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø³Ø±ÙŠØ¹Ø©
    toastMsg(msg) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2500);
    },

    // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
    clearFormInputs(section) {
        document.getElementById(`${section.charAt(0)}Amount`).value = '';
        document.getElementById(`${section.charAt(0)}Desc`).value = '';
        document.getElementById(`${section.charAt(0)}Date`).value = '';
        document.getElementById(`${section.charAt(0)}Type`).value = ''; // Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
        document.getElementById(`${section.charAt(0)}ImgName`).textContent = '';
        document.getElementById(`${section.charAt(0)}ImgName`).dataset.imgBase64 = '';
        
        if (section === 'rig' || section === 'deb') {
            document.getElementById(`${section.charAt(0)}DynamicFields`).innerHTML = '';
        }
    },

    // --------------------------------------------------
    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„ØµÙˆØ± (Settings & Media)
    // --------------------------------------------------
    
    // ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Async)
    async exportData() {
        try {
            // Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ Ø£Ø­Ø¯Ø« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            await App.loadAllData();
            
            const dataToExport = {
                version: IDB_VERSION,
                timestamp: new Date().toISOString(),
                data: AppState.db
            };
            const json = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `smart_budget_backup_${App.formatDate(new Date().toISOString()).replace(/[^0-9]/g, '_')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            App.toastMsg("ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
        } catch (error) {
            App.toastMsg("ÙØ´Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
            console.error("Export Error:", error);
        }
    },

    // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Async)
    importData(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (!data.data || !data.data.exp || !data.data.bal) {
                    throw new Error("ØªÙ†Ø³ÙŠÙ‚ Ù…Ù„Ù Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØºÙŠØ± ØµØ­ÙŠØ­.");
                }
                
                if (!confirm("ØªØ­Ø°ÙŠØ±: Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
                    event.target.value = null; 
                    return;
                }
                
                await Database.clearAll(); // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
                
                // Ø¥Ø¹Ø§Ø¯Ø© ÙƒØªØ§Ø¨Ø© ÙƒÙ„ Ù…Ø®Ø²Ù† Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                for (const storeName of STORE_NAMES) {
                    const storeData = storeName === 'bal' ? data.data.bal : data.data[storeName];
                    if (Array.isArray(storeData)) {
                         for (const item of storeData) {
                            await Database.put(storeName, item);
                        }
                    } else if (storeName === 'bal') {
                        await Database.put(storeName, storeData);
                    }
                }
                
                await App.loadAllData();
                App.updateStats(); 
                App.updateBalanceDisplay();
                App.toastMsg("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");

            } catch (error) {
                App.toastMsg("ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù Ø¨ØµÙŠØºØ© JSON ØµØ­ÙŠØ­Ø©.");
                console.error("Import Error:", error);
            } finally {
                event.target.value = null; 
            }
        };
        reader.readAsText(file);
    },

    confirmResetData() {
        App.closeLayer('sidebar');
        if (confirm("ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.")) {
            App.resetAllData();
        }
    },

    async resetAllData() {
        try {
            await Database.clearAll();
            AppState.db.exp = AppState.db.rig = AppState.db.deb = []; 
            AppState.db.bal = { clientId: 1, amount: 0, changes: [] };

            await App.loadAllData();
            App.updateStats(); 
            App.updateBalanceDisplay();
            App.toastMsg("ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
        } catch (error) {
             App.toastMsg("ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + error.message);
             console.error(error);
        }
    },

    // --------------------------------------------------
    // ÙˆØ¸Ø§Ø¦Ù Ø³Ø¬Ù„ Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ§Ù„Ø¢Ù„ÙŠØ§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
    // --------------------------------------------------

    renderBalanceLog() {
        const logContent = document.getElementById('balanceLogContent');
        const changes = AppState.db.bal.changes;
        
        if (!changes || changes.length === 0) {
            logContent.innerHTML = '<p style="text-align: center; color: #999;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø±ØµÙŠØ¯.</p>';
            return;
        }

        const html = changes.map(change => {
            const isDeposit = change.type === 'deposit' || change.type === 'right' || change.amount > 0;
            const amountClass = isDeposit ? 'right' : 'expense';
            const icon = isDeposit ? 'fa-plus-circle' : 'fa-minus-circle';
            
            let typeText = '';
            if (change.type === 'deposit') typeText = 'Ø¥ÙŠØ¯Ø§Ø¹ Ù†Ù‚Ø¯ÙŠ';
            else if (change.type === 'withdraw') typeText = 'Ø³Ø­Ø¨ Ù†Ù‚Ø¯ÙŠ/ØªØ­ÙˆÙŠÙ„';
            else if (change.type === 'expense') typeText = 'Ù…ØµØ±ÙˆÙ Ù…Ø¨Ø§Ø´Ø±';
            else if (change.type === 'right-collection') typeText = 'ØªØ­ØµÙŠÙ„ Ø­Ù‚ Ù…Ø§Ù„ÙŠ';
            else if (change.type === 'debt-payment') typeText = 'Ø¯ÙØ¹ Ø§Ù„ØªØ²Ø§Ù…';
            else if (change.type.includes('-revert')) typeText = 'Ø¹ÙƒØ³ Ø¹Ù…Ù„ÙŠØ© Ù…Ø­Ø°ÙˆÙØ©';


            return `
                 <div class="list-item" style="border-right-color: ${isDeposit ? 'var(--success)' : 'var(--danger)'};">
                    <div style="display:flex; justify-content:space-between; align-items: center;">
                        <span class="amount ${amountClass}">${App.formatCurrency(Math.abs(change.amount))}</span>
                        <span style="font-weight: bold;">${change.desc || typeText}</span>
                    </div>
                    <div class="details">
                        <span style="color: ${isDeposit ? 'var(--success)' : 'var(--danger)'};">${typeText}</span>
                        <span><i class="far fa-calendar-alt" style="margin-left: 5px;"></i> ${App.formatDate(change.date, true)}</span>
                    </div>
                </div>
            `;
        }).join('');
        
        logContent.innerHTML = html;
    },

    // ØªØ­Ø¯ÙŠØ« Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙˆØ¹
    updateRightFields(type) {
        const fieldsContainer = document.getElementById('rDynamicFields');
        // Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ø§Ù„Ù…Ø­ØµÙ„) ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ù‚ Ø¯ÙŠÙ† Ø£Ùˆ Ø¨ÙŠØ¹ Ø¢Ø¬Ù„
        if (type === 'Ø¯ÙŠÙ†' || type === 'Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ø¢Ø¬Ù„') {
            fieldsContainer.innerHTML = `
                <input id="rPaidAmount" type="text" placeholder="ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹ (0 Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„)" 
                       oninput="App.formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
            `;
        } else {
            fieldsContainer.innerHTML = '';
        }
    },
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙˆØ¹
    updateDebtFields(type) {
        const fieldsContainer = document.getElementById('dDynamicFields');
        // Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ ÙŠØ¸Ù‡Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹
        fieldsContainer.innerHTML = `
            <input id="dPaidAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø­Ø§Ù„ÙŠØ§Ù‹" 
                   oninput="App.formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
        `;
    },

    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…Ø¹Ø±Ø¶
    openCameraInput() {
        document.getElementById('eImgCamera').click();
        App.closeLayer('imageSource');
    },

    openGalleryInput() {
        document.getElementById('eImgGallery').click();
        App.closeLayer('imageSource');
    },

    updateFileName(input, spanId) {
        const span = document.getElementById(spanId);
        if (input.files && input.files[0]) {
            const file = input.files[0];
            span.textContent = `ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø©: ${file.name}`;
            
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Base64 Ù„ØªØ®Ø²ÙŠÙ†Ù‡Ø§ ÙÙŠ IndexedDB (ÙŠØ¬Ø¨ Ø§Ù„Ø­Ø°Ø± Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©)
            const reader = new FileReader();
            reader.onload = (e) => {
                span.dataset.imgBase64 = e.target.result;
            };
            reader.readAsDataURL(file);

        } else {
            span.textContent = '';
            span.dataset.imgBase64 = '';
        }
    }
};

// ===================================================
// 4. Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù€ (back button) ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø©
// ===================================================
// ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ Modals/Sidebar Ø¹Ù†Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø²Ø± "Ø§Ù„Ø¹ÙˆØ¯Ø©"
window.onpopstate = () => {
    if (AppState.historyStack.length > 0) {
        const layerToClose = AppState.historyStack[AppState.historyStack.length - 1];
        App.closeLayer(layerToClose);
    } else {
        // ÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø·Ø¨Ù‚Ø§Øª Ù…ÙØªÙˆØ­Ø©ØŒ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        // history.back(); // ØªØ¬Ù†Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ø³Ù„ÙˆÙƒ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø£Ø­Ø§Ø¯ÙŠ Ø§Ù„ØµÙØ­Ø©
    }
};

</script>
</body>
</html>
